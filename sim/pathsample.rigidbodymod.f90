!   OPTIM: A program for optimizing geometries and calculating reaction pathways
!   Copyright (C) 1999-2005 David J. Wales
!   This file is part of OPTIM.
!
!   OPTIM is free software; you can redistribute it and/or modify
!   it under the terms of the GNU General Public License as published by
!   the Free Software Foundation; either version 2 of the License, or
!   (at your option) any later version.
!
!   OPTIM is distributed in the hope that it will be useful,
!   but WITHOUT ANY WARRANTY; without even the implied warranty of
!   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
!   GNU General Public License for more details.
!
!   You should have received a copy of the GNU General Public License
!   along with this program; if not, write to the Free Software
!   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA

MODULE RIGIDBODYMOD

  USE MATHSCONSTANTS

  IMPLICIT NONE

! #####################################################################################################

! DEFINE A NEW STRUCTURE TYPE
! THIS WILL MAKE IT EASIER IF WE WANT TO HAVE MORE THAN ONE TYPE OF RIGID BODY
! IN THE SAME SYSTEM

  TYPE RIGIDBODYPOTENTIAL

     INTEGER :: NSITES
     INTEGER :: NPHYSICALSITES        ! FOR THE PURPOSES OF CALCULATING PATH LENGTHS ETC

! REFERENCE GEOMETRY
     DOUBLE PRECISION, ALLOCATABLE :: SITE(:,:)

! SITE SYMBOLS FOR OUTPUT

     CHARACTER(5), ALLOCATABLE :: SITELABEL(:)

! MASSES FOR CALCULATING ROTATIONAL CONSTANTS ETC

     DOUBLE PRECISION, ALLOCATABLE :: MASS(:)

! ATOMIC NUMBERS - NOT SURE WHY WE NEED THESE AND ONLY VALID FOR ATOMIC MODELS ANYWAY

     INTEGER, ALLOCATABLE :: ATOMICNUMBER(:)

! PARTIAL CHARGES
     DOUBLE PRECISION, ALLOCATABLE :: CHARGE(:)

! LJ PARAMETERS
     DOUBLE PRECISION, ALLOCATABLE :: C6(:)
     DOUBLE PRECISION, ALLOCATABLE :: C12(:)

! MORSE PARAMETERS - EPSILON, RHO, RE

     DOUBLE PRECISION, ALLOCATABLE :: MORSEPARAMETERS(:,:)    

! CONVERSION FACTOR FOR NORMAL MODE FREQUENCIES

     DOUBLE PRECISION :: FREQCONVFACTOR = 0.0D0

! CONVERSION FACTOR FOR COULOMB ENERGIES 

     DOUBLE PRECISION :: COULOMBCONVERSIONFACTOR = 1.0D0

! CONVERSION FACTOR FOR ELECTRIC FIELD INTERACTIONS

     DOUBLE PRECISION :: EFIELDCONVERSIONFACTOR = 1.0D0     

  END TYPE RIGIDBODYPOTENTIAL

! #####################################################################################################

! STORE THE DEFINITION OF A VIRUS CAPSOMER

  TYPE CAPSOMER
     INTEGER :: NBASALSITES
     DOUBLE PRECISION :: RHO, RADIUS, HEIGHT
     DOUBLE PRECISION :: EPSILONREP   ! REPULSIVE AS A FRACTION OF EPSILON_MORSE
  END TYPE CAPSOMER

! #####################################################################################################

  SAVE

  INTEGER :: NUMRBTYPES
  TYPE (CAPSOMER), ALLOCATABLE :: CAPSOMERDEFS(:)

  TYPE(RIGIDBODYPOTENTIAL) :: RBPOTENTIAL
  LOGICAL, ALLOCATABLE :: SITESINTERACT(:,:,:)

! SMALL ANGLE BELOW WHICH APPROXIMATIONS TO TRIGONOMETRIC FUNCTIONS ARE EMPLOYED

  DOUBLE PRECISION, PARAMETER :: SMALLANGLE = 1D-5 
  
CONTAINS

! #####################################################################################################

! INITIALISE KNOWN RIGID BODY MODELS

  SUBROUTINE INITIALISERIGIDBODY (ATOMTYPE, NBODIES, SYSTEMMASSES, SYSTEMATNUMBERS)

    IMPLICIT NONE
    CHARACTER(5), INTENT(IN) :: ATOMTYPE
    INTEGER, INTENT(IN), OPTIONAL :: NBODIES
    DOUBLE PRECISION, POINTER, DIMENSION(:), OPTIONAL :: SYSTEMMASSES
    INTEGER, POINTER, DIMENSION(:), OPTIONAL :: SYSTEMATNUMBERS

    INTEGER :: CURRENTBODY, CURRENTSITE
    DOUBLE PRECISION :: CURRENTANGLE

    SELECT CASE (ATOMTYPE(1:1))

! TIPNP FAMILY OF POTENTIALS
    CASE ('W')
       RBPOTENTIAL%NPHYSICALSITES = 3

       ALLOCATE(RBPOTENTIAL%SITELABEL(RBPOTENTIAL%NPHYSICALSITES))
       ALLOCATE(RBPOTENTIAL%MASS(RBPOTENTIAL%NPHYSICALSITES))
       ALLOCATE(RBPOTENTIAL%ATOMICNUMBER(RBPOTENTIAL%NPHYSICALSITES))

       RBPOTENTIAL%SITELABEL = (/'O', 'H', 'H'/)
       RBPOTENTIAL%MASS = (/16.0D0, 1.0D0, 1.0D0/)       ! PURE H2O, NOT ISOTOPIC ABUNDANCE WEIGHTED
       RBPOTENTIAL%ATOMICNUMBER = (/8, 1, 1/)

       RBPOTENTIAL%FREQCONVFACTOR = 1D3/(2.99792458D0*2.0D0*PI)    ! CONVERTS FREQUENCIES TO WAVENUMBERS
                                                                   ! SEE JOURNAL REFERENCE 01/07/05

       RBPOTENTIAL%COULOMBCONVERSIONFACTOR = 1389.354848D0
       RBPOTENTIAL%EFIELDCONVERSIONFACTOR = 96.4847D0 ! EV TO KJ/MOL CONVERSION, INPUT FIELD IN V/A

! INITIALISE KNOWN SYSTEM TYPES

       SELECT CASE (ATOMTYPE(2:2))
       CASE ('1')
          RBPOTENTIAL%NSITES = 3
          ALLOCATE(RBPOTENTIAL%SITE(RBPOTENTIAL%NSITES,3),RBPOTENTIAL%CHARGE(RBPOTENTIAL%NSITES))
          ALLOCATE(RBPOTENTIAL%C6(RBPOTENTIAL%NSITES),RBPOTENTIAL%C12(RBPOTENTIAL%NSITES))
          
          RBPOTENTIAL%SITE(1,:) = 0.0D0
          RBPOTENTIAL%SITE(2,:) = (/0.2785156560837814D0, -0.6990486725944498D0, 0.5916010671560346D0/)
          RBPOTENTIAL%SITE(3,:) = (/-0.0640734628674161D0, -0.4219928632410997D0, -0.8567662777734411D0/)

          RBPOTENTIAL%CHARGE = (/-0.8D0, 0.4D0, 0.4D0/)

! LJ COEFFICIENTS IN KJ/MOL ANGSTROM**6 OR ANGSTROM**12
          RBPOTENTIAL%C6 = (/2510.4D0, 0.0D0, 0.0D0/) 
          RBPOTENTIAL%C12 = (/2426720.0D0, 0.0D0, 0.0D0/)

       CASE ('2')
          RBPOTENTIAL%NSITES = 4
          ALLOCATE(RBPOTENTIAL%SITE(RBPOTENTIAL%NSITES,3),RBPOTENTIAL%CHARGE(RBPOTENTIAL%NSITES))
          ALLOCATE(RBPOTENTIAL%C6(RBPOTENTIAL%NSITES),RBPOTENTIAL%C12(RBPOTENTIAL%NSITES))
          
          RBPOTENTIAL%SITE(1,:) = 0.0D0
          RBPOTENTIAL%SITE(2,:) = (/0.2785156560837814D0, -0.6990486725944498D0, 0.5916010671560346D0/)
          RBPOTENTIAL%SITE(3,:) = (/-0.0640734628674161D0, -0.4219928632410997D0, -0.8567662777734411D0/)
          RBPOTENTIAL%SITE(4,:) = (/0.0274511879486426D0, -0.1435068418061116D0, -0.0339443461425310D0/)

          RBPOTENTIAL%CHARGE = (/0.0D0, 0.535D0, 0.535D0, -1.07D0/)

! LJ COEFFICIENTS IN KJ/MOL ANGSTROM**6 OR ANGSTROM**12
          RBPOTENTIAL%C6 = (/2510.4D0, 0.0D0, 0.0D0, 0.0D0/) 
          RBPOTENTIAL%C12 = (/2907880.0D0, 0.0D0, 0.0D0, 0.0D0/)

       CASE ('3')
          RBPOTENTIAL%NSITES = 3
          ALLOCATE(RBPOTENTIAL%SITE(RBPOTENTIAL%NSITES,3),RBPOTENTIAL%CHARGE(RBPOTENTIAL%NSITES))
          ALLOCATE(RBPOTENTIAL%C6(RBPOTENTIAL%NSITES),RBPOTENTIAL%C12(RBPOTENTIAL%NSITES))
          
          RBPOTENTIAL%SITE(1,:) = 0.0D0
          RBPOTENTIAL%SITE(2,:) = (/0.2785156560837814D0, -0.6990486725944498D0, 0.5916010671560346D0/)
          RBPOTENTIAL%SITE(3,:) = (/-0.0640734628674161D0, -0.4219928632410997D0, -0.8567662777734411D0/)

          RBPOTENTIAL%CHARGE = (/-0.834D0, 0.417D0, 0.417D0/)

! LJ COEFFICIENTS IN KJ/MOL ANGSTROM**6 OR ANGSTROM**12
          RBPOTENTIAL%C6 = (/2489.48D0, 0.0D0, 0.0D0/)             ! 2489.71000D0 
          RBPOTENTIAL%C12 = (/2435088.0D0, 0.0D0, 0.0D0/)          ! 2435099.13639D0

       CASE ('4')
          RBPOTENTIAL%NSITES = 4
          ALLOCATE(RBPOTENTIAL%SITE(RBPOTENTIAL%NSITES,3),RBPOTENTIAL%CHARGE(RBPOTENTIAL%NSITES))
          ALLOCATE(RBPOTENTIAL%C6(RBPOTENTIAL%NSITES),RBPOTENTIAL%C12(RBPOTENTIAL%NSITES))
          
          RBPOTENTIAL%SITE(1,:) = 0.0D0
          RBPOTENTIAL%SITE(2,:) = (/0.2785156560837814D0, -0.6990486725944498D0, 0.5916010671560346D0/)
          RBPOTENTIAL%SITE(3,:) = (/-0.0640734628674161D0, -0.4219928632410997D0, -0.8567662777734411D0/)
          RBPOTENTIAL%SITE(4,:) = (/0.0274511879486426D0, -0.1435068418061116D0, -0.0339443461425310D0/)

          RBPOTENTIAL%CHARGE = (/0.0D0, 0.52D0, 0.52D0, -1.04D0/)

! LJ COEFFICIENTS IN KJ/MOL ANGSTROM**6 OR ANGSTROM**12
          RBPOTENTIAL%C6 = (/2552.24D0, 0.0D0, 0.0D0, 0.0D0/)       ! 2551.90393D0
          RBPOTENTIAL%C12 = (/2510.4D3, 0.0D0, 0.0D0, 0.0D0/)       ! 2510413.58406D0      

       CASE ('5')
          RBPOTENTIAL%NSITES = 5
          ALLOCATE(RBPOTENTIAL%SITE(RBPOTENTIAL%NSITES,3),RBPOTENTIAL%CHARGE(RBPOTENTIAL%NSITES))
          ALLOCATE(RBPOTENTIAL%C6(RBPOTENTIAL%NSITES),RBPOTENTIAL%C12(RBPOTENTIAL%NSITES))
          
          RBPOTENTIAL%SITE(1,:) = 0.0D0
!          RBPOTENTIAL%SITE(2,:) = (/0.75695032726366118236D0,0.0D0,-0.58588227661829495041D0/)
!          RBPOTENTIAL%SITE(3,:) = (/-0.75695032726366118236D0,0.0D0,-0.58588227661829495041D0/)
!          RBPOTENTIAL%SITE(4,:) = (/0.0D0,0.57154330164408195802D0,0.40415127656087129759D0/)
!          RBPOTENTIAL%SITE(5,:) = (/0.0D0,-0.57154330164408195802D0,0.40415127656087129759D0/)
         
          RBPOTENTIAL%SITE(2,:) = (/0.2785156560837814D0, -0.6990486725944498D0, 0.5916010671560346D0/)
          RBPOTENTIAL%SITE(3,:) = (/-0.0640734628674161D0, -0.4219928632410997D0, -0.8567662777734411D0/)
          RBPOTENTIAL%SITE(4,:) = (/0.4728396101454916D0, 0.5159942465174050D0, -0.0131392784579428D0/)
          RBPOTENTIAL%SITE(5,:) = (/-0.6207653788462422D0, 0.2573187309647155D0, 0.1960546227983159D0/)

          RBPOTENTIAL%CHARGE = (/0.0D0, 0.241D0, 0.241D0, -0.241D0, -0.241D0/)

! LJ COEFFICIENTS IN KJ/MOL ANGSTROM**6 OR ANGSTROM**12
          RBPOTENTIAL%C6 = (/2470.012857D0, 0.0D0, 0.0D0, 0.0D0, 0.0D0/) 
          RBPOTENTIAL%C12 = (/2278383.244D0, 0.0D0, 0.0D0, 0.0D0, 0.0D0/)

       CASE DEFAULT
          PRINT *, 'UNRECOGNISED ATOM TYPE PASSED TO RIGID BODY INITIALISATION:', ATOMTYPE
          STOP ! CALL EXIT(1)

       END SELECT

! PAH MOLECULE
    CASE ('P')
       RBPOTENTIAL%NSITES = 36
       ALLOCATE(RBPOTENTIAL%SITE(RBPOTENTIAL%NSITES,3), RBPOTENTIAL%CHARGE(RBPOTENTIAL%NSITES))

       RBPOTENTIAL%SITE(:,3) = 0.0D0

       RBPOTENTIAL%SITE( 1,1)=1.42D0
       RBPOTENTIAL%SITE( 1,2)=0.0D0
       RBPOTENTIAL%CHARGE( 1)=-0.0066D0

       RBPOTENTIAL%SITE( 2,1)=0.71D0
       RBPOTENTIAL%SITE( 2,2)=1.229755D0
       RBPOTENTIAL%CHARGE( 2)=-0.0066D0

       RBPOTENTIAL%SITE( 3,1)=-0.71D0
       RBPOTENTIAL%SITE( 3,2)=1.229755D0
       RBPOTENTIAL%CHARGE( 3)=-0.0066D0

       RBPOTENTIAL%SITE( 4,1)=-1.42D0
       RBPOTENTIAL%SITE( 4,2)=0.0D0
       RBPOTENTIAL%CHARGE( 4)=-0.0066D0

       RBPOTENTIAL%SITE( 5,1)=-0.71D0
       RBPOTENTIAL%SITE( 5,2)=-1.229755D0
       RBPOTENTIAL%CHARGE( 5)=-0.0066D0

       RBPOTENTIAL%SITE( 6,1)=0.71D0
       RBPOTENTIAL%SITE( 6,2)=-1.229755D0
       RBPOTENTIAL%CHARGE( 6)=-0.0066D0

       RBPOTENTIAL%SITE( 7,1)=2.838D0
       RBPOTENTIAL%SITE( 7,2)=0.0D0
       RBPOTENTIAL%CHARGE( 7)=0.0158D0

       RBPOTENTIAL%SITE( 8,1)=1.419D0
       RBPOTENTIAL%SITE( 8,2)=2.457779D0
       RBPOTENTIAL%CHARGE( 8)=0.0158D0

       RBPOTENTIAL%SITE( 9,1)=-1.419D0
       RBPOTENTIAL%SITE( 9,2)=2.457779D0
       RBPOTENTIAL%CHARGE( 9)=0.0158D0

       RBPOTENTIAL%SITE(10,1)=-2.838D0
       RBPOTENTIAL%SITE(10,2)=0.0D0
       RBPOTENTIAL%CHARGE(10)=0.0158D0

       RBPOTENTIAL%SITE(11,1)=-1.419D0
       RBPOTENTIAL%SITE(11,2)=-2.45779D0
       RBPOTENTIAL%CHARGE(11)=0.0158D0

       RBPOTENTIAL%SITE(12,1)=1.419D0
       RBPOTENTIAL%SITE(12,2)=-2.45779D0
       RBPOTENTIAL%CHARGE(12)=0.0158D0

       RBPOTENTIAL%SITE(13,1)=3.523366D0
       RBPOTENTIAL%SITE(13,2)=1.248219D0
       RBPOTENTIAL%CHARGE(13)=-0.0986D0

       RBPOTENTIAL%SITE(14,1)=2.842673D0
       RBPOTENTIAL%SITE(14,2)=2.427211D0
       RBPOTENTIAL%CHARGE(14)=-0.0986D0

       RBPOTENTIAL%SITE(15,1)=0.680706D0
       RBPOTENTIAL%SITE(15,2)=3.675430D0
       RBPOTENTIAL%CHARGE(15)=-0.0986D0

       RBPOTENTIAL%SITE(16,1)=-0.680677D0
       RBPOTENTIAL%SITE(16,2)=3.675437D0
       RBPOTENTIAL%CHARGE(16)=-0.0986D0

       RBPOTENTIAL%SITE(17,1)=-2.842673D0
       RBPOTENTIAL%SITE(17,2)=2.427211D0
       RBPOTENTIAL%CHARGE(17)=-0.0986D0

       RBPOTENTIAL%SITE(18,1)=-3.523366D0
       RBPOTENTIAL%SITE(18,2)=1.248219D0
       RBPOTENTIAL%CHARGE(18)=-0.0986D0

       RBPOTENTIAL%SITE(19,1)=-3.523366D0
       RBPOTENTIAL%SITE(19,2)=-1.248219D0
       RBPOTENTIAL%CHARGE(19)=-0.0986D0

       RBPOTENTIAL%SITE(20,1)=-2.842673D0
       RBPOTENTIAL%SITE(20,2)=-2.427211D0
       RBPOTENTIAL%CHARGE(20)=-0.0986D0

       RBPOTENTIAL%SITE(21,1)=-0.680677D0
       RBPOTENTIAL%SITE(21,2)=-3.675437D0
       RBPOTENTIAL%CHARGE(21)=-0.0986D0

       RBPOTENTIAL%SITE(22,1)=0.680706D0
       RBPOTENTIAL%SITE(22,2)=-3.675437D0
       RBPOTENTIAL%CHARGE(22)=-0.0986D0

       RBPOTENTIAL%SITE(23,1)=2.842673D0
       RBPOTENTIAL%SITE(23,2)=-2.427211D0
       RBPOTENTIAL%CHARGE(23)=-0.0986D0

       RBPOTENTIAL%SITE(24,1)=3.523366D0
       RBPOTENTIAL%SITE(24,2)=-1.248219D0
       RBPOTENTIAL%CHARGE(24)=-0.0986D0

       RBPOTENTIAL%SITE(25,1)=4.602048D0
       RBPOTENTIAL%SITE(25,2)=1.274393D0
       RBPOTENTIAL%CHARGE(25)=0.094D0

       RBPOTENTIAL%SITE(26,1)=3.404682D0
       RBPOTENTIAL%SITE(26,2)=3.348290D0
       RBPOTENTIAL%CHARGE(26)=0.094D0

       RBPOTENTIAL%SITE(27,1)=1.197383D0
       RBPOTENTIAL%SITE(27,2)=4.622681D0
       RBPOTENTIAL%CHARGE(27)=0.094D0

       RBPOTENTIAL%SITE(28,1)=-1.197347D0
       RBPOTENTIAL%SITE(28,2)=4.622693D0
       RBPOTENTIAL%CHARGE(28)=0.094D0

       RBPOTENTIAL%SITE(29,1)=-3.404682D0
       RBPOTENTIAL%SITE(29,2)=3.348290D0
       RBPOTENTIAL%CHARGE(29)=0.094D0

       RBPOTENTIAL%SITE(30,1)=-4.602048D0
       RBPOTENTIAL%SITE(30,2)=1.274393D0
       RBPOTENTIAL%CHARGE(30)=0.094D0

       RBPOTENTIAL%SITE(31,1)=-4.602048D0
       RBPOTENTIAL%SITE(31,2)=-1.274393D0
       RBPOTENTIAL%CHARGE(31)=0.094D0

       RBPOTENTIAL%SITE(32,1)=-3.404682D0
       RBPOTENTIAL%SITE(32,2)=-3.348290D0
       RBPOTENTIAL%CHARGE(32)=0.094D0

       RBPOTENTIAL%SITE(33,1)=-1.197347D0
       RBPOTENTIAL%SITE(33,2)=-4.622693D0
       RBPOTENTIAL%CHARGE(33)=0.094D0

       RBPOTENTIAL%SITE(34,1)=1.197383D0
       RBPOTENTIAL%SITE(34,2)=-4.622681D0
       RBPOTENTIAL%CHARGE(34)=0.094D0

       RBPOTENTIAL%SITE(35,1)=3.404682D0
       RBPOTENTIAL%SITE(35,2)=-3.348290D0
       RBPOTENTIAL%CHARGE(35)=0.094D0

       RBPOTENTIAL%SITE(36,1)=4.602048D0
       RBPOTENTIAL%SITE(36,2)=-1.274393D0
       RBPOTENTIAL%CHARGE(36)=0.094D0

    CASE ('C')
       IF (NUMRBTYPES.NE.1) THEN
          PRINT *, 'MULTIPLE CAPSID TYPES NOT YET INITIALISED'
          STOP
       ENDIF

       RBPOTENTIAL%NSITES = CAPSOMERDEFS(1)%NBASALSITES + 1
       RBPOTENTIAL%NPHYSICALSITES = RBPOTENTIAL%NSITES
       
       ALLOCATE(RBPOTENTIAL%SITE(RBPOTENTIAL%NSITES,3), RBPOTENTIAL%SITELABEL(RBPOTENTIAL%NSITES))
       ALLOCATE(RBPOTENTIAL%C6(RBPOTENTIAL%NSITES), RBPOTENTIAL%C12(RBPOTENTIAL%NSITES))
       ALLOCATE(RBPOTENTIAL%MORSEPARAMETERS(RBPOTENTIAL%NSITES,3))
       ALLOCATE(RBPOTENTIAL%MASS(RBPOTENTIAL%NSITES))

       RBPOTENTIAL%C6 = 0.0D0
       RBPOTENTIAL%C12 = 0.0D0

! SITES AROUND THE BASE
! MORSE PARAMETERS ARE IN THE ORDER EPSILON, RHO, RE
! AT THE MOMENT EPSILON AND RE ARE IMPLICITLY THE UNITS OF ENERGY AND DISTANCE, RESPECTIVELY

       DO CURRENTSITE = 1, CAPSOMERDEFS(1)%NBASALSITES
          CURRENTANGLE = (CURRENTSITE-1)*TWOPI/(1.0D0*CAPSOMERDEFS(1)%NBASALSITES)

          RBPOTENTIAL%SITE(CURRENTSITE,:) = (/CAPSOMERDEFS(1)%RADIUS*COS(CURRENTANGLE), &
                                              CAPSOMERDEFS(1)%RADIUS*SIN(CURRENTANGLE), &
                                              0.0D0/)
          
          RBPOTENTIAL%SITELABEL(CURRENTSITE) = 'C';
          RBPOTENTIAL%MORSEPARAMETERS(CURRENTSITE,:) = (/1.0D0,CAPSOMERDEFS(1)%RHO,1.0D0/)
          RBPOTENTIAL%MASS(CURRENTSITE) = 0.6D0
       ENDDO

! THEN THE REPULSIVE SITE AT THE APEX
! EPSILON_REPULSIVE IS SPECIFIED AS A FRACTION OF EPSILON_MORSE

       RBPOTENTIAL%SITE(RBPOTENTIAL%NSITES,:) = (/0.0D0, 0.0D0, CAPSOMERDEFS(1)%HEIGHT/)
       RBPOTENTIAL%SITELABEL(RBPOTENTIAL%NSITES) = 'O';
       RBPOTENTIAL%C12(RBPOTENTIAL%NSITES) = &
         CAPSOMERDEFS(1)%EPSILONREP*1.0D0*(1.0D0+CAPSOMERDEFS(1)%RADIUS*SQRT((SQRT(5.0D0)+5.0D0)/2.0D0))**12
       RBPOTENTIAL%MORSEPARAMETERS(RBPOTENTIAL%NSITES,:) = 0.0D0
       RBPOTENTIAL%MASS(RBPOTENTIAL%NSITES) = 3D0

       RBPOTENTIAL%FREQCONVFACTOR = 1D0    ! NO FREQUENCY CONVERSION JUST YET

!       DO CURRENTSITE = 1, RBPOTENTIAL%NSITES
!          PRINT *, RBPOTENTIAL%SITE(CURRENTSITE,1), RBPOTENTIAL%SITE(CURRENTSITE,2), RBPOTENTIAL%SITE(CURRENTSITE,3)
!       ENDDO
!       STOP
    CASE DEFAULT
       PRINT *, 'UNRECOGNISED ATOM TYPE PASSED TO RIGID BODY INITIALISATION:', ATOMTYPE
       STOP ! CALL EXIT(1)

    END SELECT

! OPTIONAL SPECIFICATION OF SYSTEM MASSES AND ATOMIC NUMBERS
! OPTIM USES THIS BUT GMIN DOESN`T

    IF (.NOT.ALLOCATED(RBPOTENTIAL%MASS)) THEN
       PRINT *, 'INITIALISERIGIDBODY> NO MASSES SPECIFIED SO INITIALISING TO DEFAULT VALUE (1.0)'
       ALLOCATE(RBPOTENTIAL%MASS(RBPOTENTIAL%NPHYSICALSITES))
       RBPOTENTIAL%MASS = 1.0D0
    ENDIF
 
    IF (.NOT.ALLOCATED(RBPOTENTIAL%ATOMICNUMBER)) THEN
       PRINT *, 'INITIALISERIGIDBODY> NO ATOMIC NUMBERS SPECIFIED SO INITIALISING TO DEFAULT VALUE (0)'
       ALLOCATE(RBPOTENTIAL%ATOMICNUMBER(RBPOTENTIAL%NPHYSICALSITES))
       RBPOTENTIAL%ATOMICNUMBER = 0
    ENDIF
      
    IF (PRESENT(SYSTEMMASSES)) THEN
       IF (.NOT.PRESENT(NBODIES)) THEN
          PRINT *, 'INITIALISERIGIDBODY> MUST SPECIFY NUMBER OF BODIES IF YOU WISH TO INITIALISE SYSTEM MASSES'
          STOP ! CALL EXIT(1)
       ENDIF

       ALLOCATE(SYSTEMMASSES(NBODIES*RBPOTENTIAL%NPHYSICALSITES))

       DO CURRENTBODY = 1, NBODIES
          SYSTEMMASSES((CURRENTBODY-1)*RBPOTENTIAL%NPHYSICALSITES+1:CURRENTBODY*RBPOTENTIAL%NPHYSICALSITES) = &
               RBPOTENTIAL%MASS
       ENDDO
    ENDIF

    IF (PRESENT(SYSTEMATNUMBERS)) THEN
       IF (.NOT.PRESENT(NBODIES)) THEN
          PRINT *, 'INITIALISERIGIDBODY> MUST SPECIFY NUMBER OF BODIES IF YOU WISH TO INITIALISE SYSTEM ATOMIC NUMBERS'
          STOP ! CALL EXIT(1)
       ENDIF

       ALLOCATE(SYSTEMATNUMBERS(NBODIES*RBPOTENTIAL%NPHYSICALSITES))
       DO CURRENTBODY = 1, NBODIES
          SYSTEMATNUMBERS((CURRENTBODY-1)*RBPOTENTIAL%NPHYSICALSITES+1:CURRENTBODY*RBPOTENTIAL%NPHYSICALSITES) = &
               RBPOTENTIAL%ATOMICNUMBER
       ENDDO
    ENDIF

    CALL INITIALISEINTERACTIONMAP

  END SUBROUTINE INITIALISERIGIDBODY

! #####################################################################################################

! SAVES US HAVING TO CHECK EXPLICITLY IN THE POTENTIAL EVALUATION ROUTINE

  SUBROUTINE INITIALISEINTERACTIONMAP
    IMPLICIT NONE

    INTEGER :: SITE1, SITE2

    IF (ALLOCATED(SITESINTERACT)) THEN
       IF (SIZE(SITESINTERACT,1).NE.RBPOTENTIAL%NSITES .OR. SIZE(SITESINTERACT,2).NE.RBPOTENTIAL%NSITES) THEN
          DEALLOCATE(SITESINTERACT)
          ALLOCATE(SITESINTERACT(RBPOTENTIAL%NSITES, RBPOTENTIAL%NSITES, 4))
       ENDIF
    ELSE
       ALLOCATE(SITESINTERACT(RBPOTENTIAL%NSITES,RBPOTENTIAL%NSITES, 4))
    ENDIF

    SITESINTERACT = .FALSE.

    DO SITE1 = 1, RBPOTENTIAL%NSITES
       DO SITE2 = 1, RBPOTENTIAL%NSITES

! COULOMB INTERACTION

          IF (ALLOCATED(RBPOTENTIAL%CHARGE)) THEN
             IF (RBPOTENTIAL%CHARGE(SITE1).NE.0.0D0 .AND. RBPOTENTIAL%CHARGE(SITE2).NE.0.0D0) THEN
                SITESINTERACT(SITE1, SITE2, 1) = .TRUE.
                SITESINTERACT(SITE1, SITE2, 2) = .TRUE.   
             ENDIF
          ENDIF

! LJ INTERACTION

          IF (ALLOCATED(RBPOTENTIAL%C6) .AND. ALLOCATED(RBPOTENTIAL%C12)) THEN
              IF ((RBPOTENTIAL%C6(SITE1).NE.0.0D0 .OR. RBPOTENTIAL%C12(SITE1).NE.0.0D0) .AND. &
                   (RBPOTENTIAL%C6(SITE2).NE.0.0D0 .OR. RBPOTENTIAL%C12(SITE2).NE.0.0D0)) THEN
                 SITESINTERACT(SITE1, SITE2, 1) = .TRUE.
                 SITESINTERACT(SITE1, SITE2, 3) = .TRUE.
              ENDIF
          ENDIF

! MORSE INTERACTION

          IF (ALLOCATED(RBPOTENTIAL%MORSEPARAMETERS)) THEN
              IF (RBPOTENTIAL%MORSEPARAMETERS(SITE1,1).NE.0.0D0 .AND. &
                   RBPOTENTIAL%MORSEPARAMETERS(SITE2,1).NE.0.0D0) THEN
                 SITESINTERACT(SITE1, SITE2, 1) = .TRUE.
                 SITESINTERACT(SITE1, SITE2, 4) = .TRUE.
              ENDIF
          ENDIF
       ENDDO
    ENDDO

  END SUBROUTINE INITIALISEINTERACTIONMAP

! #####################################################################################################

! RETURN ALLOCATED MEMORY ON REQUEST

  SUBROUTINE CLEANRIGIDBODIES
    IMPLICIT NONE
    
    IF (ALLOCATED(RBPOTENTIAL%SITE)) DEALLOCATE(RBPOTENTIAL%SITE)
    IF (ALLOCATED(RBPOTENTIAL%SITELABEL)) DEALLOCATE(RBPOTENTIAL%SITELABEL)
    IF (ALLOCATED(RBPOTENTIAL%MASS)) DEALLOCATE(RBPOTENTIAL%MASS)
    IF (ALLOCATED(RBPOTENTIAL%ATOMICNUMBER)) DEALLOCATE(RBPOTENTIAL%ATOMICNUMBER)
    IF (ALLOCATED(RBPOTENTIAL%CHARGE)) DEALLOCATE(RBPOTENTIAL%CHARGE)
    IF (ALLOCATED(RBPOTENTIAL%C6)) DEALLOCATE(RBPOTENTIAL%C6)
    IF (ALLOCATED(RBPOTENTIAL%C12)) DEALLOCATE(RBPOTENTIAL%C12)
    IF (ALLOCATED(RBPOTENTIAL%MORSEPARAMETERS)) DEALLOCATE(RBPOTENTIAL%MORSEPARAMETERS)

    IF (ALLOCATED(SITESINTERACT)) DEALLOCATE(SITESINTERACT)

  END SUBROUTINE CLEANRIGIDBODIES

! #####################################################################################################

! MOVES THE CENTER OF MASS OF THE REFERENCE GEOMETRY TO THE ORIGIN
! THIS IS NECESSARY FOR SOME IMPLEMENTATIONS OF THE NORMAL MODE ANALYSIS

  SUBROUTINE COMTOORIGIN ()

    IMPLICIT NONE

    DOUBLE PRECISION :: INITIALCOM(3)
    INTEGER :: CURRENTSITE

! CHECK WE HAVE RELEVANT DATA

    IF (.NOT.ALLOCATED(RBPOTENTIAL%SITE)) THEN
       PRINT *, 'CANNOT PERFORM COM CALCULATION WITHOUT SPECIFIED SITES'
       STOP ! CALL EXIT(1)
    ELSE IF (.NOT.ALLOCATED(RBPOTENTIAL%MASS)) THEN
       PRINT *, 'CANNOT PERFORM COM CALCULATION WITHOUT SPECIFIED MASSES'
       STOP ! CALL EXIT(1)
    ENDIF

! CALCULATE INITIAL COM - USE ONLY PHYSICAL SITES

    INITIALCOM = 0.0D0

    DO CURRENTSITE = 1, RBPOTENTIAL%NPHYSICALSITES
       INITIALCOM = INITIALCOM + RBPOTENTIAL%MASS(CURRENTSITE)*RBPOTENTIAL%SITE(CURRENTSITE,:)
    ENDDO

    INITIALCOM = INITIALCOM/MONOMERMASS()

! CORRECT ALL SITES

    DO CURRENTSITE = 1, RBPOTENTIAL%NSITES
       RBPOTENTIAL%SITE(CURRENTSITE,:) = RBPOTENTIAL%SITE(CURRENTSITE,:) - INITIALCOM
    ENDDO

    RETURN

  END SUBROUTINE COMTOORIGIN

! #####################################################################################################

! CARTESIAN GENERATION ROUTINES

  FUNCTION CARTESIANX (REFSITE,XCOC,PX,PY,PZ)
    IMPLICIT NONE
    DOUBLE PRECISION :: CARTESIANX
    DOUBLE PRECISION, INTENT(IN) :: REFSITE(3),XCOC,PX,PY,PZ 

   DOUBLE PRECISION :: ANGLE, COS_ANGLE, COS_FACTOR, SIN_FACTOR 

! NORMALISE THE ROTATIONAL VARIABLES

    ANGLE = DSQRT(PX**2 + PY**2 + PZ**2)
    COS_ANGLE = COS(ANGLE)

    IF (ANGLE.LT.SMALLANGLE) THEN
!       PRINT *, 'SMALL ANGLE APPROXIMATION IN CARTESIANX'
       COS_FACTOR = 0.5D0 - (ANGLE**2)/24.0D0
       SIN_FACTOR = 1.0D0 - (ANGLE**2)/6.0D0
    ELSE
       COS_FACTOR = (1.0D0-COS_ANGLE)/(ANGLE**2)
       SIN_FACTOR = SIN(ANGLE)/ANGLE
    ENDIF

    CARTESIANX =  XCOC + REFSITE(1)*COS_ANGLE + &
                  PX*(PX*REFSITE(1)+PY*REFSITE(2)+PZ*REFSITE(3))*COS_FACTOR + &
                  (REFSITE(2)*PZ - REFSITE(3)*PY)*SIN_FACTOR
    RETURN
  END FUNCTION CARTESIANX

! #####################################################################################################

  FUNCTION CARTESIANY (REFSITE,YCOC,PX,PY,PZ)
    IMPLICIT NONE
    DOUBLE PRECISION :: CARTESIANY
    DOUBLE PRECISION, INTENT(IN) :: REFSITE(3),YCOC,PX,PY,PZ 

    DOUBLE PRECISION :: ANGLE, COS_ANGLE, COS_FACTOR, SIN_FACTOR

! NORMALISE THE ROTATIONAL VARIABLES

    ANGLE = DSQRT(PX**2 + PY**2 + PZ**2)
    COS_ANGLE = COS(ANGLE)   

    IF (ANGLE.LT.SMALLANGLE) THEN
!       PRINT *, 'SMALL ANGLE APPROXIMATION IN CARTESIANY'
       COS_FACTOR = 0.5D0 - (ANGLE**2)/24.0D0
       SIN_FACTOR = 1.0D0 - (ANGLE**2)/6.0D0
    ELSE
       COS_FACTOR = (1.0D0-COS_ANGLE)/(ANGLE**2)
       SIN_FACTOR = SIN(ANGLE)/ANGLE
    ENDIF

    CARTESIANY = YCOC + REFSITE(2)*COS_ANGLE + &
                 PY*(PX*REFSITE(1)+PY*REFSITE(2)+PZ*REFSITE(3))*COS_FACTOR + &
                 (REFSITE(3)*PX - REFSITE(1)*PZ)*SIN_FACTOR

    RETURN
  END FUNCTION CARTESIANY

! #####################################################################################################

  FUNCTION CARTESIANZ (REFSITE,ZCOC,PX,PY,PZ)
    IMPLICIT NONE
    DOUBLE PRECISION :: CARTESIANZ
    DOUBLE PRECISION, INTENT(IN) :: REFSITE(3),ZCOC,PX,PY,PZ 

    DOUBLE PRECISION :: ANGLE, COS_ANGLE, COS_FACTOR, SIN_FACTOR

! NORMALISE THE ROTATIONAL VARIABLES

    ANGLE = DSQRT(PX**2 + PY**2 + PZ**2)
    COS_ANGLE = COS(ANGLE)   

    IF (ANGLE.LT.SMALLANGLE) THEN
!       PRINT *, 'SMALL ANGLE APPROXIMATION IN CARTESIANZ'
       COS_FACTOR = 0.5D0 - (ANGLE**2)/24.0D0
       SIN_FACTOR = 1.0D0 - (ANGLE**2)/6.0D0
    ELSE
       COS_FACTOR = (1.0D0-COS_ANGLE)/(ANGLE**2)
       SIN_FACTOR = SIN(ANGLE)/ANGLE
    ENDIF

    CARTESIANZ = ZCOC + REFSITE(3)*COS_ANGLE + &
                 PZ*(PX*REFSITE(1)+PY*REFSITE(2)+PZ*REFSITE(3))*COS_FACTOR + &
                 (REFSITE(1)*PY - REFSITE(2)*PX)*SIN_FACTOR
    RETURN
  END FUNCTION CARTESIANZ

! #####################################################################################################

  FUNCTION CARTESIANSEPARATION(REFSITE1,XCOC1,YCOC1,ZCOC1,PX1,PY1,PZ1, &
                               REFSITE2,XCOC2,YCOC2,ZCOC2,PX2,PY2,PZ2)

    IMPLICIT NONE

    DOUBLE PRECISION :: CARTESIANSEPARATION
    DOUBLE PRECISION, INTENT(IN) :: REFSITE1(3),XCOC1,YCOC1,ZCOC1,PX1,PY1,PZ1
    DOUBLE PRECISION, INTENT(IN) :: REFSITE2(3),XCOC2,YCOC2,ZCOC2,PX2,PY2,PZ2
    
    CARTESIANSEPARATION = DSQRT((CARTESIANX(REFSITE1,XCOC1,PX1,PY1,PZ1) -     &
                                 CARTESIANX(REFSITE2,XCOC2,PX2,PY2,PZ2))**2 + &
                                (CARTESIANY(REFSITE1,YCOC1,PX1,PY1,PZ1) -     &
                                 CARTESIANY(REFSITE2,YCOC2,PX2,PY2,PZ2))**2 + &
                                (CARTESIANZ(REFSITE1,ZCOC1,PX1,PY1,PZ1) -     &
                                 CARTESIANZ(REFSITE2,ZCOC2,PX2,PY2,PZ2))**2)
    
    RETURN
  END FUNCTION CARTESIANSEPARATION

! #####################################################################################################

! CONVERT TO CARTESIANS FOR THE PURPOSES OF CALCULATING PATH LENGTHS ETC
! ASSUMES THAT THE PHYSICAL SITES ARE SPECIFIED FIRST IN THE LIST

  SUBROUTINE MONOMERTOCARTESIANS (XCOC,YCOC,ZCOC,PX,PY,PZ,CARTESIANS)
    IMPLICIT NONE

! SUBROUTINE ARGUMENTS

    DOUBLE PRECISION, INTENT(IN) :: XCOC,YCOC,ZCOC,PX,PY,PZ
    DOUBLE PRECISION, INTENT(OUT) :: CARTESIANS (3*RBPOTENTIAL%NPHYSICALSITES)
    
! LOCAL VARIABLES

    INTEGER :: CURRENTSITE
    DOUBLE PRECISION :: ANGLE, PDOTX0, COS_ANGLE, COS_FACTOR, SIN_FACTOR  

! WORK OUT THE ANGLE, THIS ONLY NEEDS TO BE DONE ONCE

    ANGLE = DSQRT(PX**2 + PY**2 + PZ**2)
    COS_ANGLE = COS(ANGLE)

    IF (ANGLE.LT.SMALLANGLE) THEN
!       PRINT *, 'SMALL ANGLE APPROXIMATION IN MONOMERTOCARTESIANS'
       COS_FACTOR = 0.5D0 - (ANGLE**2)/24.0D0
       SIN_FACTOR = 1.0D0 - (ANGLE**2)/6.0D0
    ELSE
       COS_FACTOR = (1.0D0-COS_ANGLE)/(ANGLE**2)
       SIN_FACTOR = SIN(ANGLE)/ANGLE
    ENDIF

! RUN THROUGH THE SITES

    DO CURRENTSITE=1, RBPOTENTIAL%NPHYSICALSITES
       PDOTX0 = PX*RBPOTENTIAL%SITE(CURRENTSITE,1)+PY*RBPOTENTIAL%SITE(CURRENTSITE,2)+PZ*RBPOTENTIAL%SITE(CURRENTSITE,3)

       CARTESIANS(3*CURRENTSITE-2) =  XCOC + RBPOTENTIAL%SITE(CURRENTSITE,1)*COS_ANGLE + &
            PX*PDOTX0*COS_FACTOR + &
            (RBPOTENTIAL%SITE(CURRENTSITE,2)*PZ - RBPOTENTIAL%SITE(CURRENTSITE,3)*PY)*SIN_FACTOR

       CARTESIANS(3*CURRENTSITE-1) = YCOC + RBPOTENTIAL%SITE(CURRENTSITE,2)*COS_ANGLE + &
                 PY*PDOTX0*COS_FACTOR + &
                 (RBPOTENTIAL%SITE(CURRENTSITE,3)*PX - RBPOTENTIAL%SITE(CURRENTSITE,1)*PZ)*SIN_FACTOR

       CARTESIANS(3*CURRENTSITE) = ZCOC + RBPOTENTIAL%SITE(CURRENTSITE,3)*COS_ANGLE + &
                 PZ*PDOTX0*COS_FACTOR + &
                 (RBPOTENTIAL%SITE(CURRENTSITE,1)*PY - RBPOTENTIAL%SITE(CURRENTSITE,2)*PX)*SIN_FACTOR

!       CARTESIANS(3*CURRENTSITE-2) = CARTESIANX(RBPOTENTIAL%SITE(CURRENTSITE,:),XCOC,PX,PY,PZ) 
!       CARTESIANS(3*CURRENTSITE-1) = CARTESIANY(RBPOTENTIAL%SITE(CURRENTSITE,:),YCOC,PX,PY,PZ)
!       CARTESIANS(3*CURRENTSITE) =   CARTESIANZ(RBPOTENTIAL%SITE(CURRENTSITE,:),ZCOC,PX,PY,PZ)
    ENDDO

  END SUBROUTINE MONOMERTOCARTESIANS

! #####################################################################################################

  SUBROUTINE SYSTEMTOCARTESIANS (NBODIES, ANGLEAXISCOORDS, CARTESIANCOORDS)
    IMPLICIT NONE

! SUBROUTINE ARGUMENTS

    INTEGER, INTENT(IN) :: NBODIES
    DOUBLE PRECISION, INTENT(IN) :: ANGLEAXISCOORDS(6*NBODIES)
    DOUBLE PRECISION, INTENT(OUT) :: CARTESIANCOORDS(NBODIES*RBPOTENTIAL%NPHYSICALSITES*3)  
    
! LOCAL VARIABLES

    INTEGER :: CURRENTBODY

    CARTESIANCOORDS = 0.0D0

    DO CURRENTBODY = 1, NBODIES
       CALL MONOMERTOCARTESIANS(ANGLEAXISCOORDS(3*CURRENTBODY-2), &
                                ANGLEAXISCOORDS(3*CURRENTBODY-1), &
                                ANGLEAXISCOORDS(3*CURRENTBODY), &
                                ANGLEAXISCOORDS(3*(CURRENTBODY+NBODIES)-2), &
                                ANGLEAXISCOORDS(3*(CURRENTBODY+NBODIES)-1), &
                                ANGLEAXISCOORDS(3*(CURRENTBODY+NBODIES)), &
         CARTESIANCOORDS((CURRENTBODY-1)*RBPOTENTIAL%NPHYSICALSITES*3+1:CURRENTBODY*RBPOTENTIAL%NPHYSICALSITES*3))
    ENDDO

  END SUBROUTINE SYSTEMTOCARTESIANS

! #####################################################################################################

  SUBROUTINE WRITETOCARTESIANSTREAM (WRITEUNIT, NBODIES, ANGLEAXISCOORDS, COMMENT)

    IMPLICIT NONE

! SUBROUTINE ARGUMENTS

    INTEGER, INTENT(IN) :: WRITEUNIT
    INTEGER, INTENT(IN) :: NBODIES
    DOUBLE PRECISION, INTENT(IN) :: ANGLEAXISCOORDS(6*NBODIES)
    CHARACTER(*), INTENT(IN) :: COMMENT

! LOCAL VARIABLES

    DOUBLE PRECISION :: CARTESIANS(3*NBODIES*RBPOTENTIAL%NPHYSICALSITES)
    INTEGER :: NCARTPOINTS, I

! CONVERT TO CARTESIANS AND WRITE TO SPECIFIED UNIT

    CALL SYSTEMTOCARTESIANS(NBODIES, ANGLEAXISCOORDS, CARTESIANS)

    NCARTPOINTS = NBODIES*RBPOTENTIAL%NPHYSICALSITES
    WRITE(WRITEUNIT, *) NCARTPOINTS
    WRITE(WRITEUNIT, *) TRIM(COMMENT)

    DO I = 1, NCARTPOINTS
       WRITE(WRITEUNIT,'(A5,4X,3G20.10)') RBPOTENTIAL%SITELABEL(MOD(I-1,RBPOTENTIAL%NPHYSICALSITES)+1), &
            CARTESIANS(3*(I-1)+1), CARTESIANS(3*(I-1)+2), CARTESIANS(3*(I-1)+3)
    ENDDO

  END SUBROUTINE WRITETOCARTESIANSTREAM

! #####################################################################################################

! CONVERTS A SINGLE MONOMER FROM CARTESIANS TO ANGLE-AXIS COORDINATES

  SUBROUTINE MONOMERTOAA (CARTESIANS, AATRANS, AAROT)

    IMPLICIT NONE

    DOUBLE PRECISION, INTENT(IN) :: CARTESIANS(RBPOTENTIAL%NPHYSICALSITES,3)
    DOUBLE PRECISION, INTENT(OUT) :: AATRANS(3), AAROT(3)    

    DOUBLE PRECISION :: FITTINGRMSD    
    DOUBLE PRECISION :: RMSDTOL = 1D-6
    INTEGER :: I, J  

! SIMPLY USES THE QUATERNION FITTING METHOD TO DETERMINE THE NECESSARY PARAMETERS, NOT VERY EFFICIENT

    CALL QUATERNIONMATCH(RBPOTENTIAL%NPHYSICALSITES, CARTESIANS, RBPOTENTIAL%SITE(1:RBPOTENTIAL%NPHYSICALSITES,:), &
                         FITTINGRMSD, AAROT, AATRANS)

    IF (FITTINGRMSD.GT.RMSDTOL) THEN
       PRINT *, 'ERROR IN ATTEMPTING TO CONVERT CARTESIANS TO ANGLE-AXIS COORDINATES: RMSD IS TOO HIGH', FITTINGRMSD
!       STOP ! CALL EXIT(1)
    ENDIF

  END SUBROUTINE MONOMERTOAA

! #####################################################################################################

  SUBROUTINE SYSTEMTOAA (NBODIES, CARTESIANS, AACOORDS)

    IMPLICIT NONE
    
! SUBROUTINE ARGUMENTS

    INTEGER, INTENT(IN) :: NBODIES
    DOUBLE PRECISION, INTENT(IN) :: CARTESIANS(RBPOTENTIAL%NPHYSICALSITES*NBODIES,3)
    DOUBLE PRECISION, INTENT(OUT) :: AACOORDS(6*NBODIES)

! LOCAL VARIABLES

    INTEGER :: CURRENTBODY

    DO CURRENTBODY=1,NBODIES
       CALL MONOMERTOAA(CARTESIANS(RBPOTENTIAL%NPHYSICALSITES*(CURRENTBODY-1)+1:RBPOTENTIAL%NPHYSICALSITES*CURRENTBODY,:), &
                        AACOORDS(3*CURRENTBODY-2:3*CURRENTBODY), &
                        AACOORDS(3*(CURRENTBODY+NBODIES)-2:3*(CURRENTBODY+NBODIES)))
    ENDDO
    
  END SUBROUTINE SYSTEMTOAA

! #####################################################################################################

  FUNCTION MONOMERMASS ()

    IMPLICIT NONE

    DOUBLE PRECISION :: MONOMERMASS
 
    MONOMERMASS = SUM(RBPOTENTIAL%MASS)
    RETURN

  END FUNCTION MONOMERMASS

! #####################################################################################################

! INTERACTION FUNCTIONS AND DERIVATIVES, NOTE NO UNIT CONVERSION IS ATTEMPTED

! #####################################################################################################

! LENNARD-JONES INTERACTIONS

  FUNCTION FLJ(K12,K6,DISTANCE)
    IMPLICIT NONE
    DOUBLE PRECISION :: FLJ
    DOUBLE PRECISION, INTENT(IN) :: K12, K6    ! C12 AND C6 COEFFICIENTS 
    DOUBLE PRECISION, INTENT(IN) :: DISTANCE

    DOUBLE PRECISION :: INVR6

    INVR6 = 1.0D0/(DISTANCE**6)
    FLJ = INVR6*(K12*INVR6 - K6)

    RETURN

  END FUNCTION FLJ

! #####################################################################################################

  FUNCTION DFLJDR(K12,K6,DISTANCE)
    IMPLICIT NONE
    DOUBLE PRECISION :: DFLJDR
    DOUBLE PRECISION, INTENT(IN) :: K12, K6    ! C12 AND C6 COEFFICIENTS 
    DOUBLE PRECISION, INTENT(IN) :: DISTANCE

    DOUBLE PRECISION :: INVR, INVR6

    INVR = 1.0D0/DISTANCE
    INVR6 = INVR**6

    DFLJDR = -6.0D0*(-K6+2.0D0*K12*INVR6)*INVR*INVR6
!    DFLJDR = -6.0D0*(-K6+2.0D0*K12/(DISTANCE**6))/(DISTANCE**7)

    RETURN

  END FUNCTION DFLJDR

! #####################################################################################################

  FUNCTION D2FLJDR2(K12,K6,DISTANCE)
    IMPLICIT NONE
    DOUBLE PRECISION :: D2FLJDR2
    DOUBLE PRECISION, INTENT(IN) :: K12, K6    ! C12 AND C6 COEFFICIENTS 
    DOUBLE PRECISION, INTENT(IN) :: DISTANCE

    DOUBLE PRECISION :: INVR2, INVR6

    INVR2 = 1.0D0/(DISTANCE**2)
    INVR6 = INVR2**3

    D2FLJDR2 = 6.0D0*(26.0D0*K12*INVR6 - 7.0D0*K6)*INVR2*INVR6
!    D2FLJDR2 = 6.0D0*(26.0D0*K12/DISTANCE**6 - 7.0D0*K6)/DISTANCE**8
    RETURN

  END FUNCTION D2FLJDR2

! #####################################################################################################

! COULOMBIC INTERACTIONS

  FUNCTION FCOULOMB (Q1, Q2, DISTANCE)
    IMPLICIT NONE
    DOUBLE PRECISION :: FCOULOMB
    DOUBLE PRECISION, INTENT(IN) :: Q1, Q2
    DOUBLE PRECISION, INTENT(IN) :: DISTANCE

    FCOULOMB = Q1*Q2/DISTANCE

    RETURN
  END FUNCTION FCOULOMB

! #####################################################################################################

  FUNCTION DFCOULOMBDR (Q1, Q2, DISTANCE)
    IMPLICIT NONE
    DOUBLE PRECISION :: DFCOULOMBDR
    DOUBLE PRECISION, INTENT(IN) :: Q1, Q2
    DOUBLE PRECISION, INTENT(IN) :: DISTANCE

    DFCOULOMBDR = -Q1*Q2/(DISTANCE**2)

    RETURN
  END FUNCTION DFCOULOMBDR

! #####################################################################################################

  FUNCTION D2FCOULOMBDR2 (Q1, Q2, DISTANCE)
    IMPLICIT NONE
    DOUBLE PRECISION :: D2FCOULOMBDR2
    DOUBLE PRECISION, INTENT(IN) :: Q1, Q2
    DOUBLE PRECISION, INTENT(IN) :: DISTANCE

    D2FCOULOMBDR2 = 2.0D0*Q1*Q2/(DISTANCE**3)

    RETURN
  END FUNCTION D2FCOULOMBDR2

! #####################################################################################################

! NOTE THIS MORSE FUNCTION IS SHIFTED DOWN BY EPSILON

  FUNCTION FMORSE(EPSILON, RHO, RE, DISTANCE)
    IMPLICIT NONE
    DOUBLE PRECISION :: FMORSE
    DOUBLE PRECISION, INTENT(IN) :: EPSILON, RHO, RE   ! MORSE PARAMETERS
    DOUBLE PRECISION, INTENT(IN) :: DISTANCE    

    FMORSE = EPSILON*((1.0D0-EXP(RHO*(1.0D0 - DISTANCE/RE)))**2 - 1.0D0)

  END FUNCTION FMORSE

! #####################################################################################################

  FUNCTION DFMORSEDR(EPSILON, RHO, RE, DISTANCE)
    IMPLICIT NONE
    DOUBLE PRECISION :: DFMORSEDR
    DOUBLE PRECISION, INTENT(IN) :: EPSILON, RHO, RE   ! MORSE PARAMETERS
    DOUBLE PRECISION, INTENT(IN) :: DISTANCE 

    DOUBLE PRECISION :: EXPFACTOR

    EXPFACTOR = EXP(RHO*(1.0D0-DISTANCE/RE))

    DFMORSEDR = 2.0D0*EPSILON*RHO*(1.0D0 - EXPFACTOR)*EXPFACTOR/RE

  END FUNCTION DFMORSEDR

! #####################################################################################################

  FUNCTION D2FMORSEDR2(EPSILON, RHO, RE, DISTANCE)
    IMPLICIT NONE
    DOUBLE PRECISION :: D2FMORSEDR2
    DOUBLE PRECISION, INTENT(IN) :: EPSILON, RHO, RE   ! MORSE PARAMETERS
    DOUBLE PRECISION, INTENT(IN) :: DISTANCE 

    DOUBLE PRECISION :: EXPFACTOR

    EXPFACTOR = EXP(RHO*(1.0D0-DISTANCE/RE))

    D2FMORSEDR2 = 2.0D0*EPSILON*(RHO**2)*EXPFACTOR*(2.0D0*EXPFACTOR - 1.0D0)/(RE**2)

  END FUNCTION D2FMORSEDR2

! #####################################################################################################

  SUBROUTINE UPDATEC12(NEWVALUE) 

    IMPLICIT NONE

    DOUBLE PRECISION, INTENT(IN) :: NEWVALUE
    INTEGER :: CURRENTSITE
    
    IF (ALLOCATED(RBPOTENTIAL%C12)) THEN
       DO CURRENTSITE = 1, RBPOTENTIAL%NSITES
          IF (RBPOTENTIAL%C12(CURRENTSITE).NE.0.0D0) RBPOTENTIAL%C12(CURRENTSITE) = NEWVALUE
       ENDDO
    ENDIF

    CALL INITIALISEINTERACTIONMAP

  END SUBROUTINE UPDATEC12

! #####################################################################################################

  SUBROUTINE UPDATEC6(NEWVALUE) 

    IMPLICIT NONE

    DOUBLE PRECISION, INTENT(IN) :: NEWVALUE
    INTEGER :: CURRENTSITE
    
    IF (.NOT.ALLOCATED(RBPOTENTIAL%C6)) THEN
       ALLOCATE(RBPOTENTIAL%C6(RBPOTENTIAL%NSITES))
       RBPOTENTIAL%C6 = 0.0D0
    ENDIF

    RBPOTENTIAL%C6(RBPOTENTIAL%NSITES) = NEWVALUE

    CALL INITIALISEINTERACTIONMAP

  END SUBROUTINE UPDATEC6

! #####################################################################################################

End module rigidbodymod
