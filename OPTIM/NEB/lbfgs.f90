!   COPYRIGHT (C) 2003-2006 SEMEN A. TRYGUBENKO AND DAVID J. WALES
!   THIS FILE IS PART OF NEB MODULE. NEB MODULE IS PART OF OPTIM.
!
!   OPTIM IS FREE SOFTWARE; YOU CAN REDISTRIBUTE IT AND/OR MODIFY
!   IT UNDER THE TERMS OF THE GNU GENERAL PUBLIC LICENSE AS PUBLISHED BY
!   THE FREE SOFTWARE FOUNDATION; EITHER VERSION 2 OF THE LICENSE, OR
!   (AT YOUR OPTION) ANY LATER VERSION.
!
!   OPTIM IS DISTRIBUTED IN THE HOPE THAT IT WILL BE USEFUL,
!   BUT WITHOUT ANY WARRANTY; WITHOUT EVEN THE IMPLIED WARRANTY OF
!   MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.  SEE THE
!   GNU GENERAL PUBLIC LICENSE FOR MORE DETAILS.
!
!   YOU SHOULD HAVE RECEIVED A COPY OF THE GNU GENERAL PUBLIC LICENSE
!   ALONG WITH THIS PROGRAM; IF NOT, WRITE TO THE FREE SOFTWARE
!   FOUNDATION, INC., 59 TEMPLE PLACE, SUITE 330, BOSTON, MA  02111-1307  USA
!
MODULE MINIMISER1
     IMPLICIT NONE
     CONTAINS

SUBROUTINE NEBBFGS(D,U,NPERSIST,PERSISTENT)
     USE KEYMINIMIZER
     USE KEYLBFGS
     USE NEBDATA
     USE KEYNEB,ONLY: NIMAGE,MOREPRINTING,DUMPNEBXYZ,DUMPNEBXYZFREQ,DUMPNEBEOS,DUMPNEBEOSFREQ,DEBUG,&
     & DUMPNEBPTS,DUMPNEBPTSFREQ
     USE NEBUTILS
     USE GRADIENTS
     USE NEBOUTPUT
     USE PORFUNCS
     USE MODCHARMM, ONLY : CHRMMT,CHECKOMEGAT
     USE KEY, ONLY : FREEZENODEST, FREEZETOL, DESMDEBUG, MAXNEBBFGS, NEBMUPDATE, NEBDGUESS, &
          & DESMAXEJUMP,INTEPSILON, DESMAXAVGE, KADJUSTFRAC, KADJUSTFRQ, DNEBSWITCH, KADJUSTTOL, NEBRESEEDT, &
          & NEBRESEEDINT, NEBRESEEDEMAX, NEBRESEEDBMAX, NEBKFINAL, NEBFACTOR, &
          & NREPMAX, ORDERI, ORDERJ, EPSALPHA, NREPULSIVE, DISTREF, ADDREPT, NEBKINITIAL, &
          & NEBRESEEDDEL1, NEBRESEEDDEL2, NEBRESEEDPOW1, NEBRESEEDPOW2, REPPOW, &
          & BULKT, REDOTSIM, NREPMAX, COLDFUSIONLIMIT
     USE INTCOMMONS, ONLY : DESMINT, NNZ, KD, NINTC, PREVDIH, DIHINFO
     USE COMMONS, ONLY: REDOPATHNEB

     IMPLICIT NONE 

     INTEGER,INTENT(IN) :: D,U  ! DIMENSIONALITY OF THE PROBLEM AND NUMBER OF UPDATES
     INTEGER NPERSIST           ! NUMBER OF PERSISTENT MINIMA
     INTEGER PERSISTTHRESH      ! PERSISTENCE THRESHOLD
     LOGICAL PERSISTENT(NIMAGE+2) ! LOGICAL ARRAY TO IDENTIFY PERSISTENT MINIMA
     INTEGER NTIMESMIN(NIMAGE+2)  ! NUMBER OF CONSECUTIVE STEPS THIS IMAGE IS A LOCAL MINIMUM
     LOGICAL NOTNEW 
     DOUBLE PRECISION DIJ, DMAX, DS, DF, EWORST, EMAX
     DOUBLE PRECISION, ALLOCATABLE :: REPTEMP(:)
     INTEGER, ALLOCATABLE :: IREPTEMP(:)
     INTEGER MAXIM, NDECREASE, NFAIL
     LOGICAL KNOWE, KNOWG, KNOWH, ADDATOM
     COMMON /KNOWN/ KNOWE, KNOWG, KNOWH

     INTEGER :: J2,POINT,BOUND,NPT,CP,I,ISTAT,J1,JMINUS,JPLUS,J3,JDO,J4,NPEPFAIL,NBADTOTAL
     INTEGER AT1(NATOMS),AT2(NATOMS),AT3(NATOMS),AT4(NATOMS)
     DOUBLE PRECISION :: YS,YY,SQ,YR,BETA,GNORM,DDOT,DUMMY,STPMIN,PREVGRAD,MEANSEP,EMINUS,EPLUS, &
  &                      LCOORDS(3*NATOMS), ENERGY, INVDTOACTIVE(NATOMS), STIME
     DOUBLE PRECISION,DIMENSION(D)     :: GTMP,DIAG,STP
     DOUBLE PRECISION,DIMENSION(U)     :: RHO1,ALPHA
     DOUBLE PRECISION,DIMENSION(0:U,D) :: SEARCHSTEP,GDIF

     ! EFK: FOR FREEZENODES
     DOUBLE PRECISION :: TESTG, TOTGNORM
     INTEGER :: IM

     ! EFK: FOR INTERNALS
     LOGICAL :: FAILED, INTPTEST, SKIPPED, AMIDEFAIL
     DOUBLE PRECISION :: STEPCART(3*NATOMS), AVGE, COORDS(3*NATOMS)
     DOUBLE PRECISION :: TMPRMS, TESTE, LGDUMMY(3*NATOMS)

     CALL MYCPU_TIME(STIME,.FALSE.)

     NTIMESMIN(1:NIMAGE)=0 ! NUMBER OF CONSECUTIVE STEPS THE IMAGE IS IDENTIFIED AS A LOCAL MINIMUM IN THE PROFILE
!    PERSISTTHRESH=50      ! PERSISTENCE IDENTIFICATION THRESHOLD
     PERSISTTHRESH=HUGE(1)      ! PERSISTENCE IDENTIFICATION THRESHOLD
     NPERSIST=0
     PREVGRAD=1.0D100
     INTPTEST = .FALSE.
     IF (DESMDEBUG) MOREPRINTING = .TRUE.
     ADDATOM=.FALSE.
     NFAIL=0
     IF (FREEZENODEST) IMGFREEZE(1:NIMAGE)=.FALSE.

     CALL CHECKINPUT
     IF (DEBUG) CALL DUMPFILES("B")
     IF (MOREPRINTING) THEN
          WRITE(*,'(A6,A20,A20,A9,2A8,A9)') 'ITER','ENERGY PER IMAGE','RMS FORCE','AV.DEV','PATH','STEP'
     ENDIF
     IF (PREVGRAD.LT.DNEBSWITCH) THEN
        CALL OLDNEBGRADIENT
     ELSE
        CALL NEBGRADIENT
     ENDIF
     IF (ETOTAL/NIMAGE.LT.COLDFUSIONLIMIT) THEN
        WRITE(*,'(A,2G20.10)') ' LBFGS> COLD FUSION DIAGNOSED - STEP DISCARDED, ENERGY, LIMIT=',ETOTAL/NIMAGE,COLDFUSIONLIMIT
        IF (DEBUG) CALL DUMPFILES("E")
        RETURN
     ENDIF

     NITERDONE=1
!    DO NITERDONE=1,MAX(NITERMAX,NITERMIN)
     DO ! MAIN DO LOOP WITH COUNTER NITERDONE
!    IF (BADTAU) EXIT
!
     MAIN: IF (NITERDONE==1) THEN
          POINT = 0
          IF (.NOT.DIAGCO) DIAG(1:D)=NEBDGUESS
          SEARCHSTEP(0,:)= -G*DIAG                           ! NR STEP FOR DIAGONAL INVERSE HESSIAN
          GTMP           = SEARCHSTEP(0,:)
          GNORM          = MAX(SQRT(DOT_PRODUCT(G,G)),1.0D-100)
          STP            = MIN(1.0D0/GNORM, GNORM)           ! MAKE THE FIRST GUESS FOR THE STEP LENGTH CAUTIOUS
     ELSE MAIN
          BOUND=NITERDONE-1
          IF (NITERDONE.GT.NEBMUPDATE) BOUND=NEBMUPDATE
          YS=DOT_PRODUCT( GDIF(NPT/D,:), SEARCHSTEP(NPT/D,:)  )
          IF (YS==0.0D0) YS=1.0D0
      
          ! UPDATE ESTIMATE OF DIAGONAL INVERSE HESSIAN ELEMENTS.
          ! WE DIVIDE BY BOTH YS AND YY AT DIFFERENT POINTS, SO THEY HAD BETTER NOT BE ZERO!
          IF (.NOT.DIAGCO) THEN
               YY=DOT_PRODUCT( GDIF(NPT/D,:) , GDIF(NPT/D,:) )
               IF (YY==0.0D0) YY=1.0D0
!              DIAG = ABS(YS/YY)
               DIAG = YS/YY
          ELSE
               CALL CHECKINPUT
          ENDIF
      
          ! COMPUTE -H*G USING THE FORMULA GIVEN IN: NOCEDAL, J. 1980, "UPDATING QUASI-NEWTON MATRICES WITH LIMITED STORAGE",
          ! MATHEMATICS OF COMPUTATION, VOL.35, NO.151, PP. 773-782
          CP= POINT; IF (POINT==0) CP = NEBMUPDATE
          RHO1(CP)=1.0D0/YS
          GTMP = -G
          CP= POINT 
                   
          DO I= 1,BOUND 
!              CP = CP - 1; IF (CP == -1) CP = M - 1
               CP = CP - 1; IF (CP == -1) CP = NEBMUPDATE - 1
               SQ= DOT_PRODUCT( SEARCHSTEP(CP,:),GTMP )
               ALPHA(CP+1) = RHO1(CP+1) * SQ
               GTMP        = -ALPHA(CP+1)*GDIF(CP,:) + GTMP
          ENDDO
              
          GTMP=DIAG*GTMP

          DO I=1,BOUND
               YR= DOT_PRODUCT( GDIF(CP,:) , GTMP )
               BETA= RHO1(CP+1)*YR
               BETA= ALPHA(CP+1)-BETA
               GTMP = BETA*SEARCHSTEP(CP,:) + GTMP
               CP=CP+1
!              IF (CP==M) CP=0
               IF (CP==NEBMUPDATE) CP=0
          ENDDO
              
          STP(1:D) = 1.0D0
     ENDIF MAIN

     !  STORE THE NEW SEARCH DIRECTION
     IF (NITERDONE.GT.1) SEARCHSTEP(POINT,:)=GTMP
      
!
! IF THE NUMBER OF IMAGES HAS CHANGED SINCE G WAS DECLARED THEN G IS NOT THE SAME
! SIZE AS GTMP AND DOT_PRODUCT CANNOT BE USED.
!
!    IF (DOT_PRODUCT(G,GTMP)/SQRT( DOT_PRODUCT(G,G)*DOT_PRODUCT(GTMP,GTMP) ) > 0.0D0) THEN
!
!  SEPARATE SQRT;S TO AVOID OVERFLOW.
!
     IF (DDOT(D,G,1,GTMP,1)/MAX(1.0D-100,SQRT( DDOT(D,G,1,G,1))*SQRT(DDOT(D,GTMP,1,GTMP,1)) ) > 0.0D0) THEN
          IF (MOREPRINTING) PRINT*,'SEARCH DIRECTION HAS POSITIVE PROJECTION ONTO GRADIENT - REVERSING STEP'
          GTMP=-GTMP
          SEARCHSTEP(POINT,:)=GTMP
     ENDIF
     GTMP=G

!  WE SHOULD APPLY THE MAXIMUM DNEB LBFGS STEP TO EACH IMAGE SEPARATELY.
!  HOWEVER, USING DIFFERENT SCALE FACTORS FOR DIFFERENT IMAGES LEADS TO HUGE
!  DISCONTINUITIES! NOW TAKE THE MINIMUM SCALE FACTOR FOR ALL IMAGES. DJW 26/11/07

     STPMIN=1.0D0
     DO J2=1,NIMAGE
          STEPIMAGE(J2) = SQRT(DOT_PRODUCT(SEARCHSTEP(POINT,NOPT*(J2-1)+1:NOPT*J2),SEARCHSTEP(POINT,NOPT*(J2-1)+1:NOPT*J2)))
          DUMMY=STEPIMAGE(J2)
          IF (STEPIMAGE(J2) > MAXNEBBFGS) THEN
               STP(NOPT*(J2-1)+1:NOPT*J2) = MAXNEBBFGS/STEPIMAGE(J2)
               STPMIN=MIN(STPMIN,STP(NOPT*(J2-1)+1))
          ENDIF
!         PRINT '(A,I8,3G20.10)','IMAGE,INITIAL STEP SIZE,STP,PROD=',J2,DUMMY,STP(NOPT*(J2-1)+1),STEPIMAGE(J2)*STP(NOPT*(J2-1)+1)
     ENDDO
     STP(1:D)=STPMIN

! EFK: DECIDE WHETHER TO FREEZE SOME NODES
     IF (FREEZENODEST.AND.(.NOT.NEBRESEEDT)) THEN
        TOTGNORM = SQRT(DOT_PRODUCT(G(1:NOPT*NIMAGE),G(1:NOPT*NIMAGE))/NIMAGE)
        DO IM = 1,NIMAGE
           TESTG = SQRT(DOT_PRODUCT(G(NOPT*(IM-1)+1:NOPT*IM),G(NOPT*(IM-1)+1:NOPT*IM)))
           IF(TESTG/TOTGNORM.LT.FREEZETOL) THEN
              IF (MOREPRINTING) PRINT '(A,I6,2G20.10)', ' LBFGS> FREEZING IMAGE: ', IM, TESTG, TOTGNORM
              IMGFREEZE(IM)=.TRUE.
              STEPIMAGE(IM)=0.0D0
              STP(NOPT*(IM-1)+1:NOPT*IM)=0.0D0
           ELSE
              IMGFREEZE(IM) = .FALSE.
           ENDIF
        ENDDO
        IF (REDOPATHNEB) THEN
           IMGFREEZE(REDOTSIM)=.TRUE.
           STEPIMAGE(REDOTSIM)=0.0D0
           STP(NOPT*(REDOTSIM-1)+1:NOPT*REDOTSIM)=0.0D0
           IF (MOREPRINTING) PRINT '(A,I6)',' LBFGS> FREEZING VARIABLE IMAGE ',REDOTSIM ! REDOTSIM+1 IF WE COUNT STARTING IMAGE!
        ENDIF
     ELSEIF (FREEZENODEST.AND.NEBRESEEDT) THEN
        DO IM=1,NIMAGE
           IF (IMGFREEZE(IM)) THEN
               STEPIMAGE(IM)=0.0D0
               STP(NOPT*(IM-1)+1:NOPT*IM) = 0.0D0
           ENDIF
        ENDDO
     ENDIF
     !  WE NOW HAVE THE PROPOSED STEP - UPDATE GEOMETRY AND CALCULATE NEW GRADIENT
     IF (DESMINT) THEN
        DO IM = 1,NIMAGE
           FAILED = .TRUE.
           DO WHILE (FAILED)
              PREVDIH => DIHINFO(IM+1,:)
              CALL TRANSBACKDELTA(STP(NOPT*(IM-1)+1:NOPT*IM)*SEARCHSTEP(POINT,NOPT*(IM-1)+1:NOPT*IM),&
                   & STEPCART,XCART(3*NATOMS*(IM-1)+1:3*NATOMS*IM),NINTC, &
                   & 3*NATOMS,NNZ,KD,FAILED,INTPTEST,INTEPSILON)
              CALL POTENTIAL(XCART(3*NATOMS*(IM-1)+1:3*NATOMS*IM) +STEPCART,TESTE,LGDUMMY,.FALSE.,.FALSE.,TMPRMS,.FALSE.,.FALSE.)

              IF (TESTE-EEE(IM+1).GT.DESMAXEJUMP.AND.EEE(IM+1).LT.0) THEN
                 IF (MOREPRINTING) PRINT*, 'TOO GREAT AN ENERGY INCREASE, SKIP IMAGE.', IM, TESTE, EEE(IM+1)
                 STP(NOPT*(IM-1)+1:NOPT*IM) = 0.0D0     
                 STEPIMAGE(IM) = 0.0D0
                 SKIPPED = .TRUE.
              ENDIF
              IF (FAILED) THEN
                 STP(NOPT*(IM-1)+1:NOPT*IM) = STP(NOPT*(IM-1)+1:NOPT*IM)*0.1D0        
                 STEPIMAGE(IM) = STEPIMAGE(IM)*0.1D0
                 IF (MOREPRINTING) PRINT*, 'NEBLBFGS>> DECREASING STEP TO ', IM, STEPIMAGE(IM)                 
              ENDIF
           ENDDO
           IF (.NOT.SKIPPED) XCART(3*NATOMS*(IM-1)+1:3*NATOMS*IM) = XCART(3*NATOMS*(IM-1)+1:3*NATOMS*IM) +STEPCART
           SKIPPED = .FALSE.
        ENDDO
     ENDIF
     NDECREASE=0
20   X(1:D) = X(1:D) + STP(1:D)*SEARCHSTEP(POINT,1:D)

     IF (PREVGRAD.LT.DNEBSWITCH) THEN
        CALL OLDNEBGRADIENT
     ELSE
        CALL NEBGRADIENT
     ENDIF
     IF (ETOTAL/NIMAGE.LT.COLDFUSIONLIMIT) THEN
        WRITE(*,'(A,2G20.10)') ' LBFGS> COLD FUSION DIAGNOSED - STEP DISCARDED, ENERGY, LIMIT=',ETOTAL/NIMAGE,COLDFUSIONLIMIT
        IF (DEBUG) CALL DUMPFILES("E")
        RETURN
     ENDIF

     CALL IMAGEDISTRIBUTION
!
!  DYNAMIC ADJUSTMENT OF NEWNEBK VALUES. LOCAL VALUES ARE CHANGED BY KADJUSTFRAC IF THE
!  CORRESPONDING SEPARATION IS OUTSIDE A FRACTION KADJUSTTOL OF THE AVERAGE VALUE.
!  THE ADJUSTMENT IS DONE EVERY KADJUSTFRQ CYCLES.
!
     IF (KADJUSTFRQ.GT.0) THEN
        IF (MOD(NITERDONE,KADJUSTFRQ).EQ.0) THEN ! DYNAMIC ADJUSTMENT OF K
           MEANSEP=SEPARATION/(NIMAGE+1)
           DO J1=1,NIMAGE+1
              IF (ABS((DVEC(J1)-MEANSEP)/MAX(MEANSEP,1.0D-100)).GT.KADJUSTTOL) THEN 
                 IF (DVEC(J1).GT.MEANSEP) THEN
                    NEWNEBK(J1)=MIN(1.0D2 ,NEWNEBK(J1)*(1.0D0+KADJUSTFRAC))
                    PRINT '(A,F12.4,A,I8,A,F12.4,A,F12.4)',' LBFGS> ADJUSTING NEB FORCE CONSTANT TO ',NEWNEBK(J1), &
   &                                                    ' FOR GAP ',J1,' VALUE=',DVEC(J1),' MEAN VALUE=',MEANSEP
                 ENDIF
!                IF (DVEC(J1).LT.MEANSEP) NEWNEBK(J1)=MAX(1.0D-2,NEWNEBK(J1)*(1.0D0-KADJUSTFRAC))
              ENDIF
           ENDDO
        ENDIF
     ELSE
!
!  ALTERNATIVE TURNING ON OF NEWNEBK.
!
        DO J1=1,NIMAGE+1
           NEWNEBK(J1)=MIN(NEBKFINAL,NEWNEBK(J1)*NEBFACTOR)
        ENDDO
!       IF (DEBUG) PRINT '(A,G20.10)','LBFGS> DNEB FORCE CONSTANT FOR IMAGE 1 IS ',NEWNEBK(1)
     ENDIF

     STEPTOT = SUM(STEPIMAGE)/NIMAGE

     IF (MOREPRINTING) THEN
        IF (PREVGRAD.LT.DNEBSWITCH) THEN
           WRITE(*,'(A,I6,2G20.10,F8.2,A,F8.3,F9.3,A)') ' LBFGS> STEPS: ',NITERDONE,ETOTAL/NIMAGE,RMS,AVDEV,'%',SEPARATION, &
  &                                                     STEPTOT, ' SINGLY-NUDGED'
        ELSE
           WRITE(*,'(A,I6,2G20.10,F8.2,A,F8.3,F9.3)') ' LBFGS> STEPS: ',NITERDONE,ETOTAL/NIMAGE,RMS,AVDEV,'%',SEPARATION, STEPTOT
        ENDIF
        CALL FLUSH(6,ISTAT)
     ENDIF
     IF (DEBUG) CALL DUMPFILES("M")


     CALL TERMINATERUN

!
!  CHECK TO SEE IF THE PROFILE ACTUALLY HAS A MAXIMUM IN IT. IF NOT TRY
!  REDUCING THE FORCE CONSTANTS BY 10 PER CENT.
!
!    EMAX=-1.0D100
!    DO J1=1,NIMAGE+2
!       IF (EEE(J1).GT.EMAX) THEN
!          EMAX=EEE(J1)
!          MAXIM=J1
!       ENDIF
!    ENDDO
!    PRINT '(A,I6,A,G20.10)',' LBFGS> MAXIM=',MAXIM,' ENERGY=',EMAX
!    IF ((MAXIM.EQ.1).OR.(MAXIM.EQ.NIMAGE+2)) THEN
!       DO J1=1,NIMAGE+1
!          NEWNEBK(J1)=NEWNEBK(J1)*0.9D0
!       ENDDO
!       PRINT '(A,G20.10)',' LBFGS> NO MAXIMUM IN DNEB PROFILE - REDUCING FORCE CONSTANT TO ',NEWNEBK(1)
!       EXITSTATUS=0
!    ENDIF
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!
     IF (EXITSTATUS > 0) THEN  
        EXIT
     ENDIF
     777 CONTINUE
!
! COMPUTE THE NEW STEP AND GRADIENT CHANGE
!
     NPT=POINT*D
     SEARCHSTEP(POINT,:) = STP*SEARCHSTEP(POINT,:)
     GDIF(POINT,:)=G-GTMP
     POINT=POINT+1; IF (POINT==NEBMUPDATE) POINT=0
!
! OPTIONAL RESEEDING OF BAD IMAGES.
! NOTE THAT THE NUMBERING FROM 1 TO NIMAGE IN X AND EIMAGE IS DIFFERENT
! FROM XYZ AND EEE, WHICH GO FROM 1 TO NIMAGE+2.
!
! SHOULD DELETE ALL THIS AND TIDY UP IF IT SIMPLY DOESN'T WORK! DJW !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!
     IF (NEBRESEEDT.AND.MOD(NITERDONE,NEBRESEEDINT)==0) THEN
        IF (BULKT) THEN
           PRINT '(A)','LBFGS> ERROR - MINIMUM IMAGE CONVENTION NEEDS TO BE CODED IN NEB/LBFGS.F90'
           STOP
        ENDIF
!! DJW 
!       IF (.NOT.ADDREPT) THEN
           ADDREPT=.TRUE.
           PRINT '(A)','LBFGS> TURNING ON REPULSIVE/CONSTRAINT TERMS FOR BAD IMAGES/CIS PEPTIDE BONDS'
!       ELSE
!
! TURN OFF REPULSIVE TERMS FOR A THAW PHASE.
!
!! DJW TRY KEEPING THEM ??
!
!          ADDREPT=.FALSE.
!          PRINT '(A)','LBFGS> TURNING OFF REPULSIVE/CONSTRAINT TERMS FOR BAD IMAGES/CIS PEPTIDE BONDS'
!          FREEZENODEST=.FALSE.
!          IMGFREEZE(1:NIMAGE)=.FALSE.
!          PRINT '(A,I6,A)','LBFGS> UNFREEZING ALL IMAGES'
!          GOTO 555
!       ENDIF
        BADIMAGE(1:NIMAGE+2)=.FALSE.
        BADPEPTIDE(1:NIMAGE+2)=.FALSE.
        NPEPFAIL=0
        NBADTOTAL=0
        DO J1=1,NIMAGE+2
           IF (CHRMMT.AND.CHECKOMEGAT) THEN 
               AMIDEFAIL=.FALSE.
               COORDS(1:NOPT)=XYZ((J1-1)*3*NATOMS+1:J1*3*NATOMS)
!              CALL CHECKOMEGA(COORDS,AMIDEFAIL)
               CALL DJWCHECKOMEGA(COORDS,AMIDEFAIL,NPEPFAIL,AT1,AT2,AT3,AT4)
               IF (AMIDEFAIL) THEN
                  PRINT '(2(A,I6))',' POTENTIAL> WARNING *** CIS PEPTIDE BOND(S) DETECTED FOR IMAGE ',J1,' TOTAL=',NPEPFAIL
                  BADPEPTIDE(J1)=.TRUE.
              ENDIF
           ENDIF
           IF (EEE(J1).GT.NEBRESEEDEMAX) BADIMAGE(J1)=.TRUE.
           IF ((EEE(J1)-EEE(1).GT.NEBRESEEDBMAX).AND.(EEE(J1)-EEE(NIMAGE+2).GT.NEBRESEEDBMAX)) BADIMAGE(J1)=.TRUE.
           IF (BADIMAGE(J1).OR.BADPEPTIDE(J1)) NBADTOTAL=NBADTOTAL+1
        ENDDO
        IF (BADIMAGE(1).OR.BADPEPTIDE(1)) PRINT '(A)','LBFGS> WARNING - BAD STARTING IMAGE WILL NOT BE REPLACED'
        IF (BADIMAGE(NIMAGE+2).OR.BADPEPTIDE(NIMAGE+2)) PRINT '(A)','LBFGS> WARNING - BAD FINAL IMAGE WILL NOT BE REPLACED'
        J1=2
        IMAGELOOP: DO 
           IF (BADIMAGE(J1)) THEN
              DO J2=J1-1,1,-1
                 IF ((.NOT.BADIMAGE(J2)).OR.(J2.EQ.1)) THEN
                    JMINUS=J2
                    EMINUS=EEE(J2)
                    EXIT
                 ENDIF
              ENDDO
              DO J2=J1+1,NIMAGE+2
                 IF ((.NOT.BADIMAGE(J2)).OR.(J2.EQ.NIMAGE+2)) THEN
                    JPLUS=J2
                    EPLUS=EEE(J2)
                    EXIT
                 ENDIF
              ENDDO
              PRINT '(A,I6,A,G20.10,2(A,I6),A,2F20.10)','LBFGS> DNEB BAD IMAGE ',J1,' ENERGY=',EEE(J1),' BRACKETED BY ', &
  &                                    JMINUS,',',JPLUS,' ENERGIES ',EMINUS,EPLUS
!
!  CONSIDER ONLY THE HIGHEST ENERGY BAD IMAGE TO AVOID DUPLICATION.
!
!             JDO=J1
              EWORST=-1.0D100
              DO J2=JMINUS+1,JPLUS-1
                 IF (EEE(J2).GT.EWORST) THEN
                    EWORST=EEE(J2)
                    JDO=J2
                 ENDIF
              ENDDO
              PRINT '(A,I6,A,G20.10)','LBFGS> HIGHEST BAD IMAGE IN THIS RANGE IS NUMBER ',JDO,' ENERGY=',EEE(JDO)
              DMAX=-1.0D0
              DO J2=1,NATOMS
                 J3LOOP: DO J3=J2+1,NATOMS
                    DO J4=1,NREPULSIVE
                       IF ((ORDERI(J4).EQ.J2).AND.(ORDERJ(J4).EQ.J3)) CYCLE J3LOOP
                    ENDDO
                    DIJ=SQRT((XYZ((JDO-1)*3*NATOMS+3*(J2-1)+1)-XYZ((JDO-1)*3*NATOMS+3*(J3-1)+1))**2 &
  &                         +(XYZ((JDO-1)*3*NATOMS+3*(J2-1)+2)-XYZ((JDO-1)*3*NATOMS+3*(J3-1)+2))**2 &
  &                         +(XYZ((JDO-1)*3*NATOMS+3*(J2-1)+3)-XYZ((JDO-1)*3*NATOMS+3*(J3-1)+3))**2) 
                    DS =SQRT((XYZ(3*(J2-1)+1)-XYZ(3*(J3-1)+1))**2 &
  &                         +(XYZ(3*(J2-1)+2)-XYZ(3*(J3-1)+2))**2 &
  &                         +(XYZ(3*(J2-1)+3)-XYZ(3*(J3-1)+3))**2) 
                    DF =SQRT((XYZ((NIMAGE+1)*3*NATOMS+3*(J2-1)+1)-XYZ((NIMAGE+1)*3*NATOMS+3*(J3-1)+1))**2 &
  &                         +(XYZ((NIMAGE+1)*3*NATOMS+3*(J2-1)+2)-XYZ((NIMAGE+1)*3*NATOMS+3*(J3-1)+2))**2 &
  &                         +(XYZ((NIMAGE+1)*3*NATOMS+3*(J2-1)+3)-XYZ((NIMAGE+1)*3*NATOMS+3*(J3-1)+3))**2) 
                    DUMMY=MIN(ABS(DIJ-DF),ABS(DIJ-DS))/DIJ
!
!  WE NEED DIJ TO BE LESS THAN BOTH OR GREATER THAN BOTH DISTANCES IN THE END POINTS.
!
                    IF (((DIJ-DF)*(DIJ-DS).GT.0.0D0).AND.(DUMMY.GT.DMAX)) THEN
                       DMAX=DUMMY
!                      PRINT '(A,2I6,5G20.10)','LBFGS> I,J,DIJ,DS,DF,DUMMY=',J2,J3,DIJ,DS,DF,DUMMY
                    ENDIF
                 ENDDO J3LOOP
              ENDDO
              DO J2=1,NATOMS
                 DO J3=J2+1,NATOMS
                    DIJ=SQRT((XYZ((JDO-1)*3*NATOMS+3*(J2-1)+1)-XYZ((JDO-1)*3*NATOMS+3*(J3-1)+1))**2 &
  &                         +(XYZ((JDO-1)*3*NATOMS+3*(J2-1)+2)-XYZ((JDO-1)*3*NATOMS+3*(J3-1)+2))**2 &
  &                         +(XYZ((JDO-1)*3*NATOMS+3*(J2-1)+3)-XYZ((JDO-1)*3*NATOMS+3*(J3-1)+3))**2) 
                    DS =SQRT((XYZ(3*(J2-1)+1)-XYZ(3*(J3-1)+1))**2 &
  &                         +(XYZ(3*(J2-1)+2)-XYZ(3*(J3-1)+2))**2 &
  &                         +(XYZ(3*(J2-1)+3)-XYZ(3*(J3-1)+3))**2) 
                    DF =SQRT((XYZ((NIMAGE+1)*3*NATOMS+3*(J2-1)+1)-XYZ((NIMAGE+1)*3*NATOMS+3*(J3-1)+1))**2 &
  &                         +(XYZ((NIMAGE+1)*3*NATOMS+3*(J2-1)+2)-XYZ((NIMAGE+1)*3*NATOMS+3*(J3-1)+2))**2 &
  &                         +(XYZ((NIMAGE+1)*3*NATOMS+3*(J2-1)+3)-XYZ((NIMAGE+1)*3*NATOMS+3*(J3-1)+3))**2) 
                    DUMMY=MIN(ABS(DIJ-DF),ABS(DIJ-DS))/DIJ
                    IF ((DIJ-DF)*(DIJ-DS).GT.0.0D0) THEN
                       IF (DUMMY.GT.0.9D0*DMAX) THEN
                          NOTNEW=.FALSE.
                          REPLOOP: DO J4=1,NREPULSIVE
                             IF ((ORDERI(J4).EQ.J2).AND.(ORDERJ(J4).EQ.J3)) THEN
                                NOTNEW=.TRUE.
                                EXIT REPLOOP 
                             ENDIF
                          ENDDO REPLOOP
                          IF (.NOT.NOTNEW) THEN
!
!  ADD ORDER PARAMETER FOR BAD IMAGE TO CURRENT LIST.
!
!! DJW DEBUG MAXIMUM TWO REPULSIONS
!
                             IF (NREPULSIVE.EQ.4) GOTO 888
                             NREPULSIVE=NREPULSIVE+1
                             PRINT '(A,2I6,A,I6)','LBFGS> ADDING REPULSIVE ORDER PARAMETER FOR ATOMS ',J2,J3,'  TOTAL=',NREPULSIVE
                             IF (NREPULSIVE.GT.NREPMAX) THEN
                                ALLOCATE(IREPTEMP(NREPMAX))
               
                                IREPTEMP(1:NREPMAX)=ORDERI(1:NREPMAX)
                                DEALLOCATE(ORDERI)
                                ALLOCATE(ORDERI(2*NREPMAX))
                                ORDERI(1:NREPMAX)=IREPTEMP(1:NREPMAX)
               
                                IREPTEMP(1:NREPMAX)=ORDERJ(1:NREPMAX)
                                DEALLOCATE(ORDERJ)
                                ALLOCATE(ORDERJ(2*NREPMAX))
                                ORDERJ(1:NREPMAX)=IREPTEMP(1:NREPMAX)
               
                                IREPTEMP(1:NREPMAX)=REPPOW(1:NREPMAX)
                                DEALLOCATE(REPPOW)
                                ALLOCATE(REPPOW(2*NREPMAX))
                                REPPOW(1:NREPMAX)=IREPTEMP(1:NREPMAX)
               
                                DEALLOCATE(IREPTEMP)
                                ALLOCATE(REPTEMP(1:NREPMAX))
               
                                REPTEMP(1:NREPMAX)=EPSALPHA(1:NREPMAX)
                                DEALLOCATE(EPSALPHA)
                                ALLOCATE(EPSALPHA(2*NREPMAX))
                                EPSALPHA(1:NREPMAX)=REPTEMP(1:NREPMAX)
               
                                REPTEMP(1:NREPMAX)=DISTREF(1:NREPMAX)
                                DEALLOCATE(DISTREF)
                                ALLOCATE(DISTREF(2*NREPMAX))
                                DISTREF(1:NREPMAX)=REPTEMP(1:NREPMAX)

                                NREPMAX=2*NREPMAX
                                DEALLOCATE(REPTEMP)
                             ENDIF
                             ORDERI(NREPULSIVE)=J2
                             ORDERJ(NREPULSIVE)=J3
                             EPSALPHA(NREPULSIVE)=NEBRESEEDDEL1
                             REPPOW(NREPULSIVE)=NEBRESEEDPOW1
                             DISTREF(NREPULSIVE)=DIJ
                             PRINT '(A,2G20.10)','LBFGS> BOND LENGTH AND FACTOR FOR BAD IMAGE ARE   ', &
  &                                                DIJ,EPSALPHA(NREPULSIVE)
888                          CONTINUE
                          ENDIF
                       ENDIF
                    ENDIF
                 ENDDO
              ENDDO

              J2=JMINUS
              IF (EPLUS.GT.EMINUS) J2=JPLUS

              X((JDO-2)*3*NATOMS+1:(JDO-1)*3*NATOMS)=XYZ((J2-1)*3*NATOMS+1:J2*3*NATOMS)
              EIMAGE(JDO-1)=EIMAGE(J2-1)
              PRINT '(A,I6,A,G20.10)','LBFGS> IMAGE ',JDO,' REINTERPOLATED ENERGY=',EIMAGE(JDO-1)
!
! CHANGE ALL THE OTHER BAD IMAGES IN THIS RANGE.
!
              DO J3=JMINUS+1,JDO-1
!
!  RESET TO MINUS END POINT
!
                 LCOORDS(1:3*NATOMS)=XYZ((JMINUS-1)*3*NATOMS+1:JMINUS*3*NATOMS)
!                XYZ((J3-1)*3*NATOMS+1:J3*3*NATOMS)=LCOORDS(1:3*NATOMS)
                 X((J3-2)*3*NATOMS+1:(J3-1)*3*NATOMS)=LCOORDS(1:3*NATOMS)
                 CALL POTENTIAL(LCOORDS,ENERGY,LGDUMMY,.FALSE.,.FALSE.,RMS,.FALSE.,.FALSE.)
!                EEE(J3)=ENERGY
                 EIMAGE(J3-1)=ENERGY
                 PRINT '(A,I6,A,G20.10)','LBFGS> IMAGE ',J3,' REINTERPOLATED ENERGY=',ENERGY
              ENDDO
              DO J3=JDO+1,JPLUS-1
!
!  RESET TO PLUS END POINT
!
                 LCOORDS(1:3*NATOMS)=XYZ((JPLUS-1)*3*NATOMS+1:JPLUS*3*NATOMS)
!                XYZ((J3-1)*3*NATOMS+1:J3*3*NATOMS)=LCOORDS(1:3*NATOMS)
                 X((J3-2)*3*NATOMS+1:(J3-1)*3*NATOMS)=LCOORDS(1:3*NATOMS)
                 CALL POTENTIAL(LCOORDS,ENERGY,LGDUMMY,.FALSE.,.FALSE.,RMS,.FALSE.,.FALSE.)
!                EEE(J3)=ENERGY
                 EIMAGE(J3-1)=ENERGY
                 PRINT '(A,I6,A,G20.10)','LBFGS> IMAGE ',J3,' REINTERPOLATED ENERGY=',ENERGY
              ENDDO
!             NEWNEBK(JMINUS:JPLUS-1)=NEBKINITIAL
!             PRINT '(A,G20.10)','LBFGS> FOR BAD IMAGES DNEB FORCE CONSTANTS RESET TO ',NEBKINITIAL
              J1=JPLUS+1
           ELSE
              J1=J1+1
           ENDIF
           IF (J1.GE.NIMAGE+2) EXIT IMAGELOOP
        ENDDO IMAGELOOP
!
!  NOW ADD HARMONIC CONSTRAINTS FOR ANY CIS PEPTIDE BONDS IN THIS RANGE IF WE HAVEN'T COVERED THEM ALREADY.
!
        DO J2=1,NPEPFAIL
           PRINT '(A,I6,A,4I6)','LBFGS> CHECKING FOR NEW CONSTRAINT TERMS FOR CIS PEPTIDE NUMBER ',J2,' ATOMS ', &
           &     AT1(J2),AT2(J2),AT3(J2),AT4(J2)
           NOTNEW=.FALSE.
           REPLOOP2: DO J4=1,NREPULSIVE
              IF ((ORDERI(J4).EQ.AT1(J2)).AND.(ORDERJ(J4).EQ.AT4(J2))) THEN
                 NOTNEW=.TRUE.
                 EXIT REPLOOP2
              ENDIF
              IF ((ORDERI(J4).EQ.AT4(J2)).AND.(ORDERJ(J4).EQ.AT1(J2))) THEN
                 NOTNEW=.TRUE.
                 EXIT REPLOOP2
              ENDIF
           ENDDO REPLOOP2
           IF (.NOT.NOTNEW) THEN
!
!  ADD ORDER PARAMETER FOR BAD IMAGE TO CURRENT LIST.
!
              NREPULSIVE=NREPULSIVE+3
              IF (NREPULSIVE.GT.NREPMAX) THEN
                 ALLOCATE(IREPTEMP(NREPMAX))
               
                 IREPTEMP(1:NREPMAX)=ORDERI(1:NREPMAX)
                 DEALLOCATE(ORDERI)
                 ALLOCATE(ORDERI(2*NREPMAX))
                 ORDERI(1:NREPMAX)=IREPTEMP(1:NREPMAX)
               
                 IREPTEMP(1:NREPMAX)=ORDERJ(1:NREPMAX)
                 DEALLOCATE(ORDERJ)
                 ALLOCATE(ORDERJ(2*NREPMAX))
                 ORDERJ(1:NREPMAX)=IREPTEMP(1:NREPMAX)
               
                 IREPTEMP(1:NREPMAX)=REPPOW(1:NREPMAX)
                 DEALLOCATE(REPPOW)
                 ALLOCATE(REPPOW(2*NREPMAX))
                 REPPOW(1:NREPMAX)=IREPTEMP(1:NREPMAX)
               
                 DEALLOCATE(IREPTEMP)
                 ALLOCATE(REPTEMP(1:NREPMAX))
               
                 REPTEMP(1:NREPMAX)=EPSALPHA(1:NREPMAX)
                 DEALLOCATE(EPSALPHA)
                 ALLOCATE(EPSALPHA(2*NREPMAX))
                 EPSALPHA(1:NREPMAX)=REPTEMP(1:NREPMAX)
               
                 REPTEMP(1:NREPMAX)=DISTREF(1:NREPMAX)
                 DEALLOCATE(DISTREF)
                 ALLOCATE(DISTREF(2*NREPMAX))
                 DISTREF(1:NREPMAX)=REPTEMP(1:NREPMAX)

                 NREPMAX=2*NREPMAX
                 DEALLOCATE(REPTEMP)
              ENDIF
              PRINT '(A,2I6,A,I6)','LBFGS> CIS ADDING HARMONIC CONSTRAINT FOR ATOMS ',AT1(J2),AT4(J2),'  TOTAL=',NREPULSIVE-2
              ORDERI(NREPULSIVE-2)=AT1(J2)
              ORDERJ(NREPULSIVE-2)=AT4(J2)
              EPSALPHA(NREPULSIVE-2)=NEBRESEEDDEL2
              REPPOW(NREPULSIVE-2)=NEBRESEEDPOW2
              DIJ=3.8D0
              DISTREF(NREPULSIVE-2)=DIJ 
              PRINT '(A,2G20.10)','LBFGS> BOND LENGTH AND FACTOR FOR BAD IMAGE ARE   ', &
  &                                       DIJ,EPSALPHA(NREPULSIVE-2)

              PRINT '(A,2I6,A,I6)','LBFGS> CIS ADDING HARMONIC CONSTRAINT FOR ATOMS ',AT1(J2),AT3(J2),'  TOTAL=',NREPULSIVE-1
              ORDERI(NREPULSIVE-1)=AT1(J2)
              ORDERJ(NREPULSIVE-1)=AT3(J2)
              EPSALPHA(NREPULSIVE-1)=NEBRESEEDDEL2
              REPPOW(NREPULSIVE-1)=NEBRESEEDPOW2
              DIJ=2.5D0
              DISTREF(NREPULSIVE-1)=DIJ 
              PRINT '(A,2G20.10)','LBFGS> BOND LENGTH AND FACTOR FOR BAD IMAGE ARE   ', &
  &                                       DIJ,EPSALPHA(NREPULSIVE-1)

              PRINT '(A,2I6,A,I6)','LBFGS> CIS ADDING HARMONIC CONSTRAINT FOR ATOMS ',AT2(J2),AT4(J2),'  TOTAL=',NREPULSIVE
              ORDERI(NREPULSIVE)=AT2(J2)
              ORDERJ(NREPULSIVE)=AT4(J2)
              EPSALPHA(NREPULSIVE)=NEBRESEEDDEL2
              REPPOW(NREPULSIVE)=NEBRESEEDPOW2
              DIJ=2.4D0
              DISTREF(NREPULSIVE)=DIJ 
              PRINT '(A,2G20.10)','LBFGS> BOND LENGTH AND FACTOR FOR BAD IMAGE ARE   ', &
  &                                       DIJ,EPSALPHA(NREPULSIVE)
           ENDIF
        ENDDO

!
! DEBUG COMMENT DJW
!
!
          FREEZENODEST=.FALSE.
!
!         IF (NBADTOTAL.EQ.0) THEN
!            FREEZENODEST=.FALSE.
!            IMGFREEZE(1:NIMAGE)=.FALSE.
!            PRINT '(A,I6,A)','LBFGS> NO BAD IMAGES - UNFREEZING EVERYTHING AND REMOVING REPULSIVE AND CONSTRAINT TERMS'
!  
! !  COULD TURN OFF THE REPULSIVE AND CONSTRAINT TERMS AS WELL?
! !
!            ADDREPT=.FALSE.
!         ELSE
!            FREEZENODEST=.TRUE.
!            NIMAGEFREEZE=0
!            DO J2=2,NIMAGE+1
!               IF (BADIMAGE(J2).OR.BADPEPTIDE(J2)) THEN
!                  IMGFREEZE(J2-1)=.FALSE.
!               ELSE
!                  IF ((.NOT.BADIMAGE(J2-1)).OR.(.NOT.BADIMAGE(J2+1))) THEN
!                     NIMAGEFREEZE=NIMAGEFREEZE+1
!                     IMGFREEZE(J2-1)=.TRUE.
! !                   STEPIMAGE(J2-1)=0.0D0
! !                   STP(NOPT*(J2-1-1)+1:NOPT*J2-1)=0.0D0
!                  ENDIF
!               ENDIF
!             ENDDO
!            PRINT '(A,I6,A)','LBFGS> FREEZING ',NIMAGE-NBADTOTAL,' GOOD IMAGES'
!         ENDIF

555     CONTINUE
     ENDIF

     IF (DUMPNEBXYZ.AND.MOD(NITERDONE,DUMPNEBXYZFREQ)==0) CALL RWG("W",.FALSE.,NITERDONE)
     IF (DUMPNEBPTS.AND.MOD(NITERDONE,DUMPNEBPTSFREQ)==0) CALL SAVEBANDCOORD
     IF (DUMPNEBEOS.AND.MOD(NITERDONE,DUMPNEBEOSFREQ)==0) CALL WRITEPROFILE(NITERDONE)
!
!  CHECK FOR PERSISTENT MINIMA
!
     DO J1=2,NIMAGE+1
        IF ((EEE(J1).LT.EEE(J1-1)).AND.(EEE(J1).LT.EEE(J1+1))) THEN
           NTIMESMIN(J1)=NTIMESMIN(J1)+1
        ELSE
           NTIMESMIN(J1)=0
        ENDIF
     ENDDO
     NPERSIST=0
     PERSISTENT(1:NIMAGE+2)=.FALSE.
!    IF (MOD(NITERDONE,PERSISTTHRESH)/2.EQ.0) THEN ! TO GIVE MORE THAN ONE IMAGE A CHANCE TO BECOME PERSISTENT
!       DO J1=2,NIMAGE+1
!          IF (NTIMESMIN(J1).GE.PERSISTTHRESH) THEN
!             NPERSIST=NPERSIST+1
!             PERSISTENT(J1)=.TRUE.
!             PRINT '(3(A,I8))',' NEBBFGS> IDENTIFIED PERSISTENT MINIMUM, IMAGE NUMBER ',J1,' MINIMUM FOR ',NTIMESMIN(J1),' STEPS'
!          ENDIF
!       ENDDO
!    ENDIF
     IF (NPERSIST.GT.0) THEN
        IF (DEBUG) CALL DUMPFILES("E")
        RETURN
     ENDIF
!
!  END OF CHECK FOR PERSISTENT MINIMA
!
     PREVGRAD=RMS

     NITERDONE=NITERDONE+1
     IF (NITERDONE.GT.MAX(NITERMAX,NITERMIN)) EXIT

     ENDDO ! END OF MAIN DO LOOP OVER VARIABLE NITERDONE

     IF (DEBUG) CALL DUMPFILES("E")

     CONTAINS

     SUBROUTINE CHECKINPUT
          INTEGER :: I

          IF ( D<=0 ) THEN
               PRINT *, 'D IS NOT POSITIVE, D=',D
               CALL TSUMMARY
               STOP
          ENDIF

          IF ( U<=0 ) THEN
               PRINT *, 'U IS NOT POSITIVE, U=',U
               CALL TSUMMARY
               STOP
          ENDIF
          
          IF (NITERMAX < 0) THEN
               PRINT '(1X,A)', 'MAXIMAL NUMBER OF ITERATIONS IS LESS THAN ZERO! STOP.'
               CALL TSUMMARY
               STOP
          ENDIF
          
          IF (DIAGCO) THEN
               PRINT*,'USING ESTIMATE OF THE INVERSE DIAGONAL ELEMENTS'
               DO I=1,D
                    IF (DIAG(I)<=0.0D0) THEN
                         WRITE(*,'(" THE",I5,"-TH DIAGONAL ELEMENT OF THE INVERSE HESSIAN APPROXIMATION IS NOT POSITIVE")') I
                         CALL TSUMMARY
                         STOP
                    ENDIF
               ENDDO
          ENDIF
     END SUBROUTINE CHECKINPUT

     SUBROUTINE TERMINATERUN
          EXITSTATUS=0
          NEBDGUESS=DIAG(1) ! SHOULD BE OK FOR SUBSEQUENT RUNS OF THE SAME SYSTEM DJW
          IF ( RMS <= RMSTOL.AND. NITERDONE>1.AND. .NOT.NITERDONE < NITERMIN ) THEN
               EXITSTATUS=1
               RETURN
          ENDIF
          
          AVGE = SUM(EEE(2:NIMAGE+1))/NIMAGE
          IF (NITERDONE == NITERMAX.AND.NITERDONE.GE.NITERMIN.AND.AVGE.LT.DESMAXAVGE) THEN
               EXITSTATUS=2
               RETURN
          ENDIF
     END SUBROUTINE TERMINATERUN

END SUBROUTINE NEBBFGS

END MODULE MINIMISER1
