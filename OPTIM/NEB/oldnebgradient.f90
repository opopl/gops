!   NEB MODULE IS AN IMPLEMENTATION OF THE NUDGED ELASTIC BAND METHOD FOR PERFORMING DOUBLE-ENDED PATHWAY SEARCHES.
!   COPYRIGHT (C) 2003-2006 SEMEN A. TRYGUBENKO AND DAVID J. WALES
!   THIS FILE IS PART OF NEB MODULE. NEB MODULE IS PART OF OPTIM.
!
!   OPTIM IS FREE SOFTWARE; YOU CAN REDISTRIBUTE IT AND/OR MODIFY
!   IT UNDER THE TERMS OF THE GNU GENERAL PUBLIC LICENSE AS PUBLISHED BY
!   THE FREE SOFTWARE FOUNDATION; EITHER VERSION 2 OF THE LICENSE, OR
!   (AT YOUR OPTION) ANY LATER VERSION.
!
!   OPTIM IS DISTRIBUTED IN THE HOPE THAT IT WILL BE USEFUL,
!   BUT WITHOUT ANY WARRANTY; WITHOUT EVEN THE IMPLIED WARRANTY OF
!   MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.  SEE THE
!   GNU GENERAL PUBLIC LICENSE FOR MORE DETAILS.
!
!   YOU SHOULD HAVE RECEIVED A COPY OF THE GNU GENERAL PUBLIC LICENSE
!   ALONG WITH THIS PROGRAM; IF NOT, WRITE TO THE FREE SOFTWARE
!   FOUNDATION, INC., 59 TEMPLE PLACE, SUITE 330, BOSTON, MA  02111-1307  USA
!
SUBROUTINE OLDNEBGRADIENT
USE KEYGRAD
USE NEBDATA
USE KEYNEB,ONLY: NIMAGE
USE TANGENT
USE NEBUTILS
USE KEY, ONLY: UNRST, FROZEN, FREEZE, NEBK, BULKT, TWOD
USE COMMONS, ONLY : PARAM1, PARAM2, PARAM3
USE GRADIENTS
IMPLICIT NONE
INTEGER J1, J2
DOUBLE PRECISION DUMMY1, DUMMY2

!
! IMAGE 1 IS START
! MOVABLE IMAGES ARE NUMBERS 2 TO NIMAGE+1
! IMAGE NIMAGE+2 IS FINISH
! THE FOLLOWING ASSIGNMENTS ARE MADE AT THE START OF NEWNEB
!
! X         => XYZ(NOPT+1:NOPT*(NIMAGE+1))
! EIMAGE    => EEE(2:NIMAGE+1)
! G         => GGG(NOPT+1:NOPT*(NIMAGE+1))
! GSPR      => SSS(NOPT+1:NOPT*(NIMAGE+1))
! RMSFIMAGE => RRR(2:NIMAGE+1)
! TANPTR => TANVEC
! EEE = 0.0D0
! EEE(1)=EINITIAL
! EEE(NIMAGE+2)=EFINAL
! 
! TRUEPOTEG CALCULATES ENERGY AND GRADIENTS FOR IMAGES
! COORDINATES ARE IN XYZ(1:NOPT*(NIMAGE+2))
! GRADIENT IS IN GGG(1:NOPT*(NIMAGE+2)) AND ALSO SAVED IN TRUEGRAD(1:NOPT*(NIMAGE+2))
! IMAGE POTENTIAL ENERGIES ARE IN EEE(1:NIMAGE+2)
!
CALL TRUEPOTEG(.TRUE.)
!
! MEPTANGENT CALCULATES TANGENT VECTOR ACCORDING TO HENKELMANN AND JONSSON, JCP, 113, 9978, 2000
! AND STORES IT IN TANVEC(1:NOPT,1:NIMAGE)
! THE TANGENT VECTOR FOR IMAGE J1 IS STORED IN TANVEC(:,J1-1)
!
CALL MEPTANGENT        

!
!  GRADIENT OF THE POTENTIAL PERPENDICULAR TO THE TANGENT VECTOR.
!
ETOTAL=0.0D0
DO J1=2,NIMAGE+1
   DUMMY1=0.0D0
   DO J2=1,NOPT
      DUMMY1=DUMMY1+GGG(J2+NOPT*(J1-1))*TANVEC(J2,J1-1) 
   ENDDO
   DO J2=1,NOPT
      GGG(J2+NOPT*(J1-1))=GGG(J2+NOPT*(J1-1))-DUMMY1*TANVEC(J2,J1-1)
      RMS=RMS+GGG(J2+NOPT*(J1-1))**2
   ENDDO
   ETOTAL=ETOTAL+EEE(J1)
   PRINT '(A,I6)','OLDNEBGRAD> GGG PERP FOR IMAGE ',J1
   PRINT '(6G20.10)',GGG(1+NOPT*(J1-1):J1*NOPT)
!  PRINT '(A,I6)','OLDNEBGRAD> TANVEC FOR IMAGE ',J1
!  PRINT '(6G20.10)',TANVEC(1:NOPT,J1-1)
ENDDO
RMS=SQRT(RMS/(NIMAGE*NOPT*1.0D0))
!
!  SPRING ENERGY DERIVATIVES.
!
DO J1=2,NIMAGE+1
   DUMMY1=0.0D0
   DUMMY2=0.0D0
   IF (BULKT) THEN
      DO J2=1,NATOMS
         DUMMY1=DUMMY1+ &
  &                 (XYZ(NOPT*(J1-1)+3*(J2-1)+1)-XYZ(NOPT*J1+3*(J2-1)+1) &
  &    -PARAM1*NINT((XYZ(NOPT*(J1-1)+3*(J2-1)+1)-XYZ(NOPT*J1+3*(J2-1)+1)/PARAM1)))**2 &
  &                +(XYZ(NOPT*(J1-1)+3*(J2-1)+2)-XYZ(NOPT*J1+3*(J2-1)+2) &
  &    -PARAM2*NINT((XYZ(NOPT*(J1-1)+3*(J2-1)+2)-XYZ(NOPT*J1+3*(J2-1)+2)/PARAM2)))**2 
         IF (.NOT.TWOD) DUMMY1=DUMMY1+ &
  &                 (XYZ(NOPT*(J1-1)+3*(J2-1)+3)-XYZ(NOPT*J1+3*(J2-1)+3) &
  &    -PARAM3*NINT((XYZ(NOPT*(J1-1)+3*(J2-1)+3)-XYZ(NOPT*J1+3*(J2-1)+3)/PARAM3)))**2

         DUMMY2=DUMMY2+ &
  &                 (XYZ(NOPT*(J1-1)+3*(J2-1)+1)-XYZ(NOPT*(J1-2)+3*(J2-1)+1) &
  &    -PARAM1*NINT((XYZ(NOPT*(J1-1)+3*(J2-1)+1)-XYZ(NOPT*(J1-2)+3*(J2-1)+1)/PARAM1)))**2 &
  &                +(XYZ(NOPT*(J1-1)+3*(J2-1)+2)-XYZ(NOPT*(J1-2)+3*(J2-1)+2) &
  &    -PARAM2*NINT((XYZ(NOPT*(J1-1)+3*(J2-1)+2)-XYZ(NOPT*(J1-2)+3*(J2-1)+2)/PARAM2)))**2 
         IF (.NOT.TWOD) DUMMY1=DUMMY1+ &
  &                 (XYZ(NOPT*(J1-1)+3*(J2-1)+3)-XYZ(NOPT*(J1-2)+3*(J2-1)+3) &
  &    -PARAM3*NINT((XYZ(NOPT*(J1-1)+3*(J2-1)+3)-XYZ(NOPT*(J1-2)+3*(J2-1)+3)/PARAM3)))**2
      ENDDO
   ELSE
      DO J2=1,NOPT
         DUMMY1=DUMMY1+(XYZ(J2+NOPT*(J1-1))-XYZ(J2+NOPT*J1))**2
         DUMMY2=DUMMY2+(XYZ(J2+NOPT*(J1-1))-XYZ(J2+NOPT*(J1-2)))**2
      ENDDO
   ENDIF
   DUMMY1=SQRT(DUMMY1)*NEWNEBK(J1-1)
   DUMMY2=SQRT(DUMMY2)*NEWNEBK(J1)
   DO J2=1,NOPT
      GGG(J2+NOPT*(J1-1))=GGG(J2+NOPT*(J1-1))-(DUMMY1-DUMMY2)*TANVEC(J2,J1-1)
   ENDDO
   PRINT '(A,I6)','OLDNEBGRAD> GGG G PERP + WITH PARALLEL SPRING DERIVATIVES FOR IMAGE ',J1
   PRINT '(6G20.10)',GGG(1+NOPT*(J1-1):J1*NOPT)
ENDDO
!   
! SET GRADIENTS ON FROZEN ATOMS TO ZERO.
!   
IF (FREEZE) THEN
   DO J1=1,NIMAGE+2
      DO J2=1,NATOMS
         IF (FROZEN(J2)) THEN
            GGG(NOPT*(J1-1)+3*(J2-1)+1)=0.0D0
            GGG(NOPT*(J1-1)+3*(J2-1)+2)=0.0D0
            GGG(NOPT*(J1-1)+3*(J2-1)+3)=0.0D0
         ENDIF
      ENDDO
   ENDDO
ENDIF

IF (ORT) THEN ! REMOVE OVERALL ROTATION/TRANSLATION BY FREEZING 6 DEGREES OF FREEDOM
   G(1::NOPT)=0.0D0
   G(2::NOPT)=0.0D0
   G(3::NOPT)=0.0D0
   G(4::NOPT)=0.0D0
   G(5::NOPT)=0.0D0
   G(7::NOPT)=0.0D0
!  DO J1=2,NIMAGE+1  
!     GGG(NOPT*(J1-1)+1)=0.0D0
!     GGG(NOPT*(J1-1)+2)=0.0D0
!     GGG(NOPT*(J1-1)+3)=0.0D0
!     GGG(NOPT*(J1-1)+4)=0.0D0
!     GGG(NOPT*(J1-1)+5)=0.0D0
!     GGG(NOPT*(J1-1)+7)=0.0D0
!  ENDDO
ENDIF

RMS=0.0D0
DO J1=NOPT+1,(NIMAGE+1)*NOPT
   RMS=RMS+GGG(J1)**2
ENDDO
RMS=SQRT(RMS/(NIMAGE*NOPT))

END SUBROUTINE OLDNEBGRADIENT
