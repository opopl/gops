C   OPTIM: A PROGRAM FOR OPTIMIZING GEOMETRIES AND CALCULATING REACTION PATHWAYS
C   COPYRIGHT (C) 1999-2006 DAVID J. WALES
C   THIS FILE IS PART OF OPTIM.
C
C   OPTIM IS FREE SOFTWARE; YOU CAN REDISTRIBUTE IT AND/OR MODIFY
C   IT UNDER THE TERMS OF THE GNU GENERAL PUBLIC LICENSE AS PUBLISHED BY
C   THE FREE SOFTWARE FOUNDATION; EITHER VERSION 2 OF THE LICENSE, OR
C   (AT YOUR OPTION) ANY LATER VERSION.
C
C   OPTIM IS DISTRIBUTED IN THE HOPE THAT IT WILL BE USEFUL,
C   BUT WITHOUT ANY WARRANTY; WITHOUT EVEN THE IMPLIED WARRANTY OF
C   MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.  SEE THE
C   GNU GENERAL PUBLIC LICENSE FOR MORE DETAILS.
C
C   YOU SHOULD HAVE RECEIVED A COPY OF THE GNU GENERAL PUBLIC LICENSE
C   ALONG WITH THIS PROGRAM; IF NOT, WRITE TO THE FREE SOFTWARE
C   FOUNDATION, INC., 59 TEMPLE PLACE, SUITE 330, BOSTON, MA  02111-1307  USA
C
      SUBROUTINE VDUMP(DIAG,ZT,N,M)
      USE KEY
      USE MODHESS
      USE PORFUNCS
      IMPLICIT NONE
      INTEGER M, N, J1, J2, ISTAT, MCOUNT
      DOUBLE PRECISION DIAG(M)
      LOGICAL ZT(M)
C
C  DUMP THE EIGENVECTORS WHICH CORRESPOND TO NON-ZERO EIGENVALUES
C  IN FILE VECTORS.DUMP
C
      IF (.NOT.ALLSTEPS) REWIND(44)
      IF (ALLVECTORS) THEN
!       CSW34> FIND HOW MANY MODES ARE GOING TO BE PRINTED AND ECHO THIS
!       TO A FILE FOR THE ANALYSIS SCRIPT (THIS COULD BE REMOVED WHEN ALL THE
!       DUMPING IS DONE IN OPTIM). THIS IS A PROBLEM WITH FREEZE WHERE
!       SOME NON-REAL MODES HAVE ZERO EIGANVALUE.
            MCOUNT=0
            DO J1=1,N
                IF (ZT(J1)) MCOUNT=MCOUNT+1
            ENDDO
            OPEN(UNIT=499,FILE='NMODES.DAT',STATUS='UNKNOWN')
            WRITE(499,'(I6)') MCOUNT
            CLOSE(499)
         DO J1=1,N
            IF (ZT(J1)) THEN
! IF PRINTING THE MASS WEIGHTED VECTORS (NORMAL MODES), CONVERT OMEGA^2
! INTO THE VIBRATIONAL FREQUENCY IN WAVENUMBERS (CM^(-1)). 108.52 IS THE
! CONVERSION FACTOR FROM (KCAL MOL-1 KG-1 A-2)^2 TO CM-1.
              IF (MWVECTORS) THEN
                        WRITE(44,'(F20.10)') DSQRT(DIAG(J1))*108.52
              ELSE
                        WRITE(44,'(F20.10)') DIAG(J1)
              ENDIF
              IF (ANGLEAXIS2) N=N/2
               WRITE(44,'(3F20.10)') (HESS(J2,J1),J2=1,N)
              IF (ANGLEAXIS2) N=N*2
            ENDIF
         ENDDO
      ELSE
         DO J1=N,1,-1
            IF (ZT(J1)) THEN
! AS ABOVE
               IF (MWVECTORS) THEN
                        WRITE(44,'(F20.10)') DSQRT(DIAG(J1))*108.52
               ELSE
                        WRITE(44,'(F20.10)') DIAG(J1)
               ENDIF
               WRITE(44,'(3F20.10)') (HESS(J2,J1),J2=1,N)
               CALL FLUSH(44,ISTAT)
               RETURN
            ENDIF
         ENDDO
      ENDIF
      CALL FLUSH(44,ISTAT)

      RETURN
      END
