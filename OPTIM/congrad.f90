!   NEB MODULE IS AN IMPLEMENTATI ON OF THE NUDGED ELASTIC BAND METHOD FOR PERFORMING DOUBLE-ENDED PATHWAY SEARCHES.
!   COPYRIGHT (C) 2003-2006 SEMEN A. TRYGUBENKO AND DAVID J. WALES
!   THIS FILE IS PART OF NEB MODULE. NEB MODULE IS PART OF OPTIM.
!
!   OPTIM IS FREE SOFTWARE; YOU CAN REDISTRIBUTE IT AND/OR MODIFY
!   IT UNDER THE TERMS OF THE GNU GENERAL PUBLIC LICENSE AS PUBLISHED BY
!   THE FREE SOFTWARE FOUNDATION; EITHER VERSION 2 OF THE LICENSE, OR
!   (AT YOUR OPTION) ANY LATER VERSION.
!
!   OPTIM IS DISTRIBUTED IN THE HOPE THAT IT WILL BE USEFUL,
!   BUT WITHOUT ANY WARRANTY; WITHOUT EVEN THE IMPLIED WARRANTY OF
!   MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.  SEE THE
!   GNU GENERAL PUBLIC LICENSE FOR MORE DETAILS.
!
!   YOU SHOULD HAVE RECEIVED A COPY OF THE GNU GENERAL PUBLIC LICENSE
!   ALONG WITH THIS PROGRAM; IF NOT, WRITE TO THE FREE SOFTWARE
!   FOUNDATION, INC., 59 TEMPLE PLACE, SUITE 330, BOSTON, MA  02111-1307  USA
!
SUBROUTINE CONGRAD(NMAXINT,NMININT,ETOTAL,XYZ,GGG,EEE,IMGFREEZE,RMS)
USE KEY, ONLY: FROZEN, FREEZE, NREPI, NREPJ, NNREPULSIVE, DEBUG, &
  &            NCONSTRAINT, CONI, CONJ, INTCONSTRAINTDEL, CONDISTREF, INTCONSTRAINTREP, CONDISTREFLOCAL, &
  &            CONACTIVE, INTCONSTRAINREPCUT, NREPCUT,INTIMAGE
USE COMMONS, ONLY: NATOMS, NOPT
USE PORFUNCS
IMPLICIT NONE
           
INTEGER :: J1,J2,NI2,NI1,NJ2,NJ1,NMAXINT,NMININT,NREPINT(INTIMAGE+2),ISTAT
DOUBLE PRECISION :: ECON, EREP, ETOTAL, RMS
DOUBLE PRECISION R1AX,R1AY,R1AZ,R2AX,R2AY,R2AZ,R1BX,R1BY,R1BZ,R2BX,R2BY,R2BZ,D2,D1
DOUBLE PRECISION G1(3),G2(3),CONCUT,DINT,G1INT(3),G2INT(3)
DOUBLE PRECISION DUMMY, REPGRAD(3), INTCONST, D12, DSQ2, DSQ1, DSQI
DOUBLE PRECISION CONE(INTIMAGE+2), REPE(INTIMAGE+2),MAXINT,MININT,REPEINT(INTIMAGE+2),RMSIM(INTIMAGE+2)
LOGICAL NOINT
DOUBLE PRECISION XYZ(NOPT*(INTIMAGE+2)), GGG(NOPT*(INTIMAGE+2)), EEE(INTIMAGE+2)
LOGICAL IMGFREEZE(INTIMAGE)

EEE(1:INTIMAGE+2)=0.0D0
CONE(1:INTIMAGE+2)=0.0D0
REPE(1:INTIMAGE+2)=0.0D0
REPEINT(1:INTIMAGE+2)=0.0D0
NREPINT(1:INTIMAGE+2)=0
GGG(1:NOPT*(INTIMAGE+2))=0.0D0
ECON=0.0D0; EREP=0.0D0

!
!  CONSTRAINT ENERGY AND FORCES.
!
DO J2=1,NCONSTRAINT
   IF (.NOT.CONACTIVE(J2)) CYCLE
!
   CONCUT=0.2D0*CONDISTREF(J2)
!
! FOR J1 WE CONSIDER THE LINE SEGMENT BETWEEN IMAGE J1-1 AND J1.
! THERE ARE INTIMAGE+1 LINE SEGMENTS IN TOTAL, WITH AN ENERGY CONTRIBUTION
! AND CORRESPONDING GRADIENT TERMS FOR EACH. 
! A AND B REFER TO ATOMS, 2 REFERS TO IMAGE J1.
!
!  DO J1=2,INTIMAGE+1
   DO J1=1,INTIMAGE+2  ! CHECKING FOR ZERO!
      NI1=NOPT*(J1-1)+3*(CONI(J2)-1)
      NJ1=NOPT*(J1-1)+3*(CONJ(J2)-1)
      R2AX=XYZ(NI1+1); R2AY=XYZ(NI1+2); R2AZ=XYZ(NI1+3)
      R2BX=XYZ(NJ1+1); R2BY=XYZ(NJ1+2); R2BZ=XYZ(NJ1+3)
      D2=SQRT((R2AX-R2BX)**2+(R2AY-R2BY)**2+(R2AZ-R2BZ)**2)
      IF ((ABS(D2-CONDISTREFLOCAL(J2)).GT.CONCUT)) THEN 
         DUMMY=D2-CONDISTREFLOCAL(J2)  
         G2(1)=(R2AX-R2BX)/D2
         G2(2)=(R2AY-R2BY)/D2
         G2(3)=(R2AZ-R2BZ)/D2
         REPGRAD(1:3)=2*INTCONSTRAINTDEL*((DUMMY/CONCUT)**2-1.0D0)*DUMMY*G2(1:3)
         DUMMY=INTCONSTRAINTDEL*(DUMMY**2-CONCUT**2)**2/(2.0D0*CONCUT**2)
         EEE(J1)=EEE(J1)  +DUMMY
         ECON=ECON        +DUMMY
         CONE(J1)=CONE(J1)+DUMMY
         GGG(NI1+1:NI1+3)=GGG(NI1+1:NI1+3)+REPGRAD(1:3)
         GGG(NJ1+1:NJ1+3)=GGG(NJ1+1:NJ1+3)-REPGRAD(1:3)
      ENDIF
   ENDDO
ENDDO

GGG(1:NOPT)=0.0D0                            ! CAN DELETE WHEN LOOP RANGE ABOVE CHANGES
GGG(NOPT*(INTIMAGE+1)+1:NOPT*(INTIMAGE+2))=0.0D0 ! CAN DELETE WHEN LOOP RANGE ABOVE CHANGES

! INTCONST=INTCONSTRAINREPCUT**13

DO J2=1,NNREPULSIVE
!  INTCONST=NREPCUT(J2)**13
   INTCONST=NREPCUT(J2)**3
!  DO J1=2,INTIMAGE+2
   DO J1=1,INTIMAGE+2 ! CAN CHANGE WHEN ZERO ENERGIES ARE CONFIRMED FOR END IMAGES
      NI2=NOPT*(J1-1)+3*(NREPI(J2)-1)
      NJ2=NOPT*(J1-1)+3*(NREPJ(J2)-1)
      R2AX=XYZ(NI2+1); R2AY=XYZ(NI2+2); R2AZ=XYZ(NI2+3)
      R2BX=XYZ(NJ2+1); R2BY=XYZ(NJ2+2); R2BZ=XYZ(NJ2+3)
      D2=SQRT((R2AX-R2BX)**2+(R2AY-R2BY)**2+(R2AZ-R2BZ)**2)
      IF (D2.LT.NREPCUT(J2)) THEN ! TERM FOR IMAGE J1
!        D12=D2**12
         D12=D2**2
!        DUMMY=INTCONSTRAINTREP*(1.0D0/D12+(12.0D0*D2-13.0D0*NREPCUT(J2))/INTCONST)
         DUMMY=INTCONSTRAINTREP*(1.0D0/D12+(2.0D0*D2-3.0D0*NREPCUT(J2))/INTCONST)
         EEE(J1)=EEE(J1)+DUMMY
         REPE(J1)=REPE(J1)+DUMMY
         EREP=EREP+DUMMY
!        DUMMY=-12.0D0*INTCONSTRAINTREP*(1.0D0/(D2*D12)-1.0D0/INTCONST)
         DUMMY=-2.0D0*INTCONSTRAINTREP*(1.0D0/(D2*D12)-1.0D0/INTCONST)
         G2(1)=(R2AX-R2BX)/D2
         G2(2)=(R2AY-R2BY)/D2
         G2(3)=(R2AZ-R2BZ)/D2
         REPGRAD(1:3)=DUMMY*G2(1:3)
         GGG(NI2+1:NI2+3)=GGG(NI2+1:NI2+3)+REPGRAD(1:3)
         GGG(NJ2+1:NJ2+3)=GGG(NJ2+1:NJ2+3)-REPGRAD(1:3)
      ENDIF
!
! FOR INTERNAL MINIMA WE ARE COUNTING EDGES. 
! EDGE J1 IS BETWEEN IMAGES J1-1 AND J1, STARTING FROM J1=2.
! ENERGY CONTRIBUTIONS ARE SHARED EVENLY, EXCEPT FOR
! EDGE 1, WHICH IS ASSIGNED TO IMAGE 2, AND EDGE INTIMAGE+1, WHICH
! IS ASSIGNED TO IMAGE INTIMAGE+1. GRADIENTS ARE SET TO ZERO FOR
! THE END IMAGES.
!
      IF (J1.EQ.1) CYCLE
      NI1=NOPT*(J1-2)+3*(NREPI(J2)-1)
      NJ1=NOPT*(J1-2)+3*(NREPJ(J2)-1)
      R1AX=XYZ(NI1+1); R1AY=XYZ(NI1+2); R1AZ=XYZ(NI1+3)
      R1BX=XYZ(NJ1+1); R1BY=XYZ(NJ1+2); R1BZ=XYZ(NJ1+3)
      CALL MINMAXD2R(R1AX,R1AY,R1AZ,R2AX,R2AY,R2AZ,R1BX,R1BY,R1BZ,R2BX,R2BY,R2BZ, &
  &                 D2,D1,DINT,DSQ2,DSQ1,DSQI,G1,G2,G1INT,G2INT,NOINT,.FALSE.,NREPCUT(J2))
      IF ((.NOT.NOINT).AND.(DINT.LT.NREPCUT(J2))) THEN
!        D12=DSQI**6
         D12=DSQI
!        DUMMY=INTCONSTRAINTREP*(1.0D0/D12+(12.0D0*DINT-13.0D0*NREPCUT(J2))/INTCONST)
         DUMMY=INTCONSTRAINTREP*(1.0D0/D12+(2.0D0*DINT-3.0D0*NREPCUT(J2))/INTCONST)
         IF (J1.EQ.2) THEN
            EEE(J1)=EEE(J1)+DUMMY
            REPEINT(J1)=REPEINT(J1)+DUMMY
            NREPINT(J1)=NREPINT(J1)+1
         ELSE IF (J1.LT.INTIMAGE+2) THEN
            EEE(J1)=EEE(J1)+DUMMY/2.0D0
            EEE(J1-1)=EEE(J1-1)+DUMMY/2.0D0
            REPEINT(J1)=REPEINT(J1)+DUMMY/2.0D0
            REPEINT(J1-1)=REPEINT(J1-1)+DUMMY/2.0D0
            NREPINT(J1)=NREPINT(J1)+1
            NREPINT(J1-1)=NREPINT(J1-1)+1
         ELSE IF (J1.EQ.INTIMAGE+2) THEN
            EEE(J1-1)=EEE(J1-1)+DUMMY
            REPEINT(J1-1)=REPEINT(J1-1)+DUMMY
            NREPINT(J1-1)=NREPINT(J1-1)+1
         ENDIF
         EREP=EREP+DUMMY
!        DUMMY=-12.0D0*INTCONSTRAINTREP*(1.0D0/(DINT*D12)-1.0D0/INTCONST)
         DUMMY=-2.0D0*INTCONSTRAINTREP*(1.0D0/(DINT*D12)-1.0D0/INTCONST)
         REPGRAD(1:3)=DUMMY*G1INT(1:3)
!        PRINT '(A,4I6,2G15.5)','IN1 J1,J2,REPI,REPJ,REPGRAD,NREPCUT=',J1,J2,NREPI(J2),NREPJ(J2), &
! &                              SQRT(REPGRAD(1)**2+REPGRAD(2)**2+REPGRAD(3)**2),NREPCUT(J2)
!
! GRADIENT CONTRIBUTIONS FOR IMAGE J1-1
!
         GGG(NI1+1:NI1+3)=GGG(NI1+1:NI1+3)+REPGRAD(1:3)
         GGG(NJ1+1:NJ1+3)=GGG(NJ1+1:NJ1+3)-REPGRAD(1:3)
         REPGRAD(1:3)=DUMMY*G2INT(1:3)
!        PRINT '(A,4I6,2G15.5)','IN1 J1,J2,REPI,REPJ,REPGRAD,NREPCUT=',J1,J2,NREPI(J2),NREPJ(J2), &
! &                              SQRT(REPGRAD(1)**2+REPGRAD(2)**2+REPGRAD(3)**2),NREPCUT(J2)
!
! GRADIENT CONTRIBUTIONS FOR IMAGE J1
!
         GGG(NI2+1:NI2+3)=GGG(NI2+1:NI2+3)+REPGRAD(1:3)
         GGG(NJ2+1:NJ2+3)=GGG(NJ2+1:NJ2+3)-REPGRAD(1:3)
      ENDIF
   ENDDO
ENDDO
!
! SET GRADIENTS ON FROZEN ATOMS TO ZERO.
!
IF (FREEZE) THEN
   DO J1=2,INTIMAGE+1  
      DO J2=1,NATOMS
         IF (FROZEN(J2)) THEN
            GGG(NOPT*(J1-1)+3*(J2-1)+1)=0.0D0
            GGG(NOPT*(J1-1)+3*(J2-1)+2)=0.0D0
            GGG(NOPT*(J1-1)+3*(J2-1)+3)=0.0D0
         ENDIF
      ENDDO
   ENDDO
ENDIF
!
! SET GRADIENTS TO ZERO FOR START AND FINISH IMAGES.
!
GGG(1:NOPT)=0.0D0
GGG((INTIMAGE+1)*NOPT+1:(INTIMAGE+2)*NOPT)=0.0D0
RMS=0.0D0
DO J1=2,INTIMAGE+1
   RMSIM(J1)=0.0D0
   DO J2=1,NOPT
      RMS=RMS+GGG(NOPT*(J1-1)+J2)**2
      RMSIM(J1)=RMSIM(J1)+GGG(NOPT*(J1-1)+J2)**2
   ENDDO
   RMSIM(J1)=SQRT(RMSIM(J1)/NOPT)
ENDDO
IF (INTIMAGE.NE.0) THEN
   RMS=SQRT(RMS/(NOPT*INTIMAGE))
ENDIF
!
! FOR INTIMAGE IMAGES THERE ARE INTIMAGE+2 REPLICAS INCLUDING THE END POINTS,
! AND INTIMAGE+1 LINE SEGEMENTS, WITH ASSOCIATED ENERGIES STORED IN EEE(2:INTIMAGE+2)
!
ETOTAL=0.0D0
MAXINT=-1.0D100
MININT=1.0D100
DO J1=2,INTIMAGE+1
   ETOTAL=ETOTAL+EEE(J1)
   PRINT '(A,I6,A,3G20.10)',' CONGRAD> CON/REP/RMS IMAGE ',J1,' ',CONE(J1),REPE(J1),RMSIM(J1)
   IF (REPEINT(J1).LT.MININT) THEN
      MININT=REPEINT(J1)
      NMININT=J1
   ENDIF
   IF (REPE(J1).GT.MAXINT) THEN
      MAXINT=REPE(J1)
      NMAXINT=J1
   ENDIF
ENDDO
IF (DEBUG) PRINT '(A,G20.10,A,2I6)',' CONGRAD> LARGEST  INTERNAL ENERGY=',MAXINT,' FOR IMAGE ',NMAXINT
IF (DEBUG) PRINT '(A,G20.10,A,2I6)',' CONGRAD> SMALLEST INTERNAL ENERGY=',MININT,' FOR IMAGE ',NMININT

END SUBROUTINE CONGRAD

SUBROUTINE MINMAXD2(R1AX,R1AY,R1AZ,R2AX,R2AY,R2AZ,R1BX,R1BY,R1BZ,R2BX,R2BY,R2BZ, &
  &                 D2,D1,DINT,G1,G2,G1INT,G2INT,NOINT,DEBUG)
IMPLICIT NONE
DOUBLE PRECISION R1AX,R1AY,R1AZ,R2AX,R2AY,R2AZ,R1BX,R1BY,R1BZ,R2BX,R2BY,R2BZ,D2,D1,DINT
DOUBLE PRECISION G1(3),G2(3),G1INT(3),G2INT(3)
DOUBLE PRECISION DSQ2, DSQ1, DSQI, R1APR2BMR2AMR1BSQ, R1AMR1BSQ, R2AMR2BSQ
DOUBLE PRECISION R1AMR1BDR2AMR2B, R1AMR1BDR2AMR2BSQ, DUMMY
LOGICAL NOINT, DEBUG
!
! SQUARED DISTANCE BETWEEN ATOMS A AND B FOR THETA=0 - DISTANCE IN IMAGE 2
!
DSQ2=R2AX**2 + R2AY**2 + R2AZ**2 + R2BX**2 + R2BY**2 + R2BZ**2 - 2*(R2AX*R2BX + R2AY*R2BY + R2AZ*R2BZ)
!
! SQUARED DISTANCE BETWEEN ATOMS A AND B FOR THETA=PI/2 - DISTANCE IN IMAGE 1
!
DSQ1=R1AX**2 + R1AY**2 + R1AZ**2 + R1BX**2 + R1BY**2 + R1BZ**2 - 2*(R1AX*R1BX + R1AY*R1BY + R1AZ*R1BZ)
! PRINT '(A,6F15.10)','R1AX,R1AY,R1AZ,R2AX,R2AY,R2AZ=',R1AX,R1AY,R1AZ,R2AX,R2AY,R2AZ
! PRINT '(A,6F15.10)','R1BX,R1BY,R1BZ,R2BX,R2BY,R2BZ=',R1BX,R1BY,R1BZ,R2BX,R2BY,R2BZ
!
! IS THERE AN INTERNAL EXTREMUM?
!
R1APR2BMR2AMR1BSQ=(R1AX-R1BX-R2AX+R2BX)**2+(R1AY-R1BY-R2AY+R2BY)**2+(R1AZ-R1BZ-R2AZ+R2BZ)**2
IF (R1APR2BMR2AMR1BSQ.EQ.0.0D0) THEN
   DUMMY=2.0D0 ! JUST TO SKIP THE INTERNAL EXTREMUM PART
ELSE
   DUMMY=((R1AX-R1BX)*(R1AX-R1BX-R2AX+R2BX)+(R1AY-R1BY)*(R1AY-R1BY-R2AY+R2BY)+(R1AZ-R1BZ)*(R1AZ-R1BZ-R2AZ+R2BZ))/R1APR2BMR2AMR1BSQ
ENDIF
NOINT=.TRUE.
IF ((DUMMY.GT.0.0D0).AND.(DUMMY.LT.1.0D0)) NOINT=.FALSE.
G2(1:3)=0.0D0
G1(1:3)=0.0D0
G1INT(1:3)=0.0D0
G2INT(1:3)=0.0D0
D2=SQRT(DSQ2)
D1=SQRT(DSQ1)
G2(1)=R2AX - R2BX
G2(2)=R2AY - R2BY
G2(3)=R2AZ - R2BZ
G1(1)=R1AX - R1BX
G1(2)=R1AY - R1BY
G1(3)=R1AZ - R1BZ
DSQI=1.0D10
DINT=1.0D10
IF (.NOT.NOINT) THEN
   R1AMR1BDR2AMR2B=(R1AX-R1BX)*(R2AX-R2BX)+(R1AY-R1BY)*(R2AY-R2BY)+(R1AZ-R1BZ)*(R2AZ-R2BZ)
   R1AMR1BDR2AMR2BSQ=R1AMR1BDR2AMR2B**2
   R1AMR1BSQ=(R1AX - R1BX)**2 + (R1AY - R1BY)**2 + (R1AZ - R1BZ)**2
   R2AMR2BSQ=(R2AX - R2BX)**2 + (R2AY - R2BY)**2 + (R2AZ - R2BZ)**2
   DSQI=(-R1AMR1BDR2AMR2BSQ + R1AMR1BSQ*R2AMR2BSQ)/R1APR2BMR2AMR1BSQ
   DUMMY=R1APR2BMR2AMR1BSQ**2
   DINT=SQRT(DSQI)
   IF (DINT.LE.0.0D0) THEN
      NOINT=.TRUE.
   ELSE
      G1INT(1)= (((R1AMR1BDR2AMR2BSQ - R1AMR1BSQ*R2AMR2BSQ)*(R1AX - R1BX - R2AX + R2BX) + &
 &    R1APR2BMR2AMR1BSQ*((R1AX - R1BX)*R2AMR2BSQ + R1AMR1BDR2AMR2B*(-R2AX + R2BX))))/DUMMY
      G1INT(2)= (((R1AMR1BDR2AMR2BSQ - R1AMR1BSQ*R2AMR2BSQ)*(R1AY - R1BY - R2AY + R2BY) + &
 &    R1APR2BMR2AMR1BSQ*((R1AY - R1BY)*R2AMR2BSQ + R1AMR1BDR2AMR2B*(-R2AY + R2BY))))/DUMMY
      G1INT(3)= (((R1AMR1BDR2AMR2BSQ - R1AMR1BSQ*R2AMR2BSQ)*(R1AZ - R1BZ - R2AZ + R2BZ) + &
 &    R1APR2BMR2AMR1BSQ*((R1AZ - R1BZ)*R2AMR2BSQ + R1AMR1BDR2AMR2B*(-R2AZ + R2BZ))))/DUMMY

      G2INT(1)= (((R1AMR1BDR2AMR2BSQ - R1AMR1BSQ*R2AMR2BSQ)*(R2AX - R2BX - R1AX + R1BX) + &
 &    R1APR2BMR2AMR1BSQ*((R2AX - R2BX)*R1AMR1BSQ + R1AMR1BDR2AMR2B*(-R1AX + R1BX))))/DUMMY
      G2INT(2)= (((R1AMR1BDR2AMR2BSQ - R1AMR1BSQ*R2AMR2BSQ)*(R2AY - R2BY - R1AY + R1BY) + &
 &    R1APR2BMR2AMR1BSQ*((R2AY - R2BY)*R1AMR1BSQ + R1AMR1BDR2AMR2B*(-R1AY + R1BY))))/DUMMY
      G2INT(3)= (((R1AMR1BDR2AMR2BSQ - R1AMR1BSQ*R2AMR2BSQ)*(R2AZ - R2BZ - R1AZ + R1BZ) + &
 &    R1APR2BMR2AMR1BSQ*((R2AZ - R2BZ)*R1AMR1BSQ + R1AMR1BDR2AMR2B*(-R1AZ + R1BZ))))/DUMMY
   ENDIF
ENDIF
!
! CONVERT DERIVATIVES OF DISTANCE^2 TO DERIVATIVE OF DISTANCE.
! WE HAVE CANCELLED A FACTOR OF TWO ABOVE AND BELOW!
!
G2(1:3)=G2(1:3)/D2
G1(1:3)=G1(1:3)/D1
IF (.NOT.NOINT) THEN
   G1INT(1:3)=G1INT(1:3)/DINT
   G2INT(1:3)=G2INT(1:3)/DINT
ENDIF

! PRINT '(A,3G12.5,L5)','D2,D1,DINT,NOINT=',D2,D1,DINT,NOINT

END SUBROUTINE MINMAXD2

SUBROUTINE MINMAXD2R(R1AX,R1AY,R1AZ,R2AX,R2AY,R2AZ,R1BX,R1BY,R1BZ,R2BX,R2BY,R2BZ, &
  &                 D2,D1,DINT,DSQ2,DSQ1,DSQI,G1,G2,G1INT,G2INT,NOINT,DEBUG,INTCONSTRAINREPCUT)
IMPLICIT NONE
DOUBLE PRECISION R1AX,R1AY,R1AZ,R2AX,R2AY,R2AZ,R1BX,R1BY,R1BZ,R2BX,R2BY,R2BZ,D2,D1,DINT
DOUBLE PRECISION G1(3),G2(3),G1INT(3),G2INT(3),INTCONSTRAINREPCUT
DOUBLE PRECISION DSQ2, DSQ1, DSQI, R1APR2BMR2AMR1BSQ, R1AMR1BSQ, R2AMR2BSQ
DOUBLE PRECISION R1AMR1BDR2AMR2B, R1AMR1BDR2AMR2BSQ, DUMMY
LOGICAL NOINT, DEBUG
!
! SQUARED DISTANCE BETWEEN ATOMS A AND B FOR THETA=0 - DISTANCE IN IMAGE 2
!
DSQ2=R2AX**2 + R2AY**2 + R2AZ**2 + R2BX**2 + R2BY**2 + R2BZ**2 - 2*(R2AX*R2BX + R2AY*R2BY + R2AZ*R2BZ)
!
! SQUARED DISTANCE BETWEEN ATOMS A AND B FOR THETA=PI/2 - DISTANCE IN IMAGE 1
!
DSQ1=R1AX**2 + R1AY**2 + R1AZ**2 + R1BX**2 + R1BY**2 + R1BZ**2 - 2*(R1AX*R1BX + R1AY*R1BY + R1AZ*R1BZ)
!
! IS THERE AN INTERNAL EXTREMUM?
!
R1APR2BMR2AMR1BSQ=(R1AX-R1BX-R2AX+R2BX)**2+(R1AY-R1BY-R2AY+R2BY)**2+(R1AZ-R1BZ-R2AZ+R2BZ)**2
IF (R1APR2BMR2AMR1BSQ.EQ.0.0D0) THEN
   DUMMY=2.0D0 ! JUST TO SKIP THE INTERNAL SOLUTION
ELSE
   DUMMY=((R1AX-R1BX)*(R1AX-R1BX-R2AX+R2BX)+(R1AY-R1BY)*(R1AY-R1BY-R2AY+R2BY)+(R1AZ-R1BZ)*(R1AZ-R1BZ-R2AZ+R2BZ))/R1APR2BMR2AMR1BSQ
ENDIF
NOINT=.TRUE.
IF ((DUMMY.GT.0.0D0).AND.(DUMMY.LT.1.0D0)) NOINT=.FALSE.
G2(1:3)=0.0D0
G1(1:3)=0.0D0
G1INT(1:3)=0.0D0
G2INT(1:3)=0.0D0
D2=SQRT(DSQ2)
D1=SQRT(DSQ1)
G2(1)=R2AX - R2BX
G2(2)=R2AY - R2BY
G2(3)=R2AZ - R2BZ
G1(1)=R1AX - R1BX
G1(2)=R1AY - R1BY
G1(3)=R1AZ - R1BZ
DSQI=1.0D10
DINT=1.0D10
IF (.NOT.NOINT) THEN
   R1AMR1BDR2AMR2B=(R1AX-R1BX)*(R2AX-R2BX)+(R1AY-R1BY)*(R2AY-R2BY)+(R1AZ-R1BZ)*(R2AZ-R2BZ)
   R1AMR1BDR2AMR2BSQ=R1AMR1BDR2AMR2B**2
   R1AMR1BSQ=(R1AX - R1BX)**2 + (R1AY - R1BY)**2 + (R1AZ - R1BZ)**2
   R2AMR2BSQ=(R2AX - R2BX)**2 + (R2AY - R2BY)**2 + (R2AZ - R2BZ)**2
   DSQI=MAX((-R1AMR1BDR2AMR2BSQ + R1AMR1BSQ*R2AMR2BSQ)/R1APR2BMR2AMR1BSQ,0.0D0)
   DUMMY=R1APR2BMR2AMR1BSQ**2
   DINT=SQRT(DSQI)
   IF (DINT.LE.0.0D0) THEN
      NOINT=.TRUE.
   ELSEIF (DINT.LE.INTCONSTRAINREPCUT) THEN ! SKIP OTHERWISE
      G1INT(1)= (((R1AMR1BDR2AMR2BSQ - R1AMR1BSQ*R2AMR2BSQ)*(R1AX - R1BX - R2AX + R2BX) + &
 &    R1APR2BMR2AMR1BSQ*((R1AX - R1BX)*R2AMR2BSQ + R1AMR1BDR2AMR2B*(-R2AX + R2BX))))/DUMMY
      G1INT(2)= (((R1AMR1BDR2AMR2BSQ - R1AMR1BSQ*R2AMR2BSQ)*(R1AY - R1BY - R2AY + R2BY) + &
 &    R1APR2BMR2AMR1BSQ*((R1AY - R1BY)*R2AMR2BSQ + R1AMR1BDR2AMR2B*(-R2AY + R2BY))))/DUMMY
      G1INT(3)= (((R1AMR1BDR2AMR2BSQ - R1AMR1BSQ*R2AMR2BSQ)*(R1AZ - R1BZ - R2AZ + R2BZ) + &
 &    R1APR2BMR2AMR1BSQ*((R1AZ - R1BZ)*R2AMR2BSQ + R1AMR1BDR2AMR2B*(-R2AZ + R2BZ))))/DUMMY

      G2INT(1)= (((R1AMR1BDR2AMR2BSQ - R1AMR1BSQ*R2AMR2BSQ)*(R2AX - R2BX - R1AX + R1BX) + &
 &    R1APR2BMR2AMR1BSQ*((R2AX - R2BX)*R1AMR1BSQ + R1AMR1BDR2AMR2B*(-R1AX + R1BX))))/DUMMY
      G2INT(2)= (((R1AMR1BDR2AMR2BSQ - R1AMR1BSQ*R2AMR2BSQ)*(R2AY - R2BY - R1AY + R1BY) + &
 &    R1APR2BMR2AMR1BSQ*((R2AY - R2BY)*R1AMR1BSQ + R1AMR1BDR2AMR2B*(-R1AY + R1BY))))/DUMMY
      G2INT(3)= (((R1AMR1BDR2AMR2BSQ - R1AMR1BSQ*R2AMR2BSQ)*(R2AZ - R2BZ - R1AZ + R1BZ) + &
 &    R1APR2BMR2AMR1BSQ*((R2AZ - R2BZ)*R1AMR1BSQ + R1AMR1BDR2AMR2B*(-R1AZ + R1BZ))))/DUMMY
   ENDIF
ENDIF
!
! CONVERT DERIVATIVES OF DISTANCE^2 TO DERIVATIVE OF DISTANCE.
! WE HAVE CANCELLED A FACTOR OF TWO ABOVE AND BELOW!
!
G2(1:3)=G2(1:3)/D2
G1(1:3)=G1(1:3)/D1
IF (.NOT.NOINT) THEN
!  IF (DINT.EQ.0.0D0) THEN
!     PRINT '(A,G20.10)','MINMAXD2R> ERROR *** DINT=',DINT
!     PRINT *,'ORIGINAL DUMMY=',((R1AX-R1BX)*(R1AX-R1BX-R2AX+R2BX)+ &
! &        (R1AY-R1BY)*(R1AY-R1BY-R2AY+R2BY)+(R1AZ-R1BZ)*(R1AZ-R1BZ-R2AZ+R2BZ))/R1APR2BMR2AMR1BSQ
!     PRINT *,'R1AMR1BDR2AMR2B=',R1AMR1BDR2AMR2B
!     PRINT *,'R1AMR1BDR2AMR2BSQ=',R1AMR1BDR2AMR2BSQ
!     PRINT *,'R1AMR1BSQ=',R1AMR1BSQ
!     PRINT *,'R2AMR2BSQ=',R2AMR2BSQ
!     PRINT *,'DSQI=',DSQI
!     PRINT *,'DUMMY=',DUMMY
!     PRINT *,'G1INT=',G1INT(1:3)
!     PRINT *,'G2INT=',G2INT(1:3)
!     PRINT *,'R1AX,R1AY,R1AZ=',R1AX,R1AY,R1AZ
!     PRINT *,'R2AX,R2AY,R2AZ=',R2AX,R2AY,R2AZ
!     PRINT *,'R1BX,R1BY,R1BZ=',R1BX,R1BY,R1BZ
!     PRINT *,'R2BX,R2BY,R2BZ=',R2BX,R2BY,R2BZ
!     STOP
!  ENDIF
   G1INT(1:3)=G1INT(1:3)/DINT
   G2INT(1:3)=G2INT(1:3)/DINT
ENDIF

END SUBROUTINE MINMAXD2R

!
! THIS VERSION OF CONGRAD TESTS FOR AN INTERNAL MINIMUM IN THE
! CONSTRAINT DISTANCES AS WELL AS THE REPULSIONS.
!
SUBROUTINE CONGRAD2(NMAXINT,NMININT,ETOTAL,XYZ,GGG,EEE,IMGFREEZE,RMS)
USE KEY, ONLY: FROZEN, FREEZE, NREPI, NREPJ, NNREPULSIVE, DEBUG, &
  &            NCONSTRAINT, CONI, CONJ, INTCONSTRAINTDEL, CONDISTREF, INTCONSTRAINTREP, CONDISTREFLOCAL, &
  &            CONACTIVE, INTCONSTRAINREPCUT, NREPCUT,FREEZENODEST, INTIMAGE
USE COMMONS, ONLY: NATOMS, NOPT
IMPLICIT NONE
           
INTEGER :: J1,J2,NI2,NI1,NJ2,NJ1,NMAXINT,NMININT,NCONINT(INTIMAGE+2),NREPINT(INTIMAGE+2)
DOUBLE PRECISION :: ECON, EREP, ETOTAL, RMS
DOUBLE PRECISION R1AX,R1AY,R1AZ,R2AX,R2AY,R2AZ,R1BX,R1BY,R1BZ,R2BX,R2BY,R2BZ,D2,D1
DOUBLE PRECISION G1(3),G2(3),CONCUT,DINT,G1INT(3),G2INT(3)
DOUBLE PRECISION DUMMY, REPGRAD(3), INTCONST, D12, DSQ2, DSQ1, DSQI
DOUBLE PRECISION CONE(INTIMAGE+2), REPE(INTIMAGE+2),MAXINT,MININT,REPEINT(INTIMAGE+2),CONEINT(INTIMAGE+2),RMSIMAGE(INTIMAGE+2)
LOGICAL NOINT, LPRINT
DOUBLE PRECISION XYZ(NOPT*(INTIMAGE+2)), GGG(NOPT*(INTIMAGE+2)), EEE(INTIMAGE+2)
LOGICAL IMGFREEZE(INTIMAGE)

EEE(1:INTIMAGE+2)=0.0D0
CONE(1:INTIMAGE+2)=0.0D0
REPE(1:INTIMAGE+2)=0.0D0
NCONINT(1:INTIMAGE+2)=0
NREPINT(1:INTIMAGE+2)=0
REPEINT(1:INTIMAGE+2)=0.0D0
CONEINT(1:INTIMAGE+2)=0.0D0
GGG(1:NOPT*(INTIMAGE+2))=0.0D0
ECON=0.0D0; EREP=0.0D0
LPRINT=.TRUE.
LPRINT=.FALSE.
!
!  CONSTRAINT ENERGY AND FORCES.
!
! FOR J1 WE CONSIDER THE LINE SEGMENT BETWEEN IMAGE J1-1 AND J1.
! THERE ARE INTIMAGE+1 LINE SEGMENTS IN TOTAL, WITH AN ENERGY CONTRIBUTION
! AND CORRESPONDING GRADIENT TERMS FOR EACH. 
! A AND B REFER TO ATOMS, 1 AND 2 TO IMAGES J1-1 AND J1 CORRESPONDING TO J1-2 AND J1-1 BELOW.
!
! IMGFREEZE(1:INTIMAGE) REFERS TO THE IMAGES EXCLUDING END POINTS!
!
DO J2=1,NCONSTRAINT
   IF (.NOT.CONACTIVE(J2)) CYCLE
   DO J1=2,INTIMAGE+2
      IF (FREEZENODEST) THEN ! IMGFREEZE IS NOT ALLOCATED OTHERWISE!
         IF (J1.EQ.2) THEN
            IF (IMGFREEZE(1)) CYCLE
         ELSE IF (J1.EQ.INTIMAGE+2) THEN
            IF (IMGFREEZE(INTIMAGE)) CYCLE
         ELSE
            IF (IMGFREEZE(J1-2).AND.IMGFREEZE(J1-1)) CYCLE
         ENDIF
      ENDIF
      NI1=NOPT*(J1-2)+3*(CONI(J2)-1)
      NI2=NOPT*(J1-1)+3*(CONI(J2)-1)
      NJ1=NOPT*(J1-2)+3*(CONJ(J2)-1)
      NJ2=NOPT*(J1-1)+3*(CONJ(J2)-1)
      R1AX=XYZ(NI1+1); R1AY=XYZ(NI1+2); R1AZ=XYZ(NI1+3)
      R1BX=XYZ(NJ1+1); R1BY=XYZ(NJ1+2); R1BZ=XYZ(NJ1+3)
      R2AX=XYZ(NI2+1); R2AY=XYZ(NI2+2); R2AZ=XYZ(NI2+3)
      R2BX=XYZ(NJ2+1); R2BY=XYZ(NJ2+2); R2BZ=XYZ(NJ2+3)
      CALL MINMAXD2(R1AX,R1AY,R1AZ,R2AX,R2AY,R2AZ,R1BX,R1BY,R1BZ,R2BX,R2BY,R2BZ, &
  &                 D2,D1,DINT,G1,G2,G1INT,G2INT,NOINT,.FALSE.)
!
! NEED TO INCLUDE BOTH D2 AND D1 CONTRIBUTIONS IF THEY ARE BOTH OUTSIDE TOLERANCE.
! OTHERWISE WE GET DISCONTINUITIES IF THEY ARE VERY CLOSE AND SWAP OVER.
!
      CONCUT=CONDISTREF(J2)*0.2D0
!
! TERMS FOR IMAGE J1 - NON-ZERO DERIVATIVES ONLY FOR J1. D2 IS THE DISTANCE FOR IMAGE J1.
!
!     IF (LPRINT) PRINT '(A,I6,5G15.5)', &
! &       'J1,D2,D1,DINT,MIN DIFF,CONCUT=',J1,D2,D1,DINT,ABS(D2-CONDISTREFLOCAL(J2)),CONCUT
      IF ((ABS(D2-CONDISTREFLOCAL(J2)).GT.CONCUT).AND.(J1.LT.INTIMAGE+2)) THEN 
         DUMMY=D2-CONDISTREFLOCAL(J2)  
         REPGRAD(1:3)=2*INTCONSTRAINTDEL*((DUMMY/CONCUT)**2-1.0D0)*DUMMY*G2(1:3)
         DUMMY=INTCONSTRAINTDEL*(DUMMY**2-CONCUT**2)**2/(2.0D0*CONCUT**2)
         EEE(J1)=EEE(J1)+DUMMY
         CONE(J1)=CONE(J1)+DUMMY
         ECON=ECON      +DUMMY
!        IF (LPRINT) PRINT '(A,4I6,G15.5)','MIN J1,J2,CONI,CONJ,REPGRAD=',J1,J2,CONI(J2),CONJ(J2), &
! &                              SQRT(REPGRAD(1)**2+REPGRAD(2)**2+REPGRAD(3)**2)
         GGG(NI2+1:NI2+3)=GGG(NI2+1:NI2+3)+REPGRAD(1:3)
         GGG(NJ2+1:NJ2+3)=GGG(NJ2+1:NJ2+3)-REPGRAD(1:3)
      ENDIF
!
! DON'T ADD ENERGY CONTRIBUTIONS TO EEE(2) FROM D1, SINCE THE GRADIENTS ARE NON-ZERO ONLY FOR IMAGE 1.
!
! TERMS FOR IMAGE J1-1 - NON-ZERO DERIVATIVES ONLY FOR J1-1. D1 IS THE DISTANCE FOR IMAGE J1-1.
!
!     IF (LPRINT) PRINT '(A,I6,5G15.5)', &
! &       'J1,D2,D1,DINT,MAX DIFF,CONCUT=',J1,D2,D1,DINT,ABS(D1-CONDISTREFLOCAL(J2)),CONCUT
      IF ((ABS(D1-CONDISTREFLOCAL(J2)).GT.CONCUT).AND.(J1.GT.2)) THEN  
         DUMMY=D1-CONDISTREFLOCAL(J2)  
         REPGRAD(1:3)=2*INTCONSTRAINTDEL*((DUMMY/CONCUT)**2-1.0D0)*DUMMY*G1(1:3)
         DUMMY=INTCONSTRAINTDEL*(DUMMY**2-CONCUT**2)**2/(2.0D0*CONCUT**2)
         EEE(J1-1)=EEE(J1-1)+DUMMY
         CONE(J1-1)=CONE(J1-1)+DUMMY
         ECON=ECON      +DUMMY
!        IF (LPRINT) PRINT '(A,4I6,G15.5)','MAX J1,J2,CONI,CONJ,REPGRAD=',J1,J2,CONI(J2),CONJ(J2), &
! &         SQRT(REPGRAD(1)**2+REPGRAD(2)**2+REPGRAD(3)**2)
         GGG(NI1+1:NI1+3)=GGG(NI1+1:NI1+3)+REPGRAD(1:3)
         GGG(NJ1+1:NJ1+3)=GGG(NJ1+1:NJ1+3)-REPGRAD(1:3)
      ENDIF
      IF ((.NOT.NOINT).AND.(ABS(DINT-CONDISTREFLOCAL(J2)).GT.CONCUT)) THEN
         DUMMY=DINT-CONDISTREFLOCAL(J2)  
         REPGRAD(1:3)=2*INTCONSTRAINTDEL*((DUMMY/CONCUT)**2-1.0D0)*DUMMY*G1INT(1:3)
         GGG(NI1+1:NI1+3)=GGG(NI1+1:NI1+3)+REPGRAD(1:3)
         GGG(NJ1+1:NJ1+3)=GGG(NJ1+1:NJ1+3)-REPGRAD(1:3)
         REPGRAD(1:3)=2*INTCONSTRAINTDEL*((DUMMY/CONCUT)**2-1.0D0)*DUMMY*G2INT(1:3)
         DUMMY=INTCONSTRAINTDEL*(DUMMY**2-CONCUT**2)**2/(2.0D0*CONCUT**2)
         ECON=ECON+DUMMY
         IF (J1.EQ.2) THEN
            EEE(J1)=EEE(J1)+DUMMY
            CONEINT(J1)=CONEINT(J1)+DUMMY
            NCONINT(J1)=NCONINT(J1)+1
         ELSE IF (J1.LT.INTIMAGE+2) THEN
            EEE(J1)=EEE(J1)+DUMMY/2.0D0
            EEE(J1-1)=EEE(J1-1)+DUMMY/2.0D0
            CONEINT(J1)=CONEINT(J1)+DUMMY/2.0D0
            CONEINT(J1-1)=CONEINT(J1-1)+DUMMY/2.0D0
            NCONINT(J1)=NCONINT(J1)+1
            NCONINT(J1-1)=NCONINT(J1-1)+1
         ELSE IF (J1.EQ.INTIMAGE+2) THEN
            EEE(J1-1)=EEE(J1-1)+DUMMY
            CONEINT(J1-1)=CONEINT(J1-1)+DUMMY
            NCONINT(J1-1)=NCONINT(J1-1)+1
         ENDIF
!        PRINT '(A,4I6,G15.5)','IN2 J1,J2,CONI,CONJ,REPGRAD=',J1,J2,CONI(J2),CONJ(J2), &
! &                              SQRT(REPGRAD(1)**2+REPGRAD(2)**2+REPGRAD(3)**2)
         GGG(NI2+1:NI2+3)=GGG(NI2+1:NI2+3)+REPGRAD(1:3)
         GGG(NJ2+1:NJ2+3)=GGG(NJ2+1:NJ2+3)-REPGRAD(1:3)
      ENDIF
   ENDDO
ENDDO

! INTCONST=INTCONSTRAINREPCUT**13

DO J2=1,NNREPULSIVE
!  INTCONST=NREPCUT(J2)**13
   INTCONST=NREPCUT(J2)**3
   DO J1=2,INTIMAGE+2
      IF (FREEZENODEST) THEN
         IF (J1.EQ.2) THEN
            IF (IMGFREEZE(1)) CYCLE
         ELSE IF (J1.EQ.INTIMAGE+2) THEN
            IF (IMGFREEZE(INTIMAGE)) CYCLE
         ELSE
            IF (IMGFREEZE(J1-2).AND.IMGFREEZE(J1-1)) CYCLE
         ENDIF
      ENDIF
      NI1=NOPT*(J1-2)+3*(NREPI(J2)-1)
      NI2=NOPT*(J1-1)+3*(NREPI(J2)-1)
      NJ1=NOPT*(J1-2)+3*(NREPJ(J2)-1)
      NJ2=NOPT*(J1-1)+3*(NREPJ(J2)-1)
      R1AX=XYZ(NI1+1); R1AY=XYZ(NI1+2); R1AZ=XYZ(NI1+3)
      R1BX=XYZ(NJ1+1); R1BY=XYZ(NJ1+2); R1BZ=XYZ(NJ1+3)
      R2AX=XYZ(NI2+1); R2AY=XYZ(NI2+2); R2AZ=XYZ(NI2+3)
      R2BX=XYZ(NJ2+1); R2BY=XYZ(NJ2+2); R2BZ=XYZ(NJ2+3)
      CALL MINMAXD2R(R1AX,R1AY,R1AZ,R2AX,R2AY,R2AZ,R1BX,R1BY,R1BZ,R2BX,R2BY,R2BZ, &
  &                 D2,D1,DINT,DSQ2,DSQ1,DSQI,G1,G2,G1INT,G2INT,NOINT,.FALSE.,NREPCUT(J2))
!     IF ((NREPI(J2).EQ.135).AND.(NREPJ(J2).EQ.192)) THEN
!        PRINT '(A,3G20.10)',' CONGRAD2> R1AX,R1AY,R1AZ=',R1AX,R1AY,R1AZ
!        PRINT '(A,3G20.10)',' CONGRAD2> R1BX,R1BY,R1BZ=',R1BX,R1BY,R1BZ
!        PRINT '(A,3G20.10)',' CONGRAD2> R2AX,R2AY,R2AZ=',R2AX,R2AY,R2AZ
!        PRINT '(A,3G20.10)',' CONGRAD2> R2BX,R2BY,R2BZ=',R2BX,R2BY,R2BZ
!        PRINT '(A,I6,A,2I6)',' CONGRAD2> J1=',J1,' EDGE BETWEEN IMAGES: ',J1-1,J1
!        PRINT '(A,L5,3G20.10)',' CONGRAD2> NOINT,D2,D1,DINT=',NOINT,D2,D1,DINT
!     ENDIF
      DUMMY=0.0D0 
!
! SKIP IMAGE INTIMAGE+2 - NO NON-ZERO GRADIENTS ON OTHER IMAGES AND NO ENERGY CONTRIBUTIONS.
!
!     IF ((D2.LT.INTCONSTRAINREPCUT).AND.(J1.LT.INTIMAGE+2)) THEN ! TERMS FOR IMAGE J1 - NON-ZERO DERIVATIVES ONLY FOR J1
      IF ((D2.LT.NREPCUT(J2)).AND.(J1.LT.INTIMAGE+2)) THEN ! TERMS FOR IMAGE J1 - NON-ZERO DERIVATIVES ONLY FOR J1
!        D12=DSQ2**6
         D12=DSQ2
!        DUMMY=INTCONSTRAINTREP*(1.0D0/D12+(12.0D0*D2-13.0D0*INTCONSTRAINREPCUT)/INTCONST)
!        DUMMY=INTCONSTRAINTREP*(1.0D0/D12+(12.0D0*D2-13.0D0*NREPCUT(J2))/INTCONST)
         DUMMY=INTCONSTRAINTREP*(1.0D0/D12+(2.0D0*D2-3.0D0*NREPCUT(J2))/INTCONST)
         EEE(J1)=EEE(J1)+DUMMY
         REPE(J1)=REPE(J1)+DUMMY
         EREP=EREP+DUMMY
!        DUMMY=-12.0D0*INTCONSTRAINTREP*(1.0D0/(D2*D12)-1.0D0/INTCONST)
         DUMMY=-2.0D0*INTCONSTRAINTREP*(1.0D0/(D2*D12)-1.0D0/INTCONST)
         REPGRAD(1:3)=DUMMY*G2(1:3)
!        PRINT '(A,4I6,G15.5)','MIN J1,J2,REPI,REPJ,REPGRAD=',J1,J2,NREPI(J2),NREPJ(J2), &
! &                              SQRT(REPGRAD(1)**2+REPGRAD(2)**2+REPGRAD(3)**2)
         GGG(NI2+1:NI2+3)=GGG(NI2+1:NI2+3)+REPGRAD(1:3)
         GGG(NJ2+1:NJ2+3)=GGG(NJ2+1:NJ2+3)-REPGRAD(1:3)
      ENDIF
      DUMMY=0.0D0
!
! DON'T ADD ENERGY CONTRIBUTIONS TO EEE(2) FROM D1, SINCE THE GRADIENTS ARE NON-ZERO ONLY FOR IMAGE 1.
!
!     IF ((D1.LT.INTCONSTRAINREPCUT).AND.(J1.GT.2)) THEN ! TERMS FOR IMAGE J1-1 - NON-ZERO DERIVATIVES ONLY FOR J1-1
      IF ((D1.LT.NREPCUT(J2)).AND.(J1.GT.2)) THEN ! TERMS FOR IMAGE J1-1 - NON-ZERO DERIVATIVES ONLY FOR J1-1
!        D12=DSQ1**6
         D12=DSQ1
!        DUMMY=INTCONSTRAINTREP*(1.0D0/D12+(12.0D0*D1-13.0D0*INTCONSTRAINREPCUT)/INTCONST)
!        DUMMY=INTCONSTRAINTREP*(1.0D0/D12+(12.0D0*D1-13.0D0*NREPCUT(J2))/INTCONST)
         DUMMY=INTCONSTRAINTREP*(1.0D0/D12+(2.0D0*D1-3.0D0*NREPCUT(J2))/INTCONST)
         EEE(J1-1)=EEE(J1-1)+DUMMY
         REPE(J1-1)=REPE(J1-1)+DUMMY
         EREP=EREP+DUMMY
!        DUMMY=-12.0D0*INTCONSTRAINTREP*(1.0D0/(D1*D12)-1.0D0/INTCONST)
         DUMMY=-2.0D0*INTCONSTRAINTREP*(1.0D0/(D1*D12)-1.0D0/INTCONST)
         REPGRAD(1:3)=DUMMY*G1(1:3)
!        PRINT '(A,4I6,G15.5)','MAX J1,J2,REPI,REPJ,REPGRAD=',J1,J2,NREPI(J2),NREPJ(J2), &
! &                              SQRT(REPGRAD(1)**2+REPGRAD(2)**2+REPGRAD(3)**2)
         GGG(NI1+1:NI1+3)=GGG(NI1+1:NI1+3)+REPGRAD(1:3)
         GGG(NJ1+1:NJ1+3)=GGG(NJ1+1:NJ1+3)-REPGRAD(1:3)
      ENDIF
      DUMMY=0.0D0
!     IF ((.NOT.NOINT).AND.(DINT.LT.INTCONSTRAINREPCUT)) THEN
      IF ((.NOT.NOINT).AND.(DINT.LT.NREPCUT(J2))) THEN
!        D12=DSQI**6
         D12=DSQI
!        DUMMY=INTCONSTRAINTREP*(1.0D0/D12+(12.0D0*DINT-13.0D0*INTCONSTRAINREPCUT)/INTCONST)
!        DUMMY=INTCONSTRAINTREP*(1.0D0/D12+(12.0D0*DINT-13.0D0*NREPCUT(J2))/INTCONST)
         DUMMY=INTCONSTRAINTREP*(1.0D0/D12+(2.0D0*DINT-3.0D0*NREPCUT(J2))/INTCONST)
         EREP=EREP+DUMMY
!        IF (DUMMY.GT.1.0D7) PRINT '(A,3I6,3G20.10)','J2,NREPI(J2),NREPJ(J2),DINT,NREPCUT(J2),DUMMY=', &
! &                                                   J2,NREPI(J2),NREPJ(J2),DINT,NREPCUT(J2),DUMMY
!        IF (((NREPI(J2).EQ.143).AND.(NREPJ(J2).EQ.191)).OR.  &
! &          ((NREPJ(J2).EQ.143).AND.(NREPI(J2).EQ.191))) THEN
!            PRINT '(A,3I6,3G20.10)','J2,NREPI(J2),NREPJ(J2),DINT,NREPCUT(J2),DUMMY=', &
! &                                   J2,NREPI(J2),NREPJ(J2),DINT,NREPCUT(J2),DUMMY
!        ENDIF
         IF (J1.EQ.2) THEN
            EEE(J1)=EEE(J1)+DUMMY
            REPEINT(J1)=REPEINT(J1)+DUMMY
            NREPINT(J1)=NREPINT(J1)+1
         ELSE IF (J1.LT.INTIMAGE+2) THEN
            EEE(J1)=EEE(J1)+DUMMY/2.0D0
            EEE(J1-1)=EEE(J1-1)+DUMMY/2.0D0
            REPEINT(J1)=REPEINT(J1)+DUMMY/2.0D0
            REPEINT(J1-1)=REPEINT(J1-1)+DUMMY/2.0D0
            NREPINT(J1)=NREPINT(J1)+1
            NREPINT(J1-1)=NREPINT(J1-1)+1
         ELSE IF (J1.EQ.INTIMAGE+2) THEN
            EEE(J1-1)=EEE(J1-1)+DUMMY
            REPEINT(J1-1)=REPEINT(J1-1)+DUMMY
            NREPINT(J1-1)=NREPINT(J1-1)+1
         ENDIF
!        DUMMY=-12.0D0*INTCONSTRAINTREP*(1.0D0/(DINT*D12)-1.0D0/INTCONST)
         DUMMY=-2.0D0*INTCONSTRAINTREP*(1.0D0/(DINT*D12)-1.0D0/INTCONST)
         REPGRAD(1:3)=DUMMY*G1INT(1:3)
!        PRINT '(A,4I6,2G15.5)','IN1 J1,J2,REPI,REPJ,REPGRAD,NREPCUT=',J1,J2,NREPI(J2),NREPJ(J2), &
! &                              SQRT(REPGRAD(1)**2+REPGRAD(2)**2+REPGRAD(3)**2),NREPCUT(J2)
         GGG(NI1+1:NI1+3)=GGG(NI1+1:NI1+3)+REPGRAD(1:3)
         GGG(NJ1+1:NJ1+3)=GGG(NJ1+1:NJ1+3)-REPGRAD(1:3)
         REPGRAD(1:3)=DUMMY*G2INT(1:3)
!        PRINT '(A,4I6,2G15.5)','IN1 J1,J2,REPI,REPJ,REPGRAD,NREPCUT=',J1,J2,NREPI(J2),NREPJ(J2), &
! &                              SQRT(REPGRAD(1)**2+REPGRAD(2)**2+REPGRAD(3)**2),NREPCUT(J2)
         GGG(NI2+1:NI2+3)=GGG(NI2+1:NI2+3)+REPGRAD(1:3)
         GGG(NJ2+1:NJ2+3)=GGG(NJ2+1:NJ2+3)-REPGRAD(1:3)
      ENDIF
   ENDDO
ENDDO

!
! SET GRADIENTS ON FROZEN ATOMS TO ZERO.
!
IF (FREEZE) THEN
   DO J1=2,INTIMAGE+1  
      DO J2=1,NATOMS
         IF (FROZEN(J2)) THEN
            GGG(NOPT*(J1-1)+3*(J2-1)+1)=0.0D0
            GGG(NOPT*(J1-1)+3*(J2-1)+2)=0.0D0
            GGG(NOPT*(J1-1)+3*(J2-1)+3)=0.0D0
         ENDIF
      ENDDO
   ENDDO
ENDIF
!
! SET GRADIENTS TO ZERO FOR START AND FINISH IMAGES.
!
IF (INTIMAGE.GT.0) THEN
   GGG(1:NOPT)=0.0D0
   GGG((INTIMAGE+1)*NOPT+1:(INTIMAGE+2)*NOPT)=0.0D0
ENDIF
RMS=0.0D0
RMSIMAGE(1:INTIMAGE+2)=0.0D0
DO J1=2,INTIMAGE+1
   DO J2=1,NOPT
      RMSIMAGE(J1)=RMSIMAGE(J1)+GGG(NOPT*(J1-1)+J2)**2
   ENDDO
   RMS=RMS+RMSIMAGE(J1)
   IF (LPRINT) PRINT '(A,I6,2G20.10,L5)',' CONGRAD2> J1,EEE,RMSIMAGE,FREEZE=', &
  &                                                  J1,EEE(J1),RMSIMAGE(J1),IMGFREEZE(J1)
ENDDO
IF (INTIMAGE.NE.0) THEN
   RMS=SQRT(RMS/(NOPT*INTIMAGE))
ENDIF
!
! FOR INTIMAGE IMAGES THERE ARE INTIMAGE+2 REPLICAS INCLUDING THE END POINTS,
! AND INTIMAGE+1 LINE SEGEMENTS, WITH ASSOCIATED ENERGIES STORED IN EEE(2:INTIMAGE+2)
!
ETOTAL=0.0D0
MAXINT=-1.0D100
MININT=1.0D100
DO J1=2,INTIMAGE+1
   ETOTAL=ETOTAL+EEE(J1)
!  IF (DEBUG) PRINT '(A,I6,A,4G15.5)',' CONGRAD2> CON/REP AND CON/REP INT IMAGE ', &
! &      J1,' ',CONE(J1),REPE(J1),CONEINT(J1),REPEINT(J1)
   IF (CONEINT(J1)+REPEINT(J1).LT.MININT) THEN
      MININT=CONEINT(J1)+REPEINT(J1)
      NMININT=J1
   ENDIF
   IF (CONEINT(J1)+REPEINT(J1).GT.MAXINT) THEN
      MAXINT=CONEINT(J1)+REPEINT(J1)
      NMAXINT=J1
   ENDIF
ENDDO
! IF (DEBUG) PRINT '(A,G20.10,A,2I6)',' CONGRAD2> LARGEST  INTERNAL ENERGY=',MAXINT,' FOR IMAGE ',NMAXINT
! IF (DEBUG) PRINT '(A,G20.10,A,2I6)',' CONGRAD2> SMALLEST INTERNAL ENERGY=',MININT,' FOR IMAGE ',NMININT
IF (INTIMAGE.EQ.0) ETOTAL=EEE(1)+EEE(2)

END SUBROUTINE CONGRAD2

SUBROUTINE INTMINONLY(R1AX,R1AY,R1AZ,R2AX,R2AY,R2AZ,R1BX,R1BY,R1BZ,R2BX,R2BY,R2BZ,DINT,NOINT)
IMPLICIT NONE
DOUBLE PRECISION R1AX,R1AY,R1AZ,R2AX,R2AY,R2AZ,R1BX,R1BY,R1BZ,R2BX,R2BY,R2BZ,DINT,DUMMY
DOUBLE PRECISION DSQI, R1APR2BMR2AMR1BSQ, R1AMR1BSQ, R2AMR2BSQ, R1AMR1BDR2AMR2B, R1AMR1BDR2AMR2BSQ
LOGICAL NOINT
!
! IS THERE AN INTERNAL EXTREMUM?
!
! PRINT '(A,4G20.10)','R1AX,R1BX,R2AX,R2BX=',R1AX,R1BX,R2AX,R2BX
! PRINT '(A,G20.10)','(R1AX-R1BX-R2AX+R2BX)**2=',(R1AX-R1BX-R2AX+R2BX)**2
! PRINT '(A,4G20.10)','R1AY,R1BY,R2AY,R2BY=',R1AY,R1BY,R2AY,R2BY
! PRINT '(A,G20.10)','(R1AY-R1BY-R2AY+R2BY)**2=',(R1AY-R1BY-R2AY+R2BY)**2
! PRINT '(A,4G20.10)','R1AZ,R1BZ,R2AZ,R2BZ=',R1AZ,R1BZ,R2AZ,R2BZ
! PRINT '(A,G20.10)','(R1AZ-R1BZ-R2AZ+R2BZ)**2=',(R1AZ-R1BZ-R2AZ+R2BZ)**2
R1APR2BMR2AMR1BSQ=(R1AX-R1BX-R2AX+R2BX)**2+(R1AY-R1BY-R2AY+R2BY)**2+(R1AZ-R1BZ-R2AZ+R2BZ)**2
NOINT=.TRUE.
DINT=1.0D100
IF (R1APR2BMR2AMR1BSQ.EQ.0.0D0) THEN
   RETURN ! JUST TO SKIP THE INTERNAL SOLUTION
ELSE
   DUMMY=((R1AX-R1BX)*(R1AX-R1BX-R2AX+R2BX)+ &
 &      (R1AY-R1BY)*(R1AY-R1BY-R2AY+R2BY)+(R1AZ-R1BZ)*(R1AZ-R1BZ-R2AZ+R2BZ))/R1APR2BMR2AMR1BSQ
ENDIF
IF ((DUMMY.GT.0.0D0).AND.(DUMMY.LT.1.0D0)) NOINT=.FALSE.
IF (.NOT.NOINT) THEN
   R1AMR1BDR2AMR2B=(R1AX-R1BX)*(R2AX-R2BX)+(R1AY-R1BY)*(R2AY-R2BY)+(R1AZ-R1BZ)*(R2AZ-R2BZ)
   R1AMR1BDR2AMR2BSQ=R1AMR1BDR2AMR2B**2
   R1AMR1BSQ=(R1AX - R1BX)**2 + (R1AY - R1BY)**2 + (R1AZ - R1BZ)**2
   R2AMR2BSQ=(R2AX - R2BX)**2 + (R2AY - R2BY)**2 + (R2AZ - R2BZ)**2
   DSQI=MAX((-R1AMR1BDR2AMR2BSQ + R1AMR1BSQ*R2AMR2BSQ)/R1APR2BMR2AMR1BSQ,0.0D0)
   DINT=SQRT(DSQI)
ENDIF

RETURN

END SUBROUTINE INTMINONLY
