C SUBROUTINE TO COMBINE GETKD,GETNNZ AND GETNINT
C KD IS WIDTH OF SPARSE BAND IN G MATRIX
C NEEDED TO DIMENSION STORAGE ARRAYS GCS AND GCS2
C NNZ IS NUMBER OF NON-ZERO ELEMENTS IN B-MATRIX
C NINTB IS NUMBER OF INTERNAL COORDINATES INCLUDING BOND LENGTHS (THEREFORE /= NINTS!!!)
C (CHANGED FROM NINT AS THIS IS AN INTRINSIC FORTRAN FUNCTION!!)

      SUBROUTINE GETSTUFF(KD,NNZ,NINTB)
      USE MODUNRES
      IMPLICIT NONE

      INTEGER KD,NINTB,NNZ
C
C JMC WANT DIFFERENCE BETWEEN TWO ATOM NUMBERS OF DIHEDRAL ANGLE.
C IN UNRES, C CONTAINS ALL THE CALPHA COORDS THAN ALL THE SIDE CHAIN CENTROID COORDS
C MAIN CHAIN DIHEDRALS WILL ALWAYS HAVE DIFF OF 3 (4-1,ETC) BUT SIDE CHAIN DIHEDRALS 
C WILL NOT BE SO STRAIGHTFORWARD.
C SC DIHEDRAL IS DEFINED AS ROTATION OF THE SIDE CHAIN CENTROID ABOUT THE BISECTOR OF THE 
C ANGLE DEFINED BY CA(I-1), CA(I) AND CA(I+1)
C BUT COORDS CONTAINS CA, SC, CA, SC ETC...
C SO MAX DIFF WILL BE FOR MAIN CHAIN DIHEDRAL ANGLES: DIFF = 6 (FROM 7-1)
 
      KD=3*6+2
C
C GRADIENT AND VARIABLE INTERNAL COORDINATE ARRAYS DO NOT CONTAIN ENTRIES FOR NON-CAPPING GLYCINE
C SIDE CHAINS, SO USE NSIDE NOT NRES-2.
C NOTE THIS IS ONLY TRUE IF USE GLY CAPS (AC AND NHME) NOT NH3+ AND COO- (AS THE LATTER DON'T HAVE 
C SIDE CHAINS OR EVEN CALPHAS, WHEREAS THE FORMER DO.
      NINTB=NPHI+NTHETA+3*NSIDE+NRES-1
C
C 3*NUMBER OF ATOMS IN EACH TYPE OF INT. COOR.
C 12 EACH FOR ALPHA AND 'OMEGA' (AKA BETA) - THE SIDE CHAIN POLAR ANGLE AND DIHEDRAL ANGLE.
      NNZ=6*(NRES-1)+6*NSIDE+9*NTHETA+12*NPHI+24*NSIDE
C AGAIN NOT TRUE IF 'D' CAPS USED.
C
      RETURN
      END

C SUBROUTINE TO CALCULATE B-MATRIX
C CALCULATION OF INTERNAL COORDINATES COPIED FROM EINTERN.SRC <- CHARMM ONLY
C NEW NOW ALSO CALCULATES UPPER TRIANGLE OF SYMMETRIC G-MATRIX BEETBEE ON THE FLY
C STORED IN SPARSE FORMAT GCS AS REQUIRED FOR DBPTRF ROUTINE
C
C PROBLEM IS THAT SOME OF THE COORDS (FOR GLYCINE SIDE CHAINS) DON'T ACTUALLY HAVE 
C INTERNALS ASSOCIATED WITH THEM IN MYLBFGS.  BOND LENGTHS HAVE BEEN ADDED TO DQ IN TRANSBACK.
C 1. COULD HAVE NEW COORDS ARRAY, EXCLUDING THE GLY SIDE CHAIN COORDS.
C BUT, HAVING COORDS FOR CALPHA THEN SIDE CHAIN FOR ALL RESIDUES IN THE CHAIN MAKES THE 
C NUMBERING EASIER...
C SO, COORDS PASSED TO HERE STILL CONTAINS ZEROES FOR GLYCINE SIDE CHAINS.
C      SUBROUTINE GETBEE(COORDS,VAL,INDX,JNDX,NINT,NCART,NNZ,GCS,NOCOOR,KD)
      SUBROUTINE UNRSGETBEE(BEEMATRIX,COORDS,VAL,INDX,JNDX,NINTB,NCART,NNZ,GCS,NOCOOR,KD,INTCOORDS)
      USE MODUNRES
      IMPLICIT NONE
C
C NNZ IS NUMBER OF NON-ZERO ELEMENTS IN B-MATRIX
C NINTB IS NUMBER OF INTERNAL COORDINATES
C NCART IS NUMBER OF CARTESIANS (EXCLUDING GLYCINE SIDE CHAINS [INCLUDING CAPS])
C
      INTEGER NNZ,NINTB,NCART
C
C JMC      REAL*8 COORDS(6*NATOMS)
      REAL*8 COORDS(NCART)
      REAL*8 X(NCART),Y(NCART),Z(NCART) ! JMC NOTE THAT NCART=3*NATOMS...
      REAL*8 VAL(NNZ),GCS(2*KD+1,NCART)
      INTEGER INDX(NNZ),JNDX(NNZ)
      REAL*8 RX,RY,RZ,S2,S,SR,RXSR,RYSR,RZSR
      REAL*8 DXI,DYI,DZI,DXJ,DYJ,DZJ,RI2,RJ2,RIR,RJR,RI,RJ
      REAL*8 DXIR,DYIR,DZIR,DXJR,DYJR,DZJR,CST,ISNT
      REAL*8 FX,FY,FZ,GX,GY,GZ,HX,HY,HZ,AX,AY,AZ,BX,BY,BZ
      REAL*8 RF2,RG2,RH2,RF,RG,RH,RFR,RGR,RHR,RA2,RB2,RA2R,RB2R,RABR,CP
      REAL*8 CSTTWO,SNTTWO2,SNTTWO2R,CSTTHREE,SNTTHREE2,SNTTHREE2R,DUMMY,DUMMY2,DUMMY3
      REAL*8 VXI,VYI,VZI,VXJ,VYJ,VZJ,VXK,VYK,VZK,VXL,VYL,VZL
      INTEGER MM,ITH,IPHI,I,J,K,L,IC,I1,SUMPHI,DIFF,ATOMWIDTH
      INTEGER MMM,ITHH,IPHII,II,JJ,KK,LL,IIKD,JJKD,KKKD,LLKD,KD1,KD
      INTEGER II1,JJ1,KK1,LL1,IIKD1,JJKD1,KKKD1,LLKD1
      INTEGER II2,JJ2,KK2,LL2,IIKD2,JJKD2,KKKD2,LLKD2
      LOGICAL NOCOOR
      INTEGER J1,IPASS

      REAL*8 SCALAR,TX,TY,TZ

      REAL*8 BEEMATRIX(NINTB,NCART),INTCOORDS(NINTB)
C
C PUT CARTESIANS IN COORDS IN ANGSTROMS INTO X,Y,Z IN METRES
C
      DO I1=1,NRES
        X(2*I1-1)=COORDS(6*(I1-1)+1)*1.0D-10
        Y(2*I1-1)=COORDS(6*(I1-1)+2)*1.0D-10
        Z(2*I1-1)=COORDS(6*(I1-1)+3)*1.0D-10
        X(2*I1)=COORDS(6*(I1-1)+4)*1.0D-10
        Y(2*I1)=COORDS(6*(I1-1)+5)*1.0D-10
        Z(2*I1)=COORDS(6*(I1-1)+6)*1.0D-10
      ENDDO
 
C IPASS IS A COUNTER FOR THE NUMBER OF TIMES THE ALPHA AND BETA LOOPS ARE PASSED (TO ACCOUNT FOR WHEN 
C THE LOOP IS SKIPPED DUE TO NO SIDE CHAIN ANGLE BEING PRESENT.
      IPASS=0
C
C SET ATOMWIDTH TO 10 FOR SPARSE STORAGE; KD1 IS DIMENSION OF GCS SPARSE GC MATRIX
C THAT WE NEED TO CALL DBPTRF IN TRANSFORM
C IN FACT USING MATRIX DOUBLE THIS SIZE SO CAN CALCULATE UPPER AND LOWER TRIANGLE SEPARATELY
C WILL COMBINE THE TWO AT THE END
C     ATOMWIDTH=6
C     KD=3*ATOMWIDTH+2
      KD1=KD+1
C 
C ZERO GCS HERE
C
      DO J1=1,NINTB
        DO I1=1,NCART
           BEEMATRIX(J1,I1)=0.0D0
        END DO
      END DO

       DO J1=1,KD
         DO I1=1,J1
           GCS(KD+1+I1-J1,J1)=0.0D0
           GCS(KD+1+J1-I1,I1)=0.0D0
         ENDDO
       ENDDO
       DO J1=KD+1,NCART
         DO I1=J1-KD,J1
           GCS(KD+1+I1-J1,J1)=0.0D0
           GCS(KD+1+J1-I1,I1)=0.0D0
         ENDDO
       ENDDO
C
C THE FOLLOWING LOOPS WILL PUT INTERNALS IN COORDS AND PASS THEM BACK
C IF THE FLAG NOCOOR IS FALSE
C
C MAIN CHAIN DIHEDRALS
      DO 10 IPHI=1,NPHI
        I=2*IPHI-1
        J=I+2
        K=I+4
        L=I+6
        II=3*(I-1)+1
        II1=3*(I-1)+2
        II2=3*(I-1)+3
        JJ=3*(J-1)+1
        JJ1=3*(J-1)+2
        JJ2=3*(J-1)+3
        KK=3*(K-1)+1
        KK1=3*(K-1)+2
        KK2=3*(K-1)+3
        LL=3*(L-1)+1
        LL1=3*(L-1)+2
        LL2=3*(L-1)+3
C      PRINT *,'PDIHE I J K L',I,J,K,L
C       IC=ICP(IPHI)
C F=RI-RJ, G=RJ-RK, H-RL-RK.
        FX=X(I)-X(J)
        FY=Y(I)-Y(J)
        FZ=Z(I)-Z(J)
        GX=X(J)-X(K)
        GY=Y(J)-Y(K)
        GZ=Z(J)-Z(K)
        HX=X(L)-X(K)
        HY=Y(L)-Y(K)
        HZ=Z(L)-Z(K)
C A=F^G, B=H^G
        AX=FY*GZ-FZ*GY
        AY=FZ*GX-FX*GZ
        AZ=FX*GY-FY*GX
        BX=HY*GZ-HZ*GY
        BY=HZ*GX-HX*GZ
        BZ=HX*GY-HY*GX
C RG=|G|, RGR=1/|G|
        RG2=GX*GX+GY*GY+GZ*GZ
        RG=SQRT(RG2)
        RGR=1/RG
C DAE FOR USE IN EVALUATING B-MATRIX
        RF2=FX*FX+FY*FY+FZ*FZ
        RF=SQRT(RF2)
        RFR=1/RF
        RH2=HX*HX+HY*HY+HZ*HZ
        RH=SQRT(RH2)
        RHR=1/RH
C JMC        CSTTWO=(FX*GX+FY*GY+FZ*GZ)*RFR*RGR
        CSTTWO=-(FX*GX+FY*GY+FZ*GZ)*RFR*RGR
        SNTTWO2=1-CSTTWO*CSTTWO
        SNTTWO2R=1/SNTTWO2
        CSTTHREE=(HX*GX+HY*GY+HZ*GZ)*RHR*RGR
        SNTTHREE2=1-CSTTHREE*CSTTHREE
        SNTTHREE2R=1/SNTTHREE2
        IPHII=12*(IPHI-1)+1
C
        IF (.NOT.NOCOOR) THEN
          RA2=AX*AX+AY*AY+AZ*AZ
          RB2=BX*BX+BY*BY+BZ*BZ
          RA2R=1/RA2
          RB2R=1/RB2
          RABR=SQRT(RA2R*RB2R)
C CP=COS(PHI)
          CP=(AX*BX+AY*BY+AZ*BZ)*RABR
          INTCOORDS(IPHI)=ACOS(CP)
          IF (CP.GT.1.0D0) INTCOORDS(IPHI)=0.0D0
          IF (CP.LT.-1.0D0) INTCOORDS(IPHI)=3.141592653589793D0
C JMC 
C TEST TO DETERMINE WHETHER THE DIHEDRAL ANGLE SHOULD BE > 0 OR < 0, FROM UNRES (INTCOR.F) 
C > 0 IF CW ROTATION FROM 2-> 1 TO 3-> 4.
C ?? DOES THIS AFFECT THE B-MATRIX ELEMENTS ??
          TX=AY*BZ-BY*AZ
          TY=-AX*BZ+BX*AZ
          TZ=AX*BY-BX*AY
          SCALAR=TX*GX+TY*GY+TZ*GZ
C         PRINT *,'SCALAR ',SCALAR
          IF (SCALAR.GT.0.0D0) INTCOORDS(IPHI)=-INTCOORDS(IPHI)
C         PRINT *,'COORDS = ',INTCOORDS(IPHI)
        ENDIF
C DAE CALCULATE B-MATRIX ELEMENTS
        DUMMY=RFR*RFR*RGR*SNTTWO2R
        VAL(IPHII)=-AX*DUMMY
        INDX(IPHII)=IPHI
        JNDX(IPHII)=II
        BEEMATRIX(IPHI,II)=-AX*DUMMY
C
        VAL(IPHII+1)=-AY*DUMMY
        INDX(IPHII+1)=IPHI
        JNDX(IPHII+1)=II+1
        BEEMATRIX(IPHI,II1)=-AY*DUMMY
C
        VAL(IPHII+2)=-AZ*DUMMY
        INDX(IPHII+2)=IPHI
        JNDX(IPHII+2)=II+2
        BEEMATRIX(IPHI,II2)=-AZ*DUMMY

        DUMMY=RFR*RFR*RGR*RGR*SNTTWO2R*(RG-RF*CSTTWO)
        DUMMY2=RHR*RGR*RGR*SNTTHREE2R*CSTTHREE
C
        VAL(IPHII+3)=AX*DUMMY-BX*DUMMY2
        INDX(IPHII+3)=IPHI
        JNDX(IPHII+3)=JJ
        BEEMATRIX(IPHI,JJ)=AX*DUMMY-BX*DUMMY2
C
        VAL(IPHII+4)=AY*DUMMY-BY*DUMMY2
        INDX(IPHII+4)=IPHI
        JNDX(IPHII+4)=JJ+1
        BEEMATRIX(IPHI,JJ1)=AY*DUMMY-BY*DUMMY2
C
        VAL(IPHII+5)=AZ*DUMMY-BZ*DUMMY2
        INDX(IPHII+5)=IPHI
        JNDX(IPHII+5)=JJ+2
        BEEMATRIX(IPHI,JJ2)=AZ*DUMMY-BZ*DUMMY2
C
        DUMMY=RHR*RHR*RGR*RGR*SNTTHREE2R*(RG-RH*CSTTHREE)
        DUMMY2=RFR*RGR*RGR*SNTTWO2R*CSTTWO
        VAL(IPHII+6)=-BX*DUMMY+AX*DUMMY2
        INDX(IPHII+6)=IPHI
        JNDX(IPHII+6)=KK
        BEEMATRIX(IPHI,KK)=-BX*DUMMY+AX*DUMMY2
C
        VAL(IPHII+7)=-BY*DUMMY+AY*DUMMY2
        INDX(IPHII+7)=IPHI
        JNDX(IPHII+7)=KK+1
        BEEMATRIX(IPHI,KK1)=-BY*DUMMY+AY*DUMMY2
C
        VAL(IPHII+8)=-BZ*DUMMY+AZ*DUMMY2
        INDX(IPHII+8)=IPHI
        JNDX(IPHII+8)=KK+2
        BEEMATRIX(IPHI,KK2)=-BZ*DUMMY+AZ*DUMMY2
C
        DUMMY=RHR*RHR*RGR*SNTTHREE2R
        VAL(IPHII+9)=BX*DUMMY
        INDX(IPHII+9)=IPHI
        JNDX(IPHII+9)=LL
        BEEMATRIX(IPHI,LL)=BX*DUMMY
C
        VAL(IPHII+10)=BY*DUMMY
        INDX(IPHII+10)=IPHI
        JNDX(IPHII+10)=LL+1
        BEEMATRIX(IPHI,LL1)=BY*DUMMY
C
        VAL(IPHII+11)=BZ*DUMMY
        INDX(IPHII+11)=IPHI
        JNDX(IPHII+11)=LL+2
        BEEMATRIX(IPHI,LL2)=BZ*DUMMY
C
C CALCULATE GEE FOR THIS IC
        IIKD=II+KD1
        IIKD1=II1+KD1
        IIKD2=II2+KD1
        JJKD=JJ+KD1
        JJKD1=JJ1+KD1
        JJKD2=JJ2+KD1
        KKKD=KK+KD1
        KKKD1=KK1+KD1
        KKKD2=KK2+KD1
        LLKD=LL+KD1
        LLKD1=LL1+KD1
        LLKD2=LL2+KD1
C
        VXI=VAL(IPHII)
        VYI=VAL(IPHII+1)
        VZI=VAL(IPHII+2)
        GCS(KD1,II)=GCS(KD1,II)+VXI**2
        GCS(KD1+II-II1,II1)=GCS(KD1+II-II1,II1)+VXI*VYI
        GCS(KD1+II-II2,II2)=GCS(KD1+II-II2,II2)+VXI*VZI
        GCS(KD1,II1)=GCS(KD1,II1)+VYI**2
        GCS(KD1+II1-II2,II2)=GCS(KD1+II1-II2,II2)+VYI*VZI
        GCS(KD1,II2)=GCS(KD1,II2)+VZI**2
C
        VXJ=VAL(IPHII+3)
        VYJ=VAL(IPHII+4)
        VZJ=VAL(IPHII+5)
        GCS(KD1,JJ)=GCS(KD1,JJ)+VXJ**2
        GCS(KD1+JJ-JJ1,JJ1)=GCS(KD1+II-II1,JJ1)+VXJ*VYJ
        GCS(KD1+JJ-JJ2,JJ2)=GCS(KD1+II-II2,JJ2)+VXJ*VZJ
        GCS(KD1,JJ1)=GCS(KD1,JJ1)+VYJ**2
        GCS(KD1+JJ1-JJ2,JJ2)=GCS(KD1+JJ1-JJ2,JJ2)+VYJ*VZJ
        GCS(KD1,JJ2)=GCS(KD1,JJ2)+VZJ**2
C
        VXK=VAL(IPHII+6)
        VYK=VAL(IPHII+7)
        VZK=VAL(IPHII+8)
        GCS(KD1,KK)=GCS(KD1,KK)+VXK**2
        GCS(KD1+KK-KK1,KK1)=GCS(KD1+KK-KK1,KK1)+VXK*VYK
        GCS(KD1+KK-KK2,KK2)=GCS(KD1+KK-KK2,KK2)+VXK*VZK
        GCS(KD1,KK1)=GCS(KD1,KK1)+VYK**2
        GCS(KD1+KK1-KK2,KK2)=GCS(KD1+KK1-KK2,KK2)+VYK*VZK
        GCS(KD1,KK2)=GCS(KD1,KK2)+VZK**2
C
        VXL=VAL(IPHII+9)
        VYL=VAL(IPHII+10)
        VZL=VAL(IPHII+11)
        GCS(KD1,LL)=GCS(KD1,LL)+VXL**2
        GCS(KD1+LL-LL1,LL1)=GCS(KD1+LL-LL1,LL1)+VXL*VYL
        GCS(KD1+LL-LL2,LL2)=GCS(KD1+LL-LL2,LL2)+VXL*VZL
        GCS(KD1,LL1)=GCS(KD1,LL1)+VYL**2
        GCS(KD1+LL1-LL2,LL2)=GCS(KD1+LL1-LL2,LL2)+VYL*VZL
        GCS(KD1,LL2)=GCS(KD1,LL2)+VZL**2
C
        IIKD=II+KD1
        IIKD1=II1+KD1
        IIKD2=II2+KD1
        JJKD=JJ+KD1
        JJKD1=JJ1+KD1
        JJKD2=JJ2+KD1
        KKKD=KK+KD1
        KKKD1=KK1+KD1
        KKKD2=KK2+KD1
        LLKD=LL+KD1
        LLKD1=LL1+KD1
        LLKD2=LL2+KD1
C
C       IF (II.LT.JJ) THEN
        GCS(IIKD-JJ,JJ)=GCS(IIKD-JJ,JJ)+VXI*VXJ
        GCS(IIKD-JJ1,JJ1)=GCS(IIKD-JJ1,JJ1)+VXI*VYJ
        GCS(IIKD-JJ2,JJ2)=GCS(IIKD-JJ2,JJ2)+VXI*VZJ
        GCS(IIKD1-JJ,JJ)=GCS(IIKD1-JJ,JJ)+VYI*VXJ
        GCS(IIKD1-JJ1,JJ1)=GCS(IIKD1-JJ1,JJ1)+VYI*VYJ
        GCS(IIKD1-JJ2,JJ2)=GCS(IIKD1-JJ2,JJ2)+VYI*VZJ
        GCS(IIKD2-JJ,JJ)=GCS(IIKD2-JJ,JJ)+VZI*VXJ
        GCS(IIKD2-JJ1,JJ1)=GCS(IIKD2-JJ1,JJ1)+VZI*VYJ
        GCS(IIKD2-JJ2,JJ2)=GCS(IIKD2-JJ2,JJ2)+VZI*VZJ
C       ELSE
C       GCS(JJKD-II,II)=GCS(IIKD-JJ,JJ)
C       GCS(JJKD1-II,II)=GCS(IIKD-JJ1,JJ1)
C       GCS(JJKD2-II,II)=GCS(IIKD-JJ2,JJ2)
C       GCS(JJKD-II1,II1)=GCS(IIKD1-JJ,JJ)
C       GCS(JJKD1-II1,II1)=GCS(IIKD1-JJ1,JJ1)
C       GCS(JJKD2-II1,II1)=GCS(IIKD1-JJ2,JJ2)
C       GCS(JJKD-II2,II2)=GCS(IIKD2-JJ,JJ)
C       GCS(JJKD1-II2,II2)=GCS(IIKD2-JJ1,JJ1)
C       GCS(JJKD2-II2,II2)=GCS(IIKD2-JJ2,JJ2)
C       ENDIF
C
C       IF (II.LT.KK) THEN
        GCS(IIKD-KK,KK)=GCS(IIKD-KK,KK)+VXI*VXK
        GCS(IIKD-KK1,KK1)=GCS(IIKD-KK1,KK1)+VXI*VYK
        GCS(IIKD-KK2,KK2)=GCS(IIKD-KK2,KK2)+VXI*VZK
        GCS(IIKD1-KK,KK)=GCS(IIKD1-KK,KK)+VYI*VXK
        GCS(IIKD1-KK1,KK1)=GCS(IIKD1-KK1,KK1)+VYI*VYK
        GCS(IIKD1-KK2,KK2)=GCS(IIKD1-KK2,KK2)+VYI*VZK
        GCS(IIKD2-KK,KK)=GCS(IIKD2-KK,KK)+VZI*VXK
        GCS(IIKD2-KK1,KK1)=GCS(IIKD2-KK1,KK1)+VZI*VYK
        GCS(IIKD2-KK2,KK2)=GCS(IIKD2-KK2,KK2)+VZI*VZK
C       ELSE
C       GCS(KKKD-II,II)=GCS(IIKD-KK,KK)
C       GCS(KKKD1-II,II)=GCS(IIKD-KK1,KK1)
C       GCS(KKKD2-II,II)=GCS(IIKD-KK2,KK2)
C       GCS(KKKD-II1,II1)=GCS(IIKD1-KK,KK)
C       GCS(KKKD1-II1,II1)=GCS(IIKD1-KK1,KK1)
C       GCS(KKKD2-II1,II1)=GCS(IIKD1-KK2,KK2)
C       GCS(KKKD-II2,II2)=GCS(IIKD2-KK,KK)
C       GCS(KKKD1-II2,II2)=GCS(IIKD2-KK1,KK1)
C       GCS(KKKD2-II2,II2)=GCS(IIKD2-KK2,KK2)
C       ENDIF
C
C       IF (II.LT.LL) THEN
        GCS(IIKD-LL,LL)=GCS(IIKD-LL,LL)+VXI*VXL
        GCS(IIKD-LL1,LL1)=GCS(IIKD-LL1,LL1)+VXI*VYL
        GCS(IIKD-LL2,LL2)=GCS(IIKD-LL2,LL2)+VXI*VZL
        GCS(IIKD1-LL,LL)=GCS(IIKD1-LL,LL)+VYI*VXL
        GCS(IIKD1-LL1,LL1)=GCS(IIKD1-LL1,LL1)+VYI*VYL
        GCS(IIKD1-LL2,LL2)=GCS(IIKD1-LL2,LL2)+VYI*VZL
        GCS(IIKD2-LL,LL)=GCS(IIKD2-LL,LL)+VZI*VXL
        GCS(IIKD2-LL1,LL1)=GCS(IIKD2-LL1,LL1)+VZI*VYL
        GCS(IIKD2-LL2,LL2)=GCS(IIKD2-LL2,LL2)+VZI*VZL
C       ELSE
C       GCS(LLKD-II,II)=GCS(IIKD-LL,LL)
C       GCS(LLKD1-II,II)=GCS(IIKD-LL1,LL1)
C       GCS(LLKD2-II,II)=GCS(IIKD-LL2,LL2)
C       GCS(LLKD-II1,II1)=GCS(IIKD1-LL,LL)
C       GCS(LLKD1-II1,II1)=GCS(IIKD1-LL1,LL1)
C       GCS(LLKD2-II1,II1)=GCS(IIKD1-LL2,LL2)
C       GCS(LLKD-II2,II2)=GCS(IIKD2-LL,LL)
C       GCS(LLKD1-II2,II2)=GCS(IIKD2-LL1,LL1)
C       GCS(LLKD2-II2,II2)=GCS(IIKD2-LL2,LL2)
C       ENDIF
C
C       IF (JJ.LT.KK) THEN
        GCS(JJKD-KK,KK)=GCS(JJKD-KK,KK)+VXJ*VXK
        GCS(JJKD-KK1,KK1)=GCS(JJKD-KK1,KK1)+VXJ*VYK
        GCS(JJKD-KK2,KK2)=GCS(JJKD-KK2,KK2)+VXJ*VZK
        GCS(JJKD1-KK,KK)=GCS(JJKD1-KK,KK)+VYJ*VXK
        GCS(JJKD1-KK1,KK1)=GCS(JJKD1-KK1,KK1)+VYJ*VYK
        GCS(JJKD1-KK2,KK2)=GCS(JJKD1-KK2,KK2)+VYJ*VZK
        GCS(JJKD2-KK,KK)=GCS(JJKD2-KK,KK)+VZJ*VXK
        GCS(JJKD2-KK1,KK1)=GCS(JJKD2-KK1,KK1)+VZJ*VYK
        GCS(JJKD2-KK2,KK2)=GCS(JJKD2-KK2,KK2)+VZJ*VZK
C       ELSE
C       GCS(KKKD-JJ,JJ)=GCS(JJKD-KK,KK)+1000
C       GCS(KKKD1-JJ,JJ)=GCS(JJKD-KK1,KK1)+2000
C       GCS(KKKD2-JJ,JJ)=GCS(JJKD-KK2,KK2)+3000
C       GCS(KKKD-JJ1,JJ1)=GCS(JJKD1-KK,KK)+4000
C       GCS(KKKD1-JJ1,JJ1)=GCS(JJKD1-KK1,KK1)+5000
C       GCS(KKKD2-JJ1,JJ1)=GCS(JJKD1-KK2,KK2)+6000
C       GCS(KKKD-JJ2,JJ2)=GCS(JJKD2-KK,KK)
C       GCS(KKKD1-JJ2,JJ2)=GCS(JJKD2-KK1,KK1)+8000
C       GCS(KKKD2-JJ2,JJ2)=GCS(JJKD2-KK2,KK2)+9000
C       ENDIF
C
C       IF (JJ.LT.LL) THEN
        GCS(JJKD-LL,LL)=GCS(JJKD-LL,LL)+VXJ*VXL
        GCS(JJKD-LL1,LL1)=GCS(JJKD-LL1,LL1)+VXJ*VYL
        GCS(JJKD-LL2,LL2)=GCS(JJKD-LL2,LL2)+VXJ*VZL
        GCS(JJKD1-LL,LL)=GCS(JJKD1-LL,LL)+VYJ*VXL
        GCS(JJKD1-LL1,LL1)=GCS(JJKD1-LL1,LL1)+VYJ*VYL
        GCS(JJKD1-LL2,LL2)=GCS(JJKD1-LL2,LL2)+VYJ*VZL
        GCS(JJKD2-LL,LL)=GCS(JJKD2-LL,LL)+VZJ*VXL
        GCS(JJKD2-LL1,LL1)=GCS(JJKD2-LL1,LL1)+VZJ*VYL
        GCS(JJKD2-LL2,LL2)=GCS(JJKD2-LL2,LL2)+VZJ*VZL
C       ELSE
C       GCS(LLKD-JJ,JJ)=GCS(JJKD-LL,LL)
C       GCS(LLKD1-JJ,JJ)=GCS(JJKD-LL1,LL1)
C       GCS(LLKD2-JJ,JJ)=GCS(JJKD-LL2,LL2)
C       GCS(LLKD-JJ1,JJ1)=GCS(JJKD1-LL,LL)
C       GCS(LLKD1-JJ1,JJ1)=GCS(JJKD1-LL1,LL1)
C       GCS(LLKD2-JJ1,JJ1)=GCS(JJKD1-LL2,LL2)
C       GCS(LLKD-JJ2,JJ2)=GCS(JJKD2-LL,LL)
C       GCS(LLKD1-JJ2,JJ2)=GCS(JJKD2-LL1,LL1)
C       GCS(LLKD2-JJ2,JJ2)=GCS(JJKD2-LL2,LL2)
C       ENDIF
C
C       IF (KK.LT.LL) THEN
        GCS(KKKD-LL,LL)=GCS(KKKD-LL,LL)+VXK*VXL
        GCS(KKKD-LL1,LL1)=GCS(KKKD-LL1,LL1)+VXK*VYL
        GCS(KKKD-LL2,LL2)=GCS(KKKD-LL2,LL2)+VXK*VZL
        GCS(KKKD1-LL,LL)=GCS(KKKD1-LL,LL)+VYK*VXL
        GCS(KKKD1-LL1,LL1)=GCS(KKKD1-LL1,LL1)+VYK*VYL
        GCS(KKKD1-LL2,LL2)=GCS(KKKD1-LL2,LL2)+VYK*VZL
        GCS(KKKD2-LL,LL)=GCS(KKKD2-LL,LL)+VZK*VXL
        GCS(KKKD2-LL1,LL1)=GCS(KKKD2-LL1,LL1)+VZK*VYL
        GCS(KKKD2-LL2,LL2)=GCS(KKKD2-LL2,LL2)+VZK*VZL
C       ELSE
C       GCS(LLKD-KK,KK)=GCS(KKKD-LL,LL)
C       GCS(LLKD1-KK,KK)=GCS(KKKD-LL1,LL1)
C       GCS(LLKD2-KK,KK)=GCS(KKKD-LL2,LL2)
C       GCS(LLKD-KK1,KK1)=GCS(KKKD1-LL,LL)
C       GCS(LLKD1-KK1,KK1)=GCS(KKKD1-LL1,LL1)
C       GCS(LLKD2-KK1,KK1)=GCS(KKKD1-LL2,LL2)
C       GCS(LLKD-KK2,KK2)=GCS(KKKD2-LL,LL)
C       GCS(LLKD1-KK2,KK2)=GCS(KKKD2-LL1,LL1)
C       GCS(LLKD2-KK2,KK2)=GCS(KKKD2-LL2,LL2)
C       ENDIF
C
C END DAE
C
   10 CONTINUE
C      DO I1=1,NPHI
C        PRINT *,'PHI I J K L',IP(I1),JP(I1),KP(I1),LP(I1)
C      ENDDO

      DO 20 ITH=1,NTHETA
C
C THETA I IS ANGLE BETWEEN CAI, CAI+1 AND CAI+2
        I=2*ITH-1
        J=I+2
        K=I+4
        II=3*(I-1)+1
        II1=3*(I-1)+2
        II2=3*(I-1)+3
        JJ=3*(J-1)+1
        JJ1=3*(J-1)+2
        JJ2=3*(J-1)+3
        KK=3*(K-1)+1
        KK1=3*(K-1)+2
        KK2=3*(K-1)+3
C      PRINT *,'ANGLE I J K',I,J,K
C       IC=ICT(ITH)
C       IF(IC.EQ.0) GOTO 20
        DXI=X(I)-X(J)
        DYI=Y(I)-Y(J)
        DZI=Z(I)-Z(J)
        DXJ=X(K)-X(J)
        DYJ=Y(K)-Y(J)
        DZJ=Z(K)-Z(J)
        RI2=DXI*DXI+DYI*DYI+DZI*DZI
        RJ2=DXJ*DXJ+DYJ*DYJ+DZJ*DZJ
        RI=SQRT(RI2)
        RJ=SQRT(RJ2)
        RIR=1/RI
        RJR=1/RJ
        DXIR=DXI*RIR
        DYIR=DYI*RIR
        DZIR=DZI*RIR
        DXJR=DXJ*RJR
        DYJR=DYJ*RJR
        DZJR=DZJ*RJR
        CST=DXIR*DXJR+DYIR*DYJR+DZIR*DZJR
C
        IF (.NOT.NOCOOR) THEN
C DAE STORE THETA (IN RADIANS) IN COORDS
          INTCOORDS(NPHI+ITH)=ACOS(CST)
C         PRINT *,'COORDS = ',COORDS(NPHI+ITH)
        ENDIF
C DAE CALCULATE B-MATRIX ELEMENTS FOR THESE ATOMS (WILSON DECIUS + CROSS CH.4)
        ISNT=1/SQRT(1-CST*CST)
        ITHH=12*NPHI+9*(ITH-1)+1
        VAL(ITHH)=(DXIR*CST-DXJR)*RIR*ISNT
        INDX(ITHH)=NPHI+ITH
        JNDX(ITHH)=II
        BEEMATRIX(NPHI+ITH,II)=(DXIR*CST-DXJR)*RIR*ISNT
C
        VAL(ITHH+1)=(DYIR*CST-DYJR)*RIR*ISNT
        INDX(ITHH+1)=NPHI+ITH
        JNDX(ITHH+1)=II1
        BEEMATRIX(NPHI+ITH,II1)=(DYIR*CST-DYJR)*RIR*ISNT
C
        VAL(ITHH+2)=(DZIR*CST-DZJR)*RIR*ISNT
        INDX(ITHH+2)=NPHI+ITH
        JNDX(ITHH+2)=II2
        BEEMATRIX(NPHI+ITH,II2)=(DZIR*CST-DZJR)*RIR*ISNT
C
        VAL(ITHH+3)=(DXIR*(RI-RJ*CST)+DXJR*(RJ-RI*CST))*RIR*RJR*ISNT
        INDX(ITHH+3)=NPHI+ITH
        JNDX(ITHH+3)=JJ
        BEEMATRIX(NPHI+ITH,JJ)=(DXIR*(RI-RJ*CST)+DXJR*(RJ-RI*CST))*RIR*RJR*ISNT
C
        VAL(ITHH+4)=(DYIR*(RI-RJ*CST)+DYJR*(RJ-RI*CST))*RIR*RJR*ISNT
        INDX(ITHH+4)=NPHI+ITH
        JNDX(ITHH+4)=JJ1
        BEEMATRIX(NPHI+ITH,JJ1)=(DYIR*(RI-RJ*CST)+DYJR*(RJ-RI*CST))*RIR*RJR*ISNT
C
        VAL(ITHH+5)=(DZIR*(RI-RJ*CST)+DZJR*(RJ-RI*CST))*RIR*RJR*ISNT
        INDX(ITHH+5)=NPHI+ITH
        JNDX(ITHH+5)=JJ2
        BEEMATRIX(NPHI+ITH,JJ2)=(DZIR*(RI-RJ*CST)+DZJR*(RJ-RI*CST))*RIR*RJR*ISNT
C
        VAL(ITHH+6)=(DXJR*CST-DXIR)*RJR*ISNT
        INDX(ITHH+6)=NPHI+ITH
        JNDX(ITHH+6)=KK
        BEEMATRIX(NPHI+ITH,KK)=(DXJR*CST-DXIR)*RJR*ISNT
C
        VAL(ITHH+7)=(DYJR*CST-DYIR)*RJR*ISNT
        INDX(ITHH+7)=NPHI+ITH
        JNDX(ITHH+7)=KK1
        BEEMATRIX(NPHI+ITH,KK1)=(DYJR*CST-DYIR)*RJR*ISNT
C
        VAL(ITHH+8)=(DZJR*CST-DZIR)*RJR*ISNT
        INDX(ITHH+8)=NPHI+ITH
        JNDX(ITHH+8)=KK2
        BEEMATRIX(NPHI+ITH,KK2)=(DZJR*CST-DZIR)*RJR*ISNT
C
C CALCULATE GEE FOR THIS IC
        VXI=VAL(ITHH)
        VYI=VAL(ITHH+1)
        VZI=VAL(ITHH+2)
        GCS(KD1,II)=GCS(KD1,II)+VXI**2
        GCS(KD1+II-II1,II1)=GCS(KD1+II-II1,II1)+VXI*VYI
        GCS(KD1+II-II2,II2)=GCS(KD1+II-II2,II2)+VXI*VZI
        GCS(KD1,II1)=GCS(KD1,II1)+VYI**2
        GCS(KD1+II1-II2,II2)=GCS(KD1+II1-II2,II2)+VYI*VZI
        GCS(KD1,II2)=GCS(KD1,II2)+VZI**2
C
        VXJ=VAL(ITHH+3)
        VYJ=VAL(ITHH+4)
        VZJ=VAL(ITHH+5)
        GCS(KD1,JJ)=GCS(KD1,JJ)+VXJ**2
        GCS(KD1+JJ-JJ1,JJ1)=GCS(KD1+JJ-JJ1,JJ1)+VXJ*VYJ
        GCS(KD1+JJ-JJ2,JJ2)=GCS(KD1+JJ-JJ2,JJ2)+VXJ*VZJ
        GCS(KD1,JJ1)=GCS(KD1,JJ1)+VYJ**2
        GCS(KD1+JJ1-JJ2,JJ2)=GCS(KD1+JJ1-JJ2,JJ2)+VYJ*VZJ
        GCS(KD1,JJ2)=GCS(KD1,JJ2)+VZJ**2
C
        VXK=VAL(ITHH+6)
        VYK=VAL(ITHH+7)
        VZK=VAL(ITHH+8)
        GCS(KD1,KK)=GCS(KD1,KK)+VXK**2
        GCS(KD1+KK-KK1,KK1)=GCS(KD1+KK-KK1,KK1)+VXK*VYK
        GCS(KD1+KK-KK2,KK2)=GCS(KD1+KK-KK2,KK2)+VXK*VZK
        GCS(KD1,KK1)=GCS(KD1,KK1)+VYK**2
        GCS(KD1+KK1-KK2,KK2)=GCS(KD1+KK1-KK2,KK2)+VYK*VZK
        GCS(KD1,KK2)=GCS(KD1,KK2)+VZK**2
C
        IIKD=II+KD1
        IIKD1=II1+KD1
        IIKD2=II2+KD1
        JJKD=JJ+KD1
        JJKD1=JJ1+KD1
        JJKD2=JJ2+KD1
        KKKD=KK+KD1
        KKKD1=KK1+KD1
        KKKD2=KK2+KD1
C
C       IF (II.LT.JJ) THEN
        GCS(IIKD-JJ,JJ)=GCS(IIKD-JJ,JJ)+VXI*VXJ
        GCS(IIKD-JJ1,JJ1)=GCS(IIKD-JJ1,JJ1)+VXI*VYJ
        GCS(IIKD-JJ2,JJ2)=GCS(IIKD-JJ2,JJ2)+VXI*VZJ
        GCS(IIKD1-JJ,JJ)=GCS(IIKD1-JJ,JJ)+VYI*VXJ
        GCS(IIKD1-JJ1,JJ1)=GCS(IIKD1-JJ1,JJ1)+VYI*VYJ
        GCS(IIKD1-JJ2,JJ2)=GCS(IIKD1-JJ2,JJ2)+VYI*VZJ
        GCS(IIKD2-JJ,JJ)=GCS(IIKD2-JJ,JJ)+VZI*VXJ
        GCS(IIKD2-JJ1,JJ1)=GCS(IIKD2-JJ1,JJ1)+VZI*VYJ
        GCS(IIKD2-JJ2,JJ2)=GCS(IIKD2-JJ2,JJ2)+VZI*VZJ
C       ELSE
C       GCS(JJKD-II,II)=GCS(IIKD-JJ,JJ)
C       GCS(JJKD1-II,II)=GCS(IIKD-JJ1,JJ1)
C       GCS(JJKD2-II,II)=GCS(IIKD-JJ2,JJ2)
C       GCS(JJKD-II1,II1)=GCS(IIKD1-JJ,JJ)
C       GCS(JJKD1-II1,II1)=GCS(IIKD1-JJ1,JJ1)
C       GCS(JJKD2-II1,II1)=GCS(IIKD1-JJ2,JJ2)
C       GCS(JJKD-II2,II2)=GCS(IIKD2-JJ,JJ)
C       GCS(JJKD1-II2,II2)=GCS(IIKD2-JJ1,JJ1)
C       GCS(JJKD2-II2,II2)=GCS(IIKD2-JJ2,JJ2)
C       ENDIF
C
C       IF (II.LT.KK) THEN
        GCS(IIKD-KK,KK)=GCS(IIKD-KK,KK)+VXI*VXK
        GCS(IIKD-KK1,KK1)=GCS(IIKD-KK1,KK1)+VXI*VYK
        GCS(IIKD-KK2,KK2)=GCS(IIKD-KK2,KK2)+VXI*VZK
        GCS(IIKD1-KK,KK)=GCS(IIKD1-KK,KK)+VYI*VXK
        GCS(IIKD1-KK1,KK1)=GCS(IIKD1-KK1,KK1)+VYI*VYK
        GCS(IIKD1-KK2,KK2)=GCS(IIKD1-KK2,KK2)+VYI*VZK
        GCS(IIKD2-KK,KK)=GCS(IIKD2-KK,KK)+VZI*VXK
        GCS(IIKD2-KK1,KK1)=GCS(IIKD2-KK1,KK1)+VZI*VYK
        GCS(IIKD2-KK2,KK2)=GCS(IIKD2-KK2,KK2)+VZI*VZK
C       ELSE
C       GCS(KKKD-II,II)=GCS(IIKD-KK,KK)
C       GCS(KKKD1-II,II)=GCS(IIKD-KK1,KK1)
C       GCS(KKKD2-II,II)=GCS(IIKD-KK2,KK2)
C       GCS(KKKD-II1,II1)=GCS(IIKD1-KK,KK)
C       GCS(KKKD1-II1,II1)=GCS(IIKD1-KK1,KK1)
C       GCS(KKKD2-II1,II1)=GCS(IIKD1-KK2,KK2)
C       GCS(KKKD-II2,II2)=GCS(IIKD2-KK,KK)
C       GCS(KKKD1-II2,II2)=GCS(IIKD2-KK1,KK1)
C       GCS(KKKD2-II2,II2)=GCS(IIKD2-KK2,KK2)
C       ENDIF
C
C       IF (JJ.LT.KK) THEN
        GCS(JJKD-KK,KK)=GCS(JJKD-KK,KK)+VXJ*VXK
        GCS(JJKD-KK1,KK1)=GCS(JJKD-KK1,KK1)+VXJ*VYK
        GCS(JJKD-KK2,KK2)=GCS(JJKD-KK2,KK2)+VXJ*VZK
        GCS(JJKD1-KK,KK)=GCS(JJKD1-KK,KK)+VYJ*VXK
        GCS(JJKD1-KK1,KK1)=GCS(JJKD1-KK1,KK1)+VYJ*VYK
        GCS(JJKD1-KK2,KK2)=GCS(JJKD1-KK2,KK2)+VYJ*VZK
        GCS(JJKD2-KK,KK)=GCS(JJKD2-KK,KK)+VZJ*VXK
        GCS(JJKD2-KK1,KK1)=GCS(JJKD2-KK1,KK1)+VZJ*VYK
        GCS(JJKD2-KK2,KK2)=GCS(JJKD2-KK2,KK2)+VZJ*VZK
C       ELSE
C       GCS(KKKD-JJ,JJ)=GCS(JJKD-KK,KK)
C       GCS(KKKD1-JJ,JJ)=GCS(JJKD-KK1,KK1)
C       GCS(KKKD2-JJ,JJ)=GCS(JJKD-KK2,KK2)
C       GCS(KKKD-JJ1,JJ1)=GCS(JJKD1-KK,KK)
C       GCS(KKKD1-JJ1,JJ1)=GCS(JJKD1-KK1,KK1)
C       GCS(KKKD2-JJ1,JJ1)=GCS(JJKD1-KK2,KK2)
C       GCS(KKKD-JJ2,JJ2)=GCS(JJKD2-KK,KK)
C       GCS(KKKD1-JJ2,JJ2)=GCS(JJKD2-KK1,KK1)
C       GCS(KKKD2-JJ2,JJ2)=GCS(JJKD2-KK2,KK2)
C       ENDIF
C
C
C END DAE
C
   20  CONTINUE

       IPASS=0
C SIDE CHAIN POLAR ANGLE ALPHA
C ALPHA IS ANGLE BETWEEN THE VECTOR SCI-CAI, AND THE BISECTOR OF THETA(I-1) IN THE PLANE OF THE 
C THREE CA'S. DEPENDS THEREFORE ON THE COORDINATES OF 4 ATOMS
C ***********************************************************************************************
C NOTE THAT GLYCINE RESIDUES (WHETHER CAPPING OR NORMAL) DO NOT HAVE ALPHAS OR DIHEDRAL ANGLES...
C THEREFORE CAN'T SIMPLY USE NSIDE TO WORK OUT I,J,K,L...
C ***********************************************************************************************
      DO 30 ITH=1,NRES-2
C
C SKIP THIS PASS IF THE 'ITYPE' OF THE CA(I) IS GLYCINE, 
        IF (ITYPE(ITH+1).EQ.10) GOTO 30
        IPASS=IPASS+1
        I=2*ITH-1
        J=I+2
C K IS THE SIDE CHAIN CENTROID.
        K=I+3
        L=I+4
        II=3*(I-1)+1
        II1=3*(I-1)+2
        II2=3*(I-1)+3
        JJ=3*(J-1)+1
        JJ1=3*(J-1)+2
        JJ2=3*(J-1)+3
        KK=3*(K-1)+1
        KK1=3*(K-1)+2
        KK2=3*(K-1)+3
        LL=3*(L-1)+1
        LL1=3*(L-1)+2
        LL2=3*(L-1)+3
C      PRINT *,'ANGLE I J K L',I,J,K,L
C       IC=ICT(ITH)
C       IF(IC.EQ.0) GOTO 30
C DXI IS VECTOR CAI -> SCI
        DXI=X(K)-X(J)
        DYI=Y(K)-Y(J)
        DZI=Z(K)-Z(J)
C DXJ IS BISECTOR OF I->L
        DXJ=X(J)-(X(I)+X(L))/2.0D0
        DYJ=Y(J)-(Y(I)+Y(L))/2.0D0
        DZJ=Z(J)-(Z(I)+Z(L))/2.0D0
        RI2=DXI*DXI+DYI*DYI+DZI*DZI
        RJ2=DXJ*DXJ+DYJ*DYJ+DZJ*DZJ
        RI=SQRT(RI2)
        RJ=SQRT(RJ2)
        RIR=1/RI
        RJR=1/RJ
        DXIR=DXI*RIR
        DYIR=DYI*RIR
        DZIR=DZI*RIR
        DXJR=DXJ*RJR
        DYJR=DYJ*RJR
        DZJR=DZJ*RJR
        CST=DXIR*DXJR+DYIR*DYJR+DZIR*DZJR
C
        IF (.NOT.NOCOOR) THEN
C DAE STORE THETA (IN RADIANS) IN COORDS
C         COORDS(NPHI+NTHETA+ITH)=3.141592653589793D0-ACOS(CST)
          INTCOORDS(NPHI+NTHETA+IPASS)=3.141592653589793D0-ACOS(CST)
C         PRINT *,'COORDS = ',COORDS(NPHI+NTHETA+IPASS)
        ENDIF
C DAE CALCULATE B-MATRIX ELEMENTS FOR THESE ATOMS (WILSON DECIUS + CROSS CH.4)
C JMC TESTING!!!        ISNT=1/SQRT(1-CST*CST)
        ISNT=-1/SQRT(1-CST*CST)
        ITHH=12*NPHI+9*NTHETA+12*(IPASS-1)+1
        VAL(ITHH)=-(DXJR*CST-DXIR)*RJR*ISNT/2.0D0
        INDX(ITHH)=NPHI+NTHETA+IPASS
        JNDX(ITHH)=II
        BEEMATRIX(NPHI+NTHETA+IPASS,II)=-(DXJR*CST-DXIR)*RJR*ISNT/2.0D0
C
        VAL(ITHH+1)=-(DYJR*CST-DYIR)*RJR*ISNT/2.0D0
        INDX(ITHH+1)=NPHI+NTHETA+IPASS
        JNDX(ITHH+1)=II1
        BEEMATRIX(NPHI+NTHETA+IPASS,II1)=-(DYJR*CST-DYIR)*RJR*ISNT/2.0D0
C
        VAL(ITHH+2)=-(DZJR*CST-DZIR)*RJR*ISNT/2.0D0
        INDX(ITHH+2)=NPHI+NTHETA+IPASS
        JNDX(ITHH+2)=II2
        BEEMATRIX(NPHI+NTHETA+IPASS,II2)=-(DZJR*CST-DZIR)*RJR*ISNT/2.0D0
C
        VAL(ITHH+3)=(DXIR*(RI-RJ*CST)+DXJR*(RJ-RI*CST))*RIR*RJR*ISNT
     &                                   +2.0D0*(DXJR*CST-DXIR)*RJR*ISNT
        INDX(ITHH+3)=NPHI+NTHETA+IPASS
        JNDX(ITHH+3)=JJ
        BEEMATRIX(NPHI+NTHETA+IPASS,JJ)=(DXIR*(RI-RJ*CST)+DXJR*(RJ-RI*CST))*RIR*RJR*ISNT
     &                                   +2.0D0*(DXJR*CST-DXIR)*RJR*ISNT
C
        VAL(ITHH+4)=(DYIR*(RI-RJ*CST)+DYJR*(RJ-RI*CST))*RIR*RJR*ISNT
     &                                   +2.0D0*(DYJR*CST-DYIR)*RJR*ISNT
        INDX(ITHH+4)=NPHI+NTHETA+IPASS
        JNDX(ITHH+4)=JJ1
        BEEMATRIX(NPHI+NTHETA+IPASS,JJ1)=(DYIR*(RI-RJ*CST)+DYJR*(RJ-RI*CST))*RIR*RJR*ISNT
     &                                   +2.0D0*(DYJR*CST-DYIR)*RJR*ISNT
C
        VAL(ITHH+5)=(DZIR*(RI-RJ*CST)+DZJR*(RJ-RI*CST))*RIR*RJR*ISNT
     &                                   +2.0D0*(DZJR*CST-DZIR)*RJR*ISNT
        INDX(ITHH+5)=NPHI+NTHETA+IPASS
        JNDX(ITHH+5)=JJ2
        BEEMATRIX(NPHI+NTHETA+IPASS,JJ2)=(DZIR*(RI-RJ*CST)+DZJR*(RJ-RI*CST))*RIR*RJR*ISNT
     &                                   +2.0D0*(DZJR*CST-DZIR)*RJR*ISNT
C
        VAL(ITHH+6)=(DXIR*CST-DXJR)*RIR*ISNT
        INDX(ITHH+6)=NPHI+NTHETA+IPASS
        JNDX(ITHH+6)=KK
        BEEMATRIX(NPHI+NTHETA+IPASS,KK)=(DXIR*CST-DXJR)*RIR*ISNT
C
        VAL(ITHH+7)=(DYIR*CST-DYJR)*RIR*ISNT
        INDX(ITHH+7)=NPHI+NTHETA+IPASS
        JNDX(ITHH+7)=KK1
        BEEMATRIX(NPHI+NTHETA+IPASS,KK1)=(DYIR*CST-DYJR)*RIR*ISNT
C
        VAL(ITHH+8)=(DZIR*CST-DZJR)*RIR*ISNT
        INDX(ITHH+8)=NPHI+NTHETA+IPASS
        JNDX(ITHH+8)=KK2
        BEEMATRIX(NPHI+NTHETA+IPASS,KK2)=(DZIR*CST-DZJR)*RIR*ISNT
C
        VAL(ITHH+9)=-(DXJR*CST-DXIR)*RJR*ISNT/2.0D0
        INDX(ITHH+9)=NPHI+NTHETA+IPASS
        JNDX(ITHH+9)=LL
        BEEMATRIX(NPHI+NTHETA+IPASS,LL)=-(DXJR*CST-DXIR)*RJR*ISNT/2.0D0
C
        VAL(ITHH+10)=-(DYJR*CST-DYIR)*RJR*ISNT/2.0D0
        INDX(ITHH+10)=NPHI+NTHETA+IPASS
        JNDX(ITHH+10)=LL1
        BEEMATRIX(NPHI+NTHETA+IPASS,LL1)=-(DYJR*CST-DYIR)*RJR*ISNT/2.0D0
C
        VAL(ITHH+11)=-(DZJR*CST-DZIR)*RJR*ISNT/2.0D0
        INDX(ITHH+11)=NPHI+NTHETA+IPASS
        JNDX(ITHH+11)=LL2
        BEEMATRIX(NPHI+NTHETA+IPASS,LL2)=-(DZJR*CST-DZIR)*RJR*ISNT/2.0D0
         
C
C CALCULATE GEE FOR THIS IC
        VXI=VAL(ITHH)
        VYI=VAL(ITHH+1)
        VZI=VAL(ITHH+2)
        GCS(KD1,II)=GCS(KD1,II)+VXI**2
        GCS(KD1+II-II1,II1)=GCS(KD1+II-II1,II1)+VXI*VYI
        GCS(KD1+II-II2,II2)=GCS(KD1+II-II2,II2)+VXI*VZI
        GCS(KD1,II1)=GCS(KD1,II1)+VYI**2
        GCS(KD1+II1-II2,II2)=GCS(KD1+II1-II2,II2)+VYI*VZI
        GCS(KD1,II2)=GCS(KD1,II2)+VZI**2
C
        VXJ=VAL(ITHH+3)
        VYJ=VAL(ITHH+4)
        VZJ=VAL(ITHH+5)
        GCS(KD1,JJ)=GCS(KD1,JJ)+VXJ**2
        GCS(KD1+JJ-JJ1,JJ1)=GCS(KD1+JJ-JJ1,JJ1)+VXJ*VYJ
        GCS(KD1+JJ-JJ2,JJ2)=GCS(KD1+JJ-JJ2,JJ2)+VXJ*VZJ
        GCS(KD1,JJ1)=GCS(KD1,JJ1)+VYJ**2
        GCS(KD1+JJ1-JJ2,JJ2)=GCS(KD1+JJ1-JJ2,JJ2)+VYJ*VZJ
        GCS(KD1,JJ2)=GCS(KD1,JJ2)+VZJ**2
C
        VXK=VAL(ITHH+6)
        VYK=VAL(ITHH+7)
        VZK=VAL(ITHH+8)
        GCS(KD1,KK)=GCS(KD1,KK)+VXK**2
        GCS(KD1+KK-KK1,KK1)=GCS(KD1+KK-KK1,KK1)+VXK*VYK
        GCS(KD1+KK-KK2,KK2)=GCS(KD1+KK-KK2,KK2)+VXK*VZK
        GCS(KD1,KK1)=GCS(KD1,KK1)+VYK**2
        GCS(KD1+KK1-KK2,KK2)=GCS(KD1+KK1-KK2,KK2)+VYK*VZK
        GCS(KD1,KK2)=GCS(KD1,KK2)+VZK**2
C
        VXL=VAL(ITHH+9)
        VYL=VAL(ITHH+10)
        VZL=VAL(ITHH+11)
        GCS(KD1,LL)=GCS(KD1,LL)+VXL**2
        GCS(KD1+LL-LL1,LL1)=GCS(KD1+LL-LL1,LL1)+VXL*VYL
        GCS(KD1+LL-LL2,LL2)=GCS(KD1+LL-LL2,LL2)+VXL*VZL
        GCS(KD1,LL1)=GCS(KD1,LL1)+VYL**2
        GCS(KD1+LL1-LL2,LL2)=GCS(KD1+LL1-LL2,LL2)+VYL*VZL
        GCS(KD1,LL2)=GCS(KD1,LL2)+VZL**2
C
        IIKD=II+KD1
        IIKD1=II1+KD1
        IIKD2=II2+KD1
        JJKD=JJ+KD1
        JJKD1=JJ1+KD1
        JJKD2=JJ2+KD1
        KKKD=KK+KD1
        KKKD1=KK1+KD1
        KKKD2=KK2+KD1
        LLKD=LL+KD1
        LLKD1=LL1+KD1
        LLKD2=LL2+KD1
C
C       IF (II.LT.JJ) THEN
        GCS(IIKD-JJ,JJ)=GCS(IIKD-JJ,JJ)+VXI*VXJ
        GCS(IIKD-JJ1,JJ1)=GCS(IIKD-JJ1,JJ1)+VXI*VYJ
        GCS(IIKD-JJ2,JJ2)=GCS(IIKD-JJ2,JJ2)+VXI*VZJ
        GCS(IIKD1-JJ,JJ)=GCS(IIKD1-JJ,JJ)+VYI*VXJ
        GCS(IIKD1-JJ1,JJ1)=GCS(IIKD1-JJ1,JJ1)+VYI*VYJ
        GCS(IIKD1-JJ2,JJ2)=GCS(IIKD1-JJ2,JJ2)+VYI*VZJ
        GCS(IIKD2-JJ,JJ)=GCS(IIKD2-JJ,JJ)+VZI*VXJ
        GCS(IIKD2-JJ1,JJ1)=GCS(IIKD2-JJ1,JJ1)+VZI*VYJ
        GCS(IIKD2-JJ2,JJ2)=GCS(IIKD2-JJ2,JJ2)+VZI*VZJ

C II < KK
        GCS(IIKD-KK,KK)=GCS(IIKD-KK,KK)+VXI*VXK
        GCS(IIKD-KK1,KK1)=GCS(IIKD-KK1,KK1)+VXI*VYK
        GCS(IIKD-KK2,KK2)=GCS(IIKD-KK2,KK2)+VXI*VZK
        GCS(IIKD1-KK,KK)=GCS(IIKD1-KK,KK)+VYI*VXK
        GCS(IIKD1-KK1,KK1)=GCS(IIKD1-KK1,KK1)+VYI*VYK
        GCS(IIKD1-KK2,KK2)=GCS(IIKD1-KK2,KK2)+VYI*VZK
        GCS(IIKD2-KK,KK)=GCS(IIKD2-KK,KK)+VZI*VXK
        GCS(IIKD2-KK1,KK1)=GCS(IIKD2-KK1,KK1)+VZI*VYK
        GCS(IIKD2-KK2,KK2)=GCS(IIKD2-KK2,KK2)+VZI*VZK

C II < LL
        GCS(IIKD-LL,LL)=GCS(IIKD-LL,LL)+VXI*VXL
        GCS(IIKD-LL1,LL1)=GCS(IIKD-LL1,LL1)+VXI*VYL
        GCS(IIKD-LL2,LL2)=GCS(IIKD-LL2,LL2)+VXI*VZL
        GCS(IIKD1-LL,LL)=GCS(IIKD1-LL,LL)+VYI*VXL
        GCS(IIKD1-LL1,LL1)=GCS(IIKD1-LL1,LL1)+VYI*VYL
        GCS(IIKD1-LL2,LL2)=GCS(IIKD1-LL2,LL2)+VYI*VZL
        GCS(IIKD2-LL,LL)=GCS(IIKD2-LL,LL)+VZI*VXL
        GCS(IIKD2-LL1,LL1)=GCS(IIKD2-LL1,LL1)+VZI*VYL
        GCS(IIKD2-LL2,LL2)=GCS(IIKD2-LL2,LL2)+VZI*VZL

C JJ < KK
        GCS(JJKD-KK,KK)=GCS(JJKD-KK,KK)+VXJ*VXK
        GCS(JJKD-KK1,KK1)=GCS(JJKD-KK1,KK1)+VXJ*VYK
        GCS(JJKD-KK2,KK2)=GCS(JJKD-KK2,KK2)+VXJ*VZK
        GCS(JJKD1-KK,KK)=GCS(JJKD1-KK,KK)+VYJ*VXK
        GCS(JJKD1-KK1,KK1)=GCS(JJKD1-KK1,KK1)+VYJ*VYK
        GCS(JJKD1-KK2,KK2)=GCS(JJKD1-KK2,KK2)+VYJ*VZK
        GCS(JJKD2-KK,KK)=GCS(JJKD2-KK,KK)+VZJ*VXK
        GCS(JJKD2-KK1,KK1)=GCS(JJKD2-KK1,KK1)+VZJ*VYK
        GCS(JJKD2-KK2,KK2)=GCS(JJKD2-KK2,KK2)+VZJ*VZK

C       IF (JJ.LT.LL) THEN
        GCS(JJKD-LL,LL)=GCS(JJKD-LL,LL)+VXJ*VXL
        GCS(JJKD-LL1,LL1)=GCS(JJKD-LL1,LL1)+VXJ*VYL
        GCS(JJKD-LL2,LL2)=GCS(JJKD-LL2,LL2)+VXJ*VZL
        GCS(JJKD1-LL,LL)=GCS(JJKD1-LL,LL)+VYJ*VXL
        GCS(JJKD1-LL1,LL1)=GCS(JJKD1-LL1,LL1)+VYJ*VYL
        GCS(JJKD1-LL2,LL2)=GCS(JJKD1-LL2,LL2)+VYJ*VZL
        GCS(JJKD2-LL,LL)=GCS(JJKD2-LL,LL)+VZJ*VXL
        GCS(JJKD2-LL1,LL1)=GCS(JJKD2-LL1,LL1)+VZJ*VYL
        GCS(JJKD2-LL2,LL2)=GCS(JJKD2-LL2,LL2)+VZJ*VZL

C       IF (KK.LT.LL) THEN
        GCS(KKKD-LL,LL)=GCS(KKKD-LL,LL)+VXK*VXL
        GCS(KKKD-LL1,LL1)=GCS(KKKD-LL1,LL1)+VXK*VYL
        GCS(KKKD-LL2,LL2)=GCS(KKKD-LL2,LL2)+VXK*VZL
        GCS(KKKD1-LL,LL)=GCS(KKKD1-LL,LL)+VYK*VXL
        GCS(KKKD1-LL1,LL1)=GCS(KKKD1-LL1,LL1)+VYK*VYL
        GCS(KKKD1-LL2,LL2)=GCS(KKKD1-LL2,LL2)+VYK*VZL
        GCS(KKKD2-LL,LL)=GCS(KKKD2-LL,LL)+VZK*VXL
        GCS(KKKD2-LL1,LL1)=GCS(KKKD2-LL1,LL1)+VZK*VYL
        GCS(KKKD2-LL2,LL2)=GCS(KKKD2-LL2,LL2)+VZK*VZL

C
C END DAE
C
   30  CONTINUE

C SIDE CHAIN DIHEDRALS
      IPASS=0

      DO 40 IPHI=1,NRES-2
C I= CA(I-1), J = CAI, K = SC, L = CA(I+1)
C FOR GLYCINE
        IF (ITYPE(IPHI+1).EQ.10) GOTO 40
        IPASS=IPASS+1
        I=2*IPHI-1
        J=I+2
        K=I+3
        L=I+4
        II=3*(I-1)+1
        II1=3*(I-1)+2
        II2=3*(I-1)+3
        JJ=3*(J-1)+1
        JJ1=3*(J-1)+2
        JJ2=3*(J-1)+3
        KK=3*(K-1)+1
        KK1=3*(K-1)+2
        KK2=3*(K-1)+3
        LL=3*(L-1)+1
        LL1=3*(L-1)+2
        LL2=3*(L-1)+3
C       IC=ICI(IPHI)
C POINT BIS IS THE POINT WHERE THE BISECTOR OF THETA MEETS THE VECTOR CA (I-1) -> CA(I+1)
C (SINCE ALL VIRTUAL BOND LENGTHS ARE EQUAL, THIS POINT LIES AT THE MIDPOINT OF CA (I-1) -> CA(I+1).
C F=RK-RJ, G=RJ-RBIS, H-RL-RBIS.
        FX=X(K)-X(J)
        FY=Y(K)-Y(J)
        FZ=Z(K)-Z(J)
        GX=X(J)-(X(I)+X(L))/2.0D0
        GY=Y(J)-(Y(I)+Y(L))/2.0D0
        GZ=Z(J)-(Z(I)+Z(L))/2.0D0
        HX=(X(L)-X(I))/2.0D0
        HY=(Y(L)-Y(I))/2.0D0
        HZ=(Z(L)-Z(I))/2.0D0
C A=F^G, B=H^G
        AX=FY*GZ-FZ*GY
        AY=FZ*GX-FX*GZ
        AZ=FX*GY-FY*GX
        BX=HY*GZ-HZ*GY
        BY=HZ*GX-HX*GZ
        BZ=HX*GY-HY*GX
C RG=|G|, RGR=1/|G|
        RG2=GX*GX+GY*GY+GZ*GZ
        RG=SQRT(RG2)
        RGR=1/RG
C DAE FOR USE IN EVALUATING B-MATRIX
        RF2=FX*FX+FY*FY+FZ*FZ
        RF=SQRT(RF2)
        RFR=1/RF
        RH2=HX*HX+HY*HY+HZ*HZ
        RH=SQRT(RH2)
        RHR=1/RH
C JMC        CSTTWO=(FX*GX+FY*GY+FZ*GZ)*RFR*RGR
        CSTTWO=-(FX*GX+FY*GY+FZ*GZ)*RFR*RGR
        SNTTWO2=1-CSTTWO*CSTTWO
        SNTTWO2R=1/SNTTWO2
        CSTTHREE=(HX*GX+HY*GY+HZ*GZ)*RHR*RGR
C       PRINT *,'COSTHREE = ',CSTTHREE
        SNTTHREE2=1-CSTTHREE*CSTTHREE
C       PRINT *,'SINTHREE2 = ',SNTTHREE2
        SNTTHREE2R=1/SNTTHREE2
        IPHII=12*NPHI+9*NTHETA+12*NSIDE+12*(IPASS-1)+1
        SUMPHI=NPHI+NTHETA+NSIDE+IPASS
C
        IF (.NOT.NOCOOR) THEN
          RA2=AX*AX+AY*AY+AZ*AZ
          RB2=BX*BX+BY*BY+BZ*BZ
          RA2R=1/RA2
          RB2R=1/RB2
          RABR=SQRT(RA2R*RB2R)
C CP=COS(PHI)
          CP=(AX*BX+AY*BY+AZ*BZ)*RABR
          INTCOORDS(SUMPHI)=ACOS(CP)
          IF (CP.GT.1.0D0) INTCOORDS(SUMPHI)=0.0D0
C         PRINT *,'CP ',CP
C         PRINT *,'ACOS ',ACOS(CP)
C JMC 
C TEST TO DETERMINE WHETHER THE DIHEDRAL ANGLE SHOULD BE > 0 OR < 0, FROM UNRES (INTCOR.F) 
          TX=AY*BZ-BY*AZ
          TY=-AX*BZ+BX*AZ
          TZ=AX*BY-BX*AY
          SCALAR=TX*GX+TY*GY+TZ*GZ
C         PRINT *,'SCALAR',SCALAR
          IF (SCALAR.GT.0.0D0) INTCOORDS(SUMPHI)=-INTCOORDS(SUMPHI)
C         PRINT *,'COORDS = ',COORDS(SUMPHI)
        ENDIF
C DAE CALCULATE B-MATRIX ELEMENTS

C I
        DUMMY=RHR*RHR*RGR*RGR*SNTTHREE2R*(RG-RH*CSTTHREE)
        DUMMY2=RFR*RGR*RGR*SNTTWO2R*CSTTWO
        VAL(IPHII)=(-BX*DUMMY+AX*DUMMY2)/2.0D0
        INDX(IPHII)=SUMPHI
        JNDX(IPHII)=II
        BEEMATRIX(SUMPHI,II)=(-BX*DUMMY+AX*DUMMY2)/2.0D0
C
        VAL(IPHII+1)=(-BY*DUMMY+AY*DUMMY2)/2.0D0
        INDX(IPHII+1)=SUMPHI
        JNDX(IPHII+1)=II+1
        BEEMATRIX(SUMPHI,II+1)=(-BY*DUMMY+AY*DUMMY2)/2.0D0
C
        VAL(IPHII+2)=(-BZ*DUMMY+AZ*DUMMY2)/2.0D0
        INDX(IPHII+2)=SUMPHI
        JNDX(IPHII+2)=II+2
        BEEMATRIX(SUMPHI,II+2)=(-BZ*DUMMY+AZ*DUMMY2)/2.0D0

C J
        DUMMY=RFR*RFR*RGR*RGR*SNTTWO2R*(RG-RF*CSTTWO)
        DUMMY2=RHR*RGR*RGR*SNTTHREE2R*CSTTHREE
C
        VAL(IPHII+3)=AX*DUMMY-BX*DUMMY2
        INDX(IPHII+3)=SUMPHI
        JNDX(IPHII+3)=JJ
        BEEMATRIX(SUMPHI,JJ)=AX*DUMMY-BX*DUMMY2
C
        VAL(IPHII+4)=AY*DUMMY-BY*DUMMY2
        INDX(IPHII+4)=SUMPHI
        JNDX(IPHII+4)=JJ+1
        BEEMATRIX(SUMPHI,JJ+1)=AY*DUMMY-BY*DUMMY2
C
        VAL(IPHII+5)=AZ*DUMMY-BZ*DUMMY2
        INDX(IPHII+5)=SUMPHI
        JNDX(IPHII+5)=JJ+2
        BEEMATRIX(SUMPHI,JJ+2)=AZ*DUMMY-BZ*DUMMY2

C K: SIDE CHAIN CENTROID.
        DUMMY=RFR*RFR*RGR*SNTTWO2R
        VAL(IPHII+6)=-AX*DUMMY
        INDX(IPHII+6)=SUMPHI
        JNDX(IPHII+6)=KK
        BEEMATRIX(SUMPHI,KK)=-AX*DUMMY
C
        VAL(IPHII+7)=-AY*DUMMY
        INDX(IPHII+7)=SUMPHI
        JNDX(IPHII+7)=KK+1
        BEEMATRIX(SUMPHI,KK+1)=-AY*DUMMY
C
        VAL(IPHII+8)=-AZ*DUMMY
        INDX(IPHII+8)=SUMPHI
        JNDX(IPHII+8)=KK+2
        BEEMATRIX(SUMPHI,KK+2)=-AZ*DUMMY

C L
        DUMMY=RHR*RHR*RGR*SNTTHREE2R
        DUMMY2=RHR*RHR*RGR*RGR*SNTTHREE2R*(RG-RH*CSTTHREE)
        DUMMY3=RFR*RGR*RGR*SNTTWO2R*CSTTWO
        VAL(IPHII+9)=BX*DUMMY+(-BX*DUMMY2+AX*DUMMY3)/2.0D0
        INDX(IPHII+9)=SUMPHI
        JNDX(IPHII+9)=LL
        BEEMATRIX(SUMPHI,LL)=BX*DUMMY+(-BX*DUMMY2+AX*DUMMY3)/2.0D0
C
        VAL(IPHII+10)=BY*DUMMY+(-BY*DUMMY2+AY*DUMMY3)/2.0D0
        INDX(IPHII+10)=SUMPHI
        JNDX(IPHII+10)=LL+1
        BEEMATRIX(SUMPHI,LL+1)=BY*DUMMY+(-BY*DUMMY2+AY*DUMMY3)/2.0D0
C
        VAL(IPHII+11)=BZ*DUMMY+(-BZ*DUMMY2+AZ*DUMMY3)/2.0D0
        INDX(IPHII+11)=SUMPHI
        JNDX(IPHII+11)=LL+2
        BEEMATRIX(SUMPHI,LL+2)=BZ*DUMMY+(-BZ*DUMMY2+AZ*DUMMY3)/2.0D0

C CALCULATE GEE FOR THIS IC
        IIKD=II+KD1
        IIKD1=II1+KD1
        IIKD2=II2+KD1
        JJKD=JJ+KD1
        JJKD1=JJ1+KD1
        JJKD2=JJ2+KD1
        KKKD=KK+KD1
        KKKD1=KK1+KD1
        KKKD2=KK2+KD1
        LLKD=LL+KD1
        LLKD1=LL1+KD1
        LLKD2=LL2+KD1
C
        VXI=VAL(IPHII)
        VYI=VAL(IPHII+1)
        VZI=VAL(IPHII+2)
        GCS(KD1,II)=GCS(KD1,II)+VXI**2
        GCS(KD1+II-II1,II1)=GCS(KD1+II-II1,II1)+VXI*VYI
        GCS(KD1+II-II2,II2)=GCS(KD1+II-II2,II2)+VXI*VZI
        GCS(KD1,II1)=GCS(KD1,II1)+VYI**2
        GCS(KD1+II1-II2,II2)=GCS(KD1+II1-II2,II2)+VYI*VZI
        GCS(KD1,II2)=GCS(KD1,II2)+VZI**2
C
        VXJ=VAL(IPHII+3)
        VYJ=VAL(IPHII+4)
        VZJ=VAL(IPHII+5)
        GCS(KD1,JJ)=GCS(KD1,JJ)+VXJ**2
        GCS(KD1+JJ-JJ1,JJ1)=GCS(KD1+JJ-JJ1,JJ1)+VXJ*VYJ
        GCS(KD1+JJ-JJ2,JJ2)=GCS(KD1+JJ-JJ2,JJ2)+VXJ*VZJ
        GCS(KD1,JJ1)=GCS(KD1,JJ1)+VYJ**2
        GCS(KD1+JJ1-JJ2,JJ2)=GCS(KD1+JJ1-JJ2,JJ2)+VYJ*VZJ
        GCS(KD1,JJ2)=GCS(KD1,JJ2)+VZJ**2
C
        VXK=VAL(IPHII+6)
        VYK=VAL(IPHII+7)
        VZK=VAL(IPHII+8)
        GCS(KD1,KK)=GCS(KD1,KK)+VXK**2
        GCS(KD1+KK-KK1,KK1)=GCS(KD1+KK-KK1,KK1)+VXK*VYK
        GCS(KD1+KK-KK2,KK2)=GCS(KD1+KK-KK2,KK2)+VXK*VZK
        GCS(KD1,KK1)=GCS(KD1,KK1)+VYK**2
        GCS(KD1+KK1-KK2,KK2)=GCS(KD1+KK1-KK2,KK2)+VYK*VZK
        GCS(KD1,KK2)=GCS(KD1,KK2)+VZK**2
C
        VXL=VAL(IPHII+9)
        VYL=VAL(IPHII+10)
        VZL=VAL(IPHII+11)
        GCS(KD1,LL)=GCS(KD1,LL)+VXL**2
        GCS(KD1+LL-LL1,LL1)=GCS(KD1+LL-LL1,LL1)+VXL*VYL
        GCS(KD1+LL-LL2,LL2)=GCS(KD1+LL-LL2,LL2)+VXL*VZL
        GCS(KD1,LL1)=GCS(KD1,LL1)+VYL**2
        GCS(KD1+LL1-LL2,LL2)=GCS(KD1+LL1-LL2,LL2)+VYL*VZL
        GCS(KD1,LL2)=GCS(KD1,LL2)+VZL**2
C
C       IF (II.LT.JJ) THEN
        GCS(IIKD-JJ,JJ)=GCS(IIKD-JJ,JJ)+VXI*VXJ
        GCS(IIKD-JJ1,JJ1)=GCS(IIKD-JJ1,JJ1)+VXI*VYJ
        GCS(IIKD-JJ2,JJ2)=GCS(IIKD-JJ2,JJ2)+VXI*VZJ
        GCS(IIKD1-JJ,JJ)=GCS(IIKD1-JJ,JJ)+VYI*VXJ
        GCS(IIKD1-JJ1,JJ1)=GCS(IIKD1-JJ1,JJ1)+VYI*VYJ
        GCS(IIKD1-JJ2,JJ2)=GCS(IIKD1-JJ2,JJ2)+VYI*VZJ
        GCS(IIKD2-JJ,JJ)=GCS(IIKD2-JJ,JJ)+VZI*VXJ
        GCS(IIKD2-JJ1,JJ1)=GCS(IIKD2-JJ1,JJ1)+VZI*VYJ
        GCS(IIKD2-JJ2,JJ2)=GCS(IIKD2-JJ2,JJ2)+VZI*VZJ
C       ELSE
C       GCS(JJKD-II,II)=GCS(IIKD-JJ,JJ)
C       GCS(JJKD1-II,II)=GCS(IIKD-JJ1,JJ1)
C       GCS(JJKD2-II,II)=GCS(IIKD-JJ2,JJ2)
C       GCS(JJKD-II1,II1)=GCS(IIKD1-JJ,JJ)
C       GCS(JJKD1-II1,II1)=GCS(IIKD1-JJ1,JJ1)
C       GCS(JJKD2-II1,II1)=GCS(IIKD1-JJ2,JJ2)
C       GCS(JJKD-II2,II2)=GCS(IIKD2-JJ,JJ)
C       GCS(JJKD1-II2,II2)=GCS(IIKD2-JJ1,JJ1)
C       GCS(JJKD2-II2,II2)=GCS(IIKD2-JJ2,JJ2)
C       ENDIF
C
C       IF (II.LT.KK) THEN
        GCS(IIKD-KK,KK)=GCS(IIKD-KK,KK)+VXI*VXK
        GCS(IIKD-KK1,KK1)=GCS(IIKD-KK1,KK1)+VXI*VYK
        GCS(IIKD-KK2,KK2)=GCS(IIKD-KK2,KK2)+VXI*VZK
        GCS(IIKD1-KK,KK)=GCS(IIKD1-KK,KK)+VYI*VXK
        GCS(IIKD1-KK1,KK1)=GCS(IIKD1-KK1,KK1)+VYI*VYK
        GCS(IIKD1-KK2,KK2)=GCS(IIKD1-KK2,KK2)+VYI*VZK
        GCS(IIKD2-KK,KK)=GCS(IIKD2-KK,KK)+VZI*VXK
        GCS(IIKD2-KK1,KK1)=GCS(IIKD2-KK1,KK1)+VZI*VYK
        GCS(IIKD2-KK2,KK2)=GCS(IIKD2-KK2,KK2)+VZI*VZK
C       ELSE
C       GCS(KKKD-II,II)=GCS(IIKD-KK,KK)
C       GCS(KKKD1-II,II)=GCS(IIKD-KK1,KK1)
C       GCS(KKKD2-II,II)=GCS(IIKD-KK2,KK2)
C       GCS(KKKD-II1,II1)=GCS(IIKD1-KK,KK)
C       GCS(KKKD1-II1,II1)=GCS(IIKD1-KK1,KK1)
C       GCS(KKKD2-II1,II1)=GCS(IIKD1-KK2,KK2)
C       GCS(KKKD-II2,II2)=GCS(IIKD2-KK,KK)
C       GCS(KKKD1-II2,II2)=GCS(IIKD2-KK1,KK1)
C       GCS(KKKD2-II2,II2)=GCS(IIKD2-KK2,KK2)
C       ENDIF
C
C       IF (II.LT.LL) THEN
        GCS(IIKD-LL,LL)=GCS(IIKD-LL,LL)+VXI*VXL
        GCS(IIKD-LL1,LL1)=GCS(IIKD-LL1,LL1)+VXI*VYL
        GCS(IIKD-LL2,LL2)=GCS(IIKD-LL2,LL2)+VXI*VZL
        GCS(IIKD1-LL,LL)=GCS(IIKD1-LL,LL)+VYI*VXL
        GCS(IIKD1-LL1,LL1)=GCS(IIKD1-LL1,LL1)+VYI*VYL
        GCS(IIKD1-LL2,LL2)=GCS(IIKD1-LL2,LL2)+VYI*VZL
        GCS(IIKD2-LL,LL)=GCS(IIKD2-LL,LL)+VZI*VXL
        GCS(IIKD2-LL1,LL1)=GCS(IIKD2-LL1,LL1)+VZI*VYL
        GCS(IIKD2-LL2,LL2)=GCS(IIKD2-LL2,LL2)+VZI*VZL
C       ELSE
C       GCS(LLKD-II,II)=GCS(IIKD-LL,LL)
C       GCS(LLKD1-II,II)=GCS(IIKD-LL1,LL1)
C       GCS(LLKD2-II,II)=GCS(IIKD-LL2,LL2)
C       GCS(LLKD-II1,II1)=GCS(IIKD1-LL,LL)
C       GCS(LLKD1-II1,II1)=GCS(IIKD1-LL1,LL1)
C       GCS(LLKD2-II1,II1)=GCS(IIKD1-LL2,LL2)
C       GCS(LLKD-II2,II2)=GCS(IIKD2-LL,LL)
C       GCS(LLKD1-II2,II2)=GCS(IIKD2-LL1,LL1)
C       GCS(LLKD2-II2,II2)=GCS(IIKD2-LL2,LL2)
C       ENDIF
C
C       IF (JJ.LT.KK) THEN
        GCS(JJKD-KK,KK)=GCS(JJKD-KK,KK)+VXJ*VXK
        GCS(JJKD-KK1,KK1)=GCS(JJKD-KK1,KK1)+VXJ*VYK
        GCS(JJKD-KK2,KK2)=GCS(JJKD-KK2,KK2)+VXJ*VZK
        GCS(JJKD1-KK,KK)=GCS(JJKD1-KK,KK)+VYJ*VXK
        GCS(JJKD1-KK1,KK1)=GCS(JJKD1-KK1,KK1)+VYJ*VYK
        GCS(JJKD1-KK2,KK2)=GCS(JJKD1-KK2,KK2)+VYJ*VZK
        GCS(JJKD2-KK,KK)=GCS(JJKD2-KK,KK)+VZJ*VXK
        GCS(JJKD2-KK1,KK1)=GCS(JJKD2-KK1,KK1)+VZJ*VYK
        GCS(JJKD2-KK2,KK2)=GCS(JJKD2-KK2,KK2)+VZJ*VZK
C       ELSE
C       GCS(KKKD-JJ,JJ)=GCS(JJKD-KK,KK)
C       GCS(KKKD1-JJ,JJ)=GCS(JJKD-KK1,KK1)
C       GCS(KKKD2-JJ,JJ)=GCS(JJKD-KK2,KK2)
C       GCS(KKKD-JJ1,JJ1)=GCS(JJKD1-KK,KK)
C       GCS(KKKD1-JJ1,JJ1)=GCS(JJKD1-KK1,KK1)
C       GCS(KKKD2-JJ1,JJ1)=GCS(JJKD1-KK2,KK2)
C       GCS(KKKD-JJ2,JJ2)=GCS(JJKD2-KK,KK)
C       GCS(KKKD1-JJ2,JJ2)=GCS(JJKD2-KK1,KK1)
C       GCS(KKKD2-JJ2,JJ2)=GCS(JJKD2-KK2,KK2)
C       ENDIF
C
C       IF (JJ.LT.LL) THEN
        GCS(JJKD-LL,LL)=GCS(JJKD-LL,LL)+VXJ*VXL
        GCS(JJKD-LL1,LL1)=GCS(JJKD-LL1,LL1)+VXJ*VYL
        GCS(JJKD-LL2,LL2)=GCS(JJKD-LL2,LL2)+VXJ*VZL
        GCS(JJKD1-LL,LL)=GCS(JJKD1-LL,LL)+VYJ*VXL
        GCS(JJKD1-LL1,LL1)=GCS(JJKD1-LL1,LL1)+VYJ*VYL
        GCS(JJKD1-LL2,LL2)=GCS(JJKD1-LL2,LL2)+VYJ*VZL
        GCS(JJKD2-LL,LL)=GCS(JJKD2-LL,LL)+VZJ*VXL
        GCS(JJKD2-LL1,LL1)=GCS(JJKD2-LL1,LL1)+VZJ*VYL
        GCS(JJKD2-LL2,LL2)=GCS(JJKD2-LL2,LL2)+VZJ*VZL
C       ELSE
C       GCS(LLKD-JJ,JJ)=GCS(JJKD-LL,LL)
C       GCS(LLKD1-JJ,JJ)=GCS(JJKD-LL1,LL1)
C       GCS(LLKD2-JJ,JJ)=GCS(JJKD-LL2,LL2)
C       GCS(LLKD-JJ1,JJ1)=GCS(JJKD1-LL,LL)
C       GCS(LLKD1-JJ1,JJ1)=GCS(JJKD1-LL1,LL1)
C       GCS(LLKD2-JJ1,JJ1)=GCS(JJKD1-LL2,LL2)
C       GCS(LLKD-JJ2,JJ2)=GCS(JJKD2-LL,LL)
C       GCS(LLKD1-JJ2,JJ2)=GCS(JJKD2-LL1,LL1)
C       GCS(LLKD2-JJ2,JJ2)=GCS(JJKD2-LL2,LL2)
C       ENDIF
C
C       IF (KK.LT.LL) THEN
        GCS(KKKD-LL,LL)=GCS(KKKD-LL,LL)+VXK*VXL
        GCS(KKKD-LL1,LL1)=GCS(KKKD-LL1,LL1)+VXK*VYL
        GCS(KKKD-LL2,LL2)=GCS(KKKD-LL2,LL2)+VXK*VZL
        GCS(KKKD1-LL,LL)=GCS(KKKD1-LL,LL)+VYK*VXL
        GCS(KKKD1-LL1,LL1)=GCS(KKKD1-LL1,LL1)+VYK*VYL
        GCS(KKKD1-LL2,LL2)=GCS(KKKD1-LL2,LL2)+VYK*VZL
        GCS(KKKD2-LL,LL)=GCS(KKKD2-LL,LL)+VZK*VXL
        GCS(KKKD2-LL1,LL1)=GCS(KKKD2-LL1,LL1)+VZK*VYL
        GCS(KKKD2-LL2,LL2)=GCS(KKKD2-LL2,LL2)+VZK*VZL
C       ELSE
C       GCS(LLKD-KK,KK)=GCS(KKKD-LL,LL)
C       GCS(LLKD1-KK,KK)=GCS(KKKD-LL1,LL1)
C       GCS(LLKD2-KK,KK)=GCS(KKKD-LL2,LL2)
C       GCS(LLKD-KK1,KK1)=GCS(KKKD1-LL,LL)
C       GCS(LLKD1-KK1,KK1)=GCS(KKKD1-LL1,LL1)
C       GCS(LLKD2-KK1,KK1)=GCS(KKKD1-LL2,LL2)
C       GCS(LLKD-KK2,KK2)=GCS(KKKD2-LL,LL)
C       GCS(LLKD1-KK2,KK2)=GCS(KKKD2-LL1,LL1)
C       GCS(LLKD2-KK2,KK2)=GCS(KKKD2-LL2,LL2)
C       ENDIF
C
C END DAE
C
   40 CONTINUE

C FOR MAIN CHAIN VIRTUAL BONDS:
      DO 50 MM=1,NRES-1
        I=2*MM-1
        J=2*MM+1
C MM+2 FROM CA, SC, CA, SC ... IN X,Y,Z
        II=3*(I-1)+1
        II1=3*(I-1)+2
        II2=3*(I-1)+3
        JJ=3*(J-1)+1
        JJ1=3*(J-1)+2
        JJ2=3*(J-1)+3
C      PRINT *,'BOND I J',I,J
C ? CHARMM      IC=ICB(MM)
C ICB ARRAY CONTAINS POINTERS FOR BOND PARAMETERS
C       IF(IC.EQ.0) GOTO 50
C ? CHARMM      IF(CBC(IC).EQ.0) GOTO 50
C CBC IS FORCE CONSTANT OF BOND
        RX=X(I)-X(J)
        RY=Y(I)-Y(J)
        RZ=Z(I)-Z(J)
        S2=RX*RX + RY*RY + RZ*RZ
        S=SQRT(S2)
        IF (.NOT.NOCOOR) THEN
C DAE PUT S INTO COORDS: IT IS INTERNAL COORDINATE
          INTCOORDS(MM+NPHI+NTHETA+2*NSIDE)=S
        ENDIF
C DAE CALCULATE B-MATRIX ELEMENTS FOR THIS BOND
C DAE VAL IS 1-D ARRAY OF NON-ZERO B ELEMENTS
C INDX IS ARRAY OF THE IC(ROW) INDICES OF VAL
C JNDX IS ARRAY OF THE CART(COLUMN) INDICES OF VAL
        SR=1/S
        MMM=12*NPHI+9*NTHETA+24*NSIDE+6*(MM-1)+1
        SUMPHI=NPHI+NTHETA+2*NSIDE+MM
        RXSR=RX*SR
        RYSR=RY*SR
        RZSR=RZ*SR
        VAL(MMM)=RXSR
        INDX(MMM)=SUMPHI
        JNDX(MMM)=II
        BEEMATRIX(SUMPHI,II)=RXSR
C
        VAL(MMM+1)=RYSR
        INDX(MMM+1)=SUMPHI
        JNDX(MMM+1)=II1
        BEEMATRIX(SUMPHI,II1)=RYSR
C       
        VAL(MMM+2)=RZSR
        INDX(MMM+2)=SUMPHI
        JNDX(MMM+2)=II2
        BEEMATRIX(SUMPHI,II2)=RZSR
C      
        VAL(MMM+3)=-RXSR
        INDX(MMM+3)=SUMPHI
        JNDX(MMM+3)=JJ
        BEEMATRIX(SUMPHI,JJ)=-RXSR
C     
        VAL(MMM+4)=-RYSR
        INDX(MMM+4)=SUMPHI
        JNDX(MMM+4)=JJ1
        BEEMATRIX(SUMPHI,JJ1)=-RYSR
C    
        VAL(MMM+5)=-RZSR
        INDX(MMM+5)=SUMPHI
        JNDX(MMM+5)=JJ2
        BEEMATRIX(SUMPHI,JJ2)=-RZSR
C CALCULATE GEE FOR THIS IC
        VXI=VAL(MMM)
        VYI=VAL(MMM+1)
        VZI=VAL(MMM+2)
        GCS(KD1,II)=GCS(KD1,II)+VXI**2
        GCS(KD1+II-II1,II1)=GCS(KD1+II-II1,II1)+VXI*VYI
        GCS(KD1+II-II2,II2)=GCS(KD1+II-II2,II2)+VXI*VZI
        GCS(KD1,II1)=GCS(KD1,II1)+VYI**2
        GCS(KD1+II1-II2,II2)=GCS(KD1+II1-II2,II2)+VYI*VZI
        GCS(KD1,II2)=GCS(KD1,II2)+VZI**2
C
        VXJ=VAL(MMM+3)
        VYJ=VAL(MMM+4)
        VZJ=VAL(MMM+5)
        GCS(KD1,JJ)=GCS(KD1,JJ)+VXJ**2
        GCS(KD1+JJ-JJ1,JJ1)=GCS(KD1+JJ-JJ1,JJ1)+VXJ*VYJ
        GCS(KD1+JJ-JJ2,JJ2)=GCS(KD1+JJ-JJ2,JJ2)+VXJ*VZJ
        GCS(KD1,JJ1)=GCS(KD1,JJ1)+VYJ**2
        GCS(KD1+JJ1-JJ2,JJ2)=GCS(KD1+JJ1-JJ2,JJ2)+VYJ*VZJ
        GCS(KD1,JJ2)=GCS(KD1,JJ2)+VZJ**2
C
        IIKD=II+KD1
        IIKD1=II1+KD1
        IIKD2=II2+KD1
        JJKD=JJ+KD1
        JJKD1=JJ1+KD1
        JJKD2=JJ2+KD1
C
C       IF (II.LT.JJ) THEN
        GCS(IIKD-JJ,JJ)=GCS(IIKD-JJ,JJ)+VXI*VXJ
        GCS(IIKD-JJ1,JJ1)=GCS(IIKD-JJ1,JJ1)+VXI*VYJ
        GCS(IIKD-JJ2,JJ2)=GCS(IIKD-JJ2,JJ2)+VXI*VZJ
        GCS(IIKD1-JJ,JJ)=GCS(IIKD1-JJ,JJ)+VYI*VXJ
        GCS(IIKD1-JJ1,JJ1)=GCS(IIKD1-JJ1,JJ1)+VYI*VYJ
        GCS(IIKD1-JJ2,JJ2)=GCS(IIKD1-JJ2,JJ2)+VYI*VZJ
        GCS(IIKD2-JJ,JJ)=GCS(IIKD2-JJ,JJ)+VZI*VXJ
        GCS(IIKD2-JJ1,JJ1)=GCS(IIKD2-JJ1,JJ1)+VZI*VYJ
        GCS(IIKD2-JJ2,JJ2)=GCS(IIKD2-JJ2,JJ2)+VZI*VZJ
C END DAE
   50  CONTINUE
       
      IPASS=0
C FOR SIDE CHAIN BONDS:
      DO 60 MM=1,NRES
        IF (ITYPE(MM).EQ.10) GOTO 60
        IPASS=IPASS+1
        I=2*MM-1
        J=2*MM
        II=3*(I-1)+1
        II1=3*(I-1)+2
        II2=3*(I-1)+3
        JJ=3*(J-1)+1
        JJ1=3*(J-1)+2
        JJ2=3*(J-1)+3
C      PRINT *,'BOND I J',I,J
C ? CHARMM      IC=ICB(MM)
C ICB ARRAY CONTAINS POINTERS FOR BOND PARAMETERS
C       IF(IC.EQ.0) GOTO 10
C ? CHARMM      IF(CBC(IC).EQ.0) GOTO 10
C CBC IS FORCE CONSTANT OF BOND
        RX=X(I)-X(J)
        RY=Y(I)-Y(J)
        RZ=Z(I)-Z(J)
        S2=RX*RX + RY*RY + RZ*RZ
        S=SQRT(S2)
        IF (.NOT.NOCOOR) THEN
C DAE PUT S INTO COORDS: IT IS INTERNAL COORDINATE
          INTCOORDS(NPHI+NTHETA+2*NSIDE+NRES-1+IPASS)=S
        ENDIF
C DAE CALCULATE B-MATRIX ELEMENTS FOR THIS BOND
C DAE VAL IS 1-D ARRAY OF NON-ZERO B ELEMENTS
C INDX IS ARRAY OF THE IC(ROW) INDICES OF VAL
C JNDX IS ARRAY OF THE CART(COLUMN) INDICES OF VAL
        SR=1/S
        MMM=12*NPHI+9*NTHETA+24*NSIDE+6*(NRES-1)+6*(IPASS-1)+1
        SUMPHI=NPHI+NTHETA+2*NSIDE+NRES-1+IPASS
        RXSR=RX*SR
        RYSR=RY*SR
        RZSR=RZ*SR
        VAL(MMM)=RXSR
        INDX(MMM)=SUMPHI
        JNDX(MMM)=II
        BEEMATRIX(SUMPHI,II)=RXSR
C
        VAL(MMM+1)=RYSR
        INDX(MMM+1)=SUMPHI
        JNDX(MMM+1)=II1
        BEEMATRIX(SUMPHI,II1)=RYSR
C       
        VAL(MMM+2)=RZSR
        INDX(MMM+2)=SUMPHI
        JNDX(MMM+2)=II2
        BEEMATRIX(SUMPHI,II2)=RZSR
C      
        VAL(MMM+3)=-RXSR
        INDX(MMM+3)=SUMPHI
        JNDX(MMM+3)=JJ
        BEEMATRIX(SUMPHI,JJ)=-RXSR
C     
        VAL(MMM+4)=-RYSR
        INDX(MMM+4)=SUMPHI
        JNDX(MMM+4)=JJ1
        BEEMATRIX(SUMPHI,JJ1)=-RYSR
C    
        VAL(MMM+5)=-RZSR
        INDX(MMM+5)=SUMPHI
        JNDX(MMM+5)=JJ2
        BEEMATRIX(SUMPHI,JJ2)=-RZSR
C CALCULATE GEE FOR THIS IC
        VXI=VAL(MMM)
        VYI=VAL(MMM+1)
        VZI=VAL(MMM+2)
        GCS(KD1,II)=GCS(KD1,II)+VXI**2
        GCS(KD1+II-II1,II1)=GCS(KD1+II-II1,II1)+VXI*VYI
        GCS(KD1+II-II2,II2)=GCS(KD1+II-II2,II2)+VXI*VZI
        GCS(KD1,II1)=GCS(KD1,II1)+VYI**2
        GCS(KD1+II1-II2,II2)=GCS(KD1+II1-II2,II2)+VYI*VZI
        GCS(KD1,II2)=GCS(KD1,II2)+VZI**2
C
        VXJ=VAL(MMM+3)
        VYJ=VAL(MMM+4)
        VZJ=VAL(MMM+5)
        GCS(KD1,JJ)=GCS(KD1,JJ)+VXJ**2
        GCS(KD1+JJ-JJ1,JJ1)=GCS(KD1+JJ-JJ1,JJ1)+VXJ*VYJ
        GCS(KD1+JJ-JJ2,JJ2)=GCS(KD1+JJ-JJ2,JJ2)+VXJ*VZJ
        GCS(KD1,JJ1)=GCS(KD1,JJ1)+VYJ**2
        GCS(KD1+JJ1-JJ2,JJ2)=GCS(KD1+JJ1-JJ2,JJ2)+VYJ*VZJ
        GCS(KD1,JJ2)=GCS(KD1,JJ2)+VZJ**2
C
        IIKD=II+KD1
        IIKD1=II1+KD1
        IIKD2=II2+KD1
        JJKD=JJ+KD1
        JJKD1=JJ1+KD1
        JJKD2=JJ2+KD1
C
C       IF (II.LT.JJ) THEN
        GCS(IIKD-JJ,JJ)=GCS(IIKD-JJ,JJ)+VXI*VXJ
        GCS(IIKD-JJ1,JJ1)=GCS(IIKD-JJ1,JJ1)+VXI*VYJ
        GCS(IIKD-JJ2,JJ2)=GCS(IIKD-JJ2,JJ2)+VXI*VZJ
        GCS(IIKD1-JJ,JJ)=GCS(IIKD1-JJ,JJ)+VYI*VXJ
        GCS(IIKD1-JJ1,JJ1)=GCS(IIKD1-JJ1,JJ1)+VYI*VYJ
        GCS(IIKD1-JJ2,JJ2)=GCS(IIKD1-JJ2,JJ2)+VYI*VZJ
        GCS(IIKD2-JJ,JJ)=GCS(IIKD2-JJ,JJ)+VZI*VXJ
        GCS(IIKD2-JJ1,JJ1)=GCS(IIKD2-JJ1,JJ1)+VZI*VYJ
        GCS(IIKD2-JJ2,JJ2)=GCS(IIKD2-JJ2,JJ2)+VZI*VZJ
C END DAE
   60  CONTINUE
C
C ADD LOWER DIAGONAL ELEMENTS TO UPPER DIAGONAL. AVOID DOUBLING DIAGONAL
C BY LOOPING ONLY TO J1-1
       DO J1=1,KD
         DO I1=1,J1-1
           GCS(KD+1+I1-J1,J1)=GCS(KD+1+I1-J1,J1)+GCS(KD+1+J1-I1,I1)
         ENDDO
       ENDDO
       DO J1=KD+1,NCART
         DO I1=J1-KD,J1-1
           GCS(KD+1+I1-J1,J1)=GCS(KD+1+I1-J1,J1)+GCS(KD+1+J1-I1,I1)
         ENDDO
       ENDDO
       RETURN
       END
C
C SUBROUTINE TO DO LOADS OF COORDINATE TRANSFORMATIONS TO OBTAIN 
C NORMAL MODE FREQUENCIES VIA INTERNAL COORDINATE REPRESENTATION.
C CALLS GETBEE (RENAMED UNRSGETBEE) TO CALCULATE B-MATRIX
C
      SUBROUTINE INTSECDET(COORDS,NCART,KD,NNZ,NINTB,LAMBDA)
      USE COMMONS
      USE MODHESS
      USE MODUNRES
      IMPLICIT NONE
C
C NNZ IS NUMBER OF NON-ZERO ELEMENTS IN B-MATRIX
C NINTB IS NUMBER OF INTERNAL COORDINATES (INCLUDING BOND LENGTHS)
C NINTS IN COMMONS.F90 IS NUMBER OF MAIN CHAIN DIHEDRALS AND ANGLES, AND SIDE CHAIN DIHEDRALS & ANGLES 
C NOT INCLUDING GLYCINES
C NCART IS NUMBER OF CARTESIANS
C
      INTEGER NNZ,NCART,KD,K,NINTB
C
C     REAL*8 COORDS(6*NATOMS),INTCOORDS(NINTB),VAL(NNZ),GCS2(2*KD+1,NCART)
      REAL*8 COORDS(NCART),INTCOORDS(NINTB),VAL(NNZ),GCS2(2*KD+1,NCART)
      INTEGER INDX(NNZ),JNDX(NNZ),I1,J1,K1
      REAL*8 BEEMATRIX(NINTB,NCART)
C     REAL*8 BEENUMMATRIX(NINTB,NCART)
      REAL*8 GEE(NINTS,NINTS)
C     REAL*8 WORK(4*NINTS),LAMBDA(NCART),EVECIM(NINTS),CRAP(NINTS),CRAP2(NINTS)
      REAL*8 LAMBDA(NCART),EVECIM(NINTS),CRAP(NINTS),CRAP2(NINTS)
      REAL*8 KVEC(NINTS),WORK1(3*NINTS),A(NINTS,NINTS),TMPA(NINTS,NINTS)
      REAL*8 TMPG(NINTS,NINTS)
      REAL*8 NEWATMASS(NATOMS),P
C
C  ASSIGN ENOUGH MEMORY TO WORK FOR A BLOCKSIZE OF 32 TO BE POSSIBLE.
C  THIS IS FOR DSYEVR.
C
      INTEGER ILWORK, LWORK, NFOUND, ISUPPZ(2*NINTS), IWORK(10*NINTS), INFO
      DOUBLE PRECISION WORK(33*NINTS), ABSTOL, DLAMCH, ZZWORK(NINTS,NINTS)
      ABSTOL=DLAMCH( 'SAFE  MINIMUM' )
      LWORK=33*NINTS
C     ILWORK=33*NINTS
      ILWORK=10*NINTS
C
C     PRINT *,'TRANSFORM NINTB NCART NNZ',NINTB,NCART,NNZ
C
C INITIALISATION
C
      GEE=0.0D0
      TMPA=0.0D0
      A=0.0D0
      LAMBDA=0.0D0
C
C GET B-MATRIX
C
      CALL UNRSGETBEE(BEEMATRIX,COORDS,VAL,INDX,JNDX,NINTB,NCART,NNZ,GCS2,.TRUE.,KD,INTCOORDS)

C JMC FOR TESTING
C      CALL BEENUM(NINTB,NCART,COORDS,BEENUMMATRIX,NNZ,KD)
C      DO I1=1,NINTB-NRES+1-NSIDE
C         DO J1=1,NCART
C            IF (ABS(BEEMATRIX(I1,J1)-BEENUMMATRIX(I1,J1)).GE.0.1D-5) PRINT *,'MATRIX ELEMENTS',
C    &     I1,J1,'DIFFER (ANAL, NUM):',BEEMATRIX(I1,J1),BEENUMMATRIX(I1,J1)
C         END DO
C      END DO

      DO I1=1,NINTS
C JMC         DO J1=1,NINTS ! SINCE ONLY NEED UPPER TRIANGLE OF GEE TO PASS TO DSYEV
         DO J1=I1,NINTS
            DO K1=1,NATOMS
               GEE(I1,J1)=GEE(I1,J1)+BEEMATRIX(I1,3*(K1-1)+1)*BEEMATRIX(J1,3*(K1-1)+1)
     &         *1.0D3/ATMASS(K1) ! NOTE G -> KG !!!
               GEE(I1,J1)=GEE(I1,J1)+BEEMATRIX(I1,3*(K1-1)+2)*BEEMATRIX(J1,3*(K1-1)+2)
     &         *1.0D3/ATMASS(K1)
               GEE(I1,J1)=GEE(I1,J1)+BEEMATRIX(I1,3*(K1-1)+3)*BEEMATRIX(J1,3*(K1-1)+3)
     &         *1.0D3/ATMASS(K1)
            END DO
            IF (I1.EQ.1.AND.J1.EQ.1) PRINT *,'PRINTING TO MAKE MATRIX MULTIPLICATION WORK...'
         END DO
      END DO

C JMC TEST1 - IS GEE SYMMETRIC? COMMENTED OUT SINCE ONLY CALCULATE UPPER TRIANGLE OF GEE NOW.  TESTED, OK.
C     DO I1=1,NINTS
C         DO J1=1,NINTS
C            IF (ABS(GEE(I1,J1)-GEE(J1,I1)).GE.1.0D-5) PRINT *,'GEE NON SYMMETRIC ',I1,J1,GEE(I1,J1),GEE(J1,I1)
C         END DO
C     END DO
 
C
C WILSON FG METHOD: ENTIRELY EQUIVALENT, NEGLIGIBLE TIME DIFFERENCE COMPARED TO DOING THE TRANSFORMATIONS EXPLICITLY, 
C STEP-BY-STEP.  ***NEED TO MAKE THE FULL GEE MATRIX ABOVE, NOT JUST THE UPPER TRIANGLE***
C
C     DO I1=1,NINTS
C        DO J1=1,NINTS
C           HESS(I1,J1)=4.184D0*1.0D3*HESS(I1,J1)
C        ENDDO
C     ENDDO
C     A=MATMUL(GEE,HESS)
C     CALL DGEEV('N','N',NINTS,A,NINTS,LAMBDA(1:NINTS),EVECIM,CRAP,NINTS,CRAP2,NINTS,WORK,4*NINTS,INFO)
C     IF (INFO.NE.0) PRINT*,'WARNING - INFO=',INFO,' IN DGEEV'
C     GOTO 112
C WILSON GF METHOD

C
C FIND EIGENVALUES AND EIGENVECTORS OF GEE, WHICH ARE EIGENVALUES^-1 AND THE EIGENVECTORS THEMSELVES OF GEE^-1.
C PREVIOUSLY USED DSYEV (BELOW) BUT SWITCHED TO DSYEVR AS THE FORMER GAVE SUBSTANTIALLY DIFFERENT RESULTS WITH
C THE SUNPERF LIBRARIES AND LAPACK.F/BLAS.F COMPILED IN.  DSYEVR IS NOT PERFECT, BUT BETTER...
C
       CALL DSYEVR('V','A','U',NINTS,GEE,NINTS,0.0D0,1.0D0,1,2,ABSTOL,NFOUND,KVEC,ZZWORK,NINTS,ISUPPZ,WORK,
     1            LWORK, IWORK, ILWORK, INFO )

       IF (INFO.NE.0) PRINT*,'WARNING - INFO=',INFO,' IN DSYEVR'
C
C NOTE NOW ZZWORK IS THE MATRIX OF EIGENVECTORS, WAS GEE ITSELF FROM DSYEV!!!
C
C     CALL DSYEV('V','U',NINTS,GEE,NINTS,KVEC,WORK1,3*NINTS,INFO)
C     IF (INFO.NE.0) PRINT*,'WARNING - INFO=',INFO,' IN DSYEV'

C     DO J1=1,NINTS
C        PRINT *,'K ',KVEC(J1)
C     END DO

C NOW DO A = LUHU^TL
C WHERE L_IJ = DELTA_IJ/SQRT(K_I), WHERE K_I ARE THE EIGENVALUES OF GEE^-1, DIAGONAL)
 
C     DO I1=1,NINTS
C        LL(I1,I1)=DSQRT(KVEC(I1))
C     ENDDO
C     TMP1=MATMUL(TRANSPOSE(GEE),LL)
C     TMP2=MATMUL(HESS(:NINTS,:NINTS),TMP1)
C     TMP1=MATMUL(GEE,TMP2)
C     A=MATMUL(LL,TMP1)
C     A=4.184D0*A

      DO I1=1,NINTS
         DO J1=1,NINTS
            DO K1=1,NINTS
C              TMPA(I1,J1)=TMPA(I1,J1)+GEE(I1,K1)*HESS(K1,J1)*4.184D0*DSQRT(KVEC(I1))
               TMPA(I1,J1)=TMPA(I1,J1)+ZZWORK(I1,K1)*HESS(K1,J1)*4.184D0*1.0D3*DSQRT(KVEC(I1))
C FACTOR OF 4.184D0*1.0D3 FROM KCAL -> J IN HESS
            END DO
         END DO
      END DO

      DO I1=1,NINTS
         DO J1=1,NINTS
            DO K1=1,NINTS
C              A(I1,J1)=A(I1,J1)+TMPA(I1,K1)*GEE(J1,K1)*DSQRT(KVEC(J1))
               A(I1,J1)=A(I1,J1)+TMPA(I1,K1)*ZZWORK(J1,K1)*DSQRT(KVEC(J1))
            END DO
         END DO
      END DO

      CALL DGEEV('N','N',NINTS,A,NINTS,LAMBDA(1:NINTS),EVECIM,CRAP,NINTS,CRAP2,NINTS,WORK,4*NINTS,INFO)
      IF (INFO.NE.0) PRINT*,'WARNING - INFO=',INFO,' IN DGEEV'

112   CONTINUE
C     DO I1=1,NINTS
C        PRINT *,'EVALMIN ',LAMBDA(I1),I1
C        PRINT *,'EVALMIN ',EVECIM(I1),I1
C     END DO

C JMC SORT LAMBDAS
      DO 30 I1=1,NINTS-1
         K1=I1
         P=LAMBDA(I1)
         DO 10 J1=I1+1,NINTS
            IF (LAMBDA(J1).GE.P) THEN
               K1=J1
               P=LAMBDA(J1)
            ENDIF
10       CONTINUE
         IF (K1.NE.I1) THEN
            LAMBDA(K1)=LAMBDA(I1)
            LAMBDA(I1)=P
         ENDIF
30    CONTINUE

      RETURN
      END

      SUBROUTINE BEENUM(NINTB,NCART,COORDS,BEENUMMATRIX,NNZ,KD)
      USE MODUNRES
      IMPLICIT NONE

      INTEGER NNZ,NINTB,NCART,KD,K
C
C JMC      REAL*8 COORDS(6*NATOMS)
      REAL*8 COORDS(3*NCART)
      REAL*8 VAL(NNZ)
      INTEGER INDX(NNZ),JNDX(NNZ)
      INTEGER I1,J1
      REAL*8 GCS(KD+1,NCART),GCS2(2*KD+1,NCART)
C
      REAL*8 BEEMATRIX(NINTB,NCART),BEENUMMATRIX(NINTB,NCART)
      REAL*8 INTCOORDS(NINTB),NEWINTCOORDS(NINTB)

      INTCOORDS=0.0D0
      NEWINTCOORDS=0.0D0

      DO I1=1,NCART
         COORDS(I1)=COORDS(I1)+0.1D-5
         CALL UNRSGETBEE(BEEMATRIX,COORDS,VAL,INDX,JNDX,NINTB,NCART,NNZ,GCS2,.FALSE.,KD,INTCOORDS)

         COORDS(I1)=COORDS(I1)-0.2D-5
         CALL UNRSGETBEE(BEEMATRIX,COORDS,VAL,INDX,JNDX,NINTB,NCART,NNZ,GCS2,.FALSE.,KD,NEWINTCOORDS)

         COORDS(I1)=COORDS(I1)+0.1D-5

         DO J1=1,NINTB-NRES+1-NSIDE
C           PRINT *,'INTCOORDS1 ',INTCOORDS(J1),J1
C           PRINT *,'INTCOORDS2 ',NEWINTCOORDS(J1),J1
            BEENUMMATRIX(J1,I1)=(INTCOORDS(J1)-NEWINTCOORDS(J1))/0.2D-5
            IF ((INTCOORDS(J1)-NEWINTCOORDS(J1)).GE.3.1D0) THEN
              BEENUMMATRIX(J1,I1)=(INTCOORDS(J1)-NEWINTCOORDS(J1)-(2*3.141592653589793D0))/0.2D-5
            ELSE IF ((INTCOORDS(J1)-NEWINTCOORDS(J1)).LE.-3.1D0) THEN
              BEENUMMATRIX(J1,I1)=(INTCOORDS(J1)-NEWINTCOORDS(J1)+(2*3.141592653589793D0))/0.2D-5
            END IF
         END DO
      END DO

      RETURN
      END SUBROUTINE

