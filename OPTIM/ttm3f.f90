MODULE TTM3F_MOD
!----------------------------------------------------------------------------!
! PARAMETERS OF THE TTM3F POTENTIAL                                         !
!----------------------------------------------------------------------------!
! (12-10-6) INVERSE POLYNOMIAL + EXPONENTIAL PARAMETERS FOR THE VDW INERACTIONS
DOUBLE PRECISION, PARAMETER ::   &
                                 VDWC=-0.72298855D+03,VDWD=0.10211829D+06, VDWE=0.37170376D+01
! SMEARING FACTORS FOR DIPOLE-DIPOLE(ADD), CHARGE-CHARGE/CHARGE-DIPOLE(ACCACD)
DOUBLE PRECISION, PARAMETER :: ADD=0.175D0, ACCACD=0.175D0
!   ........... POLARIZABILITIES
DOUBLE PRECISION, PARAMETER :: POLARM=1.444D0
DOUBLE PRECISION, PARAMETER :: POLFACO=0.837D0, POLFACH = 0.496D0, POLFACM=0.837D0
DOUBLE PRECISION, PARAMETER :: DMS_PARAM1 =0.5D0,DMS_PARAM2 = 0.9578D0, DMS_PARAM3=0.012D0
!   ...........   GAMMAM
DOUBLE PRECISION, PARAMETER :: GAMMAM=0.46D0
!----------------------------------------------------------------------------!
! PARAMETERS RELATED TO THE ACCURACY OF THE ENERGY/DERIVATIVES CALCULATION   !
!----------------------------------------------------------------------------!
INTEGER, PARAMETER          :: MAXITER  = 400
DOUBLE PRECISION, PARAMETER :: DIPTOL   = 1.D-15 
DOUBLE PRECISION, PARAMETER :: DMIX     = 0.7D0
!----------------------------------------------------------------------------!
! CONSTANTS                                                                  !
!----------------------------------------------------------------------------!
DOUBLE PRECISION, PARAMETER :: CHARGECON = 18.22234397655801030455D0
DOUBLE PRECISION, PARAMETER :: DEBYE  = 4.8033324D0
!----------------------------------------------------------------------------!
! VARIABLES AND ALLOCATABLE ARRAYS NEEDED BY THE "TTM3F" SUBROUTINE         !
!----------------------------------------------------------------------------!
INTEGER :: FO, LO, FH, LH, FM, LM, FO3, LO3, FH3, LH3, FM3, LM3
INTEGER :: NW_OLD
INTEGER :: NATS, NATSD, NATSQ
DOUBLE PRECISION, DIMENSION(:,:), ALLOCATABLE :: RM
DOUBLE PRECISION, DIMENSION(:,:), ALLOCATABLE :: DRM
DOUBLE PRECISION, DIMENSION(:,:), ALLOCATABLE :: DDT
DOUBLE PRECISION, DIMENSION( : ), ALLOCATABLE :: DIP
DOUBLE PRECISION, DIMENSION( : ), ALLOCATABLE :: PR_DIP
DOUBLE PRECISION, DIMENSION( : ), ALLOCATABLE :: EFQ
DOUBLE PRECISION, DIMENSION( : ), ALLOCATABLE :: EFD
DOUBLE PRECISION, DIMENSION( : ), ALLOCATABLE :: CHARGE
DOUBLE PRECISION, DIMENSION( : ), ALLOCATABLE :: PHI
DOUBLE PRECISION, DIMENSION(:,:,:,:), ALLOCATABLE :: GRDQ
END MODULE TTM3F_MOD
!*** PARAMETERS USED FOR THE CALCULATION OF THE POTENTIAL ENERGY AND THE
!*** DIPOLE MOMENT OF THE WATER MONOMER. TAKEN FROM:
!*** "H. PARTRIDGE AND D. W. SCHWENKE, J. CHEM. PHYS. 106, 4618 (1997)"
MODULE MNASA_MOD
IMPLICIT NONE
INTEGER, DIMENSION(245,3) :: IDX
INTEGER, DIMENSION(84 ,3) :: IDXD
DOUBLE PRECISION, DIMENSION(84) :: COEFD
DOUBLE PRECISION, DIMENSION(245) :: C5ZA, CBASIS, CCORE, CREST
INTEGER, DIMENSION(9,3) :: IDXM
DOUBLE PRECISION, DIMENSION(9) :: CMASS 
DOUBLE PRECISION :: REOH,THETAE,B1,ROH,ALPHAOH,DEOHA,PHH1A,PHH2
DOUBLE PRECISION :: F5Z,FBASIS,FCORE,FREST
DOUBLE PRECISION :: A,B,C0,C1,C2,B1D
DATA IDX(:,1)/  &
       1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2,  &
       2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2,  &
       2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3,  &
       3, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 3,  &
       3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4,  &
       4, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 4, 4, 4, 4, 4, 4, 4, 4,  &
       4, 4, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 6, 6, 6, 6, 6, 6, 6, 6,  &
       6, 6, 4, 4, 4, 4, 4, 4, 4, 4, 4, 5, 5, 5, 5, 5, 5, 5, 5, 5,  &
       6, 6, 6, 6, 6, 6, 6, 6, 6, 7, 7, 7, 7, 7, 7, 7, 7, 7, 5, 5,  &
       5, 5, 5, 5, 5, 5, 6, 6, 6, 6, 6, 6, 6, 6, 7, 7, 7, 7, 7, 7,  &
       7, 7, 8, 8, 8, 8, 8, 8, 8, 8, 5, 5, 5, 5, 5, 5, 5, 6, 6, 6,  &
       6, 6, 6, 6, 7, 7, 7, 7, 7, 7, 7, 8, 8, 8, 8, 8, 8, 8, 9, 9,  &
       9, 9, 9, 9, 9/
DATA IDX(:,2)/ &
       1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,  &
       1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2,  &
       2, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2,  &
       2, 2, 2, 2, 2, 2, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 3,  &
       3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2,  &
       2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 3, 3, 3, 3, 3, 3, 3, 3,  &
       3, 3, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 1, 1, 1, 1, 1, 1,  &
       1, 1, 4, 4, 4, 4, 4, 4, 4, 4, 4, 3, 3, 3, 3, 3, 3, 3, 3, 3,  &
       2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 4, 4,  &
       4, 4, 4, 4, 4, 4, 3, 3, 3, 3, 3, 3, 3, 3, 2, 2, 2, 2, 2, 2,  &
       2, 2, 1, 1, 1, 1, 1, 1, 1, 1, 5, 5, 5, 5, 5, 5, 5, 4, 4, 4,  &
       4, 4, 4, 4, 3, 3, 3, 3, 3, 3, 3, 2, 2, 2, 2, 2, 2, 2, 1, 1,  &
       1, 1, 1, 1, 1/
DATA IDX(:,3)/ &
       1, 2, 3, 4, 5, 6, 7, 8, 9,10,11,12,13,14,15, 1, 2, 3, 4, 5,  &
       6, 7, 8, 9,10,11,12,13,14, 1, 2, 3, 4, 5, 6, 7, 8, 9,10,11,  &
      12,13, 1, 2, 3, 4, 5, 6, 7, 8, 9,10,11,12,13, 1, 2, 3, 4, 5,  &
       6, 7, 8, 9,10,11,12, 1, 2, 3, 4, 5, 6, 7, 8, 9,10,11,12, 1,  &
       2, 3, 4, 5, 6, 7, 8, 9,10,11, 1, 2, 3, 4, 5, 6, 7, 8, 9,10,  &
      11, 1, 2, 3, 4, 5, 6, 7, 8, 9,10,11, 1, 2, 3, 4, 5, 6, 7, 8,  &
       9,10, 1, 2, 3, 4, 5, 6, 7, 8, 9,10, 1, 2, 3, 4, 5, 6, 7, 8,  &
       9,10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 1, 2, 3, 4, 5, 6, 7, 8, 9,  &
       1, 2, 3, 4, 5, 6, 7, 8, 9, 1, 2, 3, 4, 5, 6, 7, 8, 9, 1, 2,  &
       3, 4, 5, 6, 7, 8, 1, 2, 3, 4, 5, 6, 7, 8, 1, 2, 3, 4, 5, 6,  &
       7, 8, 1, 2, 3, 4, 5, 6, 7, 8, 1, 2, 3, 4, 5, 6, 7, 1, 2, 3,  &
       4, 5, 6, 7, 1, 2, 3, 4, 5, 6, 7, 1, 2, 3, 4, 5, 6, 7, 1, 2,  &
       3, 4, 5, 6, 7/
DATA C5ZA(1:245)/  &
       4.2278462684916D+04, 4.5859382909906D-02, 9.4804986183058D+03, &
       7.5485566680955D+02, 1.9865052511496D+03, 4.3768071560862D+02, &
       1.4466054104131D+03, 1.3591924557890D+02,-1.4299027252645D+03, &
       6.6966329416373D+02, 3.8065088734195D+03,-5.0582552618154D+02, &
      -3.2067534385604D+03, 6.9673382568135D+02, 1.6789085874578D+03, &
      -3.5387509130093D+03,-1.2902326455736D+04,-6.4271125232353D+03, &
      -6.9346876863641D+03,-4.9765266152649D+02,-3.4380943579627D+03, &
       3.9925274973255D+03,-1.2703668547457D+04,-1.5831591056092D+04, &
       2.9431777405339D+04, 2.5071411925779D+04,-4.8518811956397D+04, &
      -1.4430705306580D+04, 2.5844109323395D+04,-2.3371683301770D+03, &
       1.2333872678202D+04, 6.6525207018832D+03,-2.0884209672231D+03, &
      -6.3008463062877D+03, 4.2548148298119D+04, 2.1561445953347D+04, &
      -1.5517277060400D+05, 2.9277086555691D+04, 2.6154026873478D+05, &
      -1.3093666159230D+05,-1.6260425387088D+05, 1.2311652217133D+05, &
      -5.1764697159603D+04, 2.5287599662992D+03, 3.0114701659513D+04, &
      -2.0580084492150D+03, 3.3617940269402D+04, 1.3503379582016D+04, &
      -1.0401149481887D+05,-6.3248258344140D+04, 2.4576697811922D+05, &
       8.9685253338525D+04,-2.3910076031416D+05,-6.5265145723160D+04, &
       8.9184290973880D+04,-8.0850272976101D+03,-3.1054961140464D+04, &
      -1.3684354599285D+04, 9.3754012976495D+03,-7.4676475789329D+04, &
      -1.8122270942076D+05, 2.6987309391410D+05, 4.0582251904706D+05, &
      -4.7103517814752D+05,-3.6115503974010D+05, 3.2284775325099D+05, &
       1.3264691929787D+04, 1.8025253924335D+05,-1.2235925565102D+04, &
      -9.1363898120735D+03,-4.1294242946858D+04,-3.4995730900098D+04, &
       3.1769893347165D+05, 2.8395605362570D+05,-1.0784536354219D+06, &
      -5.9451106980882D+05, 1.5215430060937D+06, 4.5943167339298D+05, &
      -7.9957883936866D+05,-9.2432840622294D+04, 5.5825423140341D+03, &
       3.0673594098716D+03, 8.7439532014842D+04, 1.9113438435651D+05, &
      -3.4306742659939D+05,-3.0711488132651D+05, 6.2118702580693D+05, &
      -1.5805976377422D+04,-4.2038045404190D+05, 3.4847108834282D+05, &
      -1.3486811106770D+04, 3.1256632170871D+04, 5.3344700235019D+03, &
       2.6384242145376D+04, 1.2917121516510D+05,-1.3160848301195D+05, &
      -4.5853998051192D+05, 3.5760105069089D+05, 6.4570143281747D+05, &
      -3.6980075904167D+05,-3.2941029518332D+05,-3.5042507366553D+05, &
       2.1513919629391D+03, 6.3403845616538D+04, 6.2152822008047D+04, &
      -4.8805335375295D+05,-6.3261951398766D+05, 1.8433340786742D+06, &
       1.4650263449690D+06,-2.9204939728308D+06,-1.1011338105757D+06, &
       1.7270664922758D+06, 3.4925947462024D+05,-1.9526251371308D+04, &
      -3.2271030511683D+04,-3.7601575719875D+05, 1.8295007005531D+05, &
       1.5005699079799D+06,-1.2350076538617D+06,-1.8221938812193D+06, &
       1.5438780841786D+06,-3.2729150692367D+03, 1.0546285883943D+04, &
      -4.7118461673723D+04,-1.1458551385925D+05, 2.7704588008958D+05, &
       7.4145816862032D+05,-6.6864945408289D+05,-1.6992324545166D+06, &
       6.7487333473248D+05, 1.4361670430046D+06,-2.0837555267331D+05, &
       4.7678355561019D+05,-1.5194821786066D+04,-1.1987249931134D+05, &
       1.3007675671713D+05, 9.6641544907323D+05,-5.3379849922258D+05, &
      -2.4303858824867D+06, 1.5261649025605D+06, 2.0186755858342D+06, &
      -1.6429544469130D+06,-1.7921520714752D+04, 1.4125624734639D+04, &
      -2.5345006031695D+04, 1.7853375909076D+05,-5.4318156343922D+04, &
      -3.6889685715963D+05, 4.2449670705837D+05, 3.5020329799394D+05, &
       9.3825886484788D+03,-8.0012127425648D+05, 9.8554789856472D+04, &
       4.9210554266522D+05,-6.4038493953446D+05,-2.8398085766046D+06, &
       2.1390360019254D+06, 6.3452935017176D+06,-2.3677386290925D+06, &
      -3.9697874352050D+06,-1.9490691547041D+04, 4.4213579019433D+04, &
       1.6113884156437D+05,-7.1247665213713D+05,-1.1808376404616D+06, &
       3.0815171952564D+06, 1.3519809705593D+06,-3.4457898745450D+06, &
       2.0705775494050D+05,-4.3778169926622D+05, 8.7041260169714D+03, &
       1.8982512628535D+05,-2.9708215504578D+05,-8.8213012222074D+05, &
       8.6031109049755D+05, 1.0968800857081D+06,-1.0114716732602D+06, &
       1.9367263614108D+05, 2.8678295007137D+05,-9.4347729862989D+04, &
       4.4154039394108D+04, 5.3686756196439D+05, 1.7254041770855D+05, &
      -2.5310674462399D+06,-2.0381171865455D+06, 3.3780796258176D+06, &
       7.8836220768478D+05,-1.5307728782887D+05,-3.7573362053757D+05, &
       1.0124501604626D+06, 2.0929686545723D+06,-5.7305706586465D+06, &
      -2.6200352535413D+06, 7.1543745536691D+06,-1.9733601879064D+04, &
       8.5273008477607D+04, 6.1062454495045D+04,-2.2642508675984D+05, &
       2.4581653864150D+05,-9.0376851105383D+05,-4.4367930945690D+05, &
       1.5740351463593D+06, 2.4563041445249D+05,-3.4697646046367D+03, &
      -2.1391370322552D+05, 4.2358948404842D+05, 5.6270081955003D+05, &
      -8.5007851251980D+05,-6.1182429537130D+05, 5.6690751824341D+05, &
      -3.5617502919487D+05,-8.1875263381402D+02,-2.4506258140060D+05, &
       2.5830513731509D+05, 6.0646114465433D+05,-6.9676584616955D+05, &
       5.1937406389690D+05, 1.7261913546007D+05,-1.7405787307472D+04, &
      -3.8301842660567D+05, 5.4227693205154D+05, 2.5442083515211D+06, &
      -1.1837755702370D+06,-1.9381959088092D+06,-4.0642141553575D+05, &
       1.1840693827934D+04,-1.5334500255967D+05, 4.9098619510989D+05, &
       6.1688992640977D+05, 2.2351144690009D+05,-1.8550462739570D+06, &
       9.6815110649918D+03,-8.1526584681055D+04,-8.0810433155289D+04, &
       3.4520506615177D+05, 2.5509863381419D+05,-1.3331224992157D+05, &
      -4.3119301071653D+05,-5.9818343115856D+04, 1.7863692414573D+03, &
       8.9440694919836D+04,-2.5558967650731D+05,-2.2130423988459D+04, &
       4.4973674518316D+05,-2.2094939343618D+05/
!
!     EXPANSION COEFFICIENTS FOR BASIS CORRECTION
!
DATA CBASIS(1:245)/ &
       6.9770019624764D-04,-2.4209870001642D+01, 1.8113927151562D+01, &
       3.5107416275981D+01,-5.4600021126735D+00,-4.8731149608386D+01, &
       3.6007189184766D+01, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
      -7.7178474355102D+01,-3.8460795013977D+01,-4.6622480912340D+01, &
       5.5684951167513D+01, 1.2274939911242D+02,-1.4325154752086D+02, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00,-6.0800589055949D+00, &
       8.6171499453475D+01,-8.4066835441327D+01,-5.8228085624620D+01, &
       2.0237393793875D+02, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       3.3525582670313D+02, 7.0056962392208D+01,-4.5312502936708D+01, &
      -3.0441141194247D+02, 2.8111438108965D+02, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00,-1.2983583774779D+02, 3.9781671212935D+01, &
      -6.6793945229609D+01,-1.9259805675433D+02, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00,-8.2855757669957D+02,-5.7003072730941D+01, &
      -3.5604806670066D+01, 9.6277766002709D+01, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 8.8645622149112D+02,-7.6908409772041D+01, &
       6.8111763314154D+01, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       2.5090493428062D+02,-2.3622141780572D+02, 5.8155647658455D+02, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 2.8919570295095D+03, &
      -1.7871014635921D+02,-1.3515667622500D+02, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00,-3.6965613754734D+03, 2.1148158286617D+02, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00,-1.4795670139431D+03, &
       3.6210798138768D+02, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
      -5.3552886800881D+03, 3.1006384016202D+02, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 1.6241824368764D+03, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 4.3764909606382D+03, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 1.0940849243716D+03, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 3.0743267832931D+03, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00/
!
!     EXPANSION COEFFICIENTS FOR CORE CORRECTION
!
DATA CCORE(1:245)/ &
       2.4332191647159D-02,-2.9749090113656D+01, 1.8638980892831D+01, &
      -6.1272361746520D+00, 2.1567487597605D+00,-1.5552044084945D+01, &
       8.9752150543954D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
      -3.5693557878741D+02,-3.0398393196894D+00,-6.5936553294576D+00, &
       1.6056619388911D+01, 7.8061422868204D+01,-8.6270891686359D+01, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00,-3.1688002530217D+01, &
       3.7586725583944D+01,-3.2725765966657D+01,-5.6458213299259D+00, &
       2.1502613314595D+01, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       5.2789943583277D+02,-4.2461079404962D+00,-2.4937638543122D+01, &
      -1.1963809321312D+02, 2.0240663228078D+02, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00,-6.2574211352272D+02,-6.9617539465382D+00, &
      -5.9440243471241D+01, 1.4944220180218D+01, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00,-1.2851139918332D+03,-6.5043516710835D+00, &
       4.0410829440249D+01,-6.7162452402027D+01, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 1.0031942127832D+03, 7.6137226541944D+01, &
      -2.7279242226902D+01, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
      -3.3059000871075D+01, 2.4384498749480D+01,-1.4597931874215D+02, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 1.6559579606045D+03, &
       1.5038996611400D+02,-7.3865347730818D+01, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00,-1.9738401290808D+03,-1.4149993809415D+02, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00,-1.2756627454888D+02, &
       4.1487702227579D+01, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
      -1.7406770966429D+03,-9.3812204399266D+01, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00,-1.1890301282216D+03, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 2.3723447727360D+03, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00,-1.0279968223292D+03, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 5.7153838472603D+02, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00/
!
!     EXPANSION COEFFICIENTS FOR V REST
!
DATA CREST(1:245)/ &
       0.0000000000000D+00,-4.7430930170000D+00,-1.4422132560000D+01, &
      -1.8061146510000D+01, 7.5186735000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
      -2.7962099800000D+02, 1.7616414260000D+01,-9.9741392630000D+01, &
       7.1402447000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00,-7.8571336480000D+01, &
       5.2434353250000D+01, 7.7696745000000D+01, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       1.7799123760000D+02, 1.4564532380000D+02, 2.2347226000000D+02, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00,-4.3823284100000D+02,-7.2846553000000D+02, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00,-2.6752313750000D+02, 3.6170310000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00, 0.0000000000000D+00, &
       0.0000000000000D+00, 0.0000000000000D+00/
!
!     EXPANSION INDICIES FOR MASS CORRECTION
!
       DATA IDXM/1,2,1,1,3,2,1,2,1, &
                 2,1,1,3,1,2,2,1,1, &
                 1,1,2,1,1,1,2,2,3/
!
!     EXPANSION COEFFICIENTS FOR MASS CORRECTION
!
       DATA CMASS/ -8.3554183D+00,3.7036552D+01,-5.2722136D+00, &
            1.6843857D+01,-7.0929741D+01,5.5380337D+00,-2.9962997D+01, &
            1.3637682D+02,-3.0530195D+00/
!
!     TWO BODY PARAMETERS
!
       DATA REOH,THETAE,B1,ROH,ALPHAOH,DEOHA,PHH1A,PHH2/0.958649D0, &
            104.3475D0,2.0D0,0.9519607159623009D0,2.587949757553683D0, &
            42290.92019288289D0,16.94879431193463D0,12.66426998162947D0/
!
!     SCALING FACTORS FOR CONTRIBUTIONS TO EMPERICAL POTENTIAL
!
       DATA F5Z,FBASIS,FCORE,FREST/0.99967788500000D0, &
           0.15860145369897D0,-1.6351695982132D0,1D0/

!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
DATA IDXD(1:84,1)/ &
       1, 1, 1, 2, 1, 1, 1, 2, 2, 3, 1, 1, 1, 1, 2, 2, 2, 3, 3, 4, &
       1, 1, 1, 1, 1, 2, 2, 2, 2, 3, 3, 3, 4, 4, 5, 1, 1, 1, 1, 1, &
       1, 2, 2, 2, 2, 2, 3, 3, 3, 3, 4, 4, 4, 5, 5, 6, 1, 1, 1, 1, &
       1, 1, 1, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 4, 4, 4, 4, 5, 5, &
       5, 6, 6, 7/ 
DATA IDXD(1:84,2)/ &
       1, 1, 2, 1, 1, 2, 3, 1, 2, 1, 1, 2, 3, 4, 1, 2, 3, 1, 2, 1, &
       1, 2, 3, 4, 5, 1, 2, 3, 4, 1, 2, 3, 1, 2, 1, 1, 2, 3, 4, 5, &
       6, 1, 2, 3, 4, 5, 1, 2, 3, 4, 1, 2, 3, 1, 2, 1, 1, 2, 3, 4, &
       5, 6, 7, 1, 2, 3, 4, 5, 6, 1, 2, 3, 4, 5, 1, 2, 3, 4, 1, 2, &
       3, 1, 2, 1/
DATA IDXD(1:84,3)/ &
       1, 2, 1, 1, 3, 2, 1, 2, 1, 1, 4, 3, 2, 1, 3, 2, 1, 2, 1, 1, &
       5, 4, 3, 2, 1, 4, 3, 2, 1, 3, 2, 1, 2, 1, 1, 6, 5, 4, 3, 2, &
       1, 5, 4, 3, 2, 1, 4, 3, 2, 1, 3, 2, 1, 2, 1, 1, 7, 6, 5, 4, &
       3, 2, 1, 6, 5, 4, 3, 2, 1, 5, 4, 3, 2, 1, 4, 3, 2, 1, 3, 2, &
       1, 2, 1, 1/
DATA COEFD(1:84) /&
      -2.1689686086730D-03, 1.4910379754728D-02, 5.3546078430060D-02, &
      -7.4055995388666D-02,-3.7764333017616D-03, 1.4089887256484D-01, &
      -6.2584207687264D-02,-1.1260393113022D-01,-5.7824159269319D-02, &
       1.4360743650655D-02,-1.5469680141070D-02,-1.3036350092795D-02, &
       2.7515837781556D-02, 1.4098478875076D-01,-2.7663168397781D-02, &
      -5.2378176254797D-03,-1.0237198381792D-02, 8.9571999265473D-02, &
       7.2920263098603D-03,-2.6873260551686D-01, 2.0220870325864D-02, &
      -7.0764766270927D-02, 1.2140640273760D-01, 2.0978491966341D-02, &
      -1.9443840512668D-01, 4.0826835370618D-02,-4.5365190474650D-02, &
       6.2779900072132D-02,-1.3194351021000D-01,-1.4673032718563D-01, &
       1.1894031277247D-01,-6.4952851564679D-03, 8.8503610374493D-02, &
       1.4899437409291D-01, 1.3962841511565D-01,-2.6459446720450D-02, &
      -5.0128914532773D-02, 1.8329676428116D-01,-1.5559089125095D-01, &
      -4.0176879767592D-02, 3.6192059996636D-01, 1.0202887240343D-01, &
       1.9318668580051D-01,-4.3435977107932D-01,-4.2080828803311D-02, &
       1.9144626027273D-01,-1.7851138969948D-01, 1.0524533875070D-01, &
      -1.7954071602185D-02, 5.2022455612120D-02,-2.8891891146828D-01, &
      -4.7452036576319D-02,-1.0939400546289D-01, 3.5916564473568D-01, &
      -2.0162789820172D-01,-3.5838629543696D-01, 5.6706523551202D-03, &
       1.3849337488211D-01,-4.1733982195604D-01, 4.1641570764241D-01, &
      -1.2243429796296D-01, 4.7141730971228D-02,-1.8224510249551D-01, &
      -1.8880981556620D-01,-3.1992359561800D-01,-1.8567550546587D-01, &
       6.1850530431280D-01,-6.1142756235141D-02,-1.6996135584933D-01, &
       5.4252879499871D-01, 6.6128603899427D-01, 1.2107016404639D-02, &
      -1.9633639729189D-01, 2.7652059420824D-03,-2.2684111109778D-01, &
      -4.7924491598635D-01, 2.4287790137314D-01,-1.4296023329441D-01, &
       8.9664665907006D-02,-1.4003228575602D-01,-1.3321543452254D-01,&
      -1.8340983193745D-01, 2.3426707273520D-01, 1.5141050914514D-01/
DATA B1D/1.D0/
DATA A,B,C0,C1,C2/0.2999D0,-0.6932D0,1.0099D0,-0.1801D0,0.0892D0/

END MODULE MNASA_MOD

FUNCTION GAMMA1(X)
IMPLICIT NONE
DOUBLE PRECISION :: X
DOUBLE PRECISION :: GAMMA1
INTEGER :: J
DOUBLE PRECISION :: SER,STP,TMP,Y
DOUBLE PRECISION, DIMENSION(6) :: COF
SAVE COF,STP
DATA COF,STP/76.18009172947146D0,-86.50532032941677D0,24.01409824083091D0,  &
            -1.231739572450155D0,.1208650973866179D-2,-.5395239384953D-5, &
            2.5066282746310005D0/
Y=X
TMP=X+5.5D0
TMP=(X+0.5D0)*DLOG(TMP)-TMP
SER=1.000000000190015D0
DO J=1,6
   Y=Y+1.D0
   SER=SER+COF(J)/Y
ENDDO
GAMMA1=TMP+DLOG(STP*SER/X)
END FUNCTION GAMMA1
FUNCTION GAMMA4(A,X)
IMPLICIT NONE
DOUBLE PRECISION :: GAMMA4
DOUBLE PRECISION :: A, X
DOUBLE PRECISION :: GAMSER, GAMMCF, GLN
IF (X<A+1.D0) THEN
   CALL GAMMA2(GAMSER, A, X, GLN)
   GAMMA4 = 1.D0 - GAMSER
ELSE
   CALL GAMMA3(GAMMCF, A, X, GLN)
   GAMMA4 = GAMMCF
ENDIF
END FUNCTION GAMMA4
SUBROUTINE GAMMA2(GAMSER, A, X, GLN)
IMPLICIT NONE
DOUBLE PRECISION :: GAMSER
DOUBLE PRECISION :: A, X, GLN
INTEGER          :: N
INTEGER, PARAMETER :: ITMAX = 800
DOUBLE PRECISION, PARAMETER :: EPS = 3.D-7
DOUBLE PRECISION :: AP, SSUM, DEL, GAMMA1
GLN = GAMMA1(A)
AP = A
SSUM = 1.D0 / A
DEL =SSUM
DO N=1, ITMAX
   AP = AP+1.D0
   DEL = DEL*X/AP
   SSUM = SSUM+DEL
   IF (DABS(DEL) .LT. DABS(SSUM)*EPS) GOTO 1
ENDDO
1 GAMSER = SSUM*DEXP(-X+A*DLOG(X)-GLN)
END SUBROUTINE GAMMA2
SUBROUTINE GAMMA3(GAMMCF, A, X, GLN)
IMPLICIT NONE
DOUBLE PRECISION :: GAMMCF
DOUBLE PRECISION :: A, X, GLN
INTEGER          :: I
DOUBLE PRECISION :: AN, B, C, D, DEL, H, GAMMA1
INTEGER,PARAMETER :: ITMAX = 100
DOUBLE PRECISION, PARAMETER :: EPS = 3.D-7, FPMIN=1.D-30
GLN = GAMMA1(A)
B = X+1.D0-A
C = 1.D0/FPMIN
D = 1.D0/B
H=D
DO I=1, ITMAX
   AN = -I*(I-A)
   B = B+2.D0
   D = AN*D+B
   IF (DABS(D) < FPMIN) D=FPMIN
   C = B+AN/C
   IF (DABS(C) < FPMIN) C=FPMIN
   D = 1.D0/D
   DEL = D*C
   H = H*DEL
   IF (DABS(DEL-1.D0) < EPS) GOTO 1
ENDDO
1 GAMMCF=DEXP(-X+A*DLOG(X)-GLN)*H
END SUBROUTINE GAMMA3
SUBROUTINE SMEAR01(DRSQ, POL12, A, TS0, TS1)
IMPLICIT NONE
DOUBLE PRECISION, PARAMETER :: G23=1.3541179394264D0
DOUBLE PRECISION, INTENT(IN) :: DRSQ, POL12, A
DOUBLE PRECISION, INTENT(OUT) :: TS0, TS1
DOUBLE PRECISION :: DD,DRI,DRSQI,AA, RA,RA3,EXP1, A_SQRT3 
DOUBLE PRECISION, EXTERNAL :: GAMMA4

DD = DSQRT(DRSQ)
DRI = 1.D0/DD
DRSQI = DRI*DRI

AA = (POL12)**(1.D0/6.D0)
RA = DD/AA
RA3 = RA**3
EXP1 = DEXP(-A*RA3)
A_SQRT3 = A**(1.D0/3.D0)

TS0 = (1.D0-EXP1 + A_SQRT3*RA*G23*GAMMA4(2.D0/3.D0,A*RA3))*DRI
TS1 = (1.D0 -EXP1)*DRI*DRSQI
END SUBROUTINE SMEAR01
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
SUBROUTINE SMEAR1(DRSQ, POL12, A, TS1)
IMPLICIT NONE
DOUBLE PRECISION, INTENT(IN) :: DRSQ, POL12, A
DOUBLE PRECISION, INTENT(OUT) :: TS1
DOUBLE PRECISION :: DD,DRI,DRSQI,AA, RA,RA3,EXP1
DOUBLE PRECISION, EXTERNAL :: GAMMA4

DD = DSQRT(DRSQ)
DRI = 1.D0/DD
DRSQI = DRI*DRI

AA = (POL12)**(1.D0/6.D0)
RA = DD/AA
RA3 = RA**3
EXP1 = DEXP(-A*RA3)
TS1 = (1.D0 -EXP1)*DRI*DRSQI
END SUBROUTINE SMEAR1
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
SUBROUTINE SMEAR2(DRSQ, POL12, A, TS1, TS2)
IMPLICIT NONE
DOUBLE PRECISION, INTENT(IN) :: DRSQ, POL12, A
DOUBLE PRECISION, INTENT(OUT) :: TS1, TS2
DOUBLE PRECISION :: DD,DRI,DRSQI,AA, RA,RA3,EXP1

DD = DSQRT(DRSQ)
DRI = 1.D0/DD
DRSQI = DRI*DRI

AA = (POL12)**(1.D0/6.D0)
RA = DD/AA
RA3 = RA**3
EXP1 = DEXP(-A*RA3)
TS1 = (1.D0 -EXP1)*DRI*DRSQI
TS2 = (TS1 - EXP1*A/AA**3) *DRSQI
END SUBROUTINE SMEAR2
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
SUBROUTINE SMEAR3(DRSQ, POL12, A, TS1, TS2, TS3)
IMPLICIT NONE
DOUBLE PRECISION, INTENT(IN) :: DRSQ, POL12, A
DOUBLE PRECISION, INTENT(OUT) :: TS1, TS2, TS3
DOUBLE PRECISION :: DD,DRI,DRSQI,AA, RA,RA3,EXP1

DD = DSQRT(DRSQ)
DRI = 1.D0/DD
DRSQI = DRI*DRI

AA = (POL12)**(1.D0/6.D0)
RA = DD/AA
RA3 = RA**3
EXP1 = DEXP(-A*RA3)
TS1 = (1.D0 -EXP1)*DRI*DRSQI
TS2 = (TS1 - EXP1*A/AA**3) *DRSQI
TS3 = (TS2 - 0.6D0*EXP1*DD*A*A/AA**6) * DRSQI

END SUBROUTINE SMEAR3

!***
!***  ALLOCATE NECESSERY ARRAYS NEEDED FOR THE CALCULATION OF THE POTENIAL
!***
SUBROUTINE INIT_TTM3F(NW)
USE TTM3F_MOD
IMPLICIT NONE
INTEGER, INTENT(IN) :: NW
LOGICAL :: ALLOC


IF (.NOT. ALLOCATED(RM)) THEN
   ALLOC = .TRUE.
ELSE IF (NW/=NW_OLD) THEN
   ALLOC = .TRUE.
   DEALLOCATE( RM )    ! TEMPORARY ARRAY KEEPING THE COORDINATES OF THE MSITE
   DEALLOCATE( DRM )   ! TEMPORARY ARRAY KEEPING THE DERIVATIVES OF THE MSITE
   DEALLOCATE( DDT )   ! DIPOLE TENSOR
   DEALLOCATE( DIP )   ! ARRAY CONTAING THE INDUCED DIPOLES
   DEALLOCATE( PR_DIP )  ! 
   DEALLOCATE( PHI )    ! ELECTROSTATIC POTENTIAL
   DEALLOCATE( EFQ )     ! ELECTRIC FIELD FROM CHARGES
   DEALLOCATE( EFD )     ! ELECTRIC FIELD FROM DIPOLES
   DEALLOCATE( CHARGE )  ! CHARGES 
   DEALLOCATE( GRDQ )    ! DERICATIVES OF CHARGE WRT MONOMER GEOMETRY
ELSE
   ALLOC = .FALSE.
ENDIF

IF (ALLOC) THEN
   NATSQ = 3*NW       ! # OF ATOMS WITH CHARGE   (INCLUDING M-SITES)
   NATSD =   NW       ! # OF ATOMS WITH DIPOLE   (INCLUDING M-SITES)
   NATS  = 4*NW       ! # OF TOTAL ATOMS         (INCLUDING M-SITES)
   NW_OLD = NW
   FO = 1             ! INDEX ON THE FIRST OXYGEN
   LO = NW            ! INDEX ON THE LAST OXYGEN        
   FH = NW+1          ! INDEX ON THE FIRST HYDROGEN
   LH = 3*NW          ! INDEX ON THE LAST HYDROGEN
   FM = 3*NW+1        ! INDEX ON THE FIRST M-SITE
   LM = 4*NW          ! INDEX ON THE LST M-SITE
   FO3 = 3*FO-2  ! INDEX ON THE X-COMP. (OUT OF THE X,Y,Z) OF THE FIRST OXYGEN
   LO3 = 3*LO    ! INDEX ON THE X-COMP. (OUT OF THE X,Y,Z) OF THE LAST OXYGEN
   FH3 = 3*FH-2  ! INDEX ON THE X-COMP. (OUT OF THE X,Y,Z) OF THE FIRST HYDROGEN
   LH3 = 3*LH    ! INDEX ON THE X-COMP. (OUT OF THE X,Y,Z) OF THE LAST HYDROGEN
   FM3 = 3*FM-2  ! INDEX ON THE X-COMP. (OUT OF THE X,Y,Z) OF THE FIRST M-SITE
   LM3 = 3*LM    ! INDEX ON THE X-COMP. (OUT OF THE X,Y,Z) OF THE LAST M-SITE

   ALLOCATE(CHARGE(FO:LM))          
   ALLOCATE(RM (3, FM:LM))          
   ALLOCATE(DRM(3, FM:LM))         
   ALLOCATE(DIP(FM3:LM3))
   ALLOCATE(PR_DIP(FM3:LM3))
   ALLOCATE(PHI(FH:LM))
   ALLOCATE(EFQ(FO3:LM3))
   ALLOCATE(EFD(FM3:LM3))
   ALLOCATE( DDT(FM3:LM3, FM3:LM3) )
   ALLOCATE( GRDQ(NW, 3, 3, 3) )
ENDIF

END SUBROUTINE INIT_TTM3F
SUBROUTINE TTM3F(NW,RR,DRR,EN)
!** FOR A SYSTEM OF "NW" WATER MOLECULES RETURNS THE POTENTIAL ENERGY (EN) AND 
!** THE DERIVATIVES OF THE ENERGY WRT THE ATOMIC DISPLACEMENTS (DRR).
!** THE COORDINATES OF THE ATOMS ARE FOUND IN THE ARRAY "RR".
!** NOTE. IT IS VERY IMPORTANT THE INPUT COORDINATES TO BE STORED IN THE
!** ARRAY RR IN THE PROPER WAY. THE FIRST COLUMN OF RR HAS DIMENSION 3 THAT
!** CORRESPONDS TO THE X,Y,Z- CARTESIAN COORDINATES, WHILE IN THE SECOND ONE 
!** ALL THE OXYGENS OF THE SYSTEM SHOULD BE SAVED BEFORE THE HYDROGENS.
!** IT FOLLOWS AN EXAMPLE FOR A SYSTEM WITH 3-WATER MOLECULES (NW=3)
!**   RR(1:3, 1)   = X,Y,Z-COORDINATES OF THE OXYGEN OF THE FIRST MOLECULE
!**   RR(1:3, 2)   = X,Y,Z-COORDINATES OF THE OXYGEN OF THE SECOND MOLECULE
!**   RR(1:3, 3)   = X,Y,Z-COORDINATES OF THE OXYGEN OF THE THIRD MOLECULE
!**   RR(1:3, 4)   = X,Y,Z-COORDINATES OF THE HYDROGEN-1 OF THE FIRST MOLECULE
!**   RR(1:3, 5)   = X,Y,Z-COORDINATES OF THE HYDROGEN-2 OF THE FIRST MOLECULE
!**   RR(1:3, 6)   = X,Y,Z-COORDINATES OF THE HYDROGEN-1 OF THE SECOND MOLECULE
!**   RR(1:3, 7)   = X,Y,Z-COORDINATES OF THE HYDROGEN-2 OF THE SECOND MOLECULE
!**   RR(1:3, 8)   = X,Y,Z-COORDINATES OF THE HYDROGEN-1 OF THE THIRD MOLECULE
!**   RR(1:3, 9)   = X,Y,Z-COORDINATES OF THE HYDROGEN-2 OF THE THIRD MOLECULE
USE TTM3F_MOD
IMPLICIT NONE
INTEGER, INTENT(IN) :: NW
DOUBLE PRECISION, DIMENSION(3, 3*NW), INTENT(IN)  ::  RR
DOUBLE PRECISION, DIMENSION(3, 3*NW), INTENT(OUT) :: DRR
DOUBLE PRECISION, INTENT(OUT) :: EN
!
INTEGER :: ITER, I3, J3, ISP, JSP, IX, IY, IW, JW, IAT, JAT, IO, IH1, IH2, IM
DOUBLE PRECISION, DIMENSION(3) :: RI, RIJ
DOUBLE PRECISION, DIMENSION(3,3) :: R1, DR1, DD3
DOUBLE PRECISION, DIMENSION(3) :: Q3, DI, DJ, DERIJ
DOUBLE PRECISION, DIMENSION(3,3,3) :: DQ3
DOUBLE PRECISION :: DRIJSQ, DRIJ, DR6, DR10, DR12
DOUBLE PRECISION :: EINT, EVDW, EELEC, EIND, E1
DOUBLE PRECISION :: DELTADIP,TMP,EXPON, STATH, DIDJ, DIR, DJR,QI,QJ
DOUBLE PRECISION :: TS0, TS1, TS2, TS3

!-------------------------------------------------------------------------!
! INITIALIZE (IF NECCESARY) SOME ARRAYS, NEEDED FOR FOLLOWING CALCULATIONS!
!-------------------------------------------------------------------------!
CALL INIT_TTM3F(NW)
DRR = 0.D0
DRM = 0.D0
EINT = 0.D0
EVDW = 0.D0
EELEC = 0.D0
EIND = 0.D0
EFQ = 0.D0
PHI = 0.D0
DDT = 0.D0
!-------------------------------------------------------------------------!
! CALCULATE THE COORDINATES OF THE MSITES AND STORE THEM IN RM            !
!-------------------------------------------------------------------------!
DO IW=1, NW
   IO  = FO + IW-1
   IH1 = FH + 2*IW - 2
   IH2 = FH + 2*IW - 1
   IM  = FM + IW-1
   RM(1:3,IM) = RR(1:3,IO)*(1.D0-GAMMAM) + &
                           0.5D0*GAMMAM*( RR(1:3,IH1) + RR(1:3,IH2) )
ENDDO
!-------------------------------------------------------------------------!
! CALCULATES THE INTRA-MOLECULAR ENERGY AND DIPOLE MOMENT SURFACE         !
!                     ACCORDING THE PARTRIDGE SW  (JCP     )              !
!-------------------------------------------------------------------------!
TMP = 0.5D0*GAMMAM/(1.D0-GAMMAM)
DO IW=1, NW
   IO  = FO + IW-1
   IH1 = FH+2*IW-2
   IH2 = FH+2*IW-1
   IM  = FM + IW-1
   R1(1:3, 1:3) = RR(1:3, (/IO, IH1, IH2/) )
   CALL POT_NASA(R1, DR1, E1)
   CALL DMS_NASA(R1, Q3, DQ3)
   EINT = EINT + E1
   DRR(1:3, (/IO,IH1,IH2/) ) = DR1
   CHARGE(IH1)  = Q3(2)+TMP*(Q3(2)+Q3(3) )
   CHARGE(IH2)  = Q3(3)+TMP*(Q3(2)+Q3(3) )
   CHARGE(IM )  = Q3(1) / (1.D0-GAMMAM)
   GRDQ(IW,1,1,:)= DQ3(1,1,:) + TMP*(DQ3(1,1,:)+DQ3(1,2,:))
   GRDQ(IW,2,1,:)= DQ3(2,1,:) + TMP*(DQ3(2,1,:)+DQ3(2,2,:))
   GRDQ(IW,3,1,:)= DQ3(3,1,:) + TMP*(DQ3(3,1,:)+DQ3(3,2,:))

   GRDQ(IW,1,2,:)= DQ3(1,2,:) + TMP*(DQ3(1,1,:)+DQ3(1,2,:))
   GRDQ(IW,2,2,:)= DQ3(2,2,:) + TMP*(DQ3(2,1,:)+DQ3(2,2,:))
   GRDQ(IW,3,2,:)= DQ3(3,2,:) + TMP*(DQ3(3,1,:)+DQ3(3,2,:))

   GRDQ(IW,1,3,:)= DQ3(1,3,:)-2.D0*TMP*(DQ3(1,1,:)+DQ3(1,2,:))
   GRDQ(IW,2,3,:)= DQ3(2,3,:)-2.D0*TMP*(DQ3(2,1,:)+DQ3(2,2,:))
   GRDQ(IW,3,3,:)= DQ3(3,3,:)-2.D0*TMP*(DQ3(3,1,:)+DQ3(3,2,:))
ENDDO
CHARGE = CHARGE*CHARGECON
GRDQ   = GRDQ*CHARGECON
!-------------------------------------------------------------------------!
! CALCULATE THE CHARGE-CHARGE INTERACTIONS FOR ALL ATOMS                  !
!-------------------------------------------------------------------------!
DO IW=1, NW-1
   DO JW=IW+1, NW
      !OXYGEN-OXYGEN INTERACTIONS
      IAT=FO+IW-1          ! IAT=OXYGEN-1   
      JAT=FO+JW-1          ! JAT=OXYGEN-2
      RIJ=RR(:,IAT) - RR(:,JAT)
      DRIJSQ=RIJ(1)*RIJ(1) + RIJ(2)*RIJ(2) + RIJ(3)*RIJ(3)
      DRIJ = DSQRT(DRIJSQ)
      !... VDW INTERACTIONS
      DR6 = DRIJSQ**3
      DR10=DR6*DRIJSQ*DRIJSQ
      DR12=DR6*DR6
      EXPON = VDWD*DEXP(-VDWE*DRIJ)
      EVDW = EVDW + VDWC/DR6 + EXPON
      TMP=-(6.D0*VDWC/DR6)/DRIJSQ -VDWE*EXPON/DRIJ
      DRR(:,IAT) = DRR(:,IAT) + TMP * RIJ
      DRR(:,JAT) = DRR(:,JAT) - TMP * RIJ
      !HYDROGEN-HYDROGEN INTERACTIONS
      DO ISP=1, 2
         IAT=FH+2*(IW-1)+ ISP-1   ! IAT=HYDROGEN-1A/HYDROGEN-1B
         RI = RR(1:3, IAT)
         DO JSP=1, 2
            JAT=FH+2*(JW-1)+ JSP-1   ! JAT=HYDROGEN-2A/HYDROGEN-2B
            RIJ = RI - RR(1:3, JAT)
            DRIJSQ=RIJ(1)*RIJ(1) + RIJ(2)*RIJ(2) + RIJ(3)*RIJ(3)
            CALL SMEAR01(DRIJSQ, POLFACH**2, ACCACD, TS0, TS1)
            PHI(IAT) = PHI(IAT) + TS0*CHARGE(JAT)
            PHI(JAT) = PHI(JAT) + TS0*CHARGE(IAT)
            EFQ(3*IAT-2:3*IAT) = EFQ(3*IAT-2:3*IAT) + TS1*CHARGE(JAT)*RIJ
            EFQ(3*JAT-2:3*JAT) = EFQ(3*JAT-2:3*JAT) - TS1*CHARGE(IAT)*RIJ
         ENDDO
      ENDDO
      !MSITE-MSITE INTERACTIONS
      IAT=FM+IW-1          ! IAT=MSITE-1   
      JAT=FM+JW-1          ! JAT=MSITE-2
      RIJ=RM(:,IAT) - RM(:,JAT)
      DRIJSQ=RIJ(1)*RIJ(1) + RIJ(2)*RIJ(2) + RIJ(3)*RIJ(3)
      CALL SMEAR01(DRIJSQ, POLFACM**2, ACCACD, TS0, TS1)
      PHI(IAT) = PHI(IAT) + TS0*CHARGE(JAT)
      PHI(JAT) = PHI(JAT) + TS0*CHARGE(IAT)
      EFQ(3*IAT-2:3*IAT) = EFQ(3*IAT-2:3*IAT) + TS1*CHARGE(JAT)*RIJ
      EFQ(3*JAT-2:3*JAT) = EFQ(3*JAT-2:3*JAT) - TS1*CHARGE(IAT)*RIJ
   ENDDO
ENDDO
DO IW=1, NW
   DO JW=1, NW
      IF (IW/=JW) THEN
         !MSITE-HYDROGEN INTERACTIONS
         IAT = FM + IW -1   ! IAT=MSITE
         RI = RM(1:3, IAT)
         DO JSP=1,2
            JAT = FH+2*(JW-1) + JSP-1  !JAT = HYDROGEN-2
            RIJ = RI - RR(1:3, JAT)
            DRIJSQ=RIJ(1)*RIJ(1) + RIJ(2)*RIJ(2) + RIJ(3)*RIJ(3)
            CALL SMEAR01(DRIJSQ, POLFACH*POLFACM, ACCACD, TS0, TS1)
            PHI(IAT) = PHI(IAT) + TS0*CHARGE(JAT)
            PHI(JAT) = PHI(JAT) + TS0*CHARGE(IAT)
            EFQ(3*IAT-2:3*IAT) = EFQ(3*IAT-2:3*IAT) + TS1*CHARGE(JAT)*RIJ
            EFQ(3*JAT-2:3*JAT) = EFQ(3*JAT-2:3*JAT) - TS1*CHARGE(IAT)*RIJ
         ENDDO
      ENDIF 
   ENDDO
ENDDO
!-------------------------------------------------------------------------!
! CALCULATE THE DIPOLE-DIPOLE TENSOR ARRAY.  (ACCORDING TO THE THOLES   --!  
!   MODEL THE INTRA-MOLECULAR INTERACTIONS  SHOULD BE ALSO CONSIDERED)  --!
!-------------------------------------------------------------------------!
DO IAT=FM, LM-1
   I3=3*IAT-2
   RI = RM(:, IAT)
   DO JAT=IAT+1, LM
      J3=3*JAT-2
      RIJ = RI - RM(:, JAT)
      DRIJSQ=RIJ(1)*RIJ(1) + RIJ(2)*RIJ(2) + RIJ(3)*RIJ(3)
      CALL SMEAR2(DRIJSQ, POLFACM**2, ADD, TS1, TS2)
      DD3(1,1) = 3.D0*TS2*RIJ(1)*RIJ(1) - TS1
      DD3(2,2) = 3.D0*TS2*RIJ(2)*RIJ(2) - TS1
      DD3(3,3) = 3.D0*TS2*RIJ(3)*RIJ(3) - TS1
      DD3(1,2) = 3.D0*TS2*RIJ(1)*RIJ(2)
      DD3(1,3) = 3.D0*TS2*RIJ(1)*RIJ(3)
      DD3(2,3) = 3.D0*TS2*RIJ(2)*RIJ(3)
      DD3(2,1)=DD3(1,2); DD3(3,1)=DD3(1,3); DD3(3,2)=DD3(2,3)
      DDT(I3:I3+2, J3:J3+2) = DD3
      DDT(J3:J3+2, I3:I3+2) = DD3
   ENDDO  ! DO JAT=IAT+1, NATSD
ENDDO  ! DO IAT=1, NATSD
!-------------------------------------------------------------------------!
! CALCULATE THE INDUCED ELECTRIC FIELD USING AN ITERATIVE PROCED.         !
!-------------------------------------------------------------------------!
DIP(FM3:LM3) = POLARM*EFQ(FM3:LM3)
PR_DIP(FM3:LM3) = DIP(FM3:LM3)   ! KEEP THE PREVIOUS DIPOLE

STATH = DEBYE/CHARGECON/DSQRT(DBLE(NATSD))
DO ITER=1, MAXITER
   EFD = MATMUL(DDT, DIP)
   DIP(FM3:LM3) = POLARM*( EFQ(FM3:LM3) + EFD(FM3:LM3) )
   DIP(FM3:LM3) = DMIX*DIP(FM3:LM3) + (1.D0-DMIX)*PR_DIP(FM3:LM3)
   DELTADIP = SUM(  (DIP(FM3:LM3)-PR_DIP(FM3:LM3))**2  )
   DELTADIP = DSQRT(DELTADIP)*STATH
!   PRINT*,'ITER=',ITER, DELTADIP
   IF (DELTADIP<DIPTOL) THEN
      GOTO 100
   ELSE
      PR_DIP(FM3:LM3) = DIP(FM3:LM3)
   ENDIF
ENDDO
100 CONTINUE
EELEC = 0.5D0*SUM(CHARGE(FH:LM)*PHI(FH:LM))
EIND = -0.5D0*SUM(DIP(FM3:LM3)*EFQ(FM3:LM3))
EN = EINT + EVDW + EELEC + EIND
!PRINT*,'EINT=',EINT; PRINT*,'EVDW', EVDW; PRINT*,'EELEC=',EELEC; PRINT*,'EIND=',EIND
!-------------------------------------------------------------------------!
!---------  CALCULATE THE REMAINING PART OF THE DERIVATIVES   ------------!
!-------------------------------------------------------------------------!
!....... DERIVATIVES DUE TO CHARGE-CHARGE INTERACTION
DO IAT=FH, LH
   DRR(:,IAT) = DRR(:,IAT) - CHARGE(IAT)*EFQ(3*IAT-2:3*IAT)
ENDDO
DO IAT=FM, LM
   DRM(:,IAT) = DRM(:,IAT) - CHARGE(IAT)*EFQ(3*IAT-2:3*IAT)
ENDDO
!....... DERIVATIVES DUE TO CHARGE-DIPOLE AND DIPOLE-DIPOLE INTERACTION
DO IW=1, NW-1
   DO JW=IW+1, NW
      !MSITE-MSITE INTERACTIONS
      IAT=FM+IW-1          ! IAT=MSITE-1   
      JAT=FM+JW-1          ! JAT=MSITE-2
      RIJ=RM(:,IAT) - RM(:,JAT)
      DRIJSQ=RIJ(1)*RIJ(1) + RIJ(2)*RIJ(2) + RIJ(3)*RIJ(3)
      CALL SMEAR3(DRIJSQ, POLFACM**2, ADD, TS1, TS2, TS3)
      QI = CHARGE(IAT)
      QJ = CHARGE(JAT)
      DI = DIP(3*IAT-2:3*IAT)  ! DIPOLE-I
      DJ = DIP(3*JAT-2:3*JAT)  ! DIPOLE-J
      DIDJ = DI(1)*DJ(1) + DI(2)*DJ(2) + DI(3)*DJ(3)
      DIR = DI(1)*RIJ(1) + DI(2)*RIJ(2) + DI(3)*RIJ(3)
      DJR = DJ(1)*RIJ(1) + DJ(2)*RIJ(2) + DJ(3)*RIJ(3)
      DERIJ=-3.D0*TS2*(DIDJ*RIJ+DJR*DI+DIR*DJ) + 15.D0*TS3*DIR*DJR*RIJ 
      DERIJ=DERIJ-3.D0*TS2*QI*DJR*RIJ + TS1*QI*DJ
      DERIJ=DERIJ+3.D0*TS2*QJ*DIR*RIJ - TS1*QJ*DI
      DRM(:,IAT) = DRM(:,IAT) + DERIJ 
      DRM(:,JAT) = DRM(:,JAT) - DERIJ 
      PHI(IAT) = PHI(IAT) + TS1*DJR
      PHI(JAT) = PHI(JAT) - TS1*DIR
   ENDDO
ENDDO
!HYDROGEN-MSITE INTERACTIONS
DO IW=1, NW
   IAT = FM + IW -1   ! IAT=MSITE
   QI = CHARGE(IAT)         ! CHARGE-I
   DI = DIP(3*IAT-2:3*IAT)
   RI = RM(1:3, IAT)
   DO JW=1, NW
      IF (IW/=JW) THEN
         DO JSP=1,2
            JAT = FH+2*(JW-1) + JSP-1  !JAT = HYDROGEN-2
            QJ = CHARGE(JAT)         ! CHARGE-J
            RIJ = RI - RR(1:3, JAT)
            DRIJSQ=RIJ(1)*RIJ(1) + RIJ(2)*RIJ(2) + RIJ(3)*RIJ(3)
            CALL SMEAR2(DRIJSQ, POLFACH*POLFACM, ACCACD, TS1, TS2)
            DIR  = DI(1)*RIJ(1) + DI(2)*RIJ(2) + DI(3)*RIJ(3)
            DERIJ=   3.D0*TS2*QJ*DIR*RIJ - TS1*QJ*DI
            DRM(:,IAT) = DRM(:,IAT) + DERIJ
            DRR(:,JAT) = DRR(:,JAT) - DERIJ
            PHI(JAT) = PHI(JAT)-TS1*DIR
         ENDDO
      ENDIF
   ENDDO
ENDDO
!----DERIVATIVES FROM THE ADJUSTABLE CHARGES OF THE NASA PES
DO IW=1,NW
   IO  = FO + IW-1
   IH1 = FH + 2*IW-2
   IH2 = FH + 2*IW-1
   IM  = FM + IW-1
   DRR(:,IH1)=DRR(:,IH1)+(GRDQ(IW,1,1,:)*PHI(IH1)+  &
                          GRDQ(IW,1,2,:)*PHI(IH2)+GRDQ(IW,1,3,:)*PHI(IM))
   DRR(:,IH2)=DRR(:,IH2)+(GRDQ(IW,2,1,:)*PHI(IH1)+  & 
                          GRDQ(IW,2,2,:)*PHI(IH2)+GRDQ(IW,2,3,:)*PHI(IM))
   DRR(:,IO )=DRR(:,IO )+(GRDQ(IW,3,1,:)*PHI(IH1)+  &  
                          GRDQ(IW,3,2,:)*PHI(IH2)+GRDQ(IW,3,3,:)*PHI(IM))
ENDDO
!-------------------------------------------------------------------------!
!-- REDISTRIBUTE THE DERS FROM THE SITES (H,H,M) TO THE ATOMS (O,H,H)     !
!-------------------------------------------------------------------------!
DO IW=1, NW
   IO  = FO + IW-1
   IH1 = FH + 2*IW-2
   IH2 = FH + 2*IW-1
   IM  = FM + IW-1
   DRR(:,IH1) = DRR(:,IH1) +  0.5D0*GAMMAM*DRM(:,IM)
   DRR(:,IH2) = DRR(:,IH2) +  0.5D0*GAMMAM*DRM(:,IM)
   DRR(:, IO) = DRR(:, IO) + (1.D0-GAMMAM)*DRM(:,IM)
ENDDO

END SUBROUTINE TTM3F
SUBROUTINE POT_NASA(R1, DR1, E1)
!****
!**** CALCULATES THE ENERGY (E1) AND THE DERIVATIVES (DR1) OF A WATER MONOMER
!**** (COORDINATES IN THE ARRAY R1). THE POTENTIAL HAS BEEN DEVELOPED BY
!**** "H. PARTRIDGE AND D. W. SCHWENKE, J. CHEM. PHYS. 106, 4618 (1997)".
!**** SOME EXTRA CODE FOR THE CALCULATION OF THE ENERGY DERIVATIVES HAS BEEN
!**** ADDED  BY C. J. BURNHAM.
!****
USE MNASA_MOD
IMPLICIT NONE
DOUBLE PRECISION, DIMENSION(3, 3), INTENT(IN) :: R1
DOUBLE PRECISION, DIMENSION(3, 3), INTENT(OUT) :: DR1
DOUBLE PRECISION, INTENT(OUT) :: E1
DOUBLE PRECISION, DIMENSION(3) :: ROH1, ROH2, RHH
DOUBLE PRECISION, DIMENSION(0:15,3) :: FMAT
DOUBLE PRECISION :: DROH1, DROH2, DROH1OH2, DRHH
DOUBLE PRECISION :: VA, VB, VC
DOUBLE PRECISION :: DVA1,DVA2,DVB, DVCDR1, DVCDR2, DVCDCTH, SUM0,SUM1,SUM2,SUM3
DOUBLE PRECISION :: X1, X2, X3
DOUBLE PRECISION :: COSTHE, COSTH, SINTH
DOUBLE PRECISION :: EXP1, EXP2, EFAC
INTEGER          :: I, J, INI, INJ, INK, IX, IY
DOUBLE PRECISION :: DEOH, PHH1
DOUBLE PRECISION, DIMENSION(245) :: C5Z
DOUBLE PRECISION :: P1, P2, PL1, PL2, PC0

ROH1(:) = R1(1:3, 2) - R1(1:3,1)
ROH2(:) = R1(1:3, 3) - R1(1:3,1)
RHH(:)  = R1(1:3, 2) - R1(1:3,3)
DROH1 = DSQRT(DOT_PRODUCT(ROH1, ROH1))
DROH2 = DSQRT(DOT_PRODUCT(ROH2, ROH2))
DRHH  = DSQRT(DOT_PRODUCT(RHH , RHH ))
COSTH = (ROH1(1)*ROH2(1) + ROH1(2)*ROH2(2) + ROH1(3)*ROH2(3) ) / (DROH1*DROH2)


C5Z = F5Z*C5ZA + FBASIS*CBASIS + FCORE*CCORE + FREST*CREST
DEOH = F5Z*DEOHA
PHH1 = F5Z*PHH1A
PHH1 = PHH1*DEXP(PHH2)

COSTHE = -.24780227221366464506D0

EXP1 = DEXP(-ALPHAOH*(DROH1-ROH))
EXP2 = DEXP(-ALPHAOH*(DROH2-ROH))
VA = DEOH*(EXP1*(EXP1-2.D0)+EXP2*(EXP2-2.D0))
VB  = PHH1*DEXP(-PHH2*DRHH)
DVA1= 2.D0*ALPHAOH*DEOH*EXP1*(1.D0-EXP1)/DROH1
DVA2= 2.D0*ALPHAOH*DEOH*EXP2*(1.D0-EXP2)/DROH2
DVB = -PHH2*VB/DRHH
X1 = (DROH1-REOH)/REOH
X2 = (DROH2-REOH)/REOH
X3 = COSTH - COSTHE
FMAT(0,1:3) = 0.D0
FMAT(1,1:3) = 1.D0
DO J=2,15
   FMAT(J,1) = FMAT(J-1,1)*X1
   FMAT(J,2) = FMAT(J-1,2)*X2
   FMAT(J,3) = FMAT(J-1,3)*X3
ENDDO

EFAC = DEXP(-B1*(  (DROH1-REOH)**2 + (DROH2-REOH)**2))

SUM0 = 0.D0; SUM1 = 0.D0; SUM2 = 0.D0; SUM3 = 0.D0
DO J=2,245
   INI = IDX(J,1)
   INJ = IDX(J,2)
   INK = IDX(J,3)
   SUM0 = SUM0 + C5Z(J) *  ( FMAT(INI,1)*FMAT(INJ,2) +   &
        FMAT(INJ,1)*FMAT(INI,2)) *FMAT(INK,3) 
   SUM1 = SUM1 + C5Z(J) *  ( DBLE(INI-1)*FMAT(INI-1,1)*FMAT(INJ,2) +   &
        DBLE(INJ-1)*FMAT(INJ-1,1)*FMAT(INI,2)  )*FMAT(INK,3) 
   SUM2 = SUM2 + C5Z(J) *  ( DBLE(INJ-1)*FMAT(INI,1)*FMAT(INJ-1,2) +   &
        DBLE(INI-1)*FMAT(INJ,1)*FMAT(INI-1,2)  )*FMAT(INK,3) 
   SUM3 = SUM3 + C5Z(J) *  ( FMAT(INI,1)*FMAT(INJ,2) +   &
        FMAT(INJ,1)*FMAT(INI,2)) * DBLE(INK-1)*FMAT(INK-1,3) 
ENDDO     

!.... ENERGY..........
VC= 2.D0*C5Z(1)+EFAC*SUM0
E1 = VA+VB+VC
E1 = E1+0.44739574026257D0! CORRECTION
E1 = E1*0.00285914375100642899D0 ! CM-1 --> KCAL/MOL
!.... DERIVATIVES .............
DVCDR1 = (-2.D0*B1*EFAC*(DROH1-REOH)*SUM0 + EFAC*SUM1/REOH)/DROH1
DVCDR2 = (-2.D0*B1*EFAC*(DROH2-REOH)*SUM0 + EFAC*SUM2/REOH)/DROH2
DVCDCTH = EFAC*SUM3

DR1(:,2) = DVA1*ROH1 + DVB*RHH + DVCDR1*ROH1 + &
       DVCDCTH*(ROH2(:)/(DROH1*DROH2)-COSTH*ROH1(:)/(DROH1*DROH1))
DR1(:,3) = DVA2*ROH2-DVB*RHH +DVCDR2*ROH2  + &
       DVCDCTH*(ROH1(:)/(DROH1*DROH2)-COSTH*ROH2(:)/(DROH2*DROH2))
DR1(:,1) = -(DR1(:,2)+DR1(:,3))
DR1 = DR1*.00285914375100642899D0

END SUBROUTINE POT_NASA
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
SUBROUTINE DMS_NASA(R1, Q3, GRADQ)
!****
!**** CALCULATES THE CHARGES (Q3) ON THE OXYGEN AND THE HYDROGEN SITES THAT
!**** REPRODUCE THE DIPOLE MOMENT SURFACE  OF A WATER MONOMER
!**** (COORDINATES IN THE ARRAY R1). THE MODEL HAS BEEN DEVELOPED BY
!**** "H. PARTRIDGE AND D. W. SCHWENKE, J. CHEM. PHYS. 106, 4618 (1997)"
!**** WHILE SOME EXTRA CODE FOR THE CALCULATION OF THE DEIVATIVES OF THE 
!**** CHARGES WITH RESPECT TO THE ATOMIC DISPLACEMETS (GRADQ) HAS
!**** ADDED  BY C. J. BURNHAM.
!*** ------------------------------------------------------------------------
!***  IN THE VERSION 3.0 OF THE TTM3-F MODEL SOME ADDITIONAL TERMS HAVE BEEN
!***  USED FOR THE CALCULATION OF THE CHARGES (SEE THE COMMENTS)
!*** ------------------------------------------------------------------------

USE MNASA_MOD
USE TTM3F_MOD
IMPLICIT NONE
DOUBLE PRECISION, DIMENSION(3, 3) :: R1
DOUBLE PRECISION, DIMENSION(3):: Q3
DOUBLE PRECISION, DIMENSION(3,3,3):: GRADQ
DOUBLE PRECISION, DIMENSION(3) :: ROH1, ROH2, RHH, AXB
DOUBLE PRECISION, DIMENSION(0:15,3) :: FMAT
DOUBLE PRECISION :: DROH1, DROH2, DRHH, DAXB, ANG, ATH0
DOUBLE PRECISION :: X1, X2, X3
DOUBLE PRECISION :: COSTHE, COSTH, SINTH
DOUBLE PRECISION :: EXP1, EXP2, EFAC
INTEGER          :: I, J, INI, INJ, INK, IX, IY
DOUBLE PRECISION :: DEOH, PHH1
DOUBLE PRECISION :: P1, P2, PL1, PL2, PC0
DOUBLE PRECISION :: DP1DR1, DP1DR2, DP1DCABC, DP2DR1, DP2DR2, DP2DCABC
DOUBLE PRECISION :: DEFACDR1, DEFACDR2, DPC0DR1, DPC0DR2, DPC0DCABC
DOUBLE PRECISION :: F1Q1R13, F1Q1R23, F2Q1R23, F2Q1R13
DOUBLE PRECISION :: F1Q2R13, F1Q2R23, F2Q2R23, F2Q2R13
DOUBLE PRECISION :: BFAC
INTEGER :: LL1, LL2


DEOH = F5Z*DEOHA
PHH1 = F5Z*PHH1A
PHH1 = PHH1*DEXP(PHH2)

ATH0 = 1.82400520401572996557D0
COSTHE = -.24780227221366464506D0

ROH1 = R1(:,2) - R1(:,1)
ROH2 = R1(:,3) - R1(:,1)
RHH  = R1(:,2) - R1(:,3)
DROH1 = DSQRT(DOT_PRODUCT(ROH1, ROH1))
DROH2 = DSQRT(DOT_PRODUCT(ROH2, ROH2))
DRHH  = DSQRT(DOT_PRODUCT(RHH, RHH))
COSTH = DOT_PRODUCT(ROH1, ROH2)/(DROH1*DROH2)
EFAC = DEXP(-B1D*(  (DROH1-REOH)**2 + (DROH2-REOH)**2))
   
X1 = (DROH1-REOH)/REOH
X2 = (DROH2-REOH)/REOH
X3 = COSTH - COSTHE
FMAT(0,1:3) = 0.D0
FMAT(1,1:3) = 1.D0
DO J=2,15
   FMAT(J,1) = FMAT(J-1,1)*X1
   FMAT(J,2) = FMAT(J-1,2)*X2
   FMAT(J,3) = FMAT(J-1,3)*X3
ENDDO
!
!    CALCULATE DIPOLE MOMENT
!
P1 = 0.D0; 
P2 = 0.D0
PL1 = COSTH
PL2 = 0.5D0*(3.D0*PL1*PL1-1.D0)
DP1DR1 = 0.D0
DP1DR2 = 0.D0
DP1DCABC = 0.D0
DP2DR1 = 0.D0
DP2DR2 = 0.D0
DP2DCABC = 0.D0
DO J=2,84
   INI = IDXD(J,1)
   INJ = IDXD(J,2)
   INK = IDXD(J,3)
   P1 = P1 + COEFD(J) * FMAT(INI ,1)*FMAT(INJ, 2)*FMAT(INK, 3)
   P2 = P2 + COEFD(J) * FMAT(INJ ,1)*FMAT(INI, 2)*FMAT(INK, 3)
   DP1DR1 =DP1DR1+COEFD(J)*(DBLE(INI-1)*FMAT(INI-1,1)*FMAT(INJ,2)*FMAT(INK,3))
   DP1DR2 =DP1DR2+COEFD(J)*(DBLE(INJ-1)*FMAT(INI,1)*FMAT(INJ-1,2)*FMAT(INK,3))
  DP1DCABC=DP1DCABC+COEFD(J)*(DBLE(INK-1)*FMAT(INI,1)*FMAT(INJ,2)*FMAT(INK-1,3))

   DP2DR1 = DP2DR1+COEFD(J)*( DBLE(INJ-1)*FMAT(INJ-1,1)*FMAT(INI,2)*FMAT(INK,3))
   DP2DR2 = DP2DR2+COEFD(J)*( DBLE(INI-1)*FMAT(INJ,1)*FMAT(INI-1,2)*FMAT(INK,3))
  DP2DCABC=DP2DCABC+COEFD(J)*(DBLE(INK-1)*FMAT(INJ,1)*FMAT(INI,2)*FMAT(INK-1,3))
ENDDO
DP1DR1=DP1DR1 / REOH*0.529177249D0
DP1DR2=DP1DR2 / REOH*0.529177249D0
DP2DR1=DP2DR1 / REOH*0.529177249D0
DP2DR2=DP2DR2 / REOH*0.529177249D0
PC0 = A*((DROH1**B)+(DROH2**B))*(C0+PL1*C1+PL2*C2)
DPC0DR1=A*(B*DROH1**(B-1))*(C0+PL1*C1+PL2*C2)*0.529177249D0*0.529177249D0
DPC0DR2=A*(B*DROH2**(B-1))*(C0+PL1*C1+PL2*C2)*0.529177249D0*0.529177249D0
DPC0DCABC=A*((DROH1**B)+(DROH2**B))*(C1+0.5D0*(6.D0*PL1)*C2)*0.529177249D0
DEFACDR1 =-2.D0*B1D*(DROH1-REOH)*EFAC*0.529177249D0
DEFACDR2 =-2.D0*B1D*(DROH2-REOH)*EFAC*0.529177249D0
DP1DR1=DP1DR1*EFAC+P1*DEFACDR1+DPC0DR1
DP1DR2=DP1DR2*EFAC+P1*DEFACDR2+DPC0DR2
DP1DCABC=DP1DCABC*EFAC+DPC0DCABC
DP2DR1=DP2DR1*EFAC+P2*DEFACDR1+DPC0DR1
DP2DR2=DP2DR2*EFAC+P2*DEFACDR2+DPC0DR2
DP2DCABC=DP2DCABC*EFAC+DPC0DCABC
P1 = COEFD(1)+P1*EFAC+PC0*0.529177249D0
P2 = COEFD(1)+P2*EFAC+PC0*0.529177249D0
BFAC=1.D0/0.529177249
Q3(1) = -(P1+P2)   ! OXYGEN
Q3(2) = P1   ! HYDROGEN-1
Q3(3) = P2   !  HYDROGEN-2
DP1DR1=DP1DR1*BFAC
DP1DR2=DP1DR2*BFAC
DP2DR1=DP2DR1*BFAC
DP2DR2=DP2DR2*BFAC
!--------------------------------------------------------------------------------
!............. MODIFICATION OF THE GAS-PHASE DIPOLE MOMENT SURFACE...........
!--------------------------------------------------------------------------------
   AXB(1) = ROH1(2)*ROH2(3) - ROH1(3)*ROH2(2)
   AXB(2) =-ROH1(1)*ROH2(3) + ROH1(3)*ROH2(1)
   AXB(3) = ROH1(1)*ROH2(2) - ROH1(2)*ROH2(1)
   DAXB = DSQRT(DOT_PRODUCT(AXB, AXB) )
   SINTH = DAXB / (DROH1*DROH2)
   ANG = ATAN2(SINTH, COSTH)
   P1 = DMS_PARAM1*(DROH1 -DMS_PARAM2) + DMS_PARAM3*(ANG-ATH0)
   P2 = DMS_PARAM1*(DROH2 -DMS_PARAM2) + DMS_PARAM3*(ANG-ATH0)
   Q3(1) = Q3(1) - (P1+P2)
   Q3(2) = Q3(2) + P1
   Q3(3) = Q3(3) + P2
   DP1DR1 = DP1DR1 + DMS_PARAM1
   DP2DR2 = DP2DR2 + DMS_PARAM1
   DP1DCABC = DP1DCABC   - DMS_PARAM3/SINTH
   DP2DCABC = DP2DCABC   - DMS_PARAM3/SINTH
!--------------------------------------------------------------------------------

F1Q1R13=(DP1DR1-(DP1DCABC*COSTH/DROH1))/DROH1
F1Q1R23=DP1DCABC/(DROH1*DROH2)
F2Q1R23=(DP1DR2-(DP1DCABC*COSTH/DROH2))/DROH2
F2Q1R13=DP1DCABC/(DROH2*DROH1)
F1Q2R13=(DP2DR1-(DP2DCABC*COSTH/DROH1))/DROH1
F1Q2R23=DP2DCABC/(DROH1*DROH2)
F2Q2R23=(DP2DR2-(DP2DCABC*COSTH/DROH2))/DROH2
F2Q2R13=DP2DCABC/(DROH2*DROH1)


!GRADIENT OF CHARGE H1 WRT DISPLACEMENT OF H1
GRADQ(1,1,1)=F1Q1R13*ROH1(1)+F1Q1R23*ROH2(1)
GRADQ(1,1,2)=F1Q1R13*ROH1(2)+F1Q1R23*ROH2(2)
GRADQ(1,1,3)=F1Q1R13*ROH1(3)+F1Q1R23*ROH2(3)
!GRADIENT OF CHARGE H1 WRT DISPLACEMENT OF H2
GRADQ(2,1,1)=F2Q1R13*ROH1(1)+F2Q1R23*ROH2(1)
GRADQ(2,1,2)=F2Q1R13*ROH1(2)+F2Q1R23*ROH2(2)
GRADQ(2,1,3)=F2Q1R13*ROH1(3)+F2Q1R23*ROH2(3)
!GRADIENT OF CHARGE H1 WRT DISPLACEMENT OF O
GRADQ(3,1,1)=-(GRADQ(1,1,1)+GRADQ(2,1,1))
GRADQ(3,1,2)=-(GRADQ(1,1,2)+GRADQ(2,1,2))
GRADQ(3,1,3)=-(GRADQ(1,1,3)+GRADQ(2,1,3))
!GRADIENT OF CHARGE H2 WRT DISPLACEMENT OF H1
GRADQ(1,2,1)=F1Q2R13*ROH1(1)+F1Q2R23*ROH2(1)
GRADQ(1,2,2)=F1Q2R13*ROH1(2)+F1Q2R23*ROH2(2)
GRADQ(1,2,3)=F1Q2R13*ROH1(3)+F1Q2R23*ROH2(3)
!GRADIENT OF CHARGE H2 WRT DISPLACEMENT OF H2
GRADQ(2,2,1)=F2Q2R13*ROH1(1)+F2Q2R23*ROH2(1)
GRADQ(2,2,2)=F2Q2R13*ROH1(2)+F2Q2R23*ROH2(2)
GRADQ(2,2,3)=F2Q2R13*ROH1(3)+F2Q2R23*ROH2(3)
!GRADIENT OF CHARGE H2 WRT DISPLACEMENT OF O
GRADQ(3,2,1)=-(GRADQ(1,2,1)+GRADQ(2,2,1))
GRADQ(3,2,2)=-(GRADQ(1,2,2)+GRADQ(2,2,2))
GRADQ(3,2,3)=-(GRADQ(1,2,3)+GRADQ(2,2,3))
!GRADIENT OF CHARGE O WRT DISPLACEMENT OF H1
GRADQ(1,3,1)=-(GRADQ(1,1,1)+GRADQ(1,2,1))
GRADQ(1,3,2)=-(GRADQ(1,1,2)+GRADQ(1,2,2))
GRADQ(1,3,3)=-(GRADQ(1,1,3)+GRADQ(1,2,3))
!GRADIENT OF CHARGE O WRT DISPLACEMENT OF H2
GRADQ(2,3,1)=-(GRADQ(2,1,1)+GRADQ(2,2,1))
GRADQ(2,3,2)=-(GRADQ(2,1,2)+GRADQ(2,2,2))
GRADQ(2,3,3)=-(GRADQ(2,1,3)+GRADQ(2,2,3))
!GRADIENT OF CHARGE O WRT DISPLACEMENT OF O
GRADQ(3,3,1)=-(GRADQ(3,1,1)+GRADQ(3,2,1))
GRADQ(3,3,2)=-(GRADQ(3,1,2)+GRADQ(3,2,2))
GRADQ(3,3,3)=-(GRADQ(3,1,3)+GRADQ(3,2,3))
    
END SUBROUTINE DMS_NASA

SUBROUTINE TTM3FCALL(NW, COORDS, ENERGY, VNEW) !ADDS ENERGY AND GRADIENT
IMPLICIT NONE
INTEGER :: NW
DOUBLE PRECISION, INTENT(IN) :: COORDS(9*NW)
DOUBLE PRECISION, INTENT(INOUT) :: ENERGY, VNEW(9*NW)
DOUBLE PRECISION :: EN, DRR(3,SIZE(VNEW)/3)
CALL TTM3F(NW, RESHAPE(COORDS,(/3,3*NW/)), DRR, EN)
VNEW = VNEW + RESHAPE(DRR, (/9*NW/))
ENERGY = ENERGY + EN
END SUBROUTINE TTM3FCALL
