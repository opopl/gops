!   OPTIM: A PROGRAM FOR OPTIMIZING GEOMETRIES AND CALCULATING REACTION PATHWAYS
!   COPYRIGHT (C) 1999-2006 DAVID J. WALES
!   THIS FILE IS PART OF OPTIM.
!   
!   OPTIM IS FREE SOFTWARE; YOU CAN REDISTRIBUTE IT AND/OR MODIFY
!   IT UNDER THE TERMS OF THE GNU GENERAL PUBLIC LICENSE AS PUBLISHED BY
!   THE FREE SOFTWARE FOUNDATION; EITHER VERSION 2 OF THE LICENSE, OR
!   (AT YOUR OPTION) ANY LATER VERSION.
!   
!   OPTIM IS DISTRIBUTED IN THE HOPE THAT IT WILL BE USEFUL,
!   BUT WITHOUT ANY WARRANTY; WITHOUT EVEN THE IMPLIED WARRANTY OF
!   MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.  SEE THE
!   GNU GENERAL PUBLIC LICENSE FOR MORE DETAILS.
!   
!   YOU SHOULD HAVE RECEIVED A COPY OF THE GNU GENERAL PUBLIC LICENSE
!   ALONG WITH THIS PROGRAM; IF NOT, WRITE TO THE FREE SOFTWARE
!   FOUNDATION, INC., 59 TEMPLE PLACE, SUITE 330, BOSTON, MA  02111-1307  USA
!
! LINEAR INTERPOLATION FOR UNRES WITH ITERATIVE REFINEMENT OF
! LONGER OR SHORTER ROUTE AROUND EACH DIHEDRAL ANGLE
SUBROUTINE UNGUESSPATH(START,FINISH,NCOORDS,EDIFFTOLLOCAL,NATOMS)
USE KEY
USE MODCHARMM
USE MODGUESS
USE MODUNRES
USE PORFUNCS
IMPLICIT NONE
INTEGER, INTENT(IN) :: NCOORDS, NATOMS
DOUBLE PRECISION, INTENT(IN) :: START(NCOORDS), FINISH(NCOORDS), EDIFFTOLLOCAL
DOUBLE PRECISION, ALLOCATABLE :: INTERPENERGY(:), INTERPENERGYSAVE(:), PEPCOORDS(:), SMALLSTEP(:), LARGESTEP(:), DELTA(:)
DOUBLE PRECISION :: MAXE, SUME, NEWMAXE
INTEGER :: JMAXE(1), NEWJMAXE(1)
INTEGER :: ISTAT, NLONG
LOGICAL, ALLOCATABLE :: SHORTER(:)
DOUBLE PRECISION, PARAMETER :: PI=3.141592653589793D0
CHARACTER(LEN=80) LFNAME

INTEGER :: J1

IF (.NOT.UNRST) THEN
   WRITE(*,'(A)') 'ERROR - UNGUESSPATH IS ONLY FOR UNRES POTENTIAL'
   STOP
ENDIF
IF (UNRST) ALLOCATE(PEPCOORDS(3*NATOMS),SMALLSTEP(NCOORDS),LARGESTEP(NCOORDS),DELTA(NCOORDS))
ALLOCATE(SHORTER(NCOORDS))
! DEFINE THE ANGULAR STEP FOR THE SHORTEST AND LONGEST ANGULAR ROUTES BETWEEN START AND
! FINISH FOR UNRES.
DO J1=1,NCOORDS
   IF (ABS(FINISH(J1)-START(J1)).LE.PI) THEN
      SMALLSTEP(J1)=FINISH(J1)-START(J1)
      IF (FINISH(J1).GT.START(J1)) THEN
         LARGESTEP(J1)=FINISH(J1)-START(J1)-2*PI
      ELSE
         LARGESTEP(J1)=FINISH(J1)-START(J1)+2*PI
      ENDIF
   ELSE
      LARGESTEP(J1)=FINISH(J1)-START(J1)
      IF (FINISH(J1).GT.START(J1)) THEN
         SMALLSTEP(J1)=FINISH(J1)-START(J1)-2*PI
      ELSE
         SMALLSTEP(J1)=FINISH(J1)-START(J1)+2*PI
      ENDIF
   ENDIF
   DELTA(J1)=SMALLSTEP(J1)
   SHORTER(J1)=.TRUE.
ENDDO
NINTERP=MAXGCYCLES
WRITE(*,'(2(A,I6))') ' NUMBER OF INTERIOR POINTS FOR INTERPOLATED PATH IN UNGUESSPATH=',NINTERP
ALLOCATE(INTERPENERGY(NINTERP+2),INTERPENERGYSAVE(NINTERP+2))
! TO OPTIMISE THE ORDER OF THE STEPS WE NEED TO RECALCULATE INTERPENERGY FOR ALL CONFIGURATIONS
! THE ENERGY AT STEPS 1 AND NINTERP+2 ARE JUST THE ENERGIES OF THE START AND FINISH MINIMA

CALL GENERGIES(1,NINTERP+2,.FALSE.) ! FILL THE INITIAL INTERPENERGY VECTOR WITH INTERPOLATED ENERGIES
INTERPENERGYSAVE(1:NINTERP+2)=INTERPENERGY(1:NINTERP+2)

MAXE=MAXVAL(INTERPENERGY(2:NINTERP+1))
JMAXE=MAXLOC(INTERPENERGY(2:NINTERP+1)) ! NOTE THAT MAXLOC RETURNS A VECTOR OF DIMENSION ONE, NOT A SCALAR
SUME=SUM(INTERPENERGY(2:NINTERP+1))

WRITE(*,'(A,2G20.10)') 'MAXIMUM ENERGY AND MEAN OF INTERVENING POINTS=',MAXE,SUME/(NINTERP)
WRITE(*,'(A,I6)') 'MAXIMUM IS AT LOCATION ',JMAXE(1)
PRINT*,'ENERGIES:'
WRITE(*,'(I6,G20.10)') (J1,INTERPENERGY(J1),J1=1,NINTERP+2)
! TRY CHANGING THE DIRECTION (SHORTER=TRUE OR FALSE) FOR EACH DEGREE OF FREEDOM IN TURN
! UNTIL WE GET THROUGH THEM ALL WITH NO IMPROVEMENT

MAIN: DO 
   DO J1=1,NCOORDS ! TRY CHANGING THE INTERPOLATION DIRECTION FOR EACH COORDINATE IN TURN
   
! FIRST TRY USING LARGESTEP INSTEAD OF SMALLSTEP FOR THE DEGREE OF FREEDOM
! CORRESPONDING TO JMAXE(1). OR TRY SMALLSTEP INSTEAD OF LARGESTEP IF WE'VE CHANGED THIS
! AN ODD NUMBER OF TIMES ALREADY!

      IF (SHORTER(J1)) THEN
!        WRITE(*,'(A,I5)') ' TRYING LONGER INTERPOLATION FOR COORDINATE ',J1
         DELTA(J1)=LARGESTEP(J1)
         SHORTER(J1)=.FALSE.
      ELSE
!        WRITE(*,'(A,I5)') ' TRYING SHORTER INTERPOLATION FOR COORDINATE ',J1
         DELTA(J1)=SMALLSTEP(J1)
         SHORTER(J1)=.TRUE.
      ENDIF
      CALL GENERGIES(2,NINTERP+1,.FALSE.) 
      NEWMAXE=MAXVAL(INTERPENERGY(2:NINTERP+1))
      NEWJMAXE=MAXLOC(INTERPENERGY(2:NINTERP+1))
      IF (MAXE-NEWMAXE.GT.EDIFFTOLLOCAL) THEN ! ACCEPT CHANGE
         WRITE(*,'(A,G20.10,A,I6)') ' MAXIMUM INTERIOR ENERGY IS NOW ',NEWMAXE,' AT POSITION ',NEWJMAXE(1)
         MAXE=NEWMAXE
         INTERPENERGYSAVE(2:NINTERP+1)=INTERPENERGY(2:NINTERP+1)
         CYCLE MAIN ! GO BACK AND START FROM THE FIRST COORDINATE AGAIN
      ELSE
!        WRITE(*,'(A,G20.10,A,I6))') ' MAXIMUM INTERIOR ENERGY IS NOW ',NEWMAXE,' AT POSITION ',NEWJMAXE(1)
         INTERPENERGY(2:NINTERP+1)=INTERPENERGYSAVE(2:NINTERP+1)
         IF (SHORTER(J1)) THEN
            DELTA(J1)=LARGESTEP(J1)
            SHORTER(J1)=.FALSE.
         ELSE
            DELTA(J1)=SMALLSTEP(J1)
            SHORTER(J1)=.TRUE.
         ENDIF
      ENDIF
   ENDDO
   EXIT MAIN
ENDDO MAIN

SUME=SUM(INTERPENERGY(2:NINTERP+1))
WRITE(*,'(A,2G20.10)') 'MAXIMUM ENERGY AND MEAN=',MAXE,SUME/(NINTERP)
WRITE(*,'(A,I6)') 'MAXIMUM IS AT LOCATION ',JMAXE(1)
PRINT*,' ENERGIES:'
WRITE(*,'(I6,G20.10)') (J1,INTERPENERGY(J1),J1=1,NINTERP+2)
NLONG=0
DO J1=1,NCOORDS
   IF (.NOT.SHORTER(J1)) NLONG=NLONG+1
ENDDO
PRINT '(A,I5)',' NUMBER OF LONGER INTERPOLATIONS=',NLONG
! DUMP XYZ PATH
CALL GENERGIES(1,NINTERP+2,.TRUE.) 

DEALLOCATE(INTERPENERGY,INTERPENERGYSAVE,SHORTER)
IF (ALLOCATED(PEPCOORDS)) DEALLOCATE(PEPCOORDS,DELTA,SMALLSTEP,LARGESTEP)
CALL FLUSH(6,ISTAT)

CONTAINS
   SUBROUTINE GENERGIES(BOTTOM,TOP,DUMPPATH)
   INTEGER, INTENT(IN) :: BOTTOM, TOP
   INTEGER :: K1, K2, LBOTTOM, LTOP, K3
   LOGICAL, INTENT(IN) :: DUMPPATH
   DOUBLE PRECISION :: X(3*NATOMS), RMS, GRAD(3*NATOMS)
               ! THERE SHOULD BE A WAY OF NOT 
               ! DECLARING THE HESSIAN UNLESS IT IS ACTUALLY NEEDED? USE (*,*) IN POTENTIAL
               ! AND ROUTINES CALLED FROM IT?
   DOUBLE PRECISION :: ENERGY

   LBOTTOM=BOTTOM
   LTOP=TOP
   IF (LBOTTOM.GT.LTOP) THEN
      WRITE(*,'(A)') ' ERROR - LBOTTOM,LTOP=',LBOTTOM,LTOP
      STOP
   ENDIF
   IF (DUMPPATH) THEN
      IF (FILTH.EQ.0) THEN
         OPEN(UNIT=7,FILE='GUESS.XYZ',STATUS='UNKNOWN')
      ELSE
         LFNAME='GUESS.XYZ.'//TRIM(ADJUSTL(FILTHSTR))
         OPEN(UNIT=7,FILE=TRIM(ADJUSTL(LFNAME)),STATUS='UNKNOWN')
      ENDIF
      IF (FILTH.EQ.0) THEN
         OPEN(UNIT=8,FILE='GUESS.UNRES.XYZ',STATUS='UNKNOWN')
      ELSE
         LFNAME='GUESS.UNRES.XYZ.'//TRIM(ADJUSTL(FILTHSTR))
         OPEN(UNIT=8,FILE=TRIM(ADJUSTL(LFNAME)),STATUS='UNKNOWN')
      ENDIF
      IF (LBOTTOM.NE.1) THEN
         PRINT*,'HERE'
!CALL VAR_TO_GEOM(NCOORDS,START)
!CALL CHAINBUILD
         DO K2=1,NRES
            WRITE(7,'(3G20.10)') C(1,K2),C(2,K2),C(3,K2) ! BACKBONE
            WRITE(7,'(3G20.10)') C(1,K2+NRES),C(2,K2+NRES),C(3,K2+NRES) ! SIDE CHAINS
         ENDDO
         DO K2=1,(NATOMS/2)-1 ! JMC ADD PEPTIDE ATOMS...
            DO K3=1,3
               PEPCOORDS(6*(K2-1)+K3)=(2.0D0*C(K3,K2)+C(K3,K2+1))/3.0D0
               PEPCOORDS(6*(K2-1)+K3+3)=(C(K3,K2)+2.0D0*C(K3,K2+1))/3.0D0
            ENDDO
         ENDDO
         WRITE(8,'(I6)') 2*NATOMS-2
         WRITE(8,'(A)') ' '
         WRITE(8,'(A2,3G20.10)') ('C  ',C(1,K2),C(2,K2),C(3,K2),K2=1,NATOMS)
         WRITE(8,'(A2,4X,3F20.10)') ('O ',PEPCOORDS(6*(K2-1)+1),PEPCOORDS(6*(K2-1)+2),PEPCOORDS(6*(K2-1)+3) &
                                   ,K2=1,(NATOMS/2)-1)
         WRITE(8,'(A2,4X,3F20.10)') ('N ',PEPCOORDS(6*(K2-1)+4),PEPCOORDS(6*(K2-1)+5),PEPCOORDS(6*(K2-1)+6) &
                                   ,K2=1,(NATOMS/2)-1)
      ENDIF
   ENDIF
   X(1:NCOORDS)=START(1:NCOORDS)
! REMOVE EXACT ATOM SUPERPOSITIONS USING SOME RANDOM NUMERICAL NOISE WITH DPRAND
   DO K1=LBOTTOM,LTOP
      DO K2=1,NCOORDS ! LINEAR INTERPOLATION
         X(K2)=START(K2)+DELTA(K2)*(K1-1)/(NINTERP+1)
      ENDDO
!CALL VAR_TO_GEOM(NCOORDS,X)
!CALL CHAINBUILD
      IF (DUMPPATH) THEN
         DO K2=1,NRES
            WRITE(7,'(3G20.10)') C(1,K2),C(2,K2),C(3,K2) ! BACKBONE
            WRITE(7,'(3G20.10)') C(1,K2+NRES),C(2,K2+NRES),C(3,K2+NRES) ! SIDE CHAINS
         ENDDO
         DO K2=1,(NATOMS/2)-1 ! JMC ADD PEPTIDE ATOMS...
            DO K3=1,3
               PEPCOORDS(6*(K2-1)+K3)=(2.0D0*C(K3,K2)+C(K3,K2+1))/3.0D0
               PEPCOORDS(6*(K2-1)+K3+3)=(C(K3,K2)+2.0D0*C(K3,K2+1))/3.0D0
            ENDDO
         ENDDO
         WRITE(8,'(I6)') 2*NATOMS-2
         WRITE(8,'(A)') ' '
         WRITE(8,'(A2,3G20.10)') ('C  ',C(1,K2),C(2,K2),C(3,K2),K2=1,NATOMS)
         WRITE(8,'(A2,4X,3F20.10)') ('O ',PEPCOORDS(6*(K2-1)+1),PEPCOORDS(6*(K2-1)+2),PEPCOORDS(6*(K2-1)+3) &
                                   ,K2=1,(NATOMS/2)-1)
         WRITE(8,'(A2,4X,3F20.10)') ('N ',PEPCOORDS(6*(K2-1)+4),PEPCOORDS(6*(K2-1)+5),PEPCOORDS(6*(K2-1)+6) &
                                   ,K2=1,(NATOMS/2)-1)
      ELSE
         CALL POTENTIAL(X,ENERGY,GRAD,.FALSE.,.FALSE.,RMS,.FALSE.,.FALSE.)
         INTERPENERGY(K1)=ENERGY
      ENDIF
   ENDDO
   IF (DUMPPATH) CLOSE(7)
   IF (DUMPPATH.AND.UNRST) CLOSE(8)

   END SUBROUTINE GENERGIES

END SUBROUTINE UNGUESSPATH
