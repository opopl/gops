
C     --------------------- SHKDRV  ----------------------

      SUBROUTINE SHKDRV(PRCORD,QRCORD,SRCORD,
     *                  ZRCORD,BONDLN,JSTRT,JFINS,TOLSHK,
     *                  MAXSHK,BDSHAK,NUMPRO,ISHKIT,
     *                  MAXPRO,MAXCRD,NUMCRD,
     *                  OARCHV,WORK1,WORK3,WORK4,
     *                  IRES)

C     ---------------------------------------------------

C     SHKDRV DRIVER ROUTINE FOR PERFORMING SHAKE
C            ALGORITHM ON DIFFERENT SETS OF
C            COORDINATES

C     ARGUMENTS:

C        MAXSIZ- MAXIMUM NUMBER OF PROTEIN RESIDUES (I)
C        PRCORD- NEW COORDINATES WHICH SATSIFY BOND 
C                LENGTHS (O)

C     ---------------------------------------------------

      USE GLOBALS, ONLY:SO, MAXSIZ,MAXCNT

      IMPLICIT NONE


C     ARGUMENT DECLARATIONS:

         LOGICAL BDSHAK

         INTEGER NUMPRO,JSTRT,JFINS,
     *           MAXSHK,ISHKIT,MAXPRO,
     *           MAXCRD,NUMCRD,OARCHV,
     *           IRES(MAXSIZ),I1
     
         REAL PRCORD(MAXSIZ,3,MAXPRO,MAXCRD),
     *        QRCORD(MAXSIZ,3,MAXPRO,MAXCRD),
     *        SRCORD(MAXSIZ,3,MAXPRO,MAXCRD),
     *        ZRCORD(MAXSIZ,3,MAXPRO,MAXCRD),
     *        BONDLN(MAXSIZ,MAXCRD),WORK1(MAXCNT),
     *        WORK3(MAXCNT),WORK4(MAXCNT),TOLSHK

C     INTERNAL VARIABLES:

C        --- DO LOOP INDICES ---

         INTEGER I507,I512,I517
 
         INTEGER NUMSHK

         
         REAL DIFF(2,MAXSIZ),DIST(2)

        CHARACTER*3 RES_TYPE


C        --- IMPLIED DO LOOP INDICES ---

        INTEGER III,JJJ








C     REQUIRED SUBROUTINES

        EXTERNAL SHAKE,SHAKAB,SHAKOX


          DO 600 I1=1,MAXSIZ
            DIFF(1,I1)=0.0
            DIFF(2,I1)=0.0
600          CONTINUE
          DIST(1)=0.0
          DIST(2)=0.0


C     --------------------- BEGIN -----------------------


C     ATTEMPT TO SATISFY BOND CONSTRAINTS 
C     FOR EACH SET OF COORDINATES

C     SET NUMBER OF SHAKE ITERATIONS TO ZERO

      NUMSHK=0

C     'DO WHILE' LOOP, I.E., WHILE BOTH SETS OF 
C     CONSTRAINTS ARE NOT SATISFIED KEEP SHAKING

  400 CONTINUE

      NUMSHK=NUMSHK + 1
C      WRITE(6,*)'NUMSHK ISHKDRV ',  NUMSHK

C     IF THE NUMBER OF ITERATIONS HAVE EXCEEDED THE 
C     MAXIMUM, THEN PRINT MESSAGE AND ABORT

      IF( NUMSHK.GT.100 )THEN
         WRITE(OARCHV,130)NUMSHK
  130    FORMAT(/'SHKDRV: YOU GOT PROBLEMS BUD ',
     *          '-- CONVERGENCE NOT OBTAINED W/ SHAKE')
         STOP
      ENDIF

C     SHAKE ALPHA-ALPHA COORDINATES

      CALL SHAKE(MAXSIZ,PRCORD,QRCORD,SRCORD,
     *           BONDLN,NUMPRO,JSTRT+1,JFINS,ZRCORD,
     *           MAXSHK,TOLSHK,BDSHAK,ISHKIT,MAXPRO,
     *           MAXCRD,MAXCNT,WORK1,WORK3,WORK4,OARCHV)

C     IF CONVERGENCE NOT OBTAINED, HANG IT UP;
C     ALSO IF ONLY ONE COORDINATE TYPE RETURN

      IF( BDSHAK.OR.(NUMCRD.EQ.1) )RETURN

C     SHAKE ALPHA-BETA COORDINATES

      CALL SHAKAB(MAXSIZ,PRCORD,QRCORD,SRCORD,
     *            BONDLN,NUMPRO,JSTRT,JFINS,ZRCORD,
     *            MAXSHK,TOLSHK,BDSHAK,ISHKIT,MAXPRO,
     *            MAXCRD,MAXCNT,WORK1,WORK3,WORK4,OARCHV,
     *            IRES)

C     CONVERGENCE NOT OBTAINED, HANG IT UP

          IF( BDSHAK ) THEN
              WRITE(SO,*) "YEP IT DIED IN SHAKAB"          
          ENDIF


      IF( BDSHAK )RETURN

         CALL SHAKOX(PRCORD,QRCORD,SRCORD,
     *               NUMPRO,JSTRT,JFINS,
     *               MAXSHK,TOLSHK,ISHKIT,
     *               MAXPRO,MAXCRD)

C     DETERMINE WHICH, IF ANY, OF THE ALPHA-ALPHA 
C     CONSTRAINTS ARE NOT SATISFIED

C     FIND BOND DISTANCE

      DO 512 I512=1,NUMPRO
            DO 507 I507=JSTRT+1,JFINS
               DIST(1)=SQRT 
     *       ( ( PRCORD(I507,1,I512,1) -
     *           PRCORD(I507-1,1,I512,1) )**2
     *       + ( PRCORD(I507,2,I512,1) -
     *           PRCORD(I507-1,2,I512,1) )**2
     *       + ( PRCORD(I507,3,I512,1) -
     *           PRCORD(I507-1,3,I512,1) )**2 )
               DIST(2)=SQRT 
     *       ( ( PRCORD(I507,1,I512,2) -
     *           PRCORD(I507,1,I512,1) )**2
     *       + ( PRCORD(I507,2,I512,2) -
     *           PRCORD(I507,2,I512,1) )**2
     *       + ( PRCORD(I507,3,I512,2) -
     *           PRCORD(I507,3,I512,1) )**2 )
            DIFF(1,I507)=ABS(DIST(1) - BONDLN(I507,1))
            DIFF(2,I507)=ABS(DIST(2) - BONDLN(I507,2))
  507       CONTINUE

      DO 517 I517=JSTRT+1,JFINS
            IF (IRES(I517).EQ.8) DIFF(2,I517)=0.0
            IF( MAX(DIFF(1,I517),DIFF(2,I517)).GT.TOLSHK )THEN
               GO TO 400
            ENDIF
  517       CONTINUE
  512 CONTINUE



C     MISSION ACCOMPLISHED
           
C     ---------------------- DONE -----------------------

      RETURN
      END
