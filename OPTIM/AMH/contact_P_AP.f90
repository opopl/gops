      SUBROUTINE  CONTACT_P_AP(PRO_CORD,NMRES,F_CORD,LAMBDA_P_AP)

! DOES A (NON-ADDITIVE) CONTACT POTENTIAL THAT WEIGHTS C_ALPHA:C_ALPHA CONTACTS
! DIFFERENTLY IF THERE IS ALSO A CONTACT BETWEEN THE C_ALPHA ATOMS I_DIFF_P_AP ALONG CHAIN.
! (EG IF I,J AND I-I_DIFF_P_AP,J-I_DIFF_P_AP OR I+I_DIFF_P_AP,J+I_DIFF_P_AP
!  OR I-I_DIFF_P_AP,J+I_DIFF_P_AP OR I+I_DIFF_P_AP,J-I_DIFF_P_AP IS ALSO IN CONTACT)
! THIS IS INTENDED TO HELP BETA STRANDS LINE UP BETTER EVEN BEFORE H_BONDS
! COME IN FULLY.
! THERE ARE DIFFERENT WEIGHTS ACCORDING TO THE SEQ SEPARATION OF THE CONTACT PAIR
! AND WHETHER THE ADJACENT CONTACT INDICATES A PARALLEL OR ANTIPARALLEL `DOUBLE CONTACT'

      USE AMHGLOBALS,  ONLY : AMHMAXSIZ,MAXCRD,R_CUT_P_AP,WEIGHT_P_AP,&
        MAXMR,MINMR,I_DIFF_P_AP,I_ATOM_P_AP

      IMPLICIT NONE

       DOUBLE PRECISION, INTENT(IN):: PRO_CORD(AMHMAXSIZ,3,MAXCRD)
      INTEGER, INTENT(IN):: NMRES

       DOUBLE PRECISION, INTENT(OUT):: F_CORD(AMHMAXSIZ,3,MAXCRD)
       DOUBLE PRECISION, INTENT(OUT):: LAMBDA_P_AP(3)



      DOUBLE PRECISION :: DIST,DIST_FACTOR(AMHMAXSIZ,AMHMAXSIZ,3),THETA(AMHMAXSIZ,AMHMAXSIZ),&
       THETA_DOT(AMHMAXSIZ,AMHMAXSIZ),T_MAX
      INTEGER :: I,J,I_MED_MAX,I_MED_MIN,K

!     ZERO FORCE AND ENERGY

      F_CORD=0.0D0
      LAMBDA_P_AP=0.0D0


      K=I_ATOM_P_AP    !THE ATOM (ALPHA/BETA/OXYGEN = 1/2/3) POTENTIAL IS ON

      I_MED_MAX=MAXMR
      I_MED_MIN=MINMR    !MAKE EDGES OF CLASSES COMMENSURATE WITH AMH DEFINITION
                         ! HOWEVER NOTE THAT TWO PAIR CONTACTS ARE REQUIRED TO
                         ! DEFINE A PARALLEL OR ANTI-PARALLEL CONTACT. WE THUS MAKE
                         ! THE CONVENTION THAT THE CLASS OF THE AP CONTACT IS DETERMINED
                         ! BY THE *SHORTER* SEQ SEPARATED PAIR (FOR P CASE BOTH PAIRS
                         ! ARE AT SAME DISTANCE SO THERE IS NO COMPLICATION)

      DO I=1,NMRES-I_MED_MIN   !WORK OUT THETA VALUES BETWEEN ALL PAIRS I<J IN LONG/MED CLASSES
      DO J=I+I_MED_MIN,NMRES   
        DIST=DSQRT (  &
              (PRO_CORD(J,1,K)-PRO_CORD(I,1,K))**2 + &
              (PRO_CORD(J,2,K)-PRO_CORD(I,2,K))**2 + &
              (PRO_CORD(J,3,K)-PRO_CORD(I,3,K))**2 )
        DIST_FACTOR(I,J,:)=(PRO_CORD(I,:,K)-PRO_CORD(J,:,K))/DIST
        T_MAX=TANH(7.0D0*(R_CUT_P_AP-DIST))
        THETA(I,J)=-0.5D0*(1.0D0+T_MAX)   !NOTE ALWAYS NEGATIVE (HAVING A FUNCTION THAT CHANGES SIGN DOESN'T MAKE SENSE)
        THETA_DOT(I,J)=3.5D0*(1.0D0-T_MAX**2)
      ENDDO
      ENDDO

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
! WORK OUT THE THREE LAMBDA VALUES CORRESPONDING TO THE WEIGHT TERMS -WEIGHT*LAMBDA=ENERGY
! AND ALSO GET FORCES 
! NOTE THAT HAVE WRITTEN F_CORD=F_CORD+(-WEIGHT)*... TO EMPHASIZE
! THAT THE POTENTIAL IS OF FORM -WEIGHT*SUM(THETA*THETA)
!
! LAMBDAS MUST BE POSITIVE
! EXPECT (BUT DON'T REQUIRE) WEIGHT POSITIVE SO 
! EXPECT ENERGY CONTRIBUTION TO BE NEGATIVE
! (THIS IS IN LINE WITH DSSP_HDRGN CONVENTION)
! THE THREE CLASSES FOR THE LAMBDAS/WEIGHTS ARE
! (1) AP MED RANGE
! (2) AP LONG RANGE
! (3) P  LONG RANGE

      
      DO I=1,NMRES-(I_MED_MIN+2*I_DIFF_P_AP)   !AP MED RANGE. NOTE LOOP OVER I,J (WITH J>I) AND EXAMINE *SHORTER* SEQ SPERARATED
      DO J=I+(I_MED_MIN+2*I_DIFF_P_AP),MIN(I+I_MED_MAX+2*I_DIFF_P_AP,NMRES)   
                                                   !NEIGHBOUR I+I_DIFF,J-I_DIFF (IF DID I-I_DIFF,J+I_DIFF TOO WOULD OVERCOUNT)
                                                   ! SO PAIRS ARE [I,J] AND [I+I_DIFF,J-I_DIFF] WITH THE RESTRICTION THAT
                                                   ! THE SHORTER SEPARATION (IE J-I-2*I_DIFF) IS IN THE MEDIUM RANGE CLASS
                                                   ! SO J-I-2*I_DIFF>=I_MED_MIN  AND  J-I-2*I_DIFF<=I_MED_MAX
        LAMBDA_P_AP(1)=LAMBDA_P_AP(1)+THETA(I,J)*THETA(I+I_DIFF_P_AP,J-I_DIFF_P_AP)
        F_CORD(I,:,K)=F_CORD(I,:,K)-(-WEIGHT_P_AP(1))*DIST_FACTOR(I,J,:)*THETA_DOT(I,J)*THETA(I+I_DIFF_P_AP,J-I_DIFF_P_AP)
        F_CORD(J,:,K)=F_CORD(J,:,K)+(-WEIGHT_P_AP(1))*DIST_FACTOR(I,J,:)*THETA_DOT(I,J)*THETA(I+I_DIFF_P_AP,J-I_DIFF_P_AP)
        F_CORD(I+I_DIFF_P_AP,:,K)=F_CORD(I+I_DIFF_P_AP,:,K)-(-WEIGHT_P_AP(1))*DIST_FACTOR(I+I_DIFF_P_AP,J-I_DIFF_P_AP,:) &
                                                                            *THETA_DOT(I+I_DIFF_P_AP,J-I_DIFF_P_AP)*THETA(I,J)
        F_CORD(J-I_DIFF_P_AP,:,K)=F_CORD(J-I_DIFF_P_AP,:,K)+(-WEIGHT_P_AP(1))*DIST_FACTOR(I+I_DIFF_P_AP,J-I_DIFF_P_AP,:) &
                                                                            *THETA_DOT(I+I_DIFF_P_AP,J-I_DIFF_P_AP)*THETA(I,J)
      ENDDO
      ENDDO

   
      DO I=1,NMRES-(I_MED_MAX+2*I_DIFF_P_AP+1)  !AP LONG RANGE  ( [I,J] + [I+I_DIFF,J-I_DIFF], J-I-2*I_DIFF>I_MED_MAX )
      DO J=I+(I_MED_MAX+2*I_DIFF_P_AP+1),NMRES           
        LAMBDA_P_AP(2)=LAMBDA_P_AP(2)+THETA(I,J)*THETA(I+I_DIFF_P_AP,J-I_DIFF_P_AP)
        F_CORD(I,:,K)=F_CORD(I,:,K)-(-WEIGHT_P_AP(2))*DIST_FACTOR(I,J,:)*THETA_DOT(I,J)*THETA(I+I_DIFF_P_AP,J-I_DIFF_P_AP)
        F_CORD(J,:,K)=F_CORD(J,:,K)+(-WEIGHT_P_AP(2))*DIST_FACTOR(I,J,:)*THETA_DOT(I,J)*THETA(I+I_DIFF_P_AP,J-I_DIFF_P_AP)
        F_CORD(I+I_DIFF_P_AP,:,K)=F_CORD(I+I_DIFF_P_AP,:,K)-(-WEIGHT_P_AP(2))*DIST_FACTOR(I+I_DIFF_P_AP,J-I_DIFF_P_AP,:) &
                                                                            *THETA_DOT(I+I_DIFF_P_AP,J-I_DIFF_P_AP)*THETA(I,J)
        F_CORD(J-I_DIFF_P_AP,:,K)=F_CORD(J-I_DIFF_P_AP,:,K)+(-WEIGHT_P_AP(2))*DIST_FACTOR(I+I_DIFF_P_AP,J-I_DIFF_P_AP,:) &
                                                                            *THETA_DOT(I+I_DIFF_P_AP,J-I_DIFF_P_AP)*THETA(I,J)
      ENDDO
      ENDDO


      DO I=1,NMRES-(I_MED_MAX+1+I_DIFF_P_AP)  !P LONG RANGE ( [I,J] + [I+I_DIFF,J+I_DIFF], J-I>I_MED_MAX )
      DO J=I+(I_MED_MAX+1),NMRES-I_DIFF_P_AP
        LAMBDA_P_AP(3)=LAMBDA_P_AP(3)+THETA(I,J)*THETA(I+I_DIFF_P_AP,J+I_DIFF_P_AP)
        F_CORD(I,:,K)=F_CORD(I,:,K)-(-WEIGHT_P_AP(3))*DIST_FACTOR(I,J,:)*THETA_DOT(I,J)*THETA(I+I_DIFF_P_AP,J+I_DIFF_P_AP)
        F_CORD(J,:,K)=F_CORD(J,:,K)+(-WEIGHT_P_AP(3))*DIST_FACTOR(I,J,:)*THETA_DOT(I,J)*THETA(I+I_DIFF_P_AP,J+I_DIFF_P_AP)
        F_CORD(I+I_DIFF_P_AP,:,K)=F_CORD(I+I_DIFF_P_AP,:,K)-(-WEIGHT_P_AP(3))*DIST_FACTOR(I+I_DIFF_P_AP,J+I_DIFF_P_AP,:) &
                                                                            *THETA_DOT(I+I_DIFF_P_AP,J+I_DIFF_P_AP)*THETA(I,J)
        F_CORD(J+I_DIFF_P_AP,:,K)=F_CORD(J+I_DIFF_P_AP,:,K)+(-WEIGHT_P_AP(3))*DIST_FACTOR(I+I_DIFF_P_AP,J+I_DIFF_P_AP,:) &
                                                                            *THETA_DOT(I+I_DIFF_P_AP,J+I_DIFF_P_AP)*THETA(I,J)
      ENDDO
      ENDDO


      END
