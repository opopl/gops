
!     --------------------- HDRGN.F ----------------------

      SUBROUTINE HDRGN(PRO_CORD,F_CORD,TEMPAV,E)
 
!     --------------------------------------------------

!     HDRGN FINDS THE  POTENTIAL DUE TO HYDROGEN BONDS 
!     BETWEEN N AND O     

!     ---------------------------------------------------

      USE AMHGLOBALS,  ONLY: AMHMAXSIZ,HBSCL,NMRES,HO_ZERO,NO_ZERO,IRES,&
                       SIGMA_NO,SIGMA_H,HBOND,MAXCRD

      IMPLICIT NONE

!     ARGUMENT DECLARATIONS:

       DOUBLE PRECISION, INTENT(IN):: PRO_CORD(AMHMAXSIZ,3,MAXCRD)
       DOUBLE PRECISION, INTENT(OUT):: F_CORD(AMHMAXSIZ,3,MAXCRD),E(:,:)
       LOGICAL, INTENT(IN):: TEMPAV
          
!     INTERNAL VARIABLES:

       INTEGER ISIT1,ISIT2,ADD,I_CLASS,I_RES
       DOUBLE PRECISION DISTANCES(AMHMAXSIZ,AMHMAXSIZ,2),RNO(9),HPOT(9), &
                        HPOT_TOT,NITCORD(AMHMAXSIZ,3),RHO(9),H_CORD(AMHMAXSIZ,3), &
                        HVAL1,HVAL2,HVAL3,NVAL1,NVAL2,NVAL3

!         PARAMETER(SIGMA_H=1.732)  ! THORNTON = 0.19  
!         PARAMETER(SIGMA_NO=0.71) ! THORNTON = 0.17
!         PARAMETER(HO_ZERO=2.2)  ! THORNTON = 2.06
!         PARAMETER(NO_ZERO=2.960) ! THORNTON = 2.98

         EXTERNAL HFORCE
!     --------------------- BEGIN -----------------------

!     ZERO FORCE AND ENERGY

      F_CORD=0.0D0
      E=0.0D0


      NVAL1=0.483D0
      NVAL2=0.703D0
      NVAL3=0.186D0

      HVAL1=0.8409657D0
      HVAL2=0.8929599D0 
      HVAL3=0.7339256D0


!     CALCULATE COORDINATES AND DISTANCES

          DO  I_RES=2,NMRES

        NITCORD(I_RES,1)=NVAL1*PRO_CORD(I_RES-1,1,1) &
                        +NVAL2*PRO_CORD(I_RES,1,1)  &
                        -NVAL3*PRO_CORD(I_RES-1,1,3)

        NITCORD(I_RES,2)=NVAL1*PRO_CORD(I_RES-1,2,1) &
                        +NVAL2*PRO_CORD(I_RES,2,1)  &
                        -NVAL3*PRO_CORD(I_RES-1,2,3)

        NITCORD(I_RES,3)=NVAL1*PRO_CORD(I_RES-1,3,1) &
                        +NVAL2*PRO_CORD(I_RES,3,1)  &
                        -NVAL3*PRO_CORD(I_RES-1,3,3)


        H_CORD(I_RES,1) = HVAL1*PRO_CORD(I_RES-1,1,1) &
                         +HVAL2*PRO_CORD(I_RES,1,1)  &
                         -HVAL3*PRO_CORD(I_RES-1,1,3)

        H_CORD(I_RES,2) = HVAL1*PRO_CORD(I_RES-1,2,1) &
                         +HVAL2*PRO_CORD(I_RES,2,1)  &
                         -HVAL3*PRO_CORD(I_RES-1,2,3)

        H_CORD(I_RES,3) = HVAL1*PRO_CORD(I_RES-1,3,1) &
                         +HVAL2*PRO_CORD(I_RES,3,1)  &
                         -HVAL3*PRO_CORD(I_RES-1,3,3)

   ENDDO


        DO ISIT1 = 1,NMRES
        DO ISIT2 = 1,NMRES

        DISTANCES(ISIT1,ISIT2,1) = DSQRT (           &
        (PRO_CORD(ISIT1,1,3)-NITCORD(ISIT2,1))**2 + &
        (PRO_CORD(ISIT1,2,3)-NITCORD(ISIT2,2))**2 + &
        (PRO_CORD(ISIT1,3,3)-NITCORD(ISIT2,3))**2 )

        DISTANCES(ISIT1,ISIT2,2) = DSQRT(            &
        (PRO_CORD(ISIT1,1,3)-H_CORD(ISIT2,1))**2 +  &
        (PRO_CORD(ISIT1,2,3)-H_CORD(ISIT2,2))**2 +  &
        (PRO_CORD(ISIT1,3,3)-H_CORD(ISIT2,3))**2 )

        ENDDO
        ENDDO


        DO  ISIT1=3,NMRES-2

        DO  ISIT2 = 3,NMRES-2

        IF ((IRES(ISIT1) .NE. 15) .AND. (IRES(ISIT2) .NE. 15) ) THEN
        IF (ABS(ISIT2-ISIT1) .GT. 2)  THEN
        IF (DISTANCES(ISIT1,ISIT2,1) .LT. 7.0D0) THEN

        RNO(1)=DISTANCES(ISIT1,ISIT2,1)
        RHO(1)=DISTANCES(ISIT1,ISIT2,2)

        RNO(2)=DISTANCES(ISIT1-1,ISIT2,1)
        RHO(2)=DISTANCES(ISIT1-1,ISIT2,2)

        RNO(3)=DISTANCES(ISIT1+1,ISIT2,1)
        RHO(3)=DISTANCES(ISIT1+1,ISIT2,2)

        RNO(4)=DISTANCES(ISIT1-2,ISIT2,1)
        RHO(4)=DISTANCES(ISIT1-2,ISIT2,2)

        RNO(5)=DISTANCES(ISIT1+2,ISIT2,1)
        RHO(5)=DISTANCES(ISIT1+2,ISIT2,2)

        RNO(6)=DISTANCES(ISIT1,ISIT2-1,1)
        RHO(6)=DISTANCES(ISIT1,ISIT2-1,2)

        RNO(7)=DISTANCES(ISIT1,ISIT2+1,1)
        RHO(7)=DISTANCES(ISIT1,ISIT2+1,2)

        RNO(8)=DISTANCES(ISIT1,ISIT2-2,1)
        RHO(8)=DISTANCES(ISIT1,ISIT2-2,2)

        RNO(9)=DISTANCES(ISIT1,ISIT2+2,1)
        RHO(9)=DISTANCES(ISIT1,ISIT2+2,2)


          I_CLASS = 3
          IF (ABS(ISIT2-ISIT1) .LT. 13) I_CLASS = 2
          IF (ABS(ISIT2-ISIT1) .LT. 5)  I_CLASS = 1


          DO ADD = 1,9

          HPOT(ADD)= -1.0D0*( EXP(-(RNO(ADD)-NO_ZERO)**2/(2.0D0*(SIGMA_NO**2)) - &
          (RHO(ADD) - HO_ZERO)**2/(2.0D0*(SIGMA_H**2)) ) )

          ENDDO 

        HPOT_TOT = HPOT(1) 

        DO ADD = 2,9

        HPOT_TOT = HPOT_TOT + HPOT(1)*HPOT(ADD)

        ENDDO

        HPOT_TOT = HBSCL(I_CLASS)*HPOT_TOT

        IF (TEMPAV)THEN
          E(1,1)=E(1,1)+HPOT_TOT
          E(1,13+I_CLASS)=E(1,13+I_CLASS)+HPOT_TOT
        ENDIF


!     FIND FORCE DUE TO HBONDS

         IF (HBOND) THEN


        CALL HFORCE(H_CORD,NITCORD,ISIT1,ISIT2,RNO(1),RHO(1),HPOT(1),1.0D0,I_CLASS,F_CORD)

        CALL HFORCE(H_CORD,NITCORD,ISIT1,ISIT2,RNO(1),RHO(1),HPOT(1),HPOT(2),I_CLASS,F_CORD)
        CALL HFORCE(H_CORD,NITCORD,ISIT1-1,ISIT2,RNO(2),RHO(2),HPOT(2),HPOT(1),I_CLASS,F_CORD)

        CALL HFORCE(H_CORD,NITCORD,ISIT1,ISIT2,RNO(1),RHO(1),HPOT(1),HPOT(3),I_CLASS,F_CORD)
        CALL HFORCE(H_CORD,NITCORD,ISIT1+1,ISIT2,RNO(3),RHO(3),HPOT(3),HPOT(1),I_CLASS,F_CORD) 

        CALL HFORCE(H_CORD,NITCORD,ISIT1,ISIT2,RNO(1),RHO(1),HPOT(1),HPOT(4),I_CLASS,F_CORD) 
        CALL HFORCE(H_CORD,NITCORD,ISIT1-2,ISIT2,RNO(4),RHO(4),HPOT(4),HPOT(1),I_CLASS,F_CORD)

        CALL HFORCE(H_CORD,NITCORD,ISIT1+2,ISIT2,RNO(1),RHO(1),HPOT(1),HPOT(5),I_CLASS,F_CORD)
        CALL HFORCE(H_CORD,NITCORD,ISIT1,ISIT2-1,RNO(5),RHO(5),HPOT(5),HPOT(1),I_CLASS,F_CORD)

        CALL HFORCE(H_CORD,NITCORD,ISIT1,ISIT2,RNO(1),RHO(1),HPOT(1),HPOT(6),I_CLASS,F_CORD)
        CALL HFORCE(H_CORD,NITCORD,ISIT1,ISIT2-1,RNO(6),RHO(6),HPOT(6),HPOT(1),I_CLASS,F_CORD)

        CALL HFORCE(H_CORD,NITCORD,ISIT1,ISIT2,RNO(1),RHO(1),HPOT(1),HPOT(7),I_CLASS,F_CORD)
        CALL HFORCE(H_CORD,NITCORD,ISIT1,ISIT2+1,RNO(7),RHO(7),HPOT(7),HPOT(1),I_CLASS,F_CORD)

        CALL HFORCE(H_CORD,NITCORD,ISIT1,ISIT2,RNO(1),RHO(1),HPOT(1),HPOT(8),I_CLASS,F_CORD)
        CALL HFORCE(H_CORD,NITCORD,ISIT1,ISIT2-2,RNO(8),RHO(8),HPOT(8),HPOT(1),I_CLASS,F_CORD)

        CALL HFORCE(H_CORD,NITCORD,ISIT1,ISIT2,RNO(1),RHO(1),HPOT(1),HPOT(9),I_CLASS,F_CORD)
        CALL HFORCE(H_CORD,NITCORD,ISIT1,ISIT2+2,RNO(9),RHO(9),HPOT(9),HPOT(1),I_CLASS,F_CORD)

        
        ENDIF ! ENDIF HBOND

        ENDIF ! PROLINE (IRES = 15)
        ENDIF ! DISTANCES CUT-OFF
        ENDIF ! ISIT2-ISIT1 .GT. 2

        ENDDO   ! ISIT2        


        ENDDO  ! ISIT1


!     ----------------------- DONE -----------------------

      RETURN
      END
