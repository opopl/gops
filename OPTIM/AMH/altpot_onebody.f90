      SUBROUTINE INIT_ONEBODY()
  
        USE GLOBALS_ALT, ONLY : ONEBODY_GAMMA,HP_SCALE,KAPPA_OB,ALIMITS_OB,ONEBODYFLAG &
             ,MAX_LETTERS,OB_DENSITY,OB_DNS_COUNT
        IMPLICIT NONE
        INTEGER I

        ONEBODYFLAG=0

        ALIMITS_OB(1,1)=0.0D0
        ALIMITS_OB(2,1)=3.0D0
        ALIMITS_OB(1,2)=3.0D0
        ALIMITS_OB(2,2)=6.0D0
        ALIMITS_OB(1,2)=6.0D0
        ALIMITS_OB(2,2)=9.0D0

        KAPPA_OB=3.0D0
        DO I=1,MAX_LETTERS,1
           ONEBODY_GAMMA(I,1)=1.- HP_SCALE(I)
           ONEBODY_GAMMA(I,2)=HP_SCALE(I)*.5D0 +.25D0
           ONEBODY_GAMMA(I,3)=HP_SCALE(I)
        ENDDO

        OB_DENSITY=0.0D0
        OB_DNS_COUNT=0.0D0

        RETURN
      END SUBROUTINE INIT_ONEBODY

      !----------------------------

      SUBROUTINE CALC_OB_DENSITY(A,NMRES)

        USE AMHGLOBALS,  ONLY : AMHMAXSIZ,TGSEQUENCES_AMW,NUMSEQ_AMW
        USE GLOBALS_ALT, ONLY :OB_DNS_COUNT,OB_DENSITY,ALIMITS_OB
        IMPLICIT NONE
        DOUBLE PRECISION A(AMHMAXSIZ),A_I
        INTEGER WELL,ITYPE,NMRES,I,ISEQ

        OB_DNS_COUNT=OB_DNS_COUNT+1.0D0
        OB_DENSITY=0.0D0

       DO ISEQ=1,NUMSEQ_AMW
        DO I=1,NMRES
           ITYPE=TGSEQUENCES_AMW(I,ISEQ)
           A_I=A(I)
           WELL=1
           IF(A_I .GT. ALIMITS_OB(1,2) .AND. A_I .LE. ALIMITS_OB(2,2) )WELL=2
           IF(A_I .GT. ALIMITS_OB(1,3) .AND. A_I .LE. ALIMITS_OB(2,3) )WELL=3
           OB_DENSITY(ITYPE,WELL)=OB_DENSITY(ITYPE,WELL)+1.0
        ENDDO
       ENDDO

          OB_DENSITY=OB_DENSITY/REAL(NUMSEQ_AMW)

        RETURN
      END SUBROUTINE CALC_OB_DENSITY

      !-------------------------------------------
      !
      ! ENERGY_OB = -GAMMA*F(A)
      ! FORCE_OB  = +GAMMA*DF(A)/DR = +GAMMA*[DF(A)/DA] * [DA/DR] = 
      !  GAMMA*SUM(I,K) {[DTHETA/DDRIJ] }

      SUBROUTINE CALC_ONEBODY_FORCE(F_CORD,THETA_DOT,XYZ_UNIT_VECT,NMRES,A)

        USE AMHGLOBALS,  ONLY : AMHMAXSIZ,MAXCRD,TGSEQUENCES_AMW,NUMSEQ_AMW
        USE GLOBALS_ALT, ONLY : MAX_WELL_ALT,ACCUMULATED_TIME
! DEBUGGING   USE GLOBALS_ALT, ONLY :  OB_DENSITY,OB_DNS_COUNT,  
        USE ALTPOT_INTERFACES, ONLY: CALC_OB_DENSITY, CALC_DDA_ONEBODY


        IMPLICIT NONE
       DOUBLE PRECISION, INTENT(OUT):: F_CORD(AMHMAXSIZ,3,MAXCRD)
!        DOUBLE PRECISION F_CORD(AMHMAXSIZ,3,MAXCRD)
        INTEGER, INTENT(IN):: NMRES
        DOUBLE PRECISION A(AMHMAXSIZ),THETA_DOT(AMHMAXSIZ,AMHMAXSIZ,MAX_WELL_ALT)
        DOUBLE PRECISION F_OB(AMHMAXSIZ,3),XYZ_UNIT_VECT(AMHMAXSIZ,AMHMAXSIZ,3)
        DOUBLE PRECISION DDAMAT(AMHMAXSIZ)
! DEBUGGING   DOUBLE PRECISION OB_FORCE(AMHMAXSIZ)
        INTEGER ITYPE,I,J,IATOM,ISEQ

        DOUBLE PRECISION START_TIME, END_TIME

!        EXTERNAL CPU_TIME 

        CALL CPU_TIME(START_TIME)

        F_OB=0.0D0

       DO ISEQ=1,NUMSEQ_AMW,1
        DO I=1,NMRES,1
           ITYPE=TGSEQUENCES_AMW(I,ISEQ)
           DDAMAT(I)=CALC_DDA_ONEBODY(A(I),ITYPE)
        ENDDO
       ENDDO


        DO J=1,NMRES,1
           DO I=1,NMRES,1
              IF(I.NE.J) THEN
                 F_OB(J,:)=F_OB(J,:)-DDAMAT(I)*THETA_DOT(J,I,1)*XYZ_UNIT_VECT(J,I,:)
              ENDIF
              IF(ABS(I-J).GT.1) THEN
                 F_OB(J,:)=F_OB(J,:)-DDAMAT(J)*THETA_DOT(J,I,1)*XYZ_UNIT_VECT(J,I,:)
              ENDIF
           ENDDO
        ENDDO

        ! FOR DEBUGGING, SHOULD BE SWITCHED OFF
        !      OPEN(UNIT=1001,FILE='KOLLA_OB_FORCE',STATUS='UNKNOWN')  
        !       IF(OB_DNS_COUNT.LT.3.)REWIND(1001)
        !       WRITE(1001,100)OB_DNS_COUNT,(F_OB(I,1),I=1,30)
        !      CLOSE(1001)XYZ_UNIT_VECT(I,J,:)
        !100   FORMAT(200(1X,E12.6))

        DO I=1,NMRES,1                  
           IATOM=2
!    HACK FOR CONSISTENCY
           IF (TGSEQUENCES_AMW(I,1) .EQ. 8) IATOM=1
           F_CORD(I,:,IATOM)=F_CORD(I,:,IATOM)+F_OB(I,:)
        ENDDO

        CALL CALC_OB_DENSITY(A,NMRES)


        CALL CPU_TIME(END_TIME)
        ACCUMULATED_TIME(3)=ACCUMULATED_TIME(3)+END_TIME-START_TIME
        RETURN
      END SUBROUTINE CALC_ONEBODY_FORCE



      !----------------------------------


      DOUBLE PRECISION FUNCTION CALC_ONEBODY_POT(A,NMRES,E_OB)

        USE AMHGLOBALS,  ONLY : AMHMAXSIZ,TGSEQUENCES_AMW,NUMSEQ_AMW
        USE GLOBALS_ALT, ONLY : ONEBODY_GAMMA,KAPPA_OB,ALIMITS_OB,ONEBODY_TYPE

        IMPLICIT NONE
        DOUBLE PRECISION A(AMHMAXSIZ),OBPOT1,OBPOT2,OBPOT3,ENERGY,E_OB(3)
        INTEGER ITYPE,I,NMRES,ISEQ

        ENERGY=0.0D0
        E_OB=0.0D0

        IF(ONEBODY_TYPE.EQ.1)THEN
            DO ISEQ=1,NUMSEQ_AMW
             DO I=1,NMRES
                 ITYPE=TGSEQUENCES_AMW(I,ISEQ)
                 ENERGY=ENERGY-ONEBODY_GAMMA(ITYPE,1)*A(I)
             ENDDO
            ENDDO
           E_OB(1)=ENERGY/REAL(NUMSEQ_AMW)
        ELSEIF(ONEBODY_TYPE.EQ.2)THEN
          DO ISEQ=1,NUMSEQ_AMW
           DO I=1,NMRES
               ITYPE=TGSEQUENCES_AMW(I,ISEQ)
!              ITYPE=IRES(I)
              OBPOT1=(TANH(KAPPA_OB*(A(I)-ALIMITS_OB(1,1)))+ &
                   TANH(KAPPA_OB*(ALIMITS_OB(2,1)-A(I))))*ONEBODY_GAMMA(ITYPE,1)
              OBPOT2=(TANH(KAPPA_OB*(A(I)-ALIMITS_OB(1,2)))+ &
                   TANH(KAPPA_OB*(ALIMITS_OB(2,2)-A(I))))*ONEBODY_GAMMA(ITYPE,2)
              OBPOT3=(TANH(KAPPA_OB*(A(I)-ALIMITS_OB(1,3)))+ &
                   TANH(KAPPA_OB*(ALIMITS_OB(2,3)-A(I))))*ONEBODY_GAMMA(ITYPE,3)
              E_OB(1)=E_OB(1)-OBPOT1*0.5D0
              E_OB(2)=E_OB(2)-OBPOT2*0.5D0
              E_OB(3)=E_OB(3)-OBPOT3*0.5D0
              !       IF(I.EQ.30) WRITE(*,*) "OB DETAILS: ", A(I)
           ENDDO
          ENDDO
            ENERGY=E_OB(1)/REAL(NUMSEQ_AMW)+ & 
                        E_OB(2)/REAL(NUMSEQ_AMW)+ & 
                        E_OB(3)/REAL(NUMSEQ_AMW)
           !     WRITE(*,*) "OB 2: ", E_OB(1),E_OB(2),E_OB(3),ENERGY
        ELSE
           ENERGY=0.0D0
        ENDIF

        CALC_ONEBODY_POT=ENERGY
        RETURN
      END FUNCTION CALC_ONEBODY_POT


      !---------------------------------------
      ! 
      DOUBLE PRECISION FUNCTION CALC_DDA_ONEBODY(A_I,ITYPE)

        USE GLOBALS_ALT, ONLY : ONEBODY_GAMMA,KAPPA_OB,ALIMITS_OB,ONEBODY_TYPE
        IMPLICIT NONE
        INTEGER ITYPE
        DOUBLE PRECISION A_I,T11,T12,T21,T22,T13,T23,DDA1,DDA2,DDA3

        IF(ONEBODY_TYPE.EQ.1)THEN
           CALC_DDA_ONEBODY=ONEBODY_GAMMA(ITYPE,1)
        ELSEIF(ONEBODY_TYPE.EQ.2)THEN
           T11=TANH(KAPPA_OB*(A_I-ALIMITS_OB(1,1)))
           T21=TANH(KAPPA_OB*(ALIMITS_OB(2,1)-A_I))
           T12=TANH(KAPPA_OB*(A_I-ALIMITS_OB(1,2)))
           T22=TANH(KAPPA_OB*(ALIMITS_OB(2,2)-A_I))
           T13=TANH(KAPPA_OB*(A_I-ALIMITS_OB(1,3)))
           T23=TANH(KAPPA_OB*(ALIMITS_OB(2,3)-A_I))
           DDA1=(T21**2 - T11**2 )*KAPPA_OB*ONEBODY_GAMMA(ITYPE,1)*0.5D0
           DDA2=(T22**2 - T12**2 )*KAPPA_OB*ONEBODY_GAMMA(ITYPE,2)*0.5D0
           DDA3=(T23**2 - T13**2 )*KAPPA_OB*ONEBODY_GAMMA(ITYPE,3)*0.5D0
           CALC_DDA_ONEBODY=-1*(DDA1+DDA2+DDA3)
        ELSE
           CALC_DDA_ONEBODY=0.0D0
        ENDIF

        RETURN
      END FUNCTION CALC_DDA_ONEBODY
