      SUBROUTINE REP_BIAS(PRCORD,FRCORD,E)

!     THIS SUBROUTINE IS CALLED BY FORCE.F AND WILL
!     CALCULATE THE FORCE ON  REPLICAS INTRODUCED 
!     BY THE INTERREPLICA POTENTIAL
!     THIS FORCE IS MATCHED WITH THE EXPERIMENTAL 
!     PHIVALUES READ IN EARLIER

!     DECLARING VARIABLES
      USE AMHGLOBALS,  ONLY: AMHMAXSIZ,MAXCRD,NMRES,NUMPRO,MAXPRO,REP_LAMBDA,REP_PHI_EXP,&
        REP_CUT_OFF,REP_TOL,N_REP_CON,REP_CON_2_RES

       DOUBLE PRECISION, INTENT(IN):: PRCORD(AMHMAXSIZ,3,MAXPRO,MAXCRD)
       DOUBLE PRECISION, INTENT(OUT):: FRCORD(AMHMAXSIZ,3,MAXPRO,MAXCRD),E

      INTEGER :: I_RES,N_REP,J_RES,I_CON,I_REP
      DOUBLE PRECISION :: R(MAXPRO,AMHMAXSIZ,AMHMAXSIZ),R0,PHI_SIM(NMRES),KERNEL(MAXPRO,AMHMAXSIZ)

!     I_RES,J_RES,N_REP ARE INTEGERS DO LOOP OVER RESIDUES OR NUMBER OF REPLICAS
!     AMHMAXSIZ= MAX SIZE FOR ARRAY FOR HOLDING RESIDUES
!     MAXCRD = 3 X,Y,Z
!     NMRES  NUMBER OF RES OF PROTEIN
!     NUMPRO NUMBER OF REPLICAS
!     MAXPRO  PARAMETER MAXIMUM NUMBER OF REPLICAS POSSIBLE
!     REP_LAMBDA IS THE LAMBDA COEFFICIENT DETERMINING THE UNCERTAINTIES IN THE FORCE
!     REP_PHI_EXP ARE THE EXPERIMENTAL PHI VALUES READ IN IN REP_CONTACT
!     REP_CUT_OFF AND REP_TOL DETERMINE R0 THE RADIUS USED FOR DETERMINING A CONTACT 
      R0=REP_CUT_OFF+REP_TOL
!     N_REP_CON IS THE AMOUNT TOTAL NUMBER OF CONTACTS MADE FOR RESIDUE I
!     REP_CON_2_RES SPECIFIES THE RESIDUE LABEL OF THE MADE CONTACT 
!     PRCORD ARE THE COORDINATES OF THE PROTEIN
!     FRCORD IS THE RESULTING FORCE
!     TEMPAV IS A FLAG THAT STORES ENERGIES OR NOT
!     E IS THE TOTAL REPLICA ENERGY
!     R IS AN RADIUS ARRAY OF RESIDUES IN SPECIFIED REPLICAS
!     PHI_SIM ARE THE CALCULATED PHIVALUES FOR A CERTAIN RESIDUE
!     KERNEL IS EXPLAINED LATER, IT IA PHI*LAMBDA

!     WE WANT CB DISTANCES, SO WE SET MXCRD ARRAY ENTRY TO 2

!     WE NEED TO CALCULATE ALL THE
!     DISTANCES BETWEEN RESIDUES DURING EACH FOLDING RUN
!     WE GET THE DISTANCES FROM PRCORD

      DO N_REP=1,NUMPRO
      DO I_RES=1,NMRES
      DO J_RES=1,NMRES
              R(N_REP,I_RES,J_RES)=SQRT(SUM((PRCORD(I_RES,:,N_REP,2)-PRCORD(J_RES,:,N_REP,2))**2))
      END DO
      END DO
      END DO

!     CALCULATING THE FORCE, WE HAVE A CONSTANT PIECE FOR 
!     THE FORCE, CALLED KERNEL ,AND A MULTIPLICATIVE TERM
!     LET US CALCULATE THE KERNEL FIRST 
!     WE NEED PHI VALUES TO CALCULATE THE KERNEL
 
!     SETTING KERNEL AND PHISIM EQUL TO 0

      KERNEL=0
      PHI_SIM=0

!     LOOPS TO CALCULATE KERNEL AND PHISIM

      DO I_REP=1,NUMPRO
      DO I_RES=1,NMRES
      DO I_CON=1,N_REP_CON(I_RES)
                J_RES=REP_CON_2_RES(I_RES,I_CON)
                PHI_SIM(I_RES)=PHI_SIM(I_RES)+((0.5/N_REP_CON(I_RES))*(1.0+TANH(5.0*(R0-R(I_REP,I_RES,J_RES)))))/NUMPRO
      END DO
      END DO
      END DO

      DO I_REP=1,NUMPRO
      DO I_RES=1,NMRES
          KERNEL(I_REP,I_RES)=REP_LAMBDA(I_RES)*(PHI_SIM(I_RES)-REP_PHI_EXP(I_RES))
      END DO
      END DO

!     SETTING THE FORCE EQUAL TO ZERO

      FRCORD=0.0

!     FORCE TERM IN SPECIFIED DIRECTION
!     WE SIMPLY NEED TO SET UP ARRAYS THAT HOLD ALL THE FORCES IN X,Y,Z 
!     DIRECTION FOR RESIDUE I_RES

      DO N_REP=1,NUMPRO
      DO I_RES=1,NMRES
      IF (N_REP_CON(I_RES) .EQ.0) THEN
          FRCORD(I_RES,:,N_REP,2)=FRCORD(I_RES,:,N_REP,2)+0.0
      ELSE
      DO I_CON=1,N_REP_CON(I_RES)
          J_RES=REP_CON_2_RES(I_RES,I_CON)
          FRCORD(I_RES,:,N_REP,2)=FRCORD(I_RES,:,N_REP,2)+(PRCORD(I_RES,:,N_REP,2)-PRCORD(J_RES,:,N_REP,2))&
          *((KERNEL(N_REP,I_RES)+KERNEL(N_REP,J_RES))/R(N_REP,I_RES,J_RES))&
          *5.0*(1.0-(TANH(5.0*(R0-R(N_REP,I_RES,J_RES))))**2)
      END DO
      END IF
    
      END DO
      END DO

!     WE ALSO NEED TO CALCULATE THE POTENTIAL ENERGY E
      E=0

      DO I_RES=1,NMRES
      DO I_REP=1,NUMPRO
        E=E+(KERNEL(I_REP,I_RES)**2)/REP_LAMBDA(I_RES)
      END DO
      END DO

      END

