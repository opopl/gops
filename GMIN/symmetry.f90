!  GMIN: A PROGRAM FOR FINDING GLOBAL MINIMA
!  COPYRIGHT (C) 1999-2006 DAVID J. WALES
!  THIS FILE IS PART OF GMIN.
!
!  GMIN IS FREE SOFTWARE; YOU CAN REDISTRIBUTE IT AND/OR MODIFY
!  IT UNDER THE TERMS OF THE GNU GENERAL PUBLIC LICENSE AS PUBLISHED BY
!  THE FREE SOFTWARE FOUNDATION; EITHER VERSION 2 OF THE LICENSE, OR
!  (AT YOUR OPTION) ANY LATER VERSION.
!
!  GMIN IS DISTRIBUTED IN THE HOPE THAT IT WILL BE USEFUL,
!  BUT WITHOUT ANY WARRANTY; WITHOUT EVEN THE IMPLIED WARRANTY OF
!  MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.  SEE THE
!  GNU GENERAL PUBLIC LICENSE FOR MORE DETAILS.
!
!  YOU SHOULD HAVE RECEIVED A COPY OF THE GNU GENERAL PUBLIC LICENSE
!  ALONG WITH THIS PROGRAM; IF NOT, WRITE TO THE FREE SOFTWARE
!  FOUNDATION, INC., 59 TEMPLE PLACE, SUITE 330, BOSTON, MA  02111-1307  USA
!
! OBJECTIVE - TO SYMMETRISE A SET OF INPUT COORDINATES.
!
SUBROUTINE SYMMETRY(JP,SCREENC,QDONE,BRUN,ITERATIONS,TIME,CHANGEDE,NSYMCALL, &
  &         LNQUENCH,NSUCCESS,NFAIL,EBEST,BESTCOORDS,JBEST,EPPREV)

USE COMMONS
USE PORFUNCS
IMPLICIT NONE
DOUBLE PRECISION :: LCOORDS(3*NATOMS), CMDIST(NATOMS), ORBDIST(NATOMS), T0, DPRAND, SR3, RANDOM
DOUBLE PRECISION :: LEBEST, QBEST(3*NATOMS), NEWQ(3*NATOMS), VATBEST(NATOMS)
DOUBLE PRECISION :: CMX(2), CMY(2), CMZ(2), CM(3), CMSAVE(3), COREVT(NATOMS), OTHERVT(NATOMS), VATTMP(NATOMS,NPAR)
DOUBLE PRECISION :: DUMMY, XMASS, YMASS, ZMASS, VATORIG(NATOMS)
DOUBLE PRECISION :: ORIGIN(3), MINDIST, VMIN, VMAX, TEMPVT(NATOMS)
DOUBLE PRECISION :: TIME, TRANSCOORDS(3*NATOMS), LTOLD, EBEST(NPAR), BESTCOORDS(3*NATOMS,NPAR), EPPREV(NPAR)
INTEGER :: J1, J2, NDUMMY, I, NORBIT, J, ISTART, LARGESIZE, NEWORB, J4, ISTAT, MYUNIT2, MYUNIT3, LNQUENCH
INTEGER :: J3, JP, NATOMSCORE, NORBITSCORE, NTOTAL, NMOVE, MOVEINDEX(NATOMS), LOOPLIMIT, QBCORE
INTEGER :: NFLOAT, NLOST, LASTORBIT, FIRSTLOST, NCOREREAL, NSUCCESS(NPAR), NFAIL(NPAR), JBEST(NPAR)
INTEGER :: NINDEX(NATOMS), ORBSIZE(NATOMS), NEWORBSIZE(NATOMS), NSYMOP
DOUBLE PRECISION :: SCOORDS(3*NATOMS), CLOSEOP(3,3)
! DOUBLE PRECISION :: ORBSORT(3*NATOMS), LCOORDSSORTED(3*NATOMS), RCOORDSSORTED(3*NATOMS)
DOUBLE PRECISION :: CORECOORDS(3*NATOMS), OTHERCOORDS(3*NATOMS), TMPCOORDS(3), NEWORBCOORDS(NATOMS,3*120)
DOUBLE PRECISION :: ORBCOORDS(3*NATOMS), DENOM, WORSTRAD
LOGICAL :: SYMLOST(120), CHANGE, NEW, MOVEDTOCORE(NATOMS), MATCHED, CHANGEDE, WEAKESTONLY, NEWOP, FAILED, QBORDERED, QBCHANGED
LOGICAL :: RESTRICT, LDUMMY, MOVETOCORE, USECLOSESUBGROUP, CHANGECLOSE, DOMISSING, LDEBUG, LOSTORBIT
DOUBLE PRECISION :: POTEL, SCREENC(3*NATOMS), GENMAT(100,3,3), GENMATSAVE(100,3,3), SYMOP(120,3,3), LOSTOP(120,3,3)
DOUBLE PRECISION :: NEWMAT(3,3), SYMOP1(3,3), SYMOP2(3,3), DIST2, SUBOP(120,3,3), DUMMYE, DUMMYGRAD(3*NATOMS), X(3*NATOMS)
INTEGER :: GENPERM(100,NATOMS), OPPERM(120,NATOMS)
INTEGER :: NQTOT, QDONE, BRUN, ITERATIONS, NCHOICE(NATOMS), NQTOTSAVE, IGEN, IGENSAVE, ORBSYM, NORDER, NCHOOSE
INTEGER :: ICOMP, IPRNT, LASTLOST, PERM(NATOMS), NTOPSUM, NTOP, NTRIES, NSUB, NCORENEW, NEWCOREINDEX(NATOMS), NCORETMP, NMISS
INTEGER :: NMISSING(NATOMS), NSYMCALL, NMINREM, NPOSS, LNCORE
INTEGER, ALLOCATABLE :: OCCS(:,:)
DOUBLE PRECISION :: QMISSING(NATOMS,3*120) ! NUMBER OF ORBITS <= NUMBER OF ATOMS
CHARACTER(LEN=4) FPGRP, POINTGROUP
CHARACTER(LEN=6) JPSTRING
DOUBLE PRECISION LHESS(3,3), SERROR, WORK(3), AMAT(3,3), SERROR2
INTEGER IPIVOT(3), INFO, PERM2(NATOMS)
DOUBLE PRECISION, PARAMETER :: EPS=1.0D-10
COMMON /MYPOT/ POTEL
COMMON /TOT/ NQTOT
LOGICAL EVAP, EVAPREJECT
COMMON /EV/ EVAP, EVAPREJECT

SAVE NORBIT, LASTORBIT, NORDER

MYUNIT2=NPAR+MYUNIT
MYUNIT3=2*NPAR+MYUNIT+1
WRITE(JPSTRING,'(I6)') JP
IPRNT=0
LDEBUG=DEBUG
! LDEBUG=.TRUE.
NSYMCALL=NSYMCALL+1   ! NSYMCALL SHOULD BE THE NUMBER OF CONSECUTIVE CALLS TO SYMMETRY WITH THIS MINIMUM
! PRINT '(A,5I)','NSYMCALL,NORDER,NORBIT,LASTORBIT,NORBIT-LASTORBIT+1=',NSYMCALL,NORDER,NORBIT,LASTORBIT,NORBIT-LASTORBIT+1
IF (NSYMCALL.GT.1) THEN
!  IF (NSYMCALL.GT.NORBIT-LASTORBIT+1) THEN
   IF (NSYMCALL.GT.1) THEN
!     IF (LDEBUG) WRITE(MYUNIT, '(A,I5,A)') 'MAXIMUM CALLS TO SYMMETRY ',NORBIT-LASTORBIT,' EXCEEDED FOR THIS MINIMUM'
      IF (LDEBUG) WRITE(MYUNIT, '(A)') 'MAXIMUM CONSECUTIVE CALLS TO SYMMETRY REACHED FOR THIS MINIMUM'
      RETURN 
   ENDIF
ENDIF
NSYMREM=0
MOVETOCORE=.TRUE. 	! MOVE COMPLETE ORBITS TO CORE
IF (.NOT.MOVETOCORE) PRINT '(A)','WARNING - MOVETOCORE IS FALSE'
WEAKESTONLY=.TRUE. 	! MOVE WEAKEST ATOM ONLY TO FLOATERS (OTHERWISE USE ASTEP CRITERION)
RESTRICT=.FALSE.   	! MOVE WEAKEST ATOMS TO FLOATER LIST ONLY IF THEY ARE INVARIANT TO CLOSEOP
USECLOSESUBGROUP=.FALSE.	! RANDOMLY USE THE SUBGROUP GENERATED BY CLOSEOP 
CHANGECLOSE=.FALSE.  	! RANDOMLY CHANGE THE CLOSEST LOST OPERATION TO THAT OF A DIFFERENT ORBIT
DOMISSING=.TRUE.     	! IDENTIFY MISSING POSITIONS FROM COMPLETE ORBITS WHEN SYMMETRY ELEMENTS ARE LOST
IF (NSYMCALL.GT.1) DOMISSING=.FALSE. ! NO POINT IN REPEATING!
CHANGEDE=.FALSE.
IF (LDEBUG) IPRNT=11
CALL MYCPU_TIME(T0)
LEBEST=EPREV(JP)
QBEST(1:3*NATOMS)=COORDS(1:3*NATOMS,JP)
VATBEST(1:NATOMS)=VAT(1:NATOMS,JP)
NQTOTSAVE=NQTOT
LCOORDS(1:3*NATOMS)=COORDS(1:3*NATOMS,JP)
VATORIG(1:NATOMS)=VAT(1:NATOMS,JP)
QBORDERED=.FALSE.
QBCHANGED=.FALSE.
QBCORE=0

LTOLD=SYMTOL2

ORIGIN(1:3)=0.0D0
LOOPLIMIT=NATOMS
IF (NCORE(JP).GT.10) THEN
   IF (NPAR.GT.1) THEN
      WRITE(MYUNIT,'(A,I1,A,I6,A)') '[',JP,']SYMMETRY> INITIALISING ORIGIN FOR ',NCORE(JP),' ATOMS'
   ELSE
      WRITE(MYUNIT,'(A,I6,A)') 'SYMMETRY> INITIALISING ORIGIN FOR ',NCORE(JP),' ATOMS'
   ENDIF
   LOOPLIMIT=NCORE(JP)
   DO I=NATOMS-NCORE(JP)+1,NATOMS
      ORIGIN(1)=ORIGIN(1)+LCOORDS(3*(I-1)+1)
      ORIGIN(2)=ORIGIN(2)+LCOORDS(3*(I-1)+2)
      ORIGIN(3)=ORIGIN(3)+LCOORDS(3*(I-1)+3)
   ENDDO
   ORIGIN(1:3)=ORIGIN(1:3)/LOOPLIMIT
ENDIF
NCORE(JP)=0 ! WILL BE RESET LATER - THIS IS THE DEFAULT

CMLOOP: DO J1=1,200
   XMASS=0.0D0; YMASS=0.0D0; ZMASS=0.0D0
   DENOM=0.0D0
   DO I=NATOMS-LOOPLIMIT+1,NATOMS
      IF (J1.GT.1) THEN
         DUMMY=EXP(-DISTFAC*CMDIST(I))
      ELSE
         DUMMY=1.0D0
      ENDIF
      XMASS=XMASS+LCOORDS(3*(I-1)+1)*DUMMY
      YMASS=YMASS+LCOORDS(3*(I-1)+2)*DUMMY
      ZMASS=ZMASS+LCOORDS(3*(I-1)+3)*DUMMY
      DENOM=DENOM+DUMMY
   ENDDO
   DUMMY=SQRT( (ORIGIN(1)-XMASS/DENOM)**2+(ORIGIN(2)-YMASS/DENOM)**2+(ORIGIN(3)-ZMASS/DENOM)**2)
   ORIGIN(1)=XMASS/DENOM;  ORIGIN(2)=YMASS/DENOM; ORIGIN(3)=ZMASS/DENOM
   DO J=1,NATOMS ! THE WHOLE CMDIST VECTOR IS NEEDED BELOW
      CMDIST(J)=SQRT((LCOORDS(3*(J-1)+1)-ORIGIN(1))**2+ &
                     (LCOORDS(3*(J-1)+2)-ORIGIN(2))**2+ &
                     (LCOORDS(3*(J-1)+3)-ORIGIN(3))**2)
   ENDDO
   IF (LDEBUG) WRITE(MYUNIT, '(A,I5,3G20.10)') 'CYCLE, ORIGIN:',J1,ORIGIN(1:3)
   IF ((J1.GT.1).AND.(DUMMY.LT.1.0D-4)) EXIT CMLOOP 
ENDDO CMLOOP

DO J=1,NATOMS
   NINDEX(J)=J
ENDDO

IF (LDEBUG) WRITE(MYUNIT, '(A,3F15.5)') 'INITIAL CENTRE OF MASS: ',ORIGIN(1:3)
SCOORDS(1:3*NATOMS)=LCOORDS(1:3*NATOMS)
CALL PIKSR2(NATOMS,CMDIST,NINDEX) ! SORTS CMDIST AND NINDEX
! WRITE(MYUNIT,'(A)') 'SYMMETRY> CMDIST AND NINDEX:'
! WRITE(MYUNIT,'(F15.5,I8)') (CMDIST(J1),NINDEX(J1),J1=1,NATOMS)
! CALL GETORBITS(NORBIT,ORBDIST,CMDIST,NATOMS,ORBSIZE,SYMTOL1,LARGESIZE,NINDEX,LCOORDS,LDEBUG)
! FIND THE LARGEST GAP BETWEEN CM DISTANCES AND USE THE CENTRE-OF-MASS OF ALL THE ATOMS UP TO THAT POINT
CMX(1)=0.0D0; CMY(1)=0.0D0; CMZ(1)=0.0D0
CMX(2)=LCOORDS(3*(NINDEX(1)-1)+1); CMY(2)=LCOORDS(3*(NINDEX(1)-1)+2); CMZ(2)=LCOORDS(3*(NINDEX(1)-1)+3)
! STORE SUM OF CENTRES OF MASS FROM PREVIOUS LARGEST GAP TO CURRENT IN CMX(2).
GMAX=-1.0D0
DO J=2,NATOMS
   IF (ABS(CMDIST(J)-CMDIST(J-1)).GT.GMAX) THEN
      GMAX=ABS(CMDIST(J)-CMDIST(J-1))
      NDUMMY=J-1
      CMX(1)=CMX(1)+CMX(2); CMY(1)=CMY(1)+CMY(2); CMZ(1)=CMZ(1)+CMZ(2)
      CMX(2)=LCOORDS(3*(NINDEX(J)-1)+1); CMY(2)=LCOORDS(3*(NINDEX(J)-1)+2); CMZ(2)=LCOORDS(3*(NINDEX(J)-1)+3)
   ELSE
      CMX(2)=CMX(2)+LCOORDS(3*(NINDEX(J)-1)+1); CMY(2)=CMY(2)+LCOORDS(3*(NINDEX(J)-1)+2); CMZ(2)=CMZ(2)+LCOORDS(3*(NINDEX(J)-1)+3)
   ENDIF
!  PRINT '(A,I5,2G20.10)','J,DIFF,GMAX=',J,ABS(CMDIST(J)-CMDIST(J-1)),GMAX
ENDDO
CMX(1)=CMX(1)/NDUMMY; CMY(1)=CMY(1)/NDUMMY; CMZ(1)=CMZ(1)/NDUMMY


! IF (LDEBUG) PRINT '(A,3F15.5)','ORIGIN WILL BE MOVED TO CENTRE OF MASS FOR FIRST ORBIT: ',CMX(1),CMY(1),CMZ(1)
! IF (LDEBUG) PRINT '(A,I6,A,F15.5,A)','ORBIT SIZE: ',ORBSIZE(1),' DISTANCE ',ORBDIST(1),' MEMBERS:'
IF (LDEBUG) WRITE(MYUNIT, '(A,3F15.5)') 'ORIGIN WILL BE MOVED TO CENTRE OF MASS FOR ATOMS UP TO BIGGEST GAP: ',CMX(1),CMY(1),CMZ(1)
IF (LDEBUG) WRITE(MYUNIT, '(A,I6,A,F15.5,A)') 'NUMBER OF ATOMS=',NDUMMY
ORBSIZE(1)=NDUMMY
IF (LDEBUG) WRITE(MYUNIT, '(12I5)')  (NINDEX(J1),J1=1,ORBSIZE(1))
ORIGIN(1)=CMX(1)
ORIGIN(2)=CMY(1)
ORIGIN(3)=CMZ(1)
DO J=1,NATOMS
   NINDEX(J)=J
   LCOORDS(3*(J-1)+1)=LCOORDS(3*(J-1)+1)-ORIGIN(1)
   LCOORDS(3*(J-1)+2)=LCOORDS(3*(J-1)+2)-ORIGIN(2)
   LCOORDS(3*(J-1)+3)=LCOORDS(3*(J-1)+3)-ORIGIN(3)
   CMDIST(J)=SQRT(LCOORDS(3*(J-1)+1)**2+LCOORDS(3*(J-1)+2)**2+LCOORDS(3*(J-1)+3)**2)
ENDDO
CALL PIKSR2(NATOMS,CMDIST,NINDEX) ! SORTS CMDIST AND NINDEX AGAIN
! WRITE(MYUNIT,'(A)') 'SYMMETRY> CMDIST AND NINDEX AGAIN:'
! WRITE(MYUNIT,'(F15.5,I8)') (CMDIST(J1),NINDEX(J1),J1=1,NATOMS)
CALL GETORBITS(NORBIT,ORBDIST,CMDIST,NATOMS,ORBSIZE,SYMTOL1,LARGESIZE,NINDEX,LCOORDS,LDEBUG)
IF (LDEBUG) THEN
   ISTART=1
   OPEN(UNIT=MYUNIT2,FILE='ORBITS.'//TRIM(ADJUSTL(JPSTRING)) // '.XYZ',STATUS='UNKNOWN')
   DO J1=1,NORBIT
      WRITE(MYUNIT2,'(I5)') SUM(ORBSIZE(1:J1))
      WRITE(MYUNIT2,'(A)') ' '
      DO J2=ISTART,ISTART+ORBSIZE(J1)-1
         WRITE(MYUNIT2,'(A2,2X,3G20.10)') 'LA',LCOORDS(3*(NINDEX(J2)-1)+1:3*(NINDEX(J2)-1)+3)
      ENDDO
      DO J2=1,ISTART-1
         WRITE(MYUNIT2,'(A2,2X,3G20.10)') 'LB',LCOORDS(3*(NINDEX(J2)-1)+1:3*(NINDEX(J2)-1)+3)
      ENDDO
      ISTART=ISTART+ORBSIZE(J1)
   ENDDO
   CLOSE(MYUNIT2)
ENDIF

IF (LARGESIZE.EQ.1) THEN
   IF (LDEBUG) THEN
      CALL MYCPU_TIME(TIME)
      WRITE(MYUNIT, '(A,F15.2)') 'SYMMETRY> NO NONTRIVIAL ORBITS - RETURN FROM SYMMETRY, TIME TAKEN=',TIME-T0
   ENDIF
   VAT(1:NATOMS,JP)=VATBEST(1:NATOMS)
   COORDS(1:3*NATOMS,JP)=QBEST(1:3*NATOMS) 
   RETURN
ENDIF

! EXAMINE HOW THE POINT GROUP CHANGES AS WE INCLUDE MORE ORBITS.
 
ISTART=1
NATOMSCORE=0
NORBITSCORE=0
IGENSAVE=0
LNCORE=0
SYMCORE: DO J1=1,NORBIT
   DO J2=ISTART,ISTART+ORBSIZE(J1)-1
      CORECOORDS(3*(J2-1)+1:3*(J2-1)+3)=LCOORDS(3*(NINDEX(J2)-1)+1:3*(NINDEX(J2)-1)+3)
   ENDDO
   ISTART=ISTART+ORBSIZE(J1)
   NATOMSCORE=NATOMSCORE+ORBSIZE(J1)
   NORBITSCORE=NORBITSCORE+1
   SCOORDS(1:3*NATOMSCORE)=CORECOORDS(1:3*NATOMSCORE) 
   IF (NATOMSCORE.GT.3) THEN
      DUMMY=MATDIFF
      CALL PTGRP(SCOORDS,NATOMSCORE,LDEBUG,SYMTOL1,SYMTOL2,SYMTOL3,GENMAT,IGEN,FPGRP,CM,DUMMY) ! SCOORDS IS CHANGED!
      IF (LDEBUG) WRITE(MYUNIT, '(A,I5,A,I5,A,I4,A,A4)') 'NUMBER OF ORBITS=',NORBITSCORE,' NUMBER OF ATOMS=',NATOMSCORE, &
                          ' NUMBER OF GENERATORS=',IGEN,' POINT GROUP= ',FPGRP
      IF (IGEN.GT.0) THEN ! SAVE LAST SET OF GENERATORS FOR WHICH IGEN>1.
         ORBSYM=J1
         CMSAVE(1:3)=CM(1:3)
         LNCORE=NATOMSCORE
         IGENSAVE=IGEN
         POINTGROUP=FPGRP
         GENMATSAVE(1:IGEN,1:3,1:3)=GENMAT(1:IGEN,1:3,1:3)
         EXIT SYMCORE
      ENDIF
   ELSE
      IF (LDEBUG) WRITE(MYUNIT, '(A,I5,A,I5)') 'NUMBER OF ORBITS=',NORBITSCORE,' NUMBER OF ATOMS=',NATOMSCORE
   ENDIF
   IF (NATOMSCORE.GT.20) EXIT SYMCORE ! LOOKS LIKE THERE IS SIMPLY NO SYMMETRY
ENDDO SYMCORE

IF (IGENSAVE.LE.0) THEN
   IF (LDEBUG) WRITE(MYUNIT, '(A)') 'NO SYMMETRY DETECTED'
   VAT(1:NATOMS,JP)=VATBEST(1:NATOMS)
   COORDS(1:3*NATOMS,JP)=QBEST(1:3*NATOMS) 
   RETURN
ELSE
   IF (LNCORE.EQ.NATOMS) THEN
      VAT(1:NATOMS,JP)=VATBEST(1:NATOMS)
      COORDS(1:3*NATOMS,JP)=QBEST(1:3*NATOMS) 
      RETURN
   ENDIF
   IF (NPAR.GT.1) THEN
      WRITE(MYUNIT, '(A,I1,3A,I4)') '[',JP,']SYMMETRY> SYMMETRY ANALYSIS FOR POINT GROUP ',TRIM(ADJUSTL(POINTGROUP)), &
     &          ' NUMBER OF GENERATORS=',IGENSAVE
   ELSE
      WRITE(MYUNIT, '(3A,I4)') 'SYMMETRY> SYMMETRY ANALYSIS FOR POINT GROUP ',TRIM(ADJUSTL(POINTGROUP)), &
     &          ' NUMBER OF GENERATORS=',IGENSAVE
   ENDIF
!  PRINT '(A,I5,A,I5,A)','THIS GROUP WAS DETECTED FOR THE FIRST ',ORBSYM,' ORBITS CONTAINING ',LNCORE,' ATOMS'
ENDIF

! MOVE THE CORECOORDS CENTRE OF MASS TO THE ORIGIN.

DO J1=1,NATOMS
   LCOORDS(3*(J1-1)+1)=LCOORDS(3*(J1-1)+1)-CMSAVE(1)
   LCOORDS(3*(J1-1)+2)=LCOORDS(3*(J1-1)+2)-CMSAVE(2)
   LCOORDS(3*(J1-1)+3)=LCOORDS(3*(J1-1)+3)-CMSAVE(3)
ENDDO
DO J1=1,LNCORE
   CORECOORDS(3*(J1-1)+1)=CORECOORDS(3*(J1-1)+1)-CMSAVE(1)
   CORECOORDS(3*(J1-1)+2)=CORECOORDS(3*(J1-1)+2)-CMSAVE(2)
   CORECOORDS(3*(J1-1)+3)=CORECOORDS(3*(J1-1)+3)-CMSAVE(3)
ENDDO

! GENERATE ALL THE POINT GROUP OPERATIONS.

SYMOP(1,1,1)=1.0D0; SYMOP(1,1,2)=0.0D0; SYMOP(1,1,3)=0.0D0 ! IDENTITY
SYMOP(1,2,1)=0.0D0; SYMOP(1,2,2)=1.0D0; SYMOP(1,2,3)=0.0D0
SYMOP(1,3,1)=0.0D0; SYMOP(1,3,2)=0.0D0; SYMOP(1,3,3)=1.0D0
NORDER=1
DO J1=1,NATOMS
   GENPERM(1,J1)=J1
   OPPERM(1,J1)=J1
ENDDO
! 
! REFINE THE IGENSAVE SYMMETRY OPERATIONS FOR THE LNCORE ATOMS IN
! CORECOORDS USING A NEWTON-RAPHSON STEP. THIS REALLY INCREASES
! THE ACCURACY OF THE POINT GROUP OPERATIONS. WE COULD ALSO REFINE
! THE FURTHER OPERATIONS PRODUCED FROM THE GENERATORS, BUT IT DOES
! NOT SEEM NECESSARY.
!
LHESS(1:3,1:3)=0.0D0
DO J1=1,LNCORE
   LHESS(1,1)=LHESS(1,1)+CORECOORDS(3*(J1-1)+1)**2+EPS ! EPS IS DESIGNED TO AVOID SINGULARITIES
   LHESS(1,2)=LHESS(1,2)+CORECOORDS(3*(J1-1)+1)*CORECOORDS(3*(J1-1)+2)+EPS
   LHESS(1,3)=LHESS(1,3)+CORECOORDS(3*(J1-1)+1)*CORECOORDS(3*(J1-1)+3)+EPS
   LHESS(2,2)=LHESS(2,2)+CORECOORDS(3*(J1-1)+2)**2+EPS
   LHESS(2,3)=LHESS(2,3)+CORECOORDS(3*(J1-1)+2)*CORECOORDS(3*(J1-1)+3)+EPS
   LHESS(3,3)=LHESS(3,3)+CORECOORDS(3*(J1-1)+3)**2+EPS
ENDDO
LHESS(2,1)=LHESS(1,2); LHESS(3,1)=LHESS(1,3); LHESS(3,2)=LHESS(2,3) ! SYMMETRISE HESSIAN
! INVERT LHESS
CALL DGETRF(3,3,LHESS,3,IPIVOT,INFO) ! LHESS IS MODIFIED!
CALL DGETRI(3,LHESS,3,IPIVOT,WORK,3,INFO)
IF (INFO.NE.0) THEN
   WRITE(MYUNIT,'(A,I6)') 'ERROR - INFO AFTER DGETRI IN SYMMETRY=',INFO
   WRITE(MYUNIT,'(A)') 'CORECOORDS:'
   WRITE(MYUNIT,'(3F20.10)') CORECOORDS(1:3*LNCORE)
   WRITE(MYUNIT,'(A)') 'LHESS'
   WRITE(MYUNIT,'(3F20.10)') LHESS
   STOP
ENDIF 

GENLOOP: DO J1=1,IGENSAVE
!  SYMOP(1+J1,1:3,1:3)=GENMATSAVE(J1,1:3,1:3)
   SYMOP1(1:3,1:3)=GENMATSAVE(J1,1:3,1:3)
   IF (LDEBUG) WRITE(MYUNIT, '(A,I5,9F10.4)') 'NORDER,INITIAL MAT: ',NORDER,GENMATSAVE(J1,1:3,1:3)
   CALL MATMULV(NEWQ,CORECOORDS,SYMOP1,LNCORE,3,3)
!  CALL MINPERM(LNCORE,NEWQ,CORECOORDS,BOXLX,BOXLY,BOXLZ,PERIODIC,PERM,DUMMY,DIST2,WORSTRAD)
   CALL TESTSYMOP(LNCORE,NEWQ,CORECOORDS,PERM,LTOLD,DIST2,WORSTRAD)
   IF (DIST2.GT.LTOLD) THEN
      WRITE(MYUNIT, '(A,2G20.10)') 'ERROR - GENLOOP IN SYMMETRY, DIST2,LTOLD=',DIST2,LTOLD
      CYCLE GENLOOP
   ENDIF
!  CALL BIPARTITE(LNCORE,NEWQ,CORECOORDS,PERM,DUMMY,DIST2,WORSTRAD)
!  PRINT '(A,6F15.5)','DISTS: ',DUMMY,DIST2,WORSTRAD,BDUMMY,BDIST2,BWORSTRAD
   IF (LDEBUG) THEN
      SERROR=0.0D0
      DO J2=1,LNCORE
         SERROR=SERROR+(CORECOORDS(3*(PERM(J2)-1)+1)-NEWQ(3*(J2-1)+1))**2+ &
 &                     (CORECOORDS(3*(PERM(J2)-1)+2)-NEWQ(3*(J2-1)+2))**2+ &
 &                     (CORECOORDS(3*(PERM(J2)-1)+3)-NEWQ(3*(J2-1)+3))**2
      ENDDO
      WRITE(MYUNIT, '(A,I5,G20.10)') 'OPERATION,     ERROR=',J1,SERROR
      IF (SERROR.GT.0.5D0) STOP
   ENDIF
!
!  CHECK FOR INDEPENDENT GENERATORS BY COMPARING THE INTEGERS IN GENPERM
!
   DO J2=1,NORDER
      NEWOP=.FALSE.
      NEWOPLOOP: DO J3=1,LNCORE
         IF (PERM(J3).NE.GENPERM(J2,J3)) THEN
            NEWOP=.TRUE.
            EXIT NEWOPLOOP
         ENDIF
      ENDDO NEWOPLOOP
      IF (.NOT.NEWOP) THEN
         IF (LDEBUG) WRITE(MYUNIT, '(2(A,I6))') 'GENERATOR ',J1,' APPEARS TO BE THE SAME AS ',J2
         CYCLE GENLOOP
      ENDIF
   ENDDO
!
!  GENERATOR PURIFICATION SEEMS TO BE HELPFUL.
!
   AMAT(1:3,1:3)=0.0D0
   DO J2=1,LNCORE
      AMAT(1,1)=AMAT(1,1)+CORECOORDS(3*(PERM(J2)-1)+1)*CORECOORDS(3*(J2-1)+1)
      AMAT(1,2)=AMAT(1,2)+CORECOORDS(3*(PERM(J2)-1)+1)*CORECOORDS(3*(J2-1)+2)
      AMAT(1,3)=AMAT(1,3)+CORECOORDS(3*(PERM(J2)-1)+1)*CORECOORDS(3*(J2-1)+3)
      AMAT(2,1)=AMAT(2,1)+CORECOORDS(3*(PERM(J2)-1)+2)*CORECOORDS(3*(J2-1)+1)
      AMAT(2,2)=AMAT(2,2)+CORECOORDS(3*(PERM(J2)-1)+2)*CORECOORDS(3*(J2-1)+2)
      AMAT(2,3)=AMAT(2,3)+CORECOORDS(3*(PERM(J2)-1)+2)*CORECOORDS(3*(J2-1)+3)
      AMAT(3,1)=AMAT(3,1)+CORECOORDS(3*(PERM(J2)-1)+3)*CORECOORDS(3*(J2-1)+1)
      AMAT(3,2)=AMAT(3,2)+CORECOORDS(3*(PERM(J2)-1)+3)*CORECOORDS(3*(J2-1)+2)
      AMAT(3,3)=AMAT(3,3)+CORECOORDS(3*(PERM(J2)-1)+3)*CORECOORDS(3*(J2-1)+3)
   ENDDO
   SYMOP1(1,1)=AMAT(1,1)*LHESS(1,1)+AMAT(1,2)*LHESS(2,1)+AMAT(1,3)*LHESS(3,1)
   SYMOP1(2,1)=AMAT(1,1)*LHESS(1,2)+AMAT(1,2)*LHESS(2,2)+AMAT(1,3)*LHESS(3,2)
   SYMOP1(3,1)=AMAT(1,1)*LHESS(1,3)+AMAT(1,2)*LHESS(2,3)+AMAT(1,3)*LHESS(3,3)
   SYMOP1(1,2)=AMAT(2,1)*LHESS(1,1)+AMAT(2,2)*LHESS(2,1)+AMAT(2,3)*LHESS(3,1)
   SYMOP1(2,2)=AMAT(2,1)*LHESS(1,2)+AMAT(2,2)*LHESS(2,2)+AMAT(2,3)*LHESS(3,2)
   SYMOP1(3,2)=AMAT(2,1)*LHESS(1,3)+AMAT(2,2)*LHESS(2,3)+AMAT(2,3)*LHESS(3,3)
   SYMOP1(1,3)=AMAT(3,1)*LHESS(1,1)+AMAT(3,2)*LHESS(2,1)+AMAT(3,3)*LHESS(3,1)
   SYMOP1(2,3)=AMAT(3,1)*LHESS(1,2)+AMAT(3,2)*LHESS(2,2)+AMAT(3,3)*LHESS(3,2)
   SYMOP1(3,3)=AMAT(3,1)*LHESS(1,3)+AMAT(3,2)*LHESS(2,3)+AMAT(3,3)*LHESS(3,3)
   IF (LDEBUG) THEN
!
!  JUST ASSUME IT IS THE SAME PERMUTATION.
!
       CALL MATMULV(NEWQ,CORECOORDS,SYMOP1,LNCORE,3,3)
!!     CALL MINPERM(LNCORE,NEWQ,CORECOORDS,BOXLX,BOXLY,BOXLZ,PERIODIC,PERM2,DUMMY,DIST2,WORSTRAD)
!      CALL TESTSYMOP(LNCORE,NEWQ,CORECOORDS,PERM2,LTOLD,DIST2,WORSTRAD)
!!     CALL BIPARTITE(LNCORE,NEWQ,CORECOORDS,PERM2,DUMMY,DIST2,WORSTRAD)
!      IF (DIST2.GT.1.0D2) THEN
!         SERROR2=1.0D3
!         WRITE(MYUNIT,'(A,2G20.10)') 'TESTSYMOP> ERROR - SERROR,SERROR2=',SERROR,SERROR2
!         STOP
!      ELSE
         SERROR2=0.0D0
         PERM2(1:LNCORE)=PERM(1:LNCORE)
         DO J2=1,LNCORE
!           WRITE(MYUNIT,*) 'J2,PERM2=',J2,PERM2(J2)
!           IF (PERM2(J2).LT.1) THEN
!              WRITE(MYUNIT,*) 'ERROR, PERM2 < 1'
!              STOP
!           ENDIF
            SERROR2=SERROR2+(CORECOORDS(3*(PERM2(J2)-1)+1)-NEWQ(3*(J2-1)+1))**2+ &
 &                          (CORECOORDS(3*(PERM2(J2)-1)+2)-NEWQ(3*(J2-1)+2))**2+ &
 &                          (CORECOORDS(3*(PERM2(J2)-1)+3)-NEWQ(3*(J2-1)+3))**2
         ENDDO
         WRITE(MYUNIT, '(A,I5,G20.10)') 'OPERATION, NEW ERROR=',J1,SERROR2
         IF (SERROR2.GT.SERROR) WRITE(MYUNIT, '(A)') ' WARNING - ERROR HAS INCREASED - THIS SHOULD NEVER HAPPEN'
!      ENDIF
   ENDIF
   NORDER=NORDER+1
   SYMOP(NORDER,1:3,1:3)=SYMOP1(1:3,1:3)
   GENPERM(NORDER,1:LNCORE)=PERM(1:LNCORE)
   OPPERM(NORDER,1:LNCORE)=PERM(1:LNCORE)
   IF (LDEBUG) WRITE(MYUNIT, '(A,I5,9F10.4)') 'NORDER,MAT: ',NORDER,SYMOP(NORDER,1:3,1:3)
   IF (LDEBUG) WRITE(MYUNIT, '(20I6)') PERM(1:LNCORE)
ENDDO GENLOOP
!
! END REFINEMENT OF GENERATORS.
! WE COULD "PURIFY" THE COMBINATION OPERATIONS GENERATED IN THE NEXT LOOP,
! BUT IT DOES NOT SEEM NECESSARY.
!
MAKEGROUP: DO 
   OP1: DO J1=2,NORDER
      SYMOP1(1:3,1:3)=SYMOP(J1,1:3,1:3)
      OP2: DO J2=2,NORDER
         SYMOP2(1:3,1:3)=SYMOP(J2,1:3,1:3)
         CALL MATMUL(NEWMAT,SYMOP1,SYMOP2,3,3,3,3,3,3)
         DO J3=1,NORDER
            CALL CMPMAT(SYMOP,120,J3,NEWMAT,NEW,MATDIFF)
            IF (.NOT.NEW) CYCLE OP2
         ENDDO
!!
!!  CHECK FOR INDEPENDENT GENERATORS BY COMPARING THE INTEGERS IN GENPERM
!!
!         DO J3=1,LNCORE
!            PERM(J3)=OPPERM(J2,OPPERM(J1,J3))
!         ENDDO
!         DO J3=1,NORDER
!            NEWOP=.FALSE.
!            NEWOPLOOP2: DO J4=1,LNCORE
!               IF (PERM(J4).NE.OPPERM(J3,J4)) THEN
!                  NEWOP=.TRUE.
!                  EXIT NEWOPLOOP2
!               ENDIF
!            ENDDO NEWOPLOOP2
!            IF (.NOT.NEWOP) THEN
!!              IF (LDEBUG) PRINT '(A,I6)','OPERATION APPEARS TO BE THE SAME AS ',J3
!               CYCLE OP2
!            ENDIF
!         ENDDO

         NORDER=NORDER+1
         IF (NORDER.GT.120) THEN
            WRITE(MYUNIT, '(A)') 'WARNING MORE THAN 120 OPERATIONS CASE A!'
!           STOP
            NORDER=120
            EXIT MAKEGROUP
         ELSE
            SYMOP(NORDER,1:3,1:3)=NEWMAT(1:3,1:3)
            OPPERM(NORDER,1:LNCORE)=PERM(1:LNCORE)
            CYCLE MAKEGROUP
         ENDIF
      ENDDO OP2
   ENDDO OP1
   EXIT MAKEGROUP
ENDDO MAKEGROUP

CALL MYCPU_TIME(TIME)
IF (NPAR.GT.1) THEN
   WRITE(MYUNIT, '(A,I1,A,I5,A,F15.2)') '[',JP,']SYMMETRY> USING POINT GROUP OF ORDER ', &
  &                   NORDER,' CONSTRUCTED FROM GENERATORS, TIME TAKEN=',TIME-T0
ELSE
   WRITE(MYUNIT, '(A,I5,A,F15.2)') 'SYMMETRY> USING POINT GROUP OF ORDER ', &
  &                   NORDER,' CONSTRUCTED FROM GENERATORS, TIME TAKEN=',TIME-T0
ENDIF
IF (LDEBUG) THEN
   DO J1=1,NORDER
      WRITE(MYUNIT, '(A,I5,9F10.4)') 'J1,SYMOP: ',J1,SYMOP(J1,1:3,1:3)
   ENDDO
ENDIF
! TEST TO CHECK THAT WE REALLY HAVE SYMMETRY OPERATIONS!
IF (LDEBUG) THEN
   OPEN(UNIT=MYUNIT2,FILE='TESTSYM2.' // TRIM(ADJUSTL(JPSTRING)) // '.XYZ',STATUS='UNKNOWN')
   DO J1=1,NORDER
      SYMOP1(1:3,1:3)=SYMOP(J1,1:3,1:3)
      CALL MATMULV(NEWQ,CORECOORDS,SYMOP1,LNCORE,3,3)
!     CALL MINPERM(LNCORE,NEWQ,CORECOORDS,BOXLX,BOXLY,BOXLZ,PERIODIC,PERM,DUMMY,DIST2,WORSTRAD)
      CALL TESTSYMOP(LNCORE,NEWQ,CORECOORDS,PERM,LTOLD,DIST2,WORSTRAD)
!     CALL BIPARTITE(LNCORE,NEWQ,CORECOORDS,PERM,DUMMY,DIST2,WORSTRAD)
      WRITE(MYUNIT2,'(I5)') LNCORE
!     CALL MATMULV(NEWQ,LCOORDS,SYMOP1,NATOMS,3,3)
!     CALL MINPERM(NATOMS,NEWQ,LCOORDS,BOXLX,BOXLY,BOXLZ,PERIODIC,PERM,DUMMY,DIST2,WORSTRAD)
!     CALL BIPARTITE(NATOMS,NEWQ,LCOORDS,PERM,DUMMY,DIST2,WORSTRAD)
!     WRITE(MYUNIT2,'(I5)') NATOMS
      WRITE(MYUNIT2,'(A,I5,2(A,F15.5))') 'OPERATION ',J1,' DIST=',DUMMY,' DIST2=',DIST2
      WRITE(MYUNIT2,'(A2,2X,3G20.10)') ('LA',NEWQ(3*(J2-1)+1),NEWQ(3*(J2-1)+2),NEWQ(3*(J2-1)+3),J2=1,LNCORE)
   ENDDO
   CLOSE(MYUNIT2)
ENDIF

! TEST FOR PRESERVATION OF SYMMETRY OPERATIONS WHEN MORE ORBITS ARE ADDED.
! CORECOORDS AND LCOORDS WERE BOTH ROTATED ABOVE TO THE PRINCIPAL AXIS ORIENTATION.

SYMLOST(1:NORDER)=.FALSE.
ISTART=LNCORE+1
NTOTAL=LNCORE
NSYMOP=NORDER
LASTLOST=0
FIRSTLOST=NORBIT
LOSTORBIT=.FALSE.
MINDIST=1.0D100
NMISSING(1:NORBIT)=0
SYMOTHER: DO J1=NORBITSCORE+1,NORBIT
   NLOST=0
   CHANGE=.FALSE.
   NTOTAL=NTOTAL+ORBSIZE(J1)
   IF (LDEBUG) WRITE(MYUNIT, '(4(A,I5))') 'TESTING SYMMETRY FOR ORBIT ',J1,' OF ',ORBSIZE(J1),' ATOMS, RUNNING TOTAL=',NTOTAL, &
                            ' SYMMETRY ELEMENTS REMAINING=',NSYMOP

   DO J2=ISTART,ISTART+ORBSIZE(J1)-1
      ORBCOORDS(3*(J2-ISTART)+1:3*(J2-ISTART)+3)=LCOORDS(3*(NINDEX(J2)-1)+1:3*(NINDEX(J2)-1)+3)
   ENDDO
   IF (LDEBUG)  OPEN(UNIT=MYUNIT2,FILE='TEMP.' // TRIM(ADJUSTL(JPSTRING)) // '.XYZ',STATUS='UNKNOWN')
   IF (LDEBUG)  WRITE(MYUNIT2,'(I5)') LNCORE+ORBSIZE(J1)
   IF (LDEBUG)  WRITE(MYUNIT2,*) ' '
   IF (LDEBUG)  WRITE(MYUNIT2,'(A2,2X,3G20.10)') ('LA',CORECOORDS(3*(J2-1)+1:3*(J2-1)+3),J2=1,LNCORE)
   IF (LDEBUG)  WRITE(MYUNIT2,'(A2,2X,3G20.10)') ('LB',ORBCOORDS(3*(J2-1)+1:3*(J2-1)+3),J2=1,ORBSIZE(J1))
   IF (LDEBUG)  CLOSE(MYUNIT2)
   ISTART=ISTART+ORBSIZE(J1)
   IF (LDEBUG)  OPEN(UNIT=MYUNIT3,FILE='TEMP2.' // TRIM(ADJUSTL(JPSTRING)) // '.XYZ',STATUS='UNKNOWN')
   DO J3=2,NORDER ! CYCLE OVER POINT GROUP OPERATIONS
      IF (.NOT.SYMLOST(J3)) THEN
         DO J2=1,ORBSIZE(J1)
            TRANSCOORDS(3*(J2-1)+1)=SUM(SYMOP(J3,1,1:3)*ORBCOORDS(3*(J2-1)+1:3*(J2-1)+3))
            TRANSCOORDS(3*(J2-1)+2)=SUM(SYMOP(J3,2,1:3)*ORBCOORDS(3*(J2-1)+1:3*(J2-1)+3))
            TRANSCOORDS(3*(J2-1)+3)=SUM(SYMOP(J3,3,1:3)*ORBCOORDS(3*(J2-1)+1:3*(J2-1)+3))
         ENDDO
!        CALL MINPERM(ORBSIZE(J1),ORBCOORDS,TRANSCOORDS,BOXLX,BOXLY,BOXLZ,PERIODIC,PERM,DUMMY,DIST2,WORSTRAD)
         CALL TESTSYMOP(ORBSIZE(J1),ORBCOORDS,TRANSCOORDS,PERM,LTOLD,DIST2,WORSTRAD)
!        CALL BIPARTITE(ORBSIZE(J1),ORBCOORDS,TRANSCOORDS,PERM,DUMMY,DIST2,WORSTRAD)

!        CALL SORTXYZ(ORBCOORDS,ORBSORT,NORD,SYMTOL4,ORBSIZE(J1))
!        CALL COMPARE2(TRANSCOORDS,ORBSORT,NORD,ICOMP,SYMTOL4,ORBSIZE(J1),IPRNT)
!        IF (ICOMP.NE.0) THEN

         IF (DIST2/WORSTRAD.GT.SYMTOL4) THEN
!        IF (DIST2.GT.SYMTOL4) THEN
            SYMLOST(J3)=.TRUE.
            IF (FIRSTLOST.EQ.NORBIT) FIRSTLOST=J1
            LASTORBIT=J1-1
            IF (LDEBUG.AND.(.NOT.DOMISSING)) WRITE(MYUNIT, '(A,I5,A,2F15.5)') 'SYMMETRY ELEMENT ',J3,' LOST, DUMMY,DIST2=', &
  &                              DUMMY,DIST2
            NSYMOP=NSYMOP-1
            NLOST=NLOST+1
            LOSTOP(NLOST,1:3,1:3)=SYMOP(J3,1:3,1:3)
!
!  ONLY CALL THE MORE EXPENSIVE MINPERM TO CALCULATE THE DISTANCE DUMMY IF THE OPERATION
!  IS KNOWN TO BE LOST FROM CALLING THE CHEAPER TESTSYMOP.
!
            CALL MINPERM(ORBSIZE(J1),ORBCOORDS,TRANSCOORDS,BOXLX,BOXLY,BOXLZ,PERIODIC,PERM,DUMMY,DIST2,WORSTRAD)
            IF (DUMMY.LT.MINDIST) THEN
               MINDIST=DUMMY
               CLOSEOP(1:3,1:3)=SYMOP(J3,1:3,1:3)
            ENDIF
            CHANGE=.TRUE.
            IF (LDEBUG) THEN
               WRITE(MYUNIT3,'(I5)') 2*ORBSIZE(J1)+SUM(ORBSIZE(1:J1-1))
               WRITE(MYUNIT3,'(A,I5,2F15.5)') 'OPERATION,DUMMY,DIST2=',J3,DUMMY,DIST2
               WRITE(MYUNIT3,'(A2,2X,3G20.10)') ('LA',TRANSCOORDS(3*(J2-1)+1:3*(J2-1)+3),J2=1,ORBSIZE(J1))
               WRITE(MYUNIT3,'(A2,2X,3G20.10)') ('LB',ORBCOORDS(3*(J2-1)+1:3*(J2-1)+3),J2=1,ORBSIZE(J1))
               DO J2=1,ISTART-ORBSIZE(J1)-1
                  WRITE(MYUNIT3,'(A2,2X,3G20.10)') 'LB',LCOORDS(3*(NINDEX(J2)-1)+1:3*(NINDEX(J2)-1)+3)
               ENDDO
            ENDIF
            IF (DOMISSING) THEN
               TRANSLOOP: DO J2=1,ORBSIZE(J1) ! CYCLE OVER TRANSFORMED COORDINATES
                  DO J4=1,ORBSIZE(J1) ! CYCLE OVER UNTRANSFORMED COORDINATES
                     DUMMY=SQRT((ORBCOORDS(3*(J4-1)+1)-TRANSCOORDS(3*(J2-1)+1))**2+ &
                                (ORBCOORDS(3*(J4-1)+2)-TRANSCOORDS(3*(J2-1)+2))**2+ &
                                (ORBCOORDS(3*(J4-1)+3)-TRANSCOORDS(3*(J2-1)+3))**2)
                     IF (DUMMY.LT.SYMTOL5) CYCLE TRANSLOOP
                  ENDDO
                  DO J4=1,NMISSING(J1) ! CYCLE OVER KNOWN MISSING SITES TO AVOID DUPLICATES
                     DUMMY=SQRT((QMISSING(J1,3*(J4-1)+1)-TRANSCOORDS(3*(J2-1)+1))**2+ &
                                (QMISSING(J1,3*(J4-1)+2)-TRANSCOORDS(3*(J2-1)+2))**2+ &
                                (QMISSING(J1,3*(J4-1)+3)-TRANSCOORDS(3*(J2-1)+3))**2)
                     IF (DUMMY.LT.SYMTOL5) CYCLE TRANSLOOP
                  ENDDO
                  IF (NMISSING(J1).EQ.120) THEN
                     WRITE(MYUNIT, '(A)') 'WARNING - TOO MANY MISSING SITES'
                     EXIT TRANSLOOP
                  ENDIF
                  NMISSING(J1)=NMISSING(J1)+1
                  QMISSING(J1,3*(NMISSING(J1)-1)+1:3*(NMISSING(J1)-1)+3)=TRANSCOORDS(3*(J2-1)+1:3*(J2-1)+3)
                  IF (LDEBUG) WRITE(MYUNIT, '(A,I5,A,I5,A,3F15.5)') 'ORBIT ',J1,' MISSING SITE ',NMISSING(J1), &
                              ' COORDS: ',TRANSCOORDS(3*(J2-1)+1:3*(J2-1)+3)
               ENDDO TRANSLOOP
               IF (LDEBUG) WRITE(MYUNIT, '(A,I5,A,2F15.5,A,I5)') 'SYMMETRY ELEMENT ',J3,' LOST, DISTS=',DUMMY,DIST2, &
                                                       ' MISSING SITES=',NMISSING(J1)
               IF ((.NOT.LOSTORBIT).AND.(NMISSING(J1).EQ.0)) THEN
                  SYMLOST(J3)=.FALSE.
                  CHANGE=.FALSE.
                  NSYMOP=NSYMOP+1
                  NLOST=NLOST-1
                  LASTLOST=0
                  FIRSTLOST=NORBIT
                  IF (LDEBUG) WRITE(MYUNIT, '(A,I5,A,2F15.5,A,I5)') 'SYMMETRY ELEMENT ',J3,' NOT LOST IN TERMS OF MISSING SITES'
               ELSE 
                  LOSTORBIT=.TRUE.
               ENDIF
            ELSE
               LOSTORBIT=.TRUE.
            ENDIF
         ELSE
            IF (LDEBUG) WRITE(MYUNIT, '(A,I5,A)') 'SYMMETRY ELEMENT ',J3,' RETAINED'
         ENDIF
      ENDIF
   ENDDO
   IF (LDEBUG)  CLOSE(MYUNIT3)
   IF (CHANGE) LASTLOST=NLOST
   IF (NSYMOP.EQ.1) THEN
      IF (LDEBUG) WRITE(MYUNIT, '(A,I5)') 'ONLY THE IDENTITY ELEMENT REMAINS FOR ORBIT ',J1
      EXIT SYMOTHER
   ENDIF
ENDDO SYMOTHER

IF (NSYMOP.GT.1) THEN ! THE FULL STRUCTURE STILL HAS SOME SYMMETRY
   DO J3=2,NORDER ! CYCLE OVER REMAINING POINT GROUP OPERATIONS - THE IDENTITY IS NOT COUNTED
      IF (.NOT.SYMLOST(J3)) THEN
         NSYMREM=NSYMREM+1
         SYMREM(NSYMREM,1:3,1:3)=SYMOP(J3,1:3,1:3)
      ENDIF
   ENDDO
ENDIF

NCOREREAL=0
DO J1=1,FIRSTLOST-1
   NCOREREAL=NCOREREAL+ORBSIZE(J1)
ENDDO

!
! IF CORE SYMMETRY IS CONSISTENT WITH THE WHOLE SYSTEM THEN
! NCORE IS SET TO ZERO. NSYMREM CONTAINS ALL THE SYMMETRY OPERATIONS
! (EXCEPT THE IDENTITY) AND THE KEEPSYM SUBROUTINE WILL BE CALLED 
! IN TAKESTEP.
!
IF (LASTLOST.EQ.0) THEN
   WRITE(MYUNIT, '(2(A,I5))') 'SYMMETRY> SYMMETRY OF CORE IS CONSISTENT WITH THE OVERALL SYMMETRY'
   VAT(1:NATOMS,JP)=VATBEST(1:NATOMS)
   COORDS(1:3*NATOMS,JP)=QBEST(1:3*NATOMS)
   RETURN
ELSE
   IF (LDEBUG) WRITE(MYUNIT, '(A,I8,A,I8,A)') 'SYMMETRY> FIRST ORBIT TO BREAK CORE SYMMETRY IS NUMBER ',FIRSTLOST, &
  &          ' REAL CORE CONTAINS ',NCOREREAL,' ATOMS'
   IF (NPAR.GT.1) THEN
      WRITE(MYUNIT, '(A,I1,2(A,I5))') '[',JP,']SYMMETRY> NUMBER OF SYMMETRY ELEMENTS LOST IN LAST CHANGE FOR ORBIT ', &
  &                    LASTORBIT+1,' WAS ',LASTLOST
   ELSE
      WRITE(MYUNIT, '(2(A,I5))') 'SYMMETRY> NUMBER OF SYMMETRY ELEMENTS LOST IN LAST CHANGE FOR ORBIT ', &
  &                    LASTORBIT+1,' WAS ',LASTLOST
   ENDIF
ENDIF

IF (LDEBUG) THEN
   ISTART=1
   OPEN(UNIT=MYUNIT2,FILE='ORBITS2.' // TRIM(ADJUSTL(JPSTRING)) // '.XYZ',STATUS='UNKNOWN')
   DO J1=1,NORBIT
      WRITE(MYUNIT2,'(I5)') SUM(ORBSIZE(1:J1))+NMISSING(J1)
      WRITE(MYUNIT2,'(A)') ' '
      DO J2=ISTART,ISTART+ORBSIZE(J1)-1
         WRITE(MYUNIT2,'(A2,2X,3G20.10)') 'LA',LCOORDS(3*(NINDEX(J2)-1)+1:3*(NINDEX(J2)-1)+3)
      ENDDO
      DO J2=1,ISTART-1
         WRITE(MYUNIT2,'(A2,2X,3G20.10)') 'LB',LCOORDS(3*(NINDEX(J2)-1)+1:3*(NINDEX(J2)-1)+3)
      ENDDO
      DO J2=1,NMISSING(J1)
         WRITE(MYUNIT2,'(A2,2X,3G20.10)') 'LC',QMISSING(J1,3*(J2-1)+1:3*(J2-1)+3)
      ENDDO
      ISTART=ISTART+ORBSIZE(J1)
   ENDDO
   CLOSE(MYUNIT2)
ENDIF

! MOVE COORDINATES INTO CORE AND OTHER VECTORS. DEFINE LNCORE, THE NUMBER OF CORE ATOMS.
! CORECOORDS AND LNCORE ARE EXPANDED TO INCLUDE ALL THE ATOMS IN ORBITS THAT ARE INVARIANT
! UNDER ALL THE OPERATIONS OF THE PREVIOUSLY DEFINED CORE.

ISTART=1
DO J1=1,LASTORBIT
   DO J2=ISTART,ISTART+ORBSIZE(J1)-1
      CORECOORDS(3*(J2-1)+1:3*(J2-1)+3)=LCOORDS(3*(NINDEX(J2)-1)+1:3*(NINDEX(J2)-1)+3)
      COREVT(J2)=VATORIG(NINDEX(J2)) ! MUST USE VATORIG BECAUSE VAT CHANGES IF QUENCH IS CALLED IN DOMISSING
   ENDDO
   ISTART=ISTART+ORBSIZE(J1)
ENDDO
LNCORE=ISTART-1
DO J1=LASTORBIT+1,NORBIT
   DO J2=ISTART,ISTART+ORBSIZE(J1)-1
      OTHERCOORDS(3*(J2-LNCORE-1)+1:3*(J2-LNCORE-1)+3)=LCOORDS(3*(NINDEX(J2)-1)+1:3*(NINDEX(J2)-1)+3)
      OTHERVT(J2-LNCORE)=VATORIG(NINDEX(J2)) ! MUST USE VATORIG BECAUSE VAT CHANGES IF QUENCH IS CALLED IN DOMISSING
   ENDDO
   ISTART=ISTART+ORBSIZE(J1)
ENDDO

IF (DOMISSING) THEN
   MISSOPT: DO J1=1,NORBIT
      IF (NMISSING(J1).EQ.0) CYCLE MISSOPT ! DO NOT DELETE!!
      IF (NMISSING(J1).GT.2) CYCLE MISSOPT 

      NDUMMY=0
      DO J2=1,NATOMS-LNCORE
         NDUMMY=NDUMMY+1
         COORDS(3*(NDUMMY-1)+1:3*(NDUMMY-1)+3,JP)=OTHERCOORDS(3*(J2-1)+1:3*(J2-1)+3)
         VATTMP(NDUMMY,JP)=OTHERVT(J2)
      ENDDO
      IF (NDUMMY.NE.NATOMS-LNCORE) THEN
         WRITE(MYUNIT,'(A,2I8)') 'SYMMETRY> ERROR - NDUMMY,LNCORE=',NDUMMY,LNCORE
         STOP
      ENDIF
      COORDS(3*(NATOMS-NCOREREAL)+1:3*NATOMS,JP)=CORECOORDS(1:3*NCOREREAL)
      COORDS(3*(NATOMS-LNCORE)+1:3*(NATOMS-NCOREREAL),JP)=CORECOORDS(3*NCOREREAL+1:3*LNCORE)
      VATTMP(NATOMS-NCOREREAL+1:NATOMS,JP)=-1.0D100 ! PUT CORE ATOMS AT THE END SO THEY AREN'T CHANGED
      VATTMP(NATOMS-LNCORE+1:NATOMS-NCOREREAL,JP)=COREVT(NCOREREAL+1:LNCORE)

!  OPEN(MYUNIT2,FILE='JUNK.' // TRIM(ADJUSTL(JPSTRING)) // '.XYZ',STATUS='UNKNOWN')
!  WRITE(MYUNIT2,*) NATOMS
!  WRITE(MYUNIT2,'(A,I8)') 'COORDS SHOULD BE CORE+OTHER,NCOREREAL=',NCOREREAL
!  WRITE(MYUNIT2,'(A2,3X,3F20.10)') ('LA',COORDS(3*(J2-1)+1:3*(J2-1)+3,JP),J2=NATOMS-NCOREREAL+1,NATOMS)
!  WRITE(MYUNIT2,'(A2,3X,3F20.10)') ('LB',COORDS(3*(J2-1)+1:3*(J2-1)+3,JP),J2=1,NATOMS-NCOREREAL)
!  CLOSE(MYUNIT2)

      CALL SORT3(NATOMS,NATOMS,VATTMP(1:NATOMS,JP),COORDS(1:3*NATOMS,JP)) ! SORT THE ATOMS

      NMISS=0
!     DO J2=1,J1
      DO J2=J1,J1
         MISSLOOP: DO J3=1,NMISSING(J2)
            DO J4=NMISS+1,NATOMS
               DUMMY=SQRT((COORDS(3*(J4-1)+1,JP)-QMISSING(J2,3*(J3-1)+1))**2+ &
                          (COORDS(3*(J4-1)+2,JP)-QMISSING(J2,3*(J3-1)+2))**2+ &
                          (COORDS(3*(J4-1)+3,JP)-QMISSING(J2,3*(J3-1)+3))**2)
               IF (DUMMY.LT.SYMTOL5) THEN
                  IF (LDEBUG) WRITE(MYUNIT, '(3(A,I5))') 'SYMMETRY> MISSING SITE ',J3,' FROM ORBIT ',J2,' IS TOO CLOSE TO ATOM ',J4
                  CYCLE MISSLOOP
               ENDIF
            ENDDO
            NMISS=NMISS+1
            COORDS(3*(NMISS-1)+1:3*(NMISS-1)+3,JP)=QMISSING(J2,3*(J3-1)+1:3*(J3-1)+3)
         ENDDO MISSLOOP
      ENDDO
!     IF (NMISS.GT.12) EXIT MISSOPT
      IF (NMISS.EQ.0) CYCLE MISSOPT
      IF (LDEBUG) WRITE(MYUNIT, '(A,I5,A)') 'SYMMETRY> FILLING ',NMISS,' MISSING SITES'
      
      NQTOT=NQTOT+1
      NQ(JP)=NQ(JP)+1
      CALL QUENCH(.FALSE.,JP,ITERATIONS,TIME,BRUN,QDONE,SCREENC)
      IF (NPAR.GT.1) THEN
         WRITE(MYUNIT,'(A,I1,A,I10,A,F20.10,A,I5,A,G12.5,30X,A,F11.1)') &
  &                     '[',JP,']QU ',NQ(JP),' E=',POTEL,' STEPS=',ITERATIONS,' RMS=',RMS,' T=',TIME
      ELSE
         WRITE(MYUNIT,'(A,I10,A,F20.10,A,I5,A,G12.5,30X,A,F11.1)') &
  &                     'QU ',NQ(JP),' E=',POTEL,' STEPS=',ITERATIONS,' RMS=',RMS,' T=',TIME
      ENDIF
! SAVE THE BEST STRUCTURE
      IF (HIT) THEN
         EPREV(JP)=POTEL
         RETURN
      ENDIF
      IF (LEBEST-POTEL.GT.ECONV) THEN
         LEBEST=POTEL
         QBEST(1:3*NATOMS)=COORDS(1:3*NATOMS,JP)
         VATBEST(1:NATOMS)=VAT(1:NATOMS,JP)
         QBORDERED=.TRUE.
         QBCHANGED=.TRUE.
         QBCORE=NCOREREAL
!        WRITE(MYUNIT,'(A,2L5,I6)') 'SYMMETRY> Z QBORDERED,QBCHANGED,QBCORE=',QBORDERED,QBCHANGED,QBCORE
         NSYMREM=0
         EXIT MISSOPT
      ENDIF
      IF (NQTOT-NQTOTSAVE.GE.NSYMQMAX) EXIT MISSOPT
   ENDDO MISSOPT
ENDIF

! IF (CHANGECLOSE.AND.NSYMCALL.GT.1) ! THIS VERSION FOR A LIMITED NUMBER OF CALLS TO SYMMETRY WITH
                                     ! SYSTEMATIC CHANGES IN CLOSEOP
IF (CHANGECLOSE.AND.(DPRAND().GT.0.5D0)) THEN ! CHANGE CLOSEOP TO THE CLOSEST LOST OPERATION FOR ORBIT NCHOOSE
!  NCHOOSE=NORBIT-NSYMCALL+2 
   MINDIST=1.0D100
   DUMMY=DPRAND()
   NCHOOSE=INT(DUMMY*(NORBIT-LASTORBIT+1))+LASTORBIT
   WRITE(MYUNIT, '(A,I5)') 'CHANGING CLOSEOP TO THE CLOSEST LOST OPERATION FOR ORBIT ',NCHOOSE
   NDUMMY=SUM(ORBSIZE(1:NCHOOSE-1))
   DO J2=NDUMMY+1,NDUMMY+ORBSIZE(NCHOOSE)
      ORBCOORDS(3*(J2-NDUMMY-1)+1:3*(J2-NDUMMY-1)+3)=LCOORDS(3*(NINDEX(J2)-1)+1:3*(NINDEX(J2)-1)+3)
   ENDDO
   DO J3=2,NORDER ! CYCLE OVER POINT GROUP OPERATIONS
      IF (SYMLOST(J3)) THEN
         DO J2=1,ORBSIZE(NCHOOSE)
            TRANSCOORDS(3*(J2-1)+1)=SUM(SYMOP(J3,1,1:3)*ORBCOORDS(3*(J2-1)+1:3*(J2-1)+3))
            TRANSCOORDS(3*(J2-1)+2)=SUM(SYMOP(J3,2,1:3)*ORBCOORDS(3*(J2-1)+1:3*(J2-1)+3))
            TRANSCOORDS(3*(J2-1)+3)=SUM(SYMOP(J3,3,1:3)*ORBCOORDS(3*(J2-1)+1:3*(J2-1)+3))
         ENDDO
!
!  MUST USE MINPERM HERE BECAUSE TESTSYMOP DOESN'T CALCULATE DUMMY
!
         CALL MINPERM(ORBSIZE(NCHOOSE),ORBCOORDS,TRANSCOORDS,BOXLX,BOXLY,BOXLZ,PERIODIC,PERM,DUMMY,DIST2,WORSTRAD)
!        CALL TESTSYMOP(ORBSIZE(NCHOOSE),ORBCOORDS,TRANSCOORDS,PERM,LTOLD,DIST2,WORSTRAD)
!        CALL BIPARTITE(ORBSIZE(NCHOOSE),ORBCOORDS,TRANSCOORDS,PERM,DUMMY,DIST2,WORSTRAD)
         IF (DUMMY.LT.MINDIST) THEN
            MINDIST=DUMMY
            CLOSEOP(1:3,1:3)=SYMOP(J3,1:3,1:3)
         ENDIF
      ENDIF
   ENDDO
ENDIF

! IF (CHANGECLOSE.AND.NSYMCALL.GT.1) THEN ! CHANGE CLOSEOP TO SYMOP NSYMCALL
!    CLOSEOP(1:3,1:3)=SYMOP(NSYMCALL,1:3,1:3)
! ENDIF

IF (NSYMOP.GT.1) THEN ! THE FULL STRUCTURE STILL HAS SOME SYMMETRY
   IF (DPRAND().GT.0.0D0) THEN ! ADD REMAINING SYMMETRY ELEMENTS TO THE LASTLOST SET TO COMPLETE THAT SUBGROUP
      DO J3=2,NORDER ! CYCLE OVER REMAINING POINT GROUP OPERATIONS - THE IDENTITY IS NOT NEEDED
         IF (.NOT.SYMLOST(J3)) THEN
            LASTLOST=LASTLOST+1
            LOSTOP(LASTLOST,1:3,1:3)=SYMOP(J3,1:3,1:3)
         ENDIF
      ENDDO
      WRITE(MYUNIT, '(3(A,I5))') 'SYMMETRY> AFTER ADDING THE REMAINING ',NSYMOP-1,' NON-IDENTITY ELEMENTS THERE ARE ', &
  &                              LASTLOST,' IN TOTAL'
   ELSE ! OR, WITH 0% PROBABILITY, JUST USE THE FULL SYMMETRY. IN THIS CASE WE WILL ONLY PERMUTE SINGLE WEAKLY BOUND ATOMS.
      LASTLOST=0
      DO J3=2,NORDER ! CYCLE OVER REMAINING POINT GROUP OPERATIONS - THE IDENTITY IS NOT NEEDED
         IF (.NOT.SYMLOST(J3)) THEN
            LASTLOST=LASTLOST+1
            LOSTOP(LASTLOST,1:3,1:3)=SYMOP(J3,1:3,1:3)
         ENDIF
      ENDDO
      WRITE(MYUNIT, '(3(A,I5))') 'USING THE REMAINING ',NSYMOP-1,' NON-IDENTITY ELEMENTS'
   ENDIF
!
! NEED THIS LINE IN CASE COORDS ARE NOT CHANGED SO THAT KEEPSYM WORKS IN TAKESTEP
! QBEST MAY ALREADY HAVE BEEN CHANGED IN THE DOMISSING BLOCK, IN WHICH CASE
! NSYMREM WILL HAVE BEEN SET TO ZERO. ?????????????  NO IDEA WHAT THIS WAS DOING DJW
!
!  IF (NSYMREM.GT.0) THEN
!     QBEST(1:3*NATOMS)=LCOORDS(1:3*NATOMS) 
!     VATBEST(1:NATOMS)=VATORIG(1:NATOMS) 
!     QBORDERED=.FALSE.
!     QBCHANGED=.TRUE.
!     QBCORE=NCORERERAL
!        WRITE(MYUNIT,'(A,2L5)') 'SYMMETRY> B QBORDERED,QBCHANGED=',QBORDERED,QBCHANGED
!     NSURFMOVES(JP)=0
!     SHELLMOVES(JP)=.TRUE.
!     NCORE(JP)=0
!     WRITE(MYUNIT,'(A)') 'SYMMETRY> TURNING OFF SHELL MOVES'
!  ENDIF
ENDIF


! IF (USECLOSESUBGROUP.AND.((LASTLOST.GT.50).OR.(DPRAND().GT.1.0D0))) THEN ! BAD FOR LJ38
IF (LASTLOST.GT.50) THEN 
! IF (USECLOSESUBGROUP.AND.(NSYMCALL.GT.1)) THEN ! USE FOR SYSTEMATIC CHANGES TO CLOSEOP

! INSTEAD OF USING ALL THE SYMMETRY OPERATIONS IN LASTLOST TO DEFINE ORBITS, TRY USING THE SUBGROUP
! GENERATED BY CLOSEOP. THIS SHOULD BE SMALLER.

   NSUB=2
   SUBOP(1,1:3,1:3)=SYMOP(1,1:3,1:3)
   SUBOP(2,1:3,1:3)=CLOSEOP(1:3,1:3)
   MAKESUB: DO
      SUBOP1: DO J1=2,NSUB
         SYMOP1(1:3,1:3)=SUBOP(J1,1:3,1:3)
         SUBOP2: DO J2=2,NSUB
            SYMOP2(1:3,1:3)=SUBOP(J2,1:3,1:3)            
            CALL MATMUL(NEWMAT,SYMOP1,SYMOP2,3,3,3,3,3,3)
!           IF (LDEBUG) PRINT '(A,2I5,9F10.4)','J1,J2,NEWMAT: ',J1,J2,NEWMAT
! IDENTIFY SYMMETRY ELEMENT FROM ORIGINAL GROUP AND USE THIS INSTEAD.
! THE IDEA IS TO AVOID PROPAGATION OF NUMERICAL ERRORS.
            REPLACEOP: DO J3=1,NORDER
               CALL CMPMAT(SYMOP,120,J3,NEWMAT,NEW,MATDIFF)
               IF (.NOT.NEW) THEN
                  NEWMAT(1:3,1:3)=SYMOP(J3,1:3,1:3)
                  EXIT REPLACEOP
               ENDIF
            ENDDO REPLACEOP
            DO J3=1,NSUB
               CALL CMPMAT(SUBOP,120,J3,NEWMAT,NEW,MATDIFF)
               IF (.NOT.NEW) CYCLE SUBOP2
            ENDDO
            NSUB=NSUB+1
            IF (NSUB.GT.120) THEN
               WRITE(MYUNIT, '(A)') 'WARNING MORE THAN 120 OPERATIONS CASE B!'
               NSUB=120
!              STOP
               EXIT MAKESUB
            ELSE
               SUBOP(NSUB,1:3,1:3)=NEWMAT(1:3,1:3)
               CYCLE MAKESUB
            ENDIF
         ENDDO SUBOP2
      ENDDO SUBOP1
      EXIT MAKESUB
   ENDDO MAKESUB

   WRITE(MYUNIT, '(A,I5,A)') 'SYMMETRY> USING SUBGROUP OF ORDER ',NSUB,' CONSTRUCTED FROM LOST OPERATION'
   IF (LDEBUG) THEN
      DO J1=1,NSUB
         WRITE(MYUNIT, '(A,I5,9F10.4)') 'J1,SUBOP: ',J1,SUBOP(J1,1:3,1:3)
      ENDDO
   ENDIF

   LASTLOST=NSUB
   DO J1=1,NSUB
      LOSTOP(J1,1:3,1:3)=SUBOP(J1,1:3,1:3)
   ENDDO
ENDIF

! CORE ATOMS ARE ADDED TO THE FLOAT LIST IF THEIR PAIR ENERGY IS HIGH ENOUGH.
VMIN=1.0D100
VMAX=-1.0D100
DO J1=1,NATOMS
   IF (VAT(J1,JP).LT.VMIN) VMIN=VATORIG(J1)
   IF (VAT(J1,JP).GT.VMAX) VMAX=VATORIG(J1)
ENDDO

! WE CAN EITHER USE JUST THE MOST WEAKLY BOUND ATOM, OR ALL THOSE SATISFYING THE ASTEP CONDITION.
! WE CAN ALSO REQUIRE THESE ATOMS TO BE INVARIANT UNDER CLOSEOP, OR NOT.

NFLOAT=NATOMS-LNCORE

!   DO J2=1,3*NFLOAT
!      X(J2)=OTHERCOORDS(J2)
!   ENDDO
!   DO J2=3*NFLOAT+1,3*(NFLOAT+LNCORE)
!      X(J2)=CORECOORDS(J2-3*NFLOAT)
!   ENDDO
!   CALL POTENTIAL(X,DUMMYGRAD,DUMMYE,.FALSE.,.FALSE.)
!   DO J2=1,NFLOAT
!      IF (VT(J2).NE.0.0D0) THEN
!         IF (ABS((VT(J2)-OTHERVT(J2))/VT(J2)).GT.0.01D0) THEN
!            WRITE(MYUNIT,'(A,I8,2F15.5)') 'SYMMETRY> E J2,OTHERVT,VT(J2)=',J2,OTHERVT(J2),VT(J2)
!            STOP
!         ENDIF
!      ENDIF
!   ENDDO
!   DO J2=NFLOAT+1,NFLOAT+LNCORE
!      IF (VT(J2).NE.0.0D0) THEN
!         IF (ABS((VT(J2)-COREVT(J2-NFLOAT))/VT(J2)).GT.0.01D0) THEN
!            WRITE(MYUNIT,'(A,I8,2F15.5)') 'SYMMETRY> F J2,COREVT,VT(J2)=',J2,COREVT(J2-NFLOAT),VT(J2)
!            STOP
!         ENDIF
!      ENDIF
!   ENDDO

IF (RESTRICT) THEN
   SYMOP1(1:3,1:3)=CLOSEOP(1:3,1:3)
   CALL MATMULV(NEWQ,CORECOORDS,SYMOP1,LNCORE,3,3)
ENDIF
NMOVE=0
WEAK: DO J1=1,LNCORE
!  PRINT '(A,I5,3G20.10)','J1,COREVT,VMIN,ASTEP(JP)*VMIN=',J1,COREVT(J1),VMIN,ASTEP(JP)*VMIN
   IF (WEAKESTONLY) THEN
      LDUMMY=COREVT(J1).GE.VMAX
   ELSE
      LDUMMY=COREVT(J1).GT.ASTEP(JP)*VMIN
   ENDIF
   IF (LDUMMY) THEN
      IF (DEBUG) WRITE(MYUNIT,'(A,I8,2G20.10)') 'SYMMETRY> J1,COREVT,VMAX=',J1,COREVT(J1),VMAX
      IF (RESTRICT) THEN
         DIST2=SQRT((CORECOORDS(3*(J1-1)+1)-NEWQ(3*(J1-1)+1))**2+ &
                    (CORECOORDS(3*(J1-1)+2)-NEWQ(3*(J1-1)+2))**2+ &
                    (CORECOORDS(3*(J1-1)+3)-NEWQ(3*(J1-1)+3))**2)
      ELSE
         DIST2=0.0D0
      ENDIF
      IF (DIST2.LE.SYMTOL4) THEN ! ATOM LIES ON THE SYMMETRY ELEMENT 
         NFLOAT=NFLOAT+1
         OTHERCOORDS(3*(NFLOAT-1)+1:3*(NFLOAT-1)+3)=CORECOORDS(3*(J1-1)+1:3*(J1-1)+3)
         OTHERVT(NFLOAT)=COREVT(J1)
         NMOVE=NMOVE+1
         MOVEINDEX(NMOVE)=J1
         IF (J1.LE.NCOREREAL) NCOREREAL=NCOREREAL-1
         IF (LDEBUG) WRITE(MYUNIT, '(A,I5,A,2I5,A,F15.5)') 'WEAKLY BOUND INVARIANT ATOM ',J1, &
                          ' ADDED TO FLOATER LIST, LNCORE,NFLOAT=',LNCORE-NMOVE,NFLOAT, &
                          ' PAIR ENERGY=',COREVT(J1)
         WRITE(MYUNIT,'(A,I5,3F15.5)') 'MOVED ATOM COORDS: ',J1,CORECOORDS(3*(J1-1)+1:3*(J1-1)+3)
         WRITE(MYUNIT,'(A,I5,3F15.5)') 'OTHER ATOM COORDS: ',NFLOAT,OTHERCOORDS(3*(NFLOAT-1)+1:3*(NFLOAT-1)+3)
         IF (WEAKESTONLY) EXIT WEAK ! WE KNOW THERE IS ONLY ONE ATOM TO DO
      ENDIF
   ENDIF
ENDDO WEAK

DO J1=NMOVE,1,-1
   DO J2=MOVEINDEX(J1),LNCORE-1
      CORECOORDS(3*(J2-1)+1:3*(J2-1)+3)=CORECOORDS(3*J2+1:3*J2+3)
      COREVT(J2)=COREVT(J2+1)
   ENDDO
   LNCORE=LNCORE-1
ENDDO

!   DO J2=1,3*NFLOAT
!      X(J2)=OTHERCOORDS(J2)
!   ENDDO
!   DO J2=3*NFLOAT+1,3*(NFLOAT+LNCORE)
!      X(J2)=CORECOORDS(J2-3*NFLOAT)
!   ENDDO
!   CALL POTENTIAL(X,DUMMYGRAD,DUMMYE,.FALSE.,.FALSE.)
!   DO J2=1,NFLOAT
!      IF (VT(J2).NE.0.0D0) THEN
!         IF (ABS((VT(J2)-OTHERVT(J2))/VT(J2)).GT.0.01D0) THEN
!            WRITE(MYUNIT,'(A,I8,2F15.5)') 'SYMMETRY> C J2,OTHERVT,VT(J2)=',J2,OTHERVT(J2),VT(J2)
!            STOP
!         ENDIF
!      ENDIF
!   ENDDO
!   DO J2=NFLOAT+1,NFLOAT+LNCORE
!      IF (VT(J2).NE.0.0D0) THEN
!         IF (ABS((VT(J2)-COREVT(J2-NFLOAT))/VT(J2)).GT.0.01D0) THEN
!            WRITE(MYUNIT,'(A,I8,2F15.5)') 'SYMMETRY> D J2,COREVT,VT(J2)=',J2,COREVT(J2-NFLOAT),VT(J2)
!            STOP
!         ENDIF
!      ENDIF
!   ENDDO
!   WRITE(MYUNIT,'(A,I8)') 'SYMMETRY> CORE COORDINATES AFTER MOVING ATOM TO FLOATER LIST, LNCORE=',LNCORE
!   CALL FLUSH(MYUNIT,ISTAT)
!   WRITE(MYUNIT,'(3F20.10)') CORECOORDS(1:3*LNCORE)


! APPLY ALL THE NON-IDENTITY OPERATORS IN LASTLOST TO EACH NON-CORE ATOM TO GENERATE
! THE CORRESPONDING ORBIT. REMOVE DUPLICATES AS WE GO ALONG.
! IF AN ATOM LIES IN A PREVIOUS ORBIT, SKIP IT.
! NEW ORBITS SHOULD BE GUARANTEED BECAUSE WE CHECK THAT ATOM
! J1 DOES NOT LIE IN ANY PREVIOUS NEWORB;S AND WE KNOW IT DOES NOT LIE IN
! ANY OF THE SYMORB SITES.

NEWORB=0
NCORENEW=0
MOVEDTOCORE(1:NATOMS-LNCORE)=.FALSE.
OTHERLOOP: DO J1=1,NATOMS-LNCORE
   IF (MOVEDTOCORE(J1)) CYCLE OTHERLOOP
! COMPARE WITH MEMBERS OF PREVIOUS ORBITS
   DO J2=1,NEWORB
      DO J3=1,NEWORBSIZE(J2)
         DUMMY=SQRT((NEWORBCOORDS(J2,3*(J3-1)+1)-OTHERCOORDS(3*(J1-1)+1))**2+ &
                    (NEWORBCOORDS(J2,3*(J3-1)+2)-OTHERCOORDS(3*(J1-1)+2))**2+ &
                    (NEWORBCOORDS(J2,3*(J3-1)+3)-OTHERCOORDS(3*(J1-1)+3))**2)
         IF (DUMMY.LT.SYMTOL5) CYCLE OTHERLOOP
      ENDDO
   ENDDO
   NDUMMY=1
   TMPCOORDS(1:3)=OTHERCOORDS(3*(J1-1)+1:3*(J1-1)+3)
   NEWORBCOORDS(NEWORB+1,1:3)=TMPCOORDS(1:3)
   APPLYOPS: DO J2=1,LASTLOST
      TMPCOORDS(1)=SUM(LOSTOP(J2,1,1:3)*OTHERCOORDS(3*(J1-1)+1:3*(J1-1)+3))
      TMPCOORDS(2)=SUM(LOSTOP(J2,2,1:3)*OTHERCOORDS(3*(J1-1)+1:3*(J1-1)+3))
      TMPCOORDS(3)=SUM(LOSTOP(J2,3,1:3)*OTHERCOORDS(3*(J1-1)+1:3*(J1-1)+3))
      DO J3=1,NDUMMY ! CHECK OVERLAPS WITH CURRENT ORBIT
         DUMMY=SQRT((TMPCOORDS(1)-NEWORBCOORDS(NEWORB+1,3*(J3-1)+1))**2+ &
                    (TMPCOORDS(2)-NEWORBCOORDS(NEWORB+1,3*(J3-1)+2))**2+ &
                    (TMPCOORDS(3)-NEWORBCOORDS(NEWORB+1,3*(J3-1)+3))**2)
         IF (DUMMY.LT.SYMTOL5) CYCLE APPLYOPS
      ENDDO 
      DO J3=1,LNCORE+NCORENEW ! CHECK OVERLAPS WITH CORE ATOMS
         DUMMY=SQRT((TMPCOORDS(1)-CORECOORDS(3*(J3-1)+1))**2+ &
                    (TMPCOORDS(2)-CORECOORDS(3*(J3-1)+2))**2+ &
                    (TMPCOORDS(3)-CORECOORDS(3*(J3-1)+3))**2)
         IF (DUMMY.LT.SYMTOL5) CYCLE APPLYOPS
      ENDDO
      DO J4=1,NEWORB ! CHECK OVERLAPS WITH PREVIOUS ORBITS
         DO J3=1,NEWORBSIZE(J4)
            DUMMY=SQRT((NEWORBCOORDS(J4,3*(J3-1)+1)-TMPCOORDS(1))**2+ &
                       (NEWORBCOORDS(J4,3*(J3-1)+2)-TMPCOORDS(2))**2+ &
                       (NEWORBCOORDS(J4,3*(J3-1)+3)-TMPCOORDS(3))**2)
!           IF (DUMMY.LT.SYMTOL5) CYCLE APPLYOPS ! WORKS BEST TO GIVE UP ON THIS ORBIT COMPLETELY
            IF (DUMMY.LT.SYMTOL5) CYCLE OTHERLOOP
         ENDDO
      ENDDO
      NDUMMY=NDUMMY+1
      NEWORBCOORDS(NEWORB+1,3*(NDUMMY-1)+1:3*(NDUMMY-1)+3)=TMPCOORDS(1:3)
!     PRINT '(A,I5,A,I5,A,3G20.10)','NEW ORBIT ',NEWORB+1,' NEW SITE ',NDUMMY,' COORDS: ',TMPCOORDS(1:3)
   ENDDO APPLYOPS
! TEST WHETHER THIS ORBIT IS CONTAINED COMPLETELY WITHIN OTHERCOORDS. IF IT IS,
! MOVE THESE COORDINATES TO THE CORE, BUT PUT THE ATOMS BEFORE THE REAL CORE DEFINED
! BY THE ORBIT WHERE THE SYMMETRY FIRST DROPS.
   NCORETMP=0
   IF (MOVETOCORE) THEN
      MATCHED=.TRUE.
      NEWORBCOORD: DO J2=1,NDUMMY
         DO J3=1,NATOMS-LNCORE
            IF (.NOT.MOVEDTOCORE(J3)) THEN
               DUMMY=SQRT((OTHERCOORDS(3*(J3-1)+1)-NEWORBCOORDS(NEWORB+1,3*(J2-1)+1))**2+ &
                          (OTHERCOORDS(3*(J3-1)+2)-NEWORBCOORDS(NEWORB+1,3*(J2-1)+2))**2+ &
                          (OTHERCOORDS(3*(J3-1)+3)-NEWORBCOORDS(NEWORB+1,3*(J2-1)+3))**2)
               IF (DUMMY.LT.SYMTOL4) THEN

!  IT CAN HAPPEN THAT TWO IMAGES IN NEWORBCOORDS MATCH THE SAME CORE ATOM. DON;T MOVE
!  THIS ATOM TO THE CORE MORE THAN ONCE! 

                  DO J4=1,NCORETMP
                     IF (NEWCOREINDEX(J4).EQ.J3) THEN
!                       PRINT '(A,I5,A,I5,A,G20.10)','NEW ORBIT ATOM ',J2,' ALSO MATCHES FLOATER ',J3, &
!                                                    ' DUMMY=',DUMMY
                        CYCLE NEWORBCOORD
                     ENDIF
                  ENDDO

                  NCORETMP=NCORETMP+1
                  CORECOORDS(3*(LNCORE+NCORENEW+NCORETMP-1)+1:3*(LNCORE+NCORENEW+NCORETMP-1)+3)= &
                                OTHERCOORDS(3*(J3-1)+1:3*(J3-1)+3)
                  COREVT(LNCORE+NCORENEW+NCORETMP)=OTHERVT(J3)
                  NEWCOREINDEX(NCORETMP)=J3
!                 PRINT '(A,I5,A,I5,A,G20.10)','NEW ORBIT ATOM ',J2,' MATCHES FLOATER ',J3,' DUMMY=',DUMMY
                  CYCLE NEWORBCOORD
               ENDIF
            ENDIF
         ENDDO
         MATCHED=.FALSE.
         EXIT NEWORBCOORD
      ENDDO NEWORBCOORD
   ENDIF
   IF (MATCHED.AND.(NCORETMP.GT.1)) THEN ! LEAVE SINGLE ATOMS AS FLOATERS, OTHERWISE MOVE TO CORE
      NCORENEW=NCORENEW+NCORETMP
      IF (LDEBUG) WRITE(MYUNIT, '(A,I5,A,120I5)') 'MOVING ',NCORETMP,' ATOMS TO THE CORE: ',NEWCOREINDEX(1:NCORETMP)
      IF (LDEBUG) WRITE(MYUNIT, '(A,I5)') 'NUMBER OF CORE ATOMS=',LNCORE+NCORENEW
      DO J2=1,NCORETMP
         MOVEDTOCORE(NEWCOREINDEX(J2))=.TRUE.
      ENDDO
      CYCLE OTHERLOOP
   ENDIF

! OTHERWISE, STORE THE NEW ORBIT.

   NEWORB=NEWORB+1
   NEWORBSIZE(NEWORB)=NDUMMY
   IF (LDEBUG) WRITE(MYUNIT, '(3(A,I6))') 'NEW ORBIT ',NEWORB,' OF DIMENSION ',NEWORBSIZE(NEWORB), &
                ' GENERATED FROM FLOATER ',J1
ENDDO OTHERLOOP
!
! NOW WE WANT TO REORDER THE COORDINATES IN CORE SO THAT THE ORIGINAL FIRST NCOREREAL ATOMS COME LAST
! AND THEN THE COMPLETE ORBITS DEFINED FOR LOWER SYMMETRY
! COME FIRST. MOVES ARE NOT TAKEN FOR THE LAST NCOREREAL ATOMS IN TAKESTEP.
!
IF (LDEBUG) WRITE(MYUNIT,'(A,3I8)') 'SYMMETRY> REORDERING CORE ATOMS, LNCORE,NCORENEW,NCOREREAL=',LNCORE,NCORENEW,NCOREREAL
IF (LNCORE.LT.NCOREREAL) THEN
   WRITE(MYUNIT,'(A)') 'SYMMETRY> ERROR - LNCORE MUST BE >= NCOREREAL'
   STOP
ENDIF
!OPEN(UNIT=77,FILE='STUFF.XYZ',STATUS='UNKNOWN')
! WRITE(77,'(I8)') LNCORE+NCORENEW
! WRITE(77,'(A)') 'CORECOORDS BEFORE REORDERING'
! WRITE(77,'(A3,3F20.10)') ('LA ',CORECOORDS(3*(J1-1)+1:3*(J1-1)+3),J1=1,NCOREREAL)
! WRITE(77,'(A3,3F20.10)') ('LB ',CORECOORDS(3*(J1-1)+1:3*(J1-1)+3),J1=NCOREREAL+1,LNCORE)
! WRITE(77,'(A3,3F20.10)') ('LC ',CORECOORDS(3*(J1-1)+1:3*(J1-1)+3),J1=LNCORE+1,LNCORE+NCORENEW)
LNCORE=LNCORE+NCORENEW
SCOORDS(3*(LNCORE-NCOREREAL)+1:3*LNCORE)=CORECOORDS(1:3*NCOREREAL)
TEMPVT(LNCORE-NCOREREAL+1:LNCORE)=COREVT(1:NCOREREAL)
SCOORDS(1:3*(LNCORE-NCOREREAL))=CORECOORDS(3*NCOREREAL+1:3*LNCORE)
TEMPVT(1:LNCORE-NCOREREAL)=COREVT(NCOREREAL+1:LNCORE)
CORECOORDS(1:3*LNCORE)=SCOORDS(1:3*LNCORE)
COREVT(1:LNCORE)=TEMPVT(1:LNCORE)
! WRITE(77,'(I8)') LNCORE
! WRITE(77,'(A)') 'CORECOORDS AFTER REORDERING'
! WRITE(77,'(A3,3F20.10)') ('LA ',CORECOORDS(3*(J1-1)+1:3*(J1-1)+3),J1=1,LNCORE-NCOREREAL)
! WRITE(77,'(A3,3F20.10)') ('LB ',CORECOORDS(3*(J1-1)+1:3*(J1-1)+3),J1=LNCORE-NCOREREAL+1,LNCORE)
! CLOSE(77)

! IF QBEST WAS ALREADY CHANGED ABOVE THEN WE SHOULD NOT OVERWRITE IT HERE.
! IF QBEST IS CHANGED SUBSEQUENTLY IT WILL BE RECONSTRUCTED FROM CORECOORDS AND OTHERCOORDS,
! WHICH ARE ORDERED CORRECTLY.

!        WRITE(MYUNIT,'(A,2L5,I6)') 'SYMMETRY> C QBORDERED,QBCHANGED,QBCORE=',QBORDERED,QBCHANGED,QBCORE
IF (.NOT.QBCHANGED) THEN
   NDUMMY=0
   DO J1=1,NATOMS-(LNCORE-NCORENEW)
      IF (.NOT.MOVEDTOCORE(J1)) THEN
         NDUMMY=NDUMMY+1
         QBEST(3*(NDUMMY-1)+1:3*(NDUMMY-1)+3)=OTHERCOORDS(3*(J1-1)+1:3*(J1-1)+3)
         VATBEST(NDUMMY)=OTHERVT(J1)
!        IF (NDUMMY.EQ.NATOMS-LNCORE) EXIT
      ENDIF
   ENDDO
   IF (NDUMMY.NE.NATOMS-LNCORE) THEN
      WRITE(MYUNIT,'(A,2I8)') 'SYMMETRY> ERROR - NDUMMY,LNCORE=',NDUMMY,LNCORE
      STOP
   ENDIF
   QBEST(3*(NATOMS-LNCORE)+1:3*NATOMS)=CORECOORDS(1:3*LNCORE)
   VATBEST(NATOMS-LNCORE+1:NATOMS)=COREVT(1:LNCORE)
   QBORDERED=.TRUE.
   QBCHANGED=.FALSE.
   QBCORE=NCOREREAL

!   DO J2=1,3*NATOMS
!      X(J2)=QBEST(J2)
!   ENDDO
!   CALL POTENTIAL(X,DUMMYGRAD,DUMMYE,.FALSE.,.FALSE.)
!   FAILED=.FALSE.
!   DO J2=1,NATOMS
!      IF (VT(J2).NE.0.0D0) THEN
!         IF (ABS((VT(J2)-VATBEST(J2))/VT(J2)).GT.0.01D0) THEN
!            WRITE(MYUNIT,'(A,I8,2F15.5)') 'SYMMETRY> A2 J2,VATBEST,VT(J2)=',J2,VATBEST(J2),VT(J2)
!            FAILED=.TRUE.
!         ENDIF
!      ENDIF
!   ENDDO
!   IF (FAILED) THEN
!      WRITE(MYUNIT,'(A,I8)') 'SYMMETRY> CORE COORDINATES AFTER REORDERING, LNCORE=',LNCORE
!      CALL FLUSH(MYUNIT,ISTAT)
!      WRITE(MYUNIT,'(3F20.10)') CORECOORDS(1:3*LNCORE)
!      STOP
!   ENDIF
ENDIF

IF (LDEBUG) THEN
   OPEN(MYUNIT2,FILE='COREPLUSOTHER.' // TRIM(ADJUSTL(JPSTRING)) // '.XYZ',STATUS='UNKNOWN')
   WRITE(MYUNIT2,*) NATOMS
   WRITE(MYUNIT2,*) ' '
   WRITE(MYUNIT2,'(A2,3X,3F20.10)') ('LA',CORECOORDS(3*(J2-1)+1:3*(J2-1)+3),J2=1,LNCORE)
   NDUMMY=0
   DO J1=1,NATOMS
      IF (.NOT.MOVEDTOCORE(J1)) THEN
         WRITE(MYUNIT2,'(A2,3X,3F20.10)') 'LB',OTHERCOORDS(3*(J1-1)+1:3*(J1-1)+3)
         NDUMMY=NDUMMY+1
         IF (NDUMMY.EQ.NATOMS-LNCORE) EXIT
      ENDIF
   ENDDO
   CLOSE(MYUNIT2)

   OPEN(UNIT=MYUNIT2,FILE='NEWORBITS.' // TRIM(ADJUSTL(JPSTRING)) // '.XYZ',STATUS='UNKNOWN')
   DO J1=1,NEWORB
      WRITE(MYUNIT2,'(I6)') SUM(NEWORBSIZE(1:J1))+LNCORE
!     WRITE(MYUNIT2,'(I6)') NEWORBSIZE(J1)
      WRITE(MYUNIT2,'(A)') ' '
      WRITE(MYUNIT2,'(A2,3X,3F20.10)') ('LA',CORECOORDS(3*(J2-1)+1:3*(J2-1)+3),J2=1,LNCORE)
      DO J3=1,J1-1
         WRITE(MYUNIT2,'(A2,3X,3F20.10)') ('LC',NEWORBCOORDS(J3,3*(J2-1)+1:3*(J2-1)+3),J2=1,NEWORBSIZE(J3))
      ENDDO
!     WRITE(MYUNIT2,'(A2,3X,3F20.10)') (('LB',NEWORBCOORDS(J1,3*(J2-1)+1:3*(J2-1)+3),J2=1,NEWORBSIZE(J1)),J1=1,1)
      WRITE(MYUNIT2,'(A2,3X,3F20.10)') ('LB',NEWORBCOORDS(J1,3*(J2-1)+1:3*(J2-1)+3),J2=1,NEWORBSIZE(J1))
   ENDDO
   CLOSE(MYUNIT2)

   OPEN(UNIT=MYUNIT2,FILE='NEWPLUSCORE.' // TRIM(ADJUSTL(JPSTRING)) // '.XYZ',STATUS='UNKNOWN')
   WRITE(MYUNIT2,'(I6)') SUM(NEWORBSIZE(1:NEWORB))+LNCORE
   WRITE(MYUNIT2,'(A)') ' '
   WRITE(MYUNIT2,'(A2,3X,3F20.10)') ('LA',CORECOORDS(3*(J2-1)+1:3*(J2-1)+3),J2=1,LNCORE)
   WRITE(MYUNIT2,'(A2,3X,3F20.10)') (('LB',NEWORBCOORDS(J1,3*(J2-1)+1:3*(J2-1)+3),J2=1,NEWORBSIZE(J1)),J1=1,NEWORB)
   CLOSE(MYUNIT2)
ENDIF
IF (LNCORE.EQ.NATOMS) THEN
   VAT(1:NATOMS,JP)=VATBEST(1:NATOMS)
   COORDS(1:3*NATOMS,JP)=QBEST(1:3*NATOMS)
   IF (QBORDERED) NCORE(JP)=QBCORE
   RETURN
ENDIF

! WE WANT TO TRY TO MAKE COMPLETE ORBITS AND FILL THEM UP. TRY ALL POSSIBILITIES 
! FOR PRECISELY FILLED ORBITS AS STARTING POINTS FOR QUENCHES. EACH ORBIT IS EITHER
! OCCUPIED COMPLETELY OR NOT, AND WE NEED TO ENUMERATE THE POSSIBILITIES.
!
! NOW FILL IN THE NEWORB ORBITS WITH THE NATOMS-LNCORE=NFLOAT CANDIDATES. 
! ONLY QUENCH CANDIDATE GEOMETRIES WHERE ORBITS ARE COMPLETELY FILLED.
! EACH ORBIT CAN EITHER BE FILLED OR EMPTY, GIVING 2^NEWORB POSSIBILITIES,
! BUT MOST WILL PROBABLY BE DISALLOWED BECAUSE THE OCCUPATION WON;T MATCH NFLOAT.

NFLOAT=NATOMS-LNCORE
ALLOCATE(OCCS(NSYMQMAX,NEWORB))
IF (NSYMQMAX.GT.0) CALL ENUMERATE(NFLOAT,NEWORB,NEWORBSIZE,NSYMQMAX,OCCS,NPOSS,LDEBUG)

IF (NPOSS.EQ.0) WRITE(MYUNIT,'(A,I8)') 'SYMMETRY> NO POSSIBILITIES WITH COMPLETE ORBITS FILLED, NUMBER IN CORE=',LNCORE

IF (.TRUE.) THEN

   PERMS2: DO NTRIES=1,MIN(NSYMQMAX,NPOSS) ! NPOSS IS THE NUMBER OF PERMUTATIONS SAVED
      NCHOICE(1:NEWORB)=OCCS(NTRIES,1:NEWORB)
      NDUMMY=0
      DO J1=1,NEWORB
         NDUMMY=NDUMMY+NCHOICE(J1)*NEWORBSIZE(J1)
      ENDDO
      IF (NDUMMY.NE.NFLOAT) THEN
         WRITE(MYUNIT, '(A,2I5,A)') 'ERROR - NDUMMY,NFLOAT=',NDUMMY,NFLOAT,' IN SYMMETRY'
         STOP
      ENDIF
      IF (LDEBUG) WRITE(MYUNIT, '(A)') 'NCHOICE:'
      IF (LDEBUG) WRITE(MYUNIT, '(60I2)') NCHOICE(1:NEWORB)
      IF (LDEBUG) WRITE(MYUNIT, '(A,2I5)') 'NDUMMY,NFLOAT=',NDUMMY,NFLOAT
!     COORDS(1:3*LNCORE,JP)=CORECOORDS(1:3*LNCORE)
      COORDS(3*(NATOMS-LNCORE)+1:3*NATOMS,JP)=CORECOORDS(1:3*LNCORE)
!     NDUMMY=LNCORE
      NDUMMY=0
      DO J1=1,NEWORB
         IF (NCHOICE(J1).EQ.1) THEN
            COORDS(3*NDUMMY+1:3*(NDUMMY+NEWORBSIZE(J1)),JP)=NEWORBCOORDS(J1,1:3*NEWORBSIZE(J1))
            NDUMMY=NDUMMY+NEWORBSIZE(J1)
         ENDIF
      ENDDO
      NQTOT=NQTOT+1
      NQ(JP)=NQ(JP)+1
      CALL QUENCH(.FALSE.,JP,ITERATIONS,TIME,BRUN,QDONE,SCREENC)
      IF (NPAR.GT.1) THEN
         WRITE(MYUNIT,'(A,I1,A,I10,A,F20.10,A,I5,A,G12.5,30X,A,F11.1)') &
   &                '[',JP,']QU ',NQ(JP),' E=',POTEL,' STEPS=',ITERATIONS,' RMS=',RMS,' T=',TIME
      ELSE
         WRITE(MYUNIT,'(A,I10,A,F20.10,A,I5,A,G12.5,30X,A,F11.1)') &
   &                'QU ',NQ(JP),' E=',POTEL,' STEPS=',ITERATIONS,' RMS=',RMS,' T=',TIME
      ENDIF
   ! SAVE THE BEST STRUCTURE
      IF (LEBEST-POTEL.GT.ECONV) THEN
         LEBEST=POTEL
         QBEST(1:3*NATOMS)=COORDS(1:3*NATOMS,JP)
         VATBEST(1:NATOMS)=VAT(1:NATOMS,JP)
         QBCHANGED=.TRUE.
         QBORDERED=.TRUE.
         QBCORE=NCOREREAL
!        WRITE(MYUNIT,'(A,2L5,I6)') 'SYMMETRY> D QBORDERED,QBCHANGED,QBCORE=',QBORDERED,QBCHANGED,QBCORE

!   DO J2=1,3*NATOMS
!      X(J2)=QBEST(J2)
!   ENDDO
!   CALL POTENTIAL(X,DUMMYGRAD,DUMMYE,.FALSE.,.FALSE.)
!   DO J2=1,NATOMS
!      IF (VT(J2).NE.0.0D0) THEN
!         IF (ABS((VT(J2)-VATBEST(J2))/VT(J2)).GT.0.01D0) THEN
!            WRITE(MYUNIT,'(A,I8,2F15.5)') 'SYMMETRY> E J2,VATBEST,VT(J2)=',J2,VATBEST(J2),VT(J2)
!            STOP
!         ENDIF
!      ENDIF
!   ENDDO

         NSYMREM=0
!        NSURFMOVES(JP)=0
!        SHELLMOVES(JP)=.TRUE.
!        NCORE(JP)=0
!        WRITE(MYUNIT,'(A)') 'SYMMETRY> TURNING OFF SHELL MOVES'
!        EXIT PERMS2 ! SEEMS TO BE OK - PERHAPS NOT FOR LJ185?
      ENDIF
      IF (NQTOT-NQTOTSAVE.GE.NSYMQMAX) EXIT PERMS2
      IF (HIT) EXIT PERMS2
   ENDDO PERMS2
! WRITE(DUMPXYZUNIT+JP,'(I4)') NATOMS
! WRITE(DUMPXYZUNIT+JP,*) 'QBEST 1:'
! IF (NCORE(JP).GT.0) WRITE(DUMPXYZUNIT+JP,'(A2,3F20.10)')  &
  ! &     ('LA ',QBEST(3*(I-1)+1),QBEST(3*(I-1)+2),QBEST(3*(I-1)+3),I=NATOMS,NATOMS-NCORE(JP)+1,-1)
! WRITE(DUMPXYZUNIT+JP,'(A2,3F20.10)') ('LB',QBEST(3*(I-1)+1),QBEST(3*(I-1)+2),QBEST(3*(I-1)+3),I=1,NATOMS-NCORE(JP))

ELSE ! OLD ENUMERATION

   NCHOICE(1:NEWORB)=0
   NTOPSUM=0
   IF (NEWORB.LE.10) THEN ! WITH 10 NEW ORBITS OR FEWER, TRY ALL POSSIBILITIES.
      NTOP=0
   ELSE                   ! OTHERWISE, TRY FILLING UP THE FIRST NEW ORBITS AT THE START
      NEWORBINIT: DO J1=1,NEWORB
         NMINREM=MINVAL(NEWORBSIZE(J1+1:NEWORB))
         IF (NTOPSUM+NMINREM+NEWORBSIZE(J1).LE.NFLOAT) THEN
   !     IF (NTOPSUM+NEWORBSIZE(J1).LT.NFLOAT) THEN
            NCHOICE(J1)=1
            NTOPSUM=NTOPSUM+NEWORBSIZE(J1)
         ELSE
            NTOP=J1-1
            EXIT NEWORBINIT
         ENDIF
      ENDDO NEWORBINIT
   ENDIF
   NTRIES=0
   PERMS: DO
      NTRIES=NTRIES+1
      IF (NTRIES.GE.NSYMQMAX*100) EXIT PERMS ! ANOTHER ESCAPE ROUTE IF THERE ARE TOO MANY CHOICES
      NCHOICE(NEWORB)=NCHOICE(NEWORB)+1
      NDUMMY=0
      DO J1=NEWORB,2,-1
         IF (NCHOICE(J1).EQ.2) THEN
            NCHOICE(J1)=0
            NCHOICE(J1-1)=NCHOICE(J1-1)+1
         ENDIF
         IF (NCHOICE(J1).EQ.1) NDUMMY=NDUMMY+NEWORBSIZE(J1)
      ENDDO
   !  PRINT*,'NTOP,NCHOICE(NTOP+1)=',NTOP,NCHOICE(NTOP+1)
      IF (NCHOICE(NTOP+1).EQ.1) THEN
         NTOP=NTOP+1
         NTOPSUM=NTOPSUM+NEWORBSIZE(NTOP)
   !     PRINT*,'NTOP,NTOPSUM,NFLOAT=',NTOP,NTOPSUM,NFLOAT
         IF (NTOPSUM.GT.NFLOAT) EXIT PERMS ! ALL SUBSEQUENT ATTEMPTS WOULD HAVE TOO MANY ATOMS.
      ENDIF
      IF (NCHOICE(1).EQ.1) NDUMMY=NDUMMY+NEWORBSIZE(1)
      IF (NCHOICE(1).GT.1) EXIT PERMS
      IF (LDEBUG) WRITE(MYUNIT, '(A)') 'NCHOICE:'
      IF (LDEBUG) WRITE(MYUNIT, '(60I2)') NCHOICE(1:NEWORB)
      IF (LDEBUG) WRITE(MYUNIT, '(A,2I5)') 'NDUMMY,NFLOAT=',NDUMMY,NFLOAT
      IF (NDUMMY.NE.NFLOAT) CYCLE PERMS
      IF (NCHOICE(1).GT.1) EXIT PERMS
      COORDS(1:3*LNCORE,JP)=CORECOORDS(1:3*LNCORE)
      NDUMMY=LNCORE
      DO J1=1,NEWORB
         IF (NCHOICE(J1).EQ.1) THEN
            COORDS(3*NDUMMY+1:3*(NDUMMY+NEWORBSIZE(J1)),JP)=NEWORBCOORDS(J1,1:3*NEWORBSIZE(J1))
            NDUMMY=NDUMMY+NEWORBSIZE(J1)
         ENDIF
      ENDDO
      IF (NDUMMY.NE.NATOMS) THEN
         WRITE(MYUNIT, '(A,2I5)') 'ERROR - NDUMMY,NATOMS=',NDUMMY,NATOMS
         STOP
      ENDIF
      NQTOT=NQTOT+1
      NQ(JP)=NQ(JP)+1
      CALL QUENCH(.FALSE.,JP,ITERATIONS,TIME,BRUN,QDONE,SCREENC)
      WRITE(MYUNIT,'(A,I10,A,F20.10,A,I5,A,G12.5,30X,A,F11.1)') 'QU ',NQ(JP),' E=',POTEL,' STEPS=',ITERATIONS,' RMS=',RMS,' T=',TIME
   ! SAVE THE BEST STRUCTURE
      IF (LEBEST-POTEL.GT.ECONV) THEN
         LEBEST=POTEL
         QBEST(1:3*NATOMS)=COORDS(1:3*NATOMS,JP)
         VATBEST(1:NATOMS)=VAT(1:NATOMS,JP)
         QBCHANGED=.TRUE.
         QBORDERED=.TRUE.
         QBCORE=NCOREREAL
!        WRITE(MYUNIT,'(A,2L5,I6)') 'SYMMETRY> E QBORDERED,QBCHANGED,QBCORE=',QBORDERED,QBCHANGED,QBCORE

!   DO J2=1,3*NATOMS
!      X(J2)=QBEST(J2)
!   ENDDO
!   CALL POTENTIAL(X,DUMMYGRAD,DUMMYE,.FALSE.,.FALSE.)
!   DO J2=1,NATOMS
!      IF (VT(J2).NE.0.0D0) THEN
!         IF (ABS((VT(J2)-VATBEST(J2))/VT(J2)).GT.0.01D0) THEN
!            WRITE(MYUNIT,'(A,I8,2F15.5)') 'SYMMETRY> F J2,VATBEST,VT(J2)=',J2,VATBEST(J2),VT(J2)
!            STOP
!         ENDIF
!      ENDIF
!   ENDDO

         NSYMREM=0
!        NSURFMOVES(JP)=0
!        SHELLMOVES(JP)=.TRUE.
!        NCORE(JP)=0
!        WRITE(MYUNIT,'(A)') 'SYMMETRY> TURNING OFF SHELL MOVES'
         EXIT PERMS
      ENDIF
      IF (NQTOT-NQTOTSAVE.GE.NSYMQMAX) EXIT PERMS
      IF (HIT) EXIT PERMS
   ENDDO PERMS
ENDIF

IF (EPREV(JP)-LEBEST.GT.ECONV) CHANGEDE=.TRUE. 
EPREV(JP)=LEBEST
POTEL=LEBEST
VAT(1:NATOMS,JP)=VATBEST(1:NATOMS)
COORDS(1:3*NATOMS,JP)=QBEST(1:3*NATOMS)
!
! EVEN IF THE ENERGY HASN'T CHANGED THE COORDINATES IN COORDS MAY HAVE
! BEEN PERMUTED. WE NEED COORDSO TO BE EXACTLY THE SAME SO THAT THE
! ROUTINE KEEPSYM CAN WORK. COORDSO IS USED TO DEFINE THE STEP IN THIS
! ROUTINE.
!
! IF (CHANGEDE) THEN
   IF (CENT.AND.(.NOT.SEEDT)) THEN 
     IF (ELLIPSOIDT) THEN
          CALL CENTRE2(COORDS(1:3*NATOMS/2,JP))
     ELSE
          CALL CENTRE2(COORDS(1:3*NATOMS,JP))
     END IF
   END IF
   COORDSO(1:3*(NATOMS-NSEED),JP)=COORDS(1:3*(NATOMS-NSEED),JP)
!  WRITE(MYUNIT,'(A,2G20.10)'),'SYMMETRY> COORDSO CHANGED: ',COORDSO(1,JP),COORDS(1,JP)
   VATO(1:NATOMS,JP)=VAT(1:NATOMS,JP)
! ENDIF

DO J1=1,NPAR
   IF (J1.EQ.JP) CYCLE
   WRITE(MYUNIT,*) 'SYMMETRY> J1,NCORE,PTGROUP,POINTGROUP=',J1,NCORE(J1),PTGROUP(J1),POINTGROUP
!  IF (NCORE(J1).EQ.0) CYCLE 
!  IF ((POINTGROUP(1:2).EQ.PTGROUP(J1)(1:2)).OR.((POINTGROUP(1:1).EQ.'T').AND.(PTGROUP(J1)(1:1).EQ.'O'))) THEN
   IF (POINTGROUP(1:2).EQ.PTGROUP(J1)(1:2)) THEN
      SR3=DSQRT(3.0D0)
      WRITE(MYUNIT,'(A,I1,3A,I6,A)') '[',JP,']SYMMETRY> POINT GROUP ',POINTGROUP,' COINCIDES WITH RUN ',J1,' RESEEDING'
      DO J2=1,3*NATOMS
         RANDOM=(DPRAND()-0.5D0)*2.0D0
         COORDS(J2,JP)=RANDOM*DSQRT(RADIUS)/SR3
      ENDDO
      NCORE(JP)=0
      CALL QUENCH(.FALSE.,JP,ITERATIONS,TIME,BRUN,QDONE,SCREENC)
      NSUCCESS(JP)=0
      NFAIL(JP)=0
      EBEST(JP)=POTEL ! THIS IS COMMUNICATED VIA COMMON BLOCK MYPOT
      BESTCOORDS(1:3*NATOMS,JP)=COORDS(1:3*NATOMS,JP)
      JBEST(JP)=LNQUENCH
      EPREV(JP)=POTEL 
      EPPREV(JP)=0.0D0
      NSYMREM=0
      PTGROUP(JP)='    '
      NCORE(JP)=0
      DEALLOCATE(OCCS)
      RETURN
   ENDIF
ENDDO
PTGROUP(JP)=POINTGROUP

IF (QBORDERED) NCORE(JP)=QBCORE

IF (NPAR.GT.1) THEN
   WRITE(MYUNIT,'(A,I1,A,I8,3A,I8,A)') '[',JP,']SYMMETRY> NUMBER OF CORE ATOMS=', &
  &      NCORE(JP),' CORE SYMMETRY ',POINTGROUP,' AFTER ',NQ(JP),' QUENCHES'
ELSE
   WRITE(MYUNIT,'(A,I8,3A,I8,A)') 'SYMMETRY> NUMBER OF CORE ATOMS=', &
  &      NCORE(JP),' CORE SYMMETRY ',POINTGROUP,' AFTER ',NQ(JP),' QUENCHES'
ENDIF

DEALLOCATE(OCCS)

RETURN

END SUBROUTINE SYMMETRY

