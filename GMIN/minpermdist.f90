!     COPYRIGHT (C) 1999-2008 DAVID J. WALES
!  THIS FILE IS PART OF OPTIM.
!
!  OPTIM IS FREE SOFTWARE; YOU CAN REDISTRIBUTE IT AND/OR MODIFY
!  IT UNDER THE TERMS OF THE GNU GENERAL PUBLIC LICENSE AS PUBLISHED BY
!  THE FREE SOFTWARE FOUNDATION; EITHER VERSION 2 OF THE LICENSE, OR
!  (AT YOUR OPTION) ANY LATER VERSION.
!
!  OPTIM IS DISTRIBUTED IN THE HOPE THAT IT WILL BE USEFUL,
!  BUT WITHOUT ANY WARRANTY; WITHOUT EVEN THE IMPLIED WARRANTY OF
!  MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.  SEE THE
!  GNU GENERAL PUBLIC LICENSE FOR MORE DETAILS.
!
!  YOU SHOULD HAVE RECEIVED A COPY OF THE GNU GENERAL PUBLIC LICENSE
!  ALONG WITH THIS PROGRAM; IF NOT, WRITE TO THE FREE SOFTWARE
!  FOUNDATION, INC., 59 TEMPLE PLACE, SUITE 330, BOSTON, MA  02111-1307  USA
!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!
!  COORDSA BECOMES THE OPTIMAL ALIGNMENT OF THE OPTIMAL PERMUTATION(-INVERSION)
!  ISOMER, BUT WITHOUT THE PERMUTATIONS. DISTANCE IS THE RESIDUAL SQUARE DISTANCE
!  FOR THE BEST ALIGNMENT WITH RESPECT TO PERMUTATION(-INVERSION)S AS WELL AS
!  ORIENTATION AND CENTRE OF MASS.
!
!  MYORIENT IS CALLED FIRST FOR BOTH COORDSA AND COORDSB TO PUT THEM INTO
!  A STANDARD ORIENTATION IN DUMMYA AND DUMMYB (WHICH BOTH HAVE THE CENTRE OF
!  COORDINATES AT THE ORIGIN). 
!  THE OBJECTIVE IS TO IDENTIFY PERMUTATION-INVERSION ISOMERS WITHOUT FAIL. 
!  HOWEVER, WE HAVE TO CYCLE OVER ALL EQUIVALENT ATOMS IN TWO PARTICULAR ORBITS FOR DUMMYA
!  TO ACHIEVE THIS.
!  WE ITERATE PERMUTATIONS AND NEWMINDIST MINIMISATIONS UP TO A MAXIMUM NUMBER OR
!  UNTIL NO MORE PERMUTATIONS ARE REQUIRED FOR EACH INSTANCE OF DUMMYA ALIGNED 
!  ACCORDING TO NCHOOSE1 AND NCHOOSE2 BY MYORIENT. THE CUMULATIVE ROTATION
!  MATRIX THAT TAKES THE INITIAL DUMMYA TO THE ONE THAT ALIGNS BEST WITH DUMMYB
!  IS SAVED IN RMATCUMUL.
!  THEN, IF WE'VE NOT GOING BULK, AMBER, OR CHARMM, WE TRY AGAIN FOR THE INVERTED
!  VERSION OF COORDSA. THE TRANSFORMATION CORRESPONDING TO THE MINIMUM DISTANCE
!  IS SAVED WHENEVER IT IS IMPROVED - THE BEST ALIGNMENT INCLUDING PERMUTATIONS
!  IS SAVED IN XBEST, AND THE LAST STEP IS TO ROTATE THIS BACK TO COINCIDE BEST
!  WITH COORDSB (RATHER THAN DUMMYB) USING ROTINVBBEST. THIS GIVES SUITABLE
!  FIXED END POINTS FOR DNEB.
!  FINALLY, WE TRANSFORM COORDSA TO BE IN OPTIMAL ALIGNMENT, BUT WITHOUT THE
!  PERMUTATIONS IN XBEST. THE OVERALL TRANSFORMATION IS
!  COORDSA -> +/- ROTINVB RMATCUMUL ROTA (COORDSA - CMA) 
!
!  THE CORRESPONDENCE BETWEEN COORDSA AND DUMMYA AFTER DUMMYA HAS BEEN ALIGNED BY
!  NEWMINDIST IS
!  +/- RMATCUMUL ROTA (COORDSA - CMA) = PERMUTATION(DUMMYA)
!  WHERE +/- IS GIVEN BY THE VALUE OF INVERT.
!  THE CENTRES OF COORDINATES FOR COORDSA AND COORDSB CAN BE ANYWHERE. ON RETURN, THE
!  CENTRE OF COORDINATES OF COORDSA WILL BE THE SAME AS FOR COORDSB.
!
SUBROUTINE MINPERMDIST(COORDSB,COORDSA,NATOMS,DEBUG,BOXLX,BOXLY,BOXLZ,BULKT,TWOD,DISTANCE,DIST2,RIGID,RMATBEST)
USE COMMONS,ONLY : NPERMGROUP, NPERMSIZE, PERMGROUP, NSETS, SETS, CHRMMT, MYUNIT, STOCKT, NFREEZE, &
  & AMBERT, CSMGPINDEX, CSMT, ZSYM, PERIODIC, PERMDIST, PULLT, EFIELDT
USE PORFUNCS
IMPLICIT NONE

INTEGER, PARAMETER :: MAXIMUMTRIES=20
INTEGER NATOMS, NPERM, PATOMS, NTRIES, ISTAT
INTEGER J3, INVERT, NORBIT1, NORBIT2, NCHOOSE2, NDUMMY, LPERM(NATOMS), J1, J2, NCHOOSE1
DOUBLE PRECISION DIST2, COORDSA(3*NATOMS), COORDSB(3*NATOMS), DISTANCE, DUMMYA(3*NATOMS), DUMMYB(3*NATOMS), DUMMY(3*NATOMS)
DOUBLE PRECISION BOXLX,BOXLY,BOXLZ,WORSTRAD,RMAT(3,3),ENERGY, VNEW(3*NATOMS), DX, DY, DZ, RMS, DBEST, XBEST(3*NATOMS)
DOUBLE PRECISION CMXA, CMXB, CMXC, PDISTANCE
DOUBLE PRECISION ROTA(3,3), ROTINVA(3,3), ROTB(3,3), ROTINVB(3,3), ROTINVBBEST(3,3), ROTABEST(3,3), RMATBEST(3,3), TMAT(3,3)
DOUBLE PRECISION CMAX, CMAY, CMAZ, CMBX, CMBY, CMBZ, RMATCUMUL(3,3)
DOUBLE PRECISION REFXZ(3,3)
LOGICAL DEBUG, TWOD, RIGID, BULKT
DOUBLE PRECISION PDUMMYA(3*NATOMS), PDUMMYB(3*NATOMS), LDISTANCE, DUMMYC(3*NATOMS), XDUMMY, GEOMDIFFTOL
SAVE NORBIT1, NORBIT2
INTEGER NEWPERM(NATOMS), ALLPERM(NATOMS), SAVEPERM(NATOMS)

! DUMMYB(1:3*NATOMS)=COORDSB(1:3*NATOMS)
! DUMMYA(1:3*NATOMS)=COORDSA(1:3*NATOMS)

GEOMDIFFTOL=0.5D0
DISTANCE = 0.0D0
IF (.NOT.PERMDIST) THEN
   CALL NEWMINDIST(COORDSB,COORDSA,NATOMS,DISTANCE,PERIODIC,TWOD,ZSYM(1),.FALSE.,RIGID,DEBUG,RMAT)
   RETURN
ENDIF

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
! CALL OCHARMM(DUMMYA,VNEW,ENERGY,.FALSE.,.FALSE.)
! CALL POTENTIAL(DUMMYA,ENERGY,VNEW,.TRUE.,.FALSE.,RMS,.FALSE.,.FALSE.)
! PRINT '(2(A,F25.15))',' INITIAL ENERGY=',ENERGY,' RMS=',RMS
! PRINT '(2(A,F25.15))',' FOR COORDINATES:'
! PRINT '(3F25.15)',DUMMYA(1:3*NATOMS)
! PRINT '(A,F25.15,A)',' INITIAL ENERGY=',ENERGY,' KCAL/MOL'
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

!  OPEN(UNIT=10,FILE='MINPERMDIST.XYZ',STATUS='UNKNOWN')
!  WRITE(10,'(I6)') NATOMS/2
!  WRITE(10,'(A)') 'A INITIAL'
!  DO J3=1,NATOMS/2
!      WRITE(10,'(A2,2X,3F20.10)') 'LA',COORDSA(3*(J3-1)+1),COORDSA(3*(J3-1)+2),COORDSA(3*(J3-1)+3)
!  ENDDO
!  WRITE(10,'(I6)') NATOMS/2
!  WRITE(10,'(A)') 'B INITIAL'
!  DO J3=1,NATOMS/2
!      WRITE(10,'(A2,2X,3F20.10)') 'LA',COORDSB(3*(J3-1)+1),COORDSB(3*(J3-1)+2),COORDSB(3*(J3-1)+3)
!  ENDDO
!  CLOSE(10)
!
!  CALCULATE ORIGINAL CENTRES OF MASS.
!
CMAX=0.0D0; CMAY=0.0D0; CMAZ=0.0D0
IF (NFREEZE.GT.0) GOTO 11 ! DON;T SHIFT OR REORIENT COORDINATES WITH FROZEN ATOMS
IF (STOCKT.OR.RIGID) THEN 
   DO J1=1,NATOMS/2
      CMAX=CMAX+COORDSA(3*(J1-1)+1)
      CMAY=CMAY+COORDSA(3*(J1-1)+2)
      CMAZ=CMAZ+COORDSA(3*(J1-1)+3)
   ENDDO
   CMAX=2*CMAX/NATOMS; CMAY=2*CMAY/NATOMS; CMAZ=2*CMAZ/NATOMS
   CMBX=0.0D0; CMBY=0.0D0; CMBZ=0.0D0
   DO J1=1,NATOMS/2
      CMBX=CMBX+COORDSB(3*(J1-1)+1)
      CMBY=CMBY+COORDSB(3*(J1-1)+2)
      CMBZ=CMBZ+COORDSB(3*(J1-1)+3)
   ENDDO
   CMBX=2*CMBX/NATOMS; CMBY=2*CMBY/NATOMS; CMBZ=2*CMBZ/NATOMS
ELSE
   DO J1=1,NATOMS
      CMAX=CMAX+COORDSA(3*(J1-1)+1)
      CMAY=CMAY+COORDSA(3*(J1-1)+2)
      CMAZ=CMAZ+COORDSA(3*(J1-1)+3)
   ENDDO
   CMAX=CMAX/NATOMS; CMAY=CMAY/NATOMS; CMAZ=CMAZ/NATOMS
   CMBX=0.0D0; CMBY=0.0D0; CMBZ=0.0D0
   DO J1=1,NATOMS
      CMBX=CMBX+COORDSB(3*(J1-1)+1)
      CMBY=CMBY+COORDSB(3*(J1-1)+2)
      CMBZ=CMBZ+COORDSB(3*(J1-1)+3)
   ENDDO
   CMBX=CMBX/NATOMS; CMBY=CMBY/NATOMS; CMBZ=CMBZ/NATOMS
ENDIF
11 CONTINUE

INVERT=1
DBEST=1.0D100
60 NCHOOSE1=0
65 NCHOOSE1=NCHOOSE1+1
40 NCHOOSE2=0
30 NCHOOSE2=NCHOOSE2+1
DUMMYB(1:3*NATOMS)=COORDSB(1:3*NATOMS)
DUMMYA(1:3*NATOMS)=COORDSA(1:3*NATOMS)
DO J1=1,NATOMS
   ALLPERM(J1)=J1
ENDDO

! THE OPTIMAL ALIGNMENT RETURNED BY MINPERDIST IS A LOCAL MINIMUM, BUT MAY NOT
! BE THE GLOBAL MINIMUM. CALLING MYORIENT FIRST SHOULD PUT PERMUTATIONAL ISOMERS
! INTO A STANDARD ALIGNMENT AND SPOT THE GLOBAL MINIMUM ZEDRO DISTANCE IN ONE
! GO. HOWEVER, WE ALSO NEED TO CYCLE OVER EQUIVALENT ATOMS IN ORBITS USING NCHOOSE2.
!
! PROBLEMS CAN OCCUR IF WE DON'T USE ALL THE ATOMS SPECIFIED BY NORBIT1 AND NORBIT2
! BECAUSE OF THE NUMERICAL CUTOFFS EMPLOYED IN MYORIENT. WE COULD MISS THE
! RIGHT ORIENTATION! 
!
! IF WE USE MYORIENT TO PRODUCE PARTICULAR ORIENTATIONS THEN WE END UP ALIGNING 
! COORDSA NOT WITH COORDSB BUT WITH THE STANDARD ORIENTATION OF COORDSB IN DUMMYB.
! WE NOW DEAL WITH THIS BY TRACKING THE COMPLETE TRANSFORMATION, INCLUDING THE
! CONTRIBUTION OF MYORIENT USING ROTB AND ROTINVB.
!

IF ((.NOT.BULKT).AND.(NFREEZE.LE.0).AND.(.NOT.CSMT)) THEN
   IF (STOCKT) THEN
      TMAT(1:3,1:3)=0.0D0
      TMAT(1,1)=INVERT*1.0D0; TMAT(2,2)=INVERT*1.0D0; TMAT(3,3)=INVERT*1.0D0
      CALL NEWROTGEOMSTOCK(NATOMS,DUMMYA,TMAT,0.0D0,0.0D0,0.0D0)
      DUMMY(1:3*NATOMS)=DUMMYA(1:3*NATOMS)
      CALL MYORIENT(DUMMYA,DUMMYC,NORBIT1,NCHOOSE1,NORBIT2,NCHOOSE2,NATOMS/2,DEBUG,ROTA,ROTINVA,STOCKT)
      CALL NEWROTGEOMSTOCK(NATOMS,DUMMY,ROTA,0.0D0,0.0D0,0.0D0)
      DUMMYA(1:3*NATOMS)=DUMMY(1:3*NATOMS)

      DUMMY(1:3*NATOMS)=DUMMYB(1:3*NATOMS)
      CALL MYORIENT(DUMMYB,DUMMYC,NORBIT1,1,NORBIT2,1,NATOMS/2,DEBUG,ROTB,ROTINVB,STOCKT)
      CALL NEWROTGEOMSTOCK(NATOMS,DUMMY,ROTB,0.0D0,0.0D0,0.0D0)
      DUMMYB(1:3*NATOMS)=DUMMY(1:3*NATOMS)
      DO J1=1,3*(NATOMS/2)
         DISTANCE=DISTANCE+(DUMMYA(J1)-DUMMYB(J1))**2
      ENDDO
   ELSE
      DUMMYC(1:3*NATOMS)=INVERT*DUMMYA(1:3*NATOMS)
      IF ((PULLT.OR.EFIELDT).AND.(INVERT.EQ.-1)) THEN ! REFLECT IN XZ PLANE
         DO J1=1,NATOMS
            DUMMYC(3*(J1-1)+1)=DUMMYA(3*(J1-1)+1)
            DUMMYC(3*(J1-1)+2)=-DUMMYA(3*(J1-1)+2)
            DUMMYC(3*(J1-1)+3)=DUMMYA(3*(J1-1)+3)
         ENDDO
      ENDIF
      CALL MYORIENT(DUMMYC,DUMMY,NORBIT1,NCHOOSE1,NORBIT2,NCHOOSE2,NATOMS,DEBUG,ROTA,ROTINVA,STOCKT)
      DUMMYA(1:3*NATOMS)=DUMMY(1:3*NATOMS)
      CALL MYORIENT(DUMMYB,DUMMY,NORBIT1,1,NORBIT2,1,NATOMS,DEBUG,ROTB,ROTINVB,STOCKT)
      DUMMYB(1:3*NATOMS)=DUMMY(1:3*NATOMS)
      DISTANCE=0.0D0
      DO J1=1,3*NATOMS
         DISTANCE=DISTANCE+(DUMMYA(J1)-DUMMYB(J1))**2
      ENDDO
   ENDIF
   IF (DEBUG) WRITE(MYUNIT,'(A,G20.10)') ' MINPERMDIST> AFTER INITIAL CALL TO MYORIENT DISTANCE=',SQRT(DISTANCE)

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!  WRITE(10,'(I6)') NATOMS/2
!  WRITE(10,'(A,2I8)') 'DUMMYA AFTER MYORIENT, NCHOOSE1,NCHOOSE2=',NCHOOSE1,NCHOOSE2
!  DO J3=1,NATOMS/2
!      WRITE(10,'(A2,2X,3F20.10)') 'LA',DUMMYA(3*(J3-1)+1),DUMMYA(3*(J3-1)+2),DUMMYA(3*(J3-1)+3)
!  ENDDO
!  WRITE(10,'(I6)') NATOMS/2
!  WRITE(10,'(A)') 'DUMMYB AFTER MYORIENT'
!  DO J3=1,NATOMS/2
!      WRITE(10,'(A2,2X,3F20.10)') 'LA',DUMMYB(3*(J3-1)+1),DUMMYB(3*(J3-1)+2),DUMMYB(3*(J3-1)+3)
!  ENDDO
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

ELSE
  NORBIT1=1
  NORBIT2=1
  ROTINVB(1:3,1:3)=0.0D0
  ROTINVB(1,1)=1.0D0; ROTINVB(2,2)=1.0D0; ROTINVB(3,3)=1.0D0
  CALL NEWMINDIST(DUMMYB,DUMMYA,NATOMS,DISTANCE,BULKT,TWOD,'AX    ',.FALSE.,RIGID,DEBUG,RMAT)
  IF (DEBUG) WRITE(MYUNIT,'(A,G20.10)') ' MINPERMDIST> AFTER INITIAL CALL TO NEWMINDIST DISTANCE=',DISTANCE
  DISTANCE=DISTANCE**2 ! MINPERMDIST RETURNS THE DISTANCE SQUARED FOR HISTORICAL REASONS
ENDIF
IF (DEBUG) WRITE(MYUNIT,'(A,4I8)') ' MINPERMDIST> SIZE OF ORBITS AND SELECTED ATOMS: ',NORBIT1,NORBIT2,NCHOOSE1,NCHOOSE2

! CALL POTENTIAL(DUMMYA,ENERGY,VNEW,.TRUE.,.FALSE.,RMS,.FALSE.,.FALSE.)
! PRINT '(2(A,F25.15))',' NEW INITIAL ENERGY=',ENERGY,' RMS=',RMS
! PRINT '(2(A,F25.15))',' FOR COORDINATES:'
! PRINT '(3F25.15)',DUMMYA(1:3*NATOMS)
!
!  BIPARTITE MATCHING ROUTINE FOR PERMUTATIONS. COORDINATES IN DUMMYB DO NOT CHANGE
!  BUT THE COORDINATES IN DUMMYA DO. DISTANCE IS THE DISTANCE IN THIS CASE.
!  WE RETURN TO LABEL 10 AFTER EVERY ROUND OF PERMUTATIONAL/ORIENTATIONAL ALIGNMENT
!  UNLESS WE HAVE CONVERGED TO THE IDENTITY PERMUTATION.
!
!  ATOMS ARE NOT ALLOWED TO APPEAR IN MORE THAN ONE GROUP.
!  THE MAXIMUM NUMBER OF PAIR EXCHANGES ASSOCIATED WITH A GROUP IS TWO.
!
NTRIES=0
!
!  RMATCUMUL CONTAINS THE ACCUMULATED ROTATION MATRIX THAT RELATES THE ORIGINAL 
!  DUMMYA OBTAINED FROM COORDSA TO THE FINAL ONE.
!
RMATCUMUL(1:3,1:3)=0.0D0
RMATCUMUL(1,1)=1.0D0; RMATCUMUL(2,2)=1.0D0; RMATCUMUL(3,3)=1.0D0
PDISTANCE=1.0D100
10 CONTINUE
NTRIES=NTRIES+1

NDUMMY=1
DO J1=1,NATOMS
   NEWPERM(J1)=J1
ENDDO
!
! ALLPERM SAVES THE PERMUTATION FROM THE PREVIOUS CYCLE.
! NEWPERM CONTAINS THE PERMUTATION FOR THIS CYCLE, RELATIVE TO THE IDENTITY.
! SAVEPERM IS TEMPORARY STORAGE FOR NEWPERM.
! NEWPERM MUST BE APPLIED TO ALLPERM AFTER THE LOOP OVER NPERMGROUP AND
! CORRESPONDING SWAPS.
!
! NEW VERSION ALLOWS FOR OVERLAPPING ATOMS IN NPERMGROUP, SO THAT ATOMS
! CAN APPEAR IN MORE THSAN ONE GROUP. THIS WAS NEEDED TO FLEXIBLE WATER POTENTIALS.
!
DO J1=1,NPERMGROUP
   PATOMS=NPERMSIZE(J1)
   DO J2=1,PATOMS
      PDUMMYA(3*(J2-1)+1)=DUMMYA(3*(NEWPERM(PERMGROUP(NDUMMY+J2-1))-1)+1)
      PDUMMYA(3*(J2-1)+2)=DUMMYA(3*(NEWPERM(PERMGROUP(NDUMMY+J2-1))-1)+2)
      PDUMMYA(3*(J2-1)+3)=DUMMYA(3*(NEWPERM(PERMGROUP(NDUMMY+J2-1))-1)+3)
      PDUMMYB(3*(J2-1)+1)=DUMMYB(3*(NEWPERM(PERMGROUP(NDUMMY+J2-1))-1)+1)
      PDUMMYB(3*(J2-1)+2)=DUMMYB(3*(NEWPERM(PERMGROUP(NDUMMY+J2-1))-1)+2)
      PDUMMYB(3*(J2-1)+3)=DUMMYB(3*(NEWPERM(PERMGROUP(NDUMMY+J2-1))-1)+3)
   ENDDO
   CALL MINPERM(PATOMS, PDUMMYB, PDUMMYA, BOXLX, BOXLY, BOXLZ, BULKT, LPERM, LDISTANCE, DIST2, WORSTRAD)
   SAVEPERM(1:NATOMS)=NEWPERM(1:NATOMS)
   DO J2=1,PATOMS
      SAVEPERM(PERMGROUP(NDUMMY+J2-1))=NEWPERM(PERMGROUP(NDUMMY+LPERM(J2)-1))
   ENDDO
!
! UPDATE PERMUTATION OF ASSOCIATED ATOMS, IF ANY.
! WE MUST DO THIS AS WE GO ALONG, BECAUSE THESE ATOMS COULD MOVE IN MORE THAN
! ONE PERMUTATIONAL GROUP NOW.
!
   IF (NSETS(J1).GT.0) THEN
      DO J2=1,PATOMS
         DO J3=1,NSETS(J1)
            SAVEPERM(SETS(PERMGROUP(NDUMMY+J2-1),J3))=SETS(NEWPERM(PERMGROUP(NDUMMY+LPERM(J2)-1)),J3)
         ENDDO
      ENDDO
   ENDIF
   NDUMMY=NDUMMY+NPERMSIZE(J1)
   NEWPERM(1:NATOMS)=SAVEPERM(1:NATOMS)
ENDDO
!
! UPDATE THE OVERALL PERMUTATION HERE.
! 
DO J1=1,NATOMS
   SAVEPERM(ALLPERM(J1))=ALLPERM(NEWPERM(J1))
ENDDO
ALLPERM(1:NATOMS)=SAVEPERM(1:NATOMS)

DUMMY(1:3*NATOMS)=DUMMYA(1:3*NATOMS)
NPERM=0
DISTANCE=0.0D0
IF (STOCKT .OR. RIGID) THEN ! ADDITIONAL PERMUTATION OF DIPOLES
   DO J1=(NATOMS/2)+1,NATOMS
      ALLPERM(J1)=ALLPERM(J1-(NATOMS/2))+(NATOMS/2)
      NEWPERM(J1)=NEWPERM(J1-(NATOMS/2))+(NATOMS/2)
   ENDDO
ENDIF
!
! UPDATE COORDINATES IN DUMMYA TO OVERALL PERMUTATION USING NEWPERM.
!
DO J3=1,NATOMS
   DUMMYA(3*(J3-1)+1)=DUMMY(3*(NEWPERM(J3)-1)+1)
   DUMMYA(3*(J3-1)+2)=DUMMY(3*(NEWPERM(J3)-1)+2)
   DUMMYA(3*(J3-1)+3)=DUMMY(3*(NEWPERM(J3)-1)+3)
   IF (J3.NE.NEWPERM(J3)) THEN
!     IF (DEBUG) WRITE(*,'(A,I5,A,I5)') ' MINPERMDIST> MOVE POSITION ',NEWPERM(J3),' TO ',J3
      NPERM=NPERM+1
   ENDIF
   IF (STOCKT .OR. RIGID) THEN
      IF (J3.LE.(NATOMS/2)) THEN
         DISTANCE=DISTANCE+(DUMMYA(3*(J3-1)+1)-DUMMYB(3*(J3-1)+1))**2 &
  &                       +(DUMMYA(3*(J3-1)+2)-DUMMYB(3*(J3-1)+2))**2 &
  &                       +(DUMMYA(3*(J3-1)+3)-DUMMYB(3*(J3-1)+3))**2
      ENDIF
   ELSEIF (.NOT.BULKT) THEN
      DISTANCE=DISTANCE+(DUMMYA(3*(J3-1)+1)-DUMMYB(3*(J3-1)+1))**2 &
  &                    +(DUMMYA(3*(J3-1)+2)-DUMMYB(3*(J3-1)+2))**2 &
  &                    +(DUMMYA(3*(J3-1)+3)-DUMMYB(3*(J3-1)+3))**2
   ELSE
      DISTANCE=DISTANCE + (DUMMYA(3*(J3-1)+1)-DUMMYB(3*(J3-1)+1)- BOXLX*NINT((DUMMYA(3*(J3-1)+1)-DUMMYB(3*(J3-1)+1))/BOXLX))**2 &
  &                     + (DUMMYA(3*(J3-1)+2)-DUMMYB(3*(J3-1)+2)- BOXLY*NINT((DUMMYA(3*(J3-1)+2)-DUMMYB(3*(J3-1)+2))/BOXLY))**2
      IF (.NOT.TWOD) DISTANCE=DISTANCE+(DUMMYA(3*(J3-1)+3)-DUMMYB(3*(J3-1)+3) -  &
  &                                                               BOXLZ*NINT((DUMMYA(3*(J3-1)+3)-DUMMYB(3*(J3-1)+3))/BOXLZ))**2
   ENDIF
ENDDO
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
! CALL UPDATENBONDS(DUMMYA)
! CALL OCHARMM(DUMMYA,VNEW,ENERGY,.FALSE.,.FALSE.)
! CALL POTENTIAL(DUMMYA,ENERGY,VNEW,.TRUE.,.FALSE.,RMS,.FALSE.,.FALSE.)
! PRINT '(2(A,F25.15))',' B ENERGY IS NOW=',ENERGY,' RMS=',RMS
! PRINT '(2(A,F25.15))',' FOR COORDINATES:'
! PRINT '(3F25.15)',DUMMYA(1:3*NATOMS)
! PRINT '(A,F25.15,A)',' ENERGY IS NOW=',ENERGY,' KCAL/MOL'
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

IF (DEBUG) WRITE(MYUNIT,'(A,I6,A,G20.10)') ' MINPERMDIST> DISTANCE AFTER PERMUTING ',NPERM,' PAIRS OF ATOMS=',SQRT(DISTANCE)

! CALL OCHARMM(DUMMYA,VNEW,ENERGY,.FALSE.,.FALSE.)
! PRINT '(A,F25.15,A)',' ENERGY FOR LAST CYCLE=',ENERGY,' KCAL/MOL'
! CALL UPDATENBONDS(DUMMYA)
! PRINT '(A,F25.15,A)',' ENERGY FOR LAST CYCLE=',ENERGY,' KCAL/MOL AFTER UPDATE'
! CALL POTENTIAL(DUMMYA,ENERGY,VNEW,.TRUE.,.FALSE.,RMS,.FALSE.,.FALSE.)
! PRINT '(2(A,F25.15))',' ENERGY FOR LAST CYCLE=',ENERGY,' RMS=',RMS
!
!  OPTIMAL ALIGNMENT. COORDINATES IN DUMMYA ARE RESET BY NEWMINDIST (SECOND ARGUMENT).
!  MUST ALLOW AT LEAST ONE CALL TO NEWMINDIST IN CASE THE MYORIENT RESULT IS TERRIBLE
!  BUT GIVES ZERO PERMUTATIONS!
!  
!          IF (DEBUG) THEN
!             OPEN(UNIT=765,FILE='DUMMYB.XYZ',STATUS='UNKNOWN')
!             NDUMMY=(NATOMS/CSMGPINDEX)
!             DO J1=1,CSMGPINDEX
!                WRITE(765,'(I6)') NDUMMY
!                WRITE(765,'(A,I6)') 'RESULT OF POINT GROUP OPERATION ',J1
!                WRITE(765,'(A,3G20.10)') ('LA ',DUMMYB(3*(J2-1)+1+3*NDUMMY*(J1-1)), &
!      &                    DUMMYB(3*(J2-1)+2+3*NDUMMY*(J1-1)),DUMMYB(3*(J2-1)+3+3*NDUMMY*(J1-1)),J2=1,NDUMMY)
!             ENDDO
!             CLOSE(765)
!             OPEN(UNIT=765,FILE='DUMMYA.XYZ',STATUS='UNKNOWN')
!             DO J1=1,CSMGPINDEX
!                WRITE(765,'(I6)') NDUMMY
!                WRITE(765,'(A,I6)') 'MATCHING POINT GROUP OPERATION ',J1
!                WRITE(765,'(A,3G20.10)') ('LA ',DUMMYA(3*(J2-1)+1+3*NDUMMY*(J1-1)), &
!      &                    DUMMYA(3*(J2-1)+2+3*NDUMMY*(J1-1)),DUMMYA(3*(J2-1)+3+3*NDUMMY*(J1-1)),J2=1,NDUMMY)
!             ENDDO
!             CLOSE(765)
!          ENDIF
! STOP

IF ((NPERM.NE.0).OR.(NTRIES.EQ.1)) THEN 

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!  PRINT '(A)','DUMMYA BEFORE NEWMINDIST:'
!  PRINT '(3F20.10)',DUMMYA(1:3*(NATOMS/2))
!  PRINT '(A)','DUMMYB BEFORE NEWMINDIST:'
!  PRINT '(3F20.10)',DUMMYB(1:3*(NATOMS/2))
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

   CALL NEWMINDIST(DUMMYB,DUMMYA,NATOMS,DISTANCE,BULKT,TWOD,'AX    ',.FALSE.,RIGID,DEBUG,RMAT)
   RMATCUMUL=MATMUL(RMAT,RMATCUMUL)
   DISTANCE=DISTANCE**2 ! WE ARE USING DISTANCE^2 FURTHER DOWN

   IF (DEBUG) WRITE(MYUNIT,'(A,G20.10,A,I6)')  ' MINPERMDIST> DISTANCE AFTER NEWMINDIST=                     ',SQRT(DISTANCE), &
  &           ' TRIES=',NTRIES  
   CALL FLUSH(MYUNIT,ISTAT)
   IF ((NTRIES.LT.MAXIMUMTRIES).AND.(DISTANCE.LT.PDISTANCE)) THEN
!     WRITE(MYUNIT,'(A,I6,2G20.10)') 'NTRIES,DISTANCE,PDISTANCE=',NTRIES,DISTANCE,PDISTANCE
      PDISTANCE=DISTANCE
      GOTO 10
   ELSE ! PREVENT INFINITE LOOP
      IF (DEBUG) WRITE(MYUNIT,'(A)') &
  &              ' MINPERMDIST> WARNING - NUMBER OF TRIES EXCEEDED OR DISTANCE INCREASED WITH NONZERO PERMUTATIONS'
   ENDIF
ENDIF

IF (DISTANCE.LT.DBEST) THEN
   DBEST=DISTANCE
   XBEST(1:3*NATOMS)=DUMMYA(1:3*NATOMS)
   RMATBEST(1:3,1:3)=RMATCUMUL(1:3,1:3)
   ROTINVBBEST(1:3,1:3)=ROTINVB(1:3,1:3) 
   ROTABEST(1:3,1:3)=ROTA(1:3,1:3)      
   RMATBEST=MATMUL(RMATBEST,ROTABEST)
   IF (INVERT.EQ.-1) THEN
      IF (PULLT.OR.EFIELDT) THEN ! REFLECT IN XZ PLANE RATHER THAN INVERT!
         RMATBEST(1:3,1:3)=MATMUL(RMATBEST,REFXZ)
      ELSE
         RMATBEST(1:3,1:3)=-RMATBEST(1:3,1:3)
      ENDIF
   ENDIF
ENDIF

!
! IF GEOMDIFFTOL IS SET TOO SMALL WE COULD MISS THE BEST SOLUTION BY EXITING PREMATURELY. 
! TURN OFF THE NEXT LINE?!
!
! IF (SQRT(DBEST).LT.GEOMDIFFTOL) GOTO 50
IF (NCHOOSE2.LT.NORBIT2) GOTO 30
IF (NCHOOSE1.LT.NORBIT1) GOTO 65
!
!  NOW TRY THE ENANTIOMER (OR XZ REFLECTED STRUCTURE FOR PULLT.OR.EFIELDT).
!
IF ((NCHOOSE2.EQ.NORBIT2).AND.(NCHOOSE1.EQ.NORBIT1).AND.(INVERT.EQ.1)) THEN
!
! DON'T TRY INVERSION FOR BULK OR CHARMM OR AMBER OR FROZEN ATOMS OR CSM
!
   IF (BULKT.OR.CHRMMT.OR.AMBERT.OR.(NFREEZE.GT.0).OR.CSMT) GOTO 50 
   IF (DEBUG) WRITE(MYUNIT,'(A)') ' MINPERMDIST> INVERTING GEOMETRY FOR COMPARISON WITH TARGET'
   INVERT=-1
   GOTO 60
ENDIF

50 DISTANCE=DBEST
!
!  XBEST CONTAINS THE BEST ALIGNMENT OF A COORDINATES FOR THE ORIENTATION OF B COORDINATES IN DUMMYB.
!  ROTATE XBEST BY ROTINVB TO PUT IN BEST CORRESPONDENCE WITH COORDSB, UNDOING THE REORIENTATION TO DUMMYB FROM MYORIENT. 
!  WE SHOULD GET THE SAME RESULT FOR ROTINVB * RMATBEST * (COORDSA-CMA) 
!  WHERE RMATBEST = +/- RMATCUMUL * ROTA FOR THE BEST ALIGNMENT 
!  (ASIDE FROM A POSSIBLE PERMUTATION OF THE ATOM ORDERING)
!
   IF (NFREEZE.GT.0) THEN
      XDUMMY=0.0D0
      DO J1=1,NATOMS
         XDUMMY=XDUMMY+(COORDSB(3*(J1-1)+1)-XBEST(3*(J1-1)+1))**2+ &
  &                    (COORDSB(3*(J1-1)+2)-XBEST(3*(J1-1)+2))**2+ &
  &                    (COORDSB(3*(J1-1)+3)-XBEST(3*(J1-1)+3))**2
      ENDDO
   ELSE IF (STOCKT) THEN
      CALL NEWROTGEOMSTOCK(NATOMS,XBEST,ROTINVBBEST,0.0D0,0.0D0,0.0D0)
      XDUMMY=0.0D0
      DO J1=1,(NATOMS/2)
         XBEST(3*(J1-1)+1)=XBEST(3*(J1-1)+1)+CMBX
         XBEST(3*(J1-1)+2)=XBEST(3*(J1-1)+2)+CMBY
         XBEST(3*(J1-1)+3)=XBEST(3*(J1-1)+3)+CMBZ
         XDUMMY=XDUMMY+(COORDSB(3*(J1-1)+1)-XBEST(3*(J1-1)+1))**2+ &
  &                    (COORDSB(3*(J1-1)+2)-XBEST(3*(J1-1)+2))**2+ &
  &                    (COORDSB(3*(J1-1)+3)-XBEST(3*(J1-1)+3))**2
      ENDDO
   ELSEIF (BULKT) THEN
      XDUMMY=0.0D0
      DO J1=1,NATOMS
         XDUMMY=XDUMMY+(COORDSB(3*(J1-1)+1)-XBEST(3*(J1-1)+1) - BOXLX*NINT((COORDSB(3*(J1-1)+1)-XBEST(3*(J1-1)+1))/BOXLX))**2+ &
  &                    (COORDSB(3*(J1-1)+2)-XBEST(3*(J1-1)+2) - BOXLY*NINT((COORDSB(3*(J1-1)+2)-XBEST(3*(J1-1)+2))/BOXLY))**2
         IF (.NOT.TWOD) XDUMMY=XDUMMY+(COORDSB(3*(J1-1)+3)-XBEST(3*(J1-1)+3) - &
  &                                                             BOXLZ*NINT((COORDSB(3*(J1-1)+3)-XBEST(3*(J1-1)+3))/BOXLZ))**2
      ENDDO
   ELSE
      XDUMMY=0.0D0
      DO J1=1,NATOMS
         XBEST(3*(J1-1)+1:3*(J1-1)+3)=MATMUL(ROTINVBBEST,XBEST(3*(J1-1)+1:3*(J1-1)+3))
         XBEST(3*(J1-1)+1)=XBEST(3*(J1-1)+1)+CMBX
         XBEST(3*(J1-1)+2)=XBEST(3*(J1-1)+2)+CMBY
         XBEST(3*(J1-1)+3)=XBEST(3*(J1-1)+3)+CMBZ
         XDUMMY=XDUMMY+(COORDSB(3*(J1-1)+1)-XBEST(3*(J1-1)+1))**2+ &
  &                    (COORDSB(3*(J1-1)+2)-XBEST(3*(J1-1)+2))**2+ &
  &                    (COORDSB(3*(J1-1)+3)-XBEST(3*(J1-1)+3))**2
      ENDDO
   ENDIF
   IF (ABS(SQRT(XDUMMY)-SQRT(DISTANCE)).GT.GEOMDIFFTOL) THEN
      WRITE(MYUNIT,'(2(A,F20.10))') ' MINPERMDIST> ERROR *** DISTANCE BETWEEN TRANSFORMED XBEST AND COORDSB=',SQRT(XDUMMY), &
  &                         ' SHOULD BE ',SQRT(DISTANCE)
   ENDIF

   IF (NFREEZE.GT.0) THEN
      RMATBEST(1:3,1:3)=0.0D0
      RMATBEST(1,1)=1.0D0; RMATBEST(2,2)=1.0D0; RMATBEST(3,3)=1.0D0
   ELSE
      RMATBEST=MATMUL(ROTINVB,RMATBEST)
   ENDIF
   COORDSA(1:3*NATOMS)=XBEST(1:3*NATOMS) ! FINALLY, BEST COORDSA SHOULD INCLUDE PERMUTATIONS FOR DNEB INPUT!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!  DO J1=1,(NATOMS/2)
!     XDUMMY=XDUMMY+(COORDSB(3*(J1-1)+1)-COORDSA(3*(J1-1)+1))**2+ &
! &                 (COORDSB(3*(J1-1)+2)-COORDSA(3*(J1-1)+2))**2+ &
! &                 (COORDSB(3*(J1-1)+3)-COORDSA(3*(J1-1)+3))**2
!  ENDDO
!  PRINT '(A,F20.10)','XDUMMY=',XDUMMY
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

DISTANCE=SQRT(DISTANCE)

RETURN
END SUBROUTINE MINPERMDIST
