
C     --------------------- HFORCE.F ----------------------

       SUBROUTINE DSSP_HFORCE(H_CORD,NITCORD,IDX1,IDX2,R1,R2,POT,
     * FACTOR,LAMBDA_HB,SIGMANO,SIGMAH,PRO_CORD,F_CORD)
 
C     --------------------------------------------------

C     HDRGN FINDS THE  POTENTIAL DUE TO HYDROGEN BONDS 
C     BETWEEN N AND O     

C     ---------------------------------------------------

      USE AMHGLOBALS,  ONLY: MAXSIZ,MAXCRD,HO_ZERO,NO_ZERO

      IMPLICIT NONE

C     ARGUMENT DECLARATIONS:
          
       DOUBLE PRECISION  H_CORD(MAXSIZ,3),LAMBDA_HB,SIGMANO,
     *      SIGMAH,F_CORD(MAXSIZ,3,MAXCRD),PRO_CORD(MAXSIZ,3,MAXCRD)

C     INTERNAL VARIABLES:

         INTEGER IDX1,IDX2 
C        --- DO LOOP INDICES ---

         INTEGER I_AXIS 


         DOUBLE PRECISION  R1,FACTOR,POT,NITCORD(MAXSIZ,3),R2,
     *         DV_DRNO,DV_DRHO,DRNO_DO(3),DRNO_DN(3),DRHO_DO(3),DRHO_DH(3)

C     --------------------- BEGIN -----------------------

C WARNING: DO NOT ZERO F_CORD (THE FORCE) HERE AS DSSP_HDRGN IS COMPILING RUNNING TOTAL


C     FIND FORCE DUE TO HBONDS

        DV_DRNO = -LAMBDA_HB*POT*((R1 - NO_ZERO)/(SIGMANO**2))*FACTOR
        DV_DRHO = -LAMBDA_HB*POT*((R2 - HO_ZERO)/(SIGMAH**2))*FACTOR

        DO I_AXIS = 1,3
        
        DRNO_DO(I_AXIS) = 
     *  (PRO_CORD(IDX1,I_AXIS,3)-NITCORD(IDX2,I_AXIS)) /R1 

        DRNO_DN(I_AXIS) = 
     *  -(PRO_CORD(IDX1,I_AXIS,3)-NITCORD(IDX2,I_AXIS)) /R1 

        DRHO_DO(I_AXIS) =
     *  (PRO_CORD(IDX1,I_AXIS,3)-H_CORD(IDX2,I_AXIS))/R2

        DRHO_DH(I_AXIS) = 
     *  -(PRO_CORD(IDX1,I_AXIS,3)-H_CORD(IDX2,I_AXIS))/R2

C        APPLY FORCE

        F_CORD(IDX2,I_AXIS,1) = F_CORD(IDX2,I_AXIS,1) -
     *  DV_DRNO*DRNO_DN(I_AXIS)*0.7032820D0
        F_CORD(IDX2,I_AXIS,1) = F_CORD(IDX2,I_AXIS,1) -
     *  DV_DRHO*DRHO_DH(I_AXIS)*0.8929599D0

        F_CORD(IDX2-1,I_AXIS,1) = F_CORD(IDX2-1,I_AXIS,1) -     
     *  DV_DRNO*DRNO_DN(I_AXIS)*0.4831806D0   
        F_CORD(IDX2-1,I_AXIS,1) = F_CORD(IDX2-1,I_AXIS,1) -
     *  DV_DRHO*DRHO_DH(I_AXIS)*0.8409657D0

        F_CORD(IDX1,I_AXIS,3) = F_CORD(IDX1,I_AXIS,3) -     
     *  DV_DRNO*DRNO_DO(I_AXIS)   
        F_CORD(IDX1,I_AXIS,3) = F_CORD(IDX1,I_AXIS,3) -
     *  DV_DRHO*DRHO_DO(I_AXIS)

        F_CORD(IDX2-1,I_AXIS,3) = F_CORD(IDX2-1,I_AXIS,3) + 
     *  DV_DRNO*DRNO_DN(I_AXIS)*0.1864626D0   
        F_CORD(IDX2-1,I_AXIS,3) = F_CORD(IDX2-1,I_AXIS,3) +
     *  DV_DRHO*DRHO_DH(I_AXIS)*0.7338894D0

        ENDDO  ! I_AXIS        

C     ----------------------- DONE -----------------------

      RETURN
      END
