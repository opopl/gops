
C     --------------------- SHKDRV  ----------------------

      SUBROUTINE HARM_SPRING(PRCORD,JSTRT,JFINS,MAXPRO,MAXCRD, 
     *                         IRES,F_CORD_HARM,E_TEMP_HARM)

C     ---------------------------------------------------

C     HARM_SPRING DRIVER ROUTINE FOR PERFORMING HARD SPRINGS
C                 FOR MAINTAIN CHAIN CONNECTIVITY

C     ARGUMENTS:

C        MAXSIZ- MAXIMUM NUMBER OF PROTEIN RESIDUES (I)
C        PRCORD- NEW COORDINATES WHICH SATSIFY BOND 
C                LENGTHS (O)

C     ---------------------------------------------------

      USE AMHGLOBALS,  ONLY: MAXSIZ,E_HARM_SPRINGS
C      USE COMMONS,  ONLY: HARM_AMH

      IMPLICIT NONE

C     ARGUMENT DECLARATIONS:

         INTEGER JSTRT,JFINS,MAXPRO,MAXCRD,IRES(MAXSIZ), HARM_AMH
     
         DOUBLE PRECISION PRCORD(MAXSIZ,3,MAXPRO,MAXCRD),
     *     X_DIFF(MAXSIZ),Y_DIFF(MAXSIZ),Z_DIFF(MAXSIZ),
     *     F_CORD_HARM(MAXSIZ,MAXCRD,MAXCRD),CA_DIST(MAXSIZ),CA_CB_DIST(MAXSIZ),E_TEMP_HARM,CAF,
     *     R_DEV,CA_DISTANCE,CA_SPRING_SCL,CA_CB_DISTANCE,CA_CB_SPRING_SCL,
     *     CA_OX_DIST(MAXSIZ),CA_OX_DISTANCE,CA_OX_SPRING_SCL,
     *     OX_CAPLUS_DIST(MAXSIZ),OX_CAPLUS_DISTANCE,OX_CAPLUS_SPRING_SCL

C     INTERNAL VARIABLES:

C        --- DO LOOP INDICES ---

         INTEGER I507,I512

C        --- IMPLIED DO LOOP INDICES ---

C  FROM PTTARG.F   CA-CA+1     BONDLN(I505,1)=3.8004
C  FROM PTTARG.F   CB-CA       BONDLN(I505,2)=1.54
C  FROM SHAKOX.F   OX-CA       EQDIST(1)=2.42677
C  FROM SHAKOX.F   CA+1-OX     EQDIST(2)=2.82146

C CA-CA

C        WRITE(6,*)' SECCCCCCC' , HARM_AMH

        CA_SPRING_SCL=50.0D0
        CA_DISTANCE=3.8004D0       
        E_TEMP_HARM = 0.D0
        F_CORD_HARM=0.D0

           DO 507 I507=JSTRT,JFINS-1

           CAF=0.0D0

        X_DIFF(I507)=PRCORD(I507+1,1,1,1) - PRCORD(I507,1,1,1)
        Y_DIFF(I507)=PRCORD(I507+1,2,1,1) - PRCORD(I507,2,1,1)
        Z_DIFF(I507)=PRCORD(I507+1,3,1,1) - PRCORD(I507,3,1,1)

        CA_DIST(I507)=DSQRT(X_DIFF(I507)**2 + Y_DIFF(I507)**2 + Z_DIFF(I507)**2)

        R_DEV=CA_DIST(I507)-CA_DISTANCE

        E_TEMP_HARM =  E_TEMP_HARM +  CA_SPRING_SCL*R_DEV**2
        CAF=2.0D0*CA_SPRING_SCL*R_DEV/CA_DIST(I507)

        F_CORD_HARM(I507,1,1) = F_CORD_HARM(I507,1,1) + X_DIFF(I507)*CAF
        F_CORD_HARM(I507,2,1) = F_CORD_HARM(I507,2,1) + Y_DIFF(I507)*CAF
        F_CORD_HARM(I507,3,1) = F_CORD_HARM(I507,3,1) + Z_DIFF(I507)*CAF
        F_CORD_HARM(I507+1,1,1) = F_CORD_HARM(I507+1,1,1) - X_DIFF(I507)*CAF
        F_CORD_HARM(I507+1,2,1) = F_CORD_HARM(I507+1,2,1) - Y_DIFF(I507)*CAF
        F_CORD_HARM(I507+1,3,1) = F_CORD_HARM(I507+1,3,1) - Z_DIFF(I507)*CAF

 507         CONTINUE
           
C           WRITE(6,*)'CA CA ',E_TEMP_HARM

C        IF (MEMIRES(JTGRES).NE.8)THEN

          CA_CB_SPRING_SCL=50.0D0
          CA_CB_DISTANCE=1.54D0       

           DO 607 I507=JSTRT,JFINS
            IF (IRES(I507).NE.8)THEN 

           CAF=0.D0

          X_DIFF(I507)=PRCORD(I507,1,1,1) - PRCORD(I507,1,1,2)
          Y_DIFF(I507)=PRCORD(I507,2,1,1) - PRCORD(I507,2,1,2)
          Z_DIFF(I507)=PRCORD(I507,3,1,1) - PRCORD(I507,3,1,2)

            CA_CB_DIST(I507)=DSQRT(X_DIFF(I507)**2 + Y_DIFF(I507)**2 + Z_DIFF(I507)**2)

        R_DEV=CA_CB_DIST(I507)-CA_CB_DISTANCE

        E_TEMP_HARM = E_TEMP_HARM + CA_CB_SPRING_SCL*R_DEV**2
        CAF=2.0D0*CA_CB_SPRING_SCL*R_DEV/CA_CB_DIST(I507)

        F_CORD_HARM(I507,1,1) = F_CORD_HARM(I507,1,1) - X_DIFF(I507)*CAF
        F_CORD_HARM(I507,2,1) = F_CORD_HARM(I507,2,1) - Y_DIFF(I507)*CAF
        F_CORD_HARM(I507,3,1) = F_CORD_HARM(I507,3,1) - Z_DIFF(I507)*CAF
        F_CORD_HARM(I507,1,2) = F_CORD_HARM(I507,1,2) + X_DIFF(I507)*CAF
        F_CORD_HARM(I507,2,2) = F_CORD_HARM(I507,2,2) + Y_DIFF(I507)*CAF
        F_CORD_HARM(I507,3,2) = F_CORD_HARM(I507,3,2) + Z_DIFF(I507)*CAF

         ENDIF
!         WRITE(6,*)'HARMHARM ', R_DEV

 607         CONTINUE

C          WRITE(6,*)'CA CB E ',E_TEMP_HARM

C        WRITE(6,*)'CA CA DISTANCE ', CA_DIST(5),CA_DISTANCE 
C        WRITE(6,*)'CA CB DISTANCE ', CA_CB_DIST(5),CA_CB_DISTANCE 
C        WRITE(6,*)'E_TEMP_HARM ', E_TEMP_HARM

       CA_OX_SPRING_SCL=50.0D0
       CA_OX_DISTANCE= 2.42677D0  

C     SHAKE BETWEEN CA-OX
C  FROM SHAKOX.F   CA-OX       EQDIST(1)=2.42677

           DO 707 I507=JSTRT,JFINS

           CAF=0.0D0

          X_DIFF(I507)=PRCORD(I507,1,1,1) - PRCORD(I507,1,1,3)
          Y_DIFF(I507)=PRCORD(I507,2,1,1) - PRCORD(I507,2,1,3)
          Z_DIFF(I507)=PRCORD(I507,3,1,1) - PRCORD(I507,3,1,3)

            CA_OX_DIST(I507)=DSQRT(X_DIFF(I507)**2 + Y_DIFF(I507)**2 + Z_DIFF(I507)**2)

        R_DEV=CA_OX_DIST(I507)-CA_OX_DISTANCE

        E_TEMP_HARM =  E_TEMP_HARM +  CA_OX_SPRING_SCL*R_DEV**2
        CAF=2.0D0*CA_OX_SPRING_SCL*R_DEV/CA_OX_DIST(I507)

        F_CORD_HARM(I507,1,1) = F_CORD_HARM(I507,1,1) - X_DIFF(I507)*CAF
        F_CORD_HARM(I507,2,1) = F_CORD_HARM(I507,2,1) - Y_DIFF(I507)*CAF
        F_CORD_HARM(I507,3,1) = F_CORD_HARM(I507,3,1) - Z_DIFF(I507)*CAF
        F_CORD_HARM(I507,1,3) = F_CORD_HARM(I507,1,3) + X_DIFF(I507)*CAF
        F_CORD_HARM(I507,2,3) = F_CORD_HARM(I507,2,3) + Y_DIFF(I507)*CAF
        F_CORD_HARM(I507,3,3) = F_CORD_HARM(I507,3,3) + Z_DIFF(I507)*CAF

 707         CONTINUE

C         WRITE(6,*)'CA OX E ',E_TEMP_HARM


C     SHAKE BETWEEN CA-OX

          OX_CAPLUS_SPRING_SCL=50.0D0
          OX_CAPLUS_DISTANCE= 2.82146D0
    
C  FROM SHAKOX.F   CA-OX       EQDIST(1)=2.42677
C  FROM SHAKOX.F   OX-CA+1     EQDIST(2)=2.82146

           DO 807 I507=JSTRT,JFINS-1

           CAF=0.0D0

          X_DIFF(I507)=PRCORD(I507,1,1,3) - PRCORD(I507+1,1,1,1)
          Y_DIFF(I507)=PRCORD(I507,2,1,3) - PRCORD(I507+1,2,1,1)
          Z_DIFF(I507)=PRCORD(I507,3,1,3) - PRCORD(I507+1,3,1,1)

            OX_CAPLUS_DIST(I507)=DSQRT(X_DIFF(I507)**2 + Y_DIFF(I507)**2 + Z_DIFF(I507)**2)

        R_DEV=OX_CAPLUS_DIST(I507)-OX_CAPLUS_DISTANCE 

        E_TEMP_HARM =  E_TEMP_HARM +  OX_CAPLUS_SPRING_SCL*R_DEV**2
        CAF=2.0D0*OX_CAPLUS_SPRING_SCL*R_DEV/OX_CAPLUS_DIST(I507)

        F_CORD_HARM(I507,1,3) = F_CORD_HARM(I507,1,3) - X_DIFF(I507)*CAF
        F_CORD_HARM(I507,2,3) = F_CORD_HARM(I507,2,3) - Y_DIFF(I507)*CAF
        F_CORD_HARM(I507,3,3) = F_CORD_HARM(I507,3,3) - Z_DIFF(I507)*CAF
        F_CORD_HARM(I507+1,1,1) = F_CORD_HARM(I507+1,1,1) + X_DIFF(I507)*CAF
        F_CORD_HARM(I507+1,2,1) = F_CORD_HARM(I507+1,2,1) + Y_DIFF(I507)*CAF
        F_CORD_HARM(I507+1,3,1) = F_CORD_HARM(I507+1,3,1) + Z_DIFF(I507)*CAF

 807         CONTINUE

       E_HARM_SPRINGS =  E_TEMP_HARM

      RETURN
      END
