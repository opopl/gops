C   GMIN: A PROGRAM FOR FINDING GLOBAL MINIMA
C   COPYRIGHT (C) 1999-2006 DAVID J. WALES
C   THIS FILE IS PART OF GMIN.
C
C   GMIN IS FREE SOFTWARE; YOU CAN REDISTRIBUTE IT AND/OR MODIFY
C   IT UNDER THE TERMS OF THE GNU GENERAL PUBLIC LICENSE AS PUBLISHED BY
C   THE FREE SOFTWARE FOUNDATION; EITHER VERSION 2 OF THE LICENSE, OR
C   (AT YOUR OPTION) ANY LATER VERSION.
C
C   GMIN IS DISTRIBUTED IN THE HOPE THAT IT WILL BE USEFUL,
C   BUT WITHOUT ANY WARRANTY; WITHOUT EVEN THE IMPLIED WARRANTY OF
C   MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.  SEE THE
C   GNU GENERAL PUBLIC LICENSE FOR MORE DETAILS.
C
C   YOU SHOULD HAVE RECEIVED A COPY OF THE GNU GENERAL PUBLIC LICENSE
C   ALONG WITH THIS PROGRAM; IF NOT, WRITE TO THE FREE SOFTWARE
C   FOUNDATION, INC., 59 TEMPLE PLACE, SUITE 330, BOSTON, MA  02111-1307  USA
C
C   THIS PROGRAM IS SUPPOSED TO CALCULATE THE ENERGY, 
C   FIRST DERIVATIVES AND SECOND DERIVATIVES FOR SILICON 
C   CLUSTERS USING A TIGHT BINDING (TB) APPROXIMATION.  
C   THIS WILL THEN BE USED IN CONJUNCTION WITH OPTIM,
C   AS IT IS NOW KNOWN, TO SOLVE THE PROBLEMS OF THE UNIVERSE
C   AND IN PARTICULAR THOSE OF THE SILICON CLUSTER WORLD.
C   THE PARAMETERS ETC..ARE TAKEN FROM PRB 47 12754 1993
C   AND PRB 50 5645 1994 IN CASE YOU WERE WONDERING.

      SUBROUTINE FRAUSI(N,XS,DERIV1ST,ENERGY,GTEST,ANGSTROM,NATOMS)
      USE DISTANCE
      IMPLICIT NONE

      DOUBLE PRECISION EPSS,EPSP,C1, C2, C3, C4, C5,
     3                 C6, C7, C8, C9, C10,A1,B1,SSSSIG,SSPSIG,
     4                 SPPSIG,SPPPI,HSSSIG,HSPSIG,HPPSIG,HPPPI,
     5                 C11,C12, ANG2BOHR, H2EV, HBOHR2EVANG
 
      PARAMETER (EPSS=-0.3878175D0, EPSP=-0.166954D0,
     /     A1=1.0D0,B1=5.05D0,
     /     C1=20.9904791D0,C2=-18.6227459D0,
     /    C3=13.0417919D0, C4=-7.1832245D0, C5=3.0080981D0,
     /    C6=-0.8713337D0, C7=0.1321772D0, C8=-3.6D-06,
     /    C9=-4.5D-06, C10=1.71D-05,C11=-9.0D-06,C12=-2.17D-05,
     /    ANG2BOHR=1.889725989D0, H2EV=27.2113961D0, HBOHR2EVANG=51.4220824D0)

      INTEGER N,NATOMS
      DOUBLE PRECISION Q(NATOMS,NATOMS),DERIV1ST(3*NATOMS) 


      LOGICAL GTEST,ANGSTROM
      INTEGER I, J, K, AI, AJ, NDIM, NMAX, I2, J2, K2,  INFO
      DOUBLE PRECISION DIST(NATOMS,NATOMS),
     1                 WORK(24*NATOMS),
     2                 S(4*NATOMS,4*NATOMS),
     3                 ENERGY,XS(3*NATOMS),
     4                 H(4*NATOMS,4*NATOMS)
      DOUBLE PRECISION UREP,REP
      LOGICAL FTEST
      COMMON /FAIL/ FTEST
      ALLOCATE(R(NATOMS,NATOMS),DIRCOS(NATOMS,NATOMS,3),HORIG(4*NATOMS,4*NATOMS),DIAG(4*NATOMS))


      

C   CALCULATE DISTANCE MATRIX

      DO I=1,N
       I2=3*(I-1)
       R(I,I)=0.0D0
       DO J=I+1,N
            J2=3*(J-1)
            DIST(I,J)=(XS(I2+1)-XS(J2+1))**2+(XS(I2+2)-XS(J2+2))**2
     1                +(XS(I2+3)-XS(J2+3))**2
          R(I,J)=SQRT(DIST(I,J))

C   NOW THE DIRECTION COSINES
C   WHICH INCIDENTALLY ARE THE PROJECTIONS OF A UNIT VECTOR ONTO 
C   THE AXES AND NOT THE COSINES.
C   NOTE WE HAVE NOT CALCULATED DIRCOS(I,I)

            DO K=1,3
               DIRCOS(I,J,K)=(XS(J2+K)-XS(I2+K))/R(I,J)
               DIRCOS(J,I,K)=-DIRCOS(I,J,K)
               DIRCOS(I,I,K)=0.0D0
            END DO

C   CONVERT DISTANCE GIVEN IN ANGSTROMS TO BOHR
            IF (ANGSTROM) THEN
             R(I,J)=ANG2BOHR*R(I,J)
            END IF
             R(J,I)=R(I,J)
         END DO
      END DO 


C   CALCULATE REPULSIVE FREE ENERGY

      UREP=0.0D0
      DO I=1,N
         DO J=I+1,N

C CALCUALTIONS ARE IN BOHR
    
      Q(J,I)=(R(J,I)-((B1+A1)/2.0))/((B1-A1)/2.0)

      REP=C1 + C2*Q(J,I) + C3*(-1.0D0 + 2.0D0*Q(J,I)**2) + C4*(-3.0D0*Q(J,I) + 4.0D0*Q(J,I)**3) +
     /    C5*(1 -8.0D0*Q(J,I)**2 + 8.0D0*Q(J,I)**4) + C6*(5.0D0*Q(J,I) -20.0D0*Q(J,I)**3 + 16.0D0*Q(J,I)**5)
     /     + C7*(-1.0D0+18.0D0*Q(J,I)**2 -48.0D0*Q(J,I)**4 + 32.0D0*Q(J,I)**6)
     /   + C8*(-7.0D0*Q(J,I) + 56.0D0*Q(J,I)**3 - 112.0D0*Q(J,I)**5 + 64.0D0*Q(J,I)**7)
     /    + C9*(1.0D0 - 32.0D0*Q(J,I)**2 + 160.0D0*Q(J,I)**4 - 256.0D0*Q(J,I)**6
     /   +128.0D0*Q(J,I)**8) + C10*(9.0D0*Q(J,I) - 120.0D0*Q(J,I)**3 + 432.0D0*Q(J,I)**5
     /   - 576.0D0*Q(J,I)**7 + 256.0D0*Q(J,I)**9) 
     /    + C11*(-1.0D0 + 50.0D0*Q(J,I)**2 - 400.0D0*Q(J,I)**4 + 1120.0D0*Q(J,I)**6
     /    - 1280.0D0*Q(J,I)**8 + 512.0D0*Q(J,I)**10)
     /    + C12*(-11.0D0*Q(J,I) + 220.0D0*Q(J,I)**3 - 1232.0D0*Q(J,I)**5 + 2816.0D0*Q(J,I)**7
     /    - 2816.0D0*Q(J,I)**9 + 1024.0D0*Q(J,I)**11)
     /     - C1/2.0D0 

         IF (ABS(R(I,J)).GT.5.053328858168296D0) THEN
            REP=0.0D0
         ELSE
            REP=REP+0.00002119467638195263D0
         ENDIF

        UREP=REP+UREP

        ENDDO
      ENDDO

C10    FORMAT(A8, F20.17)

C   ONLY INCLUDE OVERLAP OR INTERACTION WITH DIFFERENT ATOMS HERE.
               
      DO I=1,N
         AI=4*(I-1)
C         AI2=2*AI
         DO J=I+1,N
            AJ=4*(J-1)

C   DEPENDENCE OF V ON DISTANCE BETWEEN ATOMS R(I,J)
C   SIMILARLY, S MUST SCALE WITH R(I,J)

C   CALCULATE THE OVERLAP MATRIX S(I,J), RELATED TO THESE PARAMETERS
C   BY THE SLATER-KOSTER SCHEME

           CALL OVERL(N,I,J,SSSSIG, SSPSIG, SPPSIG, SPPPI,NATOMS)


            S((AI+1),(AJ+1))=SSSSIG
            S((AI+1),(AJ+2))=DIRCOS(I,J,1)*SSPSIG
            S((AI+1),(AJ+3))=DIRCOS(I,J,2)*SSPSIG
            S((AI+1),(AJ+4))=DIRCOS(I,J,3)*SSPSIG

            S((AI+2),(AJ+1))=-S((AI+1),(AJ+2))
            S((AI+2),(AJ+2))=DIRCOS(I,J,1)**2*SPPSIG+(1.0D0-
     1                       DIRCOS(I,J,1)**2)*SPPPI
            S((AI+2),(AJ+3))=DIRCOS(I,J,1)*DIRCOS(I,J,2)*(SPPSIG
     1                       -SPPPI)
            S((AI+2),(AJ+4))=DIRCOS(I,J,1)*DIRCOS(I,J,3)*(SPPSIG
     1                       -SPPPI)

            S((AI+3),(AJ+1))=-S((AI+1),(AJ+3))
            S((AI+3),(AJ+2))=S((AI+2),(AJ+3))
            S((AI+3),(AJ+3))=DIRCOS(I,J,2)**2*SPPSIG+(1.0D0-
     1                       DIRCOS(I,J,2)**2)*SPPPI
            S((AI+3),(AJ+4))=DIRCOS(I,J,2)*DIRCOS(I,J,3)*(SPPSIG
     1                       -SPPPI)

            S((AI+4),(AJ+1))=-DIRCOS(I,J,3)*SSPSIG
            S((AI+4),(AJ+2))=S((AI+2),(AJ+4))
            S((AI+4),(AJ+3))=S((AI+3),(AJ+4))
            S((AI+4),(AJ+4))=DIRCOS(I,J,3)**2*SPPSIG+(1.0D0-
     1                       DIRCOS(I,J,3)**2)*SPPPI

            
C   HAMILTONIAN IS FOUND USING THE SLATER-KOSTER SCHEME
C   AS SHOWN IN THEIR PAPER AND HARRISON'S BOOK P.481
C   WHICH RELATES H TO THE PARAMETER V USING DIRECTION COSINES.
      
           CALL HAMIL(N,I,J,HSSSIG, HSPSIG, HPPSIG, HPPPI,NATOMS)


            H((AI+1),(AJ+1))=HSSSIG
            H((AI+1),(AJ+2))=DIRCOS(I,J,1)*HSPSIG
            H((AI+1),(AJ+3))=DIRCOS(I,J,2)*HSPSIG
            H((AI+1),(AJ+4))=DIRCOS(I,J,3)*HSPSIG

            H((AI+2),(AJ+1))=-H((AI+1),(AJ+2))
            H((AI+2),(AJ+2))=DIRCOS(I,J,1)**2*HPPSIG+(1.0D0-
     1           DIRCOS(I,J,1)**2)*HPPPI
            H((AI+2),(AJ+3))=DIRCOS(I,J,1)*DIRCOS(I,J,2)*(HPPSIG
     1           -HPPPI)
            H((AI+2),(AJ+4))=DIRCOS(I,J,1)*DIRCOS(I,J,3)*(HPPSIG
     1           -HPPPI)

            H((AI+3),(AJ+1))=-H((AI+1),(AJ+3))
            H((AI+3),(AJ+2))=H((AI+2),(AJ+3))
            H((AI+3),(AJ+3))=DIRCOS(I,J,2)**2*HPPSIG+(1.0D0-
     1           DIRCOS(I,J,2)**2)*HPPPI
            H((AI+3),(AJ+4))=DIRCOS(I,J,2)*DIRCOS(I,J,3)*(HPPSIG
     1           -HPPPI)

            H((AI+4),(AJ+1))=-DIRCOS(I,J,3)*HSPSIG
            H((AI+4),(AJ+2))=H((AI+2),(AJ+4))
            H((AI+4),(AJ+3))=H((AI+3),(AJ+4))
            H((AI+4),(AJ+4))=DIRCOS(I,J,3)**2*HPPSIG+(1.0D0-
     1           DIRCOS(I,J,3)**2)*HPPPI

       END DO

C   INTERACTION/OVERLAP OF DIFFERENT AOS ON THE SAME ATOM
         
          DO K=1,4
           DO K2=K+1,4
             S((AI+K),(AI+K2))=0.0D0
             H((AI+K),(AI+K2))=0.0D0
           END DO
          END DO

C   INTERACTION OF SAME AO ON THE SAME ATOM
       H((AI+1),(AI+1))=EPSS
        H((AI+2),(AI+2))=EPSP
        H((AI+3),(AI+3))=EPSP
        H((AI+4),(AI+4))=EPSP

      END DO

C   NOW WE HAVE TO MAKE SURE THE MATRIX S AND H ARE SYMMETRIC.
C   ERGO, HAVE TO GET THE UPPER DIAGONAL 'COS MUST HAVE COMPLETE
C   MATRIX FOR CHOLESKY DECOMPOSITION.
      
      DO I=1,4*N
        DO J=I+1,4*N
           S(J,I)=S(I,J)
           H(J,I)=H(I,J)
          END DO
    

C   INTERACTION/OVERLAP OF THE SAME AO ON THE SAME ATOM
         S(I,I)=1.0D0

      END DO

C50    FORMAT (10(5X,20F8.5,5X))
C50     FORMAT (10F8.4)

      DO I=1,4*N
         DO J=1,4*N
            HORIG(I,J)=H(I,J)
         END DO
      END DO


C      DO I=1,4*N
C        DO J=1,4*N
C           SORIG(I,J)=S(I,J)
C        END DO
C      END DO

      NDIM=4*N
      NMAX=4*NATOMS

      FTEST=.FALSE.

      CALL DSYGV( 1, 'V', 'U', NDIM, H, NMAX, S, NMAX, DIAG, WORK, 24*NATOMS, INFO )
C
C  THIS SORT ISN'T NEEDED FOR THE SGI LAPACK.F ROUTINE WHICH
C  INCORPORATES IT.
C
      CALL EIGSRT(DIAG,H,NDIM,NMAX)

 
      IF (INFO.NE.0) THEN
         FTEST=.TRUE.
         ENERGY=1.0D6
         PRINT*,'DSYGV FAILED - INFO=',INFO
         RETURN
      ENDIF

C      WRITE(6,*)
C      WRITE(6,*)  'THE EIGENVALUES OF THE HESSIAN MATRIX:'
C      DO I=1,4*N
C         WRITE(6,*)  DIAG(I)
C      END DO
C      WRITE(6,*)

      ENERGY=0.0D0

      DO J=4*N,(2*N+1),-1
         ENERGY=ENERGY+DIAG(J)
      END DO
C     WRITE(*,'(A,2F20.10)') 'HOMO AND LUMO AT ',DIAG(2*N+1),DIAG(2*N)

C   FOR SINGLE ATOM THERE SHOULD BE NO CONTRIBUTION FROM THE
C   BOND COUNTING TERM
C     WRITE(*,'(A,2F20.10)') 'ENERGY AND UREP=',2*ENERGY,UREP
      IF (N .EQ. 1) THEN
         ENERGY=2*ENERGY
      ELSE
          ENERGY=2*ENERGY+UREP
      END IF
C      WRITE(6,*)
C      WRITE(6,*) 'ENERGY=',ENERGY

C   NOW CALL THE ALL NEW ORIGINALLY CRAFTED SUBROUTINE TO CALCULATE
C   THE FIRST DERIVATIVES.
C   CONVERT R(I,J) FROM BOHR TO ANGSTROM AND ENERGY FROM HARTREE TO EV
C   DERIVS1ST SHOULD NOW BE IN EV/ANGSTROM AS RETURNED FROM SUBROUTINE.

      IF (GTEST) THEN
          CALL FRAUSIDER(N,DERIV1ST,H,ANGSTROM,NATOMS)
      END IF
      IF (ANGSTROM) THEN
      DO I=1,N
         DO J=1,N
             R(I,J)=R(I,J)/ANG2BOHR
         END DO
      END DO
      ENERGY=ENERGY*H2EV
      END IF

      RETURN
      END

C   
C  SUBROUTINE TO EXPAND THE POLYNOMIAL SUM FOR THE OVERLAP MATRIX ELEMENTS
C  THIS IS BETWEEN SAME ELEMENT....SAME ELEMENT/DIFF ELEMENT WILL BE MORE
C   

      SUBROUTINE OVERL(N,K,L,SSSS,SSPS,SPPS,SPPP,NATOMS)
      USE DISTANCE
      IMPLICIT NONE
      INTEGER  K,L,NATOMS

      INTEGER N
      DOUBLE PRECISION Q(NATOMS,NATOMS)

      DOUBLE PRECISION SSSS,SSPS,SPPS,SPPP,
     /     D1,D2,D3,
     7     D4,D5,D6,D7,D8,D9,D10,D11,D12,D13,D14,D15,D16,D17,D18,D19,D20,
     8     D21,D22,D23,D24,D25,D26,D27,D28,D29,D30,D31,D32,D33,D34,D35,D36,
     9     D37,D38,D39,D40,A3,B3,D41,D42,D43,D44,D45,D46,D47,D48

      PARAMETER ( D1=0.3942975, D2=-0.3092186, D3=0.1395490,
     /     D4=-0.0176746, D5=-0.0169834,
     /    D6=8.3055D-03,D7=1.4080D-03,D8=-2.9477D-03,D9=1.3781D-03,
     /    D10=-2.380D-04, D11=-7.16D-05,D12=5.26D-05,
     /    D13=-0.3568323,D14=0.2467967,D15=-0.0456893,
     /    D16=-0.0605347,D17=0.0497093,D18=-0.0102684,
     /    D19=-6.4619D-03,D20=5.4908D-03,D21=-1.6044D-03,
     /    D22=-1.030D-04,D23=2.934D-04,D24=-1.581D-04,
     /    D25=-0.1400088,D26=0.0192343,D27=0.1646371,
     /    D28=-0.181142,D29=0.0754221,D30=3.0624D-03,
     /    D31=-0.0183958,D32=8.7078D-03,D33=-1.1229D-03,
     /    D34=-8.468D-04,D35=5.924D-04,D36=-1.579D-04,
     /    D37=0.3722275,D38=-0.3063175,D39=0.1654376,
     /    D40=-0.0484825,D41=-2.4093D-03,D42=9.0576D-03,
     /    D43=-3.7347D-03,D44=3.162D-04,D45=3.926D-04,
     /    D46=-2.436D-04,D47=7.48D-05,D48=1.01D-05)

       A3=1.5D0
       B3=9.5D0
       Q(K,L)=(R(K,L)-((B3+A3)/2.0D0))/((B3-A3)/2.0D0)

C       PRINT*,'R OF IJ IN OVERL IS',R(K,L)

C  SSSSIG
      SSSS=D1 + D2*Q(K,L) + D3*(-1.0D0 + 2.0D0*Q(K,L)**2) 
     /    + D4*(-3.0D0*Q(K,L) + 4.0D0*Q(K,L)**3) +
     /    D5*(1 -8.0D0*Q(K,L)**2 + 8.0D0*Q(K,L)**4) 
     /    + D6*(5.0D0*Q(K,L) -20.0D0*Q(K,L)**3 + 16.0D0*Q(K,L)**5)
     /     + D7*(-1.0D0+18.0D0*Q(K,L)**2 -48.0D0*Q(K,L)**4 + 32.0D0*Q(K,L)**6)
     /   + D8*(-7.0D0*Q(K,L) + 56.0D0*Q(K,L)**3 - 112.0D0*Q(K,L)**5 + 64.0D0*Q(K,L)**7)
     /    + D9*(1.0D0 - 32.0D0*Q(K,L)**2 + 160.0D0*Q(K,L)**4 - 256.0D0*Q(K,L)**6
     /   +128.0D0*Q(K,L)**8) + D10*(9.0D0*Q(K,L) - 120.0D0*Q(K,L)**3 + 432.0D0*Q(K,L)**5
     /   - 576.0D0*Q(K,L)**7 + 256.0D0*Q(K,L)**9)
     /   +D11*(-1.0D0 + 50.0D0*Q(K,L)**2 - 400.0D0*Q(K,L)**4 + 1120.0D0*Q(K,L)**6
     /    - 1280.0D0*Q(K,L)**8 + 512.0D0*Q(K,L)**10)
     /   +D12*(-11.0D0*Q(K,L) + 220.0D0*Q(K,L)**3 - 1232.0D0*Q(K,L)**5 + 2816.0D0*Q(K,L)**7
     /    - 2816.0D0*Q(K,L)**9 + 1024.0D0*Q(K,L)**11)
     /    - D1/2.0D0

      IF (R(K,L).GT.9.489340860704047D0) THEN
         SSSS=0.0D0
      ELSE
         SSSS=SSSS-0.0007078111506558793D0
      ENDIF

C   SSPSIG
      SSPS=D13 + D14*Q(K,L) + D15*(-1.0D0 + 2.0D0*Q(K,L)**2)
     /    + D16*(-3.0D0*Q(K,L) + 4.0D0*Q(K,L)**3) +
     /    D17*(1 -8.0D0*Q(K,L)**2 + 8.0D0*Q(K,L)**4)
     /    + D18*(5.0D0*Q(K,L) -20.0D0*Q(K,L)**3 + 16.0D0*Q(K,L)**5)
     /     + D19*(-1.0D0+18.0D0*Q(K,L)**2 -48.0D0*Q(K,L)**4 + 32.0D0*Q(K,L)**6)
     /   + D20*(-7.0D0*Q(K,L) + 56.0D0*Q(K,L)**3 - 112.0D0*Q(K,L)**5 + 64.0D0*Q(K,L)**7)
     /    + D21*(1.0D0 - 32.0D0*Q(K,L)**2 + 160.0D0*Q(K,L)**4 - 256.0D0*Q(K,L)**6
     /   +128.0D0*Q(K,L)**8) 
     /    + D22*(9.0D0*Q(K,L) - 120.0D0*Q(K,L)**3 + 432.0D0*Q(K,L)**5
     /   - 576.0D0*Q(K,L)**7 + 256.0D0*Q(K,L)**9) 
     /   +D23*(-1.0D0 + 50.0D0*Q(K,L)**2 - 400.0D0*Q(K,L)**4 + 1120.0D0*Q(K,L)**6
     /    - 1280.0D0*Q(K,L)**8 + 512.0D0*Q(K,L)**10)
     /   +D24*(-11.0D0*Q(K,L) + 220.0D0*Q(K,L)**3 - 1232.0D0*Q(K,L)**5 + 2816.0D0*Q(K,L)**7
     /    - 2816.0D0*Q(K,L)**9 + 1024.0D0*Q(K,L)**11)
     /    - D13/2.0D0

      IF (R(K,L).GT.9.360442319381175D0) THEN
         SSPS=0.0D0
      ELSE
         SSPS=SSPS+0.0008518797271876711D0
      ENDIF

C SPPSIG
      SPPS=D25 + D26*Q(K,L) + D27*(-1.0D0 + 2.0D0*Q(K,L)**2)        
     /    + D28*(-3.0D0*Q(K,L) + 4.0D0*Q(K,L)**3) +
     /    D29*(1 -8.0D0*Q(K,L)**2 + 8.0D0*Q(K,L)**4)
     /    + D30*(5.0D0*Q(K,L) -20.0D0*Q(K,L)**3 + 16.0D0*Q(K,L)**5)
     /     + D31*(-1.0D0+18.0D0*Q(K,L)**2 -48.0D0*Q(K,L)**4 + 32.0D0*Q(K,L)**6)
     /   + D32*(-7.0D0*Q(K,L) + 56.0D0*Q(K,L)**3 - 112.0D0*Q(K,L)**5 + 64.0D0*Q(K,L)**7)
     /    + D33*(1.0D0 - 32.0D0*Q(K,L)**2 + 160.0D0*Q(K,L)**4 - 256.0D0*Q(K,L)**6
     /   +128.0D0*Q(K,L)**8) + D34*(9.0D0*Q(K,L) - 120.0D0*Q(K,L)**3 + 432.0D0*Q(K,L)**5
     /   - 576.0D0*Q(K,L)**7 + 256.0D0*Q(K,L)**9)
     /   +D35*(-1.0D0 + 50.0D0*Q(K,L)**2 - 400.0D0*Q(K,L)**4 + 1120.0D0*Q(K,L)**6
     /    - 1280.0D0*Q(K,L)**8 + 512.0D0*Q(K,L)**10)
     /   +D36*(-11.0D0*Q(K,L) + 220.0D0*Q(K,L)**3 - 1232.0D0*Q(K,L)**5 + 2816.0D0*Q(K,L)**7
     /    - 2816.0D0*Q(K,L)**9 + 1024.0D0*Q(K,L)**11)
     /      - D25/2.0D0

      IF (R(K,L).GT.9.096495577461203D0) THEN
         SPPS=0.0D0
      ELSE
         SPPS=SPPS-0.0002134373553017432D0
      ENDIF

C   SPPPI
      SPPP=D37 + D38*Q(K,L) + D39*(-1.0D0 + 2.0D0*Q(K,L)**2)        
     /    + D40*(-3.0D0*Q(K,L) + 4.0D0*Q(K,L)**3) +
     /    D41*(1 -8.0D0*Q(K,L)**2 + 8.0D0*Q(K,L)**4)
     /    + D42*(5.0D0*Q(K,L) -20.0D0*Q(K,L)**3 + 16.0D0*Q(K,L)**5)
     /     + D43*(-1.0D0+18.0D0*Q(K,L)**2 -48.0D0*Q(K,L)**4 + 32.0D0*Q(K,L)**6)
     /   + D44*(-7.0D0*Q(K,L) + 56.0D0*Q(K,L)**3 - 112.0D0*Q(K,L)**5 + 64.0D0*Q(K,L)**7)
     /    + D45*(1.0D0 - 32.0D0*Q(K,L)**2 + 160.0D0*Q(K,L)**4 - 256.0D0*Q(K,L)**6
     /   +128.0D0*Q(K,L)**8) + D46*(9.0D0*Q(K,L) - 120.0D0*Q(K,L)**3 + 432.0D0*Q(K,L)**5
     /   - 576.0D0*Q(K,L)**7 + 256.0D0*Q(K,L)**9)
     /   +D47*(-1.0D0 + 50.0D0*Q(K,L)**2 - 400.0D0*Q(K,L)**4 + 1120.0D0*Q(K,L)**6
     /    - 1280.0D0*Q(K,L)**8 + 512.0D0*Q(K,L)**10)
     /   +D48*(-11.0D0*Q(K,L) + 220.0D0*Q(K,L)**3 - 1232.0D0*Q(K,L)**5 + 2816.0D0*Q(K,L)**7
     /    - 2816.0D0*Q(K,L)**9 + 1024.0D0*Q(K,L)**11)
     /    - D37/2.0D0

      IF (R(K,L).GT.9.358643583694771D0) THEN
         SPPP=0.0D0
      ELSE
         SPPP=SPPP-0.0001838066680916461D0
      ENDIF

      RETURN
      END
C   
C  SUBROUTINE TO EXPAND THE POLYNOMIAL SUM FOR THE OVERLAP MATRIX ELEMENTS
C  THIS IS BETWEEN SAME ELEMENT....SAME ELEMENT/DIFF ELEMENT WILL BE MORE
C   

      SUBROUTINE HAMIL(N,K,L,SSSS,SSPS,SPPS,SPPP,NATOMS)
      USE DISTANCE
      IMPLICIT NONE
      INTEGER  K,L,NATOMS

      INTEGER N
      DOUBLE PRECISION Q(NATOMS,NATOMS)

      DOUBLE PRECISION SSSS,SSPS,SPPS,SPPP,
     /     G1,G2,G3,
     7     G4,G5,G6,G7,G8,G9,G10,G11,G12,G13,G14,G15,G16,G17,G18,G19,G20,
     8     G21,G22,G23,G24,G25,G26,G27,G28,G29,G30,G31,G32,G33,G34,G35,G36,
     9     G37,G38,G39,G40,A2,B2,G41,G42,G43,G44,G45,G46,G47,G48

C    /    G13=0.1777735,G14=-0.1094317,G15=-0.0071041,
C  NEEDED TO ADJUST G14 SINCE THE FUNCTION DOESN'T ACTUALLY HAVE A TURNING
C  POINT AROUND THE CUTOFF REGION OTHERWISE!
C
C
C    /    G25=0.0510829,G26=0.0092781,G27=-0.0894841,
C  NEEDED TO ADJUST G26 SINCE THE FUNCTION DOESN'T ACTUALLY HAVE A TURNING
C  POINT AROUND THE CUTOFF REGION OTHERWISE!
C
       PARAMETER (G1=-0.2601372,G2=0.1958030,G3=-0.0716540,
     /    G4=-0.0084811,G5=0.0229926,G6=-9.8866D-03,
     /    G7=-8.281D-04,G8=3.5950D-03,G9=-2.6770D-03,
     /    G10=1.3587D-03,G11=-5.617D-04,G12=2.165D-04,
     /    G13=0.1777735,G14=-0.1082,G15=-0.0071041,
     /    G16=0.0557698,G17=-0.0376445,G18=0.0088910,
     /    G19=0.0041357,G20=-0.0052914,G21=0.0031425,
     /    G22=-0.0014231,G23=5.843D-04,G24=-2.103D-04,
     /    G25=0.0510829,G26=0.0145,G27=-0.0894841,
     /    G28=0.0856069,G29=-0.0355870,G30=1.3150D-03,
     /    G31=7.8269D-03,G32=-6.1665D-03,G33=3.2455D-03,
     /    G34=-1.4904D-03,G35=6.809D-04,G36=-2.655D-04,
     /    G37=-0.1737379,G38=0.1403235,G39=-0.0716452,
     /    G40=0.0185100,G41=0.0027857, G42=-5.0867D-03,
     /    G43=2.5525D-03, G44=-6.749D-04, G45=-2.12D-05,
     /    G46=1.537D-04, G47=-1.269D-04, G48=7.84D-05 )

       A2=1.5D0
       B2=9.5D0
       Q(K,L)=(R(K,L)-((B2+A2)/2.0D0))/((B2-A2)/2.0D0)

C  SSSSIG
      SSSS=G1 + G2*Q(K,L) + G3*(-1.0D0 + 2.0D0*Q(K,L)**2) 
     /    + G4*(-3.0D0*Q(K,L) + 4.0D0*Q(K,L)**3) +
     /    G5*(1 -8.0D0*Q(K,L)**2 + 8.0D0*Q(K,L)**4) 
     /    + G6*(5.0D0*Q(K,L) -20.0D0*Q(K,L)**3 + 16.0D0*Q(K,L)**5)
     /     + G7*(-1.0D0+18.0D0*Q(K,L)**2 -48.0D0*Q(K,L)**4 + 32.0D0*Q(K,L)**6)
     /   + G8*(-7.0D0*Q(K,L) + 56.0D0*Q(K,L)**3 - 112.0D0*Q(K,L)**5 + 64.0D0*Q(K,L)**7)
     /    + G9*(1.0D0 - 32.0D0*Q(K,L)**2 + 160.0D0*Q(K,L)**4 - 256.0D0*Q(K,L)**6
     /   +128.0D0*Q(K,L)**8) + G10*(9.0D0*Q(K,L) - 120.0D0*Q(K,L)**3 + 432.0D0*Q(K,L)**5
     /   - 576.0D0*Q(K,L)**7 + 256.0D0*Q(K,L)**9)
     /   +G11*(-1.0D0 + 50.0D0*Q(K,L)**2 - 400.0D0*Q(K,L)**4 + 1120.0D0*Q(K,L)**6
     /    - 1280.0D0*Q(K,L)**8 + 512.0D0*Q(K,L)**10)
     /   +G12*(-11.0D0*Q(K,L) + 220.0D0*Q(K,L)**3 - 1232.0D0*Q(K,L)**5 + 2816.0D0*Q(K,L)**7
     /    - 2816.0D0*Q(K,L)**9 + 1024.0D0*Q(K,L)**11)
     /    - G1/2.0D0

         IF (R(K,L).GT.9.074040365621258D0) THEN
            SSSS=0.0D0
         ELSE
            SSSS=SSSS+0.0002808028388218697D0
         ENDIF

C   SSPSIG
      SSPS=G13 + G14*Q(K,L) + G15*(-1.0D0 + 2.0D0*Q(K,L)**2)
     /    + G16*(-3.0D0*Q(K,L) + 4.0D0*Q(K,L)**3) +
     /    G17*(1 -8.0D0*Q(K,L)**2 + 8.0D0*Q(K,L)**4)
     /    + G18*(5.0D0*Q(K,L) -20.0D0*Q(K,L)**3 + 16.0D0*Q(K,L)**5)
     /     + G19*(-1.0D0+18.0D0*Q(K,L)**2 -48.0D0*Q(K,L)**4 + 32.0D0*Q(K,L)**6)
     /   + G20*(-7.0D0*Q(K,L) + 56.0D0*Q(K,L)**3 - 112.0D0*Q(K,L)**5 + 64.0D0*Q(K,L)**7)
     /    + G21*(1.0D0 - 32.0D0*Q(K,L)**2 + 160.0D0*Q(K,L)**4 - 256.0D0*Q(K,L)**6
     /   +128.0D0*Q(K,L)**8) 
     /    + G22*(9.0D0*Q(K,L) - 120.0D0*Q(K,L)**3 + 432.0D0*Q(K,L)**5
     /   - 576.0D0*Q(K,L)**7 + 256.0D0*Q(K,L)**9) 
     /   +G23*(-1.0D0 + 50.0D0*Q(K,L)**2 - 400.0D0*Q(K,L)**4 + 1120.0D0*Q(K,L)**6
     /    - 1280.0D0*Q(K,L)**8 + 512.0D0*Q(K,L)**10)
     /   +G24*(-11.0D0*Q(K,L) + 220.0D0*Q(K,L)**3 - 1232.0D0*Q(K,L)**5 + 2816.0D0*Q(K,L)**7
     /    - 2816.0D0*Q(K,L)**9 + 1024.0D0*Q(K,L)**11)
     /    - G13/2.0D0
       IF (R(K,L).GT.9.246570341781329D0) THEN
          SSPS=0.0D0
       ELSE
          SSPS=SSPS-0.00164172705840912D0
       ENDIF

C SPPSIG
      SPPS=G25 + G26*Q(K,L) + G27*(-1.0D0 + 2.0D0*Q(K,L)**2)
     /    + G28*(-3.0D0*Q(K,L) + 4.0D0*Q(K,L)**3) +
     /    G29*(1 -8.0D0*Q(K,L)**2 + 8.0D0*Q(K,L)**4)
     /    + G30*(5.0D0*Q(K,L) -20.0D0*Q(K,L)**3 + 16.0D0*Q(K,L)**5)
     /     + G31*(-1.0D0+18.0D0*Q(K,L)**2 -48.0D0*Q(K,L)**4 + 32.0D0*Q(K,L)**6)
     /   + G32*(-7.0D0*Q(K,L) + 56.0D0*Q(K,L)**3 - 112.0D0*Q(K,L)**5 + 64.0D0*Q(K,L)**7)
     /    + G33*(1.0D0 - 32.0D0*Q(K,L)**2 + 160.0D0*Q(K,L)**4 - 256.0D0*Q(K,L)**6
     /   +128.0D0*Q(K,L)**8) + G34*(9.0D0*Q(K,L) - 120.0D0*Q(K,L)**3 + 432.0D0*Q(K,L)**5
     /   - 576.0D0*Q(K,L)**7 + 256.0D0*Q(K,L)**9)
     /   +G35*(-1.0D0 + 50.0D0*Q(K,L)**2 - 400.0D0*Q(K,L)**4 + 1120.0D0*Q(K,L)**6
     /    - 1280.0D0*Q(K,L)**8 + 512.0D0*Q(K,L)**10)
     /   +G36*(-11.0D0*Q(K,L) + 220.0D0*Q(K,L)**3 - 1232.0D0*Q(K,L)**5 + 2816.0D0*Q(K,L)**7
     /    - 2816.0D0*Q(K,L)**9 + 1024.0D0*Q(K,L)**11)
     /      - G25/2.0D0
       IF (R(K,L).GT.9.273572893686612D0) THEN
          SPPS=0.0D0
       ELSE
          SPPS=SPPS-0.005828116913694732D0
       ENDIF


C   SPPPI
      SPPP=G37 + G38*Q(K,L) + G39*(-1.0D0 + 2.0D0*Q(K,L)**2)        
     /    + G40*(-3.0D0*Q(K,L) + 4.0D0*Q(K,L)**3) +
     /    G41*(1 -8.0D0*Q(K,L)**2 + 8.0D0*Q(K,L)**4)
     /    + G42*(5.0D0*Q(K,L) -20.0D0*Q(K,L)**3 + 16.0D0*Q(K,L)**5)
     /     + G43*(-1.0D0+18.0D0*Q(K,L)**2 -48.0D0*Q(K,L)**4 + 32.0D0*Q(K,L)**6)
     /   + G44*(-7.0D0*Q(K,L) + 56.0D0*Q(K,L)**3 - 112.0D0*Q(K,L)**5 + 64.0D0*Q(K,L)**7)
     /    + G45*(1.0D0 - 32.0D0*Q(K,L)**2 + 160.0D0*Q(K,L)**4 - 256.0D0*Q(K,L)**6
     /   +128.0D0*Q(K,L)**8) + G46*(9.0D0*Q(K,L) - 120.0D0*Q(K,L)**3 + 432.0D0*Q(K,L)**5
     /   - 576.0D0*Q(K,L)**7 + 256.0D0*Q(K,L)**9)
     /   +G47*(-1.0D0 + 50.0D0*Q(K,L)**2 - 400.0D0*Q(K,L)**4 + 1120.0D0*Q(K,L)**6
     /    - 1280.0D0*Q(K,L)**8 + 512.0D0*Q(K,L)**10)
     /   +G48*(-11.0D0*Q(K,L) + 220.0D0*Q(K,L)**3 - 1232.0D0*Q(K,L)**5 + 2816.0D0*Q(K,L)**7
     /    - 2816.0D0*Q(K,L)**9 + 1024.0D0*Q(K,L)**11)
     /    - G37/2.0D0

       IF (R(K,L).GT.9.10748558948335D0) THEN
          SPPP=0.0D0
       ELSE
          SPPP=SPPP+0.00009727014254751198D0
       ENDIF

      RETURN
      END
C   THIS IS PHASE TWO WHERE WE CALCULATE THE FIRST DERIVATIVES
C   OF THE SILICON POTENTIAL CODED IN TB.SI.F. IT IS IN TIGHT
C   BINDING PARAMETERISED FORM.
C   OFF I GO...
C   THIS IS DERIVS1.F.JLOOP.BETTERISH IN THE RESRVES DIRECTORY
C   FOR THE RECORD

      SUBROUTINE FRAUSIDER(N,DERIV1ST,EIGVEC,ANGSTROM,NATOMS)
      USE DISTANCE
      IMPLICIT NONE 

      DOUBLE PRECISION EPSS,EPSP,C1, C2, C3, C4, C5,
     3                 C6, C7, C8, C9, C10,A1,B1,SSSSIG,SSPSIG,
     4                 SPPSIG,SPPPI,HSSSIG,HSPSIG,HPPSIG,HPPPI,
     5                 C11,C12, ANG2BOHR, H2EV, HBOHR2EVANG
 
      PARAMETER (EPSS=-0.3878175D0, EPSP=-0.166954D0,
     /     A1=1.0D0,B1=5.05D0,
     /     C1=20.9904791D0,C2=-18.6227459D0,
     /    C3=13.0417919D0, C4=-7.1832245D0, C5=3.0080981D0,
     /    C6=-0.8713337D0, C7=0.1321772D0, C8=-3.6D-06,
     /    C9=-4.5D-06, C10=1.71D-05,C11=-9.0D-06,C12=-2.17D-05,
     /    ANG2BOHR=1.889725989D0, H2EV=27.2113961D0, HBOHR2EVANG=51.4220824D0)

      INTEGER N,NATOMS
      DOUBLE PRECISION Q(NATOMS,NATOMS),DERIV1ST(3*NATOMS)

      INTEGER I, J, K , AI, AJ, LEV, NUM1, NUM2, 
     1        I2,J2
      DOUBLE PRECISION REP1ST(NATOMS,3),RR, D1, D2, D3,
     1                 ELEC1ST(NATOMS,3), E1, E2, DUMMY, E3,
     2                 DIFFSV(2,4,4), SDC1, SQC1, SQC2, SQC3,
     3                 R1ST(NATOMS,NATOMS),EIGVEC(4*NATOMS,4*NATOMS),
     4                 UREP1ST
      DOUBLE PRECISION SVSUB,
     1                 SQDIRCOS(3*NATOMS,NATOMS),SUBDIRCOS(3*NATOMS,NATOMS),
     2                 DELD1, DELD12, DELD2, DELD22, DELD3, DELD32, DELRDX,DRSSS,DRSSP,
     3                 DRSPPS,DRSPPP,DQDR,DSVSUB
      LOGICAL ANGSTROM


C
C  TAKE THE TRANSPOSE OF EIGVEC - MAKES LOOPS MORE EFFICIENT
C
      DO J=1,4*N
         DO I=J+1,4*N
            DUMMY=EIGVEC(J,I)
            EIGVEC(J,I)=EIGVEC(I,J)
            EIGVEC(I,J)=DUMMY
         ENDDO
      ENDDO
C
C   CAN PUT ARRAYS INTO A BLOCK DATA FORMAT INSTEAD OF PARAMETER
C   SO CAN JUST PUT IN ONCE IN A FILE TO BE INCLUDED

C   CAN'T START AN ARRAY WITH A NO. IE. 1STDERIV...SYNTAX ERROR

C   FIRST OF ALL CALCULATE DERIVATIVES OF REPULSIVE ENERGY TERM
C   THIS IS CALLED REP1ST.

      DQDR=1.0D0/((B1-A1)/2.0D0)

      DO K=1,3
         DO I=1,N
            DO J=I+1,N

      Q(J,I)=(R(J,I)-((B1+A1)/2.0))/((B1-A1)/2.0)

       
         UREP1ST=C2*DQDR + C3*4.0D0*Q(J,I)*DQDR
     /   +C4*(-3.0D0*DQDR + 12.0D0*(Q(J,I)**2)*DQDR)
     /   + C5*(-16.0D0*Q(J,I)*DQDR + 32.0D0*(Q(J,I)**3)*DQDR) +C6*(5.0D0*DQDR -60.0D0*(Q(J,I)**2)*DQDR
     /   + 80.0D0*(Q(J,I)**4)*DQDR) +C7*(36.0D0*Q(J,I)*DQDR - 192.0D0*(Q(J,I)**3)*DQDR +192.0D0*(Q(J,I)**5)*DQDR)
     /   +C8*(-7.0D0*DQDR +168.0D0*(Q(J,I)**2)*DQDR - 560.0D0*(Q(J,I)**4)*DQDR +448.0D0*(Q(J,I)**6)*DQDR)
     /   +C9*(-64.0D0*Q(J,I)*DQDR +640.0D0*(Q(J,I)**3)*DQDR -1536.0D0*(Q(J,I)**5)*DQDR +1024.0D0*(Q(J,I)**7)*DQDR)
     /   + C10*(9.0D0*DQDR -360.0D0*(Q(J,I)**2)*DQDR +2160*(Q(J,I)**4)*DQDR
     /   -4032.0D0*(Q(J,I)**6)*DQDR +2304.0D0*(Q(J,I)**8)*DQDR)
     /   +C11*(100.0D0*Q(J,I)*DQDR - 1600*(Q(J,I)**3)*DQDR + 6720*(Q(J,I)**5)*DQDR - 10240*(Q(J,I)**7)*DQDR
     /       +5120*(Q(J,I)**9)*DQDR)
     /   +C12*(-11.0D0*DQDR + 660.0D0*(Q(J,I)**2)*DQDR - 6160*(Q(J,I)**4)*DQDR +19712*(Q(J,I)**6)*DQDR
     /   -25344*(Q(J,I)**8)*DQDR + 11264*(Q(J,I)**10)*DQDR)


C           IF (ABS(R(J,I)).GT.B1) UREP1ST=0.0D0
            IF (ABS(R(I,J)).GT.5.053328858168296D0) THEN
               UREP1ST=0.0D0
            ENDIF

               R1ST(J,I)=-DIRCOS(I,J,K)*UREP1ST
               R1ST(I,J)=-R1ST(J,I)

            END DO

            R1ST(I,I)=0.0D0
            D1=0.0D0
            DO J=1,N
              D1=D1+R1ST(J,I)
            END DO

            REP1ST(I,K)=D1
         END DO
      END DO

C   CO=1,2 OR 3 REPRESENTS THE X,Y OR Z COORDINATE AND THUS DIFFERENTIATION
C   THAT COORDINATE. CRIPES, I HOPE MY WORK IS MORE COMPACT THAN MY COMMENT
C   STATEMENTS.
      DO I=1,N
        DO J=I+1,N
           J2=3*(J-1)

               DO NUM1=1,3
                  SQDIRCOS(J2+NUM1,I)=DIRCOS(J,I,NUM1)**2
                  SUBDIRCOS(J2+NUM1,I)=SQDIRCOS(J2+NUM1,I)-1.0D0
               END DO

        END DO
        END DO



C        PRINT*,'ENTERING THE DIFFERENTIATION OF ELECTRONIC ENERGY ZONE'
        DO K=1,N
          ELEC1ST(K,1)=0.0D0
        ENDDO

        DO I=1,N
         AI=4*(I-1)

C   DIFF OF INTERACTIONS OF AOS ON SAME ATOM
C   DON'T NEED TO INCLUDE FOR DIFFSV SINCE NOT USED - LOOP
C   IS ONLY FOR J=I+1,N

         DO J=I+1,N
           RR=1.0D0/R(J,I)
           AJ=4*(J-1)
           J2=3*(J-1)

C   A GOOD IDEA APPEARS TO BE SIMPLIFY THE EXPRESSIONS IN THE
C   DIFFERENTIATING SECTION AND REDUCE THE NUMBER OF INDICES


           D1=DIRCOS(J,I,1)
           D2=DIRCOS(J,I,2)
           D3=DIRCOS(J,I,3)

           SDC1=SUBDIRCOS(J2+1,I)
C           SDC2=SUBDIRCOS(J2+2,I)
C           SDC3=SUBDIRCOS(J2+3,I)
           SQC1=SQDIRCOS(J2+1,I)
           SQC2=SQDIRCOS(J2+2,I)
           SQC3=SQDIRCOS(J2+3,I)


C   DIFFSV(DIFF. OF S OR V,AO NO.,AO NO.)

C   DIFFERENTIATION OF OVERLAP OR INTERACTION BETWEEN ORBITALS
C   ON DIFFERENT ATOMS

C               DO SV=1,2
              DELD1=RR*SDC1
              DELD12=-2*RR*D1*SDC1
              DELD2=D2*D1*RR
              DELD22=-2*SQC2*D1*RR
              DELD3=D3*D1*RR
              DELD32=-2*SQC3*D1*RR
              DELRDX=D1

               
C           IF (SV.EQ.1) THEN

           CALL OVERL(N,I,J,SSSSIG, SSPSIG, SPPSIG, SPPPI,NATOMS)

           CALL DEROV(N,I,J,DRSSS,DRSSP,DRSPPS,DRSPPP,NATOMS)

             SVSUB=SPPSIG - SPPPI
             DSVSUB=DRSPPS - DRSPPP

                  DIFFSV(1,1,1)=DRSSS*DELRDX
                  DIFFSV(1,1,2)=SSPSIG*DELD1 - D1*DRSSP*DELRDX
              DIFFSV(1,1,3)=SSPSIG*DELD2 - D2*DRSSP*DELRDX
                  DIFFSV(1,1,4)=SSPSIG*DELD3 - D3*DRSSP*DELRDX


                  DIFFSV(1,2,1)=-DIFFSV(1,1,2)
                  DIFFSV(1,2,2)=SQC1*DELRDX*DSVSUB + SVSUB*DELD12 + DRSPPP*DELRDX
                  DIFFSV(1,2,3)=D1*D2*DELRDX*DSVSUB - SVSUB*D1*DELD2 - SVSUB*D2*DELD1
                  DIFFSV(1,2,4)=D1*D3*DELRDX*DSVSUB - SVSUB*D1*DELD3 - SVSUB*D3*DELD1
              
                  DIFFSV(1,3,1)=-DIFFSV(1,1,3)
                  DIFFSV(1,3,2)= DIFFSV(1,2,3)
                  DIFFSV(1,3,3)= SQC2*DELRDX*DSVSUB + SVSUB*DELD22 + DRSPPP*DELRDX
                  DIFFSV(1,3,4)= D2*D3*DELRDX*DSVSUB - SVSUB*D2*DELD3  - SVSUB*D3*DELD2

                  DIFFSV(1,4,1)=-DIFFSV(1,1,4)
                  DIFFSV(1,4,2)= DIFFSV(1,2,4)
                  DIFFSV(1,4,3)= DIFFSV(1,3,4)
                  DIFFSV(1,4,4)= SQC3*DELRDX*DSVSUB + SVSUB*DELD32 + DRSPPP*DELRDX

C              ELSE

               CALL HAMIL(N,I,J,HSSSIG, HSPSIG, HPPSIG, HPPPI,NATOMS)


               CALL DERHAM(N,I,J,DRSSS,DRSSP,DRSPPS,DRSPPP,NATOMS)

             SVSUB=HPPSIG - HPPPI
             DSVSUB=DRSPPS - DRSPPP


              DIFFSV(2,1,1)=DRSSS*DELRDX
              DIFFSV(2,1,2)=HSPSIG*DELD1 - D1*DRSSP*DELRDX
              DIFFSV(2,1,3)=HSPSIG*DELD2 - D2*DRSSP*DELRDX
              DIFFSV(2,1,4)=HSPSIG*DELD3 - D3*DRSSP*DELRDX

              DIFFSV(2,2,1)=-DIFFSV(2,1,2)
              DIFFSV(2,2,2)=SQC1*DELRDX*DSVSUB + SVSUB*DELD12 + DRSPPP*DELRDX
              DIFFSV(2,2,3)=D1*D2*DELRDX*DSVSUB - SVSUB*D1*DELD2 - SVSUB*D2*DELD1
              DIFFSV(2,2,4)=D1*D3*DELRDX*DSVSUB - SVSUB*D1*DELD3 - SVSUB*D3*DELD1

              DIFFSV(2,3,1)=-DIFFSV(2,1,3)
              DIFFSV(2,3,2)= DIFFSV(2,2,3)
              DIFFSV(2,3,3)= SQC2*DELRDX*DSVSUB + SVSUB*DELD22 + DRSPPP*DELRDX
              DIFFSV(2,3,4)= D2*D3*DELRDX*DSVSUB - SVSUB*D2*DELD3  - SVSUB*D3*DELD2

              DIFFSV(2,4,1)=-DIFFSV(2,1,4)
              DIFFSV(2,4,2)= DIFFSV(2,2,4)
              DIFFSV(2,4,3)= DIFFSV(2,3,4)
              DIFFSV(2,4,4)= SQC3*DELRDX*DSVSUB + SVSUB*DELD32 + DRSPPP*DELRDX

C              ENDIF

C               END DO ! SV

           E1=0.0D0


           DO NUM1=1,4
             DO NUM2=1,4

              E2=DIFFSV(1,NUM1,NUM2)
              E3=DIFFSV(2,NUM1,NUM2)


              DO LEV=4*N,2*N+1,-1
               E1=E1+EIGVEC(LEV,AI+NUM1)*EIGVEC(LEV,AJ+NUM2)*(E3-DIAG(LEV)*E2)
              END DO !LEV
             END DO !NUM2
           END DO !NUM1
           ELEC1ST(I,1)=ELEC1ST(I,1)+2.0D0*E1
           ELEC1ST(J,1)=ELEC1ST(J,1)-2.0D0*E1

         END DO  !J (1ST TIME)
        END DO  !I(1ST TIME)

        DO K=1,N
          ELEC1ST(K,2)=0.0D0
        ENDDO


        DO I=1,N
         AI=4*(I-1)

C   DIFF OF INTERACTIONS OF AOS ON SAME ATOM
C   DON'T NEED TO INCLUDE FOR DIFFSV SINCE NOT USED - LOOP
C   IS ONLY FOR J=I+1,N

         DO J=I+1,N

           RR=1.0D0/R(J,I)
           AJ=4*(J-1)
           J2=3*(J-1)

           D1=DIRCOS(J,I,2)
           D2=DIRCOS(J,I,3)
           D3=DIRCOS(J,I,1)

           SDC1=SUBDIRCOS(J2+2,I)
C           SDC2=SUBDIRCOS(J2+3,I)
C           SDC3=SUBDIRCOS(J2+1,I)
           SQC1=SQDIRCOS(J2+2,I)
           SQC2=SQDIRCOS(J2+3,I)
           SQC3=SQDIRCOS(J2+1,I)

C   DIFFSV(DIFF. OF S OR V,AO NO.,AO NO.)

C   DIFFERENTIATION OF OVERLAP OR INTERACTION BETWEEN ORBITALS
C   ON DIFFERENT ATOMS

C          PRINT*,'YTERMS'

              DELD1=RR*SDC1
              DELD12=-2*RR*D1*SDC1
              DELD2=D2*D1*RR
              DELD22=-2*SQC2*D1*RR
              DELD3=D3*D1*RR
              DELD32=-2*SQC3*D1*RR
              DELRDX=D1

C               DO SV=1,2
C           IF (SV.EQ.1) THEN

           CALL OVERL(N,I,J,SSSSIG, SSPSIG, SPPSIG, SPPPI,NATOMS)

           CALL DEROV(N,I,J,DRSSS,DRSSP,DRSPPS,DRSPPP,NATOMS)

             SVSUB=SPPSIG - SPPPI
             DSVSUB=DRSPPS - DRSPPP


              DIFFSV(1,1,1)=DRSSS*DELRDX
              DIFFSV(1,1,3)=SSPSIG*DELD1 - D1*DRSSP*DELRDX
              DIFFSV(1,1,4)=SSPSIG*DELD2 - D2*DRSSP*DELRDX
              DIFFSV(1,1,2)=SSPSIG*DELD3 - D3*DRSSP*DELRDX

              DIFFSV(1,2,1)=-DIFFSV(1,1,2)
              DIFFSV(1,3,3)=SQC1*DELRDX*DSVSUB + SVSUB*DELD12 + DRSPPP*DELRDX
              DIFFSV(1,2,3)=D1*D3*DELRDX*DSVSUB - SVSUB*D1*DELD3 - SVSUB*D3*DELD1
              DIFFSV(1,2,4)=D2*D3*DELRDX*DSVSUB - SVSUB*D2*DELD3 - SVSUB*D3*DELD2

              DIFFSV(1,3,1)=-DIFFSV(1,1,3)
              DIFFSV(1,3,2)= DIFFSV(1,2,3)
              DIFFSV(1,4,4)= SQC2*DELRDX*DSVSUB + SVSUB*DELD22 + DRSPPP*DELRDX
              DIFFSV(1,3,4)= D2*D1*DELRDX*DSVSUB - SVSUB*D2*DELD1 - SVSUB*D1*DELD2

              DIFFSV(1,4,1)=-DIFFSV(1,1,4)
              DIFFSV(1,4,2)= DIFFSV(1,2,4)
              DIFFSV(1,4,3)= DIFFSV(1,3,4)
              DIFFSV(1,2,2)= SQC3*DELRDX*DSVSUB + SVSUB*DELD32 + DRSPPP*DELRDX

C              ELSE

               CALL HAMIL(N,I,J,HSSSIG, HSPSIG, HPPSIG, HPPPI,NATOMS)

               CALL DERHAM(N,I,J,DRSSS,DRSSP,DRSPPS,DRSPPP,NATOMS)


             SVSUB=HPPSIG - HPPPI
             DSVSUB=DRSPPS - DRSPPP


              DIFFSV(2,1,1)=DRSSS*DELRDX
              DIFFSV(2,1,3)=HSPSIG*DELD1 - D1*DRSSP*DELRDX
              DIFFSV(2,1,4)=HSPSIG*DELD2 - D2*DRSSP*DELRDX
              DIFFSV(2,1,2)=HSPSIG*DELD3 - D3*DRSSP*DELRDX

              DIFFSV(2,2,1)=-DIFFSV(2,1,2)
              DIFFSV(2,3,3)=SQC1*DELRDX*DSVSUB + SVSUB*DELD12 + DRSPPP*DELRDX
              DIFFSV(2,2,3)=D1*D3*DELRDX*DSVSUB - SVSUB*D1*DELD3 - SVSUB*D3*DELD1
              DIFFSV(2,2,4)=D2*D3*DELRDX*DSVSUB - SVSUB*D2*DELD3 - SVSUB*D3*DELD2

              DIFFSV(2,3,1)=-DIFFSV(2,1,3)
              DIFFSV(2,3,2)= DIFFSV(2,2,3)
              DIFFSV(2,4,4)= SQC2*DELRDX*DSVSUB + SVSUB*DELD22 + DRSPPP*DELRDX
              DIFFSV(2,3,4)= D2*D1*DELRDX*DSVSUB - SVSUB*D2*DELD1 - SVSUB*D1*DELD2

              DIFFSV(2,4,1)=-DIFFSV(2,1,4)
              DIFFSV(2,4,2)= DIFFSV(2,2,4)
              DIFFSV(2,4,3)= DIFFSV(2,3,4)
              DIFFSV(2,2,2)= SQC3*DELRDX*DSVSUB + SVSUB*DELD32 + DRSPPP*DELRDX

C              ENDIF

C               END DO ! SV

           E1=0.0D0

           DO NUM1=1,4
             DO NUM2=1,4

              E2=DIFFSV(1,NUM1,NUM2)
              E3=DIFFSV(2,NUM1,NUM2)

              DO LEV=4*N,2*N+1,-1
               E1=E1+EIGVEC(LEV,AI+NUM1)*EIGVEC(LEV,AJ+NUM2)*(E3-DIAG(LEV)*E2)
              END DO !LEV
             END DO !NUM2
           END DO !NUM1
           ELEC1ST(I,2)=ELEC1ST(I,2)+2.0D0*E1
           ELEC1ST(J,2)=ELEC1ST(J,2)-2.0D0*E1

         END DO  !J (1ST TIME)
        END DO  !I(1ST TIME)

        DO K=1,N
          ELEC1ST(K,3)=0.0D0
        ENDDO
        DO I=1,N
         AI=4*(I-1)

         DO J=I+1,N

           RR=1.0D0/R(J,I)
           AJ=4*(J-1)
           J2=3*(J-1)

           D1=DIRCOS(J,I,3)
           D2=DIRCOS(J,I,1)
           D3=DIRCOS(J,I,2)


           SDC1=SUBDIRCOS(J2+3,I)
C           SDC2=SUBDIRCOS(J2+1,I)
C           SDC3=SUBDIRCOS(J2+2,I)
           SQC1=SQDIRCOS(J2+3,I)
           SQC2=SQDIRCOS(J2+1,I)
           SQC3=SQDIRCOS(J2+2,I)


C   DIFFSV(DIFF. OF S OR V,AO NO.,AO NO.)

C   DIFFERENTIATION OF OVERLAP OR INTERACTION BETWEEN ORBITALS
C   ON DIFFERENT ATOMS

C               DO SV=1,2
              DELD1=RR*SDC1
              DELD12=-2*RR*D1*SDC1
              DELD2=D2*D1*RR
              DELD22=-2*SQC2*D1*RR
              DELD3=D3*D1*RR
              DELD32=-2*SQC3*D1*RR
              DELRDX=D1

           CALL OVERL(N,I,J,SSSSIG, SSPSIG, SPPSIG, SPPPI,NATOMS)


C              IF (SV.EQ.1) THEN

               CALL DEROV(N,I,J,DRSSS,DRSSP,DRSPPS,DRSPPP,NATOMS)

             SVSUB=SPPSIG - SPPPI
             DSVSUB=DRSPPS - DRSPPP


              DIFFSV(1,1,1)=DRSSS*DELRDX
              DIFFSV(1,1,4)=SSPSIG*DELD1 - D1*DRSSP*DELRDX
              DIFFSV(1,1,2)=SSPSIG*DELD2 - D2*DRSSP*DELRDX
              DIFFSV(1,1,3)=SSPSIG*DELD3 - D3*DRSSP*DELRDX

              DIFFSV(1,2,1)=-DIFFSV(1,1,2)
              DIFFSV(1,4,4)=SQC1*DELRDX*DSVSUB + SVSUB*DELD12 + DRSPPP*DELRDX
              DIFFSV(1,2,3)=D3*D2*DELRDX*DSVSUB - SVSUB*D2*DELD3 - SVSUB*D3*DELD2
              DIFFSV(1,2,4)=D1*D2*DELRDX*DSVSUB - SVSUB*D1*DELD2 - SVSUB*D2*DELD1

              DIFFSV(1,3,1)=-DIFFSV(1,1,3)
              DIFFSV(1,3,2)= DIFFSV(1,2,3)
              DIFFSV(1,2,2)= SQC2*DELRDX*DSVSUB + SVSUB*DELD22 + DRSPPP*DELRDX
              DIFFSV(1,3,4)= D1*D3*DELRDX*DSVSUB - SVSUB*D1*DELD3 - SVSUB*D3*DELD1

              DIFFSV(1,4,1)=-DIFFSV(1,1,4)
              DIFFSV(1,4,2)= DIFFSV(1,2,4)
              DIFFSV(1,4,3)= DIFFSV(1,3,4)
              DIFFSV(1,3,3)= SQC3*DELRDX*DSVSUB + SVSUB*DELD32 + DRSPPP*DELRDX

C              ELSE

               CALL HAMIL(N,I,J,HSSSIG, HSPSIG, HPPSIG, HPPPI,NATOMS)


               CALL DERHAM(N,I,J,DRSSS,DRSSP,DRSPPS,DRSPPP,NATOMS)

             SVSUB=HPPSIG - HPPPI
             DSVSUB=DRSPPS - DRSPPP


              DIFFSV(2,1,1)=DRSSS*DELRDX
              DIFFSV(2,1,4)=HSPSIG*DELD1 - D1*DRSSP*DELRDX
              DIFFSV(2,1,2)=HSPSIG*DELD2 - D2*DRSSP*DELRDX
              DIFFSV(2,1,3)=HSPSIG*DELD3 - D3*DRSSP*DELRDX

              DIFFSV(2,2,1)=-DIFFSV(2,1,2)
              DIFFSV(2,4,4)=SQC1*DELRDX*DSVSUB + SVSUB*DELD12 + DRSPPP*DELRDX
              DIFFSV(2,2,3)=D3*D2*DELRDX*DSVSUB - SVSUB*D2*DELD3 - SVSUB*D3*DELD2
              DIFFSV(2,2,4)=D1*D2*DELRDX*DSVSUB - SVSUB*D1*DELD2 - SVSUB*D2*DELD1

              DIFFSV(2,3,1)=-DIFFSV(2,1,3)
              DIFFSV(2,3,2)= DIFFSV(2,2,3)
              DIFFSV(2,2,2)= SQC2*DELRDX*DSVSUB + SVSUB*DELD22 + DRSPPP*DELRDX
              DIFFSV(2,3,4)= D1*D3*DELRDX*DSVSUB - SVSUB*D1*DELD3 - SVSUB*D3*DELD1

              DIFFSV(2,4,1)=-DIFFSV(2,1,4)
              DIFFSV(2,4,2)= DIFFSV(2,2,4)
              DIFFSV(2,4,3)= DIFFSV(2,3,4)
              DIFFSV(2,3,3)= SQC3*DELRDX*DSVSUB + SVSUB*DELD32 + DRSPPP*DELRDX

C              ENDIF
C               END DO ! SV

          E1=0.0D0

           DO NUM1=1,4
             DO NUM2=1,4

              E2=DIFFSV(1,NUM1,NUM2)
              E3=DIFFSV(2,NUM1,NUM2)

              DO LEV=4*N,2*N+1,-1
               E1=E1+EIGVEC(LEV,AI+NUM1)*EIGVEC(LEV,AJ+NUM2)*(E3-DIAG(LEV)*E2)
              END DO !LEV
             END DO !NUM2
           END DO !NUM1
           ELEC1ST(I,3)=ELEC1ST(I,3)+2.0D0*E1
           ELEC1ST(J,3)=ELEC1ST(J,3)-2.0D0*E1


         END DO  !J (1ST TIME)
        END DO  !I(1ST TIME)

C   IN ORDER TO DIFFERENTIATE BY THE COORDINATE OF ATOM K, YOU ONLY GET 
C   A VALUE FOR THE DERIVATIVE IF ONE OF THE TWO ATOMS INVOLVED IN THE
C   PAIR INTERACTION IS K OTHERWISE IT IS ZERO. 
C   HAVE TO KEEP IT IN A LOOP WHERE I AND J ARE THE ATOM NUMBER RATHER
C   THAN THE AO.

C   MUST BE AWARE THAT ALTHOUGH NONE OF THE DIAGONAL ELEMENTS ARE DEFINED
C   THEY ARE EQUAL TO ZERO. NOT DEEMED NECESSARY TO CALC. THEM SINCE
C   THE LOOP NEVER REACHES I=J.  GOOD TO USE J=I+1 SINCE USES SYMMETRY TO 
C   CUT DOWN ON CALCULATIONS.

C   INCLUDE FACTOR OF 2 FOR ELEC1ST SINCE TWO ELECTRONS FILL EACH MO
C   INCLUDE HBOHR2EVANG CONVERSION FACTOR TO RETURN IN UNITS OF EV/ANGSTROM 
C   THAT I KNOW AND LOVE

      DO K=1,3
         DO I=1,N
            I2=3*(I-1)
            IF (ANGSTROM) THEN
             DERIV1ST(I2+K)=(2.0D0*ELEC1ST(I,K)+REP1ST(I,K))*HBOHR2EVANG
            ELSE
             DERIV1ST(I2+K)=(2.0D0*ELEC1ST(I,K)+REP1ST(I,K))
            END IF
         END DO
      END DO
       
      END
C   
C  SUBROUTINE TO EXPAND THE POLYNOMIAL SUM FOR THE OVERLAP MATRIX ELEMENTS
C  THIS IS BETWEEN SAME ELEMENT....SAME ELEMENT/DIFF ELEMENT WILL BE MORE
C   

      SUBROUTINE DEROV(N,K,L,SSSS,SSPS,SPPS,SPPP,NATOMS)
      USE DISTANCE
      IMPLICIT NONE
      INTEGER  K,L,NATOMS

      INTEGER N
      DOUBLE PRECISION Q(NATOMS,NATOMS)

      DOUBLE PRECISION SSSS,SSPS,SPPS,SPPP,DQDR,
     /     D1,D2,D3,
     7     D4,D5,D6,D7,D8,D9,D10,D11,D12,D13,D14,D15,D16,D17,D18,D19,D20,
     8     D21,D22,D23,D24,D25,D26,D27,D28,D29,D30,D31,D32,D33,D34,D35,D36,
     9     D37,D38,D39,D40,A3,B3,D41,D42,D43,D44,D45,D46,D47,D48

      PARAMETER ( D1=0.3942975, D2=-0.3092186, D3=0.1395490,
     /     D4=-0.0176746, D5=-0.0169834,
     /    D6=8.3055D-03,D7=1.4080D-03,D8=-2.9477D-03,D9=1.3781D-03,
     /    D10=-2.380D-04, D11=-7.16D-05,D12=5.26D-05,
     /    D13=-0.3568323,D14=0.2467967,D15=-0.0456893,
     /    D16=-0.0605347,D17=0.0497093,D18=-0.0102684,
     /    D19=-6.4619D-03,D20=5.4908D-03,D21=-1.6044D-03,
     /    D22=-1.030D-04,D23=2.934D-04,D24=-1.581D-04,
     /    D25=-0.1400088,D26=0.0192343,D27=0.1646371,
     /    D28=-0.181142,D29=0.0754221,D30=3.0624D-03,
     /    D31=-0.0183958,D32=8.7078D-03,D33=-1.1229D-03,
     /    D34=-8.468D-04,D35=5.924D-04,D36=-1.579D-04,
     /    D37=0.3722275,D38=-0.3063175,D39=0.1654376,
     /    D40=-0.0484825,D41=-2.4093D-03,D42=9.0576D-03,
     /    D43=-3.7347D-03,D44=3.162D-04,D45=3.926D-04,
     /    D46=-2.436D-04,D47=7.48D-05,D48=1.01D-05)

       A3=1.5D0
       B3=9.5D0

       Q(K,L)=(R(K,L)-((B3+A3)/2.0D0))/((B3-A3)/2.0D0)

C         PRINT*,'R IN DEROV IS',R(K,L)

      DQDR=1.0D0 /((B3-A3)/2.0D0)

C  SSSSIG

       SSSS=D2*DQDR + D3*4.0D0*Q(K,L)*DQDR
     /   +D4*(-3.0D0*DQDR + 12.0D0*(Q(K,L)**2)*DQDR)
     /   + D5*(-16.0D0*Q(K,L)*DQDR + 32.0D0*(Q(K,L)**3)*DQDR) +D6*(5.0D0*DQDR -60.0D0*(Q(K,L)**2)*DQDR
     /   + 80.0D0*(Q(K,L)**4)*DQDR) +D7*(36.0D0*Q(K,L)*DQDR - 192.0D0*(Q(K,L)**3)*DQDR +192.0D0*(Q(K,L)**5)*DQDR)
     /   +D8*(-7.0D0*DQDR +168.0D0*(Q(K,L)**2)*DQDR - 560.0D0*(Q(K,L)**4)*DQDR +448.0D0*(Q(K,L)**6)*DQDR)
     /   +D9*(-64.0D0*Q(K,L)*DQDR +640.0D0*(Q(K,L)**3)*DQDR -1536.0D0*(Q(K,L)**5)*DQDR +1024.0D0*(Q(K,L)**7)*DQDR)
     /   +D10*(9.0D0*DQDR -360.0D0*(Q(K,L)**2)*DQDR +2160*(Q(K,L)**4)*DQDR
     /   -4032.0D0*(Q(K,L)**6)*DQDR +2304.0D0*(Q(K,L)**8)*DQDR)
     /   +D11*(100.0D0*Q(K,L)*DQDR - 1600*(Q(K,L)**3)*DQDR + 6720*(Q(K,L)**5)*DQDR - 10240*(Q(K,L)**7)*DQDR
     /       +5120*(Q(K,L)**9)*DQDR)
     /   +D12*(-11.0D0*DQDR + 660.0D0*(Q(K,L)**2)*DQDR - 6160*(Q(K,L)**4)*DQDR +19712*(Q(K,L)**6)*DQDR 
     /   -25344*(Q(K,L)**8)*DQDR + 11264*(Q(K,L)**10)*DQDR)

      IF (R(K,L).GT.9.489340860704047D0) SSSS=0.0D0

C   SSPSIG
      SSPS=D14*DQDR + D15*4.0D0*Q(K,L)*DQDR
     /   +D16*(-3.0D0*DQDR + 12.0D0*(Q(K,L)**2)*DQDR)
     /   + D17*(-16.0D0*Q(K,L)*DQDR + 32.0D0*(Q(K,L)**3)*DQDR) +D18*(5.0D0*DQDR -60.0D0*(Q(K,L)**2)*DQDR
     /   + 80.0D0*(Q(K,L)**4)*DQDR) +D19*(36.0D0*Q(K,L)*DQDR - 192.0D0*(Q(K,L)**3)*DQDR +192.0D0*(Q(K,L)**5)*DQDR)
     /   +D20*(-7.0D0*DQDR +168.0D0*(Q(K,L)**2)*DQDR - 560.0D0*(Q(K,L)**4)*DQDR +448.0D0*(Q(K,L)**6)*DQDR)
     /   +D21*(-64.0D0*Q(K,L)*DQDR +640.0D0*(Q(K,L)**3)*DQDR -1536.0D0*(Q(K,L)**5)*DQDR +1024.0D0*(Q(K,L)**7)*DQDR)
     /   +D22*(9.0D0*DQDR -360.0D0*(Q(K,L)**2)*DQDR +2160*(Q(K,L)**4)*DQDR
     /   -4032.0D0*(Q(K,L)**6)*DQDR +2304.0D0*(Q(K,L)**8)*DQDR)
     /   +D23*(100.0D0*Q(K,L)*DQDR - 1600*(Q(K,L)**3)*DQDR + 6720*(Q(K,L)**5)*DQDR - 10240*(Q(K,L)**7)*DQDR
     /       +5120*(Q(K,L)**9)*DQDR)
     /   +D24*(-11.0D0*DQDR + 660.0D0*(Q(K,L)**2)*DQDR - 6160*(Q(K,L)**4)*DQDR +19712*(Q(K,L)**6)*DQDR 
     /   -25344*(Q(K,L)**8)*DQDR + 11264*(Q(K,L)**10)*DQDR)

      IF (R(K,L).GT.9.360442319381175D0) SSPS=0.0D0

C SPPSIG
      SPPS=D26*DQDR + D27*4.0D0*Q(K,L)*DQDR
     /   +D28*(-3.0D0*DQDR + 12.0D0*(Q(K,L)**2)*DQDR)
     /   + D29*(-16.0D0*Q(K,L)*DQDR + 32.0D0*(Q(K,L)**3)*DQDR) +D30*(5.0D0*DQDR -60.0D0*(Q(K,L)**2)*DQDR
     /   + 80.0D0*(Q(K,L)**4)*DQDR) +D31*(36.0D0*Q(K,L)*DQDR - 192.0D0*(Q(K,L)**3)*DQDR +192.0D0*(Q(K,L)**5)*DQDR)
     /   +D32*(-7.0D0*DQDR +168.0D0*(Q(K,L)**2)*DQDR - 560.0D0*(Q(K,L)**4)*DQDR +448.0D0*(Q(K,L)**6)*DQDR)
     /   +D33*(-64.0D0*Q(K,L)*DQDR +640.0D0*(Q(K,L)**3)*DQDR -1536.0D0*(Q(K,L)**5)*DQDR +1024.0D0*(Q(K,L)**7)*DQDR)
     /   +D34*(9.0D0*DQDR -360.0D0*(Q(K,L)**2)*DQDR +2160*(Q(K,L)**4)*DQDR
     /   -4032.0D0*(Q(K,L)**6)*DQDR +2304.0D0*(Q(K,L)**8)*DQDR)
     /   +D35*(100.0D0*Q(K,L)*DQDR - 1600*(Q(K,L)**3)*DQDR + 6720*(Q(K,L)**5)*DQDR - 10240*(Q(K,L)**7)*DQDR
     /       +5120*(Q(K,L)**9)*DQDR)
     /   +D36*(-11.0D0*DQDR + 660.0D0*(Q(K,L)**2)*DQDR - 6160*(Q(K,L)**4)*DQDR +19712*(Q(K,L)**6)*DQDR 
     /   -25344*(Q(K,L)**8)*DQDR + 11264*(Q(K,L)**10)*DQDR)


      IF (R(K,L).GT.9.096495577461203D0) SPPS=0.0D0

C   SPPPI
      SPPP=D38*DQDR + D39*4.0D0*Q(K,L)*DQDR
     /   +D40*(-3.0D0*DQDR + 12.0D0*(Q(K,L)**2)*DQDR)
     /   + D41*(-16.0D0*Q(K,L)*DQDR + 32.0D0*(Q(K,L)**3)*DQDR) +D42*(5.0D0*DQDR -60.0D0*(Q(K,L)**2)*DQDR
     /   + 80.0D0*(Q(K,L)**4)*DQDR) +D43*(36.0D0*Q(K,L)*DQDR - 192.0D0*(Q(K,L)**3)*DQDR +192.0D0*(Q(K,L)**5)*DQDR)
     /   +D44*(-7.0D0*DQDR +168.0D0*(Q(K,L)**2)*DQDR - 560.0D0*(Q(K,L)**4)*DQDR +448.0D0*(Q(K,L)**6)*DQDR)
     /   +D45*(-64.0D0*Q(K,L)*DQDR +640.0D0*(Q(K,L)**3)*DQDR -1536.0D0*(Q(K,L)**5)*DQDR +1024.0D0*(Q(K,L)**7)*DQDR)
     /   +D46*(9.0D0*DQDR -360.0D0*(Q(K,L)**2)*DQDR +2160*(Q(K,L)**4)*DQDR
     /   -4032.0D0*(Q(K,L)**6)*DQDR +2304.0D0*(Q(K,L)**8)*DQDR)
     /   +D47*(100.0D0*Q(K,L)*DQDR - 1600*(Q(K,L)**3)*DQDR + 6720*(Q(K,L)**5)*DQDR - 10240*(Q(K,L)**7)*DQDR
     /       +5120*(Q(K,L)**9)*DQDR)
     /   +D48*(-11.0D0*DQDR + 660.0D0*(Q(K,L)**2)*DQDR - 6160*(Q(K,L)**4)*DQDR +19712*(Q(K,L)**6)*DQDR 
     /   -25344*(Q(K,L)**8)*DQDR + 11264*(Q(K,L)**10)*DQDR)

      IF (R(K,L).GT.9.358643583694771) SPPP=0.0D0

      RETURN
      END
C   
C  SUBROUTINE TO EXPAND THE POLYNOMIAL SUM FOR THE OVERLAP MATRIX ELEMENTS
C  THIS IS BETWEEN SAME ELEMENT....SAME ELEMENT/DIFF ELEMENT WILL BE MORE
C   


      SUBROUTINE DERHAM(N,K,L,SSSS,SSPS,SPPS,SPPP,NATOMS)
      USE DISTANCE
      IMPLICIT NONE
      INTEGER  K,L,NATOMS

      INTEGER N
      DOUBLE PRECISION Q(NATOMS,NATOMS)

      DOUBLE PRECISION SSSS,SSPS,SPPS,SPPP,DQDR,
     /     G1,G2,G3,
     7     G4,G5,G6,G7,G8,G9,G10,G11,G12,G13,G14,G15,G16,G17,G18,G19,G20,
     8     G21,G22,G23,G24,G25,G26,G27,G28,G29,G30,G31,G32,G33,G34,G35,G36,
     9     G37,G38,G39,G40,A2,B2,G41,G42,G43,G44,G45,G46,G47,G48

C
C N.B. G14 AND G26 HAVE BEEN ALTERED TO GIVE FUNCTIONS WITH TURNING POINTS
C NEAR THE CUTOFF.
C
       PARAMETER (G1=-0.2601372,G2=0.1958030,G3=-0.0716540,
     /    G4=-0.0084811,G5=0.0229926,G6=-9.8866D-03,
     /    G7=-8.281D-04,G8=3.5950D-03,G9=-2.6770D-03,
     /    G10=1.3587D-03,G11=-5.617D-04,G12=2.165D-04,
     /    G13=0.1777735,G14=-0.1082D0 ,G15=-0.0071041,
     /    G16=0.0557698,G17=-0.0376445,G18=0.0088910,
     /    G19=0.0041357,G20=-0.0052914,G21=0.0031425,
     /    G22=-0.0014231,G23=5.843D-04,G24=-2.103D-04,
     /    G25=0.0510829,G26=0.0145D0,G27=-0.0894841,
     /    G28=0.0856069,G29=-0.0355870,G30=1.3150D-03,
     /    G31=7.8269D-03,G32=-6.1665D-03,G33=3.2455D-03,
     /    G34=-1.4904D-03,G35=6.809D-04,G36=-2.655D-04,
     /    G37=-0.1737379,G38=0.1403235,G39=-0.0716452,
     /    G40=0.0185100,G41=0.0027857, G42=-5.0867D-03,
     /    G43=2.5525D-03, G44=-6.749D-04, G45=-2.12D-05,
     /    G46=1.537D-04, G47=-1.269D-04, G48=7.84D-05 )

       A2=1.5D0
       B2=9.5D0

       Q(K,L)=(R(K,L)-((B2+A2)/2.0D0))/((B2-A2)/2.0D0)

      DQDR=1.0D0/((B2-A2)/2.0D0)

C  SSSSIG

       SSSS=G2*DQDR + G3*4.0D0*Q(K,L)*DQDR
     /   +G4*(-3.0D0*DQDR + 12.0D0*(Q(K,L)**2)*DQDR)
     /   + G5*(-16.0D0*Q(K,L)*DQDR + 32.0D0*(Q(K,L)**3)*DQDR) +G6*(5.0D0*DQDR -60.0D0*(Q(K,L)**2)*DQDR
     /   + 80.0D0*(Q(K,L)**4)*DQDR) +G7*(36.0D0*Q(K,L)*DQDR - 192.0D0*(Q(K,L)**3)*DQDR +192.0D0*(Q(K,L)**5)*DQDR)
     /   +G8*(-7.0D0*DQDR +168.0D0*(Q(K,L)**2)*DQDR - 560.0D0*(Q(K,L)**4)*DQDR +448.0D0*(Q(K,L)**6)*DQDR)
     /   +G9*(-64.0D0*Q(K,L)*DQDR +640.0D0*(Q(K,L)**3)*DQDR -1536.0D0*(Q(K,L)**5)*DQDR +1024.0D0*(Q(K,L)**7)*DQDR)
     /   +G10*(9.0D0*DQDR -360.0D0*(Q(K,L)**2)*DQDR +2160*(Q(K,L)**4)*DQDR
     /   -4032.0D0*(Q(K,L)**6)*DQDR +2304.0D0*(Q(K,L)**8)*DQDR)
     /   +G11*(100.0D0*Q(K,L)*DQDR - 1600*(Q(K,L)**3)*DQDR + 6720*(Q(K,L)**5)*DQDR - 10240*(Q(K,L)**7)*DQDR
     /       +5120*(Q(K,L)**9)*DQDR)
     /   +G12*(-11.0D0*DQDR + 660.0D0*(Q(K,L)**2)*DQDR - 6160*(Q(K,L)**4)*DQDR +19712*(Q(K,L)**6)*DQDR 
     /   -25344*(Q(K,L)**8)*DQDR + 11264*(Q(K,L)**10)*DQDR)

       IF (R(K,L).GT.9.074040365621258D0) SSSS=0.0D0

C   SSPSIG
      SSPS=G14*DQDR + G15*4.0D0*Q(K,L)*DQDR
     /   +G16*(-3.0D0*DQDR + 12.0D0*(Q(K,L)**2)*DQDR)
     /   + G17*(-16.0D0*Q(K,L)*DQDR + 32.0D0*(Q(K,L)**3)*DQDR) +G18*(5.0D0*DQDR -60.0D0*(Q(K,L)**2)*DQDR
     /   + 80.0D0*(Q(K,L)**4)*DQDR) +G19*(36.0D0*Q(K,L)*DQDR - 192.0D0*(Q(K,L)**3)*DQDR +192.0D0*(Q(K,L)**5)*DQDR)
     /   +G20*(-7.0D0*DQDR +168.0D0*(Q(K,L)**2)*DQDR - 560.0D0*(Q(K,L)**4)*DQDR +448.0D0*(Q(K,L)**6)*DQDR)
     /   +G21*(-64.0D0*Q(K,L)*DQDR +640.0D0*(Q(K,L)**3)*DQDR -1536.0D0*(Q(K,L)**5)*DQDR +1024.0D0*(Q(K,L)**7)*DQDR)
     /   +G22*(9.0D0*DQDR -360.0D0*(Q(K,L)**2)*DQDR +2160*(Q(K,L)**4)*DQDR
     /   -4032.0D0*(Q(K,L)**6)*DQDR +2304.0D0*(Q(K,L)**8)*DQDR)
     /   +G23*(100.0D0*Q(K,L)*DQDR - 1600*(Q(K,L)**3)*DQDR + 6720*(Q(K,L)**5)*DQDR - 10240*(Q(K,L)**7)*DQDR
     /       +5120*(Q(K,L)**9)*DQDR)
     /   +G24*(-11.0D0*DQDR + 660.0D0*(Q(K,L)**2)*DQDR - 6160*(Q(K,L)**4)*DQDR +19712*(Q(K,L)**6)*DQDR 
     /   -25344*(Q(K,L)**8)*DQDR + 11264*(Q(K,L)**10)*DQDR)

       IF (R(K,L).GT.9.246570341781329D0) SSPS=0.0D0

C SPPSIG
      SPPS=G26*DQDR + G27*4.0D0*Q(K,L)*DQDR
     /   +G28*(-3.0D0*DQDR + 12.0D0*(Q(K,L)**2)*DQDR)
     /   + G29*(-16.0D0*Q(K,L)*DQDR + 32.0D0*(Q(K,L)**3)*DQDR) +G30*(5.0D0*DQDR -60.0D0*(Q(K,L)**2)*DQDR
     /   + 80.0D0*(Q(K,L)**4)*DQDR) +G31*(36.0D0*Q(K,L)*DQDR - 192.0D0*(Q(K,L)**3)*DQDR +192.0D0*(Q(K,L)**5)*DQDR)
     /   +G32*(-7.0D0*DQDR +168.0D0*(Q(K,L)**2)*DQDR - 560.0D0*(Q(K,L)**4)*DQDR +448.0D0*(Q(K,L)**6)*DQDR)
     /   +G33*(-64.0D0*Q(K,L)*DQDR +640.0D0*(Q(K,L)**3)*DQDR -1536.0D0*(Q(K,L)**5)*DQDR +1024.0D0*(Q(K,L)**7)*DQDR)
     /   +G34*(9.0D0*DQDR -360.0D0*(Q(K,L)**2)*DQDR +2160*(Q(K,L)**4)*DQDR
     /   -4032.0D0*(Q(K,L)**6)*DQDR +2304.0D0*(Q(K,L)**8)*DQDR)
     /   +G35*(100.0D0*Q(K,L)*DQDR - 1600*(Q(K,L)**3)*DQDR + 6720*(Q(K,L)**5)*DQDR - 10240*(Q(K,L)**7)*DQDR
     /       +5120*(Q(K,L)**9)*DQDR)
     /   +G36*(-11.0D0*DQDR + 660.0D0*(Q(K,L)**2)*DQDR - 6160*(Q(K,L)**4)*DQDR +19712*(Q(K,L)**6)*DQDR 
     /   -25344*(Q(K,L)**8)*DQDR + 11264*(Q(K,L)**10)*DQDR)

       IF (R(K,L).GT.9.273572893686612D0) SPPS=0.0D0

C   SPPPI
      SPPP=G38*DQDR + G39*4.0D0*Q(K,L)*DQDR
     /   +G40*(-3.0D0*DQDR + 12.0D0*(Q(K,L)**2)*DQDR)
     /   + G41*(-16.0D0*Q(K,L)*DQDR + 32.0D0*(Q(K,L)**3)*DQDR) +G42*(5.0D0*DQDR -60.0D0*(Q(K,L)**2)*DQDR
     /   + 80.0D0*(Q(K,L)**4)*DQDR) +G43*(36.0D0*Q(K,L)*DQDR - 192.0D0*(Q(K,L)**3)*DQDR +192.0D0*(Q(K,L)**5)*DQDR)
     /   +G44*(-7.0D0*DQDR +168.0D0*(Q(K,L)**2)*DQDR - 560.0D0*(Q(K,L)**4)*DQDR +448.0D0*(Q(K,L)**6)*DQDR)
     /   +G45*(-64.0D0*Q(K,L)*DQDR +640.0D0*(Q(K,L)**3)*DQDR -1536.0D0*(Q(K,L)**5)*DQDR +1024.0D0*(Q(K,L)**7)*DQDR)
     /   +G46*(9.0D0*DQDR -360.0D0*(Q(K,L)**2)*DQDR +2160*(Q(K,L)**4)*DQDR
     /   -4032.0D0*(Q(K,L)**6)*DQDR +2304.0D0*(Q(K,L)**8)*DQDR)
     /   +G47*(100.0D0*Q(K,L)*DQDR - 1600*(Q(K,L)**3)*DQDR + 6720*(Q(K,L)**5)*DQDR - 10240*(Q(K,L)**7)*DQDR
     /       +5120*(Q(K,L)**9)*DQDR)
     /   +G48*(-11.0D0*DQDR + 660.0D0*(Q(K,L)**2)*DQDR - 6160*(Q(K,L)**4)*DQDR +19712*(Q(K,L)**6)*DQDR 
     /   -25344*(Q(K,L)**8)*DQDR + 11264*(Q(K,L)**10)*DQDR)

       IF (R(K,L).GT.9.10748558948335D0) SPPP=0.0D0

      RETURN
      END
