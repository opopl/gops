SUBROUTINE DUMPSTATE(NDONE,EBEST,BESTCOORDS,JBEST,JP)
USE COMMONS,ONLY : NATOMS, COORDS, NPAR, STEP, ASTEP, OSTEP, TEMP, NMSBSAVE, MSBE, MSBCOORDS, DUMPFILE, &
  &                NSAVE, MAXSAVE, MPIT, MYUNIT, AMHT, SEEDT, A9INTET, NSAVEINTE
USE QMODULE
USE PORFUNCS
IMPLICIT NONE
INTEGER NDONE, JBEST(NPAR), JP, J1, MYUNIT2
DOUBLE PRECISION EBEST(NPAR), BESTCOORDS(3*NATOMS,NPAR)
CHARACTER(LEN=20) :: ISTR
LOGICAL LOPEN

IF (NPAR.GT.1) THEN
   WRITE (ISTR, '(I10)') JP
   MYUNIT2=JP+30000
   CALL FLUSH(MYUNIT)
!   CALL SYSTEM('CP "GMIN.DUMP."//TRIM(ADJUSTL(ISTR)) "GMIN.DUMP."//TRIM(ADJUSTL(ISTR))//".SAVE"')
   OPEN(MYUNIT2,FILE="GMIN.DUMP."//TRIM(ADJUSTL(ISTR)),STATUS='UNKNOWN')
ELSE
   INQUIRE(UNIT=1,OPENED=LOPEN)
   IF (LOPEN) THEN
      WRITE(*,'(A,I2,A)') 'DUMPSTATE> ERROR *** UNIT ', 1, ' IS NOT FREE '
      STOP
   ELSE
      MYUNIT2=1
      CALL SYSTEM('CP GMIN.DUMP GMIN.DUMP.SAVE')
      OPEN(MYUNIT2,FILE='GMIN.DUMP',STATUS='UNKNOWN')
   ENDIF
ENDIF

  WRITE(MYUNIT2, '(A)') 'STEPS COMPLETED J1 IN MC'
  WRITE(MYUNIT2, '(I8)') NDONE
  WRITE(MYUNIT2, '(I8)') NSAVE
  WRITE(MYUNIT2, '(A)') 'COORDS'
  WRITE(MYUNIT2, '(A,I8)') 'RUN NUMBER ',JP
  WRITE(MYUNIT2, '(3F25.15)') COORDS(1:3*NATOMS,JP)
  WRITE(MYUNIT2, '(A)') 'STEP, ASTEP, OSTEP, TEMP:'
  WRITE(MYUNIT2, '(4F25.15)') STEP(JP),ASTEP(JP),OSTEP(JP),TEMP(JP)
  WRITE(MYUNIT2, '(A)') 'QMIN AND QMINP'
! BEST NSAVE MINIMA
  DO J1=1,NSAVE
     WRITE(MYUNIT2, '(A,I8)') 'SAVED MINIMUM ',J1
     WRITE(MYUNIT2, '(G25.15)') QMIN(J1)
     WRITE(MYUNIT2, '(3F25.15)') QMINP(J1,1:3*NATOMS)
  ENDDO
! BS360: WHAT IS IT GOOD FOR? EBEST AND BESTCOORDS NEVER GET UPDATED. (JULY 2010)
  WRITE(MYUNIT2,'(A)') 'NEW RESTART PROCEDURE - JBEST, EBEST, BESTCOORDS'
  WRITE(MYUNIT2, '(A,I8)') 'RUN NUMBER ',JP
  WRITE(MYUNIT2, '(I8,F25.15)') JBEST(JP), EBEST(JP)
  WRITE(MYUNIT2, '(3F25.15)') BESTCOORDS(1:3*NATOMS,JP)
! BS360: THE FOLLOWING IS NOT TESTED FOR MPI (JULY 2010)
  WRITE(MYUNIT2, '(A)') 'NEW RESTART PROCEDURE - SAVED ENERGIES AND COORDINATES IN MSB LIST'
  WRITE(MYUNIT2, '(I8)') NMSBSAVE
  DO J1=1,MIN(NMSBSAVE,MAXSAVE)
     WRITE(MYUNIT2, '(A,I8)') 'STRUCTURE NUMBER ',J1
     WRITE(MYUNIT2, '(G25.15)') MSBE(J1)
     WRITE(MYUNIT2, '(3F25.15)') MSBCOORDS(1:3*NATOMS,J1)
  ENDDO
! WRITE(MYUNIT2, '(A)','OLD TABOO PROCEDURE: ENERGY AND INERTIA DETERMINANT'
! DO J1=1,NPAR
   ! WRITE(MYUNIT2, '(A,I8)') 'TABOO STRUCTURE ',J1
   ! WRITE(MYUNIT2, '(2G25.15)') ESAVE(J1), XINSAVE(J1)
! ENDDO
!
  CLOSE(MYUNIT2)


!   CSW34> ADD IN DUMPING OF THE LOWEST INTERACTION ENERGIES IF A9INTE IS SPECIFIED
IF (NPAR.EQ.1) THEN
  IF (A9INTET) THEN
     CALL SYSTEM('CP GMININTE.DUMP GMININTE.DUMP.SAVE')

     OPEN(UNIT=1,FILE='GMININTE.DUMP',STATUS='UNKNOWN')
     WRITE(1, '(A)') 'SAVEINTE'
     WRITE(1, '(I8)') NSAVEINTE
     WRITE(1, '(A)') 'STEPS COMPLETED J1 IN MC'
     WRITE(1, '(I8)') NDONE
     WRITE(1, '(A)') 'INTEQMIN AND INTEQMINP'
     DO J1=1,NSAVEINTE
        WRITE(1, '(A,I8)') 'SAVED INTERACTION ENTHALPY MINIMUM ',J1
        WRITE(1, '(G25.15)') INTEQMIN(J1)
        WRITE(1, '(3F25.15)') INTEQMINP(J1,1:3*NATOMS)
     ENDDO
     CLOSE(UNIT=1)
  ENDIF
ENDIF

RETURN
END SUBROUTINE DUMPSTATE

SUBROUTINE RESTORESTATE(NDONE,EBEST,BESTCOORDS,JBEST,JP)
USE COMMONS,ONLY : NATOMS, COORDS, NPAR, STEP, ASTEP, OSTEP, TEMP, NMSBSAVE, MSBE, MSBCOORDS, DUMPFILE, &
  &                NSAVE, MAXSAVE, MPIT, MYUNIT, AMHT, SEEDT, A9INTET, NSAVEINTE, INTEDUMPFILE, INTERESTORE
USE QMODULE
IMPLICIT NONE
INTEGER NDONE, JBEST(NPAR), JP, J1, OLDSAVE, MYUNIT2
DOUBLE PRECISION EBEST(NPAR), BESTCOORDS(3*NATOMS,NPAR), DUMMYARRAY(3*NATOMS)
CHARACTER(LEN=1) DUMMYS
CHARACTER(LEN=20) :: ISTR

IF (NPAR.GT.1) THEN
   WRITE (ISTR, '(I10)') JP
   MYUNIT2=JP+30000
   OPEN(MYUNIT2,FILE="GMIN.DUMP."//TRIM(ADJUSTL(ISTR)),STATUS='OLD')
ELSE
   MYUNIT2=1
   OPEN(MYUNIT2,FILE='GMIN.DUMP',STATUS='OLD')
ENDIF

   READ(MYUNIT2,*) DUMMYS
   READ(MYUNIT2,'(I8)') NDONE
   READ(MYUNIT2,'(I8)') OLDSAVE
   READ(MYUNIT2,*) DUMMYS
! READ IN LAST MINIMUM, WHICH IS ALSO THE LAST MINIMUM IN THE MARKOV CHAIN.
   READ(MYUNIT2,*) DUMMYS
   READ(MYUNIT2,*) COORDS(1:3*NATOMS,JP)
   IF ((.NOT.SEEDT).AND.(.NOT.AMHT)) THEN
      WRITE(MYUNIT,'(A,I4)') 'INITIAL COORDINATES: PROCESS',JP
      WRITE(MYUNIT,'(3F20.10)') (COORDS(J1,JP),J1=1,3*NATOMS)
   ENDIF
! STEP AND TEMPERATURE INFORMATION
   READ(MYUNIT2,*) DUMMYS
   READ(MYUNIT2,*) STEP(JP),ASTEP(JP),OSTEP(JP),TEMP(JP)
! BEST OLDSAVE MINIMA
  READ(MYUNIT2,*) DUMMYS
!       CSW34> THIS IS THE LOOP THAT HAS BEEN EDITED TO ALLOW SAVE TO VARY BETWEEN
!       RUNS. THERE ARE THREE CASES WHICH MUST BE CONSIDERED. 1) NSAVE=OLDSAVE.
!       IN THIS CASE, NOTHING NEW NEEDS TO BE DONE. 2) NSAVE<OLDSAVE. NOW, THE
!       EXTRA MINIMA THAT ARE SAVED IN THE DUMP FILE NEED TO BE CYCLED OVER
!       (IGNORED). 3) NSAVE>OLDSAVE. THE ARRAY MUST BE ALLOCATED WITH
!       DIMENSIONS SUITABLE FOR THE NEW NUMBER OF MINIMA, AND THE DUMP FILE READ
!       IN AS FAR AS POSSIBLE. THE REST OF THE ARRAY MUST THEN BE PADDED WITH
!       ZEROS. THE QMIN AND QMINP ARRAYS ARE ALREADY ALLOCATED IN MAIN.F WITH
!       THE CORRECT DIMENSION SO THAT NEED NOT WORRY US HERE :)
        IF (NSAVE.EQ.OLDSAVE) THEN
           DO J1=1,NSAVE
              READ(MYUNIT2,*) DUMMYS
              READ(MYUNIT2,*) QMIN(J1)
              READ(MYUNIT2,*) QMINP(J1,1:3*NATOMS)
           ENDDO
        ELSEIF (NSAVE.LT.OLDSAVE) THEN
           PRINT *,'NSAVE<OLDSAVE - TRUNCATING READ IN'
           DO J1=1,OLDSAVE
              IF (J1.LE.NSAVE) THEN
                 READ(MYUNIT2,*) DUMMYS
                 READ(MYUNIT2,*) QMIN(J1)
                 READ(MYUNIT2,*) QMINP(J1,1:3*NATOMS)
              ELSE 
                 READ(MYUNIT2,*) DUMMYS
                 READ(MYUNIT2,*) DUMMYS
                 READ(MYUNIT2,*) DUMMYARRAY(1:3*NATOMS)
              ENDIF
           ENDDO
        ELSEIF (NSAVE.GT.OLDSAVE) THEN
           PRINT *,'NSAVE>OLDSAVE - PADDING QMIN AND QMINP WITH ZEROS'
           DO J1=1,NSAVE
              IF (J1.LE.OLDSAVE) THEN
                 READ(MYUNIT2,*) DUMMYS
                 READ(MYUNIT2,*) QMIN(J1)
                 READ(MYUNIT2,*) QMINP(J1,1:3*NATOMS)
              ELSE 
                 QMIN(J1)=0.0D0
                 QMINP(J1,1:3*NATOMS)=0.0D0
              ENDIF
           ENDDO
        ENDIF
! READ IN EBEST AND BESTCOORDS
! BS360: WHAT IS IT GOOD FOR? EBEST AND BESTCOORDS NEVER GET UPDATED. (JULY 2010)
   READ(MYUNIT2,*) DUMMYS
   READ(MYUNIT2,*) DUMMYS
   READ(MYUNIT2,*) JBEST(JP), EBEST(JP)
   READ(MYUNIT2,*) BESTCOORDS(1:3*NATOMS,JP)
! BS360: THE FOLLOWING IS NOT TESTED FOR MPI (JULY 2010)
  READ(MYUNIT2,*) DUMMYS
  READ(MYUNIT2,*) NMSBSAVE
  DO J1=1,MIN(NMSBSAVE,MAXSAVE)
     READ(MYUNIT2,*) DUMMYS
     READ(MYUNIT2,*) MSBE(J1)
     READ(MYUNIT2,*) MSBCOORDS(1:3*NATOMS,J1)
  ENDDO
! READ(MYUNIT2,*) DUMMYS
! DO J1=1,NPAR
   ! READ(MYUNIT2,*) DUMMYS
   ! READ(MYUNIT2,*) ESAVE(J1), XINSAVE(J1)
! ENDDO

  CLOSE(MYUNIT2)


!   CSW34> ADD IN RESTORING OF THE LOWEST INTERACTION ENERGIES IF A9INTE IS SPECIFIED
!          INTERESTORE IS .TRUE. IF THE RESTORE KEYWORD HAS TWO ARGUEMENTS. THE SECOND IS
!          THE NAME OF THE INTERACTION ENERGY DUMP FILE!
IF (NPAR.EQ.1) THEN
IF (A9INTET.AND.INTERESTORE) THEN
   OPEN(UNIT=1,FILE=TRIM(ADJUSTL(INTEDUMPFILE)),STATUS='OLD')
   READ(1,*) DUMMYS
   READ(1,'(I8)') OLDSAVE
   READ(1,*) DUMMYS
   READ(1,'(I8)') NDONE
   READ(1,*) DUMMYS
!       CSW34> LOOP AS ABOVE TO ALLOW SAVE TO VARY BETWEEN RUNS
   IF (NSAVEINTE.EQ.OLDSAVE) THEN
           DO J1=1,NSAVEINTE
                   READ(1,*) DUMMYS
                   READ(1,*) INTEQMIN(J1)
                   READ(1,*) INTEQMINP(J1,1:3*NATOMS)
           ENDDO
!       CSW34> NSAVEINTE<OLDSAVE
   ELSE IF (NSAVEINTE.LT.OLDSAVE) THEN
           PRINT *,'NSAVEINTE<OLDSAVE - TRUNCATING READ IN'
           DO J1=1,OLDSAVE
                   IF (J1.LE.NSAVEINTE) THEN
                           READ(1,*) DUMMYS
                           READ(1,*) INTEQMIN(J1)
                           READ(1,*) INTEQMINP(J1,1:3*NATOMS)
                   ELSE
                           READ(1,*) DUMMYS
                           READ(1,*) DUMMYS
!       CSW34> THIS IS THE KEY BIT, YOU'VE GOT TO SKIP THE CORRECT NUMBER OF
!       LINES AND THAT INCLUDES THOSE FOR THE COORDINATES. THE NEW ARRAY
!       DUMMYARRAY ALLOWS THIS IN A VERY SIMPLE WAY.
                           READ(1,*) DUMMYARRAY(1:3*NATOMS)
                  ENDIF
           ENDDO
!       CSW34> NSAVEINTE>OLDSAVE
   ELSE IF (NSAVEINTE.GT.OLDSAVE) THEN
           PRINT *,'NSAVEINTE>OLDSAVE - PADDING INTEQMIN AND INTEQMINP WITH ZEROS'
           DO J1=1,NSAVEINTE
                   IF (J1.LE.OLDSAVE) THEN
                           READ(1,*) DUMMYS
                           READ(1,*) INTEQMIN(J1)
                           READ(1,*) INTEQMINP(J1,1:3*NATOMS)
                   ELSE
                           INTEQMIN(J1)=0.0D0
                           INTEQMINP(J1,1:3*NATOMS)=0.0D0
                   ENDIF
           ENDDO
   ENDIF
CLOSE(UNIT=1)
ENDIF
ENDIF

RETURN
END SUBROUTINE RESTORESTATE
