C   GMIN: A PROGRAM FOR FINDING GLOBAL MINIMA
C   COPYRIGHT (C) 1999-2006 DAVID J. WALES
C   THIS FILE IS PART OF GMIN.
C
C   GMIN IS FREE SOFTWARE; YOU CAN REDISTRIBUTE IT AND/OR MODIFY
C   IT UNDER THE TERMS OF THE GNU GENERAL PUBLIC LICENSE AS PUBLISHED BY
C   THE FREE SOFTWARE FOUNDATION; EITHER VERSION 2 OF THE LICENSE, OR
C   (AT YOUR OPTION) ANY LATER VERSION.
C
C   GMIN IS DISTRIBUTED IN THE HOPE THAT IT WILL BE USEFUL,
C   BUT WITHOUT ANY WARRANTY; WITHOUT EVEN THE IMPLIED WARRANTY OF
C   MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.  SEE THE
C   GNU GENERAL PUBLIC LICENSE FOR MORE DETAILS.
C
C   YOU SHOULD HAVE RECEIVED A COPY OF THE GNU GENERAL PUBLIC LICENSE
C   ALONG WITH THIS PROGRAM; IF NOT, WRITE TO THE FREE SOFTWARE
C   FOUNDATION, INC., 59 TEMPLE PLACE, SUITE 330, BOSTON, MA  02111-1307  USA
C
      SUBROUTINE TABOO(EREAL,POTEL,P,NP,RES)
      USE COMMONS
      IMPLICIT NONE
      INTEGER NP, J1, J2, J3
      DOUBLE PRECISION P(3*NATOMS), EREAL, POTEL, XIP
      LOGICAL RES

      CALL NEWINERTIA(P,NATOMS,NATOMS,XIP)
C
C  FIRST CHECK IF THE LATEST ENERGY HAS BEEN FOUND BEFORE IN ANY OF THE
C  OTHER PARALLEL RUNS. IF SO, COMBINE THE LISTS FOR THE RUN WHICH FOUND
C  IT FIRST AND RESEED THE OTHER ONE.
C
      DO J1=1,NPAR
         IF (J1.NE.NP) THEN
            DO J2=1,NT(J1)
               IF (DABS(EREAL-ESAVE(J2,J1)).LT.ECONV) THEN
                  IF (2.0D0*DABS(XIP-XINSAVE(J2,J1))/(XIP+XINSAVE(J2,J1)).LT.1.0D-2) THEN
C                    IF (J2.EQ.NP) RETURN 
                     DO J3=1,MIN(NT(NP),NTAB-NT(J1))
                        ESAVE(NT(J1)+J3,J1)=ESAVE(J3,NP)
                        XINSAVE(NT(J1)+J3,J1)=XINSAVE(J3,NP)
                     ENDDO
                     NT(J1)=MIN(NT(J1)+NT(NP),NTAB)
                     CALL GSORT(NT(J1),ESAVE,XINSAVE,J1,NPAR,NTAB)  
                     NT(J1)=MIN(NT(J1),NTAB)
                     NT(NP)=0
C                    CALL RESEED(NATOMS,P,RADIUS)
                     CALL HSMOVE(P,1,15)
                     DO J3=1,3*NATOMS
                        COORDS(J3,NP)=P(J3)
                        COORDSO(J3,NP)=P(J3)
                     ENDDO
                     EPREV(NP)=1.0D100
                     EREAL=1.0D100
                     POTEL=1.0D100
                     WRITE(*,'(A,I2,A,I2)') 'PARALLEL RUN ',NP,' RESEEDED AFTER OVERLAP WITH RUN ',J1
                     RES=.TRUE.
                     RETURN
                  ELSE
                     PRINT*,'ENERGIES NEARLY DEGENERATE:',EREAL,ESAVE(J2,J1)
                     PRINT*,'BUT  DIFFERENT  STRUCTURES:',XIP,XINSAVE(J2,J1)
                  ENDIF
               ENDIF
               IF (EREAL.LT.ESAVE(J2,J1)) GOTO 10
            ENDDO
10          CONTINUE
         ENDIF
      ENDDO

      IF (NT(NP).EQ.0) THEN
         NT(NP)=1
         ESAVE(1,NP)=EREAL
         XINSAVE(1,NP)=XIP
         RETURN
      ENDIF

      SELFT=.FALSE.
      DO J2=1,NT(NP)
         IF (DABS(EREAL-ESAVE(J2,NP)).LT.ECONV) THEN
C
C SELF-AVOIDING WALK IF NPAR=1.
C
            IF (NPAR.EQ.1) THEN
               IF (DABS(XIP-XINSAVE(J2,NP))/(XIP+XINSAVE(J2,NP)).LT.1.0D-2) THEN
                  SELFT=.TRUE.
                  RETURN
               ELSE
                  PRINT*,'ENERGIES NEARLY DEGENERATE:',EREAL,ESAVE(J2,NP)
                  PRINT*,'BUT  DIFFERENT  STRUCTURES:',XIP,XINSAVE(J2,NP)
               ENDIF
            ELSE
               RETURN
            ENDIF
         ENDIF
         IF (EREAL.LT.ESAVE(J2,NP)) THEN
            NT(NP)=MIN(NT(NP)+1,NTAB)
            DO J3=NT(NP),J2+1,-1
               ESAVE(J3,NP)=ESAVE(J3-1,NP)
               XINSAVE(J3,NP)=XINSAVE(J3-1,NP)
            ENDDO
            ESAVE(J2,NP)=EREAL
            XINSAVE(J2,NP)=XIP
            RETURN
         ENDIF
      ENDDO

      NT(NP)=NT(NP)+1
      ESAVE(NT(NP),NP)=EREAL
      XINSAVE(NT(NP),NP)=XIP

      RETURN
      END
