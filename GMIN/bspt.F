!  GMIN: A PROGRAM FOR FINDING GLOBAL MINIMA
!  COPYRIGHT (C) 1999-2006 DAVID J. WALES
!  THIS FILE IS PART OF GMIN.
!
!  GMIN IS FREE SOFTWARE; YOU CAN REDISTRIBUTE IT AND/OR MODIFY
!  IT UNDER THE TERMS OF THE GNU GENERAL PUBLIC LICENSE AS PUBLISHED BY
!  THE FREE SOFTWARE FOUNDATION; EITHER VERSION 2 OF THE LICENSE, OR
!  (AT YOUR OPTION) ANY LATER VERSION.
!
!  GMIN IS DISTRIBUTED IN THE HOPE THAT IT WILL BE USEFUL,
!  BUT WITHOUT ANY WARRANTY; WITHOUT EVEN THE IMPLIED WARRANTY OF
!  MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.  SEE THE
!  GNU GENERAL PUBLIC LICENSE FOR MORE DETAILS.
!
!  YOU SHOULD HAVE RECEIVED A COPY OF THE GNU GENERAL PUBLIC LICENSE
!  ALONG WITH THIS PROGRAM; IF NOT, WRITE TO THE FREE SOFTWARE
!  FOUNDATION, INC., 59 TEMPLE PLACE, SUITE 330, BOSTON, MA  02111-1307  USA
!
! 
!---======================================---
      SUBROUTINE PTBASINSAMPLING

      USE MODCHARMM
      USE COMMONS
      USE TETHERFUNC

      IMPLICIT NONE

#IFDEF MPI
!OP226> MPI SECTION {{{ 
      INCLUDE 'MPIF.H'
!OP226 VARIABLE DECLARATIONS      {{{
      INTEGER, PARAMETER :: NHIST=100, NHISTE=1000
      INTEGER :: IACCEPT(0:NPAR-1), MPIERR, J,K, IS(MPI_STATUS_SIZE)
      INTEGER NHISTQ4(NHIST,0:NPAR-1), NDUMMY, NTYPEA, NTOT, NH, IMESG, IQE, IQ4, IQ6, J1, J2, J3, J4,
     1        NHISTQ6(NHIST,0:NPAR-1), NHISTQE(NHISTE, 0:NPAR-1), IENR, 
     2        NOUT(0:NPAR-1), ITRAJ, ITRAJO,NEACCEPT, RNDSEED, NUPDATE,
     3        CONVERGED,LBFGS_ITERATIONS, JD, BININDEX, MINIMANUMBER(HBINS,0:NPAR-1),
     4        NHISTALLQ(NHIST, NHIST, 0:NPAR-1), IBININDEX, IBININDEX2, LOWESTDIRECT(HBINS),
     5        NHISTGRAND(NHISTE, NHIST, NHIST, 0:NPAR-1),LBFGS_ITERATIONSO,LVISITS(NENRPER),PEVISITS2(NENRPER, HBINS, 0:NPAR-1),
     7        NOUTQBIN, NOUTPEBIN, LBFGS_ITERATIONSSAVE, HBINMAX, HBINMIN
      DOUBLE PRECISION I
      DOUBLE PRECISION QVISITS(HBINS, 0:NPAR-1), PEVISITS(NENRPER,0:NPAR-1), NACCEPTPT(0:NPAR-1)

      DOUBLE PRECISION V(NATOMS), VO(NATOMS), TEMPTRAJ(0:NPAR-1), H(0:NPAR-1), BETA(0:NPAR-1), 
     1        EAV(0:NPAR-1), EAV2(0:NPAR-1), Q(3,NATOMS), Q4AV(0:NPAR-1), Q4AV2(0:NPAR-1), 
     2        Q6AV(0:NPAR-1), Q6AV2(0:NPAR-1), VENR(NENRPER), 
     3        HINIT(0:NPAR-1), EPSAB, EPSBB, SIGAB, SIGBB, X(NATOMS), Y(NATOMS), Z(NATOMS), 
     4        CTE, T, VOLD,VNEW, POTEL, GRAD(3*NATOMS), Q4, Q6, RANDOM, DPRAND, Q4MAX, Q6MAX , 
     5	      DQ4, DQ6, DHISTE, ENUL, XO(NATOMS), YO(NATOMS), ZO(NATOMS), DDX, DDY, DDZ, DE, 
     6        W, WCOMP, WAC, E, ER, DBETA, DELTA, CV, FQ4, FQ6, RMAX, DDXN, DDYN, DDZN, R2, 
     7        DUMMY,BINLABEL(HBINS), VNEWSAVE, DIHEORDERPARAM,SASAORDERPARAM, PEINT, HISTINT, 
     8        DIHEORDERPARAM_AV(0:NPAR-1), SASAORDERPARAM_AV(0:NPAR-1), MINCOORDS(3*NATOMS,NPAR), INTERIMCOORDS(3*NATOMS,1),
     9        INTERIMCOORDS2(3*NATOMS,1), DIST, VOLDSAVE, LESAVE, DOSSTATS(MAXIT,2), DOSSTATSO(MAXIT,2), 
     A        DCOORDS(3*NATOMS), DOSSTATSDUM(MAXIT,2), SR3

       DOUBLE PRECISION DIHEORDERPARAM_MIN, DIHEORDERPARAM_MAX, SASAORDERPARAM_MIN, SASAORDERPARAM_MAX, 
     1          DDIHE, DSASA, RGYR_MIN, RGYR_MAX, EINT_MIN, EINT_MAX, DRGYR, DEINT,
     2          RGYR_AV(0:NPAR-1), EINT_AV(0:NPAR-1), RGYR_AV2(0:NPAR-1), EINT_AV2(0:NPAR-1),
     3          ORDERPARAM1, ORDERPARAM2, DISTANCE(HBINS, 0:NPAR-1),
     4          DISTANCE_AV(HBINS,0:NPAR-1), DISTANCEOLD, NORM_PJ(0:NPAR-1), PJ(HBINS,0:NPAR-1),
     5          VMINOLD, VMINNEW, DELTA_EAV(0:NPAR-1), CX, CY, CZ,
     6        DIHEORDERPARAM_AV2(0:NPAR-1), SASAORDERPARAM_AV2(0:NPAR-1), RGYR, EINT, VMINNEWSAVE

      CHARACTER (LEN =256)  FILENAME, FILENAME2,FILENAME3,FILENAME4,FILENAME5,FILENAME6,
     1                      FILENAME7,FILENAME8,FILENAME9, FILENAME10, FILENAME11, FILENAME12, 
     2                      FILENAME100,FILENAME101,FILENAME102, FILENAME103, FILENAME104, FILENAME105 
      CHARACTER (LEN= 80)  ISTR, SDUMMY
      CHARACTER (LEN= 80)  CFNAME
      LOGICAL EXCHANGE, EXCHANGEACCEPT, FITS, NEWENERGY, EVAP, EVAPREJECT, RECOUNT, YESNO

      DOUBLE PRECISION PREVSTEPS

      COMMON /BIN/ EPSAB, EPSBB, SIGAB, SIGBB, NTYPEA
      COMMON /MYPOT/ POTEL
      COMMON /EV/ EVAP, EVAPREJECT
! }}}

      CALL MPI_COMM_SIZE(MPI_COMM_WORLD,NDUMMY,MPIERR)
      CALL MPI_COMM_RANK(MPI_COMM_WORLD,MYNODE,MPIERR)
      NOUTQBIN=0
      NOUTPEBIN=0

      WRITE(MYUNIT, '(A,I10,A,I10)') "BSPT> THIS IS PROCESSOR", MYNODE+1, " OF", NPAR
      WRITE(MYUNIT, '(A,I10)') 'BSPT> NUMBER OF ATOMS', NATOMS
      IF (FIXSTEP(1)) FIXSTEP(2:NPAR)=.TRUE.
      IF (FIXTEMP(1)) FIXTEMP(2:NPAR)=.TRUE.
      IF (PERIODIC) THEN
         WRITE(MYUNIT, '(A,6G20.10)') 'BSPT> BINARY DATA', NTYPEA, EPSAB, EPSBB, SIGAB, SIGBB, CUTOFF
         WRITE(MYUNIT, '(A,3G20.10)') 'BSPT> BOX DATA', BOXLX, BOXLY, BOXLZ
      ELSEIF(CHRMMT) THEN
         WRITE(MYUNIT, '(A)') 'BSPT> CHARMM JOB'
         IF (FIXSTEP(MYNODE+1).OR.FIXBOTH(MYNODE+1)) THEN
            WRITE(MYUNIT, '(A,G20.10,A)') 'BSPT> STARTING STEPSIZE ', STEP(MYNODE+1),' (FIXED)'
         ELSE
            WRITE(MYUNIT, '(A,G20.10,A)') 'BSPT> STARTING STEPSIZE ', STEP(MYNODE+1),
     &                            ' (WILL BE DYNAMICALLY ADJUSTED DURING EQUILIBRATION)'
         ENDIF
      ELSEIF (.NOT.MODEL1T) THEN
         WRITE(MYUNIT, '(A,2G20.10)') 'BSPT> RADIUS AND RADIUS**2: ',SQRT(RADIUS),RADIUS
      ENDIF

      ITRAJ=MYNODE
      NEACCEPT=0
      MINIMANUMBER=0
      IENR=0 ! DJW APPEARED TO BE UNINITIALISED ?
      PEINT=(PTEMAX-PTEMIN)/NENRPER
      MAXEFALL=-1.0D100
      HISTINT=(HISTMAX-HISTMIN)/HBINS
!
! LIMIT FOR QUENCH ENERGY ABOVE WHICH STEPS WILL BE REJECTED.
!
      HBINMAX=(MIN(BSPTQMAX,HISTMAX)-HISTMIN)/HISTINT+1
      HBINMIN=(MAX(BSPTQMIN,HISTMIN)-HISTMIN)/HISTINT
      WRITE(MYUNIT, '(A,2I8)') 'BSPT> MINIMUM AND MAXIMUM QUENCH BIN LIMITS: ',HBINMIN,HBINMAX
      DO J1=1, HBINS
!        BINLABEL(J1)=HISTMIN + HISTINT*(J1-0.5D0) ! THESE ENERGIES POINT TO THE MIDDLE OF THE QUENCH BIN
         BINLABEL(J1)=HISTMIN + HISTINT*(J1-1.0D0) ! THESE ENERGIES POINT TO THE BOTTOM OF THE QUENCH BIN
      ENDDO

! INITIALISATION

      DO J1=1,NATOMS
         X(J1)=COORDS(3*(J1-1)+1,MYNODE+1)
         Y(J1)=COORDS(3*(J1-1)+2,MYNODE+1)
         Z(J1)=COORDS(3*(J1-1)+3,MYNODE+1)
      ENDDO
      DO J1=1,NATOMS
         Q(1,J1)=X(J1)
         Q(2,J1)=Y(J1)
         Q(3,J1)=Z(J1)
      ENDDO

      CTE=(LOG(PTTMAX/PTTMIN))/(NPAR-1)
      CTE=EXP(CTE)

      DO J1=0, NPAR-1
         TEMPTRAJ(J1)=PTTMIN*CTE**J1
         T=TEMPTRAJ(J1)
         BETA(J1)=1.0D0/T
      ENDDO
      IF (MYNODE.EQ.0) THEN
         OPEN(UNIT=10, FILE='TEMPERATURES',STATUS='UNKNOWN')
         WRITE(10,'(G20.10)') TEMPTRAJ(0:NPAR-1)
         CLOSE(10)
      ENDIF
!
! FOR RESTART WE NEED TO GET THE CURRENT CONFIGURATION, ITS PE, THE PE OF THE MINIMUM IT QUENCHED TO,
! IF APPLICABLE, THE NUMBER OF STEPS ALREADY DONE, THE MAXIMUM STEP SIZE, AND THE VISITS AND VISITS2
! HISTOGRAMS. IF WE DUMP USING BSPTDUMPFRQ THEN WE CAN RESTORE FROM THE LAST SUCH FILE. WE CAN WORK
! OUT WHAT THE LAST DUMP WAS ONCE WE KNOW HOW MANY STEPS HAVE BEEN DONE!
!
      IF (BSPTRESTART) THEN
         WRITE (ISTR, '(I10)') MYNODE
         FILENAME12="BSPTRESTART."//TRIM(ADJUSTL(ISTR))
         OPEN(UNIT=1986+MYNODE,FILE=FILENAME12, STATUS="OLD", FORM="FORMATTED")
         READ(1986+MYNODE,*) PREVSTEPS,VOLD,VMINOLD,STEP(MYNODE+1),
     &                       NACCEPTPT(MYNODE),NEACCEPT,NTOT,NOUTQBIN,NOUTPEBIN,NQ(MYNODE+1)
         WRITE (MYUNIT,'(A,F20.1)') 'BSPT> NUMBER OF PREVIOUS STEPS=     ',PREVSTEPS
         WRITE (MYUNIT,'(A,2F20.10)') 'BSPT> QUENCH AND INSTANTANEOUS PE=',VMINOLD,VOLD
         WRITE (MYUNIT,'(A,F20.10)') 'BSPT> STEP SIZE=',STEP(MYNODE+1)
         WRITE (MYUNIT,'(A,F15.1,2I10)') 'BSPT> ACCEPTED MC STEPS, PT STEPS AND TOTAL PT STEPS=',NACCEPTPT(MYNODE),NEACCEPT,NTOT
         WRITE (MYUNIT,'(A,3I10)') 'BSPT> QUENCHES AND INSTANTANEOUS ENERGIES OUTSIDE RANGE=',NOUTQBIN,NOUTPEBIN
         WRITE (MYUNIT,'(A,I10)') 'BSPT> TOTAL QUENCHES=',NQ(MYNODE+1)
         DO J1=1,NATOMS
            J2=3*(J1-1)
            READ(1986+MYNODE,*) COORDS(J2+1,MYNODE+1), COORDS(J2+2,MYNODE+1), COORDS(J2+3,MYNODE+1)
         ENDDO
         CLOSE(1986+MYNODE)
         IF (BSPTDUMPFRQ.GT.0) THEN
            DUMMY=INT(PREVSTEPS/(1.0D0*BSPTDUMPFRQ))*1.0D0
!
!  MISCOMPILES UNLESS WE SPLIT UP THE CALCULATION OF DUMMY !!!
!
!           WRITE(MYUNIT,*) 'BSPT> PREVSTEPS,BSPTDUMPFRQ,DUMMY=',PREVSTEPS,BSPTDUMPFRQ,DUMMY
!           WRITE(MYUNIT,*) 'BSPT> INT,ARG=',INT(PREVSTEPS/(1.0D0*BSPTDUMPFRQ)),PREVSTEPS/(1.0D0*BSPTDUMPFRQ)
            DUMMY=DUMMY*BSPTDUMPFRQ
!           WRITE(MYUNIT,*) 'BSPT> DUMMY=',DUMMY
            CALL FLUSH(MYUNIT)
            WRITE (SDUMMY, '(F15.1)') DUMMY
            ISTR=TRIM(ADJUSTL(ISTR)) // '.' // TRIM(ADJUSTL(SDUMMY))
         ELSE
            ISTR=TRIM(ADJUSTL(ISTR)) ! THIS SHOULD BE THE FINAL AND ONLY VISITS FILE
         ENDIF
         IF (PREVSTEPS.GT.NEQUIL) THEN
            FILENAME101="VISITS.HIS."//TRIM(ADJUSTL(ISTR))
            WRITE(MYUNIT,'(A,A)') 'BSPT> READING RESTART INFORMATION FROM ',TRIM(ADJUSTL(FILENAME101))
            CALL FLUSH(MYUNIT)
            OPEN(UNIT=1986+MYNODE,FILE=FILENAME101, STATUS="UNKNOWN", FORM="FORMATTED")
            READ(1986+MYNODE, '(G20.10)') DUMMY
            READ(1986+MYNODE, '(A)') SDUMMY
            DO K=1, NENRPER
               READ(1986+MYNODE,*) DUMMY,PEVISITS(K,MYNODE)
            ENDDO
            READ(1986+MYNODE, '(A)') SDUMMY
            DO K=1, HBINS
               WRITE(1986+MYNODE,*) DUMMY, QVISITS(K,MYNODE)
            ENDDO
            CLOSE(1986+MYNODE)
         ENDIF
         IF (BSPT.AND.(PREVSTEPS.GT.NEQUIL+PTSTEPS)) THEN
            FILENAME101="VISITS2.HIS."//TRIM(ADJUSTL(ISTR))
            WRITE(MYUNIT,'(A,A)') 'BSPT> READING RESTART INFORMATION FROM ',TRIM(ADJUSTL(FILENAME101))
            OPEN(UNIT=1986+MYNODE,FILE=FILENAME101,STATUS="UNKNOWN",FORM="UNFORMATTED")
            READ(1986+MYNODE) PEVISITS2(1:NENRPER,1:HBINS,MYNODE)
            CLOSE(1986+MYNODE) 
         ENDIF
         CONVERGED=1
      ELSE
12       CALL POTENTIAL(COORDS(:,MYNODE+1),GRAD, POTEL, .TRUE., .FALSE.)
         VOLD=POTEL
         WRITE(MYUNIT,'(2(A,G20.10))') 'BSPT> INITIAL CONFIGURATION ENERGY IS ',VOLD
!        WRITE(MYUNIT,'(2(A,G20.10))') 'BSPT> NOT QUENCHING INITIAL CONFIG'
         CALL QUENCH(.FALSE.,MYNODE+1,LBFGS_ITERATIONS,DUMMY,NDUMMY,CONVERGED,COORDS(:,MYNODE+1),DOSSTATS)
         WRITE(MYUNIT,'(A,G20.10)') 'BSPT> INITIAL CONFIGURATION HAS BEEN QUENCHED TO ENERGY ',POTEL
!
!  IF WE START WITH AN INVALID CONFIGURATION WE MAY NEVER RECOVER!
!
         IF (.NOT.(CHRMMT.OR.MODEL1T)) THEN
            DO K=1,NATOMS
               DIST=COORDS(3*(K-1)+1,MYNODE+1)**2+COORDS(3*(K-1)+2,MYNODE+1)**2+COORDS(3*(K-1)+3,MYNODE+1)**2
               IF (DIST.GT.RADIUS) THEN
                  IF (MOD(I-1.0D0,1.0D0*PRTFRQ).EQ.0) WRITE(MYUNIT,'(A,I6,A)') 'BSPT> ATOM ',K,
     &                       ' OUTSIDE CONTAINER, RESEED AND TRY AGAIN'
                  SR3=DSQRT(3.0D0)
                  DO J1=1,NATOMS
                     RANDOM=(DPRAND()-0.5D0)*2.0D0
                     COORDS(3*(K-1)+1,MYNODE+1)=RANDOM*DSQRT(RADIUS)/SR3
                     RANDOM=(DPRAND()-0.5D0)*2.0D0
                     COORDS(3*(K-1)+2,MYNODE+1)=RANDOM*DSQRT(RADIUS)/SR3
                     RANDOM=(DPRAND()-0.5D0)*2.0D0
                     COORDS(3*(K-1)+3,MYNODE+1)=RANDOM*DSQRT(RADIUS)/SR3
                  ENDDO
                  GOTO 12
               ENDIF
            ENDDO 
         ENDIF
      ENDIF

      LBFGS_ITERATIONS=0
      LBFGS_ITERATIONSO=0 ! SO THAT WE DON'T USE QUENCH DOS STATISTICS FROM ARBITRARY HIGH ENERGY
      VOLD=POTEL
      DO J1=1,NATOMS
         X(J1)=COORDS(3*(J1-1)+1,MYNODE+1)
         Y(J1)=COORDS(3*(J1-1)+2,MYNODE+1)
         Z(J1)=COORDS(3*(J1-1)+3,MYNODE+1)
      ENDDO
      DO J1=1,NATOMS
         Q(1,J1)=X(J1)
         Q(2,J1)=Y(J1)
         Q(3,J1)=Z(J1)
      ENDDO

      IF (PERIODIC) THEN
         CALL QORDER_BLJ(Q,Q4,Q6)
      ELSE IF (CHRMMT) THEN
           IF (ODIHET) CALL CHCALCDIHE(DIHEORDERPARAM,COORDS(1:3*NATOMS,MYNODE+1))
           IF (OSASAT) CALL ORDER_SASA(SASAORDERPARAM,RPRO,COORDS(1:3*NATOMS:3,MYNODE+1),
     1             COORDS(2:3*NATOMS:3,MYNODE+1),COORDS(3:3*NATOMS:3,MYNODE+1))
           IF (ORGYT) CALL CHCALCRGYR(RGYR,COORDS(1:3*NATOMS:3,MYNODE+1),
     1             COORDS(2:3*NATOMS:3,MYNODE+1),COORDS(3:3*NATOMS:3,MYNODE+1),.FALSE.) 
           IF (OEINTT) CALL CHCALCEINT(EINT,COORDS(1:3*NATOMS:3,MYNODE+1),
     1             COORDS(2:3*NATOMS:3,MYNODE+1),COORDS(3:3*NATOMS:3,MYNODE+1),POTEL)
      ELSE
         CALL QORDER_LJ(Q,Q4,Q6)
      ENDIF

      WRITE(MYUNIT, '(A,2G20.10)') 'BSPT> TEMPERATURE RANGE', TEMPTRAJ(0), TEMPTRAJ(NPAR-1)
      WRITE(MYUNIT, '(A,G20.10)') 'BSPT> THIS TEMPERATURE TRAJECTORY=', TEMPTRAJ(MYNODE)
      IF (.NOT.BSPTRESTART) VMINOLD=VOLD
      IF ((.NOT.BSPTRESTART).AND.(NEQUIL+PTSTEPS.GT.0)) VMINOLD=0.0D0 
      WRITE (MYUNIT,'(A,F20.1)') 'BSPT> NUMBER OF EQUILIBRATION STEPS=',NEQUIL
      WRITE (MYUNIT,'(A,F20.1)') 'BSPT> NUMBER OF PT STEPS=           ',PTSTEPS
      WRITE (MYUNIT,'(A,F20.1)') 'BSPT> NUMBER OF BSPT STEPS=         ',NQUENCH
      IF (PERIODIC) WRITE(MYUNIT, '(A, 2G20.10)') 'BSPT> STARTING Q4, Q6=', Q4, Q6
      IF (CHRMMT) THEN
        IF (OSASAT)  WRITE(MYUNIT, '(A, 2G20.10)') 'BSPT> STARTING MET-ENK ORDER PARAMS=', 
     1                                         DIHEORDERPARAM, SASAORDERPARAM 
        IF (ORGYT)  WRITE(MYUNIT, '(A, G20.10)') 'BSPT> STARTING RGYR ORDER PARAMS=', 
     1                                          RGYR 
        IF (OEINTT) WRITE(MYUNIT, '(A, G20.10)') 'BSPT> STARTING EINT ORDER PARAMS=',
     1                                          EINT
      ENDIF

! INITIALISATION COMPLETE

      RNDSEED=2002+MYNODE
      CALL SDPRND(RNDSEED)
      RANDOM=DPRAND()
      WRITE(MYUNIT, '(A, G20.10)') 'BSPT> STARTING RANDOM NUMBER=', RANDOM
      IF (FIXSTEP(MYNODE+1).OR.FIXBOTH(MYNODE+1)) THEN
         WRITE(MYUNIT, '(A,G20.10,A)') 'BSPT> STARTING STEPSIZE ', STEP(MYNODE+1),' (FIXED)'
      ELSE
         WRITE(MYUNIT, '(A,G20.10,A)') 'BSPT> STARTING STEPSIZE ', STEP(MYNODE+1),' (WILL BE DYNAMICALLY ADJUSTED)'
      ENDIF
      CALL FLUSH(MYUNIT)

      IF (.NOT.BSPTRESTART) NTOT=0
      IF (.NOT.BSPTRESTART) NACCEPTPT(MYNODE)=0.0D0
      IF (.NOT.BSPTRESTART) QVISITS(:,MYNODE)=0.0D0
      IF (.NOT.BSPTRESTART) PEVISITS(:,MYNODE)=0.0D0
      IF (.NOT.BSPTRESTART) PEVISITS2(:,:,MYNODE)=0
      IACCEPT(MYNODE)=0
      EAV(MYNODE)=0.
      EAV2(MYNODE)=0.
      Q4AV(MYNODE)=0.
      Q6AV(MYNODE)=0.
      Q4AV2(MYNODE)=0.
      Q6AV2(MYNODE)=0.
      DIHEORDERPARAM_AV(MYNODE)=0.
      SASAORDERPARAM_AV(MYNODE)=0.
      DIHEORDERPARAM_AV2(MYNODE)=0.
      SASAORDERPARAM_AV2(MYNODE)=0.
      RGYR_AV(MYNODE)=0.
      EINT_AV(MYNODE)=0.
      RGYR_AV2(MYNODE)=0.
      EINT_AV2(MYNODE)=0.
      DO J1=1,NHIST
         NHISTQ4(J1,MYNODE)=0
         NHISTQ6(J1,MYNODE)=0
      ENDDO
      DO J1=1,NHISTE
         NHISTQE(J1,MYNODE)=0
      ENDDO
      NHISTALLQ(:,:,MYNODE)=0
      NHISTGRAND(:,:,:,MYNODE)=0
      DISTANCE(:,MYNODE)=0.0D0
      DISTANCE_AV(:,MYNODE)=0.0D0
      DELTA_EAV(MYNODE)=0.0D0

      Q4MAX=0.1
      Q6MAX=0.5 ! WILL HAVE TO CHANGE AS IS RATHER SYSTEM-SPECIFIC
      DIHEORDERPARAM_MIN=0.4D0
      DIHEORDERPARAM_MAX=1.0D0
      SASAORDERPARAM_MIN=300.0D0
      SASAORDERPARAM_MAX=800.0D0
      RGYR_MIN=4.0D0
      RGYR_MAX=12.0D0
      EINT_MIN=-35.0
      EINT_MAX=10.0
      DDIHE=(DIHEORDERPARAM_MAX-DIHEORDERPARAM_MIN)/(NHIST-1)
      DSASA=(SASAORDERPARAM_MAX-SASAORDERPARAM_MIN)/(NHIST-1)
      DRGYR=(RGYR_MAX-RGYR_MIN)/(NHIST-1)
      DEINT=(EINT_MAX-EINT_MIN)/(NHIST-1)
      DQ4=Q4MAX/(NHIST-1)
      DQ6=Q6MAX/(NHIST-1)
      DHISTE=(PTEMAX-PTEMIN)/(NHISTE-1)


      ENUL=VOLD

      IF (MYNODE.EQ.0) THEN

         OPEN(UNIT=10, FILE='DISTRIBUTIONS.HEADER', FORM='FORMATTED')
         WRITE(10,*) NATOMS
         WRITE(10,*) NPAR, PTSTEPS/NENRPER, NENRPER
         WRITE(10,*) ENUL
         CLOSE(10)
      ENDIF 
!
! NUPDATE SPECIFIES THE INTERVAL FOR DYNAMICALLY ALTERING THE MAXIMUM STEP SIZE.
! ONLY USED IF STEP SIZE ISN'T FIXED.
!
      NUPDATE=100
!
! MAIN LOOP OVER STEPS.
!
!     DO I=1.0D0,NEQUIL+PTSTEPS+NQUENCH

      I=1.0D0
      IF (BSPTRESTART) I=PREVSTEPS
      DO 
         I=I+1.0D0
         IF (I.GT.NEQUIL+PTSTEPS+NQUENCH) EXIT
         RECOUNT=.FALSE.
         DO K=1, NATOMS
            XO(K)=X(K)
            YO(K)=Y(K)
            ZO(K)=Z(K)
         ENDDO
!
! IF A MOVE IS REJECTED, THE RESULT FOR THE CURRENT CONFIGURATION
! SHOULD BE RECOUNTED. THIS ALLOWS FOR THE UNSYMMETRICAL FORWARD
! AND BACKWARD MOVE PROBABILITIES FOR AN ATOM NEAR THE SURFACE OF
! THE CONSTRAINING SPHERE.
!             
         IF (CHRMMT) THEN
!           CALL TAKESTEPCH(MYNODE+1)
!           DO K=1,NATOMS
!              X(K)=COORDS(3*(K-1)+1,MYNODE+1)
!              Y(K)=COORDS(3*(K-1)+2,MYNODE+1)
!              Z(K)=COORDS(3*(K-1)+3,MYNODE+1)
!           ENDDO
            DO K=1,NATOMS
               RANDOM=DPRAND()
               X(K) = X(K) + 2.0D0*RANDOM*STEP(MYNODE+1)-STEP(MYNODE+1)
               RANDOM=DPRAND()
               Y(K) = Y(K) + 2.0D0*RANDOM*STEP(MYNODE+1)-STEP(MYNODE+1)
               RANDOM=DPRAND()
               Z(K) = Z(K) + 2.0D0*RANDOM*STEP(MYNODE+1)-STEP(MYNODE+1)
            ENDDO
         ELSE
            DO K=1,NATOMS
               RANDOM=DPRAND()
               X(K) = X(K) + 2.0D0*RANDOM*STEP(MYNODE+1)-STEP(MYNODE+1)  
               RANDOM=DPRAND()
               Y(K) = Y(K) + 2.0D0*RANDOM*STEP(MYNODE+1)-STEP(MYNODE+1)  
               RANDOM=DPRAND()
               Z(K) = Z(K) + 2.0D0*RANDOM*STEP(MYNODE+1)-STEP(MYNODE+1)  
            ENDDO
         ENDIF
!
! SHOULD PROBABLY WORRY ABOUT CENTRE OF COORDINATES VERSUS CENTRE OF MASS
! FOR HETEROATOMIC SYSTEMS.
!
         IF (CENT) THEN
            CX=0.0D0; CY=0.0D0; CZ=0.0D0
            DO K=1,NATOMS
               CX=CX+X(K); CY=CY+Y(K); CZ=CZ+Z(K)
            ENDDO
            CX=CX/NATOMS; CY=CY/NATOMS; CZ=CZ/NATOMS
            DO K=1,NATOMS
               X(K)=X(K)-CX; Y(K)=Y(K)-CY; Z(K)=Z(K)-CZ
            ENDDO
         ENDIF 
         IF (.NOT.(CHRMMT.OR.MODEL1T)) THEN
            CLOOP: DO K=1,NATOMS
               DIST=X(K)**2+Y(K)**2+Z(K)**2
               IF (DIST.GT.RADIUS) THEN
                  IF (MOD(I-1.0D0,PRTFRQ*1.0D0).EQ.0.0D0) WRITE(MYUNIT,'(A,I6,A)') 'BSPT> PERTURBED ATOM ',K,
     &                       ' OUTSIDE CONTAINER, RECOUNT PREVIOUS CONFIGURATION RESULTS'
                  RECOUNT=.TRUE. ! THE RIGHT WAY TO DEAL WITH REJECTED STEPS!
                  EXIT CLOOP
               ENDIF
            ENDDO CLOOP
         ENDIF
                
         DO K=1,NATOMS
            COORDS(3*(K-1)+1,MYNODE+1)=X(K)
            COORDS(3*(K-1)+2,MYNODE+1)=Y(K)
            COORDS(3*(K-1)+3,MYNODE+1)=Z(K)
         ENDDO
!
! AT THIS POINT ALL WE HAVE DONE IS TAKE A STEP. THE PERTURBED COORDINATES ARE IN BOTH
! COORDS AND X, Y, Z. THE OLD COORDINATES ARE IN XO, YO, ZO.
!
! NEW AND OLD QUENCH ENERGIES WILL BE IN        VMINNEW VMINOLD
! NEW AND OLD INSTANTANEOUS ENERGIES WILL BE IN    VNEW    VOLD
!
         CALL POTENTIAL(COORDS(:,MYNODE+1),GRAD, POTEL, .TRUE., .FALSE.)
         VNEW=POTEL
         WCOMP=(VNEW-VOLD)*BETA(MYNODE) ! USE DIFFERENCE IN INSTANTANEOUS ENERGIES
         W=MIN(1.0D0,EXP(-WCOMP))
         RANDOM=DPRAND()
         IF (RANDOM.GT.W) RECOUNT=.TRUE. ! RECOUNT IS INITIALISED TO .FALSE. AT THE TOP OF THE LOOP
!
! QUENCHING PART IF REQUIRED.
! COORDSO SAVES THE PERTURBED COORDINATES BEFORE THE QUENCH IN ORDER TO CALCULATE
! A QUENCH DISTANCE. SHOULD NO LONGER BE NEEDED. COORDS ARE USED AS SCRATCH FOR QUENCHES.
!
         COORDSO(:,MYNODE+1)=COORDS(:,MYNODE+1) 
         IF ((RECOUNT.AND.BSPT).OR.(I.LE.NEQUIL+PTSTEPS)) THEN
            VMINNEW=0.0D0
            LBFGS_ITERATIONS=0
         ENDIF
         IF (I.GT.NEQUIL+PTSTEPS) THEN
            IF ((.NOT.RECOUNT).AND.BSPT) THEN 
               IF (MOD(I,1.0D0*QUENCHFRQ).EQ.1.0D0*0) THEN 
!                 WRITE(MYUNIT, '(A)') 'BSPT> CALLING QUENCH'
                  IF(CHRMMT.AND.ACESOLV) NCHENCALLS=ACEUPSTEP-1
                  CALL QUENCH(.FALSE.,MYNODE+1,LBFGS_ITERATIONS,DUMMY,NDUMMY,CONVERGED,COORDS(:,MYNODE+1),DOSSTATS)
                  IF (CONVERGED.NE.1) WRITE(MYUNIT, '(A)') 'BSPT> WARNING - QUENCH DID NOT CONVERGE' 
                  VMINNEW=POTEL
                  NQ(MYNODE+1)=NQ(MYNODE+1)+1
                  MINCOORDS(:,MYNODE+1)=COORDS(:,MYNODE+1) ! MINCOORDS CONTAINS QUENCH COORDS
               ELSE
                  VMINNEW=0.0D0
                  LBFGS_ITERATIONS=0
                  EVAPREJECT=.FALSE.
                  CONVERGED=1
                  POTEL=HUGE(1.0D0)
               ENDIF
            ELSEIF (RECOUNT.AND.BSPT.AND.(VMINOLD.EQ.0.0D0).AND.(MOD(I,1.0D0*QUENCHFRQ).EQ.1.0D0*0)) THEN
!
! WE MIGHT NOT HAVE QUENCHED AT THE STEP TO BE RECOUNTED, SO WE HAVE TO DO SO HERE.
!
               IF (DEBUG) WRITE(MYUNIT, '(A,G20.10,A)') 'BSPT> RECOUNTING STEP FOR PREVIOUS CONFIGURATION WITH VMINOLD=',
     &                                     VMINOLD,' NEED TO CALL QUENCH'
               DO K=1,NATOMS
                 COORDS(3*(K-1)+1,MYNODE+1)=XO(K)
                 COORDS(3*(K-1)+2,MYNODE+1)=YO(K)
                 COORDS(3*(K-1)+3,MYNODE+1)=ZO(K)
               ENDDO
!              WRITE(MYUNIT, '(A)') 'BSPT> CALLING QUENCH FOR RECOUNT'
               IF(CHRMMT.AND.ACESOLV) NCHENCALLS=ACEUPSTEP-1
               CALL QUENCH(.FALSE.,MYNODE+1,LBFGS_ITERATIONS,DUMMY,NDUMMY,CONVERGED,COORDS(:,MYNODE+1),DOSSTATS)
               NQ(MYNODE+1)=NQ(MYNODE+1)+1
               MINCOORDS(:,MYNODE+1)=COORDS(:,MYNODE+1) ! MINCOORDS CONTAINS QUENCH COORDS
               VMINOLD=POTEL
               IF (CONVERGED.NE.1) WRITE(MYUNIT, '(A)') 'BSPT> WARNING - QUENCH DID NOT CONVERGE' 
               IF (DEBUG) WRITE(MYUNIT, '(A,G20.10)') 'BSPT> VMINOLD SET TO ',VMINOLD
            ENDIF
         ENDIF
!
! IF EITHER THE PE (VNEW) OR QUENCH ENERGY (VMINNEW) IS OUT OF RANGE OF THE HISTOGRAM
! THEN WE REJECT THE STEP AND RECOUNT THE PREVIOUS ONE.
!
         IF (BSPT.AND.(I.GT.NEQUIL+PTSTEPS).AND.(MOD(I,1.0D0*QUENCHFRQ).EQ.1.0D0*0)) THEN
            BININDEX=INT((VMINNEW-HISTMIN)/HISTINT)+1
            IF ((BININDEX.GT.HBINMAX).OR.(BININDEX.LT.HBINMIN)) THEN
               RECOUNT=.TRUE.
               NOUTQBIN=NOUTQBIN+1
            ENDIF
         ENDIF
         IBININDEX=INT((VNEW-PTEMIN)/PEINT)+1
         IF ((IBININDEX.GT.NENRPER).OR.(IBININDEX.LT.1)) THEN
            RECOUNT=.TRUE.
            NOUTPEBIN=NOUTPEBIN+1
         ENDIF

         VMINNEWSAVE=VMINNEW
         LBFGS_ITERATIONSSAVE=LBFGS_ITERATIONS
         VNEWSAVE=VNEW        ! THIS VALUE IS SAVED SO IT CAN BE PRINTED IF THE STEP IS REJECTED
         IF ((CONVERGED.NE.1).OR.EVAPREJECT) RECOUNT=.TRUE. ! REJECT AND RECOUNT
         IF (RECOUNT) THEN ! REJECT MOVE
            DO K=1, NATOMS
               X(K)=XO(K)
               Y(K)=YO(K)
               Z(K)=ZO(K)
            ENDDO
            DO K=1,NATOMS
              COORDS(3*(K-1)+1,MYNODE+1)=X(K)
              COORDS(3*(K-1)+2,MYNODE+1)=Y(K)
              COORDS(3*(K-1)+3,MYNODE+1)=Z(K)
            ENDDO
!           WRITE(MYUNIT,'(A,2G20.10)') 'BSPT> RECOUNTING VOLD,VNEW=',VOLD,VNEW                
!           WRITE(MYUNIT,'(A,2G20.10)') 'BSPT> RECOUNTING VMINOLD,VMINNEW=',VMINOLD,VMINNEW
            VMINNEW=VMINOLD
            VNEW=VOLD
            DOSSTATS(1:MAXIT,1:2)=DOSSTATSO(1:MAXIT,1:2)
            LBFGS_ITERATIONS=LBFGS_ITERATIONSO
            IF (.NOT.FITS) NOUT(MYNODE)=NOUT(MYNODE)+1
         ELSE ! ACCEPT MOVE
            NACCEPTPT(MYNODE)=NACCEPTPT(MYNODE)+1.0D0
            IACCEPT(MYNODE)=IACCEPT(MYNODE)+1
         ENDIF
         IF (.NOT.RECOUNT) THEN
            IF (MOD(I-1.0D0*1,1.0D0*PRTFRQ).EQ.1.0D0*0) WRITE(MYUNIT, '(F15.1,A,G16.6,A,G16.6,A,G16.6,A,G16.6,A,I6,A)') 
     &        I,' EN= ', VMINNEWSAVE, ' EO= ',VMINOLD, ' VN=', VNEWSAVE,' VO=',VOLD,' ITER ',LBFGS_ITERATIONSSAVE,' ACC'
         ELSE
            IF (MOD(I-1.0D0*1,1.0D0*PRTFRQ).EQ.1.0D0*0) WRITE(MYUNIT, '(F15.1,A,G16.6,A,G16.6,A,G16.6,A,G16.6,A,I6,A)') 
     &        I,' EN= ', VMINNEWSAVE, ' EO= ',VMINOLD, ' VN=', VNEWSAVE,' VO=',VOLD,' ITER ',LBFGS_ITERATIONSSAVE,' REJ'
         ENDIF
         IF (DEBUG) THEN
            CALL POTENTIAL(COORDS(:,MYNODE+1),GRAD, POTEL, .TRUE., .FALSE.)
            WRITE(MYUNIT,'(A,G20.10)') 'BSPT> POTENTIAL ENERGY AFTER ACC/REJ=',POTEL
         ENDIF
         CALL FLUSH(MYUNIT)
!
!  AT THIS POINT THE QUENCH AND INSTANTANEOUS ENERGIES FOR THE CURRENT
!  CONFIGURATION IN THE MARKOV CHAIN ARE VMINNEW AND VNEW.
!
!  QUENCHFRQ MUST BE INITIALISED TO ONE FOR PTMC TO AVOID DIVISION BY ZERO!
!
         IF (MOD(I,1.0D0*QUENCHFRQ).EQ.1.0D0*0) BININDEX=INT((VMINNEW-HISTMIN)/HISTINT)+1
         IBININDEX=INT((VNEW-PTEMIN)/PEINT)+1
!
!  MUST NOT ACCUMULATE STATISTICS UNTIL WE HAVE EQUILIBRATED FOR NEQUIL STEPS.
!
         IF (I.GT.NEQUIL) THEN
            IF (BSPT.AND.(MOD(I,1.0D0*QUENCHFRQ).EQ.1.0D0*0).AND.(I.GT.NEQUIL+PTSTEPS)) THEN 
               IF ((MOD(I, 1.0D0*SAVENTH).EQ.1.0D0*0).AND.(.NOT.RECOUNT)) THEN 
                  CALL SAVEBINSTRUCTURESMPI(POTEL,MINCOORDS(:,MYNODE+1),BININDEX,.TRUE.,MYNODE,NEWENERGY)
                  IF (NEWENERGY) THEN
                      MINIMANUMBER(BININDEX, MYNODE)=MINIMANUMBER(BININDEX, MYNODE)+1
                  ENDIF
               ENDIF
!
!  NOW DETECTED ABOVE.
!
!              IF ((BININDEX.GT.HBINMAX).OR.(BININDEX.LT.HBINMIN)) THEN
!                 WRITE(MYUNIT,'(A,I6,A,G20.10,A,I8)') 'BSPT> WARNING IN NODE ',MYNODE,
!    &                ' QUENCH ENERGY IS OUT OF RANGE, ENERGY=',VMINNEW,' WOULD BE BIN ',BININDEX
!                 NOUTQBIN=NOUTQBIN+1
!              ENDIF
            ENDIF
!
!  NOW DETECTED ABOVE.
!
!           IF ((IBININDEX.GT.NENRPER).OR.(IBININDEX.LT.1)) THEN
!              WRITE(MYUNIT,'(A,I6,A,G20.10,A,I8)') 'BSPT> WARNING IN NODE ',MYNODE,
!    &                ' POTENTIAL ENERGY IS OUT OF RANGE, ENERGY=',VNEW,' WOULD BE BIN ',IBININDEX
!              WRITE(MYUNIT,'(A,I6,A,G20.10,A,I8)') 'BSPT> NENRPER=',NENRPER
!              NOUTPEBIN=NOUTPEBIN+1
!           ENDIF
            IF (BSPT.AND.(MOD(I,1.0D0*QUENCHFRQ).EQ.1.0D0*0).AND.(I.GT.NEQUIL+PTSTEPS)) THEN
               IF ((BININDEX.GT.HBINS).OR.(BININDEX.LT.1)) GOTO 888
            ENDIF
            IF ((IBININDEX.GT.NENRPER).OR.(IBININDEX.LT.1)) GOTO 888

            PEVISITS(IBININDEX,MYNODE)=PEVISITS(IBININDEX,MYNODE)+1.0D0
            IF (BSPT.AND.(MOD(I,1.0D0*QUENCHFRQ).EQ.1.0D0*0).AND.(I.GT.NEQUIL+PTSTEPS)) THEN ! OTHERWISE BININDEX COULD BE OUT OF RANGE
               QVISITS(BININDEX,MYNODE)=QVISITS(BININDEX,MYNODE)+1.0D0
               PEVISITS2(IBININDEX,BININDEX,MYNODE)=PEVISITS2(IBININDEX,BININDEX,MYNODE)+1
            ENDIF
            IF (BSPT.AND.(MOD(I,1.0D0*QUENCHFRQ).EQ.1.0D0*0).AND.(I.GT.NEQUIL+PTSTEPS)) THEN
               DISTANCEOLD=CALCULATEDDISTANCE(COORDS(:,MYNODE+1), COORDSO(:,MYNODE+1))
               DISTANCE(BININDEX,MYNODE)=DISTANCE(BININDEX,MYNODE)+DISTANCEOLD
            ENDIF
         ENDIF
!
! IF WE ARE NOT CALCULATING DISTANCES THEN THE FOLLOWING LINES MAY BE UNNECESSARY.
!
888      DO K=1,NATOMS ! COORDS HAVE TO BE RESAVED BECAUSE WE HAVE TO USE NORESET TO BE ABLE TO CALC DISTANCE 
            COORDS(3*(K-1)+1,MYNODE+1)=X(K)
            COORDS(3*(K-1)+2,MYNODE+1)=Y(K)
            COORDS(3*(K-1)+3,MYNODE+1)=Z(K)
         ENDDO
!
!  VMINOLD IS NOW SET TO VMINNEW AND VOLD TO VNEW.
!
         VOLD=VNEW
         VMINOLD=VMINNEW 

         DOSSTATSO(1:MAXIT,1:2)=DOSSTATS(1:MAXIT,1:2)
         LBFGS_ITERATIONSO=LBFGS_ITERATIONS

         IF ((I.LE.NEQUIL).AND.(MOD(I,1.0D0*NUPDATE).EQ.1.0D0*0)) THEN ! UPDATE MC STEP SIZE IF NOT FIXED
            WAC=1.0*IACCEPT(MYNODE)/NUPDATE
            IF (.NOT.(FIXSTEP(MYNODE+1).OR.FIXBOTH(MYNODE+1))) THEN
!              IF (WAC.LT.0.4) THEN
               IF (WAC.LT.ACCRAT(MYNODE+1)-0.1D0) THEN
                  STEP(MYNODE+1)=STEP(MYNODE+1)*0.9D0
               ENDIF
!              IF (WAC.GT.0.6) THEN
               IF (WAC.GT.ACCRAT(MYNODE+1)+0.1D0) THEN
                  STEP(MYNODE+1)=STEP(MYNODE+1)*1.1D0
               ENDIF
            ENDIF
            IACCEPT(MYNODE)=0
            WRITE(MYUNIT,'(A,G20.10)') 'BSPT> MAXIMUM STEP SIZE IS NOW ',STEP(MYNODE+1)
         ENDIF
!
!  REPLICA EXCHANGE PART FOLLOWS. 

         E=VNEW
         IF (MYNODE.EQ.0) THEN
            RANDOM=DPRAND()
            J=(NPAR-1)*RANDOM
            RANDOM=DPRAND()
            IF (RANDOM.GT.EXCHPROB) THEN 
               J=-2
               EXCHANGE=.FALSE.
            ELSE
               EXCHANGE=.TRUE.
            ENDIF
         ENDIF
         CALL MPI_BCAST(J,1,MPI_INTEGER,0,MPI_COMM_WORLD,MPIERR)
!
! J IS SET TO -2 FOR NO EXCHANGE. SHOULD REALLY JUST SKIP THE NEXT PART?!
! WE TRY TO EXCHANGE WITH TRAJECTORY J+1. J STARTS FROM 0.
!
         IF (MYNODE.EQ.(J+1)) THEN
            CALL MPI_SEND(E,1,MPI_DOUBLE_PRECISION,J,0,MPI_COMM_WORLD,MPIERR)
         ENDIF
         IF (MYNODE.EQ.J) THEN
            CALL MPI_RECV(ER,1,MPI_DOUBLE_PRECISION,J+1,0,MPI_COMM_WORLD,IS,MPIERR)
            DBETA=BETA(J)-BETA(J+1)
            DELTA=E-ER
            W=MIN(1.0D0,DEXP(DELTA*DBETA))
            NTOT=NTOT+1 
            RANDOM=DPRAND()
            LESAVE=E
            IF (W.GT.RANDOM) THEN
               EXCHANGEACCEPT=.TRUE.
               IMESG=1
               CALL MPI_SEND(IMESG,1,MPI_INTEGER,J+1,0,MPI_COMM_WORLD,MPIERR)
               CALL MPI_SEND(ITRAJ,1,MPI_INTEGER,J+1,0,MPI_COMM_WORLD,MPIERR)
               CALL MPI_SEND(X,NATOMS,MPI_DOUBLE_PRECISION,J+1,1,MPI_COMM_WORLD,MPIERR)
               CALL MPI_SEND(Y,NATOMS,MPI_DOUBLE_PRECISION,J+1,1,MPI_COMM_WORLD,MPIERR)
               CALL MPI_SEND(Z,NATOMS,MPI_DOUBLE_PRECISION,J+1,1,MPI_COMM_WORLD,MPIERR)
               CALL MPI_SEND(VMINNEW,1,MPI_DOUBLE_PRECISION,J+1,1,MPI_COMM_WORLD,MPIERR)
               CALL MPI_SEND(VNEW,1,MPI_DOUBLE_PRECISION,J+1,1,MPI_COMM_WORLD,MPIERR)
               CALL MPI_SEND(DOSSTATS,2*MAXIT,MPI_DOUBLE_PRECISION,J+1,1,MPI_COMM_WORLD,MPIERR)
               CALL MPI_SEND(LBFGS_ITERATIONS,1,MPI_INTEGER,J+1,1,MPI_COMM_WORLD,MPIERR)
               CALL MPI_RECV(ITRAJ,1,MPI_INTEGER,J+1,0,MPI_COMM_WORLD,IS,MPIERR)
               CALL MPI_RECV(X,NATOMS,MPI_DOUBLE_PRECISION,J+1,1,MPI_COMM_WORLD,IS,MPIERR)
               CALL MPI_RECV(Y,NATOMS,MPI_DOUBLE_PRECISION,J+1,1,MPI_COMM_WORLD,IS,MPIERR)
               CALL MPI_RECV(Z,NATOMS,MPI_DOUBLE_PRECISION,J+1,1,MPI_COMM_WORLD,IS,MPIERR)
               CALL MPI_RECV(VMINNEW,1,MPI_DOUBLE_PRECISION,J+1,1,MPI_COMM_WORLD,IS,MPIERR)
               CALL MPI_RECV(VNEW,1,MPI_DOUBLE_PRECISION,J+1,1,MPI_COMM_WORLD,IS,MPIERR)
               CALL MPI_RECV(DOSSTATS,2*MAXIT,MPI_DOUBLE_PRECISION,J+1,1,MPI_COMM_WORLD,IS,MPIERR)
               CALL MPI_RECV(LBFGS_ITERATIONS,1,MPI_DOUBLE_PRECISION,J+1,1,MPI_COMM_WORLD,IS,MPIERR)
               E=ER
               NEACCEPT=NEACCEPT+1
               DOSSTATSO(1:MAXIT,1:2)=DOSSTATS(1:MAXIT,1:2)
               LBFGS_ITERATIONSO=LBFGS_ITERATIONS
               VMINOLD=VMINNEW ! THESE VARIABLES ARE THE SAME AT THIS POINT IN THE PROGRAM
               VOLD=VNEW
            ELSE
               EXCHANGEACCEPT=.FALSE.
               IMESG=0
               CALL MPI_SEND(IMESG,1,MPI_INTEGER,J+1,0,MPI_COMM_WORLD,MPIERR)
            ENDIF
            IF (EXCHANGEACCEPT) THEN
               IF (MOD(I-1.0D0,1.0D0*PRTFRQ).EQ.0) WRITE(MYUNIT,'(A,I5,A,G16.6,A,I5,A,G16.6,A)') 
     &                        'BSPT> EXCHANGE FROM THIS REPLICA ',J,' ENERGY ',LESAVE,
     &                                                         ' TO REPLICA ',J+1,' ENERGY ',ER,' ACC'
               IF (DEBUG) THEN
                  WRITE(MYUNIT,'(A,G20.10)') 'BSPT> INSTANTANEOUS PE IS NOW ',VOLD

                  DO K=1,NATOMS
                     COORDS(3*(K-1)+1,MYNODE+1)=X(K)
                     COORDS(3*(K-1)+2,MYNODE+1)=Y(K)
                     COORDS(3*(K-1)+3,MYNODE+1)=Z(K)
                  ENDDO
                  CALL POTENTIAL(COORDS(:,MYNODE+1),GRAD, POTEL, .TRUE., .FALSE.)
                  WRITE(MYUNIT,'(A,G20.10)') 'BSPT> RECALCULATED PE IS ',POTEL,' VNEW=',VNEW
               ENDIF

            ELSE
               IF (MOD(I-1.0D0,1.0D0*PRTFRQ).EQ.0.0D0) WRITE(MYUNIT,'(A,I5,A,G16.6,A,I5,A,G16.6,A)') 
     &                    'BSPT> EXCHANGE FROM THIS REPLICA ',J,' ENERGY ',E,' TO REPLICA ',
     &                           J+1,' ENERGY ',ER,' REJ'
            ENDIF
         ENDIF
         CALL FLUSH(MYUNIT)
         IF (MYNODE.EQ.(J+1)) THEN
            CALL MPI_RECV(IMESG,1,MPI_INTEGER,J,0,MPI_COMM_WORLD,IS,MPIERR)
            NTOT=NTOT+1
            ER=E
            IF (IMESG.EQ.1) THEN
!
!  HERE WE RECEIVE FIRST, SO WE NEED TO SAVE VARIABLES THAT WOULD OTHERWISE BE OVERWRITTEN
!  BEFORE THEY ARE SENT TO THE OTHER REPLICA. OR USE XO, YO, ZO IN THE CASE OF X, Y, Z.
!
               VOLDSAVE=VOLD
               DOSSTATSO(1:MAXIT,1:2)=DOSSTATS(1:MAXIT,1:2)
               LBFGS_ITERATIONSO=LBFGS_ITERATIONS
               CALL MPI_RECV(ITRAJO,1,MPI_INTEGER,J,0,MPI_COMM_WORLD,IS,MPIERR)
               CALL MPI_RECV(XO,NATOMS,MPI_DOUBLE_PRECISION,J,1,MPI_COMM_WORLD,IS,MPIERR)
               CALL MPI_RECV(YO,NATOMS,MPI_DOUBLE_PRECISION,J,1,MPI_COMM_WORLD,IS,MPIERR)
               CALL MPI_RECV(ZO,NATOMS,MPI_DOUBLE_PRECISION,J,1,MPI_COMM_WORLD,IS,MPIERR)
               CALL MPI_RECV(VMINOLD,1,MPI_DOUBLE_PRECISION,J,1,MPI_COMM_WORLD,IS,MPIERR)
               CALL MPI_RECV(VOLD,1,MPI_DOUBLE_PRECISION,J,1,MPI_COMM_WORLD,IS,MPIERR)
               CALL MPI_RECV(DOSSTATS,2*MAXIT,MPI_DOUBLE_PRECISION,J,1,MPI_COMM_WORLD,IS,MPIERR)
               CALL MPI_RECV(LBFGS_ITERATIONS,1,MPI_INTEGER,J,1,MPI_COMM_WORLD,IS,MPIERR)
               CALL MPI_SEND(ITRAJ,1,MPI_INTEGER,J,0,MPI_COMM_WORLD,MPIERR)
               CALL MPI_SEND(X,NATOMS,MPI_DOUBLE_PRECISION,J,1,MPI_COMM_WORLD,MPIERR)
               CALL MPI_SEND(Y,NATOMS,MPI_DOUBLE_PRECISION,J,1,MPI_COMM_WORLD,MPIERR)
               CALL MPI_SEND(Z,NATOMS,MPI_DOUBLE_PRECISION,J,1,MPI_COMM_WORLD,MPIERR)
               CALL MPI_SEND(VMINNEW,1,MPI_DOUBLE_PRECISION,J,1,MPI_COMM_WORLD,IS,MPIERR)
               CALL MPI_SEND(VNEW,1,MPI_DOUBLE_PRECISION,J,1,MPI_COMM_WORLD,IS,MPIERR)
               CALL MPI_SEND(DOSSTATSO,2*MAXIT,MPI_DOUBLE_PRECISION,J,1,MPI_COMM_WORLD,IS,MPIERR)
               CALL MPI_SEND(LBFGS_ITERATIONSO,1,MPI_DOUBLE_PRECISION,J,1,MPI_COMM_WORLD,IS,MPIERR)
               DO K=1, NATOMS
                  X(K)=XO(K)
                  Y(K)=YO(K)
                  Z(K)=ZO(K)
               ENDDO
               ITRAJ=ITRAJO
               NEACCEPT=NEACCEPT+1
               DOSSTATSO(1:MAXIT,1:2)=DOSSTATS(1:MAXIT,1:2)
               LBFGS_ITERATIONSO=LBFGS_ITERATIONS
               IF (MOD(I-1.0D0,1.0D0*PRTFRQ).EQ.0) WRITE(MYUNIT,'(A,I5,A,G16.6,A,I5,A,G16.6,A)') 
     &                     'BSPT> EXCHANGE FROM REPLICA ',MYNODE-1,' ENERGY ',VOLD,
     &                                                         ' TO THIS REPLICA ',MYNODE,' ENERGY ',VNEW,' ACC'
               VMINNEW=VMINOLD ! THESE VARIABLES ARE THE SAME AT THIS POINT IN THE PROGRAM
               VNEW=VOLD
               IF (DEBUG) THEN
                  WRITE(MYUNIT,'(2(A,G20.10))') 'BSPT> INSTANTANEOUS PE IS NOW ',VOLD,' AND VNEW=',VNEW

                  DO K=1,NATOMS
                     COORDS(3*(K-1)+1,MYNODE+1)=X(K)
                     COORDS(3*(K-1)+2,MYNODE+1)=Y(K)
                     COORDS(3*(K-1)+3,MYNODE+1)=Z(K)
                  ENDDO
                  CALL POTENTIAL(COORDS(:,MYNODE+1),GRAD, POTEL, .TRUE., .FALSE.)
                  WRITE(MYUNIT,'(A,G20.10)') 'BSPT> RECALCULATED PE IS ',POTEL
               ENDIF

            ELSE
               IF (MOD(I-1.0D0,1.0D0*PRTFRQ).EQ.0.0D0) WRITE(MYUNIT,'(A,I5,A,I5,A,G16.6,A)') 
     &                   'BSPT> EXCHANGE FROM      REPLICA ',MYNODE-1,
     &                   ' ENERGY NOT AVAILABLE TO THIS REPLICA ',MYNODE,' ENERGY ',VOLD,' REJ'
            ENDIF
         ENDIF

!        IF (PTMC) VOLD=E
!        IF (BSPT) VMINOLD=E
!        VOLD=E

         IF (I.GT.NEQUIL) THEN 
            EAV(MYNODE)=EAV(MYNODE)+E
            EAV2(MYNODE)=EAV2(MYNODE)+E**2
            IQE=INT((E-PTEMIN)/DHISTE+1)
            IF (IQE.GT.0.AND.IQE.LT.NHISTE) THEN
               NHISTQE(IQE,MYNODE)=NHISTQE(IQE,MYNODE)+1
            ENDIF
            DO K=1,NATOMS
               Q(1,K)=X(K)
               Q(2,K)=Y(K)
               Q(3,K)=Z(K)
            ENDDO
            IF (PERIODIC) THEN
               CALL QORDER_BLJ(Q,Q4,Q6)
            ELSE IF (CHRMMT) THEN
                 IF (ODIHET) CALL CHCALCDIHE(DIHEORDERPARAM,COORDS(1:3*NATOMS,MYNODE+1))
                 IF (OSASAT) CALL ORDER_SASA(SASAORDERPARAM,RPRO,COORDS(1:3*NATOMS:3,MYNODE+1),
     1                   COORDS(2:3*NATOMS:3,MYNODE+1),COORDS(3:3*NATOMS:3,MYNODE+1))
                 IF (ORGYT) CALL CHCALCRGYR(RGYR,COORDS(1:3*NATOMS:3,MYNODE+1),
     1                   COORDS(2:3*NATOMS:3,MYNODE+1),COORDS(3:3*NATOMS:3,MYNODE+1),.FALSE.) 
                 IF (OEINTT) CALL CHCALCEINT(EINT,COORDS(1:3*NATOMS:3,MYNODE+1),
     1                   COORDS(2:3*NATOMS:3,MYNODE+1),COORDS(3:3*NATOMS:3,MYNODE+1),POTEL)
            ELSE
               CALL QORDER_LJ(Q,Q4,Q6)
            ENDIF
            Q4AV(MYNODE)=Q4AV(MYNODE)+Q4
            Q4AV2(MYNODE)=Q4AV2(MYNODE)+Q4**2
            Q6AV(MYNODE)=Q6AV(MYNODE)+Q6
            Q6AV2(MYNODE)=Q6AV2(MYNODE)+Q6**2

            DIHEORDERPARAM_AV(MYNODE)=DIHEORDERPARAM_AV(MYNODE)+DIHEORDERPARAM
            DIHEORDERPARAM_AV2(MYNODE)=DIHEORDERPARAM_AV2(MYNODE)+DIHEORDERPARAM**2
            SASAORDERPARAM_AV(MYNODE)=SASAORDERPARAM_AV(MYNODE)+SASAORDERPARAM
            SASAORDERPARAM_AV2(MYNODE)=SASAORDERPARAM_AV2(MYNODE)+SASAORDERPARAM**2
            RGYR_AV(MYNODE)=RGYR_AV(MYNODE)+RGYR
            RGYR_AV2(MYNODE)=RGYR_AV2(MYNODE)+RGYR**2
            EINT_AV(MYNODE)=EINT_AV(MYNODE)+EINT
            EINT_AV2(MYNODE)=EINT_AV2(MYNODE)+EINT**2
            IF (CHRMMT) THEN
               IF (ODIHET) THEN
                  IQ4=INT((DIHEORDERPARAM-DIHEORDERPARAM_MIN)/DDIHE+1)
                  IF (IQ4.GT.0.AND.IQ4.LT.NHIST) THEN
                     NHISTQ4(IQ4,MYNODE)=NHISTQ4(IQ4,MYNODE)+1
                  ENDIF
                  IQ6=INT((SASAORDERPARAM-SASAORDERPARAM_MIN)/DSASA+1)             
                  IF (IQ6.GT.0.AND.IQ6.LT.NHIST) THEN
                     NHISTQ6(IQ6,MYNODE)=NHISTQ6(IQ6,MYNODE)+1
                  ENDIF
               ELSE IF (ORGYT) THEN
                  IQ4=INT((RGYR-RGYR_MIN)/DRGYR+1)
                  IF (IQ4.GT.0.AND.IQ4.LT.NHIST) THEN
                     NHISTQ4(IQ4,MYNODE)=NHISTQ4(IQ4,MYNODE)+1
                  ENDIF
                  IQ6=INT((EINT-EINT_MIN)/DEINT+1)             
                  IF (IQ6.GT.0.AND.IQ6.LT.NHIST) THEN
                     NHISTQ6(IQ6,MYNODE)=NHISTQ6(IQ6,MYNODE)+1
                  ENDIF
               ENDIF 
            ELSE
               IQ4=INT(Q4/DQ4+1)
               IF (IQ4.GT.0.AND.IQ4.LT.NHIST) THEN
                  NHISTQ4(IQ4,MYNODE)=NHISTQ4(IQ4,MYNODE)+1
               ENDIF
               IQ6=INT(Q6/DQ6+1)             
               IF (IQ6.GT.0.AND.IQ6.LT.NHIST) THEN
                  NHISTQ6(IQ6,MYNODE)=NHISTQ6(IQ6,MYNODE)+1
               ENDIF
            ENDIF

! FREE ENERGY STATISTIC

            IF (IQ4.GT.0.AND.IQ4.LT.NHIST.AND.IQ6.GT.0.AND.IQ6.LT.NHIST) THEN
               NHISTALLQ(IQ4,IQ6,MYNODE)=NHISTALLQ(IQ4,IQ6,MYNODE)+1
            ENDIF
            IF (IQ4.GT.0.AND.IQ4.LT.NHIST.AND.IQ6.GT.0.AND.IQ6.LT.NHIST.AND.
     1         IQE.GT.0.AND.IQE.LT.NHISTE) THEN
               NHISTGRAND(IQE,IQ4,IQ6,MYNODE)=NHISTGRAND(IQE,IQ4,IQ6,MYNODE)+1
            ENDIF
              
            IENR=IENR+1
!
! DUMP VISITS HISTOGRAMS. 
! 
            IF (BSPTDUMPFRQ.GT.0) THEN
               IF (MOD(I,1.0D0*BSPTDUMPFRQ).EQ.1.0D0*0) THEN
                  WRITE (ISTR, '(I2,A1)') MYNODE, '.'
                  WRITE (SDUMMY, '(F15.1)') I
                  ISTR=TRIM(ADJUSTL(ISTR)) // TRIM(ADJUSTL(SDUMMY))
                  IF (I.GT.NEQUIL) THEN
                     FILENAME101="VISITS.HIS."//TRIM(ADJUSTL(ISTR))
                     OPEN(UNIT=1986+MYNODE,FILE=FILENAME101, STATUS="UNKNOWN", FORM="FORMATTED")
                     WRITE(1986+MYNODE, '(G20.10)') TEMPTRAJ(MYNODE)
                     WRITE(1986+MYNODE, '(A)') 'VISITS TO INSTANTANEOUS PE BINS WITHOUT QUENCH CONTRIBUTIONS'
                     DO K=1, NENRPER
                        WRITE(1986+MYNODE, '(G20.10,F20.1)') PTEMIN+(K-1)*PEINT,PEVISITS(K,MYNODE)
                     ENDDO
                     WRITE(1986+MYNODE, '(A)') 'VISITS TO QUENCH BINS'
                     DO K=1, HBINS
                          WRITE(1986+MYNODE, '(G20.10,F20.1)') BINLABEL(K), QVISITS(K,MYNODE)
                     ENDDO
                     CLOSE(1986+MYNODE)
                  ENDIF

                  IF (BSPT.AND.(I.GT.NEQUIL+PTSTEPS)) THEN
                     FILENAME101="VISITS2.HIS."//TRIM(ADJUSTL(ISTR))
                     OPEN(UNIT=1986+MYNODE,FILE=FILENAME101,STATUS="UNKNOWN",FORM="UNFORMATTED")
                     WRITE(1986+MYNODE) PEVISITS2(1:NENRPER,1:HBINS,MYNODE)
                     CLOSE(1986+MYNODE)
                  ENDIF
!
!  RESTART INFORMATION
!
                  WRITE (ISTR,'(I2)') MYNODE
                  FILENAME9="BSPTRESTART."//TRIM(ADJUSTL(ISTR))
                  OPEN(UNIT=1985+MYNODE,FILE=FILENAME9, STATUS="UNKNOWN", FORM="FORMATTED")
                  WRITE(1985+MYNODE,'(F20.1,3G20.10,F15.1,5I15)') I,VOLD,VMINOLD,STEP(MYNODE+1),
     &                                                NACCEPTPT(MYNODE),NEACCEPT,NTOT,NOUTQBIN,NOUTPEBIN,NQ(MYNODE+1)
                  DO J1=1,NATOMS
                     WRITE(1985+MYNODE,'(3G25.15)') X(J1),Y(J1),Z(J1)
                  ENDDO
                  CLOSE(1985+MYNODE)
               ENDIF
            ENDIF
         ENDIF
      ENDDO 
 
! END OF MAIN LOOP OVER BSPT OR PT STEPS.
 
! COMPUTE THE AVERAGES

      EAV(MYNODE)=EAV(MYNODE)/PTSTEPS
      EAV2(MYNODE)=EAV2(MYNODE)/PTSTEPS
      CV=(EAV2(MYNODE)-EAV(MYNODE)**2)*BETA(MYNODE)**2

      WRITE (ISTR, '(I10)') MYNODE+1
      FILENAME3="T.EV.CV.EV2.STEPS."//TRIM(ADJUSTL(ISTR))
      OPEN(UNIT=41+MYNODE,FILE=FILENAME3, STATUS="UNKNOWN", FORM="FORMATTED")
      IF (CHRMMT) THEN
         WRITE(41+MYNODE,'(6G20.10)') TEMPTRAJ(MYNODE),TEMPTRAJ(MYNODE)/0.001987, 
     &                                EAV(MYNODE), CV, EAV2(MYNODE),PTSTEPS
      ELSE
         WRITE(41+MYNODE,'(5G20.10)') TEMPTRAJ(MYNODE),EAV(MYNODE),CV, EAV2(MYNODE),PTSTEPS
      ENDIF
      CALL FLUSH(41+MYNODE)
      CLOSE(41+MYNODE)

      Q4AV(MYNODE)=Q4AV(MYNODE)/PTSTEPS
      Q6AV(MYNODE)=Q6AV(MYNODE)/PTSTEPS
      Q4AV2(MYNODE)=Q4AV2(MYNODE)/PTSTEPS
      Q6AV2(MYNODE)=Q6AV2(MYNODE)/PTSTEPS
      DIHEORDERPARAM_AV(MYNODE)=DIHEORDERPARAM_AV(MYNODE)/PTSTEPS
      SASAORDERPARAM_AV(MYNODE)=SASAORDERPARAM_AV(MYNODE)/PTSTEPS
      DIHEORDERPARAM_AV2(MYNODE)=DIHEORDERPARAM_AV2(MYNODE)/PTSTEPS
      SASAORDERPARAM_AV2(MYNODE)=SASAORDERPARAM_AV2(MYNODE)/PTSTEPS
      RGYR_AV(MYNODE)=RGYR_AV(MYNODE)/PTSTEPS
      EINT_AV(MYNODE)=EINT_AV(MYNODE)/PTSTEPS
      RGYR_AV2(MYNODE)=RGYR_AV2(MYNODE)/PTSTEPS
      EINT_AV2(MYNODE)=EINT_AV2(MYNODE)/PTSTEPS
      FQ4=SQRT(Q4AV2(MYNODE)-Q4AV(MYNODE)**2)
      FQ6=SQRT(Q6AV2(MYNODE)-Q6AV(MYNODE)**2)
      IF (BINARY) THEN  
         FILENAME4="T.Q4AV.Q6AV.Q4AV2.Q6AV2.STEPS."//TRIM(ADJUSTL(ISTR))
         OPEN(UNIT=1980,FILE=FILENAME4, STATUS="UNKNOWN", FORM="FORMATTED")
         WRITE(1980,'(6G20.10)') TEMPTRAJ(MYNODE), Q4AV(MYNODE), Q6AV(MYNODE), Q4AV2(MYNODE),Q6AV2(MYNODE), PTSTEPS
         CLOSE(1980)
      ENDIF
      IF (CHRMMT) THEN 
         IF (ODIHET) THEN 
            FILENAME4="T.DIHEAV.SASAAV.DIHEAV2.SASAAV2.STEPS."//TRIM(ADJUSTL(ISTR))
            OPEN(UNIT=1980,FILE=FILENAME4, STATUS="UNKNOWN", FORM="FORMATTED")
            WRITE(1980,'(6G20.10)') TEMPTRAJ(MYNODE), DIHEORDERPARAM_AV(MYNODE), 
     &              SASAORDERPARAM_AV(MYNODE), DIHEORDERPARAM_AV2(MYNODE),SASAORDERPARAM_AV2(MYNODE), PTSTEPS
            CLOSE(1980)
            ELSE IF (ORGYT) THEN
            FILENAME4="T.RGYRAV.EINTAV.RGYRAV2.EINT2.STEPS."//TRIM(ADJUSTL(ISTR))
            OPEN(UNIT=1980,FILE=FILENAME4, STATUS="UNKNOWN", FORM="FORMATTED")
            WRITE(1980,'(6G20.10)') TEMPTRAJ(MYNODE), RGYR_AV(MYNODE),EINT_AV(MYNODE), RGYR_AV2(MYNODE),  
     &              EINT_AV2(MYNODE), PTSTEPS
            CLOSE(1980)
         ENDIF
      ENDIF

      FILENAME5="PROFILE_E."//TRIM(ADJUSTL(ISTR)) 
      OPEN(UNIT=1981,FILE=FILENAME5, STATUS="UNKNOWN", FORM="FORMATTED")
      DO K=1,NHISTE
         WRITE(1981,'(2G20.10)') PTEMIN+(K-1)*DHISTE,NHISTQE(K,MYNODE)
      ENDDO
      CLOSE(1981)

      IF (BINARY) THEN
         FILENAME6="PROFILE_Q4."//TRIM(ADJUSTL(ISTR))
         FILENAME7="PROFILE_Q6."//TRIM(ADJUSTL(ISTR))
         OPEN(UNIT=1982,FILE=FILENAME6, STATUS="UNKNOWN", FORM="FORMATTED")
         OPEN(UNIT=1983,FILE=FILENAME7, STATUS="UNKNOWN", FORM="FORMATTED")
         DO K=1,NHIST
            WRITE(1982,'(2G20.10)') (K-1)*DQ4,NHISTQ4(K,MYNODE)
            WRITE(1983,'(2G20.10)') (K-1)*DQ6,NHISTQ6(K,MYNODE)
         ENDDO
         CLOSE(1982)
         CLOSE(1983)
      ELSE IF (CHRMMT) THEN
         IF (ODIHET) THEN
            FILENAME6="PROFILE_DIHE."//TRIM(ADJUSTL(ISTR))
            FILENAME7="PROFILE_SASA."//TRIM(ADJUSTL(ISTR))
            OPEN(UNIT=1982,FILE=FILENAME6, STATUS="UNKNOWN", FORM="FORMATTED")
            OPEN(UNIT=1983,FILE=FILENAME7, STATUS="UNKNOWN", FORM="FORMATTED")
            DO K=1,NHIST
               WRITE(1982,'(2G20.10)') DIHEORDERPARAM_MIN+(K-1)*DDIHE,NHISTQ4(K,MYNODE)
               WRITE(1983,'(2G20.10)') SASAORDERPARAM_MIN+(K-1)*DSASA,NHISTQ6(K,MYNODE)
            ENDDO
            CLOSE(1982)
            CLOSE(1983)
         ELSE IF (ORGYT) THEN
            FILENAME6="PROFILE_RGYR."//TRIM(ADJUSTL(ISTR))
            FILENAME7="PROFILE_EINT."//TRIM(ADJUSTL(ISTR))
            OPEN(UNIT=1982,FILE=FILENAME6, STATUS="UNKNOWN", FORM="FORMATTED")
            OPEN(UNIT=1983,FILE=FILENAME7, STATUS="UNKNOWN", FORM="FORMATTED")
            DO K=1,NHIST
               WRITE(1982,'(2G20.10)') RGYR_MIN+(K-1)*DRGYR,NHISTQ4(K,MYNODE)
               WRITE(1983,'(2G20.10)') EINT_MIN+(K-1)*DEINT,NHISTQ6(K,MYNODE)
            ENDDO
            CLOSE(1982)
            CLOSE(1983)
         ENDIF
      ENDIF

      WRITE(MYUNIT, '(A,F15.1,A,G15.1,A,F15.5,A)') 'BSPT> ',NACCEPTPT(MYNODE), ' STEPS ACCEPTED OUT OF ', 
     &            PTSTEPS+NEQUIL+NQUENCH, ' I.E. ',NACCEPTPT(MYNODE)*100.0D0/(PTSTEPS+NEQUIL+NQUENCH),'%'
      WRITE(MYUNIT, '(A,G20.10)') 'BSPT> FINAL STEPSIZE ', STEP(MYNODE+1)
      WRITE(MYUNIT, '(A,G20.10,A,G20.10)') 'BSPT> ',NEACCEPT, ' PT EXCHANGES ACCEPTED OUT OF ', NTOT
      IF (BSPT) WRITE(MYUNIT, '(A,G20.10,A,G20.10,A)') 'BSPT> ',NOUTQBIN, ' QUENCHES OUTSIDE QUENCH BIN RANGE: ',
     &                                      NOUTQBIN*100.0D0/(NQUENCH),' %'
      WRITE(MYUNIT, '(A,I8,A,G20.10,A)') 'BSPT> ',NOUTPEBIN, ' POTENTIAL ENERGIES OUTSIDE BIN RANGE: ',
     &                                      NOUTPEBIN*100.0D0/(PTSTEPS+NEQUIL+NQUENCH),' %'
      WRITE(MYUNIT, '(A,I8)') 'BSPT> TOTAL NUMBER OF QUENCHES CTUALLY REQUIRED=',NQ(MYNODE+1)

      DO K=1,NATOMS
         Q(1,K)=X(K)
         Q(2,K)=Y(K)
         Q(3,K)=Z(K)
      ENDDO
      IF (PERIODIC) THEN
         CALL QORDER_BLJ(Q,Q4,Q6)
      ELSE
         CALL QORDER_LJ(Q,Q4,Q6)
      ENDIF

!     IF (PTMC) THEN
!        WRITE (ISTR, '(I10)') MYNODE+1
!        FILENAME5="FREEENSTATHISTO1.HISTO2."//TRIM(ADJUSTL(ISTR)) 
!        OPEN(UNIT=747+MYNODE,FILE=FILENAME5, STATUS="UNKNOWN", FORM="FORMATTED")
!           DO J=1,NHIST
!              DO I=1,NHIST
!                  WRITE(747+MYNODE,'(G20.10)') NHISTALLQ(I,J,MYNODE)
!              ENDDO
!           ENDDO
!        CLOSE(747+MYNODE)
!        WRITE (ISTR, '(I10)') MYNODE+1
!        FILENAME12="FREEENSTATHISTE.HISTO1.HISTO2."//TRIM(ADJUSTL(ISTR))
!        OPEN(UNIT=447+MYNODE,FILE=FILENAME12, STATUS="UNKNOWN", FORM="FORMATTED")
!        DO K=1,NHISTE
!           DO J=1,NHIST
!              DO I=1,NHIST
!                 IF (NHISTGRAND(K,I,J,MYNODE).NE.0) THEN
!                 WRITE(447+MYNODE,'(4I10)') K,I,J,NHISTGRAND(K,I,J,MYNODE)
!                 ENDIF
!              ENDDO
!           ENDDO
!        ENDDO
!        CLOSE(447+MYNODE)
!     ENDIF
!
! DUMP VISITS HISTOGRAMS. ENERGIES ARE WRITTEN FOR THE MIDDLE OF THE BINS.
! THIS IS THE REALLY IMPORTANT PART!
!
      WRITE (ISTR, '(I10)') MYNODE 
      FILENAME101="VISITS.HIS."//TRIM(ADJUSTL(ISTR))
      OPEN(UNIT=1986+MYNODE,FILE=FILENAME101, STATUS="UNKNOWN", FORM="FORMATTED")
      WRITE(1986+MYNODE, '(G20.10)') TEMPTRAJ(MYNODE)
      WRITE(1986+MYNODE, '(A)') 'VISITS TO INSTANTANEOUS PE BINS WITHOUT QUENCH CONTRIBUTIONS'
      DO K=1, NENRPER
         WRITE(1986+MYNODE, '(G20.10,F20.1)') PTEMIN+(K-1)*PEINT,PEVISITS(K,MYNODE)
      ENDDO
      WRITE(1986+MYNODE, '(A)') 'VISITS TO QUENCH BINS'
      DO K=1, HBINS
           WRITE(1986+MYNODE, '(G20.10,F20.1)') BINLABEL(K), QVISITS(K,MYNODE)
      ENDDO
      CLOSE(1986+MYNODE)

      IF (BSPT) THEN
         FILENAME101="VISITS2.HIS."//TRIM(ADJUSTL(ISTR))
         OPEN(UNIT=1986+MYNODE,FILE=FILENAME101,STATUS="UNKNOWN",FORM="UNFORMATTED")
         WRITE(1986+MYNODE) PEVISITS2(1:NENRPER,1:HBINS,MYNODE)
         CLOSE(1986+MYNODE)
      ENDIF
!
! DUMP FINAL RESTART INFORMATION.
!
      WRITE (ISTR,'(I2)') MYNODE
      FILENAME9="BSPTRESTART."//TRIM(ADJUSTL(ISTR))
      OPEN(UNIT=1985+MYNODE,FILE=FILENAME9, STATUS="UNKNOWN", FORM="FORMATTED")
      WRITE(1985+MYNODE,'(F20.1,3G20.10,F15.1,5I10)') I,VOLD,VMINOLD,STEP(MYNODE+1),
     &                                          NACCEPTPT(MYNODE),NEACCEPT,NTOT,NOUTQBIN,NOUTPEBIN,NQ(MYNODE+1)
      DO J1=1,NATOMS
         WRITE(1985+MYNODE,'(3G25.15)') X(J1),Y(J1),Z(J1)
      ENDDO
      CLOSE(1985+MYNODE)

      RETURN
!OP226 END MPI SECTION }}}
#ELSE
      RETURN
#ENDIF
      END SUBROUTINE PTBASINSAMPLING
