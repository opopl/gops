!  GMIN: A PROGRAM FOR FINDING GLOBAL MINIMA
!  COPYRIGHT (C) 1999-2006 DAVID J. WALES
!  THIS FILE IS PART OF GMIN.
!
!  GMIN IS FREE SOFTWARE; YOU CAN REDISTRIBUTE IT AND/OR MODIFY
!  IT UNDER THE TERMS OF THE GNU GENERAL PUBLIC LICENSE AS PUBLISHED BY
!  THE FREE SOFTWARE FOUNDATION; EITHER VERSION 2 OF THE LICENSE, OR
!  (AT YOUR OPTION) ANY LATER VERSION.
!
!  GMIN IS DISTRIBUTED IN THE HOPE THAT IT WILL BE USEFUL,
!  BUT WITHOUT ANY WARRANTY; WITHOUT EVEN THE IMPLIED WARRANTY OF
!  MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.  SEE THE
!  GNU GENERAL PUBLIC LICENSE FOR MORE DETAILS.
!
!  YOU SHOULD HAVE RECEIVED A COPY OF THE GNU GENERAL PUBLIC LICENSE
!  ALONG WITH THIS PROGRAM; IF NOT, WRITE TO THE FREE SOFTWARE
!  FOUNDATION, INC., 59 TEMPLE PLACE, SUITE 330, BOSTON, MA  02111-1307  USA
!
! OBJECTIVE - TO SYMMETRISE A SET OF INPUT COORDINATES USING A
! CONTINUOUS SYMMETRY MEASURE AND CONSTRUCTING THE CLOSEST STRUCTURE WITH
! THE POINT GROUP IN QUESTION. IN FACT, THIS AVERAGED STRUCTURE MAY NOT HAVE 
! THE EXACT POINT GROUP BECAUSE WE DO NOT INSIST THAT THE PERMUTATIONS
! CORRESPONDING TO MINIMUM DISTANCES ARE THEMSELVES ORGANISED SYMMETRICALLY. 
!
SUBROUTINE SYMMETRYCSM(JP,SCREENC,QDONE,BRUN,ITERATIONS,TIME,CHANGEDE,NSYMCALL, &
  &         LNQUENCH,EBEST,BESTCOORDS,JBEST)

USE COMMONS
USE PORFUNCS
IMPLICIT NONE
DOUBLE PRECISION :: LCOORDS(3*NATOMS), T0, SCREENC(3*NATOMS), LEBEST, QBEST(3*NATOMS), VATBEST(NATOMS), VATORIG(NATOMS), POO
DOUBLE PRECISION :: TIME, EBEST(NPAR), BESTCOORDS(3*NATOMS,NPAR), POTEL, CSMBEST, OLCOORDS(3*NATOMS), CSMSTEP, EREAL
DOUBLE PRECISION :: DUMMY(3*NATOMS), CSMIMAGESSAVE(3*NATOMS*CSMGPINDEX), CSMPMATSAVE(3,3), CSMEBEST
DOUBLE PRECISION :: XTEMP(3*NATOMS), CSMVALUE, RANDOM, ANGLE, COST, SINT, TY, TZ, TX, DPRAND, CSMRMS, RMAT(3,3), DIST2
DOUBLE PRECISION :: QORIG(3*NATOMS), ASTEPSAVE, CSMAVNEW(3*NATOMS), GSAVE(3*NATOMS), AA(3)
INTEGER :: ISTAT, LNQUENCH, JP, BRUN,QDONE,JBEST(NPAR), ITERATIONS, J1, J2, CSMIT, J3, NDONE
LOGICAL :: CHANGEDE, LDEBUG
INTEGER :: NQTOT, NQTOTSAVE, NSYMCALL
COMMON /MYPOT/ POTEL
COMMON /TOT/ NQTOT

LDEBUG=DEBUG
LDEBUG=.TRUE.
NSYMCALL=NSYMCALL+1   ! NSYMCALL SHOULD BE THE NUMBER OF CONSECUTIVE CALLS TO SYMMETRY WITH THIS MINIMUM
! PRINT '(A,5I)','NSYMCALL,NORDER,NORBIT,LASTORBIT,NORBIT-LASTORBIT+1=',NSYMCALL,NORDER,NORBIT,LASTORBIT,NORBIT-LASTORBIT+1
! IF (NSYMCALL.GT.1) THEN
!    IF (NSYMCALL.GT.1) THEN
!       IF (LDEBUG) WRITE(MYUNIT, '(A)') 'MAXIMUM CONSECUTIVE CALLS TO SYMMETRY REACHED FOR THIS MINIMUM'
!       RETURN 
!    ENDIF
! ENDIF
NSYMREM=0
CHANGEDE=.FALSE.
CSMEBEST=EPREV(JP)
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! ACCEPT THE CSM MINIMISED GEOMETRY WHATEVER!
! CSMEBEST=1.0D100
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
QBEST(1:3*NATOMS)=COORDS(1:3*NATOMS,JP)
VATBEST(1:NATOMS)=VAT(1:NATOMS,JP)
NQTOTSAVE=NQTOT
LCOORDS(1:3*NATOMS)=COORDS(1:3*NATOMS,JP)
VATORIG(1:NATOMS)=VAT(1:NATOMS,JP)
QORIG(1:3*NATOMS)=COORDS(1:3*NATOMS,JP)
!
!  SINCE THE STRUCTURE IN COORDS IS CHANGING WE NEED TO RECALCULATE THE 
!  NORMALISATION.
!

CSMNORM=0.0D0
DO J1=1,NATOMS
   CSMNORM=CSMNORM+LCOORDS(3*(J1-1)+1)**2+LCOORDS(3*(J1-1)+2)**2+LCOORDS(3*(J1-1)+3)**2
ENDDO
CSMNORM=2*CSMGPINDEX*CSMNORM

!
!  (1) FIRST DO CSMSTEPS OF BASIN-HOPPING FOR THE CSM VALUE OF THE GIVEN POINT GROUP.
!      ACCEPT DOWNHILL MOVES ONLY.
!  (2) THEN DO CSMRELAX BASIN-HOPPING STEPS TO RELAX THE AVERAGED STRUCTURE, WHICH
!      IDEALLY HAS THE GIVEN POINT GROUP SYMMETRY (BUT PROBABLY DOESN;T).
!  (3) ACCEPT/REJECT LOWEST ENERGY STRUCTURE FOUND ACCORDING TO USUAL METROPOLIS CONDITION.
!

CSMBEST=1.0D100
OLCOORDS(1:3*NATOMS)=LCOORDS(3*NATOMS)
CSMSTEP=0.5D0
DO J2=1,CSMSTEPS
   IF (PERMDIST) THEN
      DO J1=1,CSMGPINDEX
         XTEMP(1:3*NATOMS)=LCOORDS(1:3*NATOMS)
         CALL CSMROT(XTEMP,DUMMY,1,J1)
         CALL MINPERMDIST(XTEMP,DUMMY,NATOMS,DEBUG,BOXLX,BOXLY,BOXLZ,PERIODIC,TWOD,EREAL,DIST2,RIGID,RMAT)
         CALL CSMROT(DUMMY,XTEMP,-1,J1) ! NEED TO ROTATE THE PERMUTED ROTATED IMAGES BACK TO THE REFERENCE ORIENTATION
         CSMIMAGES(1+3*NATOMS*(J1-1):3*NATOMS*J1)=XTEMP(1:3*NATOMS)
      ENDDO
   ELSE
      DO J1=1,CSMGPINDEX
         CSMIMAGES(1+3*NATOMS*(J1-1):3*NATOMS*J1)=LCOORDS(1:3*NATOMS)
      ENDDO
   ENDIF
   CALL CSMMIN(LCOORDS,CSMVALUE,CSMRMS,CSMIT)
   IF (CSMVALUE.LT.CSMBEST) THEN
      CSMBEST=CSMVALUE
      IF (LDEBUG) WRITE(MYUNIT,'(A,I6,A,G20.10,A,I6)') 'SYMMETRIZECSM> ACCEPTED CSM GEOMETRY ',J2,' FOR CSM=', &
 &                                                     CSMVALUE,' ITERATIONS=',CSMIT
      OLCOORDS(1:3*NATOMS)=LCOORDS(1:3*NATOMS)
      CSMIMAGESSAVE(1:3*NATOMS*CSMGPINDEX)=CSMIMAGES(1:3*NATOMS*CSMGPINDEX)
      CSMPMATSAVE(1:3,1:3)=CSMPMAT(1:3,1:3)
   ELSE
      IF (LDEBUG) WRITE(MYUNIT,'(A,I6,A,G20.10,A,I6)') 'SYMMETRIZECSM> REJECTED CSM GEOMETRY ',J2,' FOR CSM=', &
 &                                                     CSMVALUE,' ITERATIONS=',CSMIT
      LCOORDS(1:3*NATOMS)=OLCOORDS(1:3*NATOMS)
   ENDIF
   IF (CSMVALUE.LT.1.0D-6) EXIT ! WE CAN;T DO BETTER THAN EXACT SYMMETRY!
   RANDOM=(DPRAND()-0.5D0)*2.0D0
   ANGLE=RANDOM*CSMSTEP ! IN RADIANS
   COST=COS(ANGLE)
   SINT=SIN(ANGLE)
!
! RANDOM ROTATION ABOUT THE X AXIS.
!
   DO J1=1,NATOMS
      TY= COST*LCOORDS(3*(J1-1)+2)+SINT*LCOORDS(3*(J1-1)+3)
      TZ=-SINT*LCOORDS(3*(J1-1)+2)+COST*LCOORDS(3*(J1-1)+3)
      LCOORDS(3*(J1-1)+2)=TY
      LCOORDS(3*(J1-1)+3)=TZ
   ENDDO
   RANDOM=(DPRAND()-0.5D0)*2.0D0
   ANGLE=RANDOM*CSMSTEP ! IN RADIANS
   COST=COS(ANGLE)
   SINT=SIN(ANGLE)
!
! RANDOM ROTATION ABOUT THE Y AXIS.
!
   DO J1=1,NATOMS
      TX= COST*LCOORDS(3*(J1-1)+1)+SINT*LCOORDS(3*(J1-1)+3)
      TZ=-SINT*LCOORDS(3*(J1-1)+1)+COST*LCOORDS(3*(J1-1)+3)
      LCOORDS(3*(J1-1)+1)=TX
      LCOORDS(3*(J1-1)+3)=TZ
   ENDDO
!
! RANDOM ROTATION ABOUT THE Z AXIS.
! 
   RANDOM=(DPRAND()-0.5D0)*2.0D0
   ANGLE=RANDOM*CSMSTEP ! IN RADIANS
   COST=COS(ANGLE)
   SINT=SIN(ANGLE)
   DO J1=1,NATOMS
      TX= COST*LCOORDS(3*(J1-1)+1)+SINT*LCOORDS(3*(J1-1)+2)
      TY=-SINT*LCOORDS(3*(J1-1)+1)+COST*LCOORDS(3*(J1-1)+2)
      LCOORDS(3*(J1-1)+1)=TX
      LCOORDS(3*(J1-1)+2)=TY
   ENDDO
ENDDO
!
! CONSTRUCT AVERAGED GEOMETRY FROM THE ORIENTATION WITH THE LOWEST CSM.
!
CSMIMAGES(1:3*NATOMS*CSMGPINDEX)=CSMIMAGESSAVE(1:3*NATOMS*CSMGPINDEX)
CSMPMAT(1:3,1:3)=CSMPMATSAVE(1:3,1:3)
CSMAV(1:3*NATOMS)=0.0D0
DO J2=1,CSMGPINDEX
! 
! ROTATE PERMUTED IMAGE TO BEST ORIENTATION WITH CSMPMAT
! APPLY POINT GROUP OPERATION J2
!
   DO J3=1,NATOMS
      XTEMP(3*(J3-1)+1)=CSMPMAT(1,1)*CSMIMAGES(3*NATOMS*(J2-1)+3*(J3-1)+1) &
  &                    +CSMPMAT(1,2)*CSMIMAGES(3*NATOMS*(J2-1)+3*(J3-1)+2) &
  &                    +CSMPMAT(1,3)*CSMIMAGES(3*NATOMS*(J2-1)+3*(J3-1)+3)
      XTEMP(3*(J3-1)+2)=CSMPMAT(2,1)*CSMIMAGES(3*NATOMS*(J2-1)+3*(J3-1)+1) &
  &                    +CSMPMAT(2,2)*CSMIMAGES(3*NATOMS*(J2-1)+3*(J3-1)+2) &
  &                    +CSMPMAT(2,3)*CSMIMAGES(3*NATOMS*(J2-1)+3*(J3-1)+3)
      XTEMP(3*(J3-1)+3)=CSMPMAT(3,1)*CSMIMAGES(3*NATOMS*(J2-1)+3*(J3-1)+1) &
  &                    +CSMPMAT(3,2)*CSMIMAGES(3*NATOMS*(J2-1)+3*(J3-1)+2) &
  &                    +CSMPMAT(3,3)*CSMIMAGES(3*NATOMS*(J2-1)+3*(J3-1)+3)
   ENDDO
   CALL CSMROT(XTEMP,DUMMY,1,J2)
   CSMAV(1:3*NATOMS)=CSMAV(1:3*NATOMS)+DUMMY(1:3*NATOMS)
ENDDO
CSMAV(1:3*NATOMS)=CSMAV(1:3*NATOMS)/CSMGPINDEX
! IF (LDEBUG) THEN
!     OPEN(UNIT=1,FILE='CSMAV_STRUCTURES.XYZ',STATUS='UNKNOWN')
!    WRITE(1,'(I6)') NATOMS
!    WRITE(1,'(A,I6)') 'COORDINATES AFTER QUENCH ',NQ(JP)-1
!    WRITE(1,'(A3,3G20.10)') ('LA ',LCOORDS(3*(J1-1)+1),LCOORDS(3*(J1-1)+2),LCOORDS(3*(J1-1)+3),J1=1,NATOMS)
!    WRITE(1,'(I6)') NATOMS
!    WRITE(1,'(A)') 'AVERAGED COORDINATES '
!    WRITE(1,'(A3,3G20.10)') ('LA ',CSMAV(3*(J1-1)+1),CSMAV(3*(J1-1)+2),CSMAV(3*(J1-1)+3),J1=1,NATOMS)
!     CLOSE(1)
! ENDIF
OLCOORDS(1:3*NATOMS)=CSMAV(1:3*NATOMS)
COORDS(1:3*NATOMS,JP)=CSMAV(1:3*NATOMS)

! !
! !  REPEAT AVERAGING FOR THE AVERAGED STRUCTURE!
! !
! NDONE=0
! 5 CONTINUE
! CALL CENTRE2(CSMAV)
! NDONE=NDONE+1
! IF (PERMDIST) THEN
!    CSMVALUE=0.0D0
!    DO J1=1,CSMGPINDEX
!       XTEMP(1:3*NATOMS)=CSMAV(1:3*NATOMS)
!       CALL CSMROT(XTEMP,DUMMY,1,J1)
!       CALL MINPERMDIST(XTEMP,DUMMY,NATOMS,DEBUG,BOXLX,BOXLY,BOXLZ,PERIODIC,TWOD,EREAL,DIST2,RIGID,RMAT)
!       CSMVALUE=CSMVALUE+EREAL**2
!       CALL CSMROT(DUMMY,XTEMP,-1,J1) ! NEED TO ROTATE THE PERMUTED ROTATED IMAGES BACK TO THE REFERENCE ORIENTATION
!       CSMIMAGES(1+3*NATOMS*(J1-1):3*NATOMS*J1)=XTEMP(1:3*NATOMS)
!    ENDDO
! ELSE
!    DO J1=1,CSMGPINDEX
!       CSMIMAGES(1+3*NATOMS*(J1-1):3*NATOMS*J1)=CSMAV(1:3*NATOMS)
!    ENDDO
! ENDIF
! CSMNORM=0.0D0
! DO J1=1,NATOMS
!    CSMNORM=CSMNORM+CSMAV(3*(J1-1)+1)**2+CSMAV(3*(J1-1)+2)**2+CSMAV(3*(J1-1)+3)**2
! ENDDO
! CSMNORM=2*CSMGPINDEX*CSMNORM
! CSMVALUE=CSMVALUE/CSMNORM
! !
! ! CHECKED THAT CSMPOTGRAD VALUE FOR CSM AGREES WITH ABOVE.
! !
! ! AA(1)=0.0D0; AA(2)=0.0D0; AA(3)=6.283185307D0
! ! CALL CSMPOTGRAD(CSMAV,AA,POO,.FALSE.,GSAVE)
! 
! CSMAVNEW(1:3*NATOMS)=0.0D0
! DO J2=1,CSMGPINDEX
!    XTEMP(1:3*NATOMS)=CSMIMAGES(1+3*NATOMS*(J2-1):3*NATOMS*J2)
!    CALL CSMROT(XTEMP,DUMMY,1,J2)
!    CSMAVNEW(1:3*NATOMS)=CSMAVNEW(1:3*NATOMS)+DUMMY(1:3*NATOMS)
! ENDDO
! CSMAVNEW(1:3*NATOMS)=CSMAVNEW(1:3*NATOMS)/CSMGPINDEX
! ! WRITE(3,'(I6)') NATOMS
! ! WRITE(3,'(A,2G20.10)') 'REAVERAGED COORDINATES, CSM=',CSMVALUE
! ! WRITE(MYUNIT,'(A,3G20.10)') 'REAVERAGED COORDINATES, CSM=',CSMVALUE
! ! WRITE(3,'(A3,3G20.10)') ('LA ',CSMAVNEW(3*(J1-1)+1),CSMAVNEW(3*(J1-1)+2),CSMAVNEW(3*(J1-1)+3),J1=1,NATOMS)
! CSMAV(1:3*NATOMS)=CSMAVNEW(1:3*NATOMS)
! IF (NDONE.LT.10) GOTO 5
! ! 
! ! STOP
! WRITE(3,'(I6)') NATOMS
! WRITE(3,'(A,2G20.10)') 'REAVERAGED COORDINATES, CSM=',CSMVALUE
! WRITE(3,'(A3,3G20.10)') ('LA ',CSMAV(3*(J1-1)+1),CSMAV(3*(J1-1)+2),CSMAV(3*(J1-1)+3),J1=1,NATOMS)
! OLCOORDS(1:3*NATOMS)=CSMAV(1:3*NATOMS)
! COORDS(1:3*NATOMS,JP)=CSMAV(1:3*NATOMS)

ASTEPSAVE=ASTEP(JP)
ASTEP(JP)=0.0D0 ! TURN OFF ANGULAR STEPS FOR CSM RELAXATION
DO J1=1,CSMQUENCHES
   NQTOT=NQTOT+1
   NQ(JP)=NQ(JP)+1
   CALL QUENCH(.FALSE.,JP,ITERATIONS,TIME,BRUN,QDONE,SCREENC)
   CALL MYCPU_TIME(T0)

   IF (NPAR.GT.1) THEN
      WRITE(MYUNIT,'(A,I1,A,I10,A,F20.10,A,I5,A,G12.5,A,G20.10,A,I5)') '[',JP,']QU ',NQ(JP),' E=', &
  &        POTEL,' STEPS=',ITERATIONS,' RMS=',RMS,' T=',T0-TSTART,' IN CSM RELAXATION ',J1
   ELSE
      WRITE(MYUNIT,'(A,I10,A,F20.10,A,I5,A,G12.5,A,G20.10,A,I5)') 'QU ',NQ(JP),' E=', &
  &        POTEL,' STEPS=',ITERATIONS,' RMS=',RMS,' T=',T0-TSTART,' IN CSM RELAXATION ',J1
   ENDIF
!
! ACCEPT DOWNHILL MOVES.
!
   IF (CSMEBEST-POTEL.GT.0.0D0) THEN
      CSMEBEST=POTEL
      OLCOORDS(1:3*NATOMS)=COORDS(1:3*NATOMS,JP)
      QBEST(1:3*NATOMS)=OLCOORDS(1:3*NATOMS)
      VATBEST(1:NATOMS)=VAT(1:NATOMS,JP)
   ELSE
      COORDS(1:3*NATOMS,JP)=OLCOORDS(1:3*NATOMS)
   ENDIF
   IF (HIT) EXIT 
   CALL TAKESTEP(JP)
ENDDO
ASTEP(JP)=ASTEPSAVE ! RESTORE ANGULAR STEP

IF (EPREV(JP)-CSMEBEST.GT.ECONV) THEN
   WRITE(MYUNIT,'(A,G20.10)') 'SYMMETRISECSM>     CHANGING CURRENT MINIMUM TO ENERGY ',CSMEBEST
   CHANGEDE=.TRUE. 
   EPREV(JP)=CSMEBEST
   POTEL=CSMEBEST
   VAT(1:NATOMS,JP)=VATBEST(1:NATOMS)
   COORDS(1:3*NATOMS,JP)=QBEST(1:3*NATOMS)
   IF (CENT.AND.(.NOT.SEEDT)) CALL CENTRE2(COORDS(1:3*NATOMS,JP))
   COORDSO(1:3*(NATOMS-NSEED),JP)=COORDS(1:3*(NATOMS-NSEED),JP)
   VATO(1:NATOMS,JP)=VAT(1:NATOMS,JP)
ELSE
   WRITE(MYUNIT,'(A,G20.10)') 'SYMMETRISECSM> NOT CHANGING CURRENT MINIMUM ENERGY     ',EPREV(JP)
   COORDS(1:3*NATOMS,JP)=QORIG(1:3*NATOMS)
ENDIF

RETURN

END SUBROUTINE SYMMETRYCSM

