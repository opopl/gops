!  GMIN: A PROGRAM FOR FINDING GLOBAL MINIMA
!  COPYRIGHT (C) 1999-2006 DAVID J. WALES
!  THIS FILE IS PART OF GMIN.
!
!  GMIN IS FREE SOFTWARE; YOU CAN REDISTRIBUTE IT AND/OR MODIFY
!  IT UNDER THE TERMS OF THE GNU GENERAL PUBLIC LICENSE AS PUBLISHED BY
!  THE FREE SOFTWARE FOUNDATION; EITHER VERSION 2 OF THE LICENSE, OR
!  (AT YOUR OPTION) ANY LATER VERSION.
!
!  GMIN IS DISTRIBUTED IN THE HOPE THAT IT WILL BE USEFUL,
!  BUT WITHOUT ANY WARRANTY; WITHOUT EVEN THE IMPLIED WARRANTY OF
!  MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.  SEE THE
!  GNU GENERAL PUBLIC LICENSE FOR MORE DETAILS.
!
!  YOU SHOULD HAVE RECEIVED A COPY OF THE GNU GENERAL PUBLIC LICENSE
!  ALONG WITH THIS PROGRAM; IF NOT, WRITE TO THE FREE SOFTWARE
!  FOUNDATION, INC., 59 TEMPLE PLACE, SUITE 330, BOSTON, MA  02111-1307  USA
!
! 
!---======================================---
      SUBROUTINE QORDER_BLJ(Q,Q4,Q6)

      USE COMMONS, ONLY: NATOMS, BOXLX, BOXLY, BOXLZ

      IMPLICIT NONE

      REAL(8) Q(3,NATOMS), Q4, Q6
	!INTEGER NMAX
	!PARAMETER(NMAX=320)
	INTEGER J, K, NB, I,M
	DOUBLE PRECISION DISTBOND
	PARAMETER (DISTBOND=1.3909)
	DOUBLE PRECISION DX,DY,DZ,DIST,PHI,COSTHETA,COEF,ARG,PI
	COMPLEX Y,Q4BAR(0:4),Q6BAR(0:6)

	NB=0
	PI=DACOS(-1D0)
	DO M=0,4
	   Q4BAR(M)=(0,0D0)
	ENDDO
	DO M=0,6
	   Q6BAR(M)=(0,0D0)
	ENDDO
	DO J=1,NATOMS-1
	   DO K=J+1,NATOMS
	      DX=Q(1,J)-Q(1,K)
	      DY=Q(2,J)-Q(2,K)
	      DZ=Q(3,J)-Q(3,K)
	      DX=DX-BOXLX*ANINT(DX/BOXLX)
	      DY=DY-BOXLY*ANINT(DY/BOXLY)
	      DZ=DZ-BOXLZ*ANINT(DZ/BOXLZ)

	      DIST=DSQRT(DX*DX+DY*DY+DZ*DZ)
	      IF (DIST.LT.DISTBOND) THEN
		 NB=NB+1
		 COSTHETA =DZ/DIST
		 PHI = DATAN(DY/DX)
		 IF(DX.LT.0) PHI=PHI+PI
		 DO M=0,4
		    Q4BAR(M)=Q4BAR(M)+Y(4,M,COSTHETA,PHI)
		 ENDDO
		 DO M=0,6
		    Q6BAR(M)=Q6BAR(M)+Y(6,M,COSTHETA,PHI)
		 ENDDO
	      ENDIF
	   ENDDO
	ENDDO
	Q4=0
	DO M=0,4
	   Q4=Q4+COEF(4,M)*Q4BAR(M)*CONJG(Q4BAR(M))
	ENDDO
	Q4=DSQRT(Q4)/(3*NB)
	Q6=0
	DO M=0,6
	   Q6=Q6+COEF(6,M)*Q6BAR(M)*CONJG(Q6BAR(M))
	ENDDO
	Q6=DSQRT(Q6/13.D0)/NB
	RETURN
	END
	
	DOUBLE PRECISION FUNCTION COEF(L,M)
	INTEGER L,M,K
	IF(M.EQ.0) THEN
	   COEF=2*L+1D0
	ELSE
	   COEF=4*L+2.
	   DO K=L-M+1,L+M
	      COEF=COEF/K
	   ENDDO
	ENDIF
	RETURN
	END
	
	COMPLEX FUNCTION Y(L,M,COSTHETA,PHI)
! COMPUTES THE THE SPHERICAL HARMONIC Y(L.M)*SQRT(4*PI)  
	IMPLICIT NONE
	INTEGER L,M
	DOUBLE PRECISION PLGNDR,COSTHETA,PHI
	IF(M.LT.0) STOP 'M<0 IN Y'
	IF(M.EQ.0) THEN
	   Y=PLGNDR(L,M,COSTHETA)
	ELSE 
	   Y=PLGNDR(L,M,COSTHETA)*EXP(CMPLX(0D0,M*PHI))
	ENDIF
	RETURN 
	END
	
	DOUBLE PRECISION FUNCTION PLGNDR(L,M,X) 
	IMPLICIT NONE
	INTEGER L,M 
	DOUBLE PRECISION X
! COMPUTES THE ASSOCIATED LEGENDRE POLYNOMIAL PML (X).
	INTEGER I,LL 
	DOUBLE PRECISION FACT,PLL,PMM,PMMP1,SOMX2 
	IF(M.LT.0.OR.M.GT.L.OR.ABS(X).GT.1.) THEN
           STOP 'BAD ARGUMENTS IN PLGNDR'
        ENDIF
	PMM=1.  
	IF(M.GT.0) THEN 
	   SOMX2=SQRT((1.-X)*(1.+X)) 
	   FACT=1. 
	   DO I=1,M 
	      PMM=-PMM*FACT*SOMX2 
	      FACT=FACT+2. 
	   ENDDO 
	ENDIF 
	IF(L.EQ.M) THEN 
	   PLGNDR=PMM 
	ELSE 
	   PMMP1=X*(2*M+1)*PMM 
	   IF(L.EQ.M+1) THEN 
	      PLGNDR=PMMP1 
	   ELSE 
	      DO LL=M+2,L
		 PLL=(X*(2*LL-1)*PMMP1-(LL+M-1)*PMM)/(LL-M) 
		 PMM=PMMP1 
		 PMMP1=PLL 
	      ENDDO  
	      PLGNDR=PLL 
	   ENDIF 
	ENDIF 
	RETURN 
	END



