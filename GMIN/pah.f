C   GMIN: A PROGRAM FOR FINDING GLOBAL MINIMA
C   COPYRIGHT (C) 1999-2006 DAVID J. WALES
C   THIS FILE IS PART OF GMIN.
C
C   GMIN IS FREE SOFTWARE; YOU CAN REDISTRIBUTE IT AND/OR MODIFY
C   IT UNDER THE TERMS OF THE GNU GENERAL PUBLIC LICENSE AS PUBLISHED BY
C   THE FREE SOFTWARE FOUNDATION; EITHER VERSION 2 OF THE LICENSE, OR
C   (AT YOUR OPTION) ANY LATER VERSION.
C
C   GMIN IS DISTRIBUTED IN THE HOPE THAT IT WILL BE USEFUL,
C   BUT WITHOUT ANY WARRANTY; WITHOUT EVEN THE IMPLIED WARRANTY OF
C   MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.  SEE THE
C   GNU GENERAL PUBLIC LICENSE FOR MORE DETAILS.
C
C   YOU SHOULD HAVE RECEIVED A COPY OF THE GNU GENERAL PUBLIC LICENSE
C   ALONG WITH THIS PROGRAM; IF NOT, WRITE TO THE FREE SOFTWARE
C   FOUNDATION, INC., 59 TEMPLE PLACE, SUITE 330, BOSTON, MA  02111-1307  USA
C
C
C  ENERGY AND GRADIENT FOR RIGID BODY PAH MOLECULE USING NEW RIGID BODY
C  DERIVATIVE FUNCTIONS ETC.
C
      SUBROUTINE PAH(X,V,EPAH,GTEST,SECT)
      USE COMMONS
      IMPLICIT NONE
      LOGICAL GTEST,SECT
      INTEGER J1, J2, K1, K2, NAT2
      DOUBLE PRECISION X(3*NATOMS), V(3*NATOMS), X1, X2, Y1, Y2, Z1, Z2, FC, DFC,
     1                 EPAH, DUMMY, RALPHA12, RALPHA22, RDIST, RM6, RM1,
     2                 M1, L1, N1, M2, L2, N2, ALPHA1, CA1, CA2, ALPHA2, S1, S2, C3A1, C3A2,
     3                 L12, M12, N12, L22, M22, N22, C6CC, C12CC, C6HH, C12HH,
     4                 GX1, GY1, GZ1, GL1, GM1, GN1, GL2, GM2, GN2, C2A2, C2A1,
     5                 D1, D2, D3, D4, D5, D6, DA, DB, DC, DIST, DUMMY2,
     6                 P1X, P1Y, P1Z, P2X, P2Y, P2Z, Q1, Q2, RDIST6,
     7           D1S, D2S, D3S, D4S, D5S, D6S, DAS, DBS, DCS, CHARGE(36), HTOKJ
      PARAMETER (HTOKJ=1389.354848D0) ! CONVERSION FACTOR FOR COULOMB ENERGY AND GRADIENTS
      DOUBLE PRECISION FLJCC, FLJHH, FLJCH, DFLJCC, DFLJHH, DFLJCH, C6CH, C12CH
C
C  STATEMENT FUNCTIONS.
C  SITE-SITE ENERGY TERMS - COULOMBIC AND LJ. 
C
      FLJCC(RM6)=(C12CC*RM6-C6CC)*RM6
      DFLJCC(RM1,RM6)=-6.0D0*(-C6CC+2.0D0*C12CC*RM6)*RM6*RM1
      FLJHH(RM6)=(C12HH*RM6-C6HH)*RM6
      DFLJHH(RM1,RM6)=-6.0D0*(-C6HH+2.0D0*C12HH*RM6)*RM6*RM1
      FLJCH(RM6)=(C12CH*RM6-C6CH)*RM6
      DFLJCH(RM1,RM6)=-6.0D0*(-C6CH+2.0D0*C12CH*RM6)*RM1*RM6

      FC(Q1,Q2,RM1)=Q1*Q2*RM1
      DFC(Q1,Q2,RM1)=-Q1*Q2*RM1**2
C
      DO J1=1,NRBSITES
         SITE(J1,3)=0.0D0
      ENDDO

      SITE( 1,1)=1.42D0
      SITE( 1,2)=0.0D0
      CHARGE( 1)=-0.0066D0
      SITE( 2,1)=0.71D0
      SITE( 2,2)=1.229755D0
      CHARGE( 2)=-0.0066D0
      SITE( 3,1)=-0.71D0
      SITE( 3,2)=1.229755D0
      CHARGE( 3)=-0.0066D0
      SITE( 4,1)=-1.42D0
      SITE( 4,2)=0.0D0
      CHARGE( 4)=-0.0066D0
      SITE( 5,1)=-0.71D0
      SITE( 5,2)=-1.229755D0
      CHARGE( 5)=-0.0066D0
      SITE( 6,1)=0.71D0
      SITE( 6,2)=-1.229755D0
      CHARGE( 6)=-0.0066D0
      SITE( 7,1)=2.838D0
      SITE( 7,2)=0.0D0
      CHARGE( 7)=0.0158D0
      SITE( 8,1)=1.419D0
      SITE( 8,2)=2.457779D0
      CHARGE( 8)=0.0158D0
      SITE( 9,1)=-1.419D0
      SITE( 9,2)=2.457779D0
      CHARGE( 9)=0.0158D0
      SITE(10,1)=-2.838D0
      SITE(10,2)=0.0D0
      CHARGE(10)=0.0158D0
      SITE(11,1)=-1.419D0
      SITE(11,2)=-2.45779D0
      CHARGE(11)=0.0158D0
      SITE(12,1)=1.419D0
      SITE(12,2)=-2.45779D0
      CHARGE(12)=0.0158D0
      SITE(13,1)=3.523366D0
      SITE(13,2)=1.248219D0
      CHARGE(13)=-0.0986D0
      SITE(14,1)=2.842673D0
      SITE(14,2)=2.427211D0
      CHARGE(14)=-0.0986D0
      SITE(15,1)=0.680706D0
      SITE(15,2)=3.675430D0
      CHARGE(15)=-0.0986D0
      SITE(16,1)=-0.680677D0
      SITE(16,2)=3.675437D0
      CHARGE(16)=-0.0986D0
      SITE(17,1)=-2.842673D0
      SITE(17,2)=2.427211D0
      CHARGE(17)=-0.0986D0
      SITE(18,1)=-3.523366D0
      SITE(18,2)=1.248219D0
      CHARGE(18)=-0.0986D0
      SITE(19,1)=-3.523366D0
      SITE(19,2)=-1.248219D0
      CHARGE(19)=-0.0986D0
      SITE(20,1)=-2.842673D0
      SITE(20,2)=-2.427211D0
      CHARGE(20)=-0.0986D0
      SITE(21,1)=-0.680677D0
      SITE(21,2)=-3.675437D0
      CHARGE(21)=-0.0986D0
      SITE(22,1)=0.680706D0
      SITE(22,2)=-3.675437D0
      CHARGE(22)=-0.0986D0
      SITE(23,1)=2.842673D0
      SITE(23,2)=-2.427211D0
      CHARGE(23)=-0.0986D0
      SITE(24,1)=3.523366D0
      SITE(24,2)=-1.248219D0
      CHARGE(24)=-0.0986D0
      SITE(25,1)=4.602048D0
      SITE(25,2)=1.274393D0
      CHARGE(25)=0.094D0
      SITE(26,1)=3.404682D0
      SITE(26,2)=3.348290D0
      CHARGE(26)=0.094D0
      SITE(27,1)=1.197383D0
      SITE(27,2)=4.622681D0
      CHARGE(27)=0.094D0
      SITE(28,1)=-1.197347D0
      SITE(28,2)=4.622693D0
      CHARGE(28)=0.094D0
      SITE(29,1)=-3.404682D0
      SITE(29,2)=3.348290D0
      CHARGE(29)=0.094D0
      SITE(30,1)=-4.602048D0
      SITE(30,2)=1.274393D0
      CHARGE(30)=0.094D0
      SITE(31,1)=-4.602048D0
      SITE(31,2)=-1.274393D0
      CHARGE(31)=0.094D0
      SITE(32,1)=-3.404682D0
      SITE(32,2)=-3.348290D0
      CHARGE(32)=0.094D0
      SITE(33,1)=-1.197347D0
      SITE(33,2)=-4.622693D0
      CHARGE(33)=0.094D0
      SITE(34,1)=1.197383D0
      SITE(34,2)=-4.622681D0
      CHARGE(34)=0.094D0
      SITE(35,1)=3.404682D0
      SITE(35,2)=-3.348290D0
      CHARGE(35)=0.094D0
      SITE(36,1)=4.602048D0
      SITE(36,2)=-1.274393D0
      CHARGE(36)=0.094D0

      C6CC=0.3926*12.075625**3 ! LJ COEFFICIENTS IN KJ/MOL ANGSTROM**6 OR ANGSTROM**12
      C12CC=0.3926*12.075625**6
      C6HH=0.0543*8.625969**3
      C12HH=0.0543*8.625969**6
      C6CH=0.1435*10.291264**3
      C12CH=0.1435*10.291264**6

      NAT2=NATOMS/2
      EPAH=0.0D0
      DO J1=1,NATOMS/2
         VT(J1)=0.0D0
      ENDDO
      DO J1=1,3*NATOMS
         V(J1)=0.0D0
      ENDDO

C
C  POTENTIAL ENERGY FIRST.
C
      DO J1=1,NAT2-1
         X1=X(3*(J1-1)+1)
         Y1=X(3*(J1-1)+2)
         Z1=X(3*(J1-1)+3)
         L1=X(3*(NAT2+J1-1)+1)
         M1=X(3*(NAT2+J1-1)+2)
         N1=X(3*(NAT2+J1-1)+3)
         L12=L1**2
         M12=M1**2
         N12=N1**2
         ALPHA1=SQRT(L12+M12+N12)
         RALPHA12=1.0D0/MAX(ALPHA1**2,1.0D-20)
         CA1=COS(ALPHA1)
         C2A1=CA1
         IF (ALPHA1.LT.0.0010D0) THEN
C           C3A1=-ALPHA1/2+ALPHA1**3/24
            C3A1=-0.5D0+ALPHA1**2/24.0D0
            S1=1.0D0-ALPHA1**2/6
         ELSE
            C3A1=(CA1-1.0D0)/ALPHA1**2
            S1=SIN(ALPHA1)/ALPHA1
         ENDIF

C        WRITE(*,'(A,6F15.5)') 'ALPHA1,RALPHA12,CA1,C2A1,C3A1,S1=',ALPHA1,RALPHA12,CA1,C2A1,C3A1,S1
         DO J2=J1+1,NAT2
            X2=X(3*(J2-1)+1)
            Y2=X(3*(J2-1)+2)
            Z2=X(3*(J2-1)+3)
            L2=X(3*(NAT2+J2-1)+1)
            M2=X(3*(NAT2+J2-1)+2)
            N2=X(3*(NAT2+J2-1)+3)
            L22=L2**2
            M22=M2**2
            N22=N2**2
            ALPHA2=SQRT(L22+M22+N22)
            RALPHA22=1.0D0/MAX(ALPHA2**2,1.0D-20)
            CA2=COS(ALPHA2)
            C2A2=CA2
            IF (ALPHA2.LT.0.00001D0) THEN
C              C3A2=-ALPHA2/2+ALPHA2**3/24
               C3A2=-0.5D0+ALPHA2**2/24.0D0
               S2=1.0D0-ALPHA2**2/6
            ELSE
               C3A2=(CA2-1.0D0)/ALPHA2**2
               S2=SIN(ALPHA2)/ALPHA2
            ENDIF
C
C  LJ AND COULOMB CONTRIBUTIONS.
C
            DO K1=1,36
               P1X=SITE(K1,1)
               P1Y=SITE(K1,2)
               P1Z=SITE(K1,3)
               DO K2=1,36
                  P2X=SITE(K2,1)
                  P2Y=SITE(K2,2)
                  P2Z=SITE(K2,3)
                  DIST= 
     1  SQRT((C2A1*P1X-C3A1*L1*(L1*P1X+M1*P1Y+N1*P1Z)-C2A2*P2X+C3A2*L2*(L2*P2X + M2*P2Y + N2*P2Z)+ 
     1      (N1*P1Y - M1*P1Z)*S1 - (N2*P2Y - M2*P2Z)*S2 + X1 - X2)**2 + 
     1   (C2A1*P1Y - C3A1*M1*(L1*P1X + M1*P1Y + N1*P1Z) - C2A2*P2Y+C3A2*M2*(L2*P2X+M2*P2Y+N2*P2Z)+ 
     1      (-(N1*P1X) + L1*P1Z)*S1 - (-(N2*P2X) + L2*P2Z)*S2 + Y1-Y2)**2 + 
     1   (C2A1*P1Z - C3A1*N1*(L1*P1X + M1*P1Y + N1*P1Z) - C2A2*P2Z+C3A2*N2*(L2*P2X+M2*P2Y+N2*P2Z)+ 
     1      (M1*P1X - L1*P1Y)*S1 - (M2*P2X - L2*P2Y)*S2 + Z1 - Z2)**2)
C           PRINT*,'COORDINATES OF MOLECULE PAIR:'
C           WRITE(*,'(3F20.10)') X1,Y1,Z1
C           WRITE(*,'(3F20.10)') L1,M1,N1
C           WRITE(*,'(3F20.10)') X2,Y2,Z2
C           WRITE(*,'(3F20.10)') L2,M2,N2
                  RDIST=1.0D0/DIST
                  RDIST6=RDIST**6
C
C  LJ TERM
C
                  IF (K1.LE.24.AND.K2.LE.24) THEN     ! C-C
                     DUMMY=FLJCC(RDIST6)
                  ELSEIF (K1.GT.24.AND.K2.GT.24) THEN ! H-H
                     DUMMY=FLJHH(RDIST6)
                  ELSE                                ! C-H
                     DUMMY=FLJCH(RDIST6)
                  ENDIF
C                 PRINT*,'DISTANCE,DUMMY=',DIST,DUMMY
C
C  COULOMB TERM
C
                  DUMMY=DUMMY+HTOKJ*FC(CHARGE(K1),CHARGE(K2),RDIST)
                  IF (GTEST.OR.SECT) THEN
                     IF (K1.LE.24.AND.K2.LE.24) THEN     ! C-C
                        DUMMY2=DFLJCC(RDIST,RDIST6)
                     ELSEIF (K1.GT.24.AND.K2.GT.24) THEN ! H-H
                        DUMMY2=DFLJHH(RDIST,RDIST6)
                     ELSE                                ! C-H
                        DUMMY2=DFLJCH(RDIST,RDIST6)
                     ENDIF
                     D1S=D1(P1X,P1Y,P1Z,P2X,P2Y,P2Z,X1,Y1,Z1,N1,L1,M1,X2,Y2,Z2,L2,M2,N2,RDIST,
     1             C2A2,RALPHA12,RALPHA22,C3A2,S2,C2A1,C3A1,S1,N12,L12,M12,L22,M22,N22)
                     D2S=D2(P1X,P1Y,P1Z,P2X,P2Y,P2Z,X1,Y1,Z1,N1,L1,M1,X2,Y2,Z2,L2,M2,N2,RDIST,
     1             C2A2,RALPHA12,RALPHA22,C3A2,S2,C2A1,C3A1,S1,N12,L12,M12,L22,M22,N22)
                     D3S=D3(P1X,P1Y,P1Z,P2X,P2Y,P2Z,X1,Y1,Z1,N1,L1,M1,X2,Y2,Z2,L2,M2,N2,RDIST,
     1             C2A2,RALPHA12,RALPHA22,C3A2,S2,C2A1,C3A1,S1,N12,L12,M12,L22,M22,N22)
                     D4S=D4(P1X,P1Y,P1Z,P2X,P2Y,P2Z,X1,Y1,Z1,N1,L1,M1,X2,Y2,Z2,L2,M2,N2,RDIST,
     1             C2A2,RALPHA12,RALPHA22,C3A2,S2,C2A1,C3A1,S1,N12,L12,M12,L22,M22,N22)
                     D5S=D5(P1X,P1Y,P1Z,P2X,P2Y,P2Z,X1,Y1,Z1,N1,L1,M1,X2,Y2,Z2,L2,M2,N2,RDIST,
     1             C2A2,RALPHA12,RALPHA22,C3A2,S2,C2A1,C3A1,S1,N12,L12,M12,L22,M22,N22)
                     D6S=D6(P1X,P1Y,P1Z,P2X,P2Y,P2Z,X1,Y1,Z1,N1,L1,M1,X2,Y2,Z2,L2,M2,N2,RDIST,
     1             C2A2,RALPHA12,RALPHA22,C3A2,S2,C2A1,C3A1,S1,N12,L12,M12,L22,M22,N22)
                     DAS=DA(P1X,P1Y,P1Z,P2X,P2Y,P2Z,X1,Y1,Z1,N1,L1,M1,X2,Y2,Z2,L2,M2,N2,RDIST,
     1             C2A2,RALPHA12,RALPHA22,C3A2,S2,C2A1,C3A1,S1,N12,L12,M12,L22,M22,N22)
                     DBS=DB(P1X,P1Y,P1Z,P2X,P2Y,P2Z,X1,Y1,Z1,N1,L1,M1,X2,Y2,Z2,L2,M2,N2,RDIST,
     1             C2A2,RALPHA12,RALPHA22,C3A2,S2,C2A1,C3A1,S1,N12,L12,M12,L22,M22,N22)
                     DCS=DC(P1X,P1Y,P1Z,P2X,P2Y,P2Z,X1,Y1,Z1,N1,L1,M1,X2,Y2,Z2,L2,M2,N2,RDIST,
     1             C2A2,RALPHA12,RALPHA22,C3A2,S2,C2A1,C3A1,S1,N12,L12,M12,L22,M22,N22)
C
C  ADD COUL;OMB CONTRIBUTION
C
                     DUMMY2=DUMMY2+HTOKJ*DFC(CHARGE(K1),CHARGE(K2),RDIST)
                     GX1=DUMMY2*D1S
                     GY1=DUMMY2*D2S
                     GZ1=DUMMY2*D3S
                     GL1=DUMMY2*D4S
                     GM1=DUMMY2*D5S
                     GN1=DUMMY2*D6S
                     GL2=DUMMY2*DAS
                     GM2=DUMMY2*DBS
                     GN2=DUMMY2*DCS

                     EPAH=EPAH+DUMMY
                     VT(J1)=VT(J1)+DUMMY
                     VT(J2)=VT(J2)+DUMMY

                     IF (GTEST) THEN
                        V(3*(J1-1)+1)=V(3*(J1-1)+1)+GX1
                        V(3*(J1-1)+2)=V(3*(J1-1)+2)+GY1
                        V(3*(J1-1)+3)=V(3*(J1-1)+3)+GZ1
                        V(3*(NAT2+J1-1)+1)=V(3*(NAT2+J1-1)+1)+GL1
                        V(3*(NAT2+J1-1)+2)=V(3*(NAT2+J1-1)+2)+GM1
                        V(3*(NAT2+J1-1)+3)=V(3*(NAT2+J1-1)+3)+GN1
                        V(3*(J2-1)+1)=V(3*(J2-1)+1)-GX1
                        V(3*(J2-1)+2)=V(3*(J2-1)+2)-GY1
                        V(3*(J2-1)+3)=V(3*(J2-1)+3)-GZ1
                        V(3*(NAT2+J2-1)+1)=V(3*(NAT2+J2-1)+1)+GL2
                        V(3*(NAT2+J2-1)+2)=V(3*(NAT2+J2-1)+2)+GM2
                        V(3*(NAT2+J2-1)+3)=V(3*(NAT2+J2-1)+3)+GN2
                     ENDIF
                  ENDIF
               ENDDO
            ENDDO
         ENDDO
      ENDDO

C     WRITE(*,'(A,G20.10)') 'ENERGY=',EPAH
C     PRINT*,'COORDS:'
C     WRITE(*,'(I6,G20.10)') (J1,X(J1),J1=1,3*NATOMS)
C     PRINT*,'GRADIENT:'
C     WRITE(*,'(I6,G20.10)') (J1,V(J1),J1=1,3*NATOMS)

      RETURN
      END
