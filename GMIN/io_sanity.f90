! GMIN I/O FILE OPENING MODULE
!
! CONTENTS
! --------
!
! FUNCTIONS:
! 
! - OPENINPUT(FILENAME) <UNDER CONSTRUCTION>
! - OPENDATA(FILENAME) <UNDER CONSTRUCTION>
! - READTOBUFFER(FILEUNIT) - RETURNS A BUFFER(100,NLINES), CONTAINING EACH LINE
!   OF FILEUNIT AS A 100 CHARACTER WIDE ARRAY
! - FILELENGTH(FILEUNIT) - RETURNS THE NUMBER OF LINES IN FILEUNIT
! - FILEEXISTS(FILEUNIT) - RETURNS .TRUE. IF FILEUNIT EXISTS
!
! SUBROUTINES:
!

FUNCTION OPENINPUT(FILENAME)
! OPEN THE INPUT FILE AND PERFORM SANITY CHECKS, RETURNING MOLECULAR INFORMATION
! FOR SUITABLE FILES
    IMPLICIT NONE

    CHARACTER, DIMENSION(:), INTENT(IN) :: FILENAME
    INTEGER :: FILEUNIT
    CHARACTER, DIMENSION(:, :) :: BUFFER
    CHARACTER, DIMENSION(:, :), ALLOCATABLE, INTENT(OUT) :: MOLINFO    
   
    
 
    RETURN MOLINFO
END FUNCTION OPENINPUT

FUNCTION OPENDATA(FILENAME)
! OPEN THE DATA FILE AND PERFORM SANITY CHECKS, SETTING THE APPROPRIATE FLAGS
! AND SETTINGS
    IMPLICIT NONE

    CHARACTER, DIMENSION(:), INTENT(IN) :: FILENAME
    INTEGER :: FILEUNIT

END FUNCTION OPENDATA

FUNCTION READTOBUFFER(FILEUNIT)
! READ THE FILE INTO A BUFFER AND RETURN THE BUFFERED FILE
    IMPLICIT NONE

    INTEGER, INTENT(IN) :: FILEUNIT
    CHARACTER, DIMENSION(:, :), ALLOCATABLE, INTENT(OUT) :: BUFFER
    INTEGER :: FILELENGTH, IOSTATUS, LINENUMBER

    ! FIND THE LENGTH OF THE FILE AND ALLOCATE THE BUFFER ACCORDINGLY
    FILELENGTH = FILELENGTH(FILEUNIT)
    ALLOCATE(BUFFER(100, FILELENGTH))

    ! INITIALISE IOSTATUS AND LINENUMBER TO 0 AND THEN LOOP THROUGH THE FILE
    IOSTATUS = 0
    LINENUMBER = 1
    DO WHILE (IOSTATUS .NE. -1)
        READ(UNIT = FILEUNIT, FMT = '(A100)', IOSTAT = IOSTATUS) &
        & BUFFER(:, LINENUMBER)
        LINENUMBER = LINENUMBER + 1
    END DO

    RETURN BUFFER
END FUNCTION READTOBUFFER

FUNCTION FILELENGTH(FILEUNIT)
! RETURNS THE LENGTH OF A FILE AS AN INTEGER
    IMPLICIT NONE

    INTEGER, INTENT(IN)   :: FILEUNIT
    INTEGER, INTENT(OUT)  :: LENGTH
    INTEGER :: IOSTATUS

    LENGTH = 0
    IOSTATUS = 0

    ! IF IT READS PAST THE END OF THE FILE, IOSTATUS=-1
    DO WHILE (IOSTATUS .NE. -1)
        READ(UNIT = FILEUNIT, IOSTAT = IOSTATUS, FMT = *)
        LENGTH = LENGTH + 1
    END DO

    RETURN LENGTH
END FUNCTION FILELENGTH

FUNCTION FILEEXISTS(FILEUNIT)
! CHECK WHETHER THE FILE EXISTS
    IMPLICIT NONE

    INTEGER, INTENT(IN)  :: FILEUNIT
    LOGICAL, INTENT(OUT) :: EXISTS

    EXISTS = .FALSE.
    INQUIRE(UNIT = FILEUNIT, EXIST = EXISTS)

    RETURN EXISTS 
END FUNCTION FILEEXISTS

! GMIN I/O ROUTINES
!
! CONTENTS
! --------
!
! FUNCTIONS:
! 
! - READPDB(BUFFER) - RETURNS MOLINFO AND COORDS FROM BUFFER <UNDER CONSTRUCTION>
! - WRITEPDB(NATOMS,MOLINFO,COORDS,FILENAME) <UNDER CONSTRUCTION>
! - READRST(BUFFER) - RETURNS COORDS 1D ARRAY FROM BUFFER <UNDER CONSTRUCTION>
! - WRITERST(NATOMS,COORDS,FILENAME) - WRITES COORDINATES INTO AMBER FILENAME.RST FILE
! - READCRD(BUFFER) <UNDER CONSTRUCTION>
! - WRITECRD(NATOMS,MOLINFO,COORDS,FILENAME) <UNDER CONSTRUCTION>
! - READXYZ(BUFFER) <UNDER CONSTRUCTION>
!
! SUBROUTINES:
!

FUNCTION WRITEPDB(NATOMS,MOLINFO,COORDS,FILENAME)
! WRITE COORDS TO FILENAME.PDB IN PDB FORMAT
! MOLINFO(NATOMS) IS A DERIVED TYPE ARRAY 
! EACH ELEMENT (I.E. MOLINFO(1)) CONTAINS INFO ABOUT THAT ATOM:
! MOLINFO(1)%INDEX = ATOM INDEX IN COORDS ARRAY
! MOLINFO(1)%NAME = ATOM NAME
! MOLINFO(1)%RESID = RESIDUE NUMBER
! MOLINFO(1)%RESNAME = RESIDUE NAME
! MOLINFO(1)%CHAINID = CHAIN IDENTIFIER
! MOLINFO(1)%SEGNAME = SEGMENT NAME
! MOLINFO(1)%ELEMENT = ELEMENT NAME
! MOLINFO(1)%OCCUPANCY = SITE OCCUPANCY
! MOLINFO(1)%BFACTOR = CRYSTALLOGRAPHIC TEMPERATURE/B FACTOR
! MOLINFO(1)%CHARGE = ATOMIC CHARGE
! MOLINFO(1)%WEIGHT = CHARMM WEIGHTING
IMPLICIT NONE
CHARACTER(LEN=40), INTENT(IN) :: FILENAME
INTEGER, INTENT(IN) :: NATOMS 
INTEGER :: I
TYPE(ATOM), INTENT(IN) :: MOLINFO(NATOMS)

OPEN(UNIT=20,FILE=TRIM(ADJUSTR(FILENAME))//TRIM(ADJUSTL('.PDB')),STATUS='UNKNOWN')
DO I=1,NATOMS
   WRITE(20,'(A6,I5,1X,A4,A1,A3,1X,A1,I4,A1,3X,3F8.3,2F6.2,10X,2A2)')
     &        'ATOM',I,MOLINFO(I)%NAME,' ',MOLINFO(I)%RESNAME,MOLINFO(I)%CHAINID
     &        ,MOLINFO(I)%RESID,' ',COORDS(3*I-2:3*I),MOLINFO(I)%OCCUPANCY
     &        ,MOLINFO(I)%BFACTOR,MOLINFO(I)%ELEMENT,MOLINFO(I)%CHARGE
ENDDO
CLOSE(20)
RETURN
END FUNCTION WRITEPDB



FUNCTION READRST(FILENAME)
! READS COORDS FROM FILENAME.RST (AMBER RESTART FILE)
IMPLICIT NONE

CHARACTER(LEN=40), INTENT(IN) :: FILENAME
CHARACTER(LEN=1) :: DUMMY
INTEGER :: NATOMS, I
DOUBLE PRECISION, INTENT(OUT) :: COORDS(3*NATOMS)

NATOMS=0
! OPEN THE FILE
OPEN(UNIT=20,FILE=TRIM(ADJUSTR(FILENAME))//TRIM(ADJUSTL('.RST')),STATUS='UNKNOWN')
! .RST FILES HAVE A TITLE LINE - READ IT INTO DUMMY
READ(20,'(20A4)') DUMMY
! READ THE NUMBER OF ATOMS FROM THE .RST FILE
READ(20,'(I5)') NATOMS
! READ COORDINATES
READ(20,'(6F12.7)') (COORDS(I),I=1,3*NATOMS)
! CLOSE THE FILE
CLOSE(20)

! RETURN THE COORDINATES IN PLACE OF THE FUNCTION CALL
RETURN COORDS
END FUNCTION READRST



FUNCTION WRITERST(NATOMS,COORDS,FILENAME)
! WRITES COORDS TO FILENAME.RST IN AMBER RESTART FORMAT
IMPLICIT NONE

CHARACTER(LEN=40), INTENT(IN) :: FILENAME
INTEGER, INTENT(IN) :: NATOMS, I
DOUBLE PRECISION, INTENT(IN) :: COORDS(3*NATOMS)

! OPEN THE FILE
OPEN(UNIT=20,FILE=TRIM(ADJUSTR(FILENAME))//TRIM(ADJUSTL('.RST')),STATUS='UNKNOWN')
! WRITE THE .RST TITLE LINE. WE MAKE IT THE FILENAME!
WRITE(20,'(20A4)') FILENAME
! WRITE THE NUMBER OF ATOMS
WRITE(20,'(I5)') NATOMS
! WRITE THE COORDINATES
WRITE(20,'(6F12.7)') (COORDS(I),I=1,3*NATOMS)
! CLOSE THE FILE
CLOSE(20)

RETURN
END FUNCTION WRITERST



FUNCTION WRITECRD(NATOMS,MOLINFO,COORDS,FILENAME)
! WRITE COORDS TO FILENAME.CRD IN CHARMM CARD FORMAT
! MOLINFO(NATOMS) IS A DERIVED TYPE ARRAY 
! EACH ELEMENT (I.E. MOLINFO(1)) CONTAINS INFO ABOUT THAT ATOM:
! MOLINFO(1)%NAME = ATOM NAME
! MOLINFO(1)%RESID = RESIDUE NUMBER
! MOLINFO(1)%RESNAME = RESIDUE NAME
! MOLINFO(1)%CHAINID = CHAIN IDENTIFIER
! MOLINFO(1)%SEGNAME = SEGMENT NAME
! MOLINFO(1)%ELEMENT = ELEMENT NAME
! MOLINFO(1)%OCCUPANCY = SITE OCCUPANCY
! MOLINFO(1)%BFACTOR = CRYSTALOGRAPHIC TEMPERATURE/B FACTOR
! MOLINFO(1)%CHARGE = ATOMIC CHARGE
! MOLINFO(1)%WEIGHT = CHARMM WEIGHING
IMPLICIT NONE

CHARACTER(LEN=40), INTENT(IN) :: FILENAME
INTEGER, INTENT(IN) :: NATOMS, I
DOUBLE PRECISION, INTENT(IN) :: COORDS(3*NATOMS)

OPEN(UNIT=20,FILE=TRIM(ADJUSTR(FILENAME))//TRIM(ADJUSTL('.RST')),STATUS='UNKNOWN')
! CHARMM .CRD FILES START WITH THE NUMBER OF ATOMS
WRITE(20,'(I5)') NATOMS
WRITE(20,'(2I5,1X,A4,1X,A4,3F17.12,2X,A4,X,A2)')
! FROM CHARMM: (INFO NEEDS TO BE IN MOLINFO)
     &        I,IRES,RES(IRES),TYPE(I),X(I),Y(I),Z(I),SEGID(ISEG),RID
CLOSE(20)
RETURN
END FUNCTION WRITECRD
